{"meta":{"version":1,"warehouse":"6.0.0"},"models":{"Asset":[{"_id":"node_modules/hexo-theme-next/source/css/noscript.styl","path":"css/noscript.styl","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/css/main.styl","path":"css/main.styl","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/js/comments-buttons.js","path":"js/comments-buttons.js","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/js/config.js","path":"js/config.js","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/js/bookmark.js","path":"js/bookmark.js","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/js/comments.js","path":"js/comments.js","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/js/next-boot.js","path":"js/next-boot.js","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/js/pjax.js","path":"js/pjax.js","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/js/motion.js","path":"js/motion.js","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/js/schedule.js","path":"js/schedule.js","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/js/sidebar.js","path":"js/sidebar.js","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/js/utils.js","path":"js/utils.js","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/images/apple-touch-icon-next.png","path":"images/apple-touch-icon-next.png","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/images/avatar.gif","path":"images/avatar.gif","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/images/favicon-32x32-next.png","path":"images/favicon-32x32-next.png","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/images/favicon-16x16-next.png","path":"images/favicon-16x16-next.png","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/images/logo.svg","path":"images/logo.svg","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/images/logo-algolia-nebula-blue-full.svg","path":"images/logo-algolia-nebula-blue-full.svg","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/js/third-party/addtoany.js","path":"js/third-party/addtoany.js","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/js/third-party/pace.js","path":"js/third-party/pace.js","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/js/third-party/fancybox.js","path":"js/third-party/fancybox.js","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/js/third-party/quicklink.js","path":"js/third-party/quicklink.js","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/js/third-party/chat/chatra.js","path":"js/third-party/chat/chatra.js","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/js/third-party/chat/tidio.js","path":"js/third-party/chat/tidio.js","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/js/third-party/analytics/google-analytics.js","path":"js/third-party/analytics/google-analytics.js","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/js/third-party/analytics/baidu-analytics.js","path":"js/third-party/analytics/baidu-analytics.js","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/js/third-party/analytics/growingio.js","path":"js/third-party/analytics/growingio.js","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/js/third-party/analytics/matomo.js","path":"js/third-party/analytics/matomo.js","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/js/third-party/comments/changyan.js","path":"js/third-party/comments/changyan.js","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/js/third-party/comments/disqus.js","path":"js/third-party/comments/disqus.js","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/js/third-party/comments/disqusjs.js","path":"js/third-party/comments/disqusjs.js","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/js/third-party/comments/gitalk.js","path":"js/third-party/comments/gitalk.js","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/js/third-party/comments/isso.js","path":"js/third-party/comments/isso.js","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/js/third-party/comments/livere.js","path":"js/third-party/comments/livere.js","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/js/third-party/comments/utterances.js","path":"js/third-party/comments/utterances.js","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/js/third-party/math/katex.js","path":"js/third-party/math/katex.js","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/js/third-party/math/mathjax.js","path":"js/third-party/math/mathjax.js","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/js/third-party/search/algolia-search.js","path":"js/third-party/search/algolia-search.js","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/js/third-party/search/local-search.js","path":"js/third-party/search/local-search.js","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/js/third-party/statistics/firestore.js","path":"js/third-party/statistics/firestore.js","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/js/third-party/statistics/lean-analytics.js","path":"js/third-party/statistics/lean-analytics.js","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/js/third-party/tags/mermaid.js","path":"js/third-party/tags/mermaid.js","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/js/third-party/tags/pdf.js","path":"js/third-party/tags/pdf.js","modified":0,"renderable":1},{"_id":"node_modules/hexo-theme-next/source/js/third-party/tags/wavedrom.js","path":"js/third-party/tags/wavedrom.js","modified":0,"renderable":1},{"_id":"source/CNAME","path":"CNAME","modified":0,"renderable":0},{"_id":"source/d51c23267c55bd8c7faa065331f5986d.txt","path":"d51c23267c55bd8c7faa065331f5986d.txt","modified":0,"renderable":0},{"_id":"source/ciscosec.html","path":"ciscosec.html","modified":0,"renderable":0},{"_id":"source/ebpf.html","path":"ebpf.html","modified":0,"renderable":0},{"_id":"source/ebpfv2.html","path":"ebpfv2.html","modified":0,"renderable":0},{"_id":"source/ebpfsre.html","path":"ebpfsre.html","modified":0,"renderable":0},{"_id":"source/ebpfv3.html","path":"ebpfv3.html","modified":0,"renderable":0},{"_id":"source/isestory.html","path":"isestory.html","modified":0,"renderable":0},{"_id":"source/isestry.html","path":"isestry.html","modified":0,"renderable":0},{"_id":"source/sec8b.html","path":"sec8b.html","modified":0,"renderable":0},{"_id":"source/google518425f6cab1f5d9.html","path":"google518425f6cab1f5d9.html","modified":0,"renderable":0},{"_id":"source/secloop.html","path":"secloop.html","modified":0,"renderable":0},{"_id":"source/isev2.html","path":"isev2.html","modified":0,"renderable":0},{"_id":"source/tetragon.html","path":"tetragon.html","modified":0,"renderable":0},{"_id":"source/sna.html","path":"sna.html","modified":0,"renderable":0},{"_id":"source/works/index.html","path":"works/index.html","modified":0,"renderable":0},{"_id":"source/vast.html","path":"vast.html","modified":0,"renderable":0},{"_id":"source/sitemap.xml","path":"sitemap.xml","modified":0,"renderable":0},{"_id":"source/cilium.html","path":"cilium.html","modified":1,"renderable":0},{"_id":"source/smartswitch.html","path":"smartswitch.html","modified":0,"renderable":0},{"_id":"source/robots.txt","path":"robots.txt","modified":0,"renderable":0},{"_id":"source/dance.html","path":"dance.html","modified":0,"renderable":0}],"Cache":[{"_id":"source/d51c23267c55bd8c7faa065331f5986d.txt","hash":"2cac247156f2780f17242c6981941ff615fb20a3","modified":1765856380817},{"_id":"source/.DS_Store","hash":"d81859531dab14e3028b2027fc80453a5306a7df","modified":1767543068110},{"_id":"source/CNAME","hash":"70933505d53db7579d12f169fd95617b09d1bc02","modified":1765705807385},{"_id":"source/ebpf.html","hash":"ffaf14a76da6a902748f36c99ea25c9c1cb1e0f2","modified":1767517344936},{"_id":"source/ciscosec.html","hash":"d5b842b17a04602f643899b7fb1187451ca08748","modified":1765701679288},{"_id":"source/ebpfv2.html","hash":"5ad83a9251e3782c0519a61435c8b1571346e735","modified":1765776526810},{"_id":"source/ebpfsre.html","hash":"199026747010fb7c4b64b3924ae437c7cbe991d3","modified":1765776231820},{"_id":"source/isestory.html","hash":"954af669dd90732919da280239248fd0a57a964f","modified":1766568527985},{"_id":"source/isestry.html","hash":"9143b2d906962975d01731144ab0f6071b1e2562","modified":1765703019663},{"_id":"source/google518425f6cab1f5d9.html","hash":"42ee49e7b7d67b8f5beaf941008882f02824ec70","modified":1765705807485},{"_id":"source/sec8b.html","hash":"e1e5aac6e2d038cec48674579ed0974ece3abf78","modified":1766568745189},{"_id":"source/secloop.html","hash":"c45133e5bdd740dc94f6b1ff3c319e76ead517b1","modified":1765544599878},{"_id":"source/_posts/.DS_Store","hash":"a13c156e72fba9932a8232230173a280af23bd8b","modified":1767542105035},{"_id":"source/tetragon.html","hash":"989795e97b10d1d071abda3e34b4bffc88ae6da6","modified":1767541218503},{"_id":"source/_posts/BRKSEC-2169-ebpf-md.md","hash":"71686c9b555aa808908af609eb1750c66688d872","modified":1767542331921},{"_id":"source/sna.html","hash":"7dea94721647831e397d2a264e8f9ddc87334112","modified":1766568800020},{"_id":"source/_posts/ChatGPT-generate-code-to-build-AMI-for-AppDynamics.md","hash":"4fa63d1aba37ff07f98e84fb6d35b8f367481b01","modified":1765705807385},{"_id":"source/_posts/Conversation-with-ChatGPT-to-accelerate-Cloud-Develpment.md","hash":"b4554386124f0a24a21216981932823f1f166636","modified":1765705807424},{"_id":"source/_posts/Update-the-cloud-init-code-for-AppD-AMI.md","hash":"00ced5ce592e8e54cd842a8cf0ed75085d6d16c1","modified":1765705807439},{"_id":"source/_posts/anycast-brief.md","hash":"4537668209998739bfcaab03800f31c02e00d439","modified":1765705807440},{"_id":"source/_posts/csr1kv-kvm-Ubuntu20-04-md.md","hash":"1de38010ffdd72e1ed2e812839333adf1b536009","modified":1765705807444},{"_id":"source/_posts/csr1kv-kvm-CentOS7.md","hash":"520813fa0481472b354d6643914277fbc597140d","modified":1765705807440},{"_id":"source/_posts/docker-traceroute-tcpdump.md","hash":"57587a96ee6d390ed3a38fc058ffd4b035ed0f96","modified":1765705807448},{"_id":"source/_posts/csr1kv-kvm-sriov-ubuntu-demo.md","hash":"fa8e8977d6b13ab93e714a9dcfd5b9dd533aee84","modified":1765705807448},{"_id":"source/_posts/deploy-thousandeyes-agent-on-aws.md","hash":"171e8414dce3aee2ec81f974a3a0a998d6c3303a","modified":1765705807448},{"_id":"source/_posts/csr1kv-nfvis-ztp-demo.md","hash":"02c4f9ee8c0499e0ff85a8394a5c24897c1bf68c","modified":1765705807448},{"_id":"source/_posts/get-known-traceroute-by-wireshark.md","hash":"4545ee9c9a4bc76ca65fc525c8afb0841b676125","modified":1765705807459},{"_id":"source/_posts/hexo-setup-log-md.md","hash":"254e02c61791d4a94afd953cfa77c023adc965e1","modified":1765705807477},{"_id":"source/_posts/ise-story-md.md","hash":"15f5abacdab3b99a11512ea2c94537b7426f7384","modified":1765714002696},{"_id":"source/_posts/master-kvm-notes-1.md","hash":"bde6d1fb5b0d019043b3031fc3a2b91158e045bd","modified":1765705807477},{"_id":"source/_posts/traceroute-vulnerability.md","hash":"9bf11d31a19002b3ad602adc0684c14d85183ef0","modified":1765705807477},{"_id":"source/works/index.html","hash":"2e6d503ee474cdc0312b2fad23dcddd5fd61489e","modified":1766568486088},{"_id":"source/tags/index.md","hash":"c50e6bc18ff1e76875cd066775fd80b5aead36c7","modified":1765705807485},{"_id":"source/_posts/csr1kv-kvm-CentOS7/pstree-011.png","hash":"2bab1c1e302f5bf734eb5d02c51c118fc9b6b89e","modified":1765705807441},{"_id":"source/_posts/csr1kv-kvm-CentOS7/line-chart-009.png","hash":"352e2729c2a71e2bb227d15a6a4d3cce5729b571","modified":1765705807440},{"_id":"source/_posts/csr1kv-kvm-CentOS7/virt-manager-1.png","hash":"71f44e79a0e7f49149509cd9da183d976c560a2e","modified":1765705807442},{"_id":"source/_posts/csr1kv-kvm-CentOS7/virt-manager-3.png","hash":"3a84c14af1b971d87b861e56c88ee8da5a6743a8","modified":1765705807443},{"_id":"source/_posts/csr1kv-kvm-CentOS7/virt-manager-5.png","hash":"c537b37388bf9dc92e1dde286ca38255d17405f3","modified":1765705807443},{"_id":"source/_posts/csr1kv-kvm-CentOS7/virt-manager-4.png","hash":"0a4e67cb1b3c4e66b41e7c8999548a0ccd9f7266","modified":1765705807443},{"_id":"source/_posts/csr1kv-kvm-CentOS7/virt-manager-7.png","hash":"55460a74043ce33e3b2c6d388540237e35ba5fe8","modified":1765705807444},{"_id":"source/_posts/csr1kv-kvm-CentOS7/virt-top-012.png","hash":"4d020d807a1653d988e77419032014874e654a77","modified":1765705807444},{"_id":"source/_posts/docker-traceroute-tcpdump/container-module-in-docker-network.png","hash":"ac30ee7ddbdf63b0b895d599dba6d7b9507c9c57","modified":1765705807448},{"_id":"source/_posts/docker-traceroute-tcpdump/traceroute-ubuntu.pcapng","hash":"5fbd9168bdd09b0c66f72fedaf1e687fe5d9fabc","modified":1765705807458},{"_id":"source/_posts/csr1kv-kvm-Ubuntu20-04-md/kvm.zip","hash":"d1a4cffa81bd4a90f5db70ef1ea37109477b8dba","modified":1765705807445},{"_id":"source/_posts/csr1kv-kvm-Ubuntu20-04-md/line-chart.png","hash":"352e2729c2a71e2bb227d15a6a4d3cce5729b571","modified":1765705807445},{"_id":"source/_posts/csr1kv-kvm-Ubuntu20-04-md/virt-manager-step2-2.png","hash":"ef1b6897759374d2e573ddea1db859eaa62d2b1e","modified":1765705807446},{"_id":"source/_posts/csr1kv-kvm-Ubuntu20-04-md/virt-manager-step1.png","hash":"339e0a7440a1f60f4c26d7dabbd72ab81569dfcf","modified":1765705807446},{"_id":"source/_posts/csr1kv-kvm-Ubuntu20-04-md/virt-manager-step3.png","hash":"404dd203a9ce5a233b18d77a154c5313a631af1b","modified":1765705807446},{"_id":"source/_posts/csr1kv-kvm-Ubuntu20-04-md/virt-manager-step2.png","hash":"9f0c4ff08205efbf62df3f082c08b3069be3b087","modified":1765705807446},{"_id":"source/_posts/get-known-traceroute-by-wireshark/Traceroute 过程.drawio","hash":"619fc72c484335da1bbb3a1b5208f95fd430b4a8","modified":1765705807464},{"_id":"source/_posts/get-known-traceroute-by-wireshark/traceroute-google-dns.pcapng","hash":"a9ef8cb9819c88ae7c1b54d0e96f1e36d1fe0b21","modified":1765705807473},{"_id":"source/isev2.html","hash":"d652c4d3ae2a2ce1eee85d4a8ed70451778fddca","modified":1766568774222},{"_id":"source/ebpfv3.html","hash":"5a740bf9204ea000f8d20609b12adb8e850ac430","modified":1766568623511},{"_id":"source/_posts/Ansible-K8S-Cilium.md","hash":"abf015c6f4a172ad47978f5585e395db8958ac0a","modified":1765714432382},{"_id":"source/_posts/csr1kv-kvm-CentOS7/virt-manager-6.png","hash":"4c7a51c24fd1d4f967da3dcf0fe013250fc50bea","modified":1765705807443},{"_id":"source/_posts/csr1kv-kvm-CentOS7/sriov-pool-001.png","hash":"4c7a51c24fd1d4f967da3dcf0fe013250fc50bea","modified":1765705807442},{"_id":"source/_posts/csr1kv-kvm-CentOS7/virt-manager-2.png","hash":"f2657a6be000fd0b98f72f967753c48d7c315934","modified":1765705807442},{"_id":"source/_posts/csr1kv-kvm-CentOS7/macvtap-ibm.png","hash":"6a699f8f1cbba8770fd9c05c20185e992767f0f0","modified":1765705807441},{"_id":"source/_posts/csr1kv-kvm-Ubuntu20-04-md/pic1-sriov-pool.png","hash":"de58ee6a1e67377720cbf24143053bf00de8803d","modified":1765705807445},{"_id":"source/_posts/K8S-Cilium-Replace-kube-proxy.md","hash":"ac4a16cf2ba99f26637cadf87be5450afabbb6b0","modified":1765722205254},{"_id":"source/_posts/docker-traceroute-tcpdump/thousandeyes-path-node2.png","hash":"720dfa311b76c5756062d8b1198038ccf5759cd6","modified":1765705807456},{"_id":"source/_posts/docker-traceroute-tcpdump/probe-anycast-dns.png","hash":"2ac4d27e4563fb855fb107812225e61f97ccc529","modified":1765705807454},{"_id":"source/_posts/docker-traceroute-tcpdump/thousandeyes-path-node3.png","hash":"d5f4234028428b97a424414b6d3f365d5b8fb25b","modified":1765705807457},{"_id":"source/_posts/csr1kv-kvm-Ubuntu20-04-md/add-sriov-pool.png","hash":"a0182bed9cf1c71aaca761f0f9179fcb9d47169b","modified":1765705807445},{"_id":"source/_posts/traceroute-vulnerability/traceroute-vulnerability.png","hash":"b0aeb8bbf976d0885a164e7a29a9ef74e738a5ab","modified":1765705807485},{"_id":"source/_posts/get-known-traceroute-by-wireshark/AS-query-1.png","hash":"79fcf93b7d51b71534b3c3d836904c390860c3cd","modified":1765705807460},{"_id":"source/_posts/get-known-traceroute-by-wireshark/whois-query.png","hash":"d5366bd1f17ee201e8f2952bda0f27abb81480a3","modified":1765705807476},{"_id":"source/_posts/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-wgi.png","hash":"20cd3993f5cff1ed1ddc9e0fc355147a0b585d8c","modified":1765705807403},{"_id":"source/_posts/docker-traceroute-tcpdump/thousandeyes-path-node1.png","hash":"da7dd3d1a044407056b74dd053c8d71e50b56435","modified":1765705807455},{"_id":"source/_posts/get-known-traceroute-by-wireshark/UDP-Probe-1.png","hash":"eab39f7f9d35389298afcd7ede44848e26dd7145","modified":1765705807467},{"_id":"source/_posts/get-known-traceroute-by-wireshark/dns-query-1.png","hash":"ba898b23c44208eb0939451c362a28f50e90d0fe","modified":1765705807469},{"_id":"source/_posts/get-known-traceroute-by-wireshark/UDP-Probe-2.png","hash":"7b79da06f083c9b0adb3bcd9ff06840a8300e735","modified":1765705807468},{"_id":"source/_posts/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230302-a8.png","hash":"d6fd0e84a3f4d7eb0914e6ddc4001259eccfbebc","modified":1765705807419},{"_id":"source/_posts/csr1kv-kvm-CentOS7/nic-type-010.png","hash":"4237997ed132f71c42a810f56e4afb7bfeb67436","modified":1765705807441},{"_id":"source/_posts/Conversation-with-ChatGPT-to-accelerate-Cloud-Develpment/SCR-20230302-a8.png","hash":"d6fd0e84a3f4d7eb0914e6ddc4001259eccfbebc","modified":1765705807434},{"_id":"source/_posts/docker-traceroute-tcpdump/te-agent-docker.png","hash":"b8df1b5007cf006bc004cdf51e305914ee36314e","modified":1765705807454},{"_id":"source/_posts/docker-traceroute-tcpdump/thousandeyes-path.png","hash":"64ee31316cca3f8422860c17d58f535ba5d39ae9","modified":1765705807458},{"_id":"source/_posts/docker-traceroute-tcpdump/wireshark-int-list.png","hash":"ab66357bcb176fcb41009c8fb785134168a24200","modified":1765705807459},{"_id":"source/_posts/get-known-traceroute-by-wireshark/ICMP-last-reply.png","hash":"1326cee55ed3a9facac625b362535a908026d6e0","modified":1765705807464},{"_id":"source/_posts/get-known-traceroute-by-wireshark/whois-answer-2.png","hash":"84c12c1a8fc15c7057511b10a324b8e5a98c2305","modified":1765705807474},{"_id":"source/_posts/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-wzx.png","hash":"c3a00473cd641a53f13a48002bbf278111af71f7","modified":1765705807412},{"_id":"source/_posts/get-known-traceroute-by-wireshark/ICMP-Reply-1.png","hash":"b15b6f57e8503ac92da75d5bf17dddd9891972ef","modified":1765705807463},{"_id":"source/_posts/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-w6k.png","hash":"9254504b8dd2c99941eb97f381f2360052e1709e","modified":1765705807397},{"_id":"source/_posts/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-w1c.png","hash":"5d661c9fa7ae0f9415696d9095e51a61e60c9cbb","modified":1765705807393},{"_id":"source/_posts/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-wa6.png","hash":"f8ad3092d8326e1b5aea70375ad7268fe54b429e","modified":1765705807400},{"_id":"source/_posts/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-wle.png","hash":"3a927dc542cc62c62bc103463f7765eaf3d043d0","modified":1765705807406},{"_id":"source/_posts/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230302-b8.png","hash":"2e2c3e855ec62bad0a014b468c92acda639a0096","modified":1765705807421},{"_id":"source/_posts/Conversation-with-ChatGPT-to-accelerate-Cloud-Develpment/SCR-20230301-wa6.png","hash":"f8ad3092d8326e1b5aea70375ad7268fe54b429e","modified":1765705807425},{"_id":"source/_posts/Conversation-with-ChatGPT-to-accelerate-Cloud-Develpment/SCR-20230302-b8.png","hash":"2e2c3e855ec62bad0a014b468c92acda639a0096","modified":1765705807435},{"_id":"source/_posts/Conversation-with-ChatGPT-to-accelerate-Cloud-Develpment/SCR-20230303-mp.png","hash":"d4917008d7a2bb98bc406ec288b320e5abbb2589","modified":1765705807439},{"_id":"source/_posts/csr1kv-kvm-Ubuntu20-04-md/virt-manager-step4.png","hash":"2015e74980373bec96834688d588e28ca5ddc2a5","modified":1765705807447},{"_id":"source/_posts/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-vv3.png","hash":"c5c38234cc1b84bcca3a5984d55c31d4229c3198","modified":1765705807387},{"_id":"source/_posts/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-vxg.png","hash":"f5ddd7e677e815a730d9bc2665ad261a920257db","modified":1765705807389},{"_id":"source/_posts/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-w1t.png","hash":"231e7589a6d0f5f1cccb1b32b49fadf5a653991f","modified":1765705807395},{"_id":"source/_posts/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-vz3.png","hash":"7a666bc3699e8f361d68fcf5ff2260b3bde48911","modified":1765705807391},{"_id":"source/_posts/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-w8d.png","hash":"7e295cbfa78cab58847bd671a30dbaa96643d7fb","modified":1765705807399},{"_id":"source/_posts/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-wi7.png","hash":"4738fe480f6fd5186d1f1ed7fd8e70febd01943d","modified":1765705807405},{"_id":"source/_posts/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-x8g.png","hash":"9580aadab1d967138b7828043aef1d219dd5de2a","modified":1765705807416},{"_id":"source/_posts/Conversation-with-ChatGPT-to-accelerate-Cloud-Develpment/SCR-20230301-x8g.png","hash":"9580aadab1d967138b7828043aef1d219dd5de2a","modified":1765705807431},{"_id":"source/_posts/Conversation-with-ChatGPT-to-accelerate-Cloud-Develpment/SCR-20230302-w8m.png","hash":"cd914a5238bb402bae8a6a12724d3c41d038d5d7","modified":1765705807437},{"_id":"source/_posts/get-known-traceroute-by-wireshark/whois-answer.png","hash":"9471e012ac5271b21d0a64824608ff6a5a323e03","modified":1765705807476},{"_id":"source/_posts/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-x5q.png","hash":"184e313d7a309da4e95e68c6165378a04cddd0fc","modified":1765705807415},{"_id":"source/_posts/Conversation-with-ChatGPT-to-accelerate-Cloud-Develpment/SCR-20230301-x5q.png","hash":"184e313d7a309da4e95e68c6165378a04cddd0fc","modified":1765705807430},{"_id":"source/_posts/traceroute-vulnerability/icmp-echo-reply.png","hash":"e96d5dc9113d9e198035b0220b9db8293e6be685","modified":1765705807479},{"_id":"source/_posts/get-known-traceroute-by-wireshark/AS-reply-1.png","hash":"b0b5c5085d72881149131a8defa6c66165c1c2a1","modified":1765705807461},{"_id":"source/_posts/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-wdb.png","hash":"fce9e8cf9493d3f77ae5fd87a5d7ebfd82d8eb8f","modified":1765705807402},{"_id":"source/_posts/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-wob.png","hash":"5439ae7fe8a235a21ee01ad8cc8426c7074f2b5f","modified":1765705807411},{"_id":"source/_posts/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230302-8x.png","hash":"463b295e0330a8108b5fd52a9298b2933a208277","modified":1765705807418},{"_id":"source/_posts/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-wn8.png","hash":"818624ccd379d0bf060bf24bb78ae96d5b3c1fb2","modified":1765705807409},{"_id":"source/_posts/Conversation-with-ChatGPT-to-accelerate-Cloud-Develpment/SCR-20230301-wdb.png","hash":"fce9e8cf9493d3f77ae5fd87a5d7ebfd82d8eb8f","modified":1765705807427},{"_id":"source/_posts/Conversation-with-ChatGPT-to-accelerate-Cloud-Develpment/SCR-20230302-8x.png","hash":"463b295e0330a8108b5fd52a9298b2933a208277","modified":1765705807433},{"_id":"source/_posts/Conversation-with-ChatGPT-to-accelerate-Cloud-Develpment/SCR-20230301-wob.png","hash":"5439ae7fe8a235a21ee01ad8cc8426c7074f2b5f","modified":1765705807428},{"_id":"node_modules/hexo-theme-next/_vendors.yml","hash":"3a282d441261c607928c34bea71ccbf92f910a97","modified":1765705245617},{"_id":"node_modules/hexo-theme-next/package.json","hash":"f32bd16fff879fd8624fe34097390613a8caab69","modified":1765705245576},{"_id":"node_modules/hexo-theme-next/README.md","hash":"6f1bf93dbccc8545872fe27b4693fda59cdbfb89","modified":1765705245579},{"_id":"node_modules/hexo-theme-next/_config.yml","hash":"9be7c9254da20280bccf46327a4fa2daf7e8cce3","modified":1765705245617},{"_id":"node_modules/hexo-theme-next/LICENSE.md","hash":"68fc9a03d50fd4b5ea97092b05967d1819dea2c4","modified":1765705245578},{"_id":"node_modules/hexo-theme-next/docs/.DS_Store","hash":"53ac55dbbb85ecf33325e9619a3ff823f859be80","modified":1765705250658},{"_id":"node_modules/hexo-theme-next/docs/AGPL3.md","hash":"0d2b8c5fa8a614723be0767cc3bca39c49578036","modified":1765705245576},{"_id":"node_modules/hexo-theme-next/docs/AUTHORS.md","hash":"a648823121563c34a177ae91f5a774b5e29f01a0","modified":1765705245577},{"_id":"node_modules/hexo-theme-next/languages/README.md","hash":"b2567e32805dda79601157351a07e5ca9fe01315","modified":1765705245578},{"_id":"node_modules/hexo-theme-next/.DS_Store","hash":"836abd4ddc8fb77a61b1b4c53e70404c5004679c","modified":1765705255750},{"_id":"node_modules/hexo-theme-next/languages/ar.yml","hash":"7d0f39e8684284a04bb9808521c87fecda8bd131","modified":1765705245617},{"_id":"node_modules/hexo-theme-next/languages/bn.yml","hash":"564bed75da6e05b11dce6164508f97a15e2fb6c2","modified":1765705245617},{"_id":"node_modules/hexo-theme-next/languages/en.yml","hash":"ba0fd79a2b1d8db01a034180556061745965ff05","modified":1765705245617},{"_id":"node_modules/hexo-theme-next/languages/de.yml","hash":"79b37df731c29665dee6cd7c90d278e1edfb6e24","modified":1765705245617},{"_id":"node_modules/hexo-theme-next/languages/eo.yml","hash":"e34bb33ae827bf2f0727088599a73bc64bdad1b0","modified":1765705245617},{"_id":"node_modules/hexo-theme-next/languages/fr.yml","hash":"8ac44e58f71a38b7697a2f7f98a6971ed818cb5b","modified":1765705245618},{"_id":"node_modules/hexo-theme-next/languages/es.yml","hash":"dffc63ef42e1266b88e0acf08994fd17a9908d53","modified":1765705245618},{"_id":"node_modules/hexo-theme-next/docs/LICENSE.txt","hash":"f5b14f791b7cfa1d16da981d929152e088a5d1b8","modified":1765705245617},{"_id":"node_modules/hexo-theme-next/languages/id.yml","hash":"929df147f4f17d638b07de5fe52ca13e2549ab1c","modified":1765705245618},{"_id":"node_modules/hexo-theme-next/languages/it.yml","hash":"16d716ecfd748def2f6486ef5a82d0ab7ceb4890","modified":1765705245618},{"_id":"node_modules/hexo-theme-next/languages/ja.yml","hash":"543222bfc516aab6c33e8534f807972ecb8943a9","modified":1765705245618},{"_id":"node_modules/hexo-theme-next/languages/ko.yml","hash":"d345a303310c8a5f4836c3683f3580f861ebd1b4","modified":1765705245618},{"_id":"node_modules/hexo-theme-next/languages/nl.yml","hash":"3cb3687696635ec71b4ca40c5fc43b56acc8843e","modified":1765705245618},{"_id":"node_modules/hexo-theme-next/languages/pt-BR.yml","hash":"76b8576ce228d540a16b1f0af5af2cce20923194","modified":1765705245618},{"_id":"node_modules/hexo-theme-next/languages/fa.yml","hash":"f3ffc444599f4ac92d62e9ed00a1490ebc277d70","modified":1765705245618},{"_id":"node_modules/hexo-theme-next/languages/pt.yml","hash":"b62faaa767a45a613dd042b5f1903675eb5a8cf9","modified":1765705245618},{"_id":"node_modules/hexo-theme-next/languages/si.yml","hash":"2d712eedf3f60d04d36c3108cf5a12e2a52e875c","modified":1765705245618},{"_id":"node_modules/hexo-theme-next/languages/th.yml","hash":"6829e998b39f8f143e20b276bb1f62d95a29de58","modified":1765705245618},{"_id":"node_modules/hexo-theme-next/languages/ru.yml","hash":"c6d8de0ff7d8148d09993257cfd3b7aca755696c","modified":1765705245618},{"_id":"node_modules/hexo-theme-next/languages/tr.yml","hash":"a57e4ed089b893a95f5e1ecff17ce625165f4d46","modified":1765705245619},{"_id":"node_modules/hexo-theme-next/languages/tk.yml","hash":"511726054873f6f8d7ce0d2e803f6731de0ddbe7","modified":1765705245618},{"_id":"node_modules/hexo-theme-next/languages/vi.yml","hash":"7ebcba5e1128784195e4681dffc9d34c4e873fec","modified":1765705245619},{"_id":"node_modules/hexo-theme-next/languages/zh-CN.yml","hash":"741d7efe0262c9cdc2c648014b55599665d90f6b","modified":1765705245619},{"_id":"node_modules/hexo-theme-next/languages/uk.yml","hash":"ff537047b4b4c3ca9a7b64fa7f428a9942751eeb","modified":1765705245619},{"_id":"node_modules/hexo-theme-next/languages/zh-TW.yml","hash":"5c0f00cdac3f4727b880dd223f622a535736fa8e","modified":1765705245619},{"_id":"node_modules/hexo-theme-next/languages/zh-HK.yml","hash":"8eb6a9f231ce1bfa54cc54418ccf14f01dcc9a31","modified":1765705245619},{"_id":"node_modules/hexo-theme-next/scripts/.DS_Store","hash":"c129b199ff62e4c502080b11c3064d0857723ff5","modified":1765705250658},{"_id":"node_modules/hexo-theme-next/layout/_layout.njk","hash":"b17d44bd7379c23241053a0b7fbd38c9c43cc239","modified":1765705245579},{"_id":"node_modules/hexo-theme-next/layout/category.njk","hash":"c68b7343d0f8145010f93351908cc36ef6212ec1","modified":1765705245580},{"_id":"node_modules/hexo-theme-next/layout/archive.njk","hash":"d759f4d2cf5ddc6875ea250113a00662c1caf6d1","modified":1765705245579},{"_id":"node_modules/hexo-theme-next/layout/.DS_Store","hash":"4dc9141f873d407f6dd73be2c30512d75fbb72ea","modified":1765705255737},{"_id":"node_modules/hexo-theme-next/layout/page.njk","hash":"af6d7570621be760536c216a56d74e40a1cceae2","modified":1765705245588},{"_id":"node_modules/hexo-theme-next/layout/index.njk","hash":"dd63e488ae8cc144335a5958acedf6a16edd7a92","modified":1765705245584},{"_id":"node_modules/hexo-theme-next/layout/tag.njk","hash":"9e16ba20c28a7f2c6bc75aa427f48122301a30aa","modified":1765705245592},{"_id":"node_modules/hexo-theme-next/layout/post.njk","hash":"0bfce9f133f501a9a4837257e3b862b3bbca15be","modified":1765705245591},{"_id":"node_modules/hexo-theme-next/scripts/events/index.js","hash":"bd9ea82376cd87df611ea3ae077875c7c595a3df","modified":1765705245570},{"_id":"node_modules/hexo-theme-next/docs/zh-CN/README.md","hash":"93064dbd1a461d55c7c07a04626294c8150b4d1b","modified":1765705245578},{"_id":"node_modules/hexo-theme-next/scripts/filters/default-injects.js","hash":"872f01cb10e422a648ea505436532e776e92926b","modified":1765705245568},{"_id":"node_modules/hexo-theme-next/scripts/filters/post.js","hash":"fdc8a0af90035e89c3fcb754a0eb189b8951a2bc","modified":1765705245574},{"_id":"node_modules/hexo-theme-next/scripts/filters/locals.js","hash":"9eb5310664759931287dd28ea39165dfb67f12ed","modified":1765705245572},{"_id":"node_modules/hexo-theme-next/scripts/helpers/engine.js","hash":"83235f2879567eb8686431c9554a4b99f14ab665","modified":1765705245569},{"_id":"node_modules/hexo-theme-next/scripts/filters/minify.js","hash":"43db8690d67c7545c5f081dbdc2601a0b2a16c5a","modified":1765705245572},{"_id":"node_modules/hexo-theme-next/scripts/helpers/font.js","hash":"4c84d45daac86396edf656d2a8abe6e7583491ea","modified":1765705245569},{"_id":"node_modules/hexo-theme-next/scripts/helpers/navigation.js","hash":"78107021101553c3d23e89290f7530b60cf4aa86","modified":1765705245573},{"_id":"node_modules/hexo-theme-next/scripts/helpers/next-url.js","hash":"6281d47c1de98eb38f3aa0f6df29bbb19d412173","modified":1765705245573},{"_id":"node_modules/hexo-theme-next/scripts/helpers/next-paginator.js","hash":"e86c764b546e4fbb87970cabc4135a56f9ef9fe1","modified":1765705245573},{"_id":"node_modules/hexo-theme-next/scripts/helpers/next-vendors.js","hash":"af3946a595f997eb43d9af87428e4898c9acbc82","modified":1765705245573},{"_id":"node_modules/hexo-theme-next/scripts/helpers/next-config.js","hash":"4bc2eb87f3fa26981652f517d1ab3f81de2ab89d","modified":1765705245573},{"_id":"node_modules/hexo-theme-next/scripts/tags/index.js","hash":"1f6aba7820f1fb58b61969485148db21846e1aa9","modified":1765705245570},{"_id":"node_modules/hexo-theme-next/scripts/tags/button.js","hash":"c6ad2ed544fbb25ecb5d820c36e76302504271b7","modified":1765705245564},{"_id":"node_modules/hexo-theme-next/scripts/tags/center-quote.js","hash":"92c19d796bdb3320df9caea59bf52df7a95d9da9","modified":1765705245565},{"_id":"node_modules/hexo-theme-next/scripts/tags/label.js","hash":"8a73348186113bae0a51ea2f891c1bb882fab05a","modified":1765705245571},{"_id":"node_modules/hexo-theme-next/scripts/tags/mermaid.js","hash":"7d7bbc4a9970bd4c5449bc71b94364a8ec61e5d2","modified":1765705245572},{"_id":"node_modules/hexo-theme-next/scripts/tags/link-grid.js","hash":"18a483c2d5afd701f6080ffdddf2d1321370336c","modified":1765705245571},{"_id":"node_modules/hexo-theme-next/docs/ru/README.md","hash":"30e929e1138445534a6f46d64667c17273337acf","modified":1765705245578},{"_id":"node_modules/hexo-theme-next/docs/zh-CN/CODE_OF_CONDUCT.md","hash":"12a6631617695504d5cf2a94b57d87bd331bef6f","modified":1765705245577},{"_id":"node_modules/hexo-theme-next/scripts/tags/note.js","hash":"7b94ddb46b7d4b0fe815f2fbe4bd375f07f55363","modified":1765705245574},{"_id":"node_modules/hexo-theme-next/source/.DS_Store","hash":"e428ed654d04836c319f3a2d6524e727ca1b2b0a","modified":1765705255738},{"_id":"node_modules/hexo-theme-next/scripts/tags/group-pictures.js","hash":"f57f7e09eb6220f681fa8385082b0960502ce5c4","modified":1765705245570},{"_id":"node_modules/hexo-theme-next/scripts/tags/pdf.js","hash":"344636b6fd7e27e8831c1e194039afc0d61931cd","modified":1765705245574},{"_id":"node_modules/hexo-theme-next/scripts/tags/wavedrom.js","hash":"b44dfeeb58b41945d469141787f3dbce4b117d08","modified":1765705245576},{"_id":"node_modules/hexo-theme-next/scripts/tags/caniuse.js","hash":"935a311142a409c1896b3ae3f01fe7a9e2db1134","modified":1765705245565},{"_id":"node_modules/hexo-theme-next/scripts/tags/video.js","hash":"2ee926448583be8f95af1f2884ae2c9c4830151d","modified":1765705245576},{"_id":"node_modules/hexo-theme-next/docs/zh-CN/CONTRIBUTING.md","hash":"a089f7a8368ab0b7d7b9b7ec0ac3767a453435df","modified":1765705245578},{"_id":"node_modules/hexo-theme-next/scripts/tags/tabs.js","hash":"0eabe51da40b4b13e16419c8fe02452d9a4fef73","modified":1765705245575},{"_id":"node_modules/hexo-theme-next/source/css/_mixins.styl","hash":"2424dd832db15a563c6c9dd10605b762392ba9de","modified":1765705245596},{"_id":"node_modules/hexo-theme-next/source/css/noscript.styl","hash":"dadc81256afb127b77eac6763d5ee0ec9c77f0a3","modified":1765705245611},{"_id":"node_modules/hexo-theme-next/source/css/main.styl","hash":"921a58577f411cf4eb5cfd66db0a241f8f88578c","modified":1765705245609},{"_id":"node_modules/hexo-theme-next/source/css/_colors.styl","hash":"26b7ee70a35327fc12a22dc7e67a73181dc94878","modified":1765705245594},{"_id":"node_modules/hexo-theme-next/source/js/bookmark.js","hash":"9ba4cceafd12c6d5ba8a6b986a046ef8319a7811","modified":1765705245564},{"_id":"node_modules/hexo-theme-next/source/js/comments.js","hash":"66ae2e26ea36a41b72c638ea8b220296638ae952","modified":1765705245567},{"_id":"node_modules/hexo-theme-next/source/js/config.js","hash":"4c4ebbe3b3f3841a26f9d5af6d0ba8bc6da01c54","modified":1765705245568},{"_id":"node_modules/hexo-theme-next/source/js/comments-buttons.js","hash":"1a7344440321713426a0b2ab17e276b5bdf85ade","modified":1765705245567},{"_id":"node_modules/hexo-theme-next/source/js/next-boot.js","hash":"d434a2a8543fb09245eaf2bc6ca123435bfa4dbb","modified":1765705245573},{"_id":"node_modules/hexo-theme-next/source/js/motion.js","hash":"6f751f5c9499a39d7c5e1d323db3260342dd9431","modified":1765705245572},{"_id":"node_modules/hexo-theme-next/source/css/.DS_Store","hash":"02d4e8257eb1b0aa05ecbc969b96252d100f0450","modified":1765705250674},{"_id":"node_modules/hexo-theme-next/source/js/pjax.js","hash":"694b271819aab37ce473b15db9e6aded971d82e5","modified":1765705245574},{"_id":"node_modules/hexo-theme-next/source/js/sidebar.js","hash":"2ee359ae48273b01ba1e0768704524e08702c7eb","modified":1765705245575},{"_id":"node_modules/hexo-theme-next/source/images/apple-touch-icon-next.png","hash":"2959dbc97f31c80283e67104fe0854e2369e40aa","modified":1765705245593},{"_id":"node_modules/hexo-theme-next/source/images/avatar.gif","hash":"2dbc3e2f2d624b2ca1afe6edc2ca17307f1950c8","modified":1765705245563},{"_id":"node_modules/hexo-theme-next/source/js/schedule.js","hash":"9c41a73ed3e8db8ca4cb53633b6f616279a5a7bd","modified":1765705245575},{"_id":"node_modules/hexo-theme-next/source/images/favicon-16x16-next.png","hash":"943a0d67a9cdf8c198109b28f9dbd42f761d11c3","modified":1765705245593},{"_id":"node_modules/hexo-theme-next/source/images/logo.svg","hash":"099e11ab995a2c8981427a85476d082609848c77","modified":1765705245617},{"_id":"node_modules/hexo-theme-next/source/images/favicon-32x32-next.png","hash":"0749d7b24b0d2fae1c8eb7f671ad4646ee1894b1","modified":1765705245594},{"_id":"node_modules/hexo-theme-next/layout/_macro/sidebar.njk","hash":"85f3a2ab22601a9606f2f630289db1363b98018f","modified":1765705245592},{"_id":"node_modules/hexo-theme-next/layout/_macro/post-collapse.njk","hash":"313637fe3569f98fd926e8cd0fcc75d098eb6e6e","modified":1765705245588},{"_id":"node_modules/hexo-theme-next/layout/_partials/comments.njk","hash":"390d6cc85dca43541bd957a8a35c72d75b37ca72","modified":1765705245581},{"_id":"node_modules/hexo-theme-next/source/js/utils.js","hash":"6734719bb74e4d9818992b0e4a745c2a1aefd5e2","modified":1765705245575},{"_id":"node_modules/hexo-theme-next/layout/_partials/languages.njk","hash":"e43f22198cccb5f6e306b1ce0d28d12a4fb891f8","modified":1765705245584},{"_id":"node_modules/hexo-theme-next/layout/_partials/pagination.njk","hash":"bc719473ed5948ab6859449d60b8d36cfc1542b4","modified":1765705245588},{"_id":"node_modules/hexo-theme-next/source/images/logo-algolia-nebula-blue-full.svg","hash":"a38c6d92b368bfc42c72ad799ad03f3274957065","modified":1765705245617},{"_id":"node_modules/hexo-theme-next/layout/_macro/post.njk","hash":"ec9bb9c5ede773c02f0c8d8475245a8a437a2b71","modified":1765705245591},{"_id":"node_modules/hexo-theme-next/layout/_partials/footer.njk","hash":"fbf8232cacf0df87e88e74860be66c9f86018302","modified":1765705245582},{"_id":"node_modules/hexo-theme-next/layout/_third-party/addtoany.njk","hash":"ef64c6bfb8540cd874701236b9be47db2496e98e","modified":1765705245579},{"_id":"node_modules/hexo-theme-next/layout/_scripts/index.njk","hash":"2a7dfffebad19b67dc9e3b2a6b2986d0630ef930","modified":1765705245583},{"_id":"node_modules/hexo-theme-next/layout/_partials/widgets.njk","hash":"d83fb59f02c5e6630a7770401a05c02f6f07358b","modified":1765705245593},{"_id":"node_modules/hexo-theme-next/layout/_scripts/vendors.njk","hash":"7261e24287984853c8ef08cda8bbc80cacf9bd6f","modified":1765705245593},{"_id":"node_modules/hexo-theme-next/layout/_partials/.DS_Store","hash":"f77c501ff623f9e6d487218f8e44b727c85a94db","modified":1765705250653},{"_id":"node_modules/hexo-theme-next/layout/_third-party/quicklink.njk","hash":"0efed71ed530447718c4ea5bbd5fc8695b0b0d5f","modified":1765705245592},{"_id":"node_modules/hexo-theme-next/scripts/events/lib/config.js","hash":"00af4f5f9a79eaccf051f9e372d233d65d44c8a5","modified":1765705245568},{"_id":"node_modules/hexo-theme-next/layout/_third-party/fancybox.njk","hash":"844559f46e2ff1c8be234d5763703106e2072a7b","modified":1765705245581},{"_id":"node_modules/hexo-theme-next/scripts/events/lib/highlight.js","hash":"8a8f752260be5b8098393f9879b61ffe904465e8","modified":1765705245570},{"_id":"node_modules/hexo-theme-next/scripts/events/lib/vendors.js","hash":"e2b4a9d6b08155735ec336eedc506763d5671821","modified":1765705245576},{"_id":"node_modules/hexo-theme-next/scripts/events/lib/injects.js","hash":"d987709267a1bc6e5014411e9983d7c49c102c16","modified":1765705245571},{"_id":"node_modules/hexo-theme-next/scripts/events/lib/utils.js","hash":"5942feb3f31ed3480bf50b0f5a4a305b5bdca3d6","modified":1765705245575},{"_id":"node_modules/hexo-theme-next/scripts/filters/comment/default-config.js","hash":"93ee5f9109dad885dc38c49bcee630c10f9dce6e","modified":1765705245568},{"_id":"node_modules/hexo-theme-next/scripts/filters/comment/common.js","hash":"19a402a225c31edffc50f202a14e0d582d3db23e","modified":1765705245568},{"_id":"node_modules/hexo-theme-next/scripts/filters/comment/disqus.js","hash":"7f71d6b271ba65ff333d5682e7575711d368c0d2","modified":1765705245568},{"_id":"node_modules/hexo-theme-next/scripts/filters/comment/disqusjs.js","hash":"a600a98e7436edeb31e291abca359885567df3c9","modified":1765705245569},{"_id":"node_modules/hexo-theme-next/scripts/filters/comment/gitalk.js","hash":"7bb7dafdd7f6bca8464b54e17e552ce7f1714195","modified":1765705245570},{"_id":"node_modules/hexo-theme-next/scripts/filters/comment/isso.js","hash":"ff8b5b5145220a17d0ecd9508ba9bd2d3b2da47d","modified":1765705245571},{"_id":"node_modules/hexo-theme-next/scripts/filters/comment/livere.js","hash":"5a07d8bb52bc1d51a624ca8db54be144566c306b","modified":1765705245572},{"_id":"node_modules/hexo-theme-next/layout/_third-party/pace.njk","hash":"d7ad5714079f7f65446f880baf14722435ca9061","modified":1765705245588},{"_id":"node_modules/hexo-theme-next/scripts/filters/comment/changyan.js","hash":"5dcaefacbcb9e99d87348d2f7158dbfb4d47b405","modified":1765705245565},{"_id":"node_modules/hexo-theme-next/scripts/events/lib/navigation.js","hash":"dd3562686d95a50375e6fd32e717ccb0d99c1e3d","modified":1765705245573},{"_id":"node_modules/hexo-theme-next/scripts/filters/comment/utterances.js","hash":"d3bded697bc32dace689d2a6dfb6eb7514169d15","modified":1765705245575},{"_id":"node_modules/hexo-theme-next/source/css/_variables/Gemini.styl","hash":"96e0a7c2a65ce68215e17e369085b2ea2f1334f2","modified":1765705245604},{"_id":"node_modules/hexo-theme-next/layout/_third-party/index.njk","hash":"dfd7cdd6ba89f8c3deabc27726c7a350cadafd11","modified":1765705245583},{"_id":"node_modules/hexo-theme-next/source/css/_variables/Muse.styl","hash":"879b49f693af0c04c285b2dd0c9cccaf77347b7c","modified":1765705245610},{"_id":"node_modules/hexo-theme-next/source/js/third-party/addtoany.js","hash":"a772605646dcfb67620a10ee8ef23c38a6d19d80","modified":1765705245563},{"_id":"node_modules/hexo-theme-next/layout/_third-party/.DS_Store","hash":"c2ffcd36d2cad38cfd6f342162d8322587c23bfe","modified":1765705250656},{"_id":"node_modules/hexo-theme-next/source/js/third-party/pace.js","hash":"0ef04218b93561ba4d0ff420d556c3d90a756d32","modified":1765705245574},{"_id":"node_modules/hexo-theme-next/source/css/_variables/Mist.styl","hash":"2c800eaab6c613e5d091be2111aaa786641aa0c2","modified":1765705245610},{"_id":"node_modules/hexo-theme-next/source/css/_variables/Pisces.styl","hash":"20d5c6aa136bbb55e03906d98ee90ad3fbaa80a7","modified":1765705245611},{"_id":"node_modules/hexo-theme-next/layout/_partials/head/head-unique.njk","hash":"93c1d103d9d16581c944c51f3d0638f57c80ee41","modified":1765705245583},{"_id":"node_modules/hexo-theme-next/source/js/third-party/fancybox.js","hash":"819f382c561fe5ec23c67cc5fabd63dd1cc22dc1","modified":1765705245569},{"_id":"node_modules/hexo-theme-next/layout/_partials/head/head.njk","hash":"5388b157bba4a40b9312f4a45c6678974ccf0837","modified":1765705245583},{"_id":"node_modules/hexo-theme-next/source/css/_variables/base.styl","hash":"b724edca546373d5eaf9b3602868f971c9094cf6","modified":1765705245599},{"_id":"node_modules/hexo-theme-next/source/js/third-party/quicklink.js","hash":"eed02e6fced8e5a653077205d4d4d7834ca71472","modified":1765705245574},{"_id":"node_modules/hexo-theme-next/layout/_partials/header/index.njk","hash":"650de421a8ce4cf685428ffbe0087ff84cbd1356","modified":1765705245583},{"_id":"node_modules/hexo-theme-next/layout/_partials/header/menu.njk","hash":"ee6fc2f111572d3eeab0a2fecbb2d6b3e37ab26b","modified":1765705245587},{"_id":"node_modules/hexo-theme-next/layout/_partials/header/sub-menu.njk","hash":"06480d8ec5f0b87eafd47f082f07968d7282dd5c","modified":1765705245592},{"_id":"node_modules/hexo-theme-next/layout/_partials/post/post-followme.njk","hash":"c1e33b4889f75acc490af3c8bde0ec56c518ff41","modified":1765705245590},{"_id":"node_modules/hexo-theme-next/layout/_partials/post/post-related.njk","hash":"e0986db00a0201dd3c60570f964829c84ba5bc68","modified":1765705245591},{"_id":"node_modules/hexo-theme-next/layout/_partials/post/post-copyright.njk","hash":"bfff923526d6800218f08dba6ce0bbf5c17755fd","modified":1765705245589},{"_id":"node_modules/hexo-theme-next/layout/_partials/header/brand.njk","hash":"dd9c4c03e99dfde0dfb8edefcb2c933f2f560efc","modified":1765705245579},{"_id":"node_modules/hexo-theme-next/layout/_partials/header/menu-item.njk","hash":"41a8b0cc16f60fa085cb719d07216d86b6bc4bf8","modified":1765705245587},{"_id":"node_modules/hexo-theme-next/layout/_partials/post/post-share.njk","hash":"16696990e4ce65fc8db18c4635082a5d5d06ff07","modified":1765705245591},{"_id":"node_modules/hexo-theme-next/layout/_partials/search/index.njk","hash":"6ad43135bd3aecf933ffdd750763e27ade36f97c","modified":1765705245583},{"_id":"node_modules/hexo-theme-next/layout/_partials/post/post-reward.njk","hash":"e8b8a7c41e9ec612d0c0c73419529d55d1c16256","modified":1765705245591},{"_id":"node_modules/hexo-theme-next/layout/_partials/sidebar/site-overview.njk","hash":"bc5708e38b6070dff0cab6bf9480971017ce4dda","modified":1765705245592},{"_id":"node_modules/hexo-theme-next/layout/_partials/page/breadcrumb.njk","hash":"89825e75cc45e9709fa6ba89883669eedaff6f46","modified":1765705245580},{"_id":"node_modules/hexo-theme-next/layout/_partials/page/schedule.njk","hash":"0f4bc8e257da60f77c0c1738607b2bde55810684","modified":1765705245592},{"_id":"node_modules/hexo-theme-next/layout/_partials/page/categories.njk","hash":"17156d99941f28a225951ffdcfa9a115e20dc2d2","modified":1765705245580},{"_id":"node_modules/hexo-theme-next/layout/_partials/page/tags.njk","hash":"a18d1598e36cc72f2b0b24c3cc3c5990dfaa3254","modified":1765705245592},{"_id":"node_modules/hexo-theme-next/layout/_partials/page/page-header.njk","hash":"7ed4f102a1825195cff8d7995bf9219f323a9034","modified":1765705245588},{"_id":"node_modules/hexo-theme-next/layout/_partials/post/post-meta.njk","hash":"9fa47e4fb342811da590ee4adc91cf81118c0a39","modified":1765705245590},{"_id":"node_modules/hexo-theme-next/layout/_third-party/analytics/growingio.njk","hash":"8afaa772c390bd9d53a5cff9645ac3168334eb98","modified":1765705245582},{"_id":"node_modules/hexo-theme-next/layout/_third-party/analytics/google-analytics.njk","hash":"d89066ff53879693f023e540d59c86137172c529","modified":1765705245582},{"_id":"node_modules/hexo-theme-next/layout/_third-party/analytics/cloudflare.njk","hash":"a5b8297c2c383124dd6a56e256ecc0c0dcf489be","modified":1765705245581},{"_id":"node_modules/hexo-theme-next/layout/_third-party/analytics/index.njk","hash":"f900306497b133e8b098bd9f4b96b93d1d96c185","modified":1765705245583},{"_id":"node_modules/hexo-theme-next/layout/_third-party/analytics/baidu-analytics.njk","hash":"6215309aee028dcb734452beec448c5afb6c63fc","modified":1765705245579},{"_id":"node_modules/hexo-theme-next/layout/_third-party/analytics/microsoft-clarity.njk","hash":"1efeeda00db08a3c033798228dd0092ee532cc36","modified":1765705245588},{"_id":"node_modules/hexo-theme-next/layout/_third-party/analytics/matomo.njk","hash":"4e89648a8ec8194c5823064cbca39c938a799006","modified":1765705245586},{"_id":"node_modules/hexo-theme-next/layout/_third-party/analytics/plausible.njk","hash":"ef9f2bb7110507f1c4336800af9157d5fa9765bd","modified":1765705245588},{"_id":"node_modules/hexo-theme-next/layout/_third-party/analytics/umami.njk","hash":"3343750682fbd8535e50f8129be3003ad26015b4","modified":1765705245593},{"_id":"node_modules/hexo-theme-next/layout/_third-party/comments/changyan.njk","hash":"d1c950f8fbdf85e7a3eae5463767a89e858e8220","modified":1765705245581},{"_id":"node_modules/hexo-theme-next/layout/_third-party/comments/livere.njk","hash":"3b13b09fba84ec6000886890a6710736a2b8fafe","modified":1765705245585},{"_id":"node_modules/hexo-theme-next/layout/_third-party/comments/disqusjs.njk","hash":"0749cb6902baecdfd01f779a2a2513f6d2f6a823","modified":1765705245581},{"_id":"node_modules/hexo-theme-next/layout/_third-party/comments/isso.njk","hash":"64cc3bdaf644fd32c0d0a247f29f5b6904da9af3","modified":1765705245584},{"_id":"node_modules/hexo-theme-next/layout/_third-party/comments/utterances.njk","hash":"5a94032bc3512a10ad4328fc19ec07b819a1d687","modified":1765705245593},{"_id":"node_modules/hexo-theme-next/layout/_third-party/comments/gitalk.njk","hash":"b63b7e2ede0d3e66e732fa1a06bda9b19e1e85d4","modified":1765705245582},{"_id":"node_modules/hexo-theme-next/layout/_third-party/comments/disqus.njk","hash":"9375b19a89b7fa9474e558d085af5448d4c5c50c","modified":1765705245581},{"_id":"node_modules/hexo-theme-next/layout/_third-party/search/localsearch.njk","hash":"e45ea3542cdc9ed7ec8447b5e6f35df4c5e82758","modified":1765705245585},{"_id":"node_modules/hexo-theme-next/layout/_third-party/search/algolia-search.njk","hash":"41b28f05e6233fb37700f7151f55868be10a0965","modified":1765705245579},{"_id":"node_modules/hexo-theme-next/layout/_third-party/tags/mermaid.njk","hash":"099e031f52fb8e47b3af5b2684737efc9e643ee7","modified":1765705245588},{"_id":"node_modules/hexo-theme-next/layout/_third-party/tags/pdf.njk","hash":"2c81984cc4f5123103460442f6e046f5b6c97127","modified":1765705245588},{"_id":"node_modules/hexo-theme-next/layout/_third-party/tags/wavedrom.njk","hash":"02202bf563fb5eedde2ccad4d6c5b9109d30a703","modified":1765705245593},{"_id":"node_modules/hexo-theme-next/layout/_third-party/statistics/busuanzi-counter.njk","hash":"55c2468b2b7f035881d494085527d6554f37b556","modified":1765705245580},{"_id":"node_modules/hexo-theme-next/layout/_third-party/statistics/lean-analytics.njk","hash":"2446e748cdc102c78492216319ac02148db7daf6","modified":1765705245585},{"_id":"node_modules/hexo-theme-next/layout/_third-party/statistics/firestore.njk","hash":"d32ebe94560fa95824478ebbff531bffc47b194d","modified":1765705245582},{"_id":"node_modules/hexo-theme-next/layout/_third-party/chat/chatra.njk","hash":"d7263fca16d0278ccf1f6aa1c6df6902a6344a09","modified":1765705245581},{"_id":"node_modules/hexo-theme-next/layout/_third-party/chat/tidio.njk","hash":"02aab857c27fc103216029be991688b12a73a525","modified":1765705245592},{"_id":"node_modules/hexo-theme-next/layout/_third-party/math/index.njk","hash":"abf37fc55aa86702118e8fdf5bf2d389dd589aa0","modified":1765705245583},{"_id":"node_modules/hexo-theme-next/source/css/_common/components/back-to-top.styl","hash":"b8445c828d78a38e2de50bdc86b3bff66285ea0f","modified":1765705245598},{"_id":"node_modules/hexo-theme-next/layout/_third-party/math/katex.njk","hash":"1ebf658690468ea197bdd0416eb7cfa4bd0b083a","modified":1765705245584},{"_id":"node_modules/hexo-theme-next/layout/_third-party/math/mathjax.njk","hash":"3677017fd4572b158311f5f5d870590ab25184e0","modified":1765705245586},{"_id":"node_modules/hexo-theme-next/source/css/_common/components/index.styl","hash":"2298e521253b3bf376a2412271bc2a7d305051f3","modified":1765705245605},{"_id":"node_modules/hexo-theme-next/source/css/_common/outline/mobile.styl","hash":"48b2dfc04df6409c6e0736ccc11462ad97d349b1","modified":1765705245610},{"_id":"node_modules/hexo-theme-next/source/css/_common/components/reading-progress.styl","hash":"90a86045a33c1bae49fc2f6fa1e1b53170c7f77b","modified":1765705245613},{"_id":"node_modules/hexo-theme-next/source/css/_common/outline/index.styl","hash":"8e34df131830d4fa3725e4590a672ba1cf1903e5","modified":1765705245607},{"_id":"node_modules/hexo-theme-next/source/css/_schemes/Mist/_header.styl","hash":"dafc6d23c80d6fe3e55a7711e94210d2479b629a","modified":1765705245594},{"_id":"node_modules/hexo-theme-next/layout/_third-party/statistics/index.njk","hash":"568ddf7955d11d93fb5e842b403a7ac8b1b7fdb1","modified":1765705245584},{"_id":"node_modules/hexo-theme-next/source/css/_schemes/Mist/_menu.styl","hash":"f23c53e32d140091b819be2603d1afbbb5d66933","modified":1765705245595},{"_id":"node_modules/hexo-theme-next/source/css/_schemes/Mist/_posts-expand.styl","hash":"485d23ccb42c0d0c8ead7ea8930dd3e06d79a285","modified":1765705245596},{"_id":"node_modules/hexo-theme-next/source/css/_schemes/Mist/index.styl","hash":"ab16a3dcdc0393b9b582ef59dcc13db9320e917c","modified":1765705245609},{"_id":"node_modules/hexo-theme-next/source/css/_schemes/Gemini/index.styl","hash":"bcbf498d8d3ecea84324f0a59b7f95f389a52b8d","modified":1765705245608},{"_id":"node_modules/hexo-theme-next/source/css/_common/scaffolding/base.styl","hash":"f316ba87f8d3299677fbf8345e1e993c35210e2e","modified":1765705245598},{"_id":"node_modules/hexo-theme-next/source/css/_common/scaffolding/buttons.styl","hash":"a042571d85ff7265f799004239a45f36b716b8a6","modified":1765705245600},{"_id":"node_modules/hexo-theme-next/source/css/_common/scaffolding/comments.styl","hash":"e4fecc889ba3317a64e9abba5842c79dff9b7827","modified":1765705245602},{"_id":"node_modules/hexo-theme-next/source/css/_schemes/Mist/_layout.styl","hash":"fa4fd8f76464e214fb7318f325b13c2b62f4b478","modified":1765705245595},{"_id":"node_modules/hexo-theme-next/source/css/_common/scaffolding/index.styl","hash":"523fb7b653b87ae37fc91fc8813e4ffad87b0d7e","modified":1765705245608},{"_id":"node_modules/hexo-theme-next/source/css/_common/scaffolding/pagination.styl","hash":"f4228c759db4a650c8d38745c2edd1dc83c45687","modified":1765705245611},{"_id":"node_modules/hexo-theme-next/source/css/_common/scaffolding/toggles.styl","hash":"69c66aab4651e2e7ae9e65f08600144970648c60","modified":1765705245616},{"_id":"node_modules/hexo-theme-next/source/css/_schemes/Muse/_menu.styl","hash":"e31f6adbb22a451f07e4661cff9a2f12e4e99a36","modified":1765705245596},{"_id":"node_modules/hexo-theme-next/source/css/_schemes/Muse/_layout.styl","hash":"6569a6640f79d247a8235b3914772c0e2f99ead2","modified":1765705245595},{"_id":"node_modules/hexo-theme-next/source/css/_common/scaffolding/tables.styl","hash":"e840b23d33023e6d45e018f6e84b683dd56efd8d","modified":1765705245616},{"_id":"node_modules/hexo-theme-next/source/css/_common/scaffolding/normalize.styl","hash":"b56367ea676ea8e8783ea89cd4ab150c7da7a060","modified":1765705245611},{"_id":"node_modules/hexo-theme-next/source/css/_schemes/Muse/_header.styl","hash":"3fbfab591f280e2e7f3b0265901c93bc4bd137ed","modified":1765705245594},{"_id":"node_modules/hexo-theme-next/source/css/_schemes/Muse/_sub-menu.styl","hash":"c48ccd8d6651fe1a01faff8f01179456d39ba9b1","modified":1765705245597},{"_id":"node_modules/hexo-theme-next/source/css/_schemes/Muse/_sidebar.styl","hash":"c29a827e82d2820ed8977c92994da73721200fac","modified":1765705245596},{"_id":"node_modules/hexo-theme-next/source/css/_schemes/Pisces/_layout.styl","hash":"a92c4eb16bdb7806079467eb022ccf193bb0f794","modified":1765705245595},{"_id":"node_modules/hexo-theme-next/source/css/_schemes/Pisces/_sidebar.styl","hash":"e792a6233e1d4dbc5fd2f10ae97b7a790b82568b","modified":1765705245597},{"_id":"node_modules/hexo-theme-next/source/css/_schemes/Pisces/_menu.styl","hash":"a03f16ffc7dfdbdc6053f9fd68d77257ba0c559e","modified":1765705245596},{"_id":"node_modules/hexo-theme-next/source/js/third-party/chat/chatra.js","hash":"c32180522788c10e51df1803aa6842ef0432ddc9","modified":1765705245567},{"_id":"node_modules/hexo-theme-next/source/js/third-party/chat/tidio.js","hash":"b0079f6a4601e06ca6fe46e83a2f5af553e9bc3c","modified":1765705245575},{"_id":"node_modules/hexo-theme-next/source/css/_schemes/Pisces/_header.styl","hash":"dc03835e42d82eaf2633cf3b627990ad3e1f5967","modified":1765705245595},{"_id":"node_modules/hexo-theme-next/source/js/third-party/analytics/baidu-analytics.js","hash":"f629acc46ff40c071ffd31b77d5c7616f0fdd778","modified":1765705245564},{"_id":"node_modules/hexo-theme-next/source/css/_schemes/Pisces/_sub-menu.styl","hash":"778ed2ad5643b93970c95626b325defeb586733f","modified":1765705245598},{"_id":"node_modules/hexo-theme-next/source/css/_schemes/Pisces/index.styl","hash":"8000075b227749a7495eaf417cac6ccfbe441580","modified":1765705245609},{"_id":"node_modules/hexo-theme-next/source/js/third-party/comments/changyan.js","hash":"6c65d5a585b7dd75e5f0fa6ef2dc85d0bcd1e58f","modified":1765705245567},{"_id":"node_modules/hexo-theme-next/source/js/third-party/analytics/matomo.js","hash":"c6a25b26a1443caa70b47fd3dfa282271574deb5","modified":1765705245572},{"_id":"node_modules/hexo-theme-next/source/js/third-party/comments/disqus.js","hash":"3631db0315bdeaa420091a9febb6fa3421a2bdb4","modified":1765705245569},{"_id":"node_modules/hexo-theme-next/source/js/third-party/analytics/growingio.js","hash":"78dd3cf04082b7dbe6246e404b2aa8e726922402","modified":1765705245570},{"_id":"node_modules/hexo-theme-next/source/js/third-party/comments/disqusjs.js","hash":"e01b42846ffcabc676c3bdd9d89e8cafc084e20b","modified":1765705245569},{"_id":"node_modules/hexo-theme-next/source/css/_schemes/Muse/index.styl","hash":"6ad168288b213cec357e9b5a97674ff2ef3a910c","modified":1765705245609},{"_id":"node_modules/hexo-theme-next/source/js/third-party/comments/gitalk.js","hash":"03eb13679fc701c2ab91e502ccd26aacc37e7999","modified":1765705245570},{"_id":"node_modules/hexo-theme-next/source/js/third-party/comments/isso.js","hash":"917d1a2bbae6cc8817ce37abc17800b1740b2517","modified":1765705245571},{"_id":"node_modules/hexo-theme-next/source/js/third-party/comments/livere.js","hash":"e35e5a90a70a96117509368423726c6a56041ea2","modified":1765705245572},{"_id":"node_modules/hexo-theme-next/source/js/third-party/analytics/google-analytics.js","hash":"def07bcc7c17d8a0caad177fb1dd2f3a5e5b3536","modified":1765705245570},{"_id":"node_modules/hexo-theme-next/source/js/third-party/math/katex.js","hash":"83c54ee536e487a1031783443fe0cb63b1b4767e","modified":1765705245571},{"_id":"node_modules/hexo-theme-next/source/js/third-party/math/mathjax.js","hash":"5c749b9c1c3bb738122d0516211ecff6496d4907","modified":1765705245572},{"_id":"node_modules/hexo-theme-next/source/js/third-party/comments/utterances.js","hash":"743f389fc5669e486c8804d7199a11542ff9bc11","modified":1765705245576},{"_id":"node_modules/hexo-theme-next/source/js/third-party/search/local-search.js","hash":"3968d972f47b79acc6c3fe44028bad77c9c5aab7","modified":1765705245572},{"_id":"node_modules/hexo-theme-next/source/js/third-party/statistics/lean-analytics.js","hash":"171889aaab60704f87cfe9a05871f493ac292b47","modified":1765705245571},{"_id":"node_modules/hexo-theme-next/source/js/third-party/tags/mermaid.js","hash":"ae1c0c6c079594936de1aea756eb58992f8fb0e0","modified":1765705245572},{"_id":"node_modules/hexo-theme-next/source/css/_common/components/pages/breadcrumb.styl","hash":"8afdc311c6b8db121758371f95cf1c5e77354f42","modified":1765705245600},{"_id":"node_modules/hexo-theme-next/source/css/_common/components/pages/categories.styl","hash":"51a97a33879289904cb523ddc2d88b5b0c60fa72","modified":1765705245602},{"_id":"node_modules/hexo-theme-next/source/js/third-party/tags/pdf.js","hash":"7e6ad201d2c9d682261209db5dba07e9608fb42a","modified":1765705245574},{"_id":"node_modules/hexo-theme-next/source/js/third-party/tags/wavedrom.js","hash":"71efb52a4c44c64c2b17edd4638d54ec884bd4c7","modified":1765705245576},{"_id":"node_modules/hexo-theme-next/source/js/third-party/statistics/firestore.js","hash":"fec1c5c913237112b2cc6fb7d1e73b789bf508f8","modified":1765705245569},{"_id":"node_modules/hexo-theme-next/source/css/_common/components/pages/index.styl","hash":"7504dbc5c70262b048143b2c37d2b5aa2809afa2","modified":1765705245605},{"_id":"node_modules/hexo-theme-next/source/js/third-party/search/algolia-search.js","hash":"6b3fa841e48d8637a33530dd48c8ab1ef317323c","modified":1765705245564},{"_id":"node_modules/hexo-theme-next/source/css/_common/components/pages/schedule.styl","hash":"6b816c2511242ee503fb5f34cd3e4dcdafc06b85","modified":1765705245613},{"_id":"node_modules/hexo-theme-next/source/css/_common/components/post/post-body.styl","hash":"a2e977137892d4fa234ef5fdc6a92926d259b19d","modified":1765705245612},{"_id":"node_modules/hexo-theme-next/source/css/_common/components/post/index.styl","hash":"098d4bd034e986fcf7e443eac4fc2193935461b7","modified":1765705245606},{"_id":"node_modules/hexo-theme-next/source/css/_common/components/pages/tag-cloud.styl","hash":"6f8756d59b084316e82772d581fef713233a1605","modified":1765705245616},{"_id":"node_modules/hexo-theme-next/source/css/_common/components/post/post-nav.styl","hash":"9ac6f477177264c26a46e8333b8456720a0444dc","modified":1765705245612},{"_id":"node_modules/hexo-theme-next/source/css/_common/components/post/post-header.styl","hash":"424de4f64b12c521e8c6bfbc711d7961490ab36e","modified":1765705245612},{"_id":"node_modules/hexo-theme-next/source/css/_common/components/post/post-footer.styl","hash":"bb089299f87793bd5eff80c6375d4e796367b67b","modified":1765705245612},{"_id":"node_modules/hexo-theme-next/source/css/_common/components/post/post-reward.styl","hash":"b47fb36915962309553ff7fb1782341585ed2b76","modified":1765705245613},{"_id":"node_modules/hexo-theme-next/source/css/_common/components/post/post-widgets.styl","hash":"ebfba158a0a4af3d1dabcacbc58986664de52140","modified":1765705245613},{"_id":"node_modules/hexo-theme-next/source/css/_common/components/post/post-gallery.styl","hash":"aa366d37389760c8595529b850f461569577a1c5","modified":1765705245612},{"_id":"node_modules/hexo-theme-next/source/css/_common/components/third-party/disqusjs.styl","hash":"6b934c14c9455f6d81219630d9b28d3d10c74ab7","modified":1765705245603},{"_id":"node_modules/hexo-theme-next/source/css/_common/components/post/post-collapse.styl","hash":"809bab3414b1eb1ae44444eb821126868f764414","modified":1765705245612},{"_id":"node_modules/hexo-theme-next/source/css/_common/components/third-party/search.styl","hash":"6083df88f6112fadcd038e85ce4d502a0ea1dfca","modified":1765705245614},{"_id":"node_modules/hexo-theme-next/source/css/_common/components/third-party/index.styl","hash":"54d12e2c5d9982f7b9e5b23be5133954a8514e9d","modified":1765705245606},{"_id":"node_modules/hexo-theme-next/source/css/_common/components/third-party/gitalk.styl","hash":"3f5d145613948dbe117f10a00a375b049470d361","modified":1765705245604},{"_id":"node_modules/hexo-theme-next/source/css/_common/components/third-party/utterances.styl","hash":"56d90ae0559caa55b75f3c300ff2711f9ed65fc4","modified":1765705245616},{"_id":"node_modules/hexo-theme-next/source/css/_common/outline/header/bookmark.styl","hash":"e74f4bb47a101b014ee2a1783c87f3b87323f9a0","modified":1765705245600},{"_id":"node_modules/hexo-theme-next/source/css/_common/outline/header/github-banner.styl","hash":"38c64c2d04e46848382bfa246a0e9c508294767b","modified":1765705245604},{"_id":"node_modules/hexo-theme-next/source/css/_common/outline/footer/index.styl","hash":"4e967702cf4c637132346bc74ec8854426f1a68c","modified":1765705245607},{"_id":"node_modules/hexo-theme-next/source/css/_common/outline/header/index.styl","hash":"6e0d0796ef7fbbb62ffdfb448753a850de82c74f","modified":1765705245607},{"_id":"node_modules/hexo-theme-next/source/css/_common/components/post/post-followme.styl","hash":"026cd5735fd2a75bb60b7bf8bd09139583d602b9","modified":1765705245612},{"_id":"node_modules/hexo-theme-next/source/css/_common/components/third-party/math.styl","hash":"9d995eb4871a6c273d9d51558676a1fdabf69e72","modified":1765705245610},{"_id":"node_modules/hexo-theme-next/source/css/_common/outline/header/menu.styl","hash":"a3dd3edea9c01b66b28a8367185269b9dcc3bdee","modified":1765705245610},{"_id":"node_modules/hexo-theme-next/source/css/_common/outline/sidebar/sidebar-author-links.styl","hash":"0847400d8579b0a2dd1bf662c78954c10adf2680","modified":1765705245614},{"_id":"node_modules/hexo-theme-next/source/css/_common/outline/sidebar/index.styl","hash":"21acb11e397526132605eef23bde7b307aa1eab5","modified":1765705245608},{"_id":"node_modules/hexo-theme-next/source/css/_common/outline/sidebar/related-posts.styl","hash":"b05908f04ef95f2d91e6eba89b12411c378d050f","modified":1765705245613},{"_id":"node_modules/hexo-theme-next/source/css/_common/outline/sidebar/sidebar-author.styl","hash":"5b38ac4a0f1ade0e681aff0e3366c481d9cf3dcd","modified":1765705245614},{"_id":"node_modules/hexo-theme-next/source/css/_common/outline/header/site-meta.styl","hash":"a851e9d5aefcd027c95eeb323860b6da70f202d1","modified":1765705245615},{"_id":"node_modules/hexo-theme-next/source/css/_common/outline/header/site-nav.styl","hash":"bf3ad8b4268f763a1e26377681644887694bc009","modified":1765705245615},{"_id":"node_modules/hexo-theme-next/source/css/_common/outline/sidebar/sidebar-blogroll.styl","hash":"ce36bf1602233298e0351b4babc592315529eb26","modified":1765705245614},{"_id":"node_modules/hexo-theme-next/source/css/_common/outline/sidebar/sidebar-button.styl","hash":"46eece42510c2c89bb9209afb0262ad76a4b0b36","modified":1765705245614},{"_id":"node_modules/hexo-theme-next/source/css/_common/outline/sidebar/sidebar-copyright.styl","hash":"56805b77fe236fac19e19c716a49363bcf986311","modified":1765705245615},{"_id":"node_modules/hexo-theme-next/source/css/_common/outline/sidebar/sidebar-toc.styl","hash":"c2e354a565c8c1b32bd0ceacc972b17982758b67","modified":1765705245615},{"_id":"node_modules/hexo-theme-next/source/css/_common/outline/sidebar/sidebar-toggle.styl","hash":"741566d6ac5f852b5c8dee6a8996b65e48e7c97f","modified":1765705245615},{"_id":"node_modules/hexo-theme-next/source/css/_common/outline/sidebar/sidebar-nav.styl","hash":"24752d145c6fb8f5344dca9c7b9640839c02e009","modified":1765705245615},{"_id":"node_modules/hexo-theme-next/source/css/_common/outline/sidebar/site-state.styl","hash":"26dd0adfcb1db6df29c6090c8d7e9b5a43583fb0","modified":1765705245615},{"_id":"node_modules/hexo-theme-next/source/css/_common/scaffolding/highlight/fold.styl","hash":"42a0b65491ad85438596b3fe0b7f23973e4cef34","modified":1765705245603},{"_id":"node_modules/hexo-theme-next/source/css/_common/scaffolding/highlight/copy-code.styl","hash":"5c31f3a86e4e6fbf2f8419415620461fa8a63c56","modified":1765705245602},{"_id":"node_modules/hexo-theme-next/source/css/_common/scaffolding/tags/blockquote-center.styl","hash":"d6418fd2bbfba7b73ddf11ec62db9637fdf5d8af","modified":1765705245599},{"_id":"node_modules/hexo-theme-next/source/css/_common/scaffolding/tags/label.styl","hash":"debee14539272fbe3835a7d3853af2230baa3501","modified":1765705245609},{"_id":"node_modules/hexo-theme-next/source/css/_common/scaffolding/tags/link-grid.styl","hash":"49329a7144f3413d1c832e52a1f4954171ef11e1","modified":1765705245609},{"_id":"node_modules/hexo-theme-next/source/css/_common/scaffolding/tags/index.styl","hash":"22cd37bd5df9972d5074710896aba4424ad5161c","modified":1765705245608},{"_id":"node_modules/hexo-theme-next/source/css/_common/scaffolding/highlight/index.styl","hash":"cfc3485b3ec87c2a6618fc8a4819ba643e68c530","modified":1765705245608},{"_id":"node_modules/hexo-theme-next/source/css/_common/scaffolding/tags/group-pictures.styl","hash":"393ff96234e4196b569d4b11496774eb78e147de","modified":1765705245605},{"_id":"node_modules/hexo-theme-next/source/css/_common/scaffolding/tags/pdf.styl","hash":"b6654a1d7cf82577d8263faffee8af3ad4a5c0e8","modified":1765705245611},{"_id":"node_modules/hexo-theme-next/source/css/_common/scaffolding/tags/note.styl","hash":"c00b45fe426d9f494650c082c9022ba14a44e37f","modified":1765705245611},{"_id":"node_modules/hexo-theme-next/source/css/_common/scaffolding/tags/wavedrom.styl","hash":"af113411ad9cca7674177be36af8dd399680834d","modified":1765705245616},{"_id":"source/_posts/traceroute-vulnerability/icmp-ttl-exceeded.png","hash":"d2249df4f7ce405ce32a253ebf4f3a8bd33e1903","modified":1765705807483},{"_id":"source/_posts/get-known-traceroute-by-wireshark/Traceroute-work.png","hash":"55a3527df8022e24a4ae561b62ddb3ec9b9c4f7c","modified":1765705807466},{"_id":"node_modules/hexo-theme-next/source/css/_common/scaffolding/tags/mermaid.styl","hash":"48d35dba575a7c9e8845b16652e76b7d4a4646de","modified":1765705245610},{"_id":"node_modules/hexo-theme-next/source/css/_common/scaffolding/tags/tabs.styl","hash":"c3be8b0738f693e750486bb71769c3dbbec174cc","modified":1765705245616},{"_id":"source/_posts/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230302-du.png","hash":"91f3b962547d91e02b65b9a724eb1228dfd78aad","modified":1765705807424},{"_id":"source/_posts/docker-traceroute-tcpdump/docker-packet1-36.png","hash":"fed60d8e416c0d8c19e9e79b23efe05485f72ad4","modified":1765705807451},{"_id":"source/_posts/get-known-traceroute-by-wireshark/packet1-36.png","hash":"d77f4fd3a89db80a7e837b05bef145e2681435a8","modified":1765705807472},{"_id":"public/tags/index.html","hash":"a7ecf71ffc40526108f7a13ce5f1dc3e74ee5fa7","modified":1767542580361},{"_id":"public/ise-story-md.html","hash":"741bab40a92b9a372b40a2aa54835f6d9585417f","modified":1767542580361},{"_id":"public/BRKSEC-2169-ebpf-md.html","hash":"35317573a37140bf1ebce90511b71cf858ffdafd","modified":1767542580361},{"_id":"public/K8S-Cilium-Replace-kube-proxy.html","hash":"66682ef5eb57477e519300131ee5db2614d7c694","modified":1767542580361},{"_id":"public/Ansible-K8S-Cilium.html","hash":"128a18c04080b665cbe36db31624d04983b5ff06","modified":1767542580361},{"_id":"public/Update-the-cloud-init-code-for-AppD-AMI.html","hash":"9830b0aee94a76b1ee998fd9b61496dd30857267","modified":1767542580361},{"_id":"public/Conversation-with-ChatGPT-to-accelerate-Cloud-Develpment.html","hash":"ab67859f7a018785b4caa4eed9ce8fec79694d07","modified":1767542580361},{"_id":"public/traceroute-vulnerability.html","hash":"92e8a46f3b03c97cc69a31538a981c73ff669dde","modified":1767542580361},{"_id":"public/ChatGPT-generate-code-to-build-AMI-for-AppDynamics.html","hash":"0a68606cc267a3baeb857addbf086f3a593776bf","modified":1767542580361},{"_id":"public/anycast-brief.html","hash":"14ca48d4b1f76d208a6c37a4d6de39039973f01f","modified":1767542580361},{"_id":"public/docker-traceroute-tcpdump.html","hash":"9b33744f58adeac15ec5aa7d21889d07a465c239","modified":1767542580361},{"_id":"public/get-known-traceroute-by-wireshark.html","hash":"bfd9ded09ff783f1ea5c9ad02edf5ece2af0a52d","modified":1767542580361},{"_id":"public/deploy-thousandeyes-agent-on-aws.html","hash":"9842bd6bf9944e8ab1ef7aa7875b7aee005fc3f2","modified":1767542580361},{"_id":"public/master-kvm-notes-1.html","hash":"8638a4d69eb36f2aac6de299266b8d6736126fed","modified":1767542580361},{"_id":"public/csr1kv-nfvis-ztp-demo.html","hash":"e582f81ee4b1a0a6e05d6e40bb17fc92db5aca1c","modified":1767542580361},{"_id":"public/csr1kv-kvm-sriov-ubuntu-demo.html","hash":"1e2d49b5df6ee03116915cc61a92871d706ee620","modified":1767542580361},{"_id":"public/hexo-setup-log-md.html","hash":"e8b78dd66ffc55b87539225ede6358986ed1614f","modified":1767542580361},{"_id":"public/csr1kv-kvm-Ubuntu20-04-md.html","hash":"499645052f543dfc7f26d88f1f522a815ba34c50","modified":1767542580361},{"_id":"public/csr1kv-kvm-CentOS7.html","hash":"715aaf9ba4652aec94122f5b8e468cf2cb390e55","modified":1767542580361},{"_id":"public/archives/index.html","hash":"49f085b4d269009be16494a4da105eddb194edaa","modified":1767542580361},{"_id":"public/archives/2021/index.html","hash":"c6a0fb667a0a591818d1604a5a0bdb5d71c4c5f9","modified":1767542580361},{"_id":"public/archives/2021/02/index.html","hash":"cf3276f7e1775ecb4140ac79e63e0c9054562ba2","modified":1767542580361},{"_id":"public/archives/2021/06/index.html","hash":"2261100c7d0c4f100dabc2496ca1c9cfff32825c","modified":1767542580361},{"_id":"public/archives/2021/07/index.html","hash":"8bd13be2f0c72e8dd0dd07af4bf197e8db6f42a8","modified":1767542580361},{"_id":"public/archives/2021/12/index.html","hash":"72204d93de89a8cf65d7ea9e318ec278668fe6b3","modified":1767542580361},{"_id":"public/archives/2023/index.html","hash":"8abf7959aac96c032bc2eb16edb289347aa3f145","modified":1767542580361},{"_id":"public/archives/2023/03/index.html","hash":"af9417b803f2d481ce01f2112d51603883da5d28","modified":1767542580361},{"_id":"public/archives/2025/index.html","hash":"6265921b56b10698a0e3fd7a3054717c6a855f83","modified":1767542580361},{"_id":"public/archives/2025/08/index.html","hash":"d931857372fc455b969df63e16ae9e62af4b1bc0","modified":1767542580361},{"_id":"public/archives/2025/12/index.html","hash":"b895627ad5c8f78ff2bdc85f248136d39069553b","modified":1767542580361},{"_id":"public/index.html","hash":"ee58f5d628cd0898bf156d36c34c69c089c9c3e2","modified":1767542580361},{"_id":"public/categories/作品集/index.html","hash":"a27096ae0083e8d05cf25a654debfb88eda8054e","modified":1767542580361},{"_id":"public/page/2/index.html","hash":"97a558ecfc870379a109b7f9455a017ce662c684","modified":1767542580361},{"_id":"public/page/3/index.html","hash":"23c5e1f4c011211a3434437063a85fbf61fee57c","modified":1767542580361},{"_id":"public/page/4/index.html","hash":"a5a581b143a6b4ce0c29f5143ca5926529be479a","modified":1767542580361},{"_id":"public/tags/eBPF/index.html","hash":"928d6822437820bca933fa3fabe501ae77d229fd","modified":1767542580361},{"_id":"public/tags/Linux/index.html","hash":"fc5d3a3c861a252d4bcb7718495cd667e3a44b34","modified":1767542580361},{"_id":"public/tags/AI-Works/index.html","hash":"90e15d4abc6a8ab2cafc64ff2c1f026a3c31107c","modified":1767542580361},{"_id":"public/tags/chatGPT/index.html","hash":"ae532a0f573996a2a15d0a12718e48e4d78164c3","modified":1767542580361},{"_id":"public/tags/AMI/index.html","hash":"f438f2773b86d2b95611b4a42289d653ebd867e6","modified":1767542580361},{"_id":"public/tags/AppDynamics/index.html","hash":"bb3cedd97ceb43396fb267a891e133de8d49dcbe","modified":1767542580361},{"_id":"public/tags/cloud-init/index.html","hash":"2d95b2679bc51af9020925c15e9a6af2c7458370","modified":1767542580361},{"_id":"public/tags/anycast/index.html","hash":"47ee730322e8f1ecc80c1a63e06b8753f2eb2914","modified":1767542580361},{"_id":"public/tags/Automation/index.html","hash":"e7c9c6883fd3332f710e043c875c2307817eb703","modified":1767542580361},{"_id":"public/tags/coding/index.html","hash":"714900858741dbd4ea883dc6b1e3c635f76f3d66","modified":1767542580361},{"_id":"public/tags/sriov/index.html","hash":"6d5abefd885e8b33b8288fdbde23663ecc1a773a","modified":1767542580361},{"_id":"public/tags/csr1000v/index.html","hash":"6a29cfbb585971f85893b5f04f79202a1e69ece1","modified":1767542580361},{"_id":"public/tags/ztp/index.html","hash":"d276ba05813e39ebfd7ec2231edcfa3f3d7eb5eb","modified":1767542580361},{"_id":"public/tags/ThousandEyes/index.html","hash":"62b9d532372005c8e47c7b2f575b127310523292","modified":1767542580361},{"_id":"public/tags/AWS/index.html","hash":"06e8d8d6418606fab676497fb5fbe7d2e965edff","modified":1767542580361},{"_id":"public/tags/AppD/index.html","hash":"15db15676d14cc6c0b75051103b77508726f5a9c","modified":1767542580361},{"_id":"public/tags/nfvis/index.html","hash":"dacd2817796cbb626e392e5f529798b3a343a4a5","modified":1767542580361},{"_id":"public/tags/docker/index.html","hash":"df7861aea5fa875a3deac55fd7753cddc8dbd3c8","modified":1767542580361},{"_id":"public/tags/tcpdump/index.html","hash":"c3d5c09f05736340c03625b064c21cc4c35915fd","modified":1767542580361},{"_id":"public/tags/traceroute/index.html","hash":"ed176e08ef00a7c199bc2f5b1744196b59314e4e","modified":1767542580361},{"_id":"public/tags/hexo/index.html","hash":"f3068dc94be522429afdc4440e3507a98542dcc6","modified":1767542580361},{"_id":"public/tags/wireshark/index.html","hash":"38908096c94786676a52e8fa6db0573d4f07321f","modified":1767542580361},{"_id":"public/tags/ISE/index.html","hash":"e4cdaef4100ab81e3fc65105b468fcf7e9d433ca","modified":1767542580361},{"_id":"public/tags/CSR1000v/index.html","hash":"d5330d27467869a2b5e8e8d56d85351ec82b1d0e","modified":1767542580361},{"_id":"public/tags/KVM/index.html","hash":"c8bc4416aa018f1157990003f100cbd0a05be4ca","modified":1767542580361},{"_id":"public/tags/SRIOV/index.html","hash":"3bc0ec7e2470861078a95ec126f4513f9f847f11","modified":1767542580361},{"_id":"public/tags/NetworkManager/index.html","hash":"10d43acd3c0473e0bc16ed05bc3bb7bedf8d41d0","modified":1767542580361},{"_id":"public/tags/Cisco/index.html","hash":"1c5443b5ad823fa794fbdcc56301e07997ade69a","modified":1767542580361},{"_id":"public/tags/kvm/index.html","hash":"1c1774fe31a8188164edcc62683c1620969702ba","modified":1767542580361},{"_id":"public/tags/icmp/index.html","hash":"5f481a3849e9bd9dc8131681e64ea62e9e9b74e5","modified":1767542580361},{"_id":"public/images/favicon-32x32-next.png","hash":"0749d7b24b0d2fae1c8eb7f671ad4646ee1894b1","modified":1765856413092},{"_id":"public/images/logo-algolia-nebula-blue-full.svg","hash":"a38c6d92b368bfc42c72ad799ad03f3274957065","modified":1765856413092},{"_id":"public/images/favicon-16x16-next.png","hash":"943a0d67a9cdf8c198109b28f9dbd42f761d11c3","modified":1765856413092},{"_id":"public/images/apple-touch-icon-next.png","hash":"2959dbc97f31c80283e67104fe0854e2369e40aa","modified":1765856413092},{"_id":"public/images/avatar.gif","hash":"2dbc3e2f2d624b2ca1afe6edc2ca17307f1950c8","modified":1765856413092},{"_id":"public/images/logo.svg","hash":"099e11ab995a2c8981427a85476d082609848c77","modified":1765856413092},{"_id":"public/CNAME","hash":"70933505d53db7579d12f169fd95617b09d1bc02","modified":1765856413092},{"_id":"public/d51c23267c55bd8c7faa065331f5986d.txt","hash":"2cac247156f2780f17242c6981941ff615fb20a3","modified":1765856413092},{"_id":"public/ebpfv2.html","hash":"5ad83a9251e3782c0519a61435c8b1571346e735","modified":1765856413092},{"_id":"public/ebpf.html","hash":"ffaf14a76da6a902748f36c99ea25c9c1cb1e0f2","modified":1767517369085},{"_id":"public/ciscosec.html","hash":"d5b842b17a04602f643899b7fb1187451ca08748","modified":1765856413092},{"_id":"public/isestory.html","hash":"954af669dd90732919da280239248fd0a57a964f","modified":1766570158249},{"_id":"public/ebpfsre.html","hash":"199026747010fb7c4b64b3924ae437c7cbe991d3","modified":1765856413092},{"_id":"public/isestry.html","hash":"9143b2d906962975d01731144ab0f6071b1e2562","modified":1765856413092},{"_id":"public/google518425f6cab1f5d9.html","hash":"42ee49e7b7d67b8f5beaf941008882f02824ec70","modified":1765856413092},{"_id":"public/sec8b.html","hash":"e1e5aac6e2d038cec48674579ed0974ece3abf78","modified":1766570158249},{"_id":"public/secloop.html","hash":"c45133e5bdd740dc94f6b1ff3c319e76ead517b1","modified":1765856413092},{"_id":"public/works/index.html","hash":"2e6d503ee474cdc0312b2fad23dcddd5fd61489e","modified":1766570158249},{"_id":"public/tetragon.html","hash":"989795e97b10d1d071abda3e34b4bffc88ae6da6","modified":1767541276915},{"_id":"public/sna.html","hash":"7dea94721647831e397d2a264e8f9ddc87334112","modified":1766570158249},{"_id":"public/docker-traceroute-tcpdump/container-module-in-docker-network.png","hash":"ac30ee7ddbdf63b0b895d599dba6d7b9507c9c57","modified":1765856413092},{"_id":"public/docker-traceroute-tcpdump/traceroute-ubuntu.pcapng","hash":"5fbd9168bdd09b0c66f72fedaf1e687fe5d9fabc","modified":1765856413092},{"_id":"public/get-known-traceroute-by-wireshark/Traceroute 过程.drawio","hash":"619fc72c484335da1bbb3a1b5208f95fd430b4a8","modified":1765856413092},{"_id":"public/get-known-traceroute-by-wireshark/traceroute-google-dns.pcapng","hash":"a9ef8cb9819c88ae7c1b54d0e96f1e36d1fe0b21","modified":1765856413092},{"_id":"public/csr1kv-kvm-CentOS7/line-chart-009.png","hash":"352e2729c2a71e2bb227d15a6a4d3cce5729b571","modified":1765856413092},{"_id":"public/csr1kv-kvm-CentOS7/pstree-011.png","hash":"2bab1c1e302f5bf734eb5d02c51c118fc9b6b89e","modified":1765856413092},{"_id":"public/csr1kv-kvm-CentOS7/virt-manager-3.png","hash":"3a84c14af1b971d87b861e56c88ee8da5a6743a8","modified":1765856413092},{"_id":"public/csr1kv-kvm-CentOS7/virt-manager-1.png","hash":"71f44e79a0e7f49149509cd9da183d976c560a2e","modified":1765856413092},{"_id":"public/csr1kv-kvm-CentOS7/virt-manager-4.png","hash":"0a4e67cb1b3c4e66b41e7c8999548a0ccd9f7266","modified":1765856413092},{"_id":"public/csr1kv-kvm-CentOS7/virt-manager-5.png","hash":"c537b37388bf9dc92e1dde286ca38255d17405f3","modified":1765856413092},{"_id":"public/csr1kv-kvm-CentOS7/virt-top-012.png","hash":"4d020d807a1653d988e77419032014874e654a77","modified":1765856413092},{"_id":"public/csr1kv-kvm-CentOS7/virt-manager-7.png","hash":"55460a74043ce33e3b2c6d388540237e35ba5fe8","modified":1765856413092},{"_id":"public/csr1kv-kvm-Ubuntu20-04-md/kvm.zip","hash":"d1a4cffa81bd4a90f5db70ef1ea37109477b8dba","modified":1765856413092},{"_id":"public/csr1kv-kvm-Ubuntu20-04-md/line-chart.png","hash":"352e2729c2a71e2bb227d15a6a4d3cce5729b571","modified":1765856413092},{"_id":"public/csr1kv-kvm-Ubuntu20-04-md/virt-manager-step1.png","hash":"339e0a7440a1f60f4c26d7dabbd72ab81569dfcf","modified":1765856413092},{"_id":"public/csr1kv-kvm-Ubuntu20-04-md/virt-manager-step2-2.png","hash":"ef1b6897759374d2e573ddea1db859eaa62d2b1e","modified":1765856413092},{"_id":"public/csr1kv-kvm-Ubuntu20-04-md/virt-manager-step2.png","hash":"9f0c4ff08205efbf62df3f082c08b3069be3b087","modified":1765856413092},{"_id":"public/csr1kv-kvm-Ubuntu20-04-md/virt-manager-step3.png","hash":"404dd203a9ce5a233b18d77a154c5313a631af1b","modified":1765856413092},{"_id":"public/css/noscript.css","hash":"4cd5301e478e0e0d4b176740ec314087ec5cb707","modified":1765856413092},{"_id":"public/js/comments-buttons.js","hash":"1a7344440321713426a0b2ab17e276b5bdf85ade","modified":1765856413092},{"_id":"public/css/main.css","hash":"f7b2291257f94d7af11a5f95f94546bfe2089317","modified":1765856413092},{"_id":"public/js/bookmark.js","hash":"9ba4cceafd12c6d5ba8a6b986a046ef8319a7811","modified":1765856413092},{"_id":"public/js/config.js","hash":"4c4ebbe3b3f3841a26f9d5af6d0ba8bc6da01c54","modified":1765856413092},{"_id":"public/js/comments.js","hash":"66ae2e26ea36a41b72c638ea8b220296638ae952","modified":1765856413092},{"_id":"public/js/motion.js","hash":"6f751f5c9499a39d7c5e1d323db3260342dd9431","modified":1765856413092},{"_id":"public/js/pjax.js","hash":"694b271819aab37ce473b15db9e6aded971d82e5","modified":1765856413092},{"_id":"public/js/schedule.js","hash":"9c41a73ed3e8db8ca4cb53633b6f616279a5a7bd","modified":1765856413092},{"_id":"public/js/next-boot.js","hash":"d434a2a8543fb09245eaf2bc6ca123435bfa4dbb","modified":1765856413092},{"_id":"public/js/utils.js","hash":"6734719bb74e4d9818992b0e4a745c2a1aefd5e2","modified":1765856413092},{"_id":"public/js/third-party/pace.js","hash":"0ef04218b93561ba4d0ff420d556c3d90a756d32","modified":1765856413092},{"_id":"public/js/third-party/addtoany.js","hash":"a772605646dcfb67620a10ee8ef23c38a6d19d80","modified":1765856413092},{"_id":"public/js/third-party/chat/tidio.js","hash":"b0079f6a4601e06ca6fe46e83a2f5af553e9bc3c","modified":1765856413092},{"_id":"public/js/third-party/quicklink.js","hash":"eed02e6fced8e5a653077205d4d4d7834ca71472","modified":1765856413092},{"_id":"public/js/third-party/analytics/baidu-analytics.js","hash":"f629acc46ff40c071ffd31b77d5c7616f0fdd778","modified":1765856413092},{"_id":"public/js/sidebar.js","hash":"2ee359ae48273b01ba1e0768704524e08702c7eb","modified":1765856413092},{"_id":"public/js/third-party/analytics/google-analytics.js","hash":"def07bcc7c17d8a0caad177fb1dd2f3a5e5b3536","modified":1765856413092},{"_id":"public/js/third-party/fancybox.js","hash":"819f382c561fe5ec23c67cc5fabd63dd1cc22dc1","modified":1765856413092},{"_id":"public/js/third-party/analytics/growingio.js","hash":"78dd3cf04082b7dbe6246e404b2aa8e726922402","modified":1765856413092},{"_id":"public/js/third-party/comments/disqusjs.js","hash":"e01b42846ffcabc676c3bdd9d89e8cafc084e20b","modified":1765856413092},{"_id":"public/js/third-party/analytics/matomo.js","hash":"c6a25b26a1443caa70b47fd3dfa282271574deb5","modified":1765856413092},{"_id":"public/js/third-party/chat/chatra.js","hash":"c32180522788c10e51df1803aa6842ef0432ddc9","modified":1765856413092},{"_id":"public/js/third-party/comments/changyan.js","hash":"6c65d5a585b7dd75e5f0fa6ef2dc85d0bcd1e58f","modified":1765856413092},{"_id":"public/js/third-party/comments/disqus.js","hash":"3631db0315bdeaa420091a9febb6fa3421a2bdb4","modified":1765856413092},{"_id":"public/js/third-party/comments/isso.js","hash":"917d1a2bbae6cc8817ce37abc17800b1740b2517","modified":1765856413092},{"_id":"public/js/third-party/comments/livere.js","hash":"e35e5a90a70a96117509368423726c6a56041ea2","modified":1765856413092},{"_id":"public/js/third-party/comments/utterances.js","hash":"743f389fc5669e486c8804d7199a11542ff9bc11","modified":1765856413092},{"_id":"public/js/third-party/math/mathjax.js","hash":"5c749b9c1c3bb738122d0516211ecff6496d4907","modified":1765856413092},{"_id":"public/js/third-party/comments/gitalk.js","hash":"03eb13679fc701c2ab91e502ccd26aacc37e7999","modified":1765856413092},{"_id":"public/js/third-party/math/katex.js","hash":"83c54ee536e487a1031783443fe0cb63b1b4767e","modified":1765856413092},{"_id":"public/js/third-party/search/algolia-search.js","hash":"6b3fa841e48d8637a33530dd48c8ab1ef317323c","modified":1765856413092},{"_id":"public/js/third-party/statistics/firestore.js","hash":"fec1c5c913237112b2cc6fb7d1e73b789bf508f8","modified":1765856413092},{"_id":"public/js/third-party/search/local-search.js","hash":"3968d972f47b79acc6c3fe44028bad77c9c5aab7","modified":1765856413092},{"_id":"public/js/third-party/statistics/lean-analytics.js","hash":"171889aaab60704f87cfe9a05871f493ac292b47","modified":1765856413092},{"_id":"public/js/third-party/tags/pdf.js","hash":"7e6ad201d2c9d682261209db5dba07e9608fb42a","modified":1765856413092},{"_id":"public/js/third-party/tags/mermaid.js","hash":"ae1c0c6c079594936de1aea756eb58992f8fb0e0","modified":1765856413092},{"_id":"public/js/third-party/tags/wavedrom.js","hash":"71efb52a4c44c64c2b17edd4638d54ec884bd4c7","modified":1765856413092},{"_id":"public/ebpfv3.html","hash":"5a740bf9204ea000f8d20609b12adb8e850ac430","modified":1766570158249},{"_id":"public/isev2.html","hash":"d652c4d3ae2a2ce1eee85d4a8ed70451778fddca","modified":1766570158249},{"_id":"public/csr1kv-kvm-CentOS7/macvtap-ibm.png","hash":"6a699f8f1cbba8770fd9c05c20185e992767f0f0","modified":1765856413092},{"_id":"public/csr1kv-kvm-CentOS7/sriov-pool-001.png","hash":"4c7a51c24fd1d4f967da3dcf0fe013250fc50bea","modified":1765856413092},{"_id":"public/csr1kv-kvm-CentOS7/virt-manager-2.png","hash":"f2657a6be000fd0b98f72f967753c48d7c315934","modified":1765856413092},{"_id":"public/csr1kv-kvm-CentOS7/virt-manager-6.png","hash":"4c7a51c24fd1d4f967da3dcf0fe013250fc50bea","modified":1765856413092},{"_id":"public/csr1kv-kvm-Ubuntu20-04-md/pic1-sriov-pool.png","hash":"de58ee6a1e67377720cbf24143053bf00de8803d","modified":1765856413092},{"_id":"public/docker-traceroute-tcpdump/probe-anycast-dns.png","hash":"2ac4d27e4563fb855fb107812225e61f97ccc529","modified":1765856413092},{"_id":"public/docker-traceroute-tcpdump/thousandeyes-path-node3.png","hash":"d5f4234028428b97a424414b6d3f365d5b8fb25b","modified":1765856413092},{"_id":"public/docker-traceroute-tcpdump/thousandeyes-path-node2.png","hash":"720dfa311b76c5756062d8b1198038ccf5759cd6","modified":1765856413092},{"_id":"public/get-known-traceroute-by-wireshark/AS-query-1.png","hash":"79fcf93b7d51b71534b3c3d836904c390860c3cd","modified":1765856413092},{"_id":"public/get-known-traceroute-by-wireshark/whois-query.png","hash":"d5366bd1f17ee201e8f2952bda0f27abb81480a3","modified":1765856413092},{"_id":"public/traceroute-vulnerability/traceroute-vulnerability.png","hash":"b0aeb8bbf976d0885a164e7a29a9ef74e738a5ab","modified":1765856413092},{"_id":"public/csr1kv-kvm-Ubuntu20-04-md/add-sriov-pool.png","hash":"a0182bed9cf1c71aaca761f0f9179fcb9d47169b","modified":1765856413092},{"_id":"public/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-wgi.png","hash":"20cd3993f5cff1ed1ddc9e0fc355147a0b585d8c","modified":1765856413092},{"_id":"public/docker-traceroute-tcpdump/thousandeyes-path-node1.png","hash":"da7dd3d1a044407056b74dd053c8d71e50b56435","modified":1765856413092},{"_id":"public/get-known-traceroute-by-wireshark/UDP-Probe-1.png","hash":"eab39f7f9d35389298afcd7ede44848e26dd7145","modified":1765856413092},{"_id":"public/get-known-traceroute-by-wireshark/dns-query-1.png","hash":"ba898b23c44208eb0939451c362a28f50e90d0fe","modified":1765856413092},{"_id":"public/get-known-traceroute-by-wireshark/UDP-Probe-2.png","hash":"7b79da06f083c9b0adb3bcd9ff06840a8300e735","modified":1765856413092},{"_id":"public/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230302-a8.png","hash":"d6fd0e84a3f4d7eb0914e6ddc4001259eccfbebc","modified":1765856413092},{"_id":"public/Conversation-with-ChatGPT-to-accelerate-Cloud-Develpment/SCR-20230302-a8.png","hash":"d6fd0e84a3f4d7eb0914e6ddc4001259eccfbebc","modified":1765856413092},{"_id":"public/docker-traceroute-tcpdump/te-agent-docker.png","hash":"b8df1b5007cf006bc004cdf51e305914ee36314e","modified":1765856413092},{"_id":"public/docker-traceroute-tcpdump/thousandeyes-path.png","hash":"64ee31316cca3f8422860c17d58f535ba5d39ae9","modified":1765856413092},{"_id":"public/docker-traceroute-tcpdump/wireshark-int-list.png","hash":"ab66357bcb176fcb41009c8fb785134168a24200","modified":1765856413092},{"_id":"public/get-known-traceroute-by-wireshark/ICMP-last-reply.png","hash":"1326cee55ed3a9facac625b362535a908026d6e0","modified":1765856413092},{"_id":"public/get-known-traceroute-by-wireshark/whois-answer-2.png","hash":"84c12c1a8fc15c7057511b10a324b8e5a98c2305","modified":1765856413092},{"_id":"public/csr1kv-kvm-CentOS7/nic-type-010.png","hash":"4237997ed132f71c42a810f56e4afb7bfeb67436","modified":1765856413092},{"_id":"public/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-wzx.png","hash":"c3a00473cd641a53f13a48002bbf278111af71f7","modified":1765856413092},{"_id":"public/get-known-traceroute-by-wireshark/ICMP-Reply-1.png","hash":"b15b6f57e8503ac92da75d5bf17dddd9891972ef","modified":1765856413092},{"_id":"public/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-wa6.png","hash":"f8ad3092d8326e1b5aea70375ad7268fe54b429e","modified":1765856413092},{"_id":"public/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-w1c.png","hash":"5d661c9fa7ae0f9415696d9095e51a61e60c9cbb","modified":1765856413092},{"_id":"public/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-w6k.png","hash":"9254504b8dd2c99941eb97f381f2360052e1709e","modified":1765856413092},{"_id":"public/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-wle.png","hash":"3a927dc542cc62c62bc103463f7765eaf3d043d0","modified":1765856413092},{"_id":"public/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230302-b8.png","hash":"2e2c3e855ec62bad0a014b468c92acda639a0096","modified":1765856413092},{"_id":"public/Conversation-with-ChatGPT-to-accelerate-Cloud-Develpment/SCR-20230301-wa6.png","hash":"f8ad3092d8326e1b5aea70375ad7268fe54b429e","modified":1765856413092},{"_id":"public/Conversation-with-ChatGPT-to-accelerate-Cloud-Develpment/SCR-20230302-b8.png","hash":"2e2c3e855ec62bad0a014b468c92acda639a0096","modified":1765856413092},{"_id":"public/Conversation-with-ChatGPT-to-accelerate-Cloud-Develpment/SCR-20230303-mp.png","hash":"d4917008d7a2bb98bc406ec288b320e5abbb2589","modified":1765856413092},{"_id":"public/csr1kv-kvm-Ubuntu20-04-md/virt-manager-step4.png","hash":"2015e74980373bec96834688d588e28ca5ddc2a5","modified":1765856413092},{"_id":"public/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-vv3.png","hash":"c5c38234cc1b84bcca3a5984d55c31d4229c3198","modified":1765856413092},{"_id":"public/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-vz3.png","hash":"7a666bc3699e8f361d68fcf5ff2260b3bde48911","modified":1765856413092},{"_id":"public/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-w1t.png","hash":"231e7589a6d0f5f1cccb1b32b49fadf5a653991f","modified":1765856413092},{"_id":"public/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-wi7.png","hash":"4738fe480f6fd5186d1f1ed7fd8e70febd01943d","modified":1765856413092},{"_id":"public/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-w8d.png","hash":"7e295cbfa78cab58847bd671a30dbaa96643d7fb","modified":1765856413092},{"_id":"public/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-x8g.png","hash":"9580aadab1d967138b7828043aef1d219dd5de2a","modified":1765856413092},{"_id":"public/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-vxg.png","hash":"f5ddd7e677e815a730d9bc2665ad261a920257db","modified":1765856413092},{"_id":"public/Conversation-with-ChatGPT-to-accelerate-Cloud-Develpment/SCR-20230301-x8g.png","hash":"9580aadab1d967138b7828043aef1d219dd5de2a","modified":1765856413092},{"_id":"public/Conversation-with-ChatGPT-to-accelerate-Cloud-Develpment/SCR-20230302-w8m.png","hash":"cd914a5238bb402bae8a6a12724d3c41d038d5d7","modified":1765856413092},{"_id":"public/get-known-traceroute-by-wireshark/whois-answer.png","hash":"9471e012ac5271b21d0a64824608ff6a5a323e03","modified":1765856413092},{"_id":"public/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-x5q.png","hash":"184e313d7a309da4e95e68c6165378a04cddd0fc","modified":1765856413092},{"_id":"public/Conversation-with-ChatGPT-to-accelerate-Cloud-Develpment/SCR-20230301-x5q.png","hash":"184e313d7a309da4e95e68c6165378a04cddd0fc","modified":1765856413092},{"_id":"public/get-known-traceroute-by-wireshark/AS-reply-1.png","hash":"b0b5c5085d72881149131a8defa6c66165c1c2a1","modified":1765856413092},{"_id":"public/traceroute-vulnerability/icmp-echo-reply.png","hash":"e96d5dc9113d9e198035b0220b9db8293e6be685","modified":1765856413092},{"_id":"public/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-wdb.png","hash":"fce9e8cf9493d3f77ae5fd87a5d7ebfd82d8eb8f","modified":1765856413092},{"_id":"public/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-wn8.png","hash":"818624ccd379d0bf060bf24bb78ae96d5b3c1fb2","modified":1765856413092},{"_id":"public/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-wob.png","hash":"5439ae7fe8a235a21ee01ad8cc8426c7074f2b5f","modified":1765856413092},{"_id":"public/Conversation-with-ChatGPT-to-accelerate-Cloud-Develpment/SCR-20230301-wob.png","hash":"5439ae7fe8a235a21ee01ad8cc8426c7074f2b5f","modified":1765856413092},{"_id":"public/Conversation-with-ChatGPT-to-accelerate-Cloud-Develpment/SCR-20230302-8x.png","hash":"463b295e0330a8108b5fd52a9298b2933a208277","modified":1765856413092},{"_id":"public/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230302-8x.png","hash":"463b295e0330a8108b5fd52a9298b2933a208277","modified":1765856413092},{"_id":"public/Conversation-with-ChatGPT-to-accelerate-Cloud-Develpment/SCR-20230301-wdb.png","hash":"fce9e8cf9493d3f77ae5fd87a5d7ebfd82d8eb8f","modified":1765856413092},{"_id":"public/get-known-traceroute-by-wireshark/Traceroute-work.png","hash":"55a3527df8022e24a4ae561b62ddb3ec9b9c4f7c","modified":1765856413092},{"_id":"public/traceroute-vulnerability/icmp-ttl-exceeded.png","hash":"d2249df4f7ce405ce32a253ebf4f3a8bd33e1903","modified":1765856413092},{"_id":"public/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230302-du.png","hash":"91f3b962547d91e02b65b9a724eb1228dfd78aad","modified":1765856413092},{"_id":"public/docker-traceroute-tcpdump/docker-packet1-36.png","hash":"fed60d8e416c0d8c19e9e79b23efe05485f72ad4","modified":1765856413092},{"_id":"public/get-known-traceroute-by-wireshark/packet1-36.png","hash":"d77f4fd3a89db80a7e837b05bef145e2681435a8","modified":1765856413092},{"_id":"source/vast.html","hash":"a06a8934ceb4aa9ea52c2bfdfd408b42bd51bbc3","modified":1765869849803},{"_id":"public/vast.html","hash":"a06a8934ceb4aa9ea52c2bfdfd408b42bd51bbc3","modified":1765869981441},{"_id":"source/sitemap.xml","hash":"114006a1c50b546d8d6dc2e06dcc9ceed10aa4e8","modified":1766568916594},{"_id":"public/sitemap.xml","hash":"114006a1c50b546d8d6dc2e06dcc9ceed10aa4e8","modified":1766570158249},{"_id":"source/cilium.html","hash":"10dd0b8493285e7a0a941812d44a06a2757121df","modified":1767888105986},{"_id":"public/cilium.html","hash":"10dd0b8493285e7a0a941812d44a06a2757121df","modified":1767888168200},{"_id":"source/smartswitch.html","hash":"95c6004e484ece5cecb753f558cd6cbe18296bfe","modified":1766539087249},{"_id":"public/smartswitch.html","hash":"95c6004e484ece5cecb753f558cd6cbe18296bfe","modified":1766539137085},{"_id":"source/robots.txt","hash":"ed545f3cc642eff4964e89060181cd9623342f91","modified":1766568987835},{"_id":"public/robots.txt","hash":"ed545f3cc642eff4964e89060181cd9623342f91","modified":1766570158249},{"_id":"source/_posts/My-GenAI-works-md.md","hash":"325b0c61d65381d4e8ad499bc90b83e1112b99a3","modified":1766650143327},{"_id":"public/My-GenAI-works-md.html","hash":"fdbe0d915f7e503423f4bc726a8887627a5f2451","modified":1767542580361},{"_id":"source/Cilium内核重塑.html","hash":"ea562cfdaf47a455f7201b96fddf074b3ce7d5e9","modified":1767017286791},{"_id":"source/dance.html","hash":"ac52fbe13160d02b8ee136c4e8c0c8c505967b4f","modified":1767075742050},{"_id":"public/Cilium内核重塑.html","hash":"ea562cfdaf47a455f7201b96fddf074b3ce7d5e9","modified":1767075775639},{"_id":"public/dance.html","hash":"ac52fbe13160d02b8ee136c4e8c0c8c505967b4f","modified":1767075775639},{"_id":"source/goodtime.html","hash":"7ba86379ff929863bb10ab0d11d2aa55a6a67d1a","modified":1767271340276},{"_id":"source/goodtime.mp3","hash":"ac2f3b1f30cf7a41f9e68bec7cf91a9c4b30ce74","modified":1767266656457},{"_id":"public/goodtime.html","hash":"7ba86379ff929863bb10ab0d11d2aa55a6a67d1a","modified":1767271356703},{"_id":"public/goodtime.mp3","hash":"ac2f3b1f30cf7a41f9e68bec7cf91a9c4b30ce74","modified":1767267291998},{"_id":"source/_posts/tetragon-md.md","hash":"5db233ff29a19bc0ae5dc58c1fa39ccac8e12a88","modified":1767542570401},{"_id":"public/tetragon-md.html","hash":"a4d2e14bbac830d3b616733338b58bf92055758c","modified":1767542580361},{"_id":"public/archives/2026/index.html","hash":"2b047f5dbe4b77372ce5711e616c742b0351b250","modified":1767542580361},{"_id":"public/archives/2026/01/index.html","hash":"a808616f789b1067e39bb7399e42d301dc70e549","modified":1767542580361},{"_id":"public/tags/Tetragon/index.html","hash":"e938a2d60d041e06da31b7872046e753492abe11","modified":1767542580361},{"_id":"public/tags/Runtime-Security/index.html","hash":"1845c7231eceb3cee7e6c9f7cf9a56d8fbb9657f","modified":1767542580361},{"_id":"source/ciliumv2.html","hash":"4fede05f82cf5d1381f9b07edea59b7065946776","modified":1767748710406},{"_id":"public/ciliumv2.html","hash":"4fede05f82cf5d1381f9b07edea59b7065946776","modified":1767748731297}],"Category":[{"name":"作品集","_id":"cuidobEyq_vlTOF1kRET6mtA-"}],"Data":[],"Page":[{"title":"tags","date":"2023-03-02T10:56:17.000Z","type":"tags","_content":"","source":"tags/index.md","raw":"---\ntitle: tags\ndate: 2023-03-02 18:56:17\ntype: tags\n---\n","updated":"2025-12-14T09:50:07.485Z","path":"tags/index.html","comments":1,"layout":"page","_id":"cuidfnisAXJKHshc4A5s6Lyvq","content":"","length":0,"excerpt":"","more":""}],"Post":[{"layout":"post","title":"eBPF 技术展示","date":"2026-01-04T12:10:00.000Z","_content":"\n🚀 Linux 内核的“魔法哨兵”：为什么 eBPF 是可观测性与安全的未来？\n\n作为一名安全架构师，我见证了无数监控方案在高性能需求面前的力不从心。直到 eBPF 的出现，它彻底改变了我们在不触动内核源码的情况下观察、拦截和优化系统的能力。\n\n在我最新的技术博客中，我深入剖析了： \n🔹 JIT 与 Verifier：如何在高性能与极致安全之间取得平衡？ \n🔹 零侵入观测：如何在不修改业务代码的情况下实现内核级监控？ \n🔹 安全攻防：利用 eBPF 打造下一代运行时安全防御体系。\n\n逻辑清晰的技术白皮书，带你从底层理解这项革命性技术。\n\n你可以在下方直接浏览，或点击链接全屏查看。\n\n<!--more-->\n\n<div style=\"position: relative; width: 100%; height: 0; padding-bottom: 75%; overflow: hidden; border: 1px solid #eee; border-radius: 8px;\">\n    <iframe src=\"/ebpf.html\" style=\"position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0;\"></iframe>\n</div>\n\n<div style=\"margin-top: 20px; text-align: center;\">\n    <a href=\"/ebpf.html\" target=\"_blank\" style=\"display: inline-block; padding: 10px 20px; background: #333; color: #fff; text-decoration: none; border-radius: 4px;\">🚀 全屏浏览此页面</a>\n</div>","source":"_posts/BRKSEC-2169-ebpf-md.md","raw":"---\nlayout: post\ntitle: eBPF 技术展示\ndate: 2026-01-04 20:10:00\ntags: [eBPF, Linux, AI Works]\ncategories: 作品集\n---\n\n🚀 Linux 内核的“魔法哨兵”：为什么 eBPF 是可观测性与安全的未来？\n\n作为一名安全架构师，我见证了无数监控方案在高性能需求面前的力不从心。直到 eBPF 的出现，它彻底改变了我们在不触动内核源码的情况下观察、拦截和优化系统的能力。\n\n在我最新的技术博客中，我深入剖析了： \n🔹 JIT 与 Verifier：如何在高性能与极致安全之间取得平衡？ \n🔹 零侵入观测：如何在不修改业务代码的情况下实现内核级监控？ \n🔹 安全攻防：利用 eBPF 打造下一代运行时安全防御体系。\n\n逻辑清晰的技术白皮书，带你从底层理解这项革命性技术。\n\n你可以在下方直接浏览，或点击链接全屏查看。\n\n<!--more-->\n\n<div style=\"position: relative; width: 100%; height: 0; padding-bottom: 75%; overflow: hidden; border: 1px solid #eee; border-radius: 8px;\">\n    <iframe src=\"/ebpf.html\" style=\"position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0;\"></iframe>\n</div>\n\n<div style=\"margin-top: 20px; text-align: center;\">\n    <a href=\"/ebpf.html\" target=\"_blank\" style=\"display: inline-block; padding: 10px 20px; background: #333; color: #fff; text-decoration: none; border-radius: 4px;\">🚀 全屏浏览此页面</a>\n</div>","slug":"BRKSEC-2169-ebpf-md","published":1,"updated":"2026-01-04T15:58:51.921Z","_id":"cuid6vlNGu1X047RteIEyQJtd","comments":1,"photos":[],"content":"<p>🚀 Linux 内核的“魔法哨兵”：为什么 eBPF 是可观测性与安全的未来？</p>\n<p>作为一名安全架构师，我见证了无数监控方案在高性能需求面前的力不从心。直到 eBPF 的出现，它彻底改变了我们在不触动内核源码的情况下观察、拦截和优化系统的能力。</p>\n<p>在我最新的技术博客中，我深入剖析了：<br>🔹 JIT 与 Verifier：如何在高性能与极致安全之间取得平衡？<br>🔹 零侵入观测：如何在不修改业务代码的情况下实现内核级监控？<br>🔹 安全攻防：利用 eBPF 打造下一代运行时安全防御体系。</p>\n<p>逻辑清晰的技术白皮书，带你从底层理解这项革命性技术。</p>\n<p>你可以在下方直接浏览，或点击链接全屏查看。</p>\n<span id=\"more\"></span>\n\n<div style=\"position: relative; width: 100%; height: 0; padding-bottom: 75%; overflow: hidden; border: 1px solid #eee; border-radius: 8px;\">\n    <iframe src=\"/ebpf.html\" style=\"position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0;\"></iframe>\n</div>\n\n<div style=\"margin-top: 20px; text-align: center;\">\n    <a href=\"/ebpf.html\" target=\"_blank\" style=\"display: inline-block; padding: 10px 20px; background: #333; color: #fff; text-decoration: none; border-radius: 4px;\">🚀 全屏浏览此页面</a>\n</div>","length":297,"excerpt":"<p>🚀 Linux 内核的“魔法哨兵”：为什么 eBPF 是可观测性与安全的未来？</p>\n<p>作为一名安全架构师，我见证了无数监控方案在高性能需求面前的力不从心。直到 eBPF 的出现，它彻底改变了我们在不触动内核源码的情况下观察、拦截和优化系统的能力。</p>\n<p>在我最新的技术博客中，我深入剖析了：<br>🔹 JIT 与 Verifier：如何在高性能与极致安全之间取得平衡？<br>🔹 零侵入观测：如何在不修改业务代码的情况下实现内核级监控？<br>🔹 安全攻防：利用 eBPF 打造下一代运行时安全防御体系。</p>\n<p>逻辑清晰的技术白皮书，带你从底层理解这项革命性技术。</p>\n<p>你可以在下方直接浏览，或点击链接全屏查看。</p>","more":"<div style=\"position: relative; width: 100%; height: 0; padding-bottom: 75%; overflow: hidden; border: 1px solid #eee; border-radius: 8px;\">\n    <iframe src=\"/ebpf.html\" style=\"position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0;\"></iframe>\n</div>\n\n<div style=\"margin-top: 20px; text-align: center;\">\n    <a href=\"/ebpf.html\" target=\"_blank\" style=\"display: inline-block; padding: 10px 20px; background: #333; color: #fff; text-decoration: none; border-radius: 4px;\">🚀 全屏浏览此页面</a>\n</div>"},{"title":"使用ChatGPT生成cloud-init制作AppDynamics在AWS上的安装镜像","date":"2023-03-02T01:00:00.000Z","_content":"\n作者: 饶维波\n\n本文记录通过ChatGPT生成cloud-init制作AppDynamics在AWS上 AMI安装镜像的过程，形成操作文档作为参考指南。\n\n# 任务简介和总体思路\n\n##  任务简介\n\nCisco AppDynamics 提供功能强大、易于使用的应用程序性能管理（APM）解决方案，端到端监控亚马逊云的应用程序，包括微服务和 Docker，通过 CloudWatch 集成为 EC2、DynamoDB、Lambda 等提供支持。AppDynamics可比较和验证云迁移前后的从客户到业务的优化，从而加速客户上云，因而深受用户喜爱。\n\n为了提升用户在亚马逊云科技云端安装部署AppDynamics软件的效率，我们需要制作一个打包好的安装镜像，叫做Amazon Machine Images (AMI)。用户使用AMI镜像启动虚拟机即可进入AppDynamics的设置界面，这能帮助用户节省大量软件下载、安装调试的时间，极大改善用户的安装体验。\n\n本次任务的目标是需要完成AppDynamics AMI的制作，且为了便于后续维护，维护的工作主要包括操作系统层面的安全漏洞修复、AppDynamics软件版本的升级，尽量使用自动化，节省人的时间精力的同时，避免人为错误。\n\n任务关键点是需要编写一个自动化脚本，考虑为Shell脚本或者cloud-init脚本。\n\n<!-- more -->\n\n##  总体思路\n\n首先需要考虑安装镜像的目标状态是什么？我们设想用户通过镜像创建EC2虚拟机实例，可以直接进入Enterprise Console的界面，并已预设了用户名密码。\n\n那我们可否启动一个EC2实例，并且在上面完成Enterprise Console的安装，然后生成快照做成AMI镜像？咨询了一下安装过AppDynamics的同事，他表示他宁愿选择重新安装，因为每个用户的需求是不同的。因此，我们只需要把需要安装的软件包下载到EC2实例，并设置好安装参数，等用户对AMI镜像进行实例化（基于AMI创建虚拟机）时，再进行Enterprise Console的安装。\n\nAWS对于AMI镜像有要求，即不允许使用静态设定的密码，建议使用EC2的instance-id作为密码。\n\n那么，我们的任务就基本清晰了，以下是任务清单\n\n1. 启动EC2实例，安装所需要的依赖包，以确保AppDynamics软件包能正常安装\n2. 设置用户权限\n3. 将AppDynamics的软件包拷贝到EC2实例\n4. 生成默认的安装参数，并设置系统启动脚本，该脚本只执行一次，在AMI实例化时执行安装，并启动Enterprise Console\n5. 按照AWS的安全合规要求进行处理，包括设置SSH参数，清除SSH Key，不留后门等要求。\n6. 关机后，基于EC2实例的快照制作镜像\n7. 最后是对镜像进行验证\n\n上面最关键的点是自动化脚本的编写，在这里，笔者使用ChatGPT来辅助生成代码。\n\n# 通过与ChatGPT对话，让其生成代码\n\n##  与ChatGPT的对话\n\n**经多次对话后，整理内容如下：**\n\n请你帮助生成一个Cloud-init代码，自动执行以下内容。\n\n在AWS Console启动AWS Linux 2 AMI，并在启动时执行以下动作：\n1、安装libaio, numactl, tzdata, ncurses-libs-5.x\n2、在/etc/security/limits.conf 中添加以下配置\n\n```bash\n\nroot hard nofile 65535\nroot soft nofile 65535\nroot hard nproc 8192\nroot soft nproc 8192\n```\n\n3、你已经会安装Cisco AppDynamics Enterprise Console 21.6.1版本，现在我将安装文件拷贝到了s3://ciscoappd/platform-setup-x64-linux-21.6.1.26487.sh。请创建/opt/appdynamics目录，将Cisco AppDynamics Enterprise Console的安装文件s3://ciscoappd/platform-setup-x64-linux-21.6.1.26487.sh拷贝至该目录，并将其设置为可执行；\n4、在/opt/appdynamics目录，生成初始文件response.varfile.bak，内容如下：\n\n```bash\n\nserverHostName=HOST_NAME\nsys.languageId=en\ndisableEULA=true\nplatformAdmin.port=9191\nplatformAdmin.databasePort=3377\nplatformAdmin.dataDir=/opt/appdynamics/platform/mysql/data\nplatformAdmin.databasePassword=ENTER_PASSWORD\nplatformAdmin.databaseRootPassword=ENTER_PASSWORD\nplatformAdmin.adminPassword=ENTER_PASSWORD\nplatformAdmin.useHttps$Boolean=false\nsys.installationDir=/opt/appdynamics/platform\n```\n\n上面的工作完成之后，再执行以下工作。\n\n5、请生成一个开机启动脚本，要求如下：\n5.1 该脚本不在本EC2实例中执行，将其设置为开机后延迟30秒之后再执行，脚本仅需执行一次；\n5.2 将/opt/appdynamics/response.varfile.bak 复制为 opt/appdynamics/response.varfile\n5.2 将/opt/appdynamics/response.varfile中的ENTER_PASSWORD替换为EC2 meta-data中的instance-id\n5.3 将/opt/appdynamics/response.varfile中的HOST_NAME设置为EC2 meta-data中的hostname\n5.4 静默安装Enterprise Console /opt/appdynamics/platform-setup-x64-linux-21.6.1.26487.sh -q -varfile /opt/appdynamics/response.varfile\n\n**一些对话经验：**\n\n- ChatGPT所掌握的数据截止到2021年9月，比如您问他卡塔尔世界杯的结果，他是不知道的。在经过多次与ChatGPT对话，它告诉我他能安装的AppDynamics最新版本是21.6.1，如果我请它直接安装23.1.1.18，它给出的代码有误。于是我请它按照21.6.1版本来安装，在上面的对话中可以看出有这部分的内容。\n- 如果一次提问的需求过于复杂，它在生成代码时，会因意外中断，因此，要注意控制一次对话的长度和问题的复杂度。上面列出的对话内容是多次对话整理出来的。\n- 如果它理解不对，可以直接指正它，吧需求提的更具体，比如请使用‘write_files’和‘runcmd’生成代码。如果不加限制，它可能会给出整段代码全部都用 echo 语句来实现，相比结构化的代码，不易理解。\n\n##  生成的cloud-init代码\n\n通过继续追问，让其帮忙生成Systemd的服务配置文件，要求只运行一次，再经过多次调试和修改，最终形成以下cloud-init代码。\n\n```yaml\n#cloud-config\npackages:\n  - libaio\n  - numactl\n  - tzdata\n  - ncurses-libs-5.x\n\nwrite_files:\n  - path: /etc/security/limits.conf\n    content: |\n      root hard nofile 65535\n      root soft nofile 65535\n      root hard nproc 8192\n      root soft nproc 8192\n\n  - path: /opt/appdynamics/response.varfile.bak\n    content: |\n      serverHostName=HOST_NAME\n      sys.languageId=en\n      disableEULA=true\n      platformAdmin.port=9191\n      platformAdmin.databasePort=3377\n      platformAdmin.dataDir=/opt/appdynamics/platform/mysql/data\n      platformAdmin.databasePassword=ENTER_PASSWORD\n      platformAdmin.databaseRootPassword=ENTER_PASSWORD\n      platformAdmin.adminPassword=ENTER_PASSWORD\n      platformAdmin.useHttps$Boolean=false\n      sys.installationDir=/opt/appdynamics/platform\n\n  - path: /etc/systemd/system/appd.console.service\n    permissions: '0644'\n    content: |\n      [Unit]\n      Description=AppDynamics Enterprise Console\n      After=network.target\n\n      [Service]\n      Type=forking\n      ExecStart=/opt/appdynamics/platform/platform-admin/bin/platform-admin.sh start-platform-admin\n      ExecStop=/opt/appdynamics/platform/platform-admin/bin/platform-admin.sh stop-platform-admin\n      User=root\n      Restart=always\n\n      [Install]\n      WantedBy=multi-user.target\n\n  - path: /etc/systemd/system/appd.console.install.service\n    permissions: '0644'\n    content: |\n      [Unit]\n      Description=AppDynamics Enterprise Console Installation\n      After=network.target\n\n      [Service]\n      Type=oneshot\n      RemainAfterExit=no\n      ExecStart=/bin/sh -c 'sleep 5 && cp /opt/appdynamics/response.varfile.bak /opt/appdynamics/response.varfile && sed -i \\\"s/ENTER_PASSWORD/`curl http://169.254.169.254/latest/meta-data/instance-id`/g\\\" /opt/appdynamics/response.varfile && sed -i \\\"s/HOST_NAME/`curl http://169.254.169.254/latest/meta-data/hostname`/g\\\" /opt/appdynamics/response.varfile && /opt/appdynamics/platform-setup-x64-linux-23.1.1.18.sh -q -varfile /opt/appdynamics/response.varfile && systemctl daemon-reload && systemctl enable appd.console.service && systemctl start appd.console.service'\n\n      [Install]\n      WantedBy=multi-user.target\n\nruncmd:\n  # Create directory and copy Cisco AppDynamics Enterprise Console setup file\n  - aws s3 cp s3://ciscoappdnx/platform-setup-x64-linux-23.1.1.18.sh /opt/appdynamics/ --region cn-northwest-1\n  - chmod +x /opt/appdynamics/platform-setup-x64-linux-23.1.1.18.sh\n  - systemctl daemon-reload\n  - systemctl enable appd.console.install.service\n  - sed -i 's/#PermitRootLogin yes/PermitRootLogin no/g' /etc/ssh/sshd_config\n  - rm -rf /root/.ssh/authorized_keys\n  - rm -rf /home/ec2-user/.ssh/authorized_keys\n  - shred -u /etc/ssh/*_key /etc/ssh/*_key.pub\n```\n\n将上述代码复制粘贴到创建EC2实例的 **user-data** 这一栏中，即可完成软件的拷贝和开机脚本的生成。\n\n上述的代码是经过多次调测才形成的，其中有两处要注意：\n\n```bash\n1. aws s3 cp 命令，在最后要加上 **‘region’** 参数，否则会报fatal error: An error occurred (400) when calling the HeadObject operation: Bad Request。这一点ChatGPT没有注意到，需要提醒它，当然它学的很快。\n2. ExecStart=/bin/sh -c 'sleep 5 && cp /opt/appdynamics/response.varfile.bak /opt/appdynamics/response.varfile && sed -i \\\"s/ENTER_PASSWORD/`curl http://169.254.169.254/latest/meta-data/instance-id`/g\\\" /opt/appdynamics/response.varfile && sed -i \\\"s/HOST_NAME/`curl http://169.254.169.254/latest/meta-data/hostname`/g\\\" /opt/appdynamics/response.varfile && /opt/appdynamics/platform-setup-x64-linux-23.1.1.18.sh -q -varfile /opt/appdynamics/response.varfile && systemctl daemon-reload && systemctl enable appd.console.service && systemctl start appd.console.service'\n这条命令是很复杂的，一个命令一个命令串行执行，其中还包括了转义字符，如果不是ChatGPT生成，我个人很难完成这个命令。该命令顺序执行以下内容，只有前面的命令执行成功，才会继续执行下一条命令：\n    1. 等待5秒钟再启动，主要是让EC2的网络和其他关联服务充分就绪；\n    2. 将response.varfile.bak拷贝至response.varfile\n    3. 使用sed命令将ENTER_PASSWORD替换为instance-id，instance-id由curl命令获取，更新response.varfile\n    4. 使用sed命令将HOST_NAME替换为hostname，hostname由curl命令获取，更新response.varfile\n    5. 执行静默安装脚本，经测算安装需要大约10分钟\n    6. 重新加载systemd，并创建appd.console.service\n    7. 最后是执行appd.console.service启动Console Service\n```\n通过SSM连接到EC2实例（注意设置EC2的IAM Role，具备SSM和S3的访问权限），通过以下命令进行调测。\n\n```bash\nsudo su\ncd /opt/appdynamics\nls -al\n# 查看platform-setup-x64-linux-23.1.1.18.sh 和 response.varfile.bak是否存在，\n# 且安装包是否被设置为可执行\ncat /etc/security/limits.conf\ncat /etc/systemd/system/appd.console.service\ncat /etc/systemd/system/appd.console.install.service\ncat /etc/ssh/sshd_config | grep PermitRootLogin\n\nls -al /etc/ssh\nls -al /root/.ssh\nls -al /home/ec2-user/.ssh\n\ncat /var/log/cloud-init-output.log\n# 检查是否有错误发生\n```\n\n# 在AWS上制作安装镜像AMI文件\n\n##  创建一个EC2实例\n\n前提条件：VPC、公有子网均已设置好。\n\n以下是操作步骤截图及相关说明\n\n**1、在EC2服务界面中点击Launch instance**\n\n![SCR-20230301-vv3.png](ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-vv3.png)\n\n**2、填写EC2实例的Name，选择Amazon Linux**\n\n![SCR-20230301-vxg.png](ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-vxg.png)\n\n**3、选择实例类型c5.xlarge，不需要Key pair，选择公有子网，并自动分配公网IP地址。**\n\n![SCR-20230301-vz3.png](ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-vz3.png)\n\n**4、设置Security Group ，设置磁盘大小500G**\n\n![SCR-20230301-w1t.png](ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-w1t.png)\n\n**Security Group的设置如下**\n\n![SCR-20230301-w1c.png](ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-w1c.png)\n\n**5、分配IAM 角色**\n\n![SCR-20230301-w6k.png](ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-w6k.png)\n\n**IAM角色具体设置如下，设置SSM权限和S3的访问权限**\n\n![SCR-20230301-w8d.png](ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-w8d.png)\n\n**6、将上述cloud-init 代码输入user-data中，并点击 Launch instance**\n\n![SCR-20230301-wa6.png](ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-wa6.png)\n\n##  检查EC2实例的设置\n\n**1、通过SSM连接EC2实例，如果未设置SSM的权限，则不能使用该方式管理EC2**\n\n![SCR-20230301-wdb.png](ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-wdb.png)\n\n![SCR-20230301-wgi.png](ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-wgi.png)\n\n**2、执行命令检查EC2的设置是否符合预期**\n\n![SCR-20230301-wi7.png](ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-wi7.png)\n\n![SCR-20230301-wle.png](ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-wle.png)\n\n以下是文本格式的输出：\n\n```bash\n[root@ip-172-31-13-10 appdynamics]# cat /etc/security/limits.conf\nroot hard nofile 65535\nroot soft nofile 65535\nroot hard nproc 8192\nroot soft nproc 8192\n\n[root@ip-172-31-13-10 appdynamics]# cat /etc/systemd/system/appd.console.service\n[Unit]\nDescription=AppDynamics Enterprise Console\nAfter=network.target\n\n[Service]\nType=forking\nExecStart=/opt/appdynamics/platform/platform-admin/bin/platform-admin.sh start-platform-admin\nExecStop=/opt/appdynamics/platform/platform-admin/bin/platform-admin.sh stop-platform-admin\nUser=root\nRestart=always\n\n[Install]\nWantedBy=multi-user.target\n\n[root@ip-172-31-13-10 appdynamics]# cat /etc/systemd/system/appd.console.install.service\n[Unit]\nDescription=AppDynamics Enterprise Console Installation\nAfter=network.target\n\n[Service]\nType=oneshot\nRemainAfterExit=no\nExecStart=/bin/sh -c 'sleep 5 && cp /opt/appdynamics/response.varfile.bak /opt/appdynamics/response.varfile && sed -i \\\"s/ENTER_PASSWORD/`curl http://169.254.169.254/latest/meta-data/instance-id`/g\\\" /opt/appdynamics/response.varfile && sed -i \\\"s/HOST_NAME/`curl http://169.254.169.254/latest/meta-data/hostname`/g\\\" /opt/appdynamics/response.varfile && /opt/appdynamics/platform-setup-x64-linux-23.1.1.18.sh -q -varfile/opt/appdynamics/response.varfile && systemctl daemon-reload && systemctl enable appd.console.service && systemctl start appd.console.service'\n\n[Install]\nWantedBy=multi-user.target\n```\n\n**可以看出是符合预期的，执行 history -c 清除历史记录。**\n\n##  生成AMI镜像\n\n**1、将该EC2关机**\n\n![SCR-20230301-wn8.png](ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-wn8.png)\n\n**2、确认关机后，点击制作Image**\n\n![SCR-20230301-wob.png](ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-wob.png)\n\n**3、填入Image的参数，点击Create Image**\n\n![SCR-20230301-wzx.png](ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-wzx.png)\n\n# 验证AMI\n\n##  使用AMI启动EC2实例\n\n**1、等待AMI状态变Available后，点击Launch instance from AMI**\n\n![SCR-20230301-x5q.png](ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-x5q.png)\n\n**2、进入EC2启动的设置页面，进行必要的设置**\n\n![SCR-20230301-x8g.png](ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-x8g.png)\n\n**除了user-data维持空白，其他设置可与创建AMI的EC2一致。**\n\n**3、EC2创建后，转到EC2的信息页面**\n\n![SCR-20230302-8x.png](ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230302-8x.png)\n\n**4、测试Enterprise Console的Web界面**\n\n大概10分钟后，可以通过以下地址访问\n\n```bash\nhttp://ec2-69-230-211-253.cn-northwest-1.compute.amazonaws.com.cn/:9191\nusername: admin\npassword: 从信息页面中拷贝instance-id，如上图为i-06b75d367808d02af\n```\n\n![SCR-20230302-a8.png](ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230302-a8.png)\n\n![SCR-20230302-b8.png](ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230302-b8.png)\n\n**5、使用SSM连接EC2，检查相关服务是否正常**\n\n![SCR-20230302-du.png](ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230302-du.png)\n\n# 总结\n\n本文整理了在AWS上制作AppDynamics的AMI镜像的过程，笔者使用了ChatGPT帮助生成自动化脚本，极大的提高了效率。\n本文中的cloud-init代码已发布到Github，如下：\n\n[https://github.com/weiborao/appd-console-install-cloud-init/blob/main/appd-install-cloud-init-CN.yaml](https://github.com/weiborao/appd-console-install-cloud-init/blob/main/appd-install-cloud-init-CN.yaml)\n\n非常感谢各位耐心的阅读，","source":"_posts/ChatGPT-generate-code-to-build-AMI-for-AppDynamics.md","raw":"---\ntitle: 使用ChatGPT生成cloud-init制作AppDynamics在AWS上的安装镜像\ndate: 2023-03-02 09:00:00\ntags:\n    - chatGPT\n    - AMI\n    - AppDynamics\n    - cloud-init\n---\n\n作者: 饶维波\n\n本文记录通过ChatGPT生成cloud-init制作AppDynamics在AWS上 AMI安装镜像的过程，形成操作文档作为参考指南。\n\n# 任务简介和总体思路\n\n##  任务简介\n\nCisco AppDynamics 提供功能强大、易于使用的应用程序性能管理（APM）解决方案，端到端监控亚马逊云的应用程序，包括微服务和 Docker，通过 CloudWatch 集成为 EC2、DynamoDB、Lambda 等提供支持。AppDynamics可比较和验证云迁移前后的从客户到业务的优化，从而加速客户上云，因而深受用户喜爱。\n\n为了提升用户在亚马逊云科技云端安装部署AppDynamics软件的效率，我们需要制作一个打包好的安装镜像，叫做Amazon Machine Images (AMI)。用户使用AMI镜像启动虚拟机即可进入AppDynamics的设置界面，这能帮助用户节省大量软件下载、安装调试的时间，极大改善用户的安装体验。\n\n本次任务的目标是需要完成AppDynamics AMI的制作，且为了便于后续维护，维护的工作主要包括操作系统层面的安全漏洞修复、AppDynamics软件版本的升级，尽量使用自动化，节省人的时间精力的同时，避免人为错误。\n\n任务关键点是需要编写一个自动化脚本，考虑为Shell脚本或者cloud-init脚本。\n\n<!-- more -->\n\n##  总体思路\n\n首先需要考虑安装镜像的目标状态是什么？我们设想用户通过镜像创建EC2虚拟机实例，可以直接进入Enterprise Console的界面，并已预设了用户名密码。\n\n那我们可否启动一个EC2实例，并且在上面完成Enterprise Console的安装，然后生成快照做成AMI镜像？咨询了一下安装过AppDynamics的同事，他表示他宁愿选择重新安装，因为每个用户的需求是不同的。因此，我们只需要把需要安装的软件包下载到EC2实例，并设置好安装参数，等用户对AMI镜像进行实例化（基于AMI创建虚拟机）时，再进行Enterprise Console的安装。\n\nAWS对于AMI镜像有要求，即不允许使用静态设定的密码，建议使用EC2的instance-id作为密码。\n\n那么，我们的任务就基本清晰了，以下是任务清单\n\n1. 启动EC2实例，安装所需要的依赖包，以确保AppDynamics软件包能正常安装\n2. 设置用户权限\n3. 将AppDynamics的软件包拷贝到EC2实例\n4. 生成默认的安装参数，并设置系统启动脚本，该脚本只执行一次，在AMI实例化时执行安装，并启动Enterprise Console\n5. 按照AWS的安全合规要求进行处理，包括设置SSH参数，清除SSH Key，不留后门等要求。\n6. 关机后，基于EC2实例的快照制作镜像\n7. 最后是对镜像进行验证\n\n上面最关键的点是自动化脚本的编写，在这里，笔者使用ChatGPT来辅助生成代码。\n\n# 通过与ChatGPT对话，让其生成代码\n\n##  与ChatGPT的对话\n\n**经多次对话后，整理内容如下：**\n\n请你帮助生成一个Cloud-init代码，自动执行以下内容。\n\n在AWS Console启动AWS Linux 2 AMI，并在启动时执行以下动作：\n1、安装libaio, numactl, tzdata, ncurses-libs-5.x\n2、在/etc/security/limits.conf 中添加以下配置\n\n```bash\n\nroot hard nofile 65535\nroot soft nofile 65535\nroot hard nproc 8192\nroot soft nproc 8192\n```\n\n3、你已经会安装Cisco AppDynamics Enterprise Console 21.6.1版本，现在我将安装文件拷贝到了s3://ciscoappd/platform-setup-x64-linux-21.6.1.26487.sh。请创建/opt/appdynamics目录，将Cisco AppDynamics Enterprise Console的安装文件s3://ciscoappd/platform-setup-x64-linux-21.6.1.26487.sh拷贝至该目录，并将其设置为可执行；\n4、在/opt/appdynamics目录，生成初始文件response.varfile.bak，内容如下：\n\n```bash\n\nserverHostName=HOST_NAME\nsys.languageId=en\ndisableEULA=true\nplatformAdmin.port=9191\nplatformAdmin.databasePort=3377\nplatformAdmin.dataDir=/opt/appdynamics/platform/mysql/data\nplatformAdmin.databasePassword=ENTER_PASSWORD\nplatformAdmin.databaseRootPassword=ENTER_PASSWORD\nplatformAdmin.adminPassword=ENTER_PASSWORD\nplatformAdmin.useHttps$Boolean=false\nsys.installationDir=/opt/appdynamics/platform\n```\n\n上面的工作完成之后，再执行以下工作。\n\n5、请生成一个开机启动脚本，要求如下：\n5.1 该脚本不在本EC2实例中执行，将其设置为开机后延迟30秒之后再执行，脚本仅需执行一次；\n5.2 将/opt/appdynamics/response.varfile.bak 复制为 opt/appdynamics/response.varfile\n5.2 将/opt/appdynamics/response.varfile中的ENTER_PASSWORD替换为EC2 meta-data中的instance-id\n5.3 将/opt/appdynamics/response.varfile中的HOST_NAME设置为EC2 meta-data中的hostname\n5.4 静默安装Enterprise Console /opt/appdynamics/platform-setup-x64-linux-21.6.1.26487.sh -q -varfile /opt/appdynamics/response.varfile\n\n**一些对话经验：**\n\n- ChatGPT所掌握的数据截止到2021年9月，比如您问他卡塔尔世界杯的结果，他是不知道的。在经过多次与ChatGPT对话，它告诉我他能安装的AppDynamics最新版本是21.6.1，如果我请它直接安装23.1.1.18，它给出的代码有误。于是我请它按照21.6.1版本来安装，在上面的对话中可以看出有这部分的内容。\n- 如果一次提问的需求过于复杂，它在生成代码时，会因意外中断，因此，要注意控制一次对话的长度和问题的复杂度。上面列出的对话内容是多次对话整理出来的。\n- 如果它理解不对，可以直接指正它，吧需求提的更具体，比如请使用‘write_files’和‘runcmd’生成代码。如果不加限制，它可能会给出整段代码全部都用 echo 语句来实现，相比结构化的代码，不易理解。\n\n##  生成的cloud-init代码\n\n通过继续追问，让其帮忙生成Systemd的服务配置文件，要求只运行一次，再经过多次调试和修改，最终形成以下cloud-init代码。\n\n```yaml\n#cloud-config\npackages:\n  - libaio\n  - numactl\n  - tzdata\n  - ncurses-libs-5.x\n\nwrite_files:\n  - path: /etc/security/limits.conf\n    content: |\n      root hard nofile 65535\n      root soft nofile 65535\n      root hard nproc 8192\n      root soft nproc 8192\n\n  - path: /opt/appdynamics/response.varfile.bak\n    content: |\n      serverHostName=HOST_NAME\n      sys.languageId=en\n      disableEULA=true\n      platformAdmin.port=9191\n      platformAdmin.databasePort=3377\n      platformAdmin.dataDir=/opt/appdynamics/platform/mysql/data\n      platformAdmin.databasePassword=ENTER_PASSWORD\n      platformAdmin.databaseRootPassword=ENTER_PASSWORD\n      platformAdmin.adminPassword=ENTER_PASSWORD\n      platformAdmin.useHttps$Boolean=false\n      sys.installationDir=/opt/appdynamics/platform\n\n  - path: /etc/systemd/system/appd.console.service\n    permissions: '0644'\n    content: |\n      [Unit]\n      Description=AppDynamics Enterprise Console\n      After=network.target\n\n      [Service]\n      Type=forking\n      ExecStart=/opt/appdynamics/platform/platform-admin/bin/platform-admin.sh start-platform-admin\n      ExecStop=/opt/appdynamics/platform/platform-admin/bin/platform-admin.sh stop-platform-admin\n      User=root\n      Restart=always\n\n      [Install]\n      WantedBy=multi-user.target\n\n  - path: /etc/systemd/system/appd.console.install.service\n    permissions: '0644'\n    content: |\n      [Unit]\n      Description=AppDynamics Enterprise Console Installation\n      After=network.target\n\n      [Service]\n      Type=oneshot\n      RemainAfterExit=no\n      ExecStart=/bin/sh -c 'sleep 5 && cp /opt/appdynamics/response.varfile.bak /opt/appdynamics/response.varfile && sed -i \\\"s/ENTER_PASSWORD/`curl http://169.254.169.254/latest/meta-data/instance-id`/g\\\" /opt/appdynamics/response.varfile && sed -i \\\"s/HOST_NAME/`curl http://169.254.169.254/latest/meta-data/hostname`/g\\\" /opt/appdynamics/response.varfile && /opt/appdynamics/platform-setup-x64-linux-23.1.1.18.sh -q -varfile /opt/appdynamics/response.varfile && systemctl daemon-reload && systemctl enable appd.console.service && systemctl start appd.console.service'\n\n      [Install]\n      WantedBy=multi-user.target\n\nruncmd:\n  # Create directory and copy Cisco AppDynamics Enterprise Console setup file\n  - aws s3 cp s3://ciscoappdnx/platform-setup-x64-linux-23.1.1.18.sh /opt/appdynamics/ --region cn-northwest-1\n  - chmod +x /opt/appdynamics/platform-setup-x64-linux-23.1.1.18.sh\n  - systemctl daemon-reload\n  - systemctl enable appd.console.install.service\n  - sed -i 's/#PermitRootLogin yes/PermitRootLogin no/g' /etc/ssh/sshd_config\n  - rm -rf /root/.ssh/authorized_keys\n  - rm -rf /home/ec2-user/.ssh/authorized_keys\n  - shred -u /etc/ssh/*_key /etc/ssh/*_key.pub\n```\n\n将上述代码复制粘贴到创建EC2实例的 **user-data** 这一栏中，即可完成软件的拷贝和开机脚本的生成。\n\n上述的代码是经过多次调测才形成的，其中有两处要注意：\n\n```bash\n1. aws s3 cp 命令，在最后要加上 **‘region’** 参数，否则会报fatal error: An error occurred (400) when calling the HeadObject operation: Bad Request。这一点ChatGPT没有注意到，需要提醒它，当然它学的很快。\n2. ExecStart=/bin/sh -c 'sleep 5 && cp /opt/appdynamics/response.varfile.bak /opt/appdynamics/response.varfile && sed -i \\\"s/ENTER_PASSWORD/`curl http://169.254.169.254/latest/meta-data/instance-id`/g\\\" /opt/appdynamics/response.varfile && sed -i \\\"s/HOST_NAME/`curl http://169.254.169.254/latest/meta-data/hostname`/g\\\" /opt/appdynamics/response.varfile && /opt/appdynamics/platform-setup-x64-linux-23.1.1.18.sh -q -varfile /opt/appdynamics/response.varfile && systemctl daemon-reload && systemctl enable appd.console.service && systemctl start appd.console.service'\n这条命令是很复杂的，一个命令一个命令串行执行，其中还包括了转义字符，如果不是ChatGPT生成，我个人很难完成这个命令。该命令顺序执行以下内容，只有前面的命令执行成功，才会继续执行下一条命令：\n    1. 等待5秒钟再启动，主要是让EC2的网络和其他关联服务充分就绪；\n    2. 将response.varfile.bak拷贝至response.varfile\n    3. 使用sed命令将ENTER_PASSWORD替换为instance-id，instance-id由curl命令获取，更新response.varfile\n    4. 使用sed命令将HOST_NAME替换为hostname，hostname由curl命令获取，更新response.varfile\n    5. 执行静默安装脚本，经测算安装需要大约10分钟\n    6. 重新加载systemd，并创建appd.console.service\n    7. 最后是执行appd.console.service启动Console Service\n```\n通过SSM连接到EC2实例（注意设置EC2的IAM Role，具备SSM和S3的访问权限），通过以下命令进行调测。\n\n```bash\nsudo su\ncd /opt/appdynamics\nls -al\n# 查看platform-setup-x64-linux-23.1.1.18.sh 和 response.varfile.bak是否存在，\n# 且安装包是否被设置为可执行\ncat /etc/security/limits.conf\ncat /etc/systemd/system/appd.console.service\ncat /etc/systemd/system/appd.console.install.service\ncat /etc/ssh/sshd_config | grep PermitRootLogin\n\nls -al /etc/ssh\nls -al /root/.ssh\nls -al /home/ec2-user/.ssh\n\ncat /var/log/cloud-init-output.log\n# 检查是否有错误发生\n```\n\n# 在AWS上制作安装镜像AMI文件\n\n##  创建一个EC2实例\n\n前提条件：VPC、公有子网均已设置好。\n\n以下是操作步骤截图及相关说明\n\n**1、在EC2服务界面中点击Launch instance**\n\n![SCR-20230301-vv3.png](ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-vv3.png)\n\n**2、填写EC2实例的Name，选择Amazon Linux**\n\n![SCR-20230301-vxg.png](ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-vxg.png)\n\n**3、选择实例类型c5.xlarge，不需要Key pair，选择公有子网，并自动分配公网IP地址。**\n\n![SCR-20230301-vz3.png](ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-vz3.png)\n\n**4、设置Security Group ，设置磁盘大小500G**\n\n![SCR-20230301-w1t.png](ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-w1t.png)\n\n**Security Group的设置如下**\n\n![SCR-20230301-w1c.png](ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-w1c.png)\n\n**5、分配IAM 角色**\n\n![SCR-20230301-w6k.png](ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-w6k.png)\n\n**IAM角色具体设置如下，设置SSM权限和S3的访问权限**\n\n![SCR-20230301-w8d.png](ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-w8d.png)\n\n**6、将上述cloud-init 代码输入user-data中，并点击 Launch instance**\n\n![SCR-20230301-wa6.png](ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-wa6.png)\n\n##  检查EC2实例的设置\n\n**1、通过SSM连接EC2实例，如果未设置SSM的权限，则不能使用该方式管理EC2**\n\n![SCR-20230301-wdb.png](ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-wdb.png)\n\n![SCR-20230301-wgi.png](ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-wgi.png)\n\n**2、执行命令检查EC2的设置是否符合预期**\n\n![SCR-20230301-wi7.png](ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-wi7.png)\n\n![SCR-20230301-wle.png](ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-wle.png)\n\n以下是文本格式的输出：\n\n```bash\n[root@ip-172-31-13-10 appdynamics]# cat /etc/security/limits.conf\nroot hard nofile 65535\nroot soft nofile 65535\nroot hard nproc 8192\nroot soft nproc 8192\n\n[root@ip-172-31-13-10 appdynamics]# cat /etc/systemd/system/appd.console.service\n[Unit]\nDescription=AppDynamics Enterprise Console\nAfter=network.target\n\n[Service]\nType=forking\nExecStart=/opt/appdynamics/platform/platform-admin/bin/platform-admin.sh start-platform-admin\nExecStop=/opt/appdynamics/platform/platform-admin/bin/platform-admin.sh stop-platform-admin\nUser=root\nRestart=always\n\n[Install]\nWantedBy=multi-user.target\n\n[root@ip-172-31-13-10 appdynamics]# cat /etc/systemd/system/appd.console.install.service\n[Unit]\nDescription=AppDynamics Enterprise Console Installation\nAfter=network.target\n\n[Service]\nType=oneshot\nRemainAfterExit=no\nExecStart=/bin/sh -c 'sleep 5 && cp /opt/appdynamics/response.varfile.bak /opt/appdynamics/response.varfile && sed -i \\\"s/ENTER_PASSWORD/`curl http://169.254.169.254/latest/meta-data/instance-id`/g\\\" /opt/appdynamics/response.varfile && sed -i \\\"s/HOST_NAME/`curl http://169.254.169.254/latest/meta-data/hostname`/g\\\" /opt/appdynamics/response.varfile && /opt/appdynamics/platform-setup-x64-linux-23.1.1.18.sh -q -varfile/opt/appdynamics/response.varfile && systemctl daemon-reload && systemctl enable appd.console.service && systemctl start appd.console.service'\n\n[Install]\nWantedBy=multi-user.target\n```\n\n**可以看出是符合预期的，执行 history -c 清除历史记录。**\n\n##  生成AMI镜像\n\n**1、将该EC2关机**\n\n![SCR-20230301-wn8.png](ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-wn8.png)\n\n**2、确认关机后，点击制作Image**\n\n![SCR-20230301-wob.png](ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-wob.png)\n\n**3、填入Image的参数，点击Create Image**\n\n![SCR-20230301-wzx.png](ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-wzx.png)\n\n# 验证AMI\n\n##  使用AMI启动EC2实例\n\n**1、等待AMI状态变Available后，点击Launch instance from AMI**\n\n![SCR-20230301-x5q.png](ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-x5q.png)\n\n**2、进入EC2启动的设置页面，进行必要的设置**\n\n![SCR-20230301-x8g.png](ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-x8g.png)\n\n**除了user-data维持空白，其他设置可与创建AMI的EC2一致。**\n\n**3、EC2创建后，转到EC2的信息页面**\n\n![SCR-20230302-8x.png](ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230302-8x.png)\n\n**4、测试Enterprise Console的Web界面**\n\n大概10分钟后，可以通过以下地址访问\n\n```bash\nhttp://ec2-69-230-211-253.cn-northwest-1.compute.amazonaws.com.cn/:9191\nusername: admin\npassword: 从信息页面中拷贝instance-id，如上图为i-06b75d367808d02af\n```\n\n![SCR-20230302-a8.png](ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230302-a8.png)\n\n![SCR-20230302-b8.png](ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230302-b8.png)\n\n**5、使用SSM连接EC2，检查相关服务是否正常**\n\n![SCR-20230302-du.png](ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230302-du.png)\n\n# 总结\n\n本文整理了在AWS上制作AppDynamics的AMI镜像的过程，笔者使用了ChatGPT帮助生成自动化脚本，极大的提高了效率。\n本文中的cloud-init代码已发布到Github，如下：\n\n[https://github.com/weiborao/appd-console-install-cloud-init/blob/main/appd-install-cloud-init-CN.yaml](https://github.com/weiborao/appd-console-install-cloud-init/blob/main/appd-install-cloud-init-CN.yaml)\n\n非常感谢各位耐心的阅读，","slug":"ChatGPT-generate-code-to-build-AMI-for-AppDynamics","published":1,"updated":"2025-12-14T09:50:07.385Z","comments":1,"layout":"post","photos":[],"_id":"cuidNXthGD9-T8SpACZm2xcgB","content":"<p>作者: 饶维波</p>\n<p>本文记录通过ChatGPT生成cloud-init制作AppDynamics在AWS上 AMI安装镜像的过程，形成操作文档作为参考指南。</p>\n<h1 id=\"任务简介和总体思路\"><a href=\"#任务简介和总体思路\" class=\"headerlink\" title=\"任务简介和总体思路\"></a>任务简介和总体思路</h1><h2 id=\"任务简介\"><a href=\"#任务简介\" class=\"headerlink\" title=\"任务简介\"></a>任务简介</h2><p>Cisco AppDynamics 提供功能强大、易于使用的应用程序性能管理（APM）解决方案，端到端监控亚马逊云的应用程序，包括微服务和 Docker，通过 CloudWatch 集成为 EC2、DynamoDB、Lambda 等提供支持。AppDynamics可比较和验证云迁移前后的从客户到业务的优化，从而加速客户上云，因而深受用户喜爱。</p>\n<p>为了提升用户在亚马逊云科技云端安装部署AppDynamics软件的效率，我们需要制作一个打包好的安装镜像，叫做Amazon Machine Images (AMI)。用户使用AMI镜像启动虚拟机即可进入AppDynamics的设置界面，这能帮助用户节省大量软件下载、安装调试的时间，极大改善用户的安装体验。</p>\n<p>本次任务的目标是需要完成AppDynamics AMI的制作，且为了便于后续维护，维护的工作主要包括操作系统层面的安全漏洞修复、AppDynamics软件版本的升级，尽量使用自动化，节省人的时间精力的同时，避免人为错误。</p>\n<p>任务关键点是需要编写一个自动化脚本，考虑为Shell脚本或者cloud-init脚本。</p>\n<span id=\"more\"></span>\n\n<h2 id=\"总体思路\"><a href=\"#总体思路\" class=\"headerlink\" title=\"总体思路\"></a>总体思路</h2><p>首先需要考虑安装镜像的目标状态是什么？我们设想用户通过镜像创建EC2虚拟机实例，可以直接进入Enterprise Console的界面，并已预设了用户名密码。</p>\n<p>那我们可否启动一个EC2实例，并且在上面完成Enterprise Console的安装，然后生成快照做成AMI镜像？咨询了一下安装过AppDynamics的同事，他表示他宁愿选择重新安装，因为每个用户的需求是不同的。因此，我们只需要把需要安装的软件包下载到EC2实例，并设置好安装参数，等用户对AMI镜像进行实例化（基于AMI创建虚拟机）时，再进行Enterprise Console的安装。</p>\n<p>AWS对于AMI镜像有要求，即不允许使用静态设定的密码，建议使用EC2的instance-id作为密码。</p>\n<p>那么，我们的任务就基本清晰了，以下是任务清单</p>\n<ol>\n<li>启动EC2实例，安装所需要的依赖包，以确保AppDynamics软件包能正常安装</li>\n<li>设置用户权限</li>\n<li>将AppDynamics的软件包拷贝到EC2实例</li>\n<li>生成默认的安装参数，并设置系统启动脚本，该脚本只执行一次，在AMI实例化时执行安装，并启动Enterprise Console</li>\n<li>按照AWS的安全合规要求进行处理，包括设置SSH参数，清除SSH Key，不留后门等要求。</li>\n<li>关机后，基于EC2实例的快照制作镜像</li>\n<li>最后是对镜像进行验证</li>\n</ol>\n<p>上面最关键的点是自动化脚本的编写，在这里，笔者使用ChatGPT来辅助生成代码。</p>\n<h1 id=\"通过与ChatGPT对话，让其生成代码\"><a href=\"#通过与ChatGPT对话，让其生成代码\" class=\"headerlink\" title=\"通过与ChatGPT对话，让其生成代码\"></a>通过与ChatGPT对话，让其生成代码</h1><h2 id=\"与ChatGPT的对话\"><a href=\"#与ChatGPT的对话\" class=\"headerlink\" title=\"与ChatGPT的对话\"></a>与ChatGPT的对话</h2><p><strong>经多次对话后，整理内容如下：</strong></p>\n<p>请你帮助生成一个Cloud-init代码，自动执行以下内容。</p>\n<p>在AWS Console启动AWS Linux 2 AMI，并在启动时执行以下动作：<br>1、安装libaio, numactl, tzdata, ncurses-libs-5.x<br>2、在&#x2F;etc&#x2F;security&#x2F;limits.conf 中添加以下配置</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">root hard nofile 65535</span><br><span class=\"line\">root soft nofile 65535</span><br><span class=\"line\">root hard <span class=\"built_in\">nproc</span> 8192</span><br><span class=\"line\">root soft <span class=\"built_in\">nproc</span> 8192</span><br></pre></td></tr></table></figure>\n\n<p>3、你已经会安装Cisco AppDynamics Enterprise Console 21.6.1版本，现在我将安装文件拷贝到了s3:&#x2F;&#x2F;ciscoappd&#x2F;platform-setup-x64-linux-21.6.1.26487.sh。请创建&#x2F;opt&#x2F;appdynamics目录，将Cisco AppDynamics Enterprise Console的安装文件s3:&#x2F;&#x2F;ciscoappd&#x2F;platform-setup-x64-linux-21.6.1.26487.sh拷贝至该目录，并将其设置为可执行；<br>4、在&#x2F;opt&#x2F;appdynamics目录，生成初始文件response.varfile.bak，内容如下：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">serverHostName=HOST_NAME</span><br><span class=\"line\">sys.languageId=en</span><br><span class=\"line\">disableEULA=<span class=\"literal\">true</span></span><br><span class=\"line\">platformAdmin.port=9191</span><br><span class=\"line\">platformAdmin.databasePort=3377</span><br><span class=\"line\">platformAdmin.dataDir=/opt/appdynamics/platform/mysql/data</span><br><span class=\"line\">platformAdmin.databasePassword=ENTER_PASSWORD</span><br><span class=\"line\">platformAdmin.databaseRootPassword=ENTER_PASSWORD</span><br><span class=\"line\">platformAdmin.adminPassword=ENTER_PASSWORD</span><br><span class=\"line\">platformAdmin.useHttps<span class=\"variable\">$Boolean</span>=<span class=\"literal\">false</span></span><br><span class=\"line\">sys.installationDir=/opt/appdynamics/platform</span><br></pre></td></tr></table></figure>\n\n<p>上面的工作完成之后，再执行以下工作。</p>\n<p>5、请生成一个开机启动脚本，要求如下：<br>5.1 该脚本不在本EC2实例中执行，将其设置为开机后延迟30秒之后再执行，脚本仅需执行一次；<br>5.2 将&#x2F;opt&#x2F;appdynamics&#x2F;response.varfile.bak 复制为 opt&#x2F;appdynamics&#x2F;response.varfile<br>5.2 将&#x2F;opt&#x2F;appdynamics&#x2F;response.varfile中的ENTER_PASSWORD替换为EC2 meta-data中的instance-id<br>5.3 将&#x2F;opt&#x2F;appdynamics&#x2F;response.varfile中的HOST_NAME设置为EC2 meta-data中的hostname<br>5.4 静默安装Enterprise Console &#x2F;opt&#x2F;appdynamics&#x2F;platform-setup-x64-linux-21.6.1.26487.sh -q -varfile &#x2F;opt&#x2F;appdynamics&#x2F;response.varfile</p>\n<p><strong>一些对话经验：</strong></p>\n<ul>\n<li>ChatGPT所掌握的数据截止到2021年9月，比如您问他卡塔尔世界杯的结果，他是不知道的。在经过多次与ChatGPT对话，它告诉我他能安装的AppDynamics最新版本是21.6.1，如果我请它直接安装23.1.1.18，它给出的代码有误。于是我请它按照21.6.1版本来安装，在上面的对话中可以看出有这部分的内容。</li>\n<li>如果一次提问的需求过于复杂，它在生成代码时，会因意外中断，因此，要注意控制一次对话的长度和问题的复杂度。上面列出的对话内容是多次对话整理出来的。</li>\n<li>如果它理解不对，可以直接指正它，吧需求提的更具体，比如请使用‘write_files’和‘runcmd’生成代码。如果不加限制，它可能会给出整段代码全部都用 echo 语句来实现，相比结构化的代码，不易理解。</li>\n</ul>\n<h2 id=\"生成的cloud-init代码\"><a href=\"#生成的cloud-init代码\" class=\"headerlink\" title=\"生成的cloud-init代码\"></a>生成的cloud-init代码</h2><p>通过继续追问，让其帮忙生成Systemd的服务配置文件，要求只运行一次，再经过多次调试和修改，最终形成以下cloud-init代码。</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#cloud-config</span></span><br><span class=\"line\"><span class=\"attr\">packages:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">libaio</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">numactl</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">tzdata</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">ncurses-libs-5.x</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">write_files:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">path:</span> <span class=\"string\">/etc/security/limits.conf</span></span><br><span class=\"line\">    <span class=\"attr\">content:</span> <span class=\"string\">|</span></span><br><span class=\"line\"><span class=\"string\">      root hard nofile 65535</span></span><br><span class=\"line\"><span class=\"string\">      root soft nofile 65535</span></span><br><span class=\"line\"><span class=\"string\">      root hard nproc 8192</span></span><br><span class=\"line\"><span class=\"string\">      root soft nproc 8192</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">path:</span> <span class=\"string\">/opt/appdynamics/response.varfile.bak</span></span><br><span class=\"line\">    <span class=\"attr\">content:</span> <span class=\"string\">|</span></span><br><span class=\"line\"><span class=\"string\">      serverHostName=HOST_NAME</span></span><br><span class=\"line\"><span class=\"string\">      sys.languageId=en</span></span><br><span class=\"line\"><span class=\"string\">      disableEULA=true</span></span><br><span class=\"line\"><span class=\"string\">      platformAdmin.port=9191</span></span><br><span class=\"line\"><span class=\"string\">      platformAdmin.databasePort=3377</span></span><br><span class=\"line\"><span class=\"string\">      platformAdmin.dataDir=/opt/appdynamics/platform/mysql/data</span></span><br><span class=\"line\"><span class=\"string\">      platformAdmin.databasePassword=ENTER_PASSWORD</span></span><br><span class=\"line\"><span class=\"string\">      platformAdmin.databaseRootPassword=ENTER_PASSWORD</span></span><br><span class=\"line\"><span class=\"string\">      platformAdmin.adminPassword=ENTER_PASSWORD</span></span><br><span class=\"line\"><span class=\"string\">      platformAdmin.useHttps$Boolean=false</span></span><br><span class=\"line\"><span class=\"string\">      sys.installationDir=/opt/appdynamics/platform</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">path:</span> <span class=\"string\">/etc/systemd/system/appd.console.service</span></span><br><span class=\"line\">    <span class=\"attr\">permissions:</span> <span class=\"string\">&#x27;0644&#x27;</span></span><br><span class=\"line\">    <span class=\"attr\">content:</span> <span class=\"string\">|</span></span><br><span class=\"line\"><span class=\"string\">      [Unit]</span></span><br><span class=\"line\"><span class=\"string\">      Description=AppDynamics Enterprise Console</span></span><br><span class=\"line\"><span class=\"string\">      After=network.target</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\">      [<span class=\"string\">Service</span>]</span><br><span class=\"line\">      <span class=\"string\">Type=forking</span></span><br><span class=\"line\">      <span class=\"string\">ExecStart=/opt/appdynamics/platform/platform-admin/bin/platform-admin.sh</span> <span class=\"string\">start-platform-admin</span></span><br><span class=\"line\">      <span class=\"string\">ExecStop=/opt/appdynamics/platform/platform-admin/bin/platform-admin.sh</span> <span class=\"string\">stop-platform-admin</span></span><br><span class=\"line\">      <span class=\"string\">User=root</span></span><br><span class=\"line\">      <span class=\"string\">Restart=always</span></span><br><span class=\"line\"></span><br><span class=\"line\">      [<span class=\"string\">Install</span>]</span><br><span class=\"line\">      <span class=\"string\">WantedBy=multi-user.target</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">path:</span> <span class=\"string\">/etc/systemd/system/appd.console.install.service</span></span><br><span class=\"line\">    <span class=\"attr\">permissions:</span> <span class=\"string\">&#x27;0644&#x27;</span></span><br><span class=\"line\">    <span class=\"attr\">content:</span> <span class=\"string\">|</span></span><br><span class=\"line\"><span class=\"string\">      [Unit]</span></span><br><span class=\"line\"><span class=\"string\">      Description=AppDynamics Enterprise Console Installation</span></span><br><span class=\"line\"><span class=\"string\">      After=network.target</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\">      [<span class=\"string\">Service</span>]</span><br><span class=\"line\">      <span class=\"string\">Type=oneshot</span></span><br><span class=\"line\">      <span class=\"string\">RemainAfterExit=no</span></span><br><span class=\"line\">      <span class=\"string\">ExecStart=/bin/sh</span> <span class=\"string\">-c</span> <span class=\"string\">&#x27;sleep 5 &amp;&amp; cp /opt/appdynamics/response.varfile.bak /opt/appdynamics/response.varfile &amp;&amp; sed -i \\&quot;s/ENTER_PASSWORD/`curl http://169.254.169.254/latest/meta-data/instance-id`/g\\&quot; /opt/appdynamics/response.varfile &amp;&amp; sed -i \\&quot;s/HOST_NAME/`curl http://169.254.169.254/latest/meta-data/hostname`/g\\&quot; /opt/appdynamics/response.varfile &amp;&amp; /opt/appdynamics/platform-setup-x64-linux-23.1.1.18.sh -q -varfile /opt/appdynamics/response.varfile &amp;&amp; systemctl daemon-reload &amp;&amp; systemctl enable appd.console.service &amp;&amp; systemctl start appd.console.service&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">      [<span class=\"string\">Install</span>]</span><br><span class=\"line\">      <span class=\"string\">WantedBy=multi-user.target</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">runcmd:</span></span><br><span class=\"line\">  <span class=\"comment\"># Create directory and copy Cisco AppDynamics Enterprise Console setup file</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">aws</span> <span class=\"string\">s3</span> <span class=\"string\">cp</span> <span class=\"string\">s3://ciscoappdnx/platform-setup-x64-linux-23.1.1.18.sh</span> <span class=\"string\">/opt/appdynamics/</span> <span class=\"string\">--region</span> <span class=\"string\">cn-northwest-1</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">chmod</span> <span class=\"string\">+x</span> <span class=\"string\">/opt/appdynamics/platform-setup-x64-linux-23.1.1.18.sh</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">systemctl</span> <span class=\"string\">daemon-reload</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">systemctl</span> <span class=\"string\">enable</span> <span class=\"string\">appd.console.install.service</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">sed</span> <span class=\"string\">-i</span> <span class=\"string\">&#x27;s/#PermitRootLogin yes/PermitRootLogin no/g&#x27;</span> <span class=\"string\">/etc/ssh/sshd_config</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">rm</span> <span class=\"string\">-rf</span> <span class=\"string\">/root/.ssh/authorized_keys</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">rm</span> <span class=\"string\">-rf</span> <span class=\"string\">/home/ec2-user/.ssh/authorized_keys</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">shred</span> <span class=\"string\">-u</span> <span class=\"string\">/etc/ssh/*_key</span> <span class=\"string\">/etc/ssh/*_key.pub</span></span><br></pre></td></tr></table></figure>\n\n<p>将上述代码复制粘贴到创建EC2实例的 <strong>user-data</strong> 这一栏中，即可完成软件的拷贝和开机脚本的生成。</p>\n<p>上述的代码是经过多次调测才形成的，其中有两处要注意：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1. aws s3 <span class=\"built_in\">cp</span> 命令，在最后要加上 **‘region’** 参数，否则会报fatal error: An error occurred (400) when calling the HeadObject operation: Bad Request。这一点ChatGPT没有注意到，需要提醒它，当然它学的很快。</span><br><span class=\"line\">2. ExecStart=/bin/sh -c <span class=\"string\">&#x27;sleep 5 &amp;&amp; cp /opt/appdynamics/response.varfile.bak /opt/appdynamics/response.varfile &amp;&amp; sed -i \\&quot;s/ENTER_PASSWORD/`curl http://169.254.169.254/latest/meta-data/instance-id`/g\\&quot; /opt/appdynamics/response.varfile &amp;&amp; sed -i \\&quot;s/HOST_NAME/`curl http://169.254.169.254/latest/meta-data/hostname`/g\\&quot; /opt/appdynamics/response.varfile &amp;&amp; /opt/appdynamics/platform-setup-x64-linux-23.1.1.18.sh -q -varfile /opt/appdynamics/response.varfile &amp;&amp; systemctl daemon-reload &amp;&amp; systemctl enable appd.console.service &amp;&amp; systemctl start appd.console.service&#x27;</span></span><br><span class=\"line\">这条命令是很复杂的，一个命令一个命令串行执行，其中还包括了转义字符，如果不是ChatGPT生成，我个人很难完成这个命令。该命令顺序执行以下内容，只有前面的命令执行成功，才会继续执行下一条命令：</span><br><span class=\"line\">    1. 等待5秒钟再启动，主要是让EC2的网络和其他关联服务充分就绪；</span><br><span class=\"line\">    2. 将response.varfile.bak拷贝至response.varfile</span><br><span class=\"line\">    3. 使用sed命令将ENTER_PASSWORD替换为instance-id，instance-id由curl命令获取，更新response.varfile</span><br><span class=\"line\">    4. 使用sed命令将HOST_NAME替换为hostname，hostname由curl命令获取，更新response.varfile</span><br><span class=\"line\">    5. 执行静默安装脚本，经测算安装需要大约10分钟</span><br><span class=\"line\">    6. 重新加载systemd，并创建appd.console.service</span><br><span class=\"line\">    7. 最后是执行appd.console.service启动Console Service</span><br></pre></td></tr></table></figure>\n<p>通过SSM连接到EC2实例（注意设置EC2的IAM Role，具备SSM和S3的访问权限），通过以下命令进行调测。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">sudo</span> su</span><br><span class=\"line\"><span class=\"built_in\">cd</span> /opt/appdynamics</span><br><span class=\"line\"><span class=\"built_in\">ls</span> -al</span><br><span class=\"line\"><span class=\"comment\"># 查看platform-setup-x64-linux-23.1.1.18.sh 和 response.varfile.bak是否存在，</span></span><br><span class=\"line\"><span class=\"comment\"># 且安装包是否被设置为可执行</span></span><br><span class=\"line\"><span class=\"built_in\">cat</span> /etc/security/limits.conf</span><br><span class=\"line\"><span class=\"built_in\">cat</span> /etc/systemd/system/appd.console.service</span><br><span class=\"line\"><span class=\"built_in\">cat</span> /etc/systemd/system/appd.console.install.service</span><br><span class=\"line\"><span class=\"built_in\">cat</span> /etc/ssh/sshd_config | grep PermitRootLogin</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">ls</span> -al /etc/ssh</span><br><span class=\"line\"><span class=\"built_in\">ls</span> -al /root/.ssh</span><br><span class=\"line\"><span class=\"built_in\">ls</span> -al /home/ec2-user/.ssh</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">cat</span> /var/log/cloud-init-output.log</span><br><span class=\"line\"><span class=\"comment\"># 检查是否有错误发生</span></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"在AWS上制作安装镜像AMI文件\"><a href=\"#在AWS上制作安装镜像AMI文件\" class=\"headerlink\" title=\"在AWS上制作安装镜像AMI文件\"></a>在AWS上制作安装镜像AMI文件</h1><h2 id=\"创建一个EC2实例\"><a href=\"#创建一个EC2实例\" class=\"headerlink\" title=\"创建一个EC2实例\"></a>创建一个EC2实例</h2><p>前提条件：VPC、公有子网均已设置好。</p>\n<p>以下是操作步骤截图及相关说明</p>\n<p><strong>1、在EC2服务界面中点击Launch instance</strong></p>\n<p><img src=\"/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-vv3.png\" alt=\"SCR-20230301-vv3.png\"></p>\n<p><strong>2、填写EC2实例的Name，选择Amazon Linux</strong></p>\n<p><img src=\"/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-vxg.png\" alt=\"SCR-20230301-vxg.png\"></p>\n<p><strong>3、选择实例类型c5.xlarge，不需要Key pair，选择公有子网，并自动分配公网IP地址。</strong></p>\n<p><img src=\"/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-vz3.png\" alt=\"SCR-20230301-vz3.png\"></p>\n<p><strong>4、设置Security Group ，设置磁盘大小500G</strong></p>\n<p><img src=\"/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-w1t.png\" alt=\"SCR-20230301-w1t.png\"></p>\n<p><strong>Security Group的设置如下</strong></p>\n<p><img src=\"/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-w1c.png\" alt=\"SCR-20230301-w1c.png\"></p>\n<p><strong>5、分配IAM 角色</strong></p>\n<p><img src=\"/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-w6k.png\" alt=\"SCR-20230301-w6k.png\"></p>\n<p><strong>IAM角色具体设置如下，设置SSM权限和S3的访问权限</strong></p>\n<p><img src=\"/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-w8d.png\" alt=\"SCR-20230301-w8d.png\"></p>\n<p><strong>6、将上述cloud-init 代码输入user-data中，并点击 Launch instance</strong></p>\n<p><img src=\"/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-wa6.png\" alt=\"SCR-20230301-wa6.png\"></p>\n<h2 id=\"检查EC2实例的设置\"><a href=\"#检查EC2实例的设置\" class=\"headerlink\" title=\"检查EC2实例的设置\"></a>检查EC2实例的设置</h2><p><strong>1、通过SSM连接EC2实例，如果未设置SSM的权限，则不能使用该方式管理EC2</strong></p>\n<p><img src=\"/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-wdb.png\" alt=\"SCR-20230301-wdb.png\"></p>\n<p><img src=\"/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-wgi.png\" alt=\"SCR-20230301-wgi.png\"></p>\n<p><strong>2、执行命令检查EC2的设置是否符合预期</strong></p>\n<p><img src=\"/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-wi7.png\" alt=\"SCR-20230301-wi7.png\"></p>\n<p><img src=\"/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-wle.png\" alt=\"SCR-20230301-wle.png\"></p>\n<p>以下是文本格式的输出：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@ip-172-31-13-10 appdynamics]# <span class=\"built_in\">cat</span> /etc/security/limits.conf</span><br><span class=\"line\">root hard nofile 65535</span><br><span class=\"line\">root soft nofile 65535</span><br><span class=\"line\">root hard <span class=\"built_in\">nproc</span> 8192</span><br><span class=\"line\">root soft <span class=\"built_in\">nproc</span> 8192</span><br><span class=\"line\"></span><br><span class=\"line\">[root@ip-172-31-13-10 appdynamics]# <span class=\"built_in\">cat</span> /etc/systemd/system/appd.console.service</span><br><span class=\"line\">[Unit]</span><br><span class=\"line\">Description=AppDynamics Enterprise Console</span><br><span class=\"line\">After=network.target</span><br><span class=\"line\"></span><br><span class=\"line\">[Service]</span><br><span class=\"line\">Type=forking</span><br><span class=\"line\">ExecStart=/opt/appdynamics/platform/platform-admin/bin/platform-admin.sh start-platform-admin</span><br><span class=\"line\">ExecStop=/opt/appdynamics/platform/platform-admin/bin/platform-admin.sh stop-platform-admin</span><br><span class=\"line\">User=root</span><br><span class=\"line\">Restart=always</span><br><span class=\"line\"></span><br><span class=\"line\">[Install]</span><br><span class=\"line\">WantedBy=multi-user.target</span><br><span class=\"line\"></span><br><span class=\"line\">[root@ip-172-31-13-10 appdynamics]# <span class=\"built_in\">cat</span> /etc/systemd/system/appd.console.install.service</span><br><span class=\"line\">[Unit]</span><br><span class=\"line\">Description=AppDynamics Enterprise Console Installation</span><br><span class=\"line\">After=network.target</span><br><span class=\"line\"></span><br><span class=\"line\">[Service]</span><br><span class=\"line\">Type=oneshot</span><br><span class=\"line\">RemainAfterExit=no</span><br><span class=\"line\">ExecStart=/bin/sh -c <span class=\"string\">&#x27;sleep 5 &amp;&amp; cp /opt/appdynamics/response.varfile.bak /opt/appdynamics/response.varfile &amp;&amp; sed -i \\&quot;s/ENTER_PASSWORD/`curl http://169.254.169.254/latest/meta-data/instance-id`/g\\&quot; /opt/appdynamics/response.varfile &amp;&amp; sed -i \\&quot;s/HOST_NAME/`curl http://169.254.169.254/latest/meta-data/hostname`/g\\&quot; /opt/appdynamics/response.varfile &amp;&amp; /opt/appdynamics/platform-setup-x64-linux-23.1.1.18.sh -q -varfile/opt/appdynamics/response.varfile &amp;&amp; systemctl daemon-reload &amp;&amp; systemctl enable appd.console.service &amp;&amp; systemctl start appd.console.service&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">[Install]</span><br><span class=\"line\">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>\n\n<p><strong>可以看出是符合预期的，执行 history -c 清除历史记录。</strong></p>\n<h2 id=\"生成AMI镜像\"><a href=\"#生成AMI镜像\" class=\"headerlink\" title=\"生成AMI镜像\"></a>生成AMI镜像</h2><p><strong>1、将该EC2关机</strong></p>\n<p><img src=\"/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-wn8.png\" alt=\"SCR-20230301-wn8.png\"></p>\n<p><strong>2、确认关机后，点击制作Image</strong></p>\n<p><img src=\"/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-wob.png\" alt=\"SCR-20230301-wob.png\"></p>\n<p><strong>3、填入Image的参数，点击Create Image</strong></p>\n<p><img src=\"/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-wzx.png\" alt=\"SCR-20230301-wzx.png\"></p>\n<h1 id=\"验证AMI\"><a href=\"#验证AMI\" class=\"headerlink\" title=\"验证AMI\"></a>验证AMI</h1><h2 id=\"使用AMI启动EC2实例\"><a href=\"#使用AMI启动EC2实例\" class=\"headerlink\" title=\"使用AMI启动EC2实例\"></a>使用AMI启动EC2实例</h2><p><strong>1、等待AMI状态变Available后，点击Launch instance from AMI</strong></p>\n<p><img src=\"/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-x5q.png\" alt=\"SCR-20230301-x5q.png\"></p>\n<p><strong>2、进入EC2启动的设置页面，进行必要的设置</strong></p>\n<p><img src=\"/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-x8g.png\" alt=\"SCR-20230301-x8g.png\"></p>\n<p><strong>除了user-data维持空白，其他设置可与创建AMI的EC2一致。</strong></p>\n<p><strong>3、EC2创建后，转到EC2的信息页面</strong></p>\n<p><img src=\"/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230302-8x.png\" alt=\"SCR-20230302-8x.png\"></p>\n<p><strong>4、测试Enterprise Console的Web界面</strong></p>\n<p>大概10分钟后，可以通过以下地址访问</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http://ec2-69-230-211-253.cn-northwest-1.compute.amazonaws.com.cn/:9191</span><br><span class=\"line\">username: admin</span><br><span class=\"line\">password: 从信息页面中拷贝instance-id，如上图为i-06b75d367808d02af</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230302-a8.png\" alt=\"SCR-20230302-a8.png\"></p>\n<p><img src=\"/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230302-b8.png\" alt=\"SCR-20230302-b8.png\"></p>\n<p><strong>5、使用SSM连接EC2，检查相关服务是否正常</strong></p>\n<p><img src=\"/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230302-du.png\" alt=\"SCR-20230302-du.png\"></p>\n<h1 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h1><p>本文整理了在AWS上制作AppDynamics的AMI镜像的过程，笔者使用了ChatGPT帮助生成自动化脚本，极大的提高了效率。<br>本文中的cloud-init代码已发布到Github，如下：</p>\n<p><a href=\"https://github.com/weiborao/appd-console-install-cloud-init/blob/main/appd-install-cloud-init-CN.yaml\">https://github.com/weiborao/appd-console-install-cloud-init/blob/main/appd-install-cloud-init-CN.yaml</a></p>\n<p>非常感谢各位耐心的阅读，</p>\n","length":3019,"excerpt":"<p>作者: 饶维波</p>\n<p>本文记录通过ChatGPT生成cloud-init制作AppDynamics在AWS上 AMI安装镜像的过程，形成操作文档作为参考指南。</p>\n<h1 id=\"任务简介和总体思路\"><a href=\"#任务简介和总体思路\" class=\"headerlink\" title=\"任务简介和总体思路\"></a>任务简介和总体思路</h1><h2 id=\"任务简介\"><a href=\"#任务简介\" class=\"headerlink\" title=\"任务简介\"></a>任务简介</h2><p>Cisco AppDynamics 提供功能强大、易于使用的应用程序性能管理（APM）解决方案，端到端监控亚马逊云的应用程序，包括微服务和 Docker，通过 CloudWatch 集成为 EC2、DynamoDB、Lambda 等提供支持。AppDynamics可比较和验证云迁移前后的从客户到业务的优化，从而加速客户上云，因而深受用户喜爱。</p>\n<p>为了提升用户在亚马逊云科技云端安装部署AppDynamics软件的效率，我们需要制作一个打包好的安装镜像，叫做Amazon Machine Images (AMI)。用户使用AMI镜像启动虚拟机即可进入AppDynamics的设置界面，这能帮助用户节省大量软件下载、安装调试的时间，极大改善用户的安装体验。</p>\n<p>本次任务的目标是需要完成AppDynamics AMI的制作，且为了便于后续维护，维护的工作主要包括操作系统层面的安全漏洞修复、AppDynamics软件版本的升级，尽量使用自动化，节省人的时间精力的同时，避免人为错误。</p>\n<p>任务关键点是需要编写一个自动化脚本，考虑为Shell脚本或者cloud-init脚本。</p>","more":"<h2 id=\"总体思路\"><a href=\"#总体思路\" class=\"headerlink\" title=\"总体思路\"></a>总体思路</h2><p>首先需要考虑安装镜像的目标状态是什么？我们设想用户通过镜像创建EC2虚拟机实例，可以直接进入Enterprise Console的界面，并已预设了用户名密码。</p>\n<p>那我们可否启动一个EC2实例，并且在上面完成Enterprise Console的安装，然后生成快照做成AMI镜像？咨询了一下安装过AppDynamics的同事，他表示他宁愿选择重新安装，因为每个用户的需求是不同的。因此，我们只需要把需要安装的软件包下载到EC2实例，并设置好安装参数，等用户对AMI镜像进行实例化（基于AMI创建虚拟机）时，再进行Enterprise Console的安装。</p>\n<p>AWS对于AMI镜像有要求，即不允许使用静态设定的密码，建议使用EC2的instance-id作为密码。</p>\n<p>那么，我们的任务就基本清晰了，以下是任务清单</p>\n<ol>\n<li>启动EC2实例，安装所需要的依赖包，以确保AppDynamics软件包能正常安装</li>\n<li>设置用户权限</li>\n<li>将AppDynamics的软件包拷贝到EC2实例</li>\n<li>生成默认的安装参数，并设置系统启动脚本，该脚本只执行一次，在AMI实例化时执行安装，并启动Enterprise Console</li>\n<li>按照AWS的安全合规要求进行处理，包括设置SSH参数，清除SSH Key，不留后门等要求。</li>\n<li>关机后，基于EC2实例的快照制作镜像</li>\n<li>最后是对镜像进行验证</li>\n</ol>\n<p>上面最关键的点是自动化脚本的编写，在这里，笔者使用ChatGPT来辅助生成代码。</p>\n<h1 id=\"通过与ChatGPT对话，让其生成代码\"><a href=\"#通过与ChatGPT对话，让其生成代码\" class=\"headerlink\" title=\"通过与ChatGPT对话，让其生成代码\"></a>通过与ChatGPT对话，让其生成代码</h1><h2 id=\"与ChatGPT的对话\"><a href=\"#与ChatGPT的对话\" class=\"headerlink\" title=\"与ChatGPT的对话\"></a>与ChatGPT的对话</h2><p><strong>经多次对话后，整理内容如下：</strong></p>\n<p>请你帮助生成一个Cloud-init代码，自动执行以下内容。</p>\n<p>在AWS Console启动AWS Linux 2 AMI，并在启动时执行以下动作：<br>1、安装libaio, numactl, tzdata, ncurses-libs-5.x<br>2、在&#x2F;etc&#x2F;security&#x2F;limits.conf 中添加以下配置</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">root hard nofile 65535</span><br><span class=\"line\">root soft nofile 65535</span><br><span class=\"line\">root hard <span class=\"built_in\">nproc</span> 8192</span><br><span class=\"line\">root soft <span class=\"built_in\">nproc</span> 8192</span><br></pre></td></tr></table></figure>\n\n<p>3、你已经会安装Cisco AppDynamics Enterprise Console 21.6.1版本，现在我将安装文件拷贝到了s3:&#x2F;&#x2F;ciscoappd&#x2F;platform-setup-x64-linux-21.6.1.26487.sh。请创建&#x2F;opt&#x2F;appdynamics目录，将Cisco AppDynamics Enterprise Console的安装文件s3:&#x2F;&#x2F;ciscoappd&#x2F;platform-setup-x64-linux-21.6.1.26487.sh拷贝至该目录，并将其设置为可执行；<br>4、在&#x2F;opt&#x2F;appdynamics目录，生成初始文件response.varfile.bak，内容如下：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">serverHostName=HOST_NAME</span><br><span class=\"line\">sys.languageId=en</span><br><span class=\"line\">disableEULA=<span class=\"literal\">true</span></span><br><span class=\"line\">platformAdmin.port=9191</span><br><span class=\"line\">platformAdmin.databasePort=3377</span><br><span class=\"line\">platformAdmin.dataDir=/opt/appdynamics/platform/mysql/data</span><br><span class=\"line\">platformAdmin.databasePassword=ENTER_PASSWORD</span><br><span class=\"line\">platformAdmin.databaseRootPassword=ENTER_PASSWORD</span><br><span class=\"line\">platformAdmin.adminPassword=ENTER_PASSWORD</span><br><span class=\"line\">platformAdmin.useHttps<span class=\"variable\">$Boolean</span>=<span class=\"literal\">false</span></span><br><span class=\"line\">sys.installationDir=/opt/appdynamics/platform</span><br></pre></td></tr></table></figure>\n\n<p>上面的工作完成之后，再执行以下工作。</p>\n<p>5、请生成一个开机启动脚本，要求如下：<br>5.1 该脚本不在本EC2实例中执行，将其设置为开机后延迟30秒之后再执行，脚本仅需执行一次；<br>5.2 将&#x2F;opt&#x2F;appdynamics&#x2F;response.varfile.bak 复制为 opt&#x2F;appdynamics&#x2F;response.varfile<br>5.2 将&#x2F;opt&#x2F;appdynamics&#x2F;response.varfile中的ENTER_PASSWORD替换为EC2 meta-data中的instance-id<br>5.3 将&#x2F;opt&#x2F;appdynamics&#x2F;response.varfile中的HOST_NAME设置为EC2 meta-data中的hostname<br>5.4 静默安装Enterprise Console &#x2F;opt&#x2F;appdynamics&#x2F;platform-setup-x64-linux-21.6.1.26487.sh -q -varfile &#x2F;opt&#x2F;appdynamics&#x2F;response.varfile</p>\n<p><strong>一些对话经验：</strong></p>\n<ul>\n<li>ChatGPT所掌握的数据截止到2021年9月，比如您问他卡塔尔世界杯的结果，他是不知道的。在经过多次与ChatGPT对话，它告诉我他能安装的AppDynamics最新版本是21.6.1，如果我请它直接安装23.1.1.18，它给出的代码有误。于是我请它按照21.6.1版本来安装，在上面的对话中可以看出有这部分的内容。</li>\n<li>如果一次提问的需求过于复杂，它在生成代码时，会因意外中断，因此，要注意控制一次对话的长度和问题的复杂度。上面列出的对话内容是多次对话整理出来的。</li>\n<li>如果它理解不对，可以直接指正它，吧需求提的更具体，比如请使用‘write_files’和‘runcmd’生成代码。如果不加限制，它可能会给出整段代码全部都用 echo 语句来实现，相比结构化的代码，不易理解。</li>\n</ul>\n<h2 id=\"生成的cloud-init代码\"><a href=\"#生成的cloud-init代码\" class=\"headerlink\" title=\"生成的cloud-init代码\"></a>生成的cloud-init代码</h2><p>通过继续追问，让其帮忙生成Systemd的服务配置文件，要求只运行一次，再经过多次调试和修改，最终形成以下cloud-init代码。</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#cloud-config</span></span><br><span class=\"line\"><span class=\"attr\">packages:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">libaio</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">numactl</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">tzdata</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">ncurses-libs-5.x</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">write_files:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">path:</span> <span class=\"string\">/etc/security/limits.conf</span></span><br><span class=\"line\">    <span class=\"attr\">content:</span> <span class=\"string\">|</span></span><br><span class=\"line\"><span class=\"string\">      root hard nofile 65535</span></span><br><span class=\"line\"><span class=\"string\">      root soft nofile 65535</span></span><br><span class=\"line\"><span class=\"string\">      root hard nproc 8192</span></span><br><span class=\"line\"><span class=\"string\">      root soft nproc 8192</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">path:</span> <span class=\"string\">/opt/appdynamics/response.varfile.bak</span></span><br><span class=\"line\">    <span class=\"attr\">content:</span> <span class=\"string\">|</span></span><br><span class=\"line\"><span class=\"string\">      serverHostName=HOST_NAME</span></span><br><span class=\"line\"><span class=\"string\">      sys.languageId=en</span></span><br><span class=\"line\"><span class=\"string\">      disableEULA=true</span></span><br><span class=\"line\"><span class=\"string\">      platformAdmin.port=9191</span></span><br><span class=\"line\"><span class=\"string\">      platformAdmin.databasePort=3377</span></span><br><span class=\"line\"><span class=\"string\">      platformAdmin.dataDir=/opt/appdynamics/platform/mysql/data</span></span><br><span class=\"line\"><span class=\"string\">      platformAdmin.databasePassword=ENTER_PASSWORD</span></span><br><span class=\"line\"><span class=\"string\">      platformAdmin.databaseRootPassword=ENTER_PASSWORD</span></span><br><span class=\"line\"><span class=\"string\">      platformAdmin.adminPassword=ENTER_PASSWORD</span></span><br><span class=\"line\"><span class=\"string\">      platformAdmin.useHttps$Boolean=false</span></span><br><span class=\"line\"><span class=\"string\">      sys.installationDir=/opt/appdynamics/platform</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">path:</span> <span class=\"string\">/etc/systemd/system/appd.console.service</span></span><br><span class=\"line\">    <span class=\"attr\">permissions:</span> <span class=\"string\">&#x27;0644&#x27;</span></span><br><span class=\"line\">    <span class=\"attr\">content:</span> <span class=\"string\">|</span></span><br><span class=\"line\"><span class=\"string\">      [Unit]</span></span><br><span class=\"line\"><span class=\"string\">      Description=AppDynamics Enterprise Console</span></span><br><span class=\"line\"><span class=\"string\">      After=network.target</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\">      [<span class=\"string\">Service</span>]</span><br><span class=\"line\">      <span class=\"string\">Type=forking</span></span><br><span class=\"line\">      <span class=\"string\">ExecStart=/opt/appdynamics/platform/platform-admin/bin/platform-admin.sh</span> <span class=\"string\">start-platform-admin</span></span><br><span class=\"line\">      <span class=\"string\">ExecStop=/opt/appdynamics/platform/platform-admin/bin/platform-admin.sh</span> <span class=\"string\">stop-platform-admin</span></span><br><span class=\"line\">      <span class=\"string\">User=root</span></span><br><span class=\"line\">      <span class=\"string\">Restart=always</span></span><br><span class=\"line\"></span><br><span class=\"line\">      [<span class=\"string\">Install</span>]</span><br><span class=\"line\">      <span class=\"string\">WantedBy=multi-user.target</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">path:</span> <span class=\"string\">/etc/systemd/system/appd.console.install.service</span></span><br><span class=\"line\">    <span class=\"attr\">permissions:</span> <span class=\"string\">&#x27;0644&#x27;</span></span><br><span class=\"line\">    <span class=\"attr\">content:</span> <span class=\"string\">|</span></span><br><span class=\"line\"><span class=\"string\">      [Unit]</span></span><br><span class=\"line\"><span class=\"string\">      Description=AppDynamics Enterprise Console Installation</span></span><br><span class=\"line\"><span class=\"string\">      After=network.target</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\">      [<span class=\"string\">Service</span>]</span><br><span class=\"line\">      <span class=\"string\">Type=oneshot</span></span><br><span class=\"line\">      <span class=\"string\">RemainAfterExit=no</span></span><br><span class=\"line\">      <span class=\"string\">ExecStart=/bin/sh</span> <span class=\"string\">-c</span> <span class=\"string\">&#x27;sleep 5 &amp;&amp; cp /opt/appdynamics/response.varfile.bak /opt/appdynamics/response.varfile &amp;&amp; sed -i \\&quot;s/ENTER_PASSWORD/`curl http://169.254.169.254/latest/meta-data/instance-id`/g\\&quot; /opt/appdynamics/response.varfile &amp;&amp; sed -i \\&quot;s/HOST_NAME/`curl http://169.254.169.254/latest/meta-data/hostname`/g\\&quot; /opt/appdynamics/response.varfile &amp;&amp; /opt/appdynamics/platform-setup-x64-linux-23.1.1.18.sh -q -varfile /opt/appdynamics/response.varfile &amp;&amp; systemctl daemon-reload &amp;&amp; systemctl enable appd.console.service &amp;&amp; systemctl start appd.console.service&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">      [<span class=\"string\">Install</span>]</span><br><span class=\"line\">      <span class=\"string\">WantedBy=multi-user.target</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">runcmd:</span></span><br><span class=\"line\">  <span class=\"comment\"># Create directory and copy Cisco AppDynamics Enterprise Console setup file</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">aws</span> <span class=\"string\">s3</span> <span class=\"string\">cp</span> <span class=\"string\">s3://ciscoappdnx/platform-setup-x64-linux-23.1.1.18.sh</span> <span class=\"string\">/opt/appdynamics/</span> <span class=\"string\">--region</span> <span class=\"string\">cn-northwest-1</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">chmod</span> <span class=\"string\">+x</span> <span class=\"string\">/opt/appdynamics/platform-setup-x64-linux-23.1.1.18.sh</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">systemctl</span> <span class=\"string\">daemon-reload</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">systemctl</span> <span class=\"string\">enable</span> <span class=\"string\">appd.console.install.service</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">sed</span> <span class=\"string\">-i</span> <span class=\"string\">&#x27;s/#PermitRootLogin yes/PermitRootLogin no/g&#x27;</span> <span class=\"string\">/etc/ssh/sshd_config</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">rm</span> <span class=\"string\">-rf</span> <span class=\"string\">/root/.ssh/authorized_keys</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">rm</span> <span class=\"string\">-rf</span> <span class=\"string\">/home/ec2-user/.ssh/authorized_keys</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">shred</span> <span class=\"string\">-u</span> <span class=\"string\">/etc/ssh/*_key</span> <span class=\"string\">/etc/ssh/*_key.pub</span></span><br></pre></td></tr></table></figure>\n\n<p>将上述代码复制粘贴到创建EC2实例的 <strong>user-data</strong> 这一栏中，即可完成软件的拷贝和开机脚本的生成。</p>\n<p>上述的代码是经过多次调测才形成的，其中有两处要注意：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1. aws s3 <span class=\"built_in\">cp</span> 命令，在最后要加上 **‘region’** 参数，否则会报fatal error: An error occurred (400) when calling the HeadObject operation: Bad Request。这一点ChatGPT没有注意到，需要提醒它，当然它学的很快。</span><br><span class=\"line\">2. ExecStart=/bin/sh -c <span class=\"string\">&#x27;sleep 5 &amp;&amp; cp /opt/appdynamics/response.varfile.bak /opt/appdynamics/response.varfile &amp;&amp; sed -i \\&quot;s/ENTER_PASSWORD/`curl http://169.254.169.254/latest/meta-data/instance-id`/g\\&quot; /opt/appdynamics/response.varfile &amp;&amp; sed -i \\&quot;s/HOST_NAME/`curl http://169.254.169.254/latest/meta-data/hostname`/g\\&quot; /opt/appdynamics/response.varfile &amp;&amp; /opt/appdynamics/platform-setup-x64-linux-23.1.1.18.sh -q -varfile /opt/appdynamics/response.varfile &amp;&amp; systemctl daemon-reload &amp;&amp; systemctl enable appd.console.service &amp;&amp; systemctl start appd.console.service&#x27;</span></span><br><span class=\"line\">这条命令是很复杂的，一个命令一个命令串行执行，其中还包括了转义字符，如果不是ChatGPT生成，我个人很难完成这个命令。该命令顺序执行以下内容，只有前面的命令执行成功，才会继续执行下一条命令：</span><br><span class=\"line\">    1. 等待5秒钟再启动，主要是让EC2的网络和其他关联服务充分就绪；</span><br><span class=\"line\">    2. 将response.varfile.bak拷贝至response.varfile</span><br><span class=\"line\">    3. 使用sed命令将ENTER_PASSWORD替换为instance-id，instance-id由curl命令获取，更新response.varfile</span><br><span class=\"line\">    4. 使用sed命令将HOST_NAME替换为hostname，hostname由curl命令获取，更新response.varfile</span><br><span class=\"line\">    5. 执行静默安装脚本，经测算安装需要大约10分钟</span><br><span class=\"line\">    6. 重新加载systemd，并创建appd.console.service</span><br><span class=\"line\">    7. 最后是执行appd.console.service启动Console Service</span><br></pre></td></tr></table></figure>\n<p>通过SSM连接到EC2实例（注意设置EC2的IAM Role，具备SSM和S3的访问权限），通过以下命令进行调测。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">sudo</span> su</span><br><span class=\"line\"><span class=\"built_in\">cd</span> /opt/appdynamics</span><br><span class=\"line\"><span class=\"built_in\">ls</span> -al</span><br><span class=\"line\"><span class=\"comment\"># 查看platform-setup-x64-linux-23.1.1.18.sh 和 response.varfile.bak是否存在，</span></span><br><span class=\"line\"><span class=\"comment\"># 且安装包是否被设置为可执行</span></span><br><span class=\"line\"><span class=\"built_in\">cat</span> /etc/security/limits.conf</span><br><span class=\"line\"><span class=\"built_in\">cat</span> /etc/systemd/system/appd.console.service</span><br><span class=\"line\"><span class=\"built_in\">cat</span> /etc/systemd/system/appd.console.install.service</span><br><span class=\"line\"><span class=\"built_in\">cat</span> /etc/ssh/sshd_config | grep PermitRootLogin</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">ls</span> -al /etc/ssh</span><br><span class=\"line\"><span class=\"built_in\">ls</span> -al /root/.ssh</span><br><span class=\"line\"><span class=\"built_in\">ls</span> -al /home/ec2-user/.ssh</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">cat</span> /var/log/cloud-init-output.log</span><br><span class=\"line\"><span class=\"comment\"># 检查是否有错误发生</span></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"在AWS上制作安装镜像AMI文件\"><a href=\"#在AWS上制作安装镜像AMI文件\" class=\"headerlink\" title=\"在AWS上制作安装镜像AMI文件\"></a>在AWS上制作安装镜像AMI文件</h1><h2 id=\"创建一个EC2实例\"><a href=\"#创建一个EC2实例\" class=\"headerlink\" title=\"创建一个EC2实例\"></a>创建一个EC2实例</h2><p>前提条件：VPC、公有子网均已设置好。</p>\n<p>以下是操作步骤截图及相关说明</p>\n<p><strong>1、在EC2服务界面中点击Launch instance</strong></p>\n<p><img src=\"/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-vv3.png\" alt=\"SCR-20230301-vv3.png\"></p>\n<p><strong>2、填写EC2实例的Name，选择Amazon Linux</strong></p>\n<p><img src=\"/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-vxg.png\" alt=\"SCR-20230301-vxg.png\"></p>\n<p><strong>3、选择实例类型c5.xlarge，不需要Key pair，选择公有子网，并自动分配公网IP地址。</strong></p>\n<p><img src=\"/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-vz3.png\" alt=\"SCR-20230301-vz3.png\"></p>\n<p><strong>4、设置Security Group ，设置磁盘大小500G</strong></p>\n<p><img src=\"/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-w1t.png\" alt=\"SCR-20230301-w1t.png\"></p>\n<p><strong>Security Group的设置如下</strong></p>\n<p><img src=\"/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-w1c.png\" alt=\"SCR-20230301-w1c.png\"></p>\n<p><strong>5、分配IAM 角色</strong></p>\n<p><img src=\"/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-w6k.png\" alt=\"SCR-20230301-w6k.png\"></p>\n<p><strong>IAM角色具体设置如下，设置SSM权限和S3的访问权限</strong></p>\n<p><img src=\"/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-w8d.png\" alt=\"SCR-20230301-w8d.png\"></p>\n<p><strong>6、将上述cloud-init 代码输入user-data中，并点击 Launch instance</strong></p>\n<p><img src=\"/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-wa6.png\" alt=\"SCR-20230301-wa6.png\"></p>\n<h2 id=\"检查EC2实例的设置\"><a href=\"#检查EC2实例的设置\" class=\"headerlink\" title=\"检查EC2实例的设置\"></a>检查EC2实例的设置</h2><p><strong>1、通过SSM连接EC2实例，如果未设置SSM的权限，则不能使用该方式管理EC2</strong></p>\n<p><img src=\"/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-wdb.png\" alt=\"SCR-20230301-wdb.png\"></p>\n<p><img src=\"/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-wgi.png\" alt=\"SCR-20230301-wgi.png\"></p>\n<p><strong>2、执行命令检查EC2的设置是否符合预期</strong></p>\n<p><img src=\"/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-wi7.png\" alt=\"SCR-20230301-wi7.png\"></p>\n<p><img src=\"/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-wle.png\" alt=\"SCR-20230301-wle.png\"></p>\n<p>以下是文本格式的输出：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@ip-172-31-13-10 appdynamics]# <span class=\"built_in\">cat</span> /etc/security/limits.conf</span><br><span class=\"line\">root hard nofile 65535</span><br><span class=\"line\">root soft nofile 65535</span><br><span class=\"line\">root hard <span class=\"built_in\">nproc</span> 8192</span><br><span class=\"line\">root soft <span class=\"built_in\">nproc</span> 8192</span><br><span class=\"line\"></span><br><span class=\"line\">[root@ip-172-31-13-10 appdynamics]# <span class=\"built_in\">cat</span> /etc/systemd/system/appd.console.service</span><br><span class=\"line\">[Unit]</span><br><span class=\"line\">Description=AppDynamics Enterprise Console</span><br><span class=\"line\">After=network.target</span><br><span class=\"line\"></span><br><span class=\"line\">[Service]</span><br><span class=\"line\">Type=forking</span><br><span class=\"line\">ExecStart=/opt/appdynamics/platform/platform-admin/bin/platform-admin.sh start-platform-admin</span><br><span class=\"line\">ExecStop=/opt/appdynamics/platform/platform-admin/bin/platform-admin.sh stop-platform-admin</span><br><span class=\"line\">User=root</span><br><span class=\"line\">Restart=always</span><br><span class=\"line\"></span><br><span class=\"line\">[Install]</span><br><span class=\"line\">WantedBy=multi-user.target</span><br><span class=\"line\"></span><br><span class=\"line\">[root@ip-172-31-13-10 appdynamics]# <span class=\"built_in\">cat</span> /etc/systemd/system/appd.console.install.service</span><br><span class=\"line\">[Unit]</span><br><span class=\"line\">Description=AppDynamics Enterprise Console Installation</span><br><span class=\"line\">After=network.target</span><br><span class=\"line\"></span><br><span class=\"line\">[Service]</span><br><span class=\"line\">Type=oneshot</span><br><span class=\"line\">RemainAfterExit=no</span><br><span class=\"line\">ExecStart=/bin/sh -c <span class=\"string\">&#x27;sleep 5 &amp;&amp; cp /opt/appdynamics/response.varfile.bak /opt/appdynamics/response.varfile &amp;&amp; sed -i \\&quot;s/ENTER_PASSWORD/`curl http://169.254.169.254/latest/meta-data/instance-id`/g\\&quot; /opt/appdynamics/response.varfile &amp;&amp; sed -i \\&quot;s/HOST_NAME/`curl http://169.254.169.254/latest/meta-data/hostname`/g\\&quot; /opt/appdynamics/response.varfile &amp;&amp; /opt/appdynamics/platform-setup-x64-linux-23.1.1.18.sh -q -varfile/opt/appdynamics/response.varfile &amp;&amp; systemctl daemon-reload &amp;&amp; systemctl enable appd.console.service &amp;&amp; systemctl start appd.console.service&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">[Install]</span><br><span class=\"line\">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>\n\n<p><strong>可以看出是符合预期的，执行 history -c 清除历史记录。</strong></p>\n<h2 id=\"生成AMI镜像\"><a href=\"#生成AMI镜像\" class=\"headerlink\" title=\"生成AMI镜像\"></a>生成AMI镜像</h2><p><strong>1、将该EC2关机</strong></p>\n<p><img src=\"/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-wn8.png\" alt=\"SCR-20230301-wn8.png\"></p>\n<p><strong>2、确认关机后，点击制作Image</strong></p>\n<p><img src=\"/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-wob.png\" alt=\"SCR-20230301-wob.png\"></p>\n<p><strong>3、填入Image的参数，点击Create Image</strong></p>\n<p><img src=\"/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-wzx.png\" alt=\"SCR-20230301-wzx.png\"></p>\n<h1 id=\"验证AMI\"><a href=\"#验证AMI\" class=\"headerlink\" title=\"验证AMI\"></a>验证AMI</h1><h2 id=\"使用AMI启动EC2实例\"><a href=\"#使用AMI启动EC2实例\" class=\"headerlink\" title=\"使用AMI启动EC2实例\"></a>使用AMI启动EC2实例</h2><p><strong>1、等待AMI状态变Available后，点击Launch instance from AMI</strong></p>\n<p><img src=\"/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-x5q.png\" alt=\"SCR-20230301-x5q.png\"></p>\n<p><strong>2、进入EC2启动的设置页面，进行必要的设置</strong></p>\n<p><img src=\"/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-x8g.png\" alt=\"SCR-20230301-x8g.png\"></p>\n<p><strong>除了user-data维持空白，其他设置可与创建AMI的EC2一致。</strong></p>\n<p><strong>3、EC2创建后，转到EC2的信息页面</strong></p>\n<p><img src=\"/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230302-8x.png\" alt=\"SCR-20230302-8x.png\"></p>\n<p><strong>4、测试Enterprise Console的Web界面</strong></p>\n<p>大概10分钟后，可以通过以下地址访问</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http://ec2-69-230-211-253.cn-northwest-1.compute.amazonaws.com.cn/:9191</span><br><span class=\"line\">username: admin</span><br><span class=\"line\">password: 从信息页面中拷贝instance-id，如上图为i-06b75d367808d02af</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230302-a8.png\" alt=\"SCR-20230302-a8.png\"></p>\n<p><img src=\"/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230302-b8.png\" alt=\"SCR-20230302-b8.png\"></p>\n<p><strong>5、使用SSM连接EC2，检查相关服务是否正常</strong></p>\n<p><img src=\"/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230302-du.png\" alt=\"SCR-20230302-du.png\"></p>\n<h1 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h1><p>本文整理了在AWS上制作AppDynamics的AMI镜像的过程，笔者使用了ChatGPT帮助生成自动化脚本，极大的提高了效率。<br>本文中的cloud-init代码已发布到Github，如下：</p>\n<p><a href=\"https://github.com/weiborao/appd-console-install-cloud-init/blob/main/appd-install-cloud-init-CN.yaml\">https://github.com/weiborao/appd-console-install-cloud-init/blob/main/appd-install-cloud-init-CN.yaml</a></p>\n<p>非常感谢各位耐心的阅读，</p>"},{"title":"Ansible-K8S-Cilium","date":"2025-08-04T01:23:21.000Z","description":"本文使用Ansible脚本从零开始部署Ubuntu虚拟机，然后在Ubuntu上安装K8S，使用Cilium作为CNI。","_content":"# Setup K8S with Ansible from zero\n\n# 1. 删除之前的环境\n\n```bash\nois@ois:~/data/k8s-cilium-lab$ cd ..\nois@ois:~/data$ ./07-undefine-vms.sh \nDomain 'k8s-node-1' destroyed\n\nDomain 'k8s-node-1' has been undefined\nVolume 'vda'(/home/ois/data/k8s-cilium-lab/nodevms/k8s-node-1.qcow2) removed.\n\nDomain 'k8s-node-2' destroyed\n\nDomain 'k8s-node-2' has been undefined\nVolume 'vda'(/home/ois/data/k8s-cilium-lab/nodevms/k8s-node-2.qcow2) removed.\n\nDomain 'k8s-node-3' destroyed\n\nDomain 'k8s-node-3' has been undefined\nVolume 'vda'(/home/ois/data/k8s-cilium-lab/nodevms/k8s-node-3.qcow2) removed.\n\nDomain 'dns-bgp-server' destroyed\n\nDomain 'dns-bgp-server' has been undefined\nVolume 'vda'(/home/ois/data/k8s-cilium-lab/nodevms/dns-bgp-server.qcow2) removed.\n\nois@ois:~/data$ rm -rf k8s-cilium-lab/\nois@ois:~/data$ \n```\n\n# 2. 重新构建项目文件结构\n\n```bash\nois@ois:~/data$ ./00-create-project-structure.sh \n--- K8s + Cilium Lab Setup (Warning-Free) ---\nThis script will prepare a new Ansible project directory named 'k8s-cilium-lab'.\n\n--- Step 1: Checking Prerequisites ---\n✅ OS is Debian-based.\n✅ Ansible is already installed.\n--> Ensuring libvirt and whois are up-to-date...\n✅ Dependencies are present.\n✅ SSH key already exists at ~/.ssh/id_rsa. Skipping generation.\n\n--- Step 2: Creating Project Structure ---\n✅ Project directory structure created in 'k8s-cilium-lab/'.\n\n--- Step 3: Configuring User Password Hash ---\nA secure password hash is required for the 'ubuntu' user on the VMs.\nEnter the password for the 'ubuntu' user (input will be hidden): \n--> Generating password hash...\n✅ Password hash generated.\n\n--- Step 4: Generating Configuration Files ---\n✅ Created ansible.cfg\n✅ Created inventory.ini\n✅ Created group_vars/all.yml with password hash.\n✅ Created host_vars/k8s-node-1.yml\n✅ Created host_vars/k8s-node-2.yml\n✅ Created host_vars/k8s-node-3.yml\n✅ Created host_vars/dns-bgp-server.yml\n\n--- Setup Complete! ---\n✅ Project 'k8s-cilium-lab' has been successfully configured.\n\nNext Steps:\n1. Run the next script to generate the VM creation playbook:\n   ../01-create-vms.sh\n2. Run the playbook to create your lab VMs (no vault password needed):\n   ansible-playbook playbooks/1_create_vms.yml\n```\n\n# 3. 生成Playbook，用于构建Lab环境虚拟机\n\n```bash\nois@ois:~/data$ ./01-create-vms.sh \n--- Lab VM Playbook Generator (Final Corrected Version) ---\n\n--- Step 1: Verifying Project Context ---\n✅ Working inside project directory: /home/ois/data/k8s-cilium-lab\n\n--- Step 2: Ensuring Directories Exist ---\n✅ Directories 'playbooks/' and 'templates/' are ready.\n\n--- Step 3: Generating Files ---\n✅ Generated playbook: playbooks/1_create_vms.yml\n✅ Generated template: templates/user-data.j2\n✅ Generated template: templates/network-config.j2\n✅ Generated template: templates/meta-data.j2\n\n--- Generation Complete! ---\n✅ All necessary files have been created inside the 'k8s-cilium-lab' directory.\n\nNext Step:\n1. Change into the project directory: cd k8s-cilium-lab\n2. Run the playbook to create your lab VMs:\n   ansible-playbook playbooks/1_create_vms.yml\n```\n\n# 4. 运行Playbook，构建虚拟机环境\n\n自动创建k8s-nodes 和 运行FRR的虚拟机，并进行联通性探测，添加到已知主机列表(known_hosts)\n\n```bash\nois@ois:~/data$ cd k8s-cilium-lab/\nois@ois:~/data/k8s-cilium-lab$ \nois@ois:~/data/k8s-cilium-lab$ \nois@ois:~/data/k8s-cilium-lab$ ansible-playbook playbooks/1_create_vms.yml\n\nPLAY [Play 1 - Pre-flight Check for Existing VMs] ******************************************************************************************************************************************************\n\nTASK [Check status of each VM with virsh] **************************************************************************************************************************************************************\nok: [dns-bgp-server]\nok: [k8s-node-2]\nok: [k8s-node-1]\nok: [k8s-node-3]\n\nPLAY [Play 2 - Decide if Provisioning is Needed] *******************************************************************************************************************************************************\n\nTASK [Initialize an empty list for missing VMs] ********************************************************************************************************************************************************\nok: [localhost]\n\nTASK [Populate the list of missing VMs] ****************************************************************************************************************************************************************\nok: [localhost] => (item=dns-bgp-server)\nok: [localhost] => (item=k8s-node-1)\nok: [localhost] => (item=k8s-node-2)\nok: [localhost] => (item=k8s-node-3)\n\nTASK [Set global flag if provisioning is required] *****************************************************************************************************************************************************\nok: [localhost]\n\nTASK [Report status] ***********************************************************************************************************************************************************************************\nok: [localhost] => {\n    \"msg\": \"Provisioning needed: True. Missing VMs: ['dns-bgp-server', 'k8s-node-1', 'k8s-node-2', 'k8s-node-3']\"\n}\n\nPLAY [Play 3 - Prepare VM Assets in Parallel] **********************************************************************************************************************************************************\n[WARNING]: Using run_once with the free strategy is not currently supported. This task will still be executed for every host in the inventory list.\n\nTASK [Ensure VM directories exist] *********************************************************************************************************************************************************************\nchanged: [dns-bgp-server] => (item=/home/ois/data/k8s-cilium-lab/nodevms)\nok: [k8s-node-2] => (item=/home/ois/data/k8s-cilium-lab/nodevms)\nok: [k8s-node-3] => (item=/home/ois/data/k8s-cilium-lab/nodevms)\nok: [k8s-node-1] => (item=/home/ois/data/k8s-cilium-lab/nodevms)\nchanged: [dns-bgp-server] => (item=/home/ois/data/k8s-cilium-lab/nodevm_cfg)\nok: [k8s-node-2] => (item=/home/ois/data/k8s-cilium-lab/nodevm_cfg)\nok: [k8s-node-3] => (item=/home/ois/data/k8s-cilium-lab/nodevm_cfg)\nok: [k8s-node-1] => (item=/home/ois/data/k8s-cilium-lab/nodevm_cfg)\n\nTASK [Check if VM disk image already exists] ***********************************************************************************************************************************************************\nok: [k8s-node-2]\nok: [dns-bgp-server]\nok: [k8s-node-1]\nok: [k8s-node-3]\n\nTASK [Create VM disk image from base image] ************************************************************************************************************************************************************\nchanged: [dns-bgp-server]\nchanged: [k8s-node-2]\nchanged: [k8s-node-1]\nchanged: [k8s-node-3]\n\nTASK [Resize VM disk image] ****************************************************************************************************************************************************************************\nchanged: [dns-bgp-server]\nchanged: [k8s-node-2]\nchanged: [k8s-node-3]\nchanged: [k8s-node-1]\n\nTASK [Generate cloud-init files] ***********************************************************************************************************************************************************************\nchanged: [k8s-node-2] => (item={'src': '../templates/user-data.j2', 'dest': '/home/ois/data/k8s-cilium-lab/nodevm_cfg/k8s-node-2_user-data'})\nchanged: [k8s-node-3] => (item={'src': '../templates/user-data.j2', 'dest': '/home/ois/data/k8s-cilium-lab/nodevm_cfg/k8s-node-3_user-data'})\nchanged: [dns-bgp-server] => (item={'src': '../templates/user-data.j2', 'dest': '/home/ois/data/k8s-cilium-lab/nodevm_cfg/dns-bgp-server_user-data'})\nchanged: [k8s-node-1] => (item={'src': '../templates/user-data.j2', 'dest': '/home/ois/data/k8s-cilium-lab/nodevm_cfg/k8s-node-1_user-data'})\nchanged: [k8s-node-3] => (item={'src': '../templates/network-config.j2', 'dest': '/home/ois/data/k8s-cilium-lab/nodevm_cfg/k8s-node-3_network-config'})\nchanged: [k8s-node-2] => (item={'src': '../templates/network-config.j2', 'dest': '/home/ois/data/k8s-cilium-lab/nodevm_cfg/k8s-node-2_network-config'})\nchanged: [k8s-node-1] => (item={'src': '../templates/network-config.j2', 'dest': '/home/ois/data/k8s-cilium-lab/nodevm_cfg/k8s-node-1_network-config'})\nchanged: [dns-bgp-server] => (item={'src': '../templates/network-config.j2', 'dest': '/home/ois/data/k8s-cilium-lab/nodevm_cfg/dns-bgp-server_network-config'})\nchanged: [k8s-node-3] => (item={'src': '../templates/meta-data.j2', 'dest': '/home/ois/data/k8s-cilium-lab/nodevm_cfg/k8s-node-3_meta-data'})\nchanged: [k8s-node-2] => (item={'src': '../templates/meta-data.j2', 'dest': '/home/ois/data/k8s-cilium-lab/nodevm_cfg/k8s-node-2_meta-data'})\nchanged: [k8s-node-1] => (item={'src': '../templates/meta-data.j2', 'dest': '/home/ois/data/k8s-cilium-lab/nodevm_cfg/k8s-node-1_meta-data'})\nchanged: [dns-bgp-server] => (item={'src': '../templates/meta-data.j2', 'dest': '/home/ois/data/k8s-cilium-lab/nodevm_cfg/dns-bgp-server_meta-data'})\n\nPLAY [Play 4 - Install VMs Sequentially to Avoid Race Condition] ***************************************************************************************************************************************\n\nTASK [Create and start the VM with virt-install] *******************************************************************************************************************************************************\nchanged: [dns-bgp-server]\n\nPLAY [Play 4 - Install VMs Sequentially to Avoid Race Condition] ***************************************************************************************************************************************\n\nTASK [Create and start the VM with virt-install] *******************************************************************************************************************************************************\nchanged: [k8s-node-1]\n\nPLAY [Play 4 - Install VMs Sequentially to Avoid Race Condition] ***************************************************************************************************************************************\n\nTASK [Create and start the VM with virt-install] *******************************************************************************************************************************************************\nchanged: [k8s-node-2]\n\nPLAY [Play 4 - Install VMs Sequentially to Avoid Race Condition] ***************************************************************************************************************************************\n\nTASK [Create and start the VM with virt-install] *******************************************************************************************************************************************************\nchanged: [k8s-node-3]\n\nPLAY [Play 5 - Verify VM Connectivity in Parallel] *****************************************************************************************************************************************************\n\nTASK [Wait for VMs to boot and SSH to become available] ************************************************************************************************************************************************\nok: [dns-bgp-server -> localhost]\nok: [k8s-node-1 -> localhost]\n# 10.75.59.86:22 SSH-2.0-OpenSSH_9.6p1 Ubuntu-3ubuntu13.12\n# 10.75.59.81:22 SSH-2.0-OpenSSH_9.6p1 Ubuntu-3ubuntu13.12\n# 10.75.59.81:22 SSH-2.0-OpenSSH_9.6p1 Ubuntu-3ubuntu13.12\n# 10.75.59.86:22 SSH-2.0-OpenSSH_9.6p1 Ubuntu-3ubuntu13.12\n# 10.75.59.81:22 SSH-2.0-OpenSSH_9.6p1 Ubuntu-3ubuntu13.12\n# 10.75.59.81:22 SSH-2.0-OpenSSH_9.6p1 Ubuntu-3ubuntu13.12\n# 10.75.59.86:22 SSH-2.0-OpenSSH_9.6p1 Ubuntu-3ubuntu13.12\n# 10.75.59.81:22 SSH-2.0-OpenSSH_9.6p1 Ubuntu-3ubuntu13.12\n# 10.75.59.86:22 SSH-2.0-OpenSSH_9.6p1 Ubuntu-3ubuntu13.12\n# 10.75.59.86:22 SSH-2.0-OpenSSH_9.6p1 Ubuntu-3ubuntu13.12\n\nTASK [Add host keys to known_hosts file] ***************************************************************************************************************************************************************\nchanged: [k8s-node-1 -> localhost]\nchanged: [dns-bgp-server -> localhost]\n\nTASK [Wait for VMs to boot and SSH to become available] ************************************************************************************************************************************************\nok: [k8s-node-3 -> localhost]\n# 10.75.59.83:22 SSH-2.0-OpenSSH_9.6p1 Ubuntu-3ubuntu13.12\n# 10.75.59.83:22 SSH-2.0-OpenSSH_9.6p1 Ubuntu-3ubuntu13.12\n# 10.75.59.83:22 SSH-2.0-OpenSSH_9.6p1 Ubuntu-3ubuntu13.12\n# 10.75.59.83:22 SSH-2.0-OpenSSH_9.6p1 Ubuntu-3ubuntu13.12\n# 10.75.59.83:22 SSH-2.0-OpenSSH_9.6p1 Ubuntu-3ubuntu13.12\n\nTASK [Add host keys to known_hosts file] ***************************************************************************************************************************************************************\nchanged: [k8s-node-3 -> localhost]\n\nTASK [Wait for VMs to boot and SSH to become available] ************************************************************************************************************************************************\nok: [k8s-node-2 -> localhost]\n# 10.75.59.82:22 SSH-2.0-OpenSSH_9.6p1 Ubuntu-3ubuntu13.12\n# 10.75.59.82:22 SSH-2.0-OpenSSH_9.6p1 Ubuntu-3ubuntu13.12\n# 10.75.59.82:22 SSH-2.0-OpenSSH_9.6p1 Ubuntu-3ubuntu13.12\n# 10.75.59.82:22 SSH-2.0-OpenSSH_9.6p1 Ubuntu-3ubuntu13.12\n# 10.75.59.82:22 SSH-2.0-OpenSSH_9.6p1 Ubuntu-3ubuntu13.12\n\nTASK [Add host keys to known_hosts file] ***************************************************************************************************************************************************************\nchanged: [k8s-node-2 -> localhost]\n\nPLAY RECAP *********************************************************************************************************************************************************************************************\ndns-bgp-server             : ok=9    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   \nk8s-node-1                 : ok=9    changed=5    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   \nk8s-node-2                 : ok=9    changed=5    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   \nk8s-node-3                 : ok=9    changed=5    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   \nlocalhost                  : ok=4    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   \n```\n\n多次运行，以测试幂等性，多次运行不影响结果，已执行过的任务会自行跳过。\n\n```bash\nois@ois:~/data/k8s-cilium-lab$ ansible-playbook playbooks/1_create_vms.yml\n\nPLAY [Play 1 - Pre-flight Check for Existing VMs] ******************************************************************************************************************************************************\n\nTASK [Check status of each VM with virsh] **************************************************************************************************************************************************************\nok: [k8s-node-3]\nok: [k8s-node-1]\nok: [dns-bgp-server]\nok: [k8s-node-2]\n\nPLAY [Play 2 - Decide if Provisioning is Needed] *******************************************************************************************************************************************************\n\nTASK [Initialize an empty list for missing VMs] ********************************************************************************************************************************************************\nok: [localhost]\n\nTASK [Populate the list of missing VMs] ****************************************************************************************************************************************************************\nskipping: [localhost] => (item=dns-bgp-server) \nskipping: [localhost] => (item=k8s-node-1) \nskipping: [localhost] => (item=k8s-node-2) \nskipping: [localhost] => (item=k8s-node-3) \nskipping: [localhost]\n\nTASK [Set global flag if provisioning is required] *****************************************************************************************************************************************************\nok: [localhost]\n\nTASK [Report status] ***********************************************************************************************************************************************************************************\nok: [localhost] => {\n    \"msg\": \"Provisioning needed: False. Missing VMs: []\"\n}\n\nPLAY [Play 3 - Prepare VM Assets in Parallel] **********************************************************************************************************************************************************\n[WARNING]: Using run_once with the free strategy is not currently supported. This task will still be executed for every host in the inventory list.\n\nTASK [Ensure VM directories exist] *********************************************************************************************************************************************************************\nskipping: [dns-bgp-server] => (item=/home/ois/data/k8s-cilium-lab/nodevms) \nskipping: [dns-bgp-server] => (item=/home/ois/data/k8s-cilium-lab/nodevm_cfg) \nskipping: [k8s-node-1] => (item=/home/ois/data/k8s-cilium-lab/nodevms) \nskipping: [dns-bgp-server]\nskipping: [k8s-node-1] => (item=/home/ois/data/k8s-cilium-lab/nodevm_cfg) \nskipping: [k8s-node-2] => (item=/home/ois/data/k8s-cilium-lab/nodevms) \nskipping: [k8s-node-2] => (item=/home/ois/data/k8s-cilium-lab/nodevm_cfg) \nskipping: [k8s-node-3] => (item=/home/ois/data/k8s-cilium-lab/nodevms) \nskipping: [k8s-node-3] => (item=/home/ois/data/k8s-cilium-lab/nodevm_cfg) \nskipping: [k8s-node-1]\nskipping: [k8s-node-2]\nskipping: [k8s-node-3]\n\nTASK [Check if VM disk image already exists] ***********************************************************************************************************************************************************\nskipping: [dns-bgp-server]\nskipping: [k8s-node-1]\nskipping: [k8s-node-2]\nskipping: [k8s-node-3]\n\nTASK [Create VM disk image from base image] ************************************************************************************************************************************************************\nskipping: [dns-bgp-server]\nskipping: [k8s-node-1]\nskipping: [k8s-node-2]\nskipping: [k8s-node-3]\n\nTASK [Resize VM disk image] ****************************************************************************************************************************************************************************\nskipping: [dns-bgp-server]\nskipping: [k8s-node-1]\nskipping: [k8s-node-2]\nskipping: [k8s-node-3]\n\nTASK [Generate cloud-init files] ***********************************************************************************************************************************************************************\nskipping: [k8s-node-1] => (item={'src': '../templates/user-data.j2', 'dest': '/home/ois/data/k8s-cilium-lab/nodevm_cfg/k8s-node-1_user-data'}) \nskipping: [k8s-node-1] => (item={'src': '../templates/network-config.j2', 'dest': '/home/ois/data/k8s-cilium-lab/nodevm_cfg/k8s-node-1_network-config'}) \nskipping: [k8s-node-2] => (item={'src': '../templates/user-data.j2', 'dest': '/home/ois/data/k8s-cilium-lab/nodevm_cfg/k8s-node-2_user-data'}) \nskipping: [k8s-node-1] => (item={'src': '../templates/meta-data.j2', 'dest': '/home/ois/data/k8s-cilium-lab/nodevm_cfg/k8s-node-1_meta-data'}) \nskipping: [k8s-node-1]\nskipping: [k8s-node-2] => (item={'src': '../templates/network-config.j2', 'dest': '/home/ois/data/k8s-cilium-lab/nodevm_cfg/k8s-node-2_network-config'}) \nskipping: [dns-bgp-server] => (item={'src': '../templates/user-data.j2', 'dest': '/home/ois/data/k8s-cilium-lab/nodevm_cfg/dns-bgp-server_user-data'}) \nskipping: [k8s-node-2] => (item={'src': '../templates/meta-data.j2', 'dest': '/home/ois/data/k8s-cilium-lab/nodevm_cfg/k8s-node-2_meta-data'}) \nskipping: [k8s-node-2]\nskipping: [dns-bgp-server] => (item={'src': '../templates/network-config.j2', 'dest': '/home/ois/data/k8s-cilium-lab/nodevm_cfg/dns-bgp-server_network-config'}) \nskipping: [dns-bgp-server] => (item={'src': '../templates/meta-data.j2', 'dest': '/home/ois/data/k8s-cilium-lab/nodevm_cfg/dns-bgp-server_meta-data'}) \nskipping: [k8s-node-3] => (item={'src': '../templates/user-data.j2', 'dest': '/home/ois/data/k8s-cilium-lab/nodevm_cfg/k8s-node-3_user-data'}) \nskipping: [dns-bgp-server]\nskipping: [k8s-node-3] => (item={'src': '../templates/network-config.j2', 'dest': '/home/ois/data/k8s-cilium-lab/nodevm_cfg/k8s-node-3_network-config'}) \nskipping: [k8s-node-3] => (item={'src': '../templates/meta-data.j2', 'dest': '/home/ois/data/k8s-cilium-lab/nodevm_cfg/k8s-node-3_meta-data'}) \nskipping: [k8s-node-3]\n\nPLAY [Play 4 - Install VMs Sequentially to Avoid Race Condition] ***************************************************************************************************************************************\n\nTASK [Create and start the VM with virt-install] *******************************************************************************************************************************************************\nskipping: [dns-bgp-server]\n\nPLAY [Play 4 - Install VMs Sequentially to Avoid Race Condition] ***************************************************************************************************************************************\n\nTASK [Create and start the VM with virt-install] *******************************************************************************************************************************************************\nskipping: [k8s-node-1]\n\nPLAY [Play 4 - Install VMs Sequentially to Avoid Race Condition] ***************************************************************************************************************************************\n\nTASK [Create and start the VM with virt-install] *******************************************************************************************************************************************************\nskipping: [k8s-node-2]\n\nPLAY [Play 4 - Install VMs Sequentially to Avoid Race Condition] ***************************************************************************************************************************************\n\nTASK [Create and start the VM with virt-install] *******************************************************************************************************************************************************\nskipping: [k8s-node-3]\n\nPLAY [Play 5 - Verify VM Connectivity in Parallel] *****************************************************************************************************************************************************\n\nTASK [Wait for VMs to boot and SSH to become available] ************************************************************************************************************************************************\nskipping: [dns-bgp-server]\nskipping: [k8s-node-1]\nskipping: [k8s-node-2]\nskipping: [k8s-node-3]\n\nTASK [Add host keys to known_hosts file] ***************************************************************************************************************************************************************\nskipping: [dns-bgp-server]\nskipping: [k8s-node-1]\nskipping: [k8s-node-2]\nskipping: [k8s-node-3]\n\nPLAY RECAP *********************************************************************************************************************************************************************************************\ndns-bgp-server             : ok=1    changed=0    unreachable=0    failed=0    skipped=8    rescued=0    ignored=0   \nk8s-node-1                 : ok=1    changed=0    unreachable=0    failed=0    skipped=8    rescued=0    ignored=0   \nk8s-node-2                 : ok=1    changed=0    unreachable=0    failed=0    skipped=8    rescued=0    ignored=0   \nk8s-node-3                 : ok=1    changed=0    unreachable=0    failed=0    skipped=8    rescued=0    ignored=0   \nlocalhost                  : ok=3    changed=0    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   \n```\n\n# 5. 生成Playbook以便安装Containerd和K8S工具\n\n```bash\nois@ois:~/data/k8s-cilium-lab$ cd ..\nois@ois:~/data$ ./02-prepare-nodes.sh \n--- Node Preparation Playbook Generator (with cloud-init wait) ---\n\n--- Step 1: Verifying Project Context ---\n✅ Working inside project directory: /home/ois/data/k8s-cilium-lab\n\n--- Step 2: Ensuring Role Directories Exist ---\n✅ Role directories created.\n\n--- Step 3: Generating Role Task Files ---\n✅ Created tasks for 'common' role.\n✅ Created tasks for 'k8s_node' role.\n✅ Created tasks for 'infra_server' role.\n\n--- Step 4: Generating Config Templates ---\n✅ Created /etc/hosts template.\n✅ Created containerd config template.\n✅ Created FRR config template.\n\n--- Step 5: Generating Main Playbook ---\n✅ Created main playbook: playbooks/2_prepare_nodes.yml\n\n--- Generation Complete! ---\n✅ All necessary files for node preparation have been created.\n\nNext Step:\n1. Change into the project directory: cd k8s-cilium-lab\n2. Run the playbook to prepare your nodes. You will be prompted for the sudo password:\n   ansible-playbook playbooks/2_prepare_nodes.yml --ask-become-pass\n```\n\n# 6. 执行Playbook，安装Containerd和K8S工具\n\n```bash\nois@ois:~/data$ cd k8s-cilium-lab/\nois@ois:~/data/k8s-cilium-lab$ ansible-playbook playbooks/2_prepare_nodes.yml --ask-become-pass\nBECOME password: \n\nPLAY [Play 1 - Prepare All Nodes] **********************************************************************************************************************************************************************\n\nTASK [Gathering Facts] *********************************************************************************************************************************************************************************\nok: [dns-bgp-server]\nok: [k8s-node-3]\nok: [k8s-node-2]\nok: [k8s-node-1]\n\nTASK [common : Wait for cloud-init to complete] ********************************************************************************************************************************************************\nok: [dns-bgp-server]\nok: [k8s-node-2]\nok: [k8s-node-3]\nok: [k8s-node-1]\n\nTASK [common : Update apt cache and upgrade all packages] **********************************************************************************************************************************************\nchanged: [dns-bgp-server]\nchanged: [k8s-node-3]\nchanged: [k8s-node-1]\nchanged: [k8s-node-2]\n\nTASK [common : Configure /etc/hosts from template] *****************************************************************************************************************************************************\nchanged: [k8s-node-2]\nchanged: [dns-bgp-server]\nchanged: [k8s-node-3]\nchanged: [k8s-node-1]\n\nTASK [common : Turn off all swap devices] **************************************************************************************************************************************************************\nskipping: [dns-bgp-server]\nskipping: [k8s-node-1]\nskipping: [k8s-node-2]\nskipping: [k8s-node-3]\n\nTASK [common : Comment out swap entries in /etc/fstab] *************************************************************************************************************************************************\nskipping: [dns-bgp-server]\nskipping: [k8s-node-1]\nskipping: [k8s-node-2]\nskipping: [k8s-node-3]\n\nTASK [common : Load required kernel modules] ***********************************************************************************************************************************************************\nchanged: [dns-bgp-server] => (item=overlay)\nchanged: [k8s-node-1] => (item=overlay)\nchanged: [k8s-node-2] => (item=overlay)\nchanged: [k8s-node-3] => (item=overlay)\nchanged: [k8s-node-2] => (item=br_netfilter)\nchanged: [dns-bgp-server] => (item=br_netfilter)\nchanged: [k8s-node-1] => (item=br_netfilter)\nchanged: [k8s-node-3] => (item=br_netfilter)\n\nTASK [common : Ensure kernel modules are loaded on boot] ***********************************************************************************************************************************************\nchanged: [dns-bgp-server]\nchanged: [k8s-node-1]\nchanged: [k8s-node-3]\nchanged: [k8s-node-2]\n\nTASK [common : Configure sysctl parameters for Kubernetes networking] **********************************************************************************************************************************\nchanged: [dns-bgp-server]\nchanged: [k8s-node-1]\nchanged: [k8s-node-3]\nchanged: [k8s-node-2]\n\nTASK [common : Apply sysctl settings without reboot] ***************************************************************************************************************************************************\nok: [dns-bgp-server]\nok: [k8s-node-1]\nok: [k8s-node-3]\nok: [k8s-node-2]\n\nPLAY [Play 2 - Prepare Kubernetes Nodes] ***************************************************************************************************************************************************************\n\nTASK [Gathering Facts] *********************************************************************************************************************************************************************************\nok: [k8s-node-3]\nok: [k8s-node-1]\nok: [k8s-node-2]\n\nTASK [k8s_node : Install prerequisite packages] ********************************************************************************************************************************************************\nok: [k8s-node-1]\nok: [k8s-node-2]\nok: [k8s-node-3]\n\nTASK [k8s_node : Ensure apt keyrings directory exists] *************************************************************************************************************************************************\nok: [k8s-node-1]\nok: [k8s-node-3]\nok: [k8s-node-2]\n\nTASK [k8s_node : Add Docker's official GPG key] ********************************************************************************************************************************************************\nchanged: [k8s-node-2]\nchanged: [k8s-node-3]\nchanged: [k8s-node-1]\n\nTASK [k8s_node : Add Docker's repository to Apt sources] ***********************************************************************************************************************************************\nchanged: [k8s-node-2]\nchanged: [k8s-node-1]\nchanged: [k8s-node-3]\n\nTASK [k8s_node : Install containerd] *******************************************************************************************************************************************************************\nchanged: [k8s-node-1]\nchanged: [k8s-node-2]\nchanged: [k8s-node-3]\n\nTASK [k8s_node : Configure containerd from template] ***************************************************************************************************************************************************\nchanged: [k8s-node-1]\nchanged: [k8s-node-2]\nchanged: [k8s-node-3]\n\nTASK [k8s_node : Install prerequisite packages for Kubernetes repo] ************************************************************************************************************************************\nchanged: [k8s-node-2]\nchanged: [k8s-node-3]\nchanged: [k8s-node-1]\n\nTASK [k8s_node : Download the Kubernetes public signing key] *******************************************************************************************************************************************\nchanged: [k8s-node-2]\nchanged: [k8s-node-1]\nchanged: [k8s-node-3]\n\nTASK [k8s_node : Dearmor the Kubernetes GPG key] *******************************************************************************************************************************************************\nchanged: [k8s-node-1]\nchanged: [k8s-node-2]\nchanged: [k8s-node-3]\n\nTASK [k8s_node : Add Kubernetes APT repository] ********************************************************************************************************************************************************\nchanged: [k8s-node-2]\nchanged: [k8s-node-1]\nchanged: [k8s-node-3]\n\nTASK [k8s_node : Clean up temporary key file] **********************************************************************************************************************************************************\nchanged: [k8s-node-1]\nchanged: [k8s-node-2]\nchanged: [k8s-node-3]\n\nTASK [k8s_node : Install kubelet, kubeadm, and kubectl] ************************************************************************************************************************************************\nchanged: [k8s-node-3]\nchanged: [k8s-node-1]\nchanged: [k8s-node-2]\n\nTASK [k8s_node : Pin Kubernetes package versions] ******************************************************************************************************************************************************\nchanged: [k8s-node-2] => (item=kubelet)\nchanged: [k8s-node-3] => (item=kubelet)\nchanged: [k8s-node-1] => (item=kubelet)\nchanged: [k8s-node-2] => (item=kubeadm)\nchanged: [k8s-node-1] => (item=kubeadm)\nchanged: [k8s-node-3] => (item=kubeadm)\nchanged: [k8s-node-2] => (item=kubectl)\nchanged: [k8s-node-3] => (item=kubectl)\nchanged: [k8s-node-1] => (item=kubectl)\n\nTASK [k8s_node : Enable and start kubelet service] *****************************************************************************************************************************************************\nchanged: [k8s-node-2]\nchanged: [k8s-node-3]\nchanged: [k8s-node-1]\n\nRUNNING HANDLER [Restart containerd] *******************************************************************************************************************************************************************\nchanged: [k8s-node-2]\nchanged: [k8s-node-1]\nchanged: [k8s-node-3]\n\nPLAY [Play 3 - Prepare Infrastructure Server] **********************************************************************************************************************************************************\n\nTASK [Gathering Facts] *********************************************************************************************************************************************************************************\nok: [dns-bgp-server]\n\nTASK [infra_server : Install dnsmasq and FRR] **********************************************************************************************************************************************************\nchanged: [dns-bgp-server]\n\nTASK [infra_server : Configure dnsmasq] ****************************************************************************************************************************************************************\nchanged: [dns-bgp-server]\n\nTASK [infra_server : Configure FRR daemons] ************************************************************************************************************************************************************\nok: [dns-bgp-server] => (item=zebra)\nchanged: [dns-bgp-server] => (item=bgpd)\n\nTASK [infra_server : Configure frr.conf] ***************************************************************************************************************************************************************\nchanged: [dns-bgp-server]\n\nTASK [infra_server : Ensure FRR config has correct permissions] ****************************************************************************************************************************************\nok: [dns-bgp-server]\n\nRUNNING HANDLER [Restart dnsmasq] **********************************************************************************************************************************************************************\nchanged: [dns-bgp-server]\n\nRUNNING HANDLER [Restart frr] **************************************************************************************************************************************************************************\nchanged: [dns-bgp-server]\n\nPLAY RECAP *********************************************************************************************************************************************************************************************\ndns-bgp-server             : ok=16   changed=11   unreachable=0    failed=0    skipped=2    rescued=0    ignored=0   \nk8s-node-1                 : ok=24   changed=18   unreachable=0    failed=0    skipped=2    rescued=0    ignored=0   \nk8s-node-2                 : ok=24   changed=18   unreachable=0    failed=0    skipped=2    rescued=0    ignored=0   \nk8s-node-3                 : ok=24   changed=18   unreachable=0    failed=0    skipped=2    rescued=0    ignored=0   \n```\n\n多次执行Playbook，验证幂等性\n\n```bash\nois@ois:~/data/k8s-cilium-lab$ ansible-playbook playbooks/2_prepare_nodes.yml --ask-become-pass\nBECOME password: \n\nPLAY [Play 1 - Prepare All Nodes] **********************************************************************************************************************************************************************\n\nTASK [Gathering Facts] *********************************************************************************************************************************************************************************\nok: [k8s-node-2]\nok: [dns-bgp-server]\nok: [k8s-node-3]\nok: [k8s-node-1]\n\nTASK [common : Wait for cloud-init to complete] ********************************************************************************************************************************************************\nok: [k8s-node-1]\nok: [dns-bgp-server]\nok: [k8s-node-2]\nok: [k8s-node-3]\n\nTASK [common : Update apt cache and upgrade all packages] **********************************************************************************************************************************************\nok: [dns-bgp-server]\nok: [k8s-node-2]\nok: [k8s-node-3]\nok: [k8s-node-1]\n\nTASK [common : Configure /etc/hosts from template] *****************************************************************************************************************************************************\nok: [k8s-node-1]\nok: [k8s-node-3]\nok: [dns-bgp-server]\nok: [k8s-node-2]\n\nTASK [common : Turn off all swap devices] **************************************************************************************************************************************************************\nskipping: [dns-bgp-server]\nskipping: [k8s-node-1]\nskipping: [k8s-node-2]\nskipping: [k8s-node-3]\n\nTASK [common : Comment out swap entries in /etc/fstab] *************************************************************************************************************************************************\nskipping: [dns-bgp-server]\nskipping: [k8s-node-1]\nskipping: [k8s-node-2]\nskipping: [k8s-node-3]\n\nTASK [common : Load required kernel modules] ***********************************************************************************************************************************************************\nok: [k8s-node-2] => (item=overlay)\nok: [dns-bgp-server] => (item=overlay)\nok: [k8s-node-3] => (item=overlay)\nok: [k8s-node-1] => (item=overlay)\nok: [k8s-node-2] => (item=br_netfilter)\nok: [dns-bgp-server] => (item=br_netfilter)\nok: [k8s-node-3] => (item=br_netfilter)\nok: [k8s-node-1] => (item=br_netfilter)\n\nTASK [common : Ensure kernel modules are loaded on boot] ***********************************************************************************************************************************************\nok: [k8s-node-1]\nok: [dns-bgp-server]\nok: [k8s-node-2]\nok: [k8s-node-3]\n\nTASK [common : Configure sysctl parameters for Kubernetes networking] **********************************************************************************************************************************\nok: [dns-bgp-server]\nok: [k8s-node-1]\nok: [k8s-node-2]\nok: [k8s-node-3]\n\nTASK [common : Apply sysctl settings without reboot] ***************************************************************************************************************************************************\nok: [dns-bgp-server]\nok: [k8s-node-1]\nok: [k8s-node-2]\nok: [k8s-node-3]\n\nPLAY [Play 2 - Prepare Kubernetes Nodes] ***************************************************************************************************************************************************************\n\nTASK [Gathering Facts] *********************************************************************************************************************************************************************************\nok: [k8s-node-2]\nok: [k8s-node-1]\nok: [k8s-node-3]\n\nTASK [k8s_node : Install prerequisite packages] ********************************************************************************************************************************************************\nok: [k8s-node-1]\nok: [k8s-node-2]\nok: [k8s-node-3]\n\nTASK [k8s_node : Ensure apt keyrings directory exists] *************************************************************************************************************************************************\nok: [k8s-node-1]\nok: [k8s-node-2]\nok: [k8s-node-3]\n\nTASK [k8s_node : Add Docker's official GPG key] ********************************************************************************************************************************************************\nok: [k8s-node-1]\nok: [k8s-node-2]\nok: [k8s-node-3]\n\nTASK [k8s_node : Add Docker's repository to Apt sources] ***********************************************************************************************************************************************\nok: [k8s-node-2]\nok: [k8s-node-1]\nok: [k8s-node-3]\n\nTASK [k8s_node : Install containerd] *******************************************************************************************************************************************************************\nok: [k8s-node-2]\nok: [k8s-node-1]\nok: [k8s-node-3]\n\nTASK [k8s_node : Configure containerd from template] ***************************************************************************************************************************************************\nok: [k8s-node-1]\nok: [k8s-node-2]\nok: [k8s-node-3]\n\nTASK [k8s_node : Install prerequisite packages for Kubernetes repo] ************************************************************************************************************************************\nok: [k8s-node-2]\nok: [k8s-node-1]\nok: [k8s-node-3]\n\nTASK [k8s_node : Download the Kubernetes public signing key] *******************************************************************************************************************************************\nchanged: [k8s-node-2]\nchanged: [k8s-node-1]\nchanged: [k8s-node-3]\n\nTASK [k8s_node : Dearmor the Kubernetes GPG key] *******************************************************************************************************************************************************\nok: [k8s-node-1]\nok: [k8s-node-2]\nok: [k8s-node-3]\n\nTASK [k8s_node : Add Kubernetes APT repository] ********************************************************************************************************************************************************\nok: [k8s-node-1]\nok: [k8s-node-2]\nok: [k8s-node-3]\n\nTASK [k8s_node : Clean up temporary key file] **********************************************************************************************************************************************************\nchanged: [k8s-node-1]\nchanged: [k8s-node-2]\nchanged: [k8s-node-3]\n\nTASK [k8s_node : Install kubelet, kubeadm, and kubectl] ************************************************************************************************************************************************\nok: [k8s-node-1]\nok: [k8s-node-2]\nok: [k8s-node-3]\n\nTASK [k8s_node : Pin Kubernetes package versions] ******************************************************************************************************************************************************\nok: [k8s-node-1] => (item=kubelet)\nok: [k8s-node-2] => (item=kubelet)\nok: [k8s-node-3] => (item=kubelet)\nok: [k8s-node-1] => (item=kubeadm)\nok: [k8s-node-2] => (item=kubeadm)\nok: [k8s-node-3] => (item=kubeadm)\nok: [k8s-node-1] => (item=kubectl)\nok: [k8s-node-2] => (item=kubectl)\nok: [k8s-node-3] => (item=kubectl)\n\nTASK [k8s_node : Enable and start kubelet service] *****************************************************************************************************************************************************\nok: [k8s-node-1]\nok: [k8s-node-2]\nok: [k8s-node-3]\n\nPLAY [Play 3 - Prepare Infrastructure Server] **********************************************************************************************************************************************************\n\nTASK [Gathering Facts] *********************************************************************************************************************************************************************************\nok: [dns-bgp-server]\n\nTASK [infra_server : Install dnsmasq and FRR] **********************************************************************************************************************************************************\nok: [dns-bgp-server]\n\nTASK [infra_server : Configure dnsmasq] ****************************************************************************************************************************************************************\nok: [dns-bgp-server]\n\nTASK [infra_server : Configure FRR daemons] ************************************************************************************************************************************************************\nok: [dns-bgp-server] => (item=zebra)\nok: [dns-bgp-server] => (item=bgpd)\n\nTASK [infra_server : Configure frr.conf] ***************************************************************************************************************************************************************\nok: [dns-bgp-server]\n\nTASK [infra_server : Ensure FRR config has correct permissions] ****************************************************************************************************************************************\nok: [dns-bgp-server]\n\nPLAY RECAP *********************************************************************************************************************************************************************************************\ndns-bgp-server             : ok=14   changed=0    unreachable=0    failed=0    skipped=2    rescued=0    ignored=0   \nk8s-node-1                 : ok=23   changed=2    unreachable=0    failed=0    skipped=2    rescued=0    ignored=0   \nk8s-node-2                 : ok=23   changed=2    unreachable=0    failed=0    skipped=2    rescued=0    ignored=0   \nk8s-node-3                 : ok=23   changed=2    unreachable=0    failed=0    skipped=2    rescued=0    ignored=0   \n```\n\n# 7. 执行脚本，构建设置K8S Cluster的Playbook\n\n```bash\nois@ois:~/data/k8s-cilium-lab$ cd ..\nois@ois:~/data$ ./03-setup-cluster.sh \n--- Kubernetes Cluster Setup Playbook Generator ---\n\n--- Step 1: Verifying Project Context ---\n✅ Working inside project directory: /home/ois/data/k8s-cilium-lab\n\n--- Step 2: Checking for 'community.kubernetes' Ansible Collection ---\n✅ 'community.kubernetes' collection is already installed.\n\n--- Step 3: Generating Cilium BGP Template ---\n✅ Created Cilium BGP config template.\n\n--- Step 4: Generating Main Playbook ---\n✅ Created main playbook: playbooks/3_setup_cluster.yml\n\n--- Generation Complete! ---\n✅ All necessary files for cluster setup have been created.\n\nNext Step:\n1. IMPORTANT: Reset your cluster nodes to ensure a clean state for this new workflow.\n   On each K8s VM, run: sudo kubeadm reset -f\n2. Change into the project directory: cd k8s-cilium-lab\n3. Run the playbook to build your Kubernetes cluster. You will be prompted for the sudo password:\n   ansible-playbook playbooks/3_setup_cluster.yml --ask-become-pass\n```\n\n# 8. 执行Playbook 设置K8S Cluster和Clium\n\n```bash\nois@ois:~/data$ cd k8s-cilium-lab/\nois@ois:~/data/k8s-cilium-lab$ ansible-playbook playbooks/3_setup_cluster.yml --ask-become-pass\nBECOME password: \n[DEPRECATION WARNING]: community.kubernetes.helm_repository has been deprecated. The community.kubernetes collection is being renamed to kubernetes.core. Please update your FQCNs to kubernetes.core \ninstead. This feature will be removed from community.kubernetes in version 3.0.0. Deprecation warnings can be disabled by setting deprecation_warnings=False in ansible.cfg.\n[DEPRECATION WARNING]: community.kubernetes.helm has been deprecated. The community.kubernetes collection is being renamed to kubernetes.core. Please update your FQCNs to kubernetes.core instead. \nThis feature will be removed from community.kubernetes in version 3.0.0. Deprecation warnings can be disabled by setting deprecation_warnings=False in ansible.cfg.\n[DEPRECATION WARNING]: community.kubernetes.k8s has been deprecated. The community.kubernetes collection is being renamed to kubernetes.core. Please update your FQCNs to kubernetes.core instead. This\n feature will be removed from community.kubernetes in version 3.0.0. Deprecation warnings can be disabled by setting deprecation_warnings=False in ansible.cfg.\n[DEPRECATION WARNING]: community.kubernetes.k8s_info has been deprecated. The community.kubernetes collection is being renamed to kubernetes.core. Please update your FQCNs to kubernetes.core instead.\n This feature will be removed from community.kubernetes in version 3.0.0. Deprecation warnings can be disabled by setting deprecation_warnings=False in ansible.cfg.\n\nPLAY [Play 1 - Initialize and Configure Control Plane] *************************************************************************************************************************************************\n\nTASK [Gathering Facts] *********************************************************************************************************************************************************************************\nok: [k8s-node-1]\n\nTASK [Check if cluster is already initialized] *********************************************************************************************************************************************************\nok: [k8s-node-1]\n\nTASK [Initialize the cluster] **************************************************************************************************************************************************************************\nchanged: [k8s-node-1]\n\nTASK [Create .kube directory for ubuntu user] **********************************************************************************************************************************************************\nchanged: [k8s-node-1]\n\nTASK [Copy admin.conf to user's kube config] ***********************************************************************************************************************************************************\nchanged: [k8s-node-1]\n\nTASK [Set KUBECONFIG for root user permanently] ********************************************************************************************************************************************************\nchanged: [k8s-node-1]\n\nTASK [Install prerequisites for Kubernetes modules] ****************************************************************************************************************************************************\nchanged: [k8s-node-1]\n\nTASK [Install Helm] ************************************************************************************************************************************************************************************\nchanged: [k8s-node-1]\n\nTASK [Install Cilium CLI] ******************************************************************************************************************************************************************************\nchanged: [k8s-node-1]\n\nTASK [Add Helm repositories] ***************************************************************************************************************************************************************************\nchanged: [k8s-node-1] => (item={'name': 'cilium', 'url': 'https://helm.cilium.io/'})\nchanged: [k8s-node-1] => (item={'name': 'isovalent', 'url': 'https://helm.isovalent.com/'})\n\nTASK [Deploy Cilium and Hubble with Helm] **************************************************************************************************************************************************************\nchanged: [k8s-node-1]\n\nTASK [Expose Hubble UI service via NodePort] ***********************************************************************************************************************************************************\n[WARNING]: kubernetes<24.2.0 is not supported or tested. Some features may not work.\nchanged: [k8s-node-1]\n\nTASK [Wait for Cilium CRDs to become available] ********************************************************************************************************************************************************\nFAILED - RETRYING: [k8s-node-1]: Wait for Cilium CRDs to become available (20 retries left).\nFAILED - RETRYING: [k8s-node-1]: Wait for Cilium CRDs to become available (19 retries left).\nFAILED - RETRYING: [k8s-node-1]: Wait for Cilium CRDs to become available (18 retries left).\nFAILED - RETRYING: [k8s-node-1]: Wait for Cilium CRDs to become available (17 retries left).\nFAILED - RETRYING: [k8s-node-1]: Wait for Cilium CRDs to become available (16 retries left).\nFAILED - RETRYING: [k8s-node-1]: Wait for Cilium CRDs to become available (15 retries left).\nFAILED - RETRYING: [k8s-node-1]: Wait for Cilium CRDs to become available (14 retries left).\nFAILED - RETRYING: [k8s-node-1]: Wait for Cilium CRDs to become available (13 retries left).\nFAILED - RETRYING: [k8s-node-1]: Wait for Cilium CRDs to become available (12 retries left).\nFAILED - RETRYING: [k8s-node-1]: Wait for Cilium CRDs to become available (11 retries left).\nFAILED - RETRYING: [k8s-node-1]: Wait for Cilium CRDs to become available (10 retries left).\nFAILED - RETRYING: [k8s-node-1]: Wait for Cilium CRDs to become available (9 retries left).\nok: [k8s-node-1]\n\nTASK [Apply Cilium BGP Configuration from template] ****************************************************************************************************************************************************\nchanged: [k8s-node-1]\n\nTASK [Generate a token for workers to join] ************************************************************************************************************************************************************\nchanged: [k8s-node-1]\n\nTASK [Store the join command for other hosts to access] ************************************************************************************************************************************************\nok: [k8s-node-1]\n\nPLAY [Play 2 - Join Worker Nodes to the Fully Configured Cluster] **************************************************************************************************************************************\n\nTASK [Gathering Facts] *********************************************************************************************************************************************************************************\nok: [k8s-node-2]\nok: [k8s-node-3]\n\nTASK [Check if node has already joined] ****************************************************************************************************************************************************************\nok: [k8s-node-2]\nok: [k8s-node-3]\n\nTASK [Join the cluster] ********************************************************************************************************************************************************************************\nchanged: [k8s-node-2]\nchanged: [k8s-node-3]\n\nPLAY [Play 3 - Display Final Access Information] *******************************************************************************************************************************************************\n\nTASK [Get Hubble UI service details] *******************************************************************************************************************************************************************\nok: [k8s-node-1]\n\nTASK [Display the final access URL] ********************************************************************************************************************************************************************\nok: [k8s-node-1] => {\n    \"msg\": \"========================================================\\n🚀 Your Kubernetes Lab is Ready!\\n\\nAccess the Hubble UI at:\\nhttp://10.75.59.81:31708\\n========================================================\\n\"\n}\n\nPLAY RECAP *********************************************************************************************************************************************************************************************\nk8s-node-1                 : ok=18   changed=12   unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   \nk8s-node-2                 : ok=3    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   \nk8s-node-3                 : ok=3    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   \n```\n\n# 9. 多次执行Playbook，验证幂等性。\n\n```bash\nois@ois:~/data/k8s-cilium-lab$ ansible-playbook playbooks/3_setup_cluster.yml --ask-become-pass\nBECOME password: \n[DEPRECATION WARNING]: community.kubernetes.helm_repository has been deprecated. The community.kubernetes collection is being renamed to kubernetes.core. Please update your FQCNs to kubernetes.core \ninstead. This feature will be removed from community.kubernetes in version 3.0.0. Deprecation warnings can be disabled by setting deprecation_warnings=False in ansible.cfg.\n[DEPRECATION WARNING]: community.kubernetes.helm has been deprecated. The community.kubernetes collection is being renamed to kubernetes.core. Please update your FQCNs to kubernetes.core instead. \nThis feature will be removed from community.kubernetes in version 3.0.0. Deprecation warnings can be disabled by setting deprecation_warnings=False in ansible.cfg.\n[DEPRECATION WARNING]: community.kubernetes.k8s has been deprecated. The community.kubernetes collection is being renamed to kubernetes.core. Please update your FQCNs to kubernetes.core instead. This\n feature will be removed from community.kubernetes in version 3.0.0. Deprecation warnings can be disabled by setting deprecation_warnings=False in ansible.cfg.\n[DEPRECATION WARNING]: community.kubernetes.k8s_info has been deprecated. The community.kubernetes collection is being renamed to kubernetes.core. Please update your FQCNs to kubernetes.core instead.\n This feature will be removed from community.kubernetes in version 3.0.0. Deprecation warnings can be disabled by setting deprecation_warnings=False in ansible.cfg.\n\nPLAY [Play 1 - Initialize and Configure Control Plane] *************************************************************************************************************************************************\n\nTASK [Gathering Facts] *********************************************************************************************************************************************************************************\nok: [k8s-node-1]\n\nTASK [Check if cluster is already initialized] *********************************************************************************************************************************************************\nok: [k8s-node-1]\n\nTASK [Initialize the cluster] **************************************************************************************************************************************************************************\nskipping: [k8s-node-1]\n\nTASK [Create .kube directory for ubuntu user] **********************************************************************************************************************************************************\nskipping: [k8s-node-1]\n\nTASK [Copy admin.conf to user's kube config] ***********************************************************************************************************************************************************\nskipping: [k8s-node-1]\n\nTASK [Set KUBECONFIG for root user permanently] ********************************************************************************************************************************************************\nok: [k8s-node-1]\n\nTASK [Install prerequisites for Kubernetes modules] ****************************************************************************************************************************************************\nok: [k8s-node-1]\n\nTASK [Install Helm] ************************************************************************************************************************************************************************************\nskipping: [k8s-node-1]\n\nTASK [Install Cilium CLI] ******************************************************************************************************************************************************************************\nskipping: [k8s-node-1]\n\nTASK [Add Helm repositories] ***************************************************************************************************************************************************************************\nok: [k8s-node-1] => (item={'name': 'cilium', 'url': 'https://helm.cilium.io/'})\nok: [k8s-node-1] => (item={'name': 'isovalent', 'url': 'https://helm.isovalent.com/'})\n\nTASK [Deploy Cilium and Hubble with Helm] **************************************************************************************************************************************************************\n[WARNING]: The default idempotency check can fail to report changes in certain cases. Install helm diff >= 3.4.1 for better results.\nok: [k8s-node-1]\n\nTASK [Expose Hubble UI service via NodePort] ***********************************************************************************************************************************************************\n[WARNING]: kubernetes<24.2.0 is not supported or tested. Some features may not work.\nok: [k8s-node-1]\n\nTASK [Wait for Cilium CRDs to become available] ********************************************************************************************************************************************************\nok: [k8s-node-1]\n\nTASK [Apply Cilium BGP Configuration from template] ****************************************************************************************************************************************************\nok: [k8s-node-1]\n\nTASK [Generate a token for workers to join] ************************************************************************************************************************************************************\nchanged: [k8s-node-1]\n\nTASK [Store the join command for other hosts to access] ************************************************************************************************************************************************\nok: [k8s-node-1]\n\nPLAY [Play 2 - Join Worker Nodes to the Fully Configured Cluster] **************************************************************************************************************************************\n\nTASK [Gathering Facts] *********************************************************************************************************************************************************************************\nok: [k8s-node-2]\nok: [k8s-node-3]\n\nTASK [Check if node has already joined] ****************************************************************************************************************************************************************\nok: [k8s-node-2]\nok: [k8s-node-3]\n\nTASK [Join the cluster] ********************************************************************************************************************************************************************************\nskipping: [k8s-node-2]\nskipping: [k8s-node-3]\n\nPLAY [Play 3 - Display Final Access Information] *******************************************************************************************************************************************************\n\nTASK [Get Hubble UI service details] *******************************************************************************************************************************************************************\nok: [k8s-node-1]\n\nTASK [Display the final access URL] ********************************************************************************************************************************************************************\nok: [k8s-node-1] => {\n    \"msg\": \"========================================================\\n🚀 Your Kubernetes Lab is Ready!\\n\\nAccess the Hubble UI at:\\nhttp://10.75.59.81:31708\\n========================================================\\n\"\n}\n\nPLAY RECAP *********************************************************************************************************************************************************************************************\nk8s-node-1                 : ok=13   changed=1    unreachable=0    failed=0    skipped=5    rescued=0    ignored=0   \nk8s-node-2                 : ok=2    changed=0    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   \nk8s-node-3                 : ok=2    changed=0    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   \n```\n\n# 10. 部署Demo App\n\n```bash\nois@ois:~/data/k8s-cilium-lab$ cd ../\nois@ois:~/data$ ./04-deploy-star-wars.sh \n--- Star Wars Demo Script Deployer ---\n\n--- Step 1: Verifying Project Context ---\n✅ Working inside project directory: /home/ois/data/k8s-cilium-lab\n\n--- Step 2: Generating the script template ---\n✅ Created template: templates/deploy-star-wars.sh.j2\n\n--- Step 3: Generating the deployment playbook ---\n✅ Created playbook: playbooks/4_deploy_app.yml\n\n--- Generation Complete! ---\n✅ All necessary files for deploying the application script have been created.\n\nNext Steps:\n1. Change into the project directory: cd k8s-cilium-lab\n2. Run the playbook to copy the script to your control plane node:\n   ansible-playbook playbooks/4_deploy_app.yml --ask-become-pass\n3. SSH into the control plane and run the script:\n   ssh ubuntu@k8s-node-1\n   sudo /root/deploy-star-wars.sh\nois@ois:~/data$ cd k8s-cilium-lab/\nois@ois:~/data/k8s-cilium-lab$ ansible-playbook playbooks/4_deploy_app.yml --ask-become-pass\nBECOME password: \n\nPLAY [Deploy Star Wars Demo Script] ********************************************************************************************************************************************************************\n\nTASK [Gathering Facts] *********************************************************************************************************************************************************************************\nok: [k8s-node-1]\n\nTASK [Copy the Star Wars deployment script to the control plane] ***************************************************************************************************************************************\nchanged: [k8s-node-1]\n\nPLAY RECAP *********************************************************************************************************************************************************************************************\nk8s-node-1                 : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   \n\nois@ois:~/data/k8s-cilium-lab$ \nois@ois:~/data/k8s-cilium-lab$ ssh ubuntu@10.75.59.81\nWelcome to Ubuntu 24.04.2 LTS (GNU/Linux 6.8.0-63-generic x86_64)\n\n * Documentation:  https://help.ubuntu.com\n * Management:     https://landscape.canonical.com\n * Support:        https://ubuntu.com/pro\n\n System information as of Mon Aug  4 05:00:52 PM CST 2025\n\n  System load:  0.26               Processes:               195\n  Usage of /:   33.4% of 18.33GB   Users logged in:         0\n  Memory usage: 16%                IPv4 address for enp1s0: 10.75.59.81\n  Swap usage:   0%\n\n\nExpanded Security Maintenance for Applications is not enabled.\n\n0 updates can be applied immediately.\n\nEnable ESM Apps to receive additional future security updates.\nSee https://ubuntu.com/esm or run: sudo pro status\n\n\n*** System restart required ***\nLast login: Mon Aug  4 16:55:53 2025 from 10.75.59.129\nubuntu@k8s-node-1:~$ sudo su\n[sudo] password for ubuntu: \nroot@k8s-node-1:/home/ubuntu# cd\nroot@k8s-node-1:~# cilium status\n    /¯¯\\\n /¯¯\\__/¯¯\\    Cilium:             OK\n \\__/¯¯\\__/    Operator:           OK\n /¯¯\\__/¯¯\\    Envoy DaemonSet:    OK\n \\__/¯¯\\__/    Hubble Relay:       OK\n    \\__/       ClusterMesh:        disabled\n\nDaemonSet              cilium                   Desired: 3, Ready: 3/3, Available: 3/3\nDaemonSet              cilium-envoy             Desired: 3, Ready: 3/3, Available: 3/3\nDeployment             cilium-operator          Desired: 2, Ready: 2/2, Available: 2/2\nDeployment             hubble-relay             Desired: 1, Ready: 1/1, Available: 1/1\nDeployment             hubble-ui                Desired: 1, Ready: 1/1, Available: 1/1\nContainers:            cilium                   Running: 3\n                       cilium-envoy             Running: 3\n                       cilium-operator          Running: 2\n                       clustermesh-apiserver    \n                       hubble-relay             Running: 1\n                       hubble-ui                Running: 1\nCluster Pods:          8/8 managed by Cilium\nHelm chart version:    1.17.6\nImage versions         cilium             quay.io/isovalent/cilium:v1.17.6-cee.1@sha256:2d01daf4f25f7d644889b49ca856e1a4269981fc963e50bd3962665b41b6adb3: 3\n                       cilium-envoy       quay.io/isovalent/cilium-envoy:v1.17.6-cee.1@sha256:318eff387835ca2717baab42a84f35a83a5f9e7d519253df87269f80b9ff0171: 3\n                       cilium-operator    quay.io/isovalent/operator-generic:v1.17.6-cee.1@sha256:2e602710a7c4f101831df679e5d8251bae8bf0f9fe26c20bbef87f1966ea8265: 2\n                       hubble-relay       quay.io/isovalent/hubble-relay:v1.17.6-cee.1@sha256:d378e3607f7492374e65e2bd854cc0ec87480c63ba49a96dadcd75a6946b586e: 1\n                       hubble-ui          quay.io/isovalent/hubble-ui-backend:v1.17.6-cee.1@sha256:a034b7e98e6ea796ed26df8f4e71f83fc16465a19d166eff67a03b822c0bfa15: 1\n                       hubble-ui          quay.io/isovalent/hubble-ui:v1.17.6-cee.1@sha256:9e37c1296b802830834cc87342a9182ccbb71ffebb711971e849221bd9d59392: 1\nroot@k8s-node-1:~# \nroot@k8s-node-1:~# ./deploy-star-wars.sh \n🚀 Starting Star Wars Demo Application Deployment...\n=================================================\n\n--- Step 1: Ensuring 'star-wars' namespace exists ---\n\n▶️  Running command:\n  kubectl create namespace star-wars\nnamespace/star-wars created\n✅ Namespace 'star-wars' created.\n\n--- Step 2: Applying application manifest from GitHub ---\n\n▶️  Running command:\n  kubectl apply -n star-wars -f https://raw.githubusercontent.com/cilium/cilium/HEAD/examples/minikube/http-sw-app.yaml\nservice/deathstar created\ndeployment.apps/deathstar created\npod/tiefighter created\npod/xwing created\n\n--- Step 3: Waiting for all application pods to be ready ---\n  (This may take a minute as images are pulled...)\n\n▶️  Running command:\n  kubectl wait --for=condition=ready pod --all -n star-wars --timeout=120s\npod/deathstar-86f85ffb4d-8xbb4 condition met\npod/deathstar-86f85ffb4d-dwfx5 condition met\npod/tiefighter condition met\npod/xwing condition met\n✅ All pods are running and ready.\n\n--- Step 4: Displaying pod status ---\n\n▶️  Running command:\n  kubectl -n star-wars get pod -o wide --show-labels\nNAME                         READY   STATUS    RESTARTS   AGE   IP             NODE         NOMINATED NODE   READINESS GATES   LABELS\ndeathstar-86f85ffb4d-8xbb4   1/1     Running   0          24s   172.16.2.92    k8s-node-3   <none>           <none>            app.kubernetes.io/name=deathstar,class=deathstar,org=empire,pod-template-hash=86f85ffb4d\ndeathstar-86f85ffb4d-dwfx5   1/1     Running   0          24s   172.16.1.198   k8s-node-2   <none>           <none>            app.kubernetes.io/name=deathstar,class=deathstar,org=empire,pod-template-hash=86f85ffb4d\ntiefighter                   1/1     Running   0          24s   172.16.2.180   k8s-node-3   <none>           <none>            app.kubernetes.io/name=tiefighter,class=tiefighter,org=empire\nxwing                        1/1     Running   0          24s   172.16.2.156   k8s-node-3   <none>           <none>            app.kubernetes.io/name=xwing,class=xwing,org=alliance\n\n--- Step 5: Exposing 'deathstar' service via NodePort ---\n\n▶️  Running command:\n  kubectl -n star-wars patch service deathstar -p {\"spec\":{\"type\":\"NodePort\"}}\nservice/deathstar patched\n✅ Service 'deathstar' patched to NodePort.\n\n--- Step 6: Testing connectivity from client pods ---\n  (A 'Ship landed' message indicates success)\n\n▶️  Running command:\n  kubectl -n star-wars exec tiefighter -- curl -s -XPOST http://deathstar.star-wars.svc.cluster.local/v1/request-landing\nShip landed\n\n▶️  Running command:\n  kubectl -n star-wars exec xwing -- curl -s -XPOST http://deathstar.star-wars.svc.cluster.local/v1/request-landing\nShip landed\n\n--- Step 7: Displaying external access information ---\n\n=================================================\n🎉 Star Wars Demo Application Deployed Successfully!\n   You can access the Deathstar service from outside the cluster at:\n   curl -XPOST http://10.75.59.81:30719/v1/request-landing\n=================================================\nroot@k8s-node-1:~# curl -XPOST http://10.75.59.81:30719/v1/request-landing\nShip landed\nroot@k8s-node-1:~# exit\nexit\nubuntu@k8s-node-1:~$ curl -XPOST http://10.75.59.81:30719/v1/request-landing\nShip landed\nroot@k8s-node-1:~# kubectl get nodes -o wide\nNAME         STATUS   ROLES           AGE   VERSION   INTERNAL-IP   EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION     CONTAINER-RUNTIME\nk8s-node-1   Ready    control-plane   21m   v1.33.3   10.75.59.81   <none>        Ubuntu 24.04.2 LTS   6.8.0-63-generic   containerd://1.7.27\nk8s-node-2   Ready    <none>          19m   v1.33.3   10.75.59.82   <none>        Ubuntu 24.04.2 LTS   6.8.0-63-generic   containerd://1.7.27\nk8s-node-3   Ready    <none>          19m   v1.33.3   10.75.59.83   <none>        Ubuntu 24.04.2 LTS   6.8.0-63-generic   containerd://1.7.27\nroot@k8s-node-1:~# kubectl get pods -A -o wide\nNAMESPACE     NAME                                 READY   STATUS    RESTARTS   AGE   IP             NODE         NOMINATED NODE   READINESS GATES\nkube-system   cilium-45qr7                         1/1     Running   0          19m   10.75.59.83    k8s-node-3   <none>           <none>\nkube-system   cilium-9q5s7                         1/1     Running   0          19m   10.75.59.82    k8s-node-2   <none>           <none>\nkube-system   cilium-envoy-72jj7                   1/1     Running   0          19m   10.75.59.82    k8s-node-2   <none>           <none>\nkube-system   cilium-envoy-d8hb4                   1/1     Running   0          20m   10.75.59.81    k8s-node-1   <none>           <none>\nkube-system   cilium-envoy-vvsms                   1/1     Running   0          19m   10.75.59.83    k8s-node-3   <none>           <none>\nkube-system   cilium-operator-d67c55dc8-lfpjb      1/1     Running   0          20m   10.75.59.81    k8s-node-1   <none>           <none>\nkube-system   cilium-operator-d67c55dc8-rpfv8      1/1     Running   0          20m   10.75.59.82    k8s-node-2   <none>           <none>\nkube-system   cilium-xbjqm                         1/1     Running   0          20m   10.75.59.81    k8s-node-1   <none>           <none>\nkube-system   coredns-674b8bbfcf-n9wgt             1/1     Running   0          21m   172.16.0.105   k8s-node-1   <none>           <none>\nkube-system   coredns-674b8bbfcf-ntssg             1/1     Running   0          21m   172.16.0.161   k8s-node-1   <none>           <none>\nkube-system   etcd-k8s-node-1                      1/1     Running   0          21m   10.75.59.81    k8s-node-1   <none>           <none>\nkube-system   hubble-relay-cfb755899-46pzc         1/1     Running   0          20m   172.16.1.115   k8s-node-2   <none>           <none>\nkube-system   hubble-ui-68c64498c4-p2nq4           2/2     Running   0          20m   172.16.1.105   k8s-node-2   <none>           <none>\nkube-system   kube-apiserver-k8s-node-1            1/1     Running   0          21m   10.75.59.81    k8s-node-1   <none>           <none>\nkube-system   kube-controller-manager-k8s-node-1   1/1     Running   0          21m   10.75.59.81    k8s-node-1   <none>           <none>\nkube-system   kube-scheduler-k8s-node-1            1/1     Running   0          21m   10.75.59.81    k8s-node-1   <none>           <none>\nstar-wars     deathstar-86f85ffb4d-8xbb4           1/1     Running   0          12m   172.16.2.92    k8s-node-3   <none>           <none>\nstar-wars     deathstar-86f85ffb4d-dwfx5           1/1     Running   0          12m   172.16.1.198   k8s-node-2   <none>           <none>\nstar-wars     tiefighter                           1/1     Running   0          12m   172.16.2.180   k8s-node-3   <none>           <none>\nstar-wars     xwing                                1/1     Running   0          12m   172.16.2.156   k8s-node-3   <none>           <none>\nroot@k8s-node-1:~# kubectl get deployment -A -o wide\nNAMESPACE     NAME              READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS         IMAGES                                                                                                                                                                                                                                        SELECTOR\nkube-system   cilium-operator   2/2     2            2           21m   cilium-operator    quay.io/isovalent/operator-generic:v1.17.6-cee.1@sha256:2e602710a7c4f101831df679e5d8251bae8bf0f9fe26c20bbef87f1966ea8265                                                                                                                      io.cilium/app=operator,name=cilium-operator\nkube-system   coredns           2/2     2            2           22m   coredns            registry.k8s.io/coredns/coredns:v1.12.0                                                                                                                                                                                                       k8s-app=kube-dns\nkube-system   hubble-relay      1/1     1            1           21m   hubble-relay       quay.io/isovalent/hubble-relay:v1.17.6-cee.1@sha256:d378e3607f7492374e65e2bd854cc0ec87480c63ba49a96dadcd75a6946b586e                                                                                                                          k8s-app=hubble-relay\nkube-system   hubble-ui         1/1     1            1           21m   frontend,backend   quay.io/isovalent/hubble-ui:v1.17.6-cee.1@sha256:9e37c1296b802830834cc87342a9182ccbb71ffebb711971e849221bd9d59392,quay.io/isovalent/hubble-ui-backend:v1.17.6-cee.1@sha256:a034b7e98e6ea796ed26df8f4e71f83fc16465a19d166eff67a03b822c0bfa15   k8s-app=hubble-ui\nstar-wars     deathstar         2/2     2            2           12m   deathstar          quay.io/cilium/starwars@sha256:896dc536ec505778c03efedb73c3b7b83c8de11e74264c8c35291ff6d5fe8ada                                                                                                                                               class=deathstar,org=empire\n\n```\n# 11. 系统信息探索\n## 11.1 K8S 和 Cilium相关信息\n```bash\nroot@k8s-node-1:~# helm get values cilium -n kube-system\nUSER-SUPPLIED VALUES:\nautoDirectNodeRoutes: true\nbgpControlPlane:\n  announce:\n    podCIDR: true\n  enabled: true\nbpf:\n  lb:\n    externalClusterIP: true\n    sock: true\n  masquerade: true\nenableIPv4Masquerade: true\nhubble:\n  enabled: true\n  relay:\n    enabled: true\n  ui:\n    enabled: true\nipam:\n  mode: kubernetes\nipv4NativeRoutingCIDR: 172.16.0.0/20\nk8s:\n  requireIPv4PodCIDR: true\nk8sServiceHost: 10.75.59.81\nk8sServicePort: 6443\nkubeProxyReplacement: true\nroutingMode: native\nroot@k8s-node-1:~# \nroot@k8s-node-1:~# kubectl -n kube-system get configmap cilium-config -o yaml\napiVersion: v1\ndata:\n  agent-not-ready-taint-key: node.cilium.io/agent-not-ready\n  arping-refresh-period: 30s\n  auto-direct-node-routes: \"true\"\n  bgp-secrets-namespace: kube-system\n  bpf-distributed-lru: \"false\"\n  bpf-events-drop-enabled: \"true\"\n  bpf-events-policy-verdict-enabled: \"true\"\n  bpf-events-trace-enabled: \"true\"\n  bpf-lb-acceleration: disabled\n  bpf-lb-algorithm-annotation: \"false\"\n  bpf-lb-external-clusterip: \"false\"\n  bpf-lb-map-max: \"65536\"\n  bpf-lb-mode-annotation: \"false\"\n  bpf-lb-sock: \"false\"\n  bpf-lb-source-range-all-types: \"false\"\n  bpf-map-dynamic-size-ratio: \"0.0025\"\n  bpf-policy-map-max: \"16384\"\n  bpf-root: /sys/fs/bpf\n  cgroup-root: /run/cilium/cgroupv2\n  cilium-endpoint-gc-interval: 5m0s\n  cluster-id: \"0\"\n  cluster-name: default\n  clustermesh-enable-endpoint-sync: \"false\"\n  clustermesh-enable-mcs-api: \"false\"\n  cni-exclusive: \"true\"\n  cni-log-file: /var/run/cilium/cilium-cni.log\n  custom-cni-conf: \"false\"\n  datapath-mode: veth\n  debug: \"false\"\n  debug-verbose: \"\"\n  default-lb-service-ipam: lbipam\n  direct-routing-skip-unreachable: \"false\"\n  dnsproxy-enable-transparent-mode: \"true\"\n  dnsproxy-socket-linger-timeout: \"10\"\n  egress-gateway-ha-reconciliation-trigger-interval: 1s\n  egress-gateway-reconciliation-trigger-interval: 1s\n  enable-auto-protect-node-port-range: \"true\"\n  enable-bfd: \"false\"\n  enable-bgp-control-plane: \"true\"\n  enable-bgp-control-plane-status-report: \"true\"\n  enable-bpf-clock-probe: \"false\"\n  enable-bpf-masquerade: \"true\"\n  enable-cluster-aware-addressing: \"false\"\n  enable-egress-gateway-ha-socket-termination: \"false\"\n  enable-endpoint-health-checking: \"true\"\n  enable-endpoint-lockdown-on-policy-overflow: \"false\"\n  enable-experimental-lb: \"false\"\n  enable-health-check-loadbalancer-ip: \"false\"\n  enable-health-check-nodeport: \"true\"\n  enable-health-checking: \"true\"\n  enable-hubble: \"true\"\n  enable-inter-cluster-snat: \"false\"\n  enable-internal-traffic-policy: \"true\"\n  enable-ipv4: \"true\"\n  enable-ipv4-big-tcp: \"false\"\n  enable-ipv4-masquerade: \"true\"\n  enable-ipv6: \"false\"\n  enable-ipv6-big-tcp: \"false\"\n  enable-ipv6-masquerade: \"true\"\n  enable-k8s-networkpolicy: \"true\"\n  enable-k8s-terminating-endpoint: \"true\"\n  enable-l2-neigh-discovery: \"true\"\n  enable-l7-proxy: \"true\"\n  enable-lb-ipam: \"true\"\n  enable-local-redirect-policy: \"false\"\n  enable-masquerade-to-route-source: \"false\"\n  enable-metrics: \"true\"\n  enable-node-selector-labels: \"false\"\n  enable-non-default-deny-policies: \"false\"\n  enable-phantom-services: \"false\"\n  enable-policy: default\n  enable-policy-secrets-sync: \"true\"\n  enable-runtime-device-detection: \"true\"\n  enable-sctp: \"false\"\n  enable-source-ip-verification: \"true\"\n  enable-srv6: \"false\"\n  enable-svc-source-range-check: \"true\"\n  enable-tcx: \"true\"\n  enable-vtep: \"false\"\n  enable-well-known-identities: \"false\"\n  enable-xt-socket-fallback: \"true\"\n  envoy-access-log-buffer-size: \"4096\"\n  envoy-base-id: \"0\"\n  envoy-keep-cap-netbindservice: \"false\"\n  export-aggregation: \"\"\n  export-aggregation-renew-ttl: \"true\"\n  export-aggregation-state-filter: \"\"\n  export-file-path: \"\"\n  external-envoy-proxy: \"true\"\n  feature-gates-approved: \"\"\n  feature-gates-strict: \"true\"\n  health-check-icmp-failure-threshold: \"3\"\n  http-retry-count: \"3\"\n  hubble-disable-tls: \"false\"\n  hubble-export-file-max-backups: \"5\"\n  hubble-export-file-max-size-mb: \"10\"\n  hubble-listen-address: :4244\n  hubble-socket-path: /var/run/cilium/hubble.sock\n  hubble-tls-cert-file: /var/lib/cilium/tls/hubble/server.crt\n  hubble-tls-client-ca-files: /var/lib/cilium/tls/hubble/client-ca.crt\n  hubble-tls-key-file: /var/lib/cilium/tls/hubble/server.key\n  identity-allocation-mode: crd\n  identity-gc-interval: 15m0s\n  identity-heartbeat-timeout: 30m0s\n  install-no-conntrack-iptables-rules: \"false\"\n  ipam: kubernetes\n  ipam-cilium-node-update-rate: 15s\n  iptables-random-fully: \"false\"\n  ipv4-native-routing-cidr: 172.16.0.0/20\n  k8s-require-ipv4-pod-cidr: \"true\"\n  k8s-require-ipv6-pod-cidr: \"false\"\n  kube-proxy-replacement: \"true\"\n  kube-proxy-replacement-healthz-bind-address: \"\"\n  max-connected-clusters: \"255\"\n  mesh-auth-enabled: \"true\"\n  mesh-auth-gc-interval: 5m0s\n  mesh-auth-queue-size: \"1024\"\n  mesh-auth-rotated-identities-queue-size: \"1024\"\n  monitor-aggregation: medium\n  monitor-aggregation-flags: all\n  monitor-aggregation-interval: 5s\n  multicast-enabled: \"false\"\n  nat-map-stats-entries: \"32\"\n  nat-map-stats-interval: 30s\n  node-port-bind-protection: \"true\"\n  nodeport-addresses: \"\"\n  nodes-gc-interval: 5m0s\n  operator-api-serve-addr: 127.0.0.1:9234\n  operator-prometheus-serve-addr: :9963\n  policy-cidr-match-mode: \"\"\n  policy-secrets-namespace: cilium-secrets\n  policy-secrets-only-from-secrets-namespace: \"true\"\n  preallocate-bpf-maps: \"false\"\n  procfs: /host/proc\n  proxy-connect-timeout: \"2\"\n  proxy-idle-timeout-seconds: \"60\"\n  proxy-initial-fetch-timeout: \"30\"\n  proxy-max-concurrent-retries: \"128\"\n  proxy-max-connection-duration-seconds: \"0\"\n  proxy-max-requests-per-connection: \"0\"\n  proxy-xff-num-trusted-hops-egress: \"0\"\n  proxy-xff-num-trusted-hops-ingress: \"0\"\n  remove-cilium-node-taints: \"true\"\n  routing-mode: native\n  service-no-backend-response: reject\n  set-cilium-is-up-condition: \"true\"\n  set-cilium-node-taints: \"true\"\n  srv6-encap-mode: reduced\n  srv6-locator-pool-enabled: \"false\"\n  synchronize-k8s-nodes: \"true\"\n  tofqdns-dns-reject-response-code: refused\n  tofqdns-enable-dns-compression: \"true\"\n  tofqdns-endpoint-max-ip-per-hostname: \"1000\"\n  tofqdns-idle-connection-grace-period: 0s\n  tofqdns-max-deferred-connection-deletes: \"10000\"\n  tofqdns-proxy-response-max-delay: 100ms\n  tunnel-protocol: vxlan\n  tunnel-source-port-range: 0-0\n  unmanaged-pod-watcher-interval: \"15\"\n  vtep-cidr: \"\"\n  vtep-endpoint: \"\"\n  vtep-mac: \"\"\n  vtep-mask: \"\"\n  write-cni-conf-when-ready: /host/etc/cni/net.d/05-cilium.conflist\nkind: ConfigMap\nmetadata:\n  annotations:\n    meta.helm.sh/release-name: cilium\n    meta.helm.sh/release-namespace: kube-system\n  creationTimestamp: \"2025-08-04T08:52:46Z\"\n  labels:\n    app.kubernetes.io/managed-by: Helm\n  name: cilium-config\n  namespace: kube-system\n  resourceVersion: \"436\"\n  uid: 614c6b36-9112-4fd0-bebf-e92741fa28da\nroot@k8s-node-1:~# kubectl exec -n kube-system -it cilium-45qr7 -- /bin/sh\nDefaulted container \"cilium-agent\" out of: cilium-agent, config (init), mount-cgroup (init), apply-sysctl-overwrites (init), mount-bpf-fs (init), clean-cilium-state (init), install-cni-binaries (init)\n/home/cilium # cilium status\nKVStore:                 Disabled   \nKubernetes:              Ok         1.33 (v1.33.3) [linux/amd64]\nKubernetes APIs:         [\"EndpointSliceOrEndpoint\", \"cilium/v2::CiliumClusterwideNetworkPolicy\", \"cilium/v2::CiliumEndpoint\", \"cilium/v2::CiliumNetworkPolicy\", \"cilium/v2::CiliumNode\", \"cilium/v2alpha1::CiliumCIDRGroup\", \"core/v1::Namespace\", \"core/v1::Pods\", \"core/v1::Service\", \"isovalent/v1alpha1::IsovalentClusterwideNetworkPolicy\", \"isovalent/v1alpha1::IsovalentNetworkPolicy\", \"networking.k8s.io/v1::NetworkPolicy\"]\nKubeProxyReplacement:    True   [enp1s0   10.75.59.83 fe80::5054:ff:fead:b814 (Direct Routing)]\nHost firewall:           Disabled\nSRv6:                    Disabled\nCNI Chaining:            none\nCNI Config file:         successfully wrote CNI configuration file to /host/etc/cni/net.d/05-cilium.conflist\nCilium:                  Ok   1.17.6-cee.1 (v1.17.6-cee.1-a33b0b85)\nNodeMonitor:             Listening for events on 4 CPUs with 64x4096 of shared memory\nCilium health daemon:    Ok   \nIPAM:                    IPv4: 5/254 allocated from 172.16.2.0/24, \nIPv4 BIG TCP:            Disabled\nIPv6 BIG TCP:            Disabled\nBandwidthManager:        Disabled\nRouting:                 Network: Native   Host: BPF\nAttach Mode:             TCX\nDevice Mode:             veth\nMasquerading:            BPF   [enp1s0]   172.16.0.0/20 [IPv4: Enabled, IPv6: Disabled]\nController Status:       36/36 healthy\nProxy Status:            OK, ip 172.16.2.88, 0 redirects active on ports 10000-20000, Envoy: external\nGlobal Identity Range:   min 256, max 65535\nHubble:                  Ok              Current/Max Flows: 2522/4095 (61.59%), Flows/s: 1.51   Metrics: Disabled\nEncryption:              Disabled        \nCluster health:          3/3 reachable   (2025-08-04T09:21:04Z)\nName                     IP              Node   Endpoints\nModules Health:          Stopped(0) Degraded(0) OK(68)\n/home/cilium # cilium status --verbose\nKVStore:                Disabled   \nKubernetes:             Ok         1.33 (v1.33.3) [linux/amd64]\nKubernetes APIs:        [\"EndpointSliceOrEndpoint\", \"cilium/v2::CiliumClusterwideNetworkPolicy\", \"cilium/v2::CiliumEndpoint\", \"cilium/v2::CiliumNetworkPolicy\", \"cilium/v2::CiliumNode\", \"cilium/v2alpha1::CiliumCIDRGroup\", \"core/v1::Namespace\", \"core/v1::Pods\", \"core/v1::Service\", \"isovalent/v1alpha1::IsovalentClusterwideNetworkPolicy\", \"isovalent/v1alpha1::IsovalentNetworkPolicy\", \"networking.k8s.io/v1::NetworkPolicy\"]\nKubeProxyReplacement:   True   [enp1s0   10.75.59.83 fe80::5054:ff:fead:b814 (Direct Routing)]\nHost firewall:          Disabled\nSRv6:                   Disabled\nCNI Chaining:           none\nCNI Config file:        successfully wrote CNI configuration file to /host/etc/cni/net.d/05-cilium.conflist\nCilium:                 Ok   1.17.6-cee.1 (v1.17.6-cee.1-a33b0b85)\nNodeMonitor:            Listening for events on 4 CPUs with 64x4096 of shared memory\nCilium health daemon:   Ok   \nIPAM:                   IPv4: 5/254 allocated from 172.16.2.0/24, \nAllocated addresses:\n  172.16.2.156 (star-wars/xwing)\n  172.16.2.180 (star-wars/tiefighter)\n  172.16.2.35 (health)\n  172.16.2.88 (router)\n  172.16.2.92 (star-wars/deathstar-86f85ffb4d-8xbb4)\nIPv4 BIG TCP:           Disabled\nIPv6 BIG TCP:           Disabled\nBandwidthManager:       Disabled\nRouting:                Network: Native   Host: BPF\nAttach Mode:            TCX\nDevice Mode:            veth\nMasquerading:           BPF   [enp1s0]   172.16.0.0/20 [IPv4: Enabled, IPv6: Disabled]\nClock Source for BPF:   ktime\nController Status:      36/36 healthy\n  Name                                                  Last success   Last error   Count   Message\n  cilium-health-ep                                      1m0s ago       never        0       no error   \n  ct-map-pressure                                       1s ago         never        0       no error   \n  daemon-validate-config                                35s ago        never        0       no error   \n  dns-garbage-collector-job                             3s ago         never        0       no error   \n  endpoint-1375-regeneration-recovery                   never          never        0       no error   \n  endpoint-196-regeneration-recovery                    never          never        0       no error   \n  endpoint-2338-regeneration-recovery                   never          never        0       no error   \n  endpoint-523-regeneration-recovery                    never          never        0       no error   \n  endpoint-640-regeneration-recovery                    never          never        0       no error   \n  endpoint-gc                                           2m3s ago       never        0       no error   \n  endpoint-periodic-regeneration                        1m3s ago       never        0       no error   \n  ep-bpf-prog-watchdog                                  1s ago         never        0       no error   \n  ipcache-inject-labels                                 1s ago         never        0       no error   \n  k8s-heartbeat                                         3s ago         never        0       no error   \n  link-cache                                            3s ago         never        0       no error   \n  node-neighbor-link-updater                            1s ago         never        0       no error   \n  proxy-ports-checkpoint                                27m1s ago      never        0       no error   \n  resolve-identity-1375                                 2m0s ago       never        0       no error   \n  resolve-identity-196                                  1m41s ago      never        0       no error   \n  resolve-identity-2338                                 1m41s ago      never        0       no error   \n  resolve-identity-523                                  2m1s ago       never        0       no error   \n  resolve-identity-640                                  1m41s ago      never        0       no error   \n  resolve-labels-star-wars/deathstar-86f85ffb4d-8xbb4   21m41s ago     never        0       no error   \n  resolve-labels-star-wars/tiefighter                   21m41s ago     never        0       no error   \n  resolve-labels-star-wars/xwing                        21m41s ago     never        0       no error   \n  sync-lb-maps-with-k8s-services                        27m1s ago      never        0       no error   \n  sync-policymap-1375                                   11m56s ago     never        0       no error   \n  sync-policymap-196                                    6m41s ago      never        0       no error   \n  sync-policymap-2338                                   6m41s ago      never        0       no error   \n  sync-policymap-523                                    11m57s ago     never        0       no error   \n  sync-policymap-640                                    6m41s ago      never        0       no error   \n  sync-to-k8s-ciliumendpoint (196)                      1s ago         never        0       no error   \n  sync-to-k8s-ciliumendpoint (2338)                     1s ago         never        0       no error   \n  sync-to-k8s-ciliumendpoint (640)                      1s ago         never        0       no error   \n  sync-utime                                            1s ago         never        0       no error   \n  write-cni-file                                        27m3s ago      never        0       no error   \nProxy Status:            OK, ip 172.16.2.88, 0 redirects active on ports 10000-20000, Envoy: external\nGlobal Identity Range:   min 256, max 65535\nHubble:                  Ok   Current/Max Flows: 2570/4095 (62.76%), Flows/s: 1.51   Metrics: Disabled\nKubeProxyReplacement Details:\n  Status:                 True\n  Socket LB:              Enabled\n  Socket LB Tracing:      Enabled\n  Socket LB Coverage:     Full\n  Devices:                enp1s0   10.75.59.83 fe80::5054:ff:fead:b814 (Direct Routing)\n  Mode:                   SNAT\n  Backend Selection:      Random\n  Session Affinity:       Enabled\n  Graceful Termination:   Enabled\n  NAT46/64 Support:       Disabled\n  XDP Acceleration:       Disabled\n  Services:\n  - ClusterIP:      Enabled\n  - NodePort:       Enabled (Range: 30000-32767) \n  - LoadBalancer:   Enabled \n  - externalIPs:    Enabled \n  - HostPort:       Enabled\n  Annotations:\n  - service.cilium.io/node\n  - service.cilium.io/src-ranges-policy\n  - service.cilium.io/type\nBPF Maps:   dynamic sizing: on (ratio: 0.002500)\n  Name                          Size\n  Auth                          524288\n  Non-TCP connection tracking   65536\n  TCP connection tracking       131072\n  Endpoint policy               65535\n  IP cache                      512000\n  IPv4 masquerading agent       16384\n  IPv6 masquerading agent       16384\n  IPv4 fragmentation            8192\n  IPv4 service                  65536\n  IPv6 service                  65536\n  IPv4 service backend          65536\n  IPv6 service backend          65536\n  IPv4 service reverse NAT      65536\n  IPv6 service reverse NAT      65536\n  Metrics                       1024\n  Ratelimit metrics             64\n  NAT                           131072\n  Neighbor table                131072\n  Global policy                 16384\n  Session affinity              65536\n  Sock reverse NAT              65536\nEncryption:       Disabled        \nCluster health:   3/3 reachable   (2025-08-04T09:21:04Z)\nName              IP              Node   Endpoints\n  k8s-node-3 (localhost):\n    Host connectivity to 10.75.59.83:\n      ICMP to stack:   OK, RTT=451.197µs\n      HTTP to agent:   OK, RTT=625.346µs\n    Endpoint connectivity to 172.16.2.35:\n      ICMP to stack:   OK, RTT=376.939µs\n      HTTP to agent:   OK, RTT=882.754µs\n  k8s-node-1:\n    Host connectivity to 10.75.59.81:\n      ICMP to stack:   OK, RTT=582.892µs\n      HTTP to agent:   OK, RTT=1.042743ms\n    Endpoint connectivity to 172.16.0.116:\n      ICMP to stack:   OK, RTT=703.331µs\n      HTTP to agent:   OK, RTT=1.533329ms\n  k8s-node-2:\n    Host connectivity to 10.75.59.82:\n      ICMP to stack:   OK, RTT=632.658µs\n      HTTP to agent:   OK, RTT=1.156736ms\n    Endpoint connectivity to 172.16.1.173:\n      ICMP to stack:   OK, RTT=636.518µs\n      HTTP to agent:   OK, RTT=1.37198ms\nModules Health:\n      enterprise-agent\n      ├── agent\n      │   ├── controlplane\n      │   │   ├── auth\n      │   │   │   ├── observer-job-auth-gc-identity-events            [OK] OK (1.812µs) [5] (21m, x1)\n      │   │   │   ├── observer-job-auth-request-authentication        [OK] Primed (27m, x1)\n      │   │   │   └── timer-job-auth-gc-cleanup                       [OK] OK (15.847µs) (2m3s, x1)\n      │   │   ├── bgp-control-plane\n      │   │   │   ├── job-bgp-controller                              [OK] Running (27m, x1)\n      │   │   │   ├── job-bgp-crd-status-initialize                   [OK] Running (27m, x1)\n      │   │   │   ├── job-bgp-crd-status-update-job                   [OK] Running (27m, x1)\n      │   │   │   ├── job-bgp-policy-observer                         [OK] Running (27m, x1)\n      │   │   │   ├── job-bgp-reconcile-error-statedb-tracker         [OK] Running (27m, x1)\n      │   │   │   ├── job-bgp-state-observer                          [OK] Running (27m, x1)\n      │   │   │   ├── job-bgpcp-resource-store-events                 [OK] Running (27m, x5)\n      │   │   │   └── job-diffstore-events                            [OK] Running (27m, x2)\n      │   │   ├── ciliumenvoyconfig\n      │   │   │   └── experimental\n      │   │   │       ├── job-reconcile                               [OK] OK, 0 object(s) (27m, x3)\n      │   │   │       └── job-refresh                                 [OK] Next refresh in 30m0s (27m, x1)\n      │   │   ├── daemon\n      │   │   │   ├──                                                 [OK] daemon-validate-config (35s, x27)\n      │   │   │   ├── ep-bpf-prog-watchdog\n      │   │   │   │   └── ep-bpf-prog-watchdog                        [OK] ep-bpf-prog-watchdog (1s, x55)\n      │   │   │   └── job-sync-hostips                                [OK] Synchronized (1s, x29)\n      │   │   ├── dynamic-lifecycle-manager\n      │   │   │   ├── job-reconcile                                   [OK] OK, 0 object(s) (27m, x3)\n      │   │   │   └── job-refresh                                     [OK] Next refresh in 30m0s (27m, x1)\n      │   │   ├── enabled-features\n      │   │   │   └── job-update-config-metric                        [OK] Waiting for agent config (27m, x1)\n      │   │   ├── endpoint-manager\n      │   │   │   ├── cilium-endpoint-1375 (/)\n      │   │   │   │   ├── datapath-regenerate                         [OK] Endpoint regeneration successful (63s, x15)\n      │   │   │   │   └── policymap-sync                              [OK] sync-policymap-1375 (11m, x2)\n      │   │   │   ├── cilium-endpoint-196 (star-wars/xwing)\n      │   │   │   │   ├── cep-k8s-sync                                [OK] sync-to-k8s-ciliumendpoint (196) (1s, x132)\n      │   │   │   │   ├── datapath-regenerate                         [OK] Endpoint regeneration successful (63s, x12)\n      │   │   │   │   └── policymap-sync                              [OK] sync-policymap-196 (6m41s, x2)\n      │   │   │   ├── cilium-endpoint-2338 (star-wars/tiefighter)\n      │   │   │   │   ├── cep-k8s-sync                                [OK] sync-to-k8s-ciliumendpoint (2338) (1s, x132)\n      │   │   │   │   ├── datapath-regenerate                         [OK] Endpoint regeneration successful (63s, x12)\n      │   │   │   │   └── policymap-sync                              [OK] sync-policymap-2338 (6m41s, x2)\n      │   │   │   ├── cilium-endpoint-523 (/)\n      │   │   │   │   ├── datapath-regenerate                         [OK] Endpoint regeneration successful (63s, x16)\n      │   │   │   │   └── policymap-sync                              [OK] sync-policymap-523 (11m, x2)\n      │   │   │   ├── cilium-endpoint-640 (star-wars/deathstar-86f85ffb4d-8xbb4)\n      │   │   │   │   ├── cep-k8s-sync                                [OK] sync-to-k8s-ciliumendpoint (640) (1s, x132)\n      │   │   │   │   ├── datapath-regenerate                         [OK] Endpoint regeneration successful (63s, x12)\n      │   │   │   │   └── policymap-sync                              [OK] sync-policymap-640 (6m41s, x2)\n      │   │   │   └── endpoint-gc                                     [OK] endpoint-gc (2m3s, x6)\n      │   │   ├── envoy-proxy\n      │   │   │   ├── observer-job-k8s-secrets-resource-events-cilium-secrets    [OK] Primed (27m, x1)\n      │   │   │   └── timer-job-version-check                         [OK] OK (13.805158ms) (2m1s, x1)\n      │   │   ├── hubble\n      │   │   │   └── job-hubble                                      [OK] Running (27m, x1)\n      │   │   ├── identity\n      │   │   │   └── timer-job-id-alloc-update-policy-maps           [OK] OK (103.031µs) (21m, x1)\n      │   │   ├── l2-announcer\n      │   │   │   └── job-l2-announcer-lease-gc                       [OK] Running (27m, x1)\n      │   │   ├── nat-stats\n      │   │   │   └── timer-job-nat-stats                             [OK] OK (2.520538ms) (1s, x1)\n      │   │   ├── node-manager\n      │   │   │   ├── background-sync                                 [OK] Node validation successful (66s, x19)\n      │   │   │   ├── neighbor-link-updater\n      │   │   │   │   ├── k8s-node-1                                  [OK] Node neighbor link update successful (61s, x20)\n      │   │   │   │   └── k8s-node-2                                  [OK] Node neighbor link update successful (31s, x20)\n      │   │   │   ├── node-checkpoint-writer                          [OK] node checkpoint written (25m, x3)\n      │   │   │   └── nodes-add                                       [OK] Node adds successful (27m, x3)\n      │   │   ├── policy\n      │   │   │   └── observer-job-policy-importer                    [OK] Primed (27m, x1)\n      │   │   ├── service-manager\n      │   │   │   ├── job-health-check-event-watcher                  [OK] Waiting for health check events (27m, x1)\n      │   │   │   └── job-service-reconciler                          [OK] 1 NodePort frontend addresses (27m, x1)\n      │   │   ├── service-resolver\n      │   │   │   └── job-service-reloader-initializer                [OK] Running (27m, x1)\n      │   │   └── stale-endpoint-cleanup\n      │   │       └── job-endpoint-cleanup                            [OK] Running (27m, x1)\n      │   ├── datapath\n      │   │   ├── agent-liveness-updater\n      │   │   │   └── timer-job-agent-liveness-updater                [OK] OK (82.885µs) (0s, x1)\n      │   │   ├── iptables\n      │   │   │   ├── ipset\n      │   │   │   │   ├── job-ipset-init-finalizer                    [OK] Running (27m, x1)\n      │   │   │   │   ├── job-reconcile                               [OK] OK, 0 object(s) (27m, x2)\n      │   │   │   │   └── job-refresh                                 [OK] Next refresh in 30m0s (27m, x1)\n      │   │   │   └── job-iptables-reconciliation-loop                [OK] iptables rules full reconciliation completed (27m, x1)\n      │   │   ├── l2-responder\n      │   │   │   └── job-l2-responder-reconciler                     [OK] Running (27m, x1)\n      │   │   ├── maps\n      │   │   │   └── bwmap\n      │   │   │       └── timer-job-pressure-metric-throttle          [OK] OK (18.336µs) (1s, x1)\n      │   │   ├── mtu\n      │   │   │   ├── job-endpoint-mtu-updater                        [OK] Endpoint MTU updated (27m, x1)\n      │   │   │   └── job-mtu-updater                                 [OK] MTU updated (1500) (27m, x1)\n      │   │   ├── node-address\n      │   │   │   └── job-node-address-update                         [OK] 172.16.2.88 (primary), fe80::7019:6fff:febf:e8a7 (primary) (27m, x1)\n      │   │   ├── orchestrator\n      │   │   │   └── job-reinitialize                                [OK] OK (26m, x2)\n      │   │   └── sysctl\n      │   │       ├── job-reconcile                                   [OK] OK, 16 object(s) (6m56s, x35)\n      │   │       └── job-refresh                                     [OK] Next refresh in 9m53.185634443s (6m56s, x1)\n      │   └── infra\n      │       ├── k8s-synced-crdsync\n      │       │   └── job-sync-crds                                   [OK] Running (27m, x1)\n      │       ├── metrics\n      │       │   ├── job-collect                                     [OK] Sampled 24 metrics in 4.183045ms, next collection at 2025-08-04 09:26:00.386029804 +0000 UTC m=+1803.177514891 (2m1s, x1)\n      │       │   └── timer-job-cleanup                               [OK] Primed (27m, x1)\n      │       └── shell\n      │           └── job-listener                                    [OK] Listening on /var/run/cilium/shell.sock (27m, x1)\n      └── enterprise-controlplane\n          └── cec-ingress-policy\n              └── timer-job-enterprise-endpoint-policy-periodic-regeneration      [OK] OK (21.899µs) (1s, x1)\n      \n/home/cilium # cilium service list\nID   Frontend                Service Type   Backend                               \n1    172.16.32.1:443/TCP     ClusterIP      1 => 10.75.59.81:6443/TCP (active)    \n2    172.16.42.186:443/TCP   ClusterIP      1 => 10.75.59.83:4244/TCP (active)    \n3    172.16.42.14:80/TCP     ClusterIP      1 => 172.16.1.115:4245/TCP (active)   \n4    172.16.38.134:80/TCP    ClusterIP      1 => 172.16.1.105:8081/TCP (active)   \n5    10.75.59.83:31708/TCP   NodePort       1 => 172.16.1.105:8081/TCP (active)   \n6    0.0.0.0:31708/TCP       NodePort       1 => 172.16.1.105:8081/TCP (active)   \n7    172.16.32.10:53/TCP     ClusterIP      1 => 172.16.0.161:53/TCP (active)     \n                                            2 => 172.16.0.105:53/TCP (active)     \n8    172.16.32.10:9153/TCP   ClusterIP      1 => 172.16.0.161:9153/TCP (active)   \n                                            2 => 172.16.0.105:9153/TCP (active)   \n9    172.16.32.10:53/UDP     ClusterIP      1 => 172.16.0.161:53/UDP (active)     \n                                            2 => 172.16.0.105:53/UDP (active)     \n10   172.16.34.108:80/TCP    ClusterIP      1 => 172.16.1.198:80/TCP (active)     \n                                            2 => 172.16.2.92:80/TCP (active)      \n11   10.75.59.83:30719/TCP   NodePort       1 => 172.16.1.198:80/TCP (active)     \n                                            2 => 172.16.2.92:80/TCP (active)      \n12   0.0.0.0:30719/TCP       NodePort       1 => 172.16.1.198:80/TCP (active)     \n                                            2 => 172.16.2.92:80/TCP (active)      \n/home/cilium # cilium bpf nat list\nTCP IN 10.75.59.82:4240 -> 10.75.59.83:35986 XLATE_DST 10.75.59.83:35986 Created=1076sec ago NeedsCT=1\nICMP IN 10.75.59.81:0 -> 10.75.59.83:63865 XLATE_DST 10.75.59.83:63865 Created=156sec ago NeedsCT=1\nTCP IN 10.75.59.81:4240 -> 10.75.59.83:58402 XLATE_DST 10.75.59.83:58402 Created=56sec ago NeedsCT=1\nICMP OUT 10.75.59.83:47633 -> 10.75.59.81:0 XLATE_SRC 10.75.59.83:47633 Created=56sec ago NeedsCT=1\nICMP OUT 10.75.59.83:56308 -> 172.16.0.116:0 XLATE_SRC 10.75.59.83:56308 Created=206sec ago NeedsCT=1\nICMP OUT 10.75.59.83:40570 -> 10.75.59.82:0 XLATE_SRC 10.75.59.83:40570 Created=226sec ago NeedsCT=1\nTCP IN 172.16.0.116:4240 -> 10.75.59.83:33274 XLATE_DST 10.75.59.83:33274 Created=706sec ago NeedsCT=1\nICMP IN 172.16.0.116:0 -> 10.75.59.83:56308 XLATE_DST 10.75.59.83:56308 Created=206sec ago NeedsCT=1\nTCP OUT 10.75.59.83:37066 -> 10.75.59.81:6443 XLATE_SRC 10.75.59.83:37066 Created=1655sec ago NeedsCT=1\nTCP OUT 10.75.59.83:44064 -> 172.16.1.173:4240 XLATE_SRC 10.75.59.83:44064 Created=1066sec ago NeedsCT=1\nTCP OUT 10.75.59.83:46184 -> 10.75.59.81:6443 XLATE_SRC 10.75.59.83:46184 Created=1651sec ago NeedsCT=1\nTCP OUT 10.75.59.83:43981 -> 10.75.59.86:179 XLATE_SRC 10.75.59.83:43981 Created=1648sec ago NeedsCT=1\nTCP OUT 10.75.59.83:57802 -> 10.75.59.81:4240 XLATE_SRC 10.75.59.83:57802 Created=716sec ago NeedsCT=1\nICMP IN 10.75.59.82:0 -> 10.75.59.83:43531 XLATE_DST 10.75.59.83:43531 Created=36sec ago NeedsCT=1\nTCP IN 10.75.59.86:179 -> 10.75.59.83:43981 XLATE_DST 10.75.59.83:43981 Created=1648sec ago NeedsCT=1\nTCP OUT 10.75.59.83:58402 -> 10.75.59.81:4240 XLATE_SRC 10.75.59.83:58402 Created=56sec ago NeedsCT=1\nICMP OUT 10.75.59.83:43619 -> 10.75.59.82:0 XLATE_SRC 10.75.59.83:43619 Created=176sec ago NeedsCT=1\nICMP OUT 10.75.59.83:40760 -> 10.75.59.81:0 XLATE_SRC 10.75.59.83:40760 Created=216sec ago NeedsCT=1\nTCP IN 142.250.199.100:443 -> 10.75.59.83:40732 XLATE_DST 172.16.2.180:40732 Created=205sec ago NeedsCT=0\nTCP OUT 10.75.59.83:34202 -> 172.16.0.116:4240 XLATE_SRC 10.75.59.83:34202 Created=46sec ago NeedsCT=1\nICMP IN 10.75.59.81:0 -> 10.75.59.83:47633 XLATE_DST 10.75.59.83:47633 Created=56sec ago NeedsCT=1\nTCP OUT 10.75.59.83:33274 -> 172.16.0.116:4240 XLATE_SRC 10.75.59.83:33274 Created=706sec ago NeedsCT=1\nICMP OUT 10.75.59.83:43531 -> 10.75.59.82:0 XLATE_SRC 10.75.59.83:43531 Created=36sec ago NeedsCT=1\nICMP IN 10.75.59.82:0 -> 10.75.59.83:43619 XLATE_DST 10.75.59.83:43619 Created=176sec ago NeedsCT=1\nTCP IN 10.75.59.81:6443 -> 10.75.59.83:37066 XLATE_DST 10.75.59.83:37066 Created=1655sec ago NeedsCT=1\nICMP OUT 10.75.59.83:36675 -> 172.16.1.173:0 XLATE_SRC 10.75.59.83:36675 Created=106sec ago NeedsCT=1\nTCP OUT 172.16.2.180:40732 -> 142.250.199.100:443 XLATE_SRC 10.75.59.83:40732 Created=205sec ago NeedsCT=0\nICMP IN 172.16.0.116:0 -> 10.75.59.83:38433 XLATE_DST 10.75.59.83:38433 Created=276sec ago NeedsCT=1\nTCP OUT 10.75.59.83:35986 -> 10.75.59.82:4240 XLATE_SRC 10.75.59.83:35986 Created=1076sec ago NeedsCT=1\nICMP IN 172.16.1.173:0 -> 10.75.59.83:36675 XLATE_DST 10.75.59.83:36675 Created=106sec ago NeedsCT=1\nTCP IN 10.75.59.81:6443 -> 10.75.59.83:46184 XLATE_DST 10.75.59.83:46184 Created=1651sec ago NeedsCT=1\nTCP IN 172.16.0.116:4240 -> 10.75.59.83:34202 XLATE_DST 10.75.59.83:34202 Created=46sec ago NeedsCT=1\nICMP OUT 10.75.59.83:63865 -> 10.75.59.81:0 XLATE_SRC 10.75.59.83:63865 Created=156sec ago NeedsCT=1\nICMP OUT 10.75.59.83:38433 -> 172.16.0.116:0 XLATE_SRC 10.75.59.83:38433 Created=276sec ago NeedsCT=1\nICMP IN 10.75.59.82:0 -> 10.75.59.83:40570 XLATE_DST 10.75.59.83:40570 Created=226sec ago NeedsCT=1\nICMP OUT 10.75.59.83:36899 -> 172.16.1.173:0 XLATE_SRC 10.75.59.83:36899 Created=236sec ago NeedsCT=1\nICMP IN 172.16.1.173:0 -> 10.75.59.83:36899 XLATE_DST 10.75.59.83:36899 Created=236sec ago NeedsCT=1\nTCP IN 10.75.59.81:4240 -> 10.75.59.83:57802 XLATE_DST 10.75.59.83:57802 Created=716sec ago NeedsCT=1\nICMP IN 10.75.59.81:0 -> 10.75.59.83:40760 XLATE_DST 10.75.59.83:40760 Created=216sec ago NeedsCT=1\nTCP IN 172.16.1.173:4240 -> 10.75.59.83:44064 XLATE_DST 10.75.59.83:44064 Created=1066sec ago NeedsCT=1\n\n/home/cilium # cilium config\n##### Read-write configurations #####\nConntrackAccounting               : Disabled\nConntrackLocal                    : Disabled\nDebug                             : Disabled\nDebugLB                           : Disabled\nDropNotification                  : Enabled\nMonitorAggregationLevel           : Medium\nPolicyAccounting                  : Enabled\nPolicyAuditMode                   : Disabled\nPolicyTracing                     : Disabled\nPolicyVerdictNotification         : Enabled\nSourceIPVerification              : Enabled\nTraceNotification                 : Enabled\nMonitorNumPages                   : 64\nPolicyEnforcement                 : default\n/home/cilium # exit\nroot@k8s-node-1:~# \n```\n## 11.2 BGP相关信息\n```bash\nroot@k8s-node-1:~# cilium bgp peers\nNode         Local AS   Peer AS   Peer Address   Session State   Uptime   Family         Received   Advertised\nk8s-node-1   65000      65000     10.75.59.86    established     41m41s   ipv4/unicast   1          8    \nk8s-node-2   65000      65000     10.75.59.86    established     39m53s   ipv4/unicast   1          8    \nk8s-node-3   65000      65000     10.75.59.86    established     39m52s   ipv4/unicast   1          8    \nroot@k8s-node-1:~# cilium bgp routes\n(Defaulting to `available ipv4 unicast` routes, please see help for more options)\n\nNode         VRouter   Prefix             NextHop   Age      Attrs\nk8s-node-1   65000     172.16.0.0/24      0.0.0.0   41m48s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n             65000     172.16.32.1/32     0.0.0.0   41m48s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n             65000     172.16.32.10/32    0.0.0.0   41m48s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n             65000     172.16.34.108/32   0.0.0.0   34m39s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n             65000     172.16.38.134/32   0.0.0.0   41m48s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n             65000     172.16.42.14/32    0.0.0.0   41m48s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n             65000     172.16.42.186/32   0.0.0.0   41m47s   [{Origin: i} {Nexthop: 0.0.0.0}]   \nk8s-node-2   65000     172.16.1.0/24      0.0.0.0   39m59s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n             65000     172.16.32.1/32     0.0.0.0   39m59s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n             65000     172.16.32.10/32    0.0.0.0   39m59s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n             65000     172.16.34.108/32   0.0.0.0   34m39s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n             65000     172.16.38.134/32   0.0.0.0   39m59s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n             65000     172.16.42.14/32    0.0.0.0   39m59s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n             65000     172.16.42.186/32   0.0.0.0   39m56s   [{Origin: i} {Nexthop: 0.0.0.0}]   \nk8s-node-3   65000     172.16.2.0/24      0.0.0.0   39m58s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n             65000     172.16.32.1/32     0.0.0.0   39m58s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n             65000     172.16.32.10/32    0.0.0.0   39m58s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n             65000     172.16.34.108/32   0.0.0.0   34m39s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n             65000     172.16.38.134/32   0.0.0.0   39m58s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n             65000     172.16.42.14/32    0.0.0.0   39m58s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n             65000     172.16.42.186/32   0.0.0.0   39m55s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n\nroot@dns-bgp-server:~# ip route show\ndefault via 10.75.59.1 dev enp1s0 proto static \n10.75.59.0/24 dev enp1s0 proto kernel scope link src 10.75.59.86 \n172.16.0.0/24 nhid 8 via 10.75.59.81 dev enp1s0 proto bgp metric 20 \n172.16.1.0/24 nhid 12 via 10.75.59.82 dev enp1s0 proto bgp metric 20 \n172.16.2.0/24 nhid 19 via 10.75.59.83 dev enp1s0 proto bgp metric 20 \n172.16.32.1 nhid 18 proto bgp metric 20 \n        nexthop via 10.75.59.81 dev enp1s0 weight 1 \n        nexthop via 10.75.59.82 dev enp1s0 weight 1 \n        nexthop via 10.75.59.83 dev enp1s0 weight 1 \n172.16.32.10 nhid 18 proto bgp metric 20 \n        nexthop via 10.75.59.81 dev enp1s0 weight 1 \n        nexthop via 10.75.59.82 dev enp1s0 weight 1 \n        nexthop via 10.75.59.83 dev enp1s0 weight 1 \n172.16.34.108 nhid 18 proto bgp metric 20 \n        nexthop via 10.75.59.81 dev enp1s0 weight 1 \n        nexthop via 10.75.59.82 dev enp1s0 weight 1 \n        nexthop via 10.75.59.83 dev enp1s0 weight 1 \n172.16.38.134 nhid 18 proto bgp metric 20 \n        nexthop via 10.75.59.81 dev enp1s0 weight 1 \n        nexthop via 10.75.59.82 dev enp1s0 weight 1 \n        nexthop via 10.75.59.83 dev enp1s0 weight 1 \n172.16.42.14 nhid 18 proto bgp metric 20 \n        nexthop via 10.75.59.81 dev enp1s0 weight 1 \n        nexthop via 10.75.59.82 dev enp1s0 weight 1 \n        nexthop via 10.75.59.83 dev enp1s0 weight 1 \n172.16.42.186 nhid 18 proto bgp metric 20 \n        nexthop via 10.75.59.81 dev enp1s0 weight 1 \n        nexthop via 10.75.59.82 dev enp1s0 weight 1 \n        nexthop via 10.75.59.83 dev enp1s0 weight 1 \nroot@dns-bgp-server:~# route -n\nKernel IP routing table\nDestination     Gateway         Genmask         Flags Metric Ref    Use Iface\n0.0.0.0         10.75.59.1      0.0.0.0         UG    0      0        0 enp1s0\n10.75.59.0      0.0.0.0         255.255.255.0   U     0      0        0 enp1s0\n172.16.0.0      10.75.59.81     255.255.255.0   UG    20     0        0 enp1s0\n172.16.1.0      10.75.59.82     255.255.255.0   UG    20     0        0 enp1s0\n172.16.2.0      10.75.59.83     255.255.255.0   UG    20     0        0 enp1s0\n172.16.32.1     10.75.59.81     255.255.255.255 UGH   20     0        0 enp1s0\n172.16.32.10    10.75.59.81     255.255.255.255 UGH   20     0        0 enp1s0\n172.16.34.108   10.75.59.81     255.255.255.255 UGH   20     0        0 enp1s0\n172.16.38.134   10.75.59.81     255.255.255.255 UGH   20     0        0 enp1s0\n172.16.42.14    10.75.59.81     255.255.255.255 UGH   20     0        0 enp1s0\n172.16.42.186   10.75.59.81     255.255.255.255 UGH   20     0        0 enp1s0\nroot@dns-bgp-server:~# vtysh -c \"show ip bgp\"\nBGP table version is 15, local router ID is 10.75.59.86, vrf id 0\nDefault local pref 100, local AS 65000\nStatus codes:  s suppressed, d damped, h history, * valid, > best, = multipath,\n               i internal, r RIB-failure, S Stale, R Removed\nNexthop codes: @NNN nexthop's vrf id, < announce-nh-self\nOrigin codes:  i - IGP, e - EGP, ? - incomplete\nRPKI validation codes: V valid, I invalid, N Not found\n\n   Network          Next Hop            Metric LocPrf Weight Path\n*> 10.75.59.0/24    0.0.0.0                  0         32768 ?\n*>i172.16.0.0/24    10.75.59.81                   100      0 i\n*>i172.16.1.0/24    10.75.59.82                   100      0 i\n*>i172.16.2.0/24    10.75.59.83                   100      0 i\n*=i172.16.32.1/32   10.75.59.83                   100      0 i\n*=i                 10.75.59.82                   100      0 i\n*>i                 10.75.59.81                   100      0 i\n*=i172.16.32.10/32  10.75.59.83                   100      0 i\n*=i                 10.75.59.82                   100      0 i\n*>i                 10.75.59.81                   100      0 i\n*>i172.16.34.108/32 10.75.59.81                   100      0 i\n*=i                 10.75.59.82                   100      0 i\n*=i                 10.75.59.83                   100      0 i\n*=i172.16.38.134/32 10.75.59.83                   100      0 i\n*=i                 10.75.59.82                   100      0 i\n*>i                 10.75.59.81                   100      0 i\n*=i172.16.42.14/32  10.75.59.83                   100      0 i\n*=i                 10.75.59.82                   100      0 i\n*>i                 10.75.59.81                   100      0 i\n*=i172.16.42.186/32 10.75.59.83                   100      0 i\n*=i                 10.75.59.82                   100      0 i\n*>i                 10.75.59.81                   100      0 i\n\nDisplayed  10 routes and 22 total paths\nroot@dns-bgp-server:~# vtysh -c \"show ip bgp summary\"\n\nIPv4 Unicast Summary (VRF default):\nBGP router identifier 10.75.59.86, local AS number 65000 vrf-id 0\nBGP table version 15\nRIB entries 19, using 3648 bytes of memory\nPeers 3, using 2172 KiB of memory\n\nNeighbor        V         AS   MsgRcvd   MsgSent   TblVer  InQ OutQ  Up/Down State/PfxRcd   PfxSnt Desc\n10.75.59.81     4      65000       247       244        0    0    0 00:40:09            7        1 N/A\n10.75.59.82     4      65000       240       234        0    0    0 00:38:20            7        1 N/A\n10.75.59.83     4      65000       239       233        0    0    0 00:38:19            7        1 N/A\n\nTotal number of neighbors 3\n```\n\n# 12. 项目文档结构\n\n```bash\nois@ois:~/data/k8s-cilium-lab$ tree\n.\n├── ansible.cfg\n├── group_vars\n│   └── all.yml\n├── host_vars\n│   ├── dns-bgp-server.yml\n│   ├── k8s-node-1.yml\n│   ├── k8s-node-2.yml\n│   └── k8s-node-3.yml\n├── inventory.ini\n├── nodevm_cfg\n│   ├── dns-bgp-server_meta-data\n│   ├── dns-bgp-server_network-config\n│   ├── dns-bgp-server_user-data\n│   ├── k8s-node-1_meta-data\n│   ├── k8s-node-1_network-config\n│   ├── k8s-node-1_user-data\n│   ├── k8s-node-2_meta-data\n│   ├── k8s-node-2_network-config\n│   ├── k8s-node-2_user-data\n│   ├── k8s-node-3_meta-data\n│   ├── k8s-node-3_network-config\n│   └── k8s-node-3_user-data\n├── nodevms\n│   ├── dns-bgp-server.qcow2\n│   ├── k8s-node-1.qcow2\n│   ├── k8s-node-2.qcow2\n│   └── k8s-node-3.qcow2\n├── playbooks\n│   ├── 1_create_vms.yml\n│   ├── 2_prepare_nodes.yml\n│   ├── 3_setup_cluster.yml\n│   └── 4_deploy_app.yml\n├── roles\n│   ├── common\n│   │   └── tasks\n│   │       └── main.yml\n│   ├── infra_server\n│   │   └── tasks\n│   │       └── main.yml\n│   └── k8s_node\n│       └── tasks\n│           └── main.yml\n└── templates\n    ├── cilium-bgp.yaml.j2\n    ├── containerd.toml.j2\n    ├── deploy-star-wars.sh.j2\n    ├── frr.conf.j2\n    ├── hosts.j2\n    ├── meta-data.j2\n    ├── network-config.j2\n    └── user-data.j2\n\n14 directories, 38 files\n```","source":"_posts/Ansible-K8S-Cilium.md","raw":"---\ntitle: Ansible-K8S-Cilium\ndate: 2025-08-04 09:23:21\ntags:\ndescription: 本文使用Ansible脚本从零开始部署Ubuntu虚拟机，然后在Ubuntu上安装K8S，使用Cilium作为CNI。\n---\n# Setup K8S with Ansible from zero\n\n# 1. 删除之前的环境\n\n```bash\nois@ois:~/data/k8s-cilium-lab$ cd ..\nois@ois:~/data$ ./07-undefine-vms.sh \nDomain 'k8s-node-1' destroyed\n\nDomain 'k8s-node-1' has been undefined\nVolume 'vda'(/home/ois/data/k8s-cilium-lab/nodevms/k8s-node-1.qcow2) removed.\n\nDomain 'k8s-node-2' destroyed\n\nDomain 'k8s-node-2' has been undefined\nVolume 'vda'(/home/ois/data/k8s-cilium-lab/nodevms/k8s-node-2.qcow2) removed.\n\nDomain 'k8s-node-3' destroyed\n\nDomain 'k8s-node-3' has been undefined\nVolume 'vda'(/home/ois/data/k8s-cilium-lab/nodevms/k8s-node-3.qcow2) removed.\n\nDomain 'dns-bgp-server' destroyed\n\nDomain 'dns-bgp-server' has been undefined\nVolume 'vda'(/home/ois/data/k8s-cilium-lab/nodevms/dns-bgp-server.qcow2) removed.\n\nois@ois:~/data$ rm -rf k8s-cilium-lab/\nois@ois:~/data$ \n```\n\n# 2. 重新构建项目文件结构\n\n```bash\nois@ois:~/data$ ./00-create-project-structure.sh \n--- K8s + Cilium Lab Setup (Warning-Free) ---\nThis script will prepare a new Ansible project directory named 'k8s-cilium-lab'.\n\n--- Step 1: Checking Prerequisites ---\n✅ OS is Debian-based.\n✅ Ansible is already installed.\n--> Ensuring libvirt and whois are up-to-date...\n✅ Dependencies are present.\n✅ SSH key already exists at ~/.ssh/id_rsa. Skipping generation.\n\n--- Step 2: Creating Project Structure ---\n✅ Project directory structure created in 'k8s-cilium-lab/'.\n\n--- Step 3: Configuring User Password Hash ---\nA secure password hash is required for the 'ubuntu' user on the VMs.\nEnter the password for the 'ubuntu' user (input will be hidden): \n--> Generating password hash...\n✅ Password hash generated.\n\n--- Step 4: Generating Configuration Files ---\n✅ Created ansible.cfg\n✅ Created inventory.ini\n✅ Created group_vars/all.yml with password hash.\n✅ Created host_vars/k8s-node-1.yml\n✅ Created host_vars/k8s-node-2.yml\n✅ Created host_vars/k8s-node-3.yml\n✅ Created host_vars/dns-bgp-server.yml\n\n--- Setup Complete! ---\n✅ Project 'k8s-cilium-lab' has been successfully configured.\n\nNext Steps:\n1. Run the next script to generate the VM creation playbook:\n   ../01-create-vms.sh\n2. Run the playbook to create your lab VMs (no vault password needed):\n   ansible-playbook playbooks/1_create_vms.yml\n```\n\n# 3. 生成Playbook，用于构建Lab环境虚拟机\n\n```bash\nois@ois:~/data$ ./01-create-vms.sh \n--- Lab VM Playbook Generator (Final Corrected Version) ---\n\n--- Step 1: Verifying Project Context ---\n✅ Working inside project directory: /home/ois/data/k8s-cilium-lab\n\n--- Step 2: Ensuring Directories Exist ---\n✅ Directories 'playbooks/' and 'templates/' are ready.\n\n--- Step 3: Generating Files ---\n✅ Generated playbook: playbooks/1_create_vms.yml\n✅ Generated template: templates/user-data.j2\n✅ Generated template: templates/network-config.j2\n✅ Generated template: templates/meta-data.j2\n\n--- Generation Complete! ---\n✅ All necessary files have been created inside the 'k8s-cilium-lab' directory.\n\nNext Step:\n1. Change into the project directory: cd k8s-cilium-lab\n2. Run the playbook to create your lab VMs:\n   ansible-playbook playbooks/1_create_vms.yml\n```\n\n# 4. 运行Playbook，构建虚拟机环境\n\n自动创建k8s-nodes 和 运行FRR的虚拟机，并进行联通性探测，添加到已知主机列表(known_hosts)\n\n```bash\nois@ois:~/data$ cd k8s-cilium-lab/\nois@ois:~/data/k8s-cilium-lab$ \nois@ois:~/data/k8s-cilium-lab$ \nois@ois:~/data/k8s-cilium-lab$ ansible-playbook playbooks/1_create_vms.yml\n\nPLAY [Play 1 - Pre-flight Check for Existing VMs] ******************************************************************************************************************************************************\n\nTASK [Check status of each VM with virsh] **************************************************************************************************************************************************************\nok: [dns-bgp-server]\nok: [k8s-node-2]\nok: [k8s-node-1]\nok: [k8s-node-3]\n\nPLAY [Play 2 - Decide if Provisioning is Needed] *******************************************************************************************************************************************************\n\nTASK [Initialize an empty list for missing VMs] ********************************************************************************************************************************************************\nok: [localhost]\n\nTASK [Populate the list of missing VMs] ****************************************************************************************************************************************************************\nok: [localhost] => (item=dns-bgp-server)\nok: [localhost] => (item=k8s-node-1)\nok: [localhost] => (item=k8s-node-2)\nok: [localhost] => (item=k8s-node-3)\n\nTASK [Set global flag if provisioning is required] *****************************************************************************************************************************************************\nok: [localhost]\n\nTASK [Report status] ***********************************************************************************************************************************************************************************\nok: [localhost] => {\n    \"msg\": \"Provisioning needed: True. Missing VMs: ['dns-bgp-server', 'k8s-node-1', 'k8s-node-2', 'k8s-node-3']\"\n}\n\nPLAY [Play 3 - Prepare VM Assets in Parallel] **********************************************************************************************************************************************************\n[WARNING]: Using run_once with the free strategy is not currently supported. This task will still be executed for every host in the inventory list.\n\nTASK [Ensure VM directories exist] *********************************************************************************************************************************************************************\nchanged: [dns-bgp-server] => (item=/home/ois/data/k8s-cilium-lab/nodevms)\nok: [k8s-node-2] => (item=/home/ois/data/k8s-cilium-lab/nodevms)\nok: [k8s-node-3] => (item=/home/ois/data/k8s-cilium-lab/nodevms)\nok: [k8s-node-1] => (item=/home/ois/data/k8s-cilium-lab/nodevms)\nchanged: [dns-bgp-server] => (item=/home/ois/data/k8s-cilium-lab/nodevm_cfg)\nok: [k8s-node-2] => (item=/home/ois/data/k8s-cilium-lab/nodevm_cfg)\nok: [k8s-node-3] => (item=/home/ois/data/k8s-cilium-lab/nodevm_cfg)\nok: [k8s-node-1] => (item=/home/ois/data/k8s-cilium-lab/nodevm_cfg)\n\nTASK [Check if VM disk image already exists] ***********************************************************************************************************************************************************\nok: [k8s-node-2]\nok: [dns-bgp-server]\nok: [k8s-node-1]\nok: [k8s-node-3]\n\nTASK [Create VM disk image from base image] ************************************************************************************************************************************************************\nchanged: [dns-bgp-server]\nchanged: [k8s-node-2]\nchanged: [k8s-node-1]\nchanged: [k8s-node-3]\n\nTASK [Resize VM disk image] ****************************************************************************************************************************************************************************\nchanged: [dns-bgp-server]\nchanged: [k8s-node-2]\nchanged: [k8s-node-3]\nchanged: [k8s-node-1]\n\nTASK [Generate cloud-init files] ***********************************************************************************************************************************************************************\nchanged: [k8s-node-2] => (item={'src': '../templates/user-data.j2', 'dest': '/home/ois/data/k8s-cilium-lab/nodevm_cfg/k8s-node-2_user-data'})\nchanged: [k8s-node-3] => (item={'src': '../templates/user-data.j2', 'dest': '/home/ois/data/k8s-cilium-lab/nodevm_cfg/k8s-node-3_user-data'})\nchanged: [dns-bgp-server] => (item={'src': '../templates/user-data.j2', 'dest': '/home/ois/data/k8s-cilium-lab/nodevm_cfg/dns-bgp-server_user-data'})\nchanged: [k8s-node-1] => (item={'src': '../templates/user-data.j2', 'dest': '/home/ois/data/k8s-cilium-lab/nodevm_cfg/k8s-node-1_user-data'})\nchanged: [k8s-node-3] => (item={'src': '../templates/network-config.j2', 'dest': '/home/ois/data/k8s-cilium-lab/nodevm_cfg/k8s-node-3_network-config'})\nchanged: [k8s-node-2] => (item={'src': '../templates/network-config.j2', 'dest': '/home/ois/data/k8s-cilium-lab/nodevm_cfg/k8s-node-2_network-config'})\nchanged: [k8s-node-1] => (item={'src': '../templates/network-config.j2', 'dest': '/home/ois/data/k8s-cilium-lab/nodevm_cfg/k8s-node-1_network-config'})\nchanged: [dns-bgp-server] => (item={'src': '../templates/network-config.j2', 'dest': '/home/ois/data/k8s-cilium-lab/nodevm_cfg/dns-bgp-server_network-config'})\nchanged: [k8s-node-3] => (item={'src': '../templates/meta-data.j2', 'dest': '/home/ois/data/k8s-cilium-lab/nodevm_cfg/k8s-node-3_meta-data'})\nchanged: [k8s-node-2] => (item={'src': '../templates/meta-data.j2', 'dest': '/home/ois/data/k8s-cilium-lab/nodevm_cfg/k8s-node-2_meta-data'})\nchanged: [k8s-node-1] => (item={'src': '../templates/meta-data.j2', 'dest': '/home/ois/data/k8s-cilium-lab/nodevm_cfg/k8s-node-1_meta-data'})\nchanged: [dns-bgp-server] => (item={'src': '../templates/meta-data.j2', 'dest': '/home/ois/data/k8s-cilium-lab/nodevm_cfg/dns-bgp-server_meta-data'})\n\nPLAY [Play 4 - Install VMs Sequentially to Avoid Race Condition] ***************************************************************************************************************************************\n\nTASK [Create and start the VM with virt-install] *******************************************************************************************************************************************************\nchanged: [dns-bgp-server]\n\nPLAY [Play 4 - Install VMs Sequentially to Avoid Race Condition] ***************************************************************************************************************************************\n\nTASK [Create and start the VM with virt-install] *******************************************************************************************************************************************************\nchanged: [k8s-node-1]\n\nPLAY [Play 4 - Install VMs Sequentially to Avoid Race Condition] ***************************************************************************************************************************************\n\nTASK [Create and start the VM with virt-install] *******************************************************************************************************************************************************\nchanged: [k8s-node-2]\n\nPLAY [Play 4 - Install VMs Sequentially to Avoid Race Condition] ***************************************************************************************************************************************\n\nTASK [Create and start the VM with virt-install] *******************************************************************************************************************************************************\nchanged: [k8s-node-3]\n\nPLAY [Play 5 - Verify VM Connectivity in Parallel] *****************************************************************************************************************************************************\n\nTASK [Wait for VMs to boot and SSH to become available] ************************************************************************************************************************************************\nok: [dns-bgp-server -> localhost]\nok: [k8s-node-1 -> localhost]\n# 10.75.59.86:22 SSH-2.0-OpenSSH_9.6p1 Ubuntu-3ubuntu13.12\n# 10.75.59.81:22 SSH-2.0-OpenSSH_9.6p1 Ubuntu-3ubuntu13.12\n# 10.75.59.81:22 SSH-2.0-OpenSSH_9.6p1 Ubuntu-3ubuntu13.12\n# 10.75.59.86:22 SSH-2.0-OpenSSH_9.6p1 Ubuntu-3ubuntu13.12\n# 10.75.59.81:22 SSH-2.0-OpenSSH_9.6p1 Ubuntu-3ubuntu13.12\n# 10.75.59.81:22 SSH-2.0-OpenSSH_9.6p1 Ubuntu-3ubuntu13.12\n# 10.75.59.86:22 SSH-2.0-OpenSSH_9.6p1 Ubuntu-3ubuntu13.12\n# 10.75.59.81:22 SSH-2.0-OpenSSH_9.6p1 Ubuntu-3ubuntu13.12\n# 10.75.59.86:22 SSH-2.0-OpenSSH_9.6p1 Ubuntu-3ubuntu13.12\n# 10.75.59.86:22 SSH-2.0-OpenSSH_9.6p1 Ubuntu-3ubuntu13.12\n\nTASK [Add host keys to known_hosts file] ***************************************************************************************************************************************************************\nchanged: [k8s-node-1 -> localhost]\nchanged: [dns-bgp-server -> localhost]\n\nTASK [Wait for VMs to boot and SSH to become available] ************************************************************************************************************************************************\nok: [k8s-node-3 -> localhost]\n# 10.75.59.83:22 SSH-2.0-OpenSSH_9.6p1 Ubuntu-3ubuntu13.12\n# 10.75.59.83:22 SSH-2.0-OpenSSH_9.6p1 Ubuntu-3ubuntu13.12\n# 10.75.59.83:22 SSH-2.0-OpenSSH_9.6p1 Ubuntu-3ubuntu13.12\n# 10.75.59.83:22 SSH-2.0-OpenSSH_9.6p1 Ubuntu-3ubuntu13.12\n# 10.75.59.83:22 SSH-2.0-OpenSSH_9.6p1 Ubuntu-3ubuntu13.12\n\nTASK [Add host keys to known_hosts file] ***************************************************************************************************************************************************************\nchanged: [k8s-node-3 -> localhost]\n\nTASK [Wait for VMs to boot and SSH to become available] ************************************************************************************************************************************************\nok: [k8s-node-2 -> localhost]\n# 10.75.59.82:22 SSH-2.0-OpenSSH_9.6p1 Ubuntu-3ubuntu13.12\n# 10.75.59.82:22 SSH-2.0-OpenSSH_9.6p1 Ubuntu-3ubuntu13.12\n# 10.75.59.82:22 SSH-2.0-OpenSSH_9.6p1 Ubuntu-3ubuntu13.12\n# 10.75.59.82:22 SSH-2.0-OpenSSH_9.6p1 Ubuntu-3ubuntu13.12\n# 10.75.59.82:22 SSH-2.0-OpenSSH_9.6p1 Ubuntu-3ubuntu13.12\n\nTASK [Add host keys to known_hosts file] ***************************************************************************************************************************************************************\nchanged: [k8s-node-2 -> localhost]\n\nPLAY RECAP *********************************************************************************************************************************************************************************************\ndns-bgp-server             : ok=9    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   \nk8s-node-1                 : ok=9    changed=5    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   \nk8s-node-2                 : ok=9    changed=5    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   \nk8s-node-3                 : ok=9    changed=5    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   \nlocalhost                  : ok=4    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   \n```\n\n多次运行，以测试幂等性，多次运行不影响结果，已执行过的任务会自行跳过。\n\n```bash\nois@ois:~/data/k8s-cilium-lab$ ansible-playbook playbooks/1_create_vms.yml\n\nPLAY [Play 1 - Pre-flight Check for Existing VMs] ******************************************************************************************************************************************************\n\nTASK [Check status of each VM with virsh] **************************************************************************************************************************************************************\nok: [k8s-node-3]\nok: [k8s-node-1]\nok: [dns-bgp-server]\nok: [k8s-node-2]\n\nPLAY [Play 2 - Decide if Provisioning is Needed] *******************************************************************************************************************************************************\n\nTASK [Initialize an empty list for missing VMs] ********************************************************************************************************************************************************\nok: [localhost]\n\nTASK [Populate the list of missing VMs] ****************************************************************************************************************************************************************\nskipping: [localhost] => (item=dns-bgp-server) \nskipping: [localhost] => (item=k8s-node-1) \nskipping: [localhost] => (item=k8s-node-2) \nskipping: [localhost] => (item=k8s-node-3) \nskipping: [localhost]\n\nTASK [Set global flag if provisioning is required] *****************************************************************************************************************************************************\nok: [localhost]\n\nTASK [Report status] ***********************************************************************************************************************************************************************************\nok: [localhost] => {\n    \"msg\": \"Provisioning needed: False. Missing VMs: []\"\n}\n\nPLAY [Play 3 - Prepare VM Assets in Parallel] **********************************************************************************************************************************************************\n[WARNING]: Using run_once with the free strategy is not currently supported. This task will still be executed for every host in the inventory list.\n\nTASK [Ensure VM directories exist] *********************************************************************************************************************************************************************\nskipping: [dns-bgp-server] => (item=/home/ois/data/k8s-cilium-lab/nodevms) \nskipping: [dns-bgp-server] => (item=/home/ois/data/k8s-cilium-lab/nodevm_cfg) \nskipping: [k8s-node-1] => (item=/home/ois/data/k8s-cilium-lab/nodevms) \nskipping: [dns-bgp-server]\nskipping: [k8s-node-1] => (item=/home/ois/data/k8s-cilium-lab/nodevm_cfg) \nskipping: [k8s-node-2] => (item=/home/ois/data/k8s-cilium-lab/nodevms) \nskipping: [k8s-node-2] => (item=/home/ois/data/k8s-cilium-lab/nodevm_cfg) \nskipping: [k8s-node-3] => (item=/home/ois/data/k8s-cilium-lab/nodevms) \nskipping: [k8s-node-3] => (item=/home/ois/data/k8s-cilium-lab/nodevm_cfg) \nskipping: [k8s-node-1]\nskipping: [k8s-node-2]\nskipping: [k8s-node-3]\n\nTASK [Check if VM disk image already exists] ***********************************************************************************************************************************************************\nskipping: [dns-bgp-server]\nskipping: [k8s-node-1]\nskipping: [k8s-node-2]\nskipping: [k8s-node-3]\n\nTASK [Create VM disk image from base image] ************************************************************************************************************************************************************\nskipping: [dns-bgp-server]\nskipping: [k8s-node-1]\nskipping: [k8s-node-2]\nskipping: [k8s-node-3]\n\nTASK [Resize VM disk image] ****************************************************************************************************************************************************************************\nskipping: [dns-bgp-server]\nskipping: [k8s-node-1]\nskipping: [k8s-node-2]\nskipping: [k8s-node-3]\n\nTASK [Generate cloud-init files] ***********************************************************************************************************************************************************************\nskipping: [k8s-node-1] => (item={'src': '../templates/user-data.j2', 'dest': '/home/ois/data/k8s-cilium-lab/nodevm_cfg/k8s-node-1_user-data'}) \nskipping: [k8s-node-1] => (item={'src': '../templates/network-config.j2', 'dest': '/home/ois/data/k8s-cilium-lab/nodevm_cfg/k8s-node-1_network-config'}) \nskipping: [k8s-node-2] => (item={'src': '../templates/user-data.j2', 'dest': '/home/ois/data/k8s-cilium-lab/nodevm_cfg/k8s-node-2_user-data'}) \nskipping: [k8s-node-1] => (item={'src': '../templates/meta-data.j2', 'dest': '/home/ois/data/k8s-cilium-lab/nodevm_cfg/k8s-node-1_meta-data'}) \nskipping: [k8s-node-1]\nskipping: [k8s-node-2] => (item={'src': '../templates/network-config.j2', 'dest': '/home/ois/data/k8s-cilium-lab/nodevm_cfg/k8s-node-2_network-config'}) \nskipping: [dns-bgp-server] => (item={'src': '../templates/user-data.j2', 'dest': '/home/ois/data/k8s-cilium-lab/nodevm_cfg/dns-bgp-server_user-data'}) \nskipping: [k8s-node-2] => (item={'src': '../templates/meta-data.j2', 'dest': '/home/ois/data/k8s-cilium-lab/nodevm_cfg/k8s-node-2_meta-data'}) \nskipping: [k8s-node-2]\nskipping: [dns-bgp-server] => (item={'src': '../templates/network-config.j2', 'dest': '/home/ois/data/k8s-cilium-lab/nodevm_cfg/dns-bgp-server_network-config'}) \nskipping: [dns-bgp-server] => (item={'src': '../templates/meta-data.j2', 'dest': '/home/ois/data/k8s-cilium-lab/nodevm_cfg/dns-bgp-server_meta-data'}) \nskipping: [k8s-node-3] => (item={'src': '../templates/user-data.j2', 'dest': '/home/ois/data/k8s-cilium-lab/nodevm_cfg/k8s-node-3_user-data'}) \nskipping: [dns-bgp-server]\nskipping: [k8s-node-3] => (item={'src': '../templates/network-config.j2', 'dest': '/home/ois/data/k8s-cilium-lab/nodevm_cfg/k8s-node-3_network-config'}) \nskipping: [k8s-node-3] => (item={'src': '../templates/meta-data.j2', 'dest': '/home/ois/data/k8s-cilium-lab/nodevm_cfg/k8s-node-3_meta-data'}) \nskipping: [k8s-node-3]\n\nPLAY [Play 4 - Install VMs Sequentially to Avoid Race Condition] ***************************************************************************************************************************************\n\nTASK [Create and start the VM with virt-install] *******************************************************************************************************************************************************\nskipping: [dns-bgp-server]\n\nPLAY [Play 4 - Install VMs Sequentially to Avoid Race Condition] ***************************************************************************************************************************************\n\nTASK [Create and start the VM with virt-install] *******************************************************************************************************************************************************\nskipping: [k8s-node-1]\n\nPLAY [Play 4 - Install VMs Sequentially to Avoid Race Condition] ***************************************************************************************************************************************\n\nTASK [Create and start the VM with virt-install] *******************************************************************************************************************************************************\nskipping: [k8s-node-2]\n\nPLAY [Play 4 - Install VMs Sequentially to Avoid Race Condition] ***************************************************************************************************************************************\n\nTASK [Create and start the VM with virt-install] *******************************************************************************************************************************************************\nskipping: [k8s-node-3]\n\nPLAY [Play 5 - Verify VM Connectivity in Parallel] *****************************************************************************************************************************************************\n\nTASK [Wait for VMs to boot and SSH to become available] ************************************************************************************************************************************************\nskipping: [dns-bgp-server]\nskipping: [k8s-node-1]\nskipping: [k8s-node-2]\nskipping: [k8s-node-3]\n\nTASK [Add host keys to known_hosts file] ***************************************************************************************************************************************************************\nskipping: [dns-bgp-server]\nskipping: [k8s-node-1]\nskipping: [k8s-node-2]\nskipping: [k8s-node-3]\n\nPLAY RECAP *********************************************************************************************************************************************************************************************\ndns-bgp-server             : ok=1    changed=0    unreachable=0    failed=0    skipped=8    rescued=0    ignored=0   \nk8s-node-1                 : ok=1    changed=0    unreachable=0    failed=0    skipped=8    rescued=0    ignored=0   \nk8s-node-2                 : ok=1    changed=0    unreachable=0    failed=0    skipped=8    rescued=0    ignored=0   \nk8s-node-3                 : ok=1    changed=0    unreachable=0    failed=0    skipped=8    rescued=0    ignored=0   \nlocalhost                  : ok=3    changed=0    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   \n```\n\n# 5. 生成Playbook以便安装Containerd和K8S工具\n\n```bash\nois@ois:~/data/k8s-cilium-lab$ cd ..\nois@ois:~/data$ ./02-prepare-nodes.sh \n--- Node Preparation Playbook Generator (with cloud-init wait) ---\n\n--- Step 1: Verifying Project Context ---\n✅ Working inside project directory: /home/ois/data/k8s-cilium-lab\n\n--- Step 2: Ensuring Role Directories Exist ---\n✅ Role directories created.\n\n--- Step 3: Generating Role Task Files ---\n✅ Created tasks for 'common' role.\n✅ Created tasks for 'k8s_node' role.\n✅ Created tasks for 'infra_server' role.\n\n--- Step 4: Generating Config Templates ---\n✅ Created /etc/hosts template.\n✅ Created containerd config template.\n✅ Created FRR config template.\n\n--- Step 5: Generating Main Playbook ---\n✅ Created main playbook: playbooks/2_prepare_nodes.yml\n\n--- Generation Complete! ---\n✅ All necessary files for node preparation have been created.\n\nNext Step:\n1. Change into the project directory: cd k8s-cilium-lab\n2. Run the playbook to prepare your nodes. You will be prompted for the sudo password:\n   ansible-playbook playbooks/2_prepare_nodes.yml --ask-become-pass\n```\n\n# 6. 执行Playbook，安装Containerd和K8S工具\n\n```bash\nois@ois:~/data$ cd k8s-cilium-lab/\nois@ois:~/data/k8s-cilium-lab$ ansible-playbook playbooks/2_prepare_nodes.yml --ask-become-pass\nBECOME password: \n\nPLAY [Play 1 - Prepare All Nodes] **********************************************************************************************************************************************************************\n\nTASK [Gathering Facts] *********************************************************************************************************************************************************************************\nok: [dns-bgp-server]\nok: [k8s-node-3]\nok: [k8s-node-2]\nok: [k8s-node-1]\n\nTASK [common : Wait for cloud-init to complete] ********************************************************************************************************************************************************\nok: [dns-bgp-server]\nok: [k8s-node-2]\nok: [k8s-node-3]\nok: [k8s-node-1]\n\nTASK [common : Update apt cache and upgrade all packages] **********************************************************************************************************************************************\nchanged: [dns-bgp-server]\nchanged: [k8s-node-3]\nchanged: [k8s-node-1]\nchanged: [k8s-node-2]\n\nTASK [common : Configure /etc/hosts from template] *****************************************************************************************************************************************************\nchanged: [k8s-node-2]\nchanged: [dns-bgp-server]\nchanged: [k8s-node-3]\nchanged: [k8s-node-1]\n\nTASK [common : Turn off all swap devices] **************************************************************************************************************************************************************\nskipping: [dns-bgp-server]\nskipping: [k8s-node-1]\nskipping: [k8s-node-2]\nskipping: [k8s-node-3]\n\nTASK [common : Comment out swap entries in /etc/fstab] *************************************************************************************************************************************************\nskipping: [dns-bgp-server]\nskipping: [k8s-node-1]\nskipping: [k8s-node-2]\nskipping: [k8s-node-3]\n\nTASK [common : Load required kernel modules] ***********************************************************************************************************************************************************\nchanged: [dns-bgp-server] => (item=overlay)\nchanged: [k8s-node-1] => (item=overlay)\nchanged: [k8s-node-2] => (item=overlay)\nchanged: [k8s-node-3] => (item=overlay)\nchanged: [k8s-node-2] => (item=br_netfilter)\nchanged: [dns-bgp-server] => (item=br_netfilter)\nchanged: [k8s-node-1] => (item=br_netfilter)\nchanged: [k8s-node-3] => (item=br_netfilter)\n\nTASK [common : Ensure kernel modules are loaded on boot] ***********************************************************************************************************************************************\nchanged: [dns-bgp-server]\nchanged: [k8s-node-1]\nchanged: [k8s-node-3]\nchanged: [k8s-node-2]\n\nTASK [common : Configure sysctl parameters for Kubernetes networking] **********************************************************************************************************************************\nchanged: [dns-bgp-server]\nchanged: [k8s-node-1]\nchanged: [k8s-node-3]\nchanged: [k8s-node-2]\n\nTASK [common : Apply sysctl settings without reboot] ***************************************************************************************************************************************************\nok: [dns-bgp-server]\nok: [k8s-node-1]\nok: [k8s-node-3]\nok: [k8s-node-2]\n\nPLAY [Play 2 - Prepare Kubernetes Nodes] ***************************************************************************************************************************************************************\n\nTASK [Gathering Facts] *********************************************************************************************************************************************************************************\nok: [k8s-node-3]\nok: [k8s-node-1]\nok: [k8s-node-2]\n\nTASK [k8s_node : Install prerequisite packages] ********************************************************************************************************************************************************\nok: [k8s-node-1]\nok: [k8s-node-2]\nok: [k8s-node-3]\n\nTASK [k8s_node : Ensure apt keyrings directory exists] *************************************************************************************************************************************************\nok: [k8s-node-1]\nok: [k8s-node-3]\nok: [k8s-node-2]\n\nTASK [k8s_node : Add Docker's official GPG key] ********************************************************************************************************************************************************\nchanged: [k8s-node-2]\nchanged: [k8s-node-3]\nchanged: [k8s-node-1]\n\nTASK [k8s_node : Add Docker's repository to Apt sources] ***********************************************************************************************************************************************\nchanged: [k8s-node-2]\nchanged: [k8s-node-1]\nchanged: [k8s-node-3]\n\nTASK [k8s_node : Install containerd] *******************************************************************************************************************************************************************\nchanged: [k8s-node-1]\nchanged: [k8s-node-2]\nchanged: [k8s-node-3]\n\nTASK [k8s_node : Configure containerd from template] ***************************************************************************************************************************************************\nchanged: [k8s-node-1]\nchanged: [k8s-node-2]\nchanged: [k8s-node-3]\n\nTASK [k8s_node : Install prerequisite packages for Kubernetes repo] ************************************************************************************************************************************\nchanged: [k8s-node-2]\nchanged: [k8s-node-3]\nchanged: [k8s-node-1]\n\nTASK [k8s_node : Download the Kubernetes public signing key] *******************************************************************************************************************************************\nchanged: [k8s-node-2]\nchanged: [k8s-node-1]\nchanged: [k8s-node-3]\n\nTASK [k8s_node : Dearmor the Kubernetes GPG key] *******************************************************************************************************************************************************\nchanged: [k8s-node-1]\nchanged: [k8s-node-2]\nchanged: [k8s-node-3]\n\nTASK [k8s_node : Add Kubernetes APT repository] ********************************************************************************************************************************************************\nchanged: [k8s-node-2]\nchanged: [k8s-node-1]\nchanged: [k8s-node-3]\n\nTASK [k8s_node : Clean up temporary key file] **********************************************************************************************************************************************************\nchanged: [k8s-node-1]\nchanged: [k8s-node-2]\nchanged: [k8s-node-3]\n\nTASK [k8s_node : Install kubelet, kubeadm, and kubectl] ************************************************************************************************************************************************\nchanged: [k8s-node-3]\nchanged: [k8s-node-1]\nchanged: [k8s-node-2]\n\nTASK [k8s_node : Pin Kubernetes package versions] ******************************************************************************************************************************************************\nchanged: [k8s-node-2] => (item=kubelet)\nchanged: [k8s-node-3] => (item=kubelet)\nchanged: [k8s-node-1] => (item=kubelet)\nchanged: [k8s-node-2] => (item=kubeadm)\nchanged: [k8s-node-1] => (item=kubeadm)\nchanged: [k8s-node-3] => (item=kubeadm)\nchanged: [k8s-node-2] => (item=kubectl)\nchanged: [k8s-node-3] => (item=kubectl)\nchanged: [k8s-node-1] => (item=kubectl)\n\nTASK [k8s_node : Enable and start kubelet service] *****************************************************************************************************************************************************\nchanged: [k8s-node-2]\nchanged: [k8s-node-3]\nchanged: [k8s-node-1]\n\nRUNNING HANDLER [Restart containerd] *******************************************************************************************************************************************************************\nchanged: [k8s-node-2]\nchanged: [k8s-node-1]\nchanged: [k8s-node-3]\n\nPLAY [Play 3 - Prepare Infrastructure Server] **********************************************************************************************************************************************************\n\nTASK [Gathering Facts] *********************************************************************************************************************************************************************************\nok: [dns-bgp-server]\n\nTASK [infra_server : Install dnsmasq and FRR] **********************************************************************************************************************************************************\nchanged: [dns-bgp-server]\n\nTASK [infra_server : Configure dnsmasq] ****************************************************************************************************************************************************************\nchanged: [dns-bgp-server]\n\nTASK [infra_server : Configure FRR daemons] ************************************************************************************************************************************************************\nok: [dns-bgp-server] => (item=zebra)\nchanged: [dns-bgp-server] => (item=bgpd)\n\nTASK [infra_server : Configure frr.conf] ***************************************************************************************************************************************************************\nchanged: [dns-bgp-server]\n\nTASK [infra_server : Ensure FRR config has correct permissions] ****************************************************************************************************************************************\nok: [dns-bgp-server]\n\nRUNNING HANDLER [Restart dnsmasq] **********************************************************************************************************************************************************************\nchanged: [dns-bgp-server]\n\nRUNNING HANDLER [Restart frr] **************************************************************************************************************************************************************************\nchanged: [dns-bgp-server]\n\nPLAY RECAP *********************************************************************************************************************************************************************************************\ndns-bgp-server             : ok=16   changed=11   unreachable=0    failed=0    skipped=2    rescued=0    ignored=0   \nk8s-node-1                 : ok=24   changed=18   unreachable=0    failed=0    skipped=2    rescued=0    ignored=0   \nk8s-node-2                 : ok=24   changed=18   unreachable=0    failed=0    skipped=2    rescued=0    ignored=0   \nk8s-node-3                 : ok=24   changed=18   unreachable=0    failed=0    skipped=2    rescued=0    ignored=0   \n```\n\n多次执行Playbook，验证幂等性\n\n```bash\nois@ois:~/data/k8s-cilium-lab$ ansible-playbook playbooks/2_prepare_nodes.yml --ask-become-pass\nBECOME password: \n\nPLAY [Play 1 - Prepare All Nodes] **********************************************************************************************************************************************************************\n\nTASK [Gathering Facts] *********************************************************************************************************************************************************************************\nok: [k8s-node-2]\nok: [dns-bgp-server]\nok: [k8s-node-3]\nok: [k8s-node-1]\n\nTASK [common : Wait for cloud-init to complete] ********************************************************************************************************************************************************\nok: [k8s-node-1]\nok: [dns-bgp-server]\nok: [k8s-node-2]\nok: [k8s-node-3]\n\nTASK [common : Update apt cache and upgrade all packages] **********************************************************************************************************************************************\nok: [dns-bgp-server]\nok: [k8s-node-2]\nok: [k8s-node-3]\nok: [k8s-node-1]\n\nTASK [common : Configure /etc/hosts from template] *****************************************************************************************************************************************************\nok: [k8s-node-1]\nok: [k8s-node-3]\nok: [dns-bgp-server]\nok: [k8s-node-2]\n\nTASK [common : Turn off all swap devices] **************************************************************************************************************************************************************\nskipping: [dns-bgp-server]\nskipping: [k8s-node-1]\nskipping: [k8s-node-2]\nskipping: [k8s-node-3]\n\nTASK [common : Comment out swap entries in /etc/fstab] *************************************************************************************************************************************************\nskipping: [dns-bgp-server]\nskipping: [k8s-node-1]\nskipping: [k8s-node-2]\nskipping: [k8s-node-3]\n\nTASK [common : Load required kernel modules] ***********************************************************************************************************************************************************\nok: [k8s-node-2] => (item=overlay)\nok: [dns-bgp-server] => (item=overlay)\nok: [k8s-node-3] => (item=overlay)\nok: [k8s-node-1] => (item=overlay)\nok: [k8s-node-2] => (item=br_netfilter)\nok: [dns-bgp-server] => (item=br_netfilter)\nok: [k8s-node-3] => (item=br_netfilter)\nok: [k8s-node-1] => (item=br_netfilter)\n\nTASK [common : Ensure kernel modules are loaded on boot] ***********************************************************************************************************************************************\nok: [k8s-node-1]\nok: [dns-bgp-server]\nok: [k8s-node-2]\nok: [k8s-node-3]\n\nTASK [common : Configure sysctl parameters for Kubernetes networking] **********************************************************************************************************************************\nok: [dns-bgp-server]\nok: [k8s-node-1]\nok: [k8s-node-2]\nok: [k8s-node-3]\n\nTASK [common : Apply sysctl settings without reboot] ***************************************************************************************************************************************************\nok: [dns-bgp-server]\nok: [k8s-node-1]\nok: [k8s-node-2]\nok: [k8s-node-3]\n\nPLAY [Play 2 - Prepare Kubernetes Nodes] ***************************************************************************************************************************************************************\n\nTASK [Gathering Facts] *********************************************************************************************************************************************************************************\nok: [k8s-node-2]\nok: [k8s-node-1]\nok: [k8s-node-3]\n\nTASK [k8s_node : Install prerequisite packages] ********************************************************************************************************************************************************\nok: [k8s-node-1]\nok: [k8s-node-2]\nok: [k8s-node-3]\n\nTASK [k8s_node : Ensure apt keyrings directory exists] *************************************************************************************************************************************************\nok: [k8s-node-1]\nok: [k8s-node-2]\nok: [k8s-node-3]\n\nTASK [k8s_node : Add Docker's official GPG key] ********************************************************************************************************************************************************\nok: [k8s-node-1]\nok: [k8s-node-2]\nok: [k8s-node-3]\n\nTASK [k8s_node : Add Docker's repository to Apt sources] ***********************************************************************************************************************************************\nok: [k8s-node-2]\nok: [k8s-node-1]\nok: [k8s-node-3]\n\nTASK [k8s_node : Install containerd] *******************************************************************************************************************************************************************\nok: [k8s-node-2]\nok: [k8s-node-1]\nok: [k8s-node-3]\n\nTASK [k8s_node : Configure containerd from template] ***************************************************************************************************************************************************\nok: [k8s-node-1]\nok: [k8s-node-2]\nok: [k8s-node-3]\n\nTASK [k8s_node : Install prerequisite packages for Kubernetes repo] ************************************************************************************************************************************\nok: [k8s-node-2]\nok: [k8s-node-1]\nok: [k8s-node-3]\n\nTASK [k8s_node : Download the Kubernetes public signing key] *******************************************************************************************************************************************\nchanged: [k8s-node-2]\nchanged: [k8s-node-1]\nchanged: [k8s-node-3]\n\nTASK [k8s_node : Dearmor the Kubernetes GPG key] *******************************************************************************************************************************************************\nok: [k8s-node-1]\nok: [k8s-node-2]\nok: [k8s-node-3]\n\nTASK [k8s_node : Add Kubernetes APT repository] ********************************************************************************************************************************************************\nok: [k8s-node-1]\nok: [k8s-node-2]\nok: [k8s-node-3]\n\nTASK [k8s_node : Clean up temporary key file] **********************************************************************************************************************************************************\nchanged: [k8s-node-1]\nchanged: [k8s-node-2]\nchanged: [k8s-node-3]\n\nTASK [k8s_node : Install kubelet, kubeadm, and kubectl] ************************************************************************************************************************************************\nok: [k8s-node-1]\nok: [k8s-node-2]\nok: [k8s-node-3]\n\nTASK [k8s_node : Pin Kubernetes package versions] ******************************************************************************************************************************************************\nok: [k8s-node-1] => (item=kubelet)\nok: [k8s-node-2] => (item=kubelet)\nok: [k8s-node-3] => (item=kubelet)\nok: [k8s-node-1] => (item=kubeadm)\nok: [k8s-node-2] => (item=kubeadm)\nok: [k8s-node-3] => (item=kubeadm)\nok: [k8s-node-1] => (item=kubectl)\nok: [k8s-node-2] => (item=kubectl)\nok: [k8s-node-3] => (item=kubectl)\n\nTASK [k8s_node : Enable and start kubelet service] *****************************************************************************************************************************************************\nok: [k8s-node-1]\nok: [k8s-node-2]\nok: [k8s-node-3]\n\nPLAY [Play 3 - Prepare Infrastructure Server] **********************************************************************************************************************************************************\n\nTASK [Gathering Facts] *********************************************************************************************************************************************************************************\nok: [dns-bgp-server]\n\nTASK [infra_server : Install dnsmasq and FRR] **********************************************************************************************************************************************************\nok: [dns-bgp-server]\n\nTASK [infra_server : Configure dnsmasq] ****************************************************************************************************************************************************************\nok: [dns-bgp-server]\n\nTASK [infra_server : Configure FRR daemons] ************************************************************************************************************************************************************\nok: [dns-bgp-server] => (item=zebra)\nok: [dns-bgp-server] => (item=bgpd)\n\nTASK [infra_server : Configure frr.conf] ***************************************************************************************************************************************************************\nok: [dns-bgp-server]\n\nTASK [infra_server : Ensure FRR config has correct permissions] ****************************************************************************************************************************************\nok: [dns-bgp-server]\n\nPLAY RECAP *********************************************************************************************************************************************************************************************\ndns-bgp-server             : ok=14   changed=0    unreachable=0    failed=0    skipped=2    rescued=0    ignored=0   \nk8s-node-1                 : ok=23   changed=2    unreachable=0    failed=0    skipped=2    rescued=0    ignored=0   \nk8s-node-2                 : ok=23   changed=2    unreachable=0    failed=0    skipped=2    rescued=0    ignored=0   \nk8s-node-3                 : ok=23   changed=2    unreachable=0    failed=0    skipped=2    rescued=0    ignored=0   \n```\n\n# 7. 执行脚本，构建设置K8S Cluster的Playbook\n\n```bash\nois@ois:~/data/k8s-cilium-lab$ cd ..\nois@ois:~/data$ ./03-setup-cluster.sh \n--- Kubernetes Cluster Setup Playbook Generator ---\n\n--- Step 1: Verifying Project Context ---\n✅ Working inside project directory: /home/ois/data/k8s-cilium-lab\n\n--- Step 2: Checking for 'community.kubernetes' Ansible Collection ---\n✅ 'community.kubernetes' collection is already installed.\n\n--- Step 3: Generating Cilium BGP Template ---\n✅ Created Cilium BGP config template.\n\n--- Step 4: Generating Main Playbook ---\n✅ Created main playbook: playbooks/3_setup_cluster.yml\n\n--- Generation Complete! ---\n✅ All necessary files for cluster setup have been created.\n\nNext Step:\n1. IMPORTANT: Reset your cluster nodes to ensure a clean state for this new workflow.\n   On each K8s VM, run: sudo kubeadm reset -f\n2. Change into the project directory: cd k8s-cilium-lab\n3. Run the playbook to build your Kubernetes cluster. You will be prompted for the sudo password:\n   ansible-playbook playbooks/3_setup_cluster.yml --ask-become-pass\n```\n\n# 8. 执行Playbook 设置K8S Cluster和Clium\n\n```bash\nois@ois:~/data$ cd k8s-cilium-lab/\nois@ois:~/data/k8s-cilium-lab$ ansible-playbook playbooks/3_setup_cluster.yml --ask-become-pass\nBECOME password: \n[DEPRECATION WARNING]: community.kubernetes.helm_repository has been deprecated. The community.kubernetes collection is being renamed to kubernetes.core. Please update your FQCNs to kubernetes.core \ninstead. This feature will be removed from community.kubernetes in version 3.0.0. Deprecation warnings can be disabled by setting deprecation_warnings=False in ansible.cfg.\n[DEPRECATION WARNING]: community.kubernetes.helm has been deprecated. The community.kubernetes collection is being renamed to kubernetes.core. Please update your FQCNs to kubernetes.core instead. \nThis feature will be removed from community.kubernetes in version 3.0.0. Deprecation warnings can be disabled by setting deprecation_warnings=False in ansible.cfg.\n[DEPRECATION WARNING]: community.kubernetes.k8s has been deprecated. The community.kubernetes collection is being renamed to kubernetes.core. Please update your FQCNs to kubernetes.core instead. This\n feature will be removed from community.kubernetes in version 3.0.0. Deprecation warnings can be disabled by setting deprecation_warnings=False in ansible.cfg.\n[DEPRECATION WARNING]: community.kubernetes.k8s_info has been deprecated. The community.kubernetes collection is being renamed to kubernetes.core. Please update your FQCNs to kubernetes.core instead.\n This feature will be removed from community.kubernetes in version 3.0.0. Deprecation warnings can be disabled by setting deprecation_warnings=False in ansible.cfg.\n\nPLAY [Play 1 - Initialize and Configure Control Plane] *************************************************************************************************************************************************\n\nTASK [Gathering Facts] *********************************************************************************************************************************************************************************\nok: [k8s-node-1]\n\nTASK [Check if cluster is already initialized] *********************************************************************************************************************************************************\nok: [k8s-node-1]\n\nTASK [Initialize the cluster] **************************************************************************************************************************************************************************\nchanged: [k8s-node-1]\n\nTASK [Create .kube directory for ubuntu user] **********************************************************************************************************************************************************\nchanged: [k8s-node-1]\n\nTASK [Copy admin.conf to user's kube config] ***********************************************************************************************************************************************************\nchanged: [k8s-node-1]\n\nTASK [Set KUBECONFIG for root user permanently] ********************************************************************************************************************************************************\nchanged: [k8s-node-1]\n\nTASK [Install prerequisites for Kubernetes modules] ****************************************************************************************************************************************************\nchanged: [k8s-node-1]\n\nTASK [Install Helm] ************************************************************************************************************************************************************************************\nchanged: [k8s-node-1]\n\nTASK [Install Cilium CLI] ******************************************************************************************************************************************************************************\nchanged: [k8s-node-1]\n\nTASK [Add Helm repositories] ***************************************************************************************************************************************************************************\nchanged: [k8s-node-1] => (item={'name': 'cilium', 'url': 'https://helm.cilium.io/'})\nchanged: [k8s-node-1] => (item={'name': 'isovalent', 'url': 'https://helm.isovalent.com/'})\n\nTASK [Deploy Cilium and Hubble with Helm] **************************************************************************************************************************************************************\nchanged: [k8s-node-1]\n\nTASK [Expose Hubble UI service via NodePort] ***********************************************************************************************************************************************************\n[WARNING]: kubernetes<24.2.0 is not supported or tested. Some features may not work.\nchanged: [k8s-node-1]\n\nTASK [Wait for Cilium CRDs to become available] ********************************************************************************************************************************************************\nFAILED - RETRYING: [k8s-node-1]: Wait for Cilium CRDs to become available (20 retries left).\nFAILED - RETRYING: [k8s-node-1]: Wait for Cilium CRDs to become available (19 retries left).\nFAILED - RETRYING: [k8s-node-1]: Wait for Cilium CRDs to become available (18 retries left).\nFAILED - RETRYING: [k8s-node-1]: Wait for Cilium CRDs to become available (17 retries left).\nFAILED - RETRYING: [k8s-node-1]: Wait for Cilium CRDs to become available (16 retries left).\nFAILED - RETRYING: [k8s-node-1]: Wait for Cilium CRDs to become available (15 retries left).\nFAILED - RETRYING: [k8s-node-1]: Wait for Cilium CRDs to become available (14 retries left).\nFAILED - RETRYING: [k8s-node-1]: Wait for Cilium CRDs to become available (13 retries left).\nFAILED - RETRYING: [k8s-node-1]: Wait for Cilium CRDs to become available (12 retries left).\nFAILED - RETRYING: [k8s-node-1]: Wait for Cilium CRDs to become available (11 retries left).\nFAILED - RETRYING: [k8s-node-1]: Wait for Cilium CRDs to become available (10 retries left).\nFAILED - RETRYING: [k8s-node-1]: Wait for Cilium CRDs to become available (9 retries left).\nok: [k8s-node-1]\n\nTASK [Apply Cilium BGP Configuration from template] ****************************************************************************************************************************************************\nchanged: [k8s-node-1]\n\nTASK [Generate a token for workers to join] ************************************************************************************************************************************************************\nchanged: [k8s-node-1]\n\nTASK [Store the join command for other hosts to access] ************************************************************************************************************************************************\nok: [k8s-node-1]\n\nPLAY [Play 2 - Join Worker Nodes to the Fully Configured Cluster] **************************************************************************************************************************************\n\nTASK [Gathering Facts] *********************************************************************************************************************************************************************************\nok: [k8s-node-2]\nok: [k8s-node-3]\n\nTASK [Check if node has already joined] ****************************************************************************************************************************************************************\nok: [k8s-node-2]\nok: [k8s-node-3]\n\nTASK [Join the cluster] ********************************************************************************************************************************************************************************\nchanged: [k8s-node-2]\nchanged: [k8s-node-3]\n\nPLAY [Play 3 - Display Final Access Information] *******************************************************************************************************************************************************\n\nTASK [Get Hubble UI service details] *******************************************************************************************************************************************************************\nok: [k8s-node-1]\n\nTASK [Display the final access URL] ********************************************************************************************************************************************************************\nok: [k8s-node-1] => {\n    \"msg\": \"========================================================\\n🚀 Your Kubernetes Lab is Ready!\\n\\nAccess the Hubble UI at:\\nhttp://10.75.59.81:31708\\n========================================================\\n\"\n}\n\nPLAY RECAP *********************************************************************************************************************************************************************************************\nk8s-node-1                 : ok=18   changed=12   unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   \nk8s-node-2                 : ok=3    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   \nk8s-node-3                 : ok=3    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   \n```\n\n# 9. 多次执行Playbook，验证幂等性。\n\n```bash\nois@ois:~/data/k8s-cilium-lab$ ansible-playbook playbooks/3_setup_cluster.yml --ask-become-pass\nBECOME password: \n[DEPRECATION WARNING]: community.kubernetes.helm_repository has been deprecated. The community.kubernetes collection is being renamed to kubernetes.core. Please update your FQCNs to kubernetes.core \ninstead. This feature will be removed from community.kubernetes in version 3.0.0. Deprecation warnings can be disabled by setting deprecation_warnings=False in ansible.cfg.\n[DEPRECATION WARNING]: community.kubernetes.helm has been deprecated. The community.kubernetes collection is being renamed to kubernetes.core. Please update your FQCNs to kubernetes.core instead. \nThis feature will be removed from community.kubernetes in version 3.0.0. Deprecation warnings can be disabled by setting deprecation_warnings=False in ansible.cfg.\n[DEPRECATION WARNING]: community.kubernetes.k8s has been deprecated. The community.kubernetes collection is being renamed to kubernetes.core. Please update your FQCNs to kubernetes.core instead. This\n feature will be removed from community.kubernetes in version 3.0.0. Deprecation warnings can be disabled by setting deprecation_warnings=False in ansible.cfg.\n[DEPRECATION WARNING]: community.kubernetes.k8s_info has been deprecated. The community.kubernetes collection is being renamed to kubernetes.core. Please update your FQCNs to kubernetes.core instead.\n This feature will be removed from community.kubernetes in version 3.0.0. Deprecation warnings can be disabled by setting deprecation_warnings=False in ansible.cfg.\n\nPLAY [Play 1 - Initialize and Configure Control Plane] *************************************************************************************************************************************************\n\nTASK [Gathering Facts] *********************************************************************************************************************************************************************************\nok: [k8s-node-1]\n\nTASK [Check if cluster is already initialized] *********************************************************************************************************************************************************\nok: [k8s-node-1]\n\nTASK [Initialize the cluster] **************************************************************************************************************************************************************************\nskipping: [k8s-node-1]\n\nTASK [Create .kube directory for ubuntu user] **********************************************************************************************************************************************************\nskipping: [k8s-node-1]\n\nTASK [Copy admin.conf to user's kube config] ***********************************************************************************************************************************************************\nskipping: [k8s-node-1]\n\nTASK [Set KUBECONFIG for root user permanently] ********************************************************************************************************************************************************\nok: [k8s-node-1]\n\nTASK [Install prerequisites for Kubernetes modules] ****************************************************************************************************************************************************\nok: [k8s-node-1]\n\nTASK [Install Helm] ************************************************************************************************************************************************************************************\nskipping: [k8s-node-1]\n\nTASK [Install Cilium CLI] ******************************************************************************************************************************************************************************\nskipping: [k8s-node-1]\n\nTASK [Add Helm repositories] ***************************************************************************************************************************************************************************\nok: [k8s-node-1] => (item={'name': 'cilium', 'url': 'https://helm.cilium.io/'})\nok: [k8s-node-1] => (item={'name': 'isovalent', 'url': 'https://helm.isovalent.com/'})\n\nTASK [Deploy Cilium and Hubble with Helm] **************************************************************************************************************************************************************\n[WARNING]: The default idempotency check can fail to report changes in certain cases. Install helm diff >= 3.4.1 for better results.\nok: [k8s-node-1]\n\nTASK [Expose Hubble UI service via NodePort] ***********************************************************************************************************************************************************\n[WARNING]: kubernetes<24.2.0 is not supported or tested. Some features may not work.\nok: [k8s-node-1]\n\nTASK [Wait for Cilium CRDs to become available] ********************************************************************************************************************************************************\nok: [k8s-node-1]\n\nTASK [Apply Cilium BGP Configuration from template] ****************************************************************************************************************************************************\nok: [k8s-node-1]\n\nTASK [Generate a token for workers to join] ************************************************************************************************************************************************************\nchanged: [k8s-node-1]\n\nTASK [Store the join command for other hosts to access] ************************************************************************************************************************************************\nok: [k8s-node-1]\n\nPLAY [Play 2 - Join Worker Nodes to the Fully Configured Cluster] **************************************************************************************************************************************\n\nTASK [Gathering Facts] *********************************************************************************************************************************************************************************\nok: [k8s-node-2]\nok: [k8s-node-3]\n\nTASK [Check if node has already joined] ****************************************************************************************************************************************************************\nok: [k8s-node-2]\nok: [k8s-node-3]\n\nTASK [Join the cluster] ********************************************************************************************************************************************************************************\nskipping: [k8s-node-2]\nskipping: [k8s-node-3]\n\nPLAY [Play 3 - Display Final Access Information] *******************************************************************************************************************************************************\n\nTASK [Get Hubble UI service details] *******************************************************************************************************************************************************************\nok: [k8s-node-1]\n\nTASK [Display the final access URL] ********************************************************************************************************************************************************************\nok: [k8s-node-1] => {\n    \"msg\": \"========================================================\\n🚀 Your Kubernetes Lab is Ready!\\n\\nAccess the Hubble UI at:\\nhttp://10.75.59.81:31708\\n========================================================\\n\"\n}\n\nPLAY RECAP *********************************************************************************************************************************************************************************************\nk8s-node-1                 : ok=13   changed=1    unreachable=0    failed=0    skipped=5    rescued=0    ignored=0   \nk8s-node-2                 : ok=2    changed=0    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   \nk8s-node-3                 : ok=2    changed=0    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   \n```\n\n# 10. 部署Demo App\n\n```bash\nois@ois:~/data/k8s-cilium-lab$ cd ../\nois@ois:~/data$ ./04-deploy-star-wars.sh \n--- Star Wars Demo Script Deployer ---\n\n--- Step 1: Verifying Project Context ---\n✅ Working inside project directory: /home/ois/data/k8s-cilium-lab\n\n--- Step 2: Generating the script template ---\n✅ Created template: templates/deploy-star-wars.sh.j2\n\n--- Step 3: Generating the deployment playbook ---\n✅ Created playbook: playbooks/4_deploy_app.yml\n\n--- Generation Complete! ---\n✅ All necessary files for deploying the application script have been created.\n\nNext Steps:\n1. Change into the project directory: cd k8s-cilium-lab\n2. Run the playbook to copy the script to your control plane node:\n   ansible-playbook playbooks/4_deploy_app.yml --ask-become-pass\n3. SSH into the control plane and run the script:\n   ssh ubuntu@k8s-node-1\n   sudo /root/deploy-star-wars.sh\nois@ois:~/data$ cd k8s-cilium-lab/\nois@ois:~/data/k8s-cilium-lab$ ansible-playbook playbooks/4_deploy_app.yml --ask-become-pass\nBECOME password: \n\nPLAY [Deploy Star Wars Demo Script] ********************************************************************************************************************************************************************\n\nTASK [Gathering Facts] *********************************************************************************************************************************************************************************\nok: [k8s-node-1]\n\nTASK [Copy the Star Wars deployment script to the control plane] ***************************************************************************************************************************************\nchanged: [k8s-node-1]\n\nPLAY RECAP *********************************************************************************************************************************************************************************************\nk8s-node-1                 : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   \n\nois@ois:~/data/k8s-cilium-lab$ \nois@ois:~/data/k8s-cilium-lab$ ssh ubuntu@10.75.59.81\nWelcome to Ubuntu 24.04.2 LTS (GNU/Linux 6.8.0-63-generic x86_64)\n\n * Documentation:  https://help.ubuntu.com\n * Management:     https://landscape.canonical.com\n * Support:        https://ubuntu.com/pro\n\n System information as of Mon Aug  4 05:00:52 PM CST 2025\n\n  System load:  0.26               Processes:               195\n  Usage of /:   33.4% of 18.33GB   Users logged in:         0\n  Memory usage: 16%                IPv4 address for enp1s0: 10.75.59.81\n  Swap usage:   0%\n\n\nExpanded Security Maintenance for Applications is not enabled.\n\n0 updates can be applied immediately.\n\nEnable ESM Apps to receive additional future security updates.\nSee https://ubuntu.com/esm or run: sudo pro status\n\n\n*** System restart required ***\nLast login: Mon Aug  4 16:55:53 2025 from 10.75.59.129\nubuntu@k8s-node-1:~$ sudo su\n[sudo] password for ubuntu: \nroot@k8s-node-1:/home/ubuntu# cd\nroot@k8s-node-1:~# cilium status\n    /¯¯\\\n /¯¯\\__/¯¯\\    Cilium:             OK\n \\__/¯¯\\__/    Operator:           OK\n /¯¯\\__/¯¯\\    Envoy DaemonSet:    OK\n \\__/¯¯\\__/    Hubble Relay:       OK\n    \\__/       ClusterMesh:        disabled\n\nDaemonSet              cilium                   Desired: 3, Ready: 3/3, Available: 3/3\nDaemonSet              cilium-envoy             Desired: 3, Ready: 3/3, Available: 3/3\nDeployment             cilium-operator          Desired: 2, Ready: 2/2, Available: 2/2\nDeployment             hubble-relay             Desired: 1, Ready: 1/1, Available: 1/1\nDeployment             hubble-ui                Desired: 1, Ready: 1/1, Available: 1/1\nContainers:            cilium                   Running: 3\n                       cilium-envoy             Running: 3\n                       cilium-operator          Running: 2\n                       clustermesh-apiserver    \n                       hubble-relay             Running: 1\n                       hubble-ui                Running: 1\nCluster Pods:          8/8 managed by Cilium\nHelm chart version:    1.17.6\nImage versions         cilium             quay.io/isovalent/cilium:v1.17.6-cee.1@sha256:2d01daf4f25f7d644889b49ca856e1a4269981fc963e50bd3962665b41b6adb3: 3\n                       cilium-envoy       quay.io/isovalent/cilium-envoy:v1.17.6-cee.1@sha256:318eff387835ca2717baab42a84f35a83a5f9e7d519253df87269f80b9ff0171: 3\n                       cilium-operator    quay.io/isovalent/operator-generic:v1.17.6-cee.1@sha256:2e602710a7c4f101831df679e5d8251bae8bf0f9fe26c20bbef87f1966ea8265: 2\n                       hubble-relay       quay.io/isovalent/hubble-relay:v1.17.6-cee.1@sha256:d378e3607f7492374e65e2bd854cc0ec87480c63ba49a96dadcd75a6946b586e: 1\n                       hubble-ui          quay.io/isovalent/hubble-ui-backend:v1.17.6-cee.1@sha256:a034b7e98e6ea796ed26df8f4e71f83fc16465a19d166eff67a03b822c0bfa15: 1\n                       hubble-ui          quay.io/isovalent/hubble-ui:v1.17.6-cee.1@sha256:9e37c1296b802830834cc87342a9182ccbb71ffebb711971e849221bd9d59392: 1\nroot@k8s-node-1:~# \nroot@k8s-node-1:~# ./deploy-star-wars.sh \n🚀 Starting Star Wars Demo Application Deployment...\n=================================================\n\n--- Step 1: Ensuring 'star-wars' namespace exists ---\n\n▶️  Running command:\n  kubectl create namespace star-wars\nnamespace/star-wars created\n✅ Namespace 'star-wars' created.\n\n--- Step 2: Applying application manifest from GitHub ---\n\n▶️  Running command:\n  kubectl apply -n star-wars -f https://raw.githubusercontent.com/cilium/cilium/HEAD/examples/minikube/http-sw-app.yaml\nservice/deathstar created\ndeployment.apps/deathstar created\npod/tiefighter created\npod/xwing created\n\n--- Step 3: Waiting for all application pods to be ready ---\n  (This may take a minute as images are pulled...)\n\n▶️  Running command:\n  kubectl wait --for=condition=ready pod --all -n star-wars --timeout=120s\npod/deathstar-86f85ffb4d-8xbb4 condition met\npod/deathstar-86f85ffb4d-dwfx5 condition met\npod/tiefighter condition met\npod/xwing condition met\n✅ All pods are running and ready.\n\n--- Step 4: Displaying pod status ---\n\n▶️  Running command:\n  kubectl -n star-wars get pod -o wide --show-labels\nNAME                         READY   STATUS    RESTARTS   AGE   IP             NODE         NOMINATED NODE   READINESS GATES   LABELS\ndeathstar-86f85ffb4d-8xbb4   1/1     Running   0          24s   172.16.2.92    k8s-node-3   <none>           <none>            app.kubernetes.io/name=deathstar,class=deathstar,org=empire,pod-template-hash=86f85ffb4d\ndeathstar-86f85ffb4d-dwfx5   1/1     Running   0          24s   172.16.1.198   k8s-node-2   <none>           <none>            app.kubernetes.io/name=deathstar,class=deathstar,org=empire,pod-template-hash=86f85ffb4d\ntiefighter                   1/1     Running   0          24s   172.16.2.180   k8s-node-3   <none>           <none>            app.kubernetes.io/name=tiefighter,class=tiefighter,org=empire\nxwing                        1/1     Running   0          24s   172.16.2.156   k8s-node-3   <none>           <none>            app.kubernetes.io/name=xwing,class=xwing,org=alliance\n\n--- Step 5: Exposing 'deathstar' service via NodePort ---\n\n▶️  Running command:\n  kubectl -n star-wars patch service deathstar -p {\"spec\":{\"type\":\"NodePort\"}}\nservice/deathstar patched\n✅ Service 'deathstar' patched to NodePort.\n\n--- Step 6: Testing connectivity from client pods ---\n  (A 'Ship landed' message indicates success)\n\n▶️  Running command:\n  kubectl -n star-wars exec tiefighter -- curl -s -XPOST http://deathstar.star-wars.svc.cluster.local/v1/request-landing\nShip landed\n\n▶️  Running command:\n  kubectl -n star-wars exec xwing -- curl -s -XPOST http://deathstar.star-wars.svc.cluster.local/v1/request-landing\nShip landed\n\n--- Step 7: Displaying external access information ---\n\n=================================================\n🎉 Star Wars Demo Application Deployed Successfully!\n   You can access the Deathstar service from outside the cluster at:\n   curl -XPOST http://10.75.59.81:30719/v1/request-landing\n=================================================\nroot@k8s-node-1:~# curl -XPOST http://10.75.59.81:30719/v1/request-landing\nShip landed\nroot@k8s-node-1:~# exit\nexit\nubuntu@k8s-node-1:~$ curl -XPOST http://10.75.59.81:30719/v1/request-landing\nShip landed\nroot@k8s-node-1:~# kubectl get nodes -o wide\nNAME         STATUS   ROLES           AGE   VERSION   INTERNAL-IP   EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION     CONTAINER-RUNTIME\nk8s-node-1   Ready    control-plane   21m   v1.33.3   10.75.59.81   <none>        Ubuntu 24.04.2 LTS   6.8.0-63-generic   containerd://1.7.27\nk8s-node-2   Ready    <none>          19m   v1.33.3   10.75.59.82   <none>        Ubuntu 24.04.2 LTS   6.8.0-63-generic   containerd://1.7.27\nk8s-node-3   Ready    <none>          19m   v1.33.3   10.75.59.83   <none>        Ubuntu 24.04.2 LTS   6.8.0-63-generic   containerd://1.7.27\nroot@k8s-node-1:~# kubectl get pods -A -o wide\nNAMESPACE     NAME                                 READY   STATUS    RESTARTS   AGE   IP             NODE         NOMINATED NODE   READINESS GATES\nkube-system   cilium-45qr7                         1/1     Running   0          19m   10.75.59.83    k8s-node-3   <none>           <none>\nkube-system   cilium-9q5s7                         1/1     Running   0          19m   10.75.59.82    k8s-node-2   <none>           <none>\nkube-system   cilium-envoy-72jj7                   1/1     Running   0          19m   10.75.59.82    k8s-node-2   <none>           <none>\nkube-system   cilium-envoy-d8hb4                   1/1     Running   0          20m   10.75.59.81    k8s-node-1   <none>           <none>\nkube-system   cilium-envoy-vvsms                   1/1     Running   0          19m   10.75.59.83    k8s-node-3   <none>           <none>\nkube-system   cilium-operator-d67c55dc8-lfpjb      1/1     Running   0          20m   10.75.59.81    k8s-node-1   <none>           <none>\nkube-system   cilium-operator-d67c55dc8-rpfv8      1/1     Running   0          20m   10.75.59.82    k8s-node-2   <none>           <none>\nkube-system   cilium-xbjqm                         1/1     Running   0          20m   10.75.59.81    k8s-node-1   <none>           <none>\nkube-system   coredns-674b8bbfcf-n9wgt             1/1     Running   0          21m   172.16.0.105   k8s-node-1   <none>           <none>\nkube-system   coredns-674b8bbfcf-ntssg             1/1     Running   0          21m   172.16.0.161   k8s-node-1   <none>           <none>\nkube-system   etcd-k8s-node-1                      1/1     Running   0          21m   10.75.59.81    k8s-node-1   <none>           <none>\nkube-system   hubble-relay-cfb755899-46pzc         1/1     Running   0          20m   172.16.1.115   k8s-node-2   <none>           <none>\nkube-system   hubble-ui-68c64498c4-p2nq4           2/2     Running   0          20m   172.16.1.105   k8s-node-2   <none>           <none>\nkube-system   kube-apiserver-k8s-node-1            1/1     Running   0          21m   10.75.59.81    k8s-node-1   <none>           <none>\nkube-system   kube-controller-manager-k8s-node-1   1/1     Running   0          21m   10.75.59.81    k8s-node-1   <none>           <none>\nkube-system   kube-scheduler-k8s-node-1            1/1     Running   0          21m   10.75.59.81    k8s-node-1   <none>           <none>\nstar-wars     deathstar-86f85ffb4d-8xbb4           1/1     Running   0          12m   172.16.2.92    k8s-node-3   <none>           <none>\nstar-wars     deathstar-86f85ffb4d-dwfx5           1/1     Running   0          12m   172.16.1.198   k8s-node-2   <none>           <none>\nstar-wars     tiefighter                           1/1     Running   0          12m   172.16.2.180   k8s-node-3   <none>           <none>\nstar-wars     xwing                                1/1     Running   0          12m   172.16.2.156   k8s-node-3   <none>           <none>\nroot@k8s-node-1:~# kubectl get deployment -A -o wide\nNAMESPACE     NAME              READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS         IMAGES                                                                                                                                                                                                                                        SELECTOR\nkube-system   cilium-operator   2/2     2            2           21m   cilium-operator    quay.io/isovalent/operator-generic:v1.17.6-cee.1@sha256:2e602710a7c4f101831df679e5d8251bae8bf0f9fe26c20bbef87f1966ea8265                                                                                                                      io.cilium/app=operator,name=cilium-operator\nkube-system   coredns           2/2     2            2           22m   coredns            registry.k8s.io/coredns/coredns:v1.12.0                                                                                                                                                                                                       k8s-app=kube-dns\nkube-system   hubble-relay      1/1     1            1           21m   hubble-relay       quay.io/isovalent/hubble-relay:v1.17.6-cee.1@sha256:d378e3607f7492374e65e2bd854cc0ec87480c63ba49a96dadcd75a6946b586e                                                                                                                          k8s-app=hubble-relay\nkube-system   hubble-ui         1/1     1            1           21m   frontend,backend   quay.io/isovalent/hubble-ui:v1.17.6-cee.1@sha256:9e37c1296b802830834cc87342a9182ccbb71ffebb711971e849221bd9d59392,quay.io/isovalent/hubble-ui-backend:v1.17.6-cee.1@sha256:a034b7e98e6ea796ed26df8f4e71f83fc16465a19d166eff67a03b822c0bfa15   k8s-app=hubble-ui\nstar-wars     deathstar         2/2     2            2           12m   deathstar          quay.io/cilium/starwars@sha256:896dc536ec505778c03efedb73c3b7b83c8de11e74264c8c35291ff6d5fe8ada                                                                                                                                               class=deathstar,org=empire\n\n```\n# 11. 系统信息探索\n## 11.1 K8S 和 Cilium相关信息\n```bash\nroot@k8s-node-1:~# helm get values cilium -n kube-system\nUSER-SUPPLIED VALUES:\nautoDirectNodeRoutes: true\nbgpControlPlane:\n  announce:\n    podCIDR: true\n  enabled: true\nbpf:\n  lb:\n    externalClusterIP: true\n    sock: true\n  masquerade: true\nenableIPv4Masquerade: true\nhubble:\n  enabled: true\n  relay:\n    enabled: true\n  ui:\n    enabled: true\nipam:\n  mode: kubernetes\nipv4NativeRoutingCIDR: 172.16.0.0/20\nk8s:\n  requireIPv4PodCIDR: true\nk8sServiceHost: 10.75.59.81\nk8sServicePort: 6443\nkubeProxyReplacement: true\nroutingMode: native\nroot@k8s-node-1:~# \nroot@k8s-node-1:~# kubectl -n kube-system get configmap cilium-config -o yaml\napiVersion: v1\ndata:\n  agent-not-ready-taint-key: node.cilium.io/agent-not-ready\n  arping-refresh-period: 30s\n  auto-direct-node-routes: \"true\"\n  bgp-secrets-namespace: kube-system\n  bpf-distributed-lru: \"false\"\n  bpf-events-drop-enabled: \"true\"\n  bpf-events-policy-verdict-enabled: \"true\"\n  bpf-events-trace-enabled: \"true\"\n  bpf-lb-acceleration: disabled\n  bpf-lb-algorithm-annotation: \"false\"\n  bpf-lb-external-clusterip: \"false\"\n  bpf-lb-map-max: \"65536\"\n  bpf-lb-mode-annotation: \"false\"\n  bpf-lb-sock: \"false\"\n  bpf-lb-source-range-all-types: \"false\"\n  bpf-map-dynamic-size-ratio: \"0.0025\"\n  bpf-policy-map-max: \"16384\"\n  bpf-root: /sys/fs/bpf\n  cgroup-root: /run/cilium/cgroupv2\n  cilium-endpoint-gc-interval: 5m0s\n  cluster-id: \"0\"\n  cluster-name: default\n  clustermesh-enable-endpoint-sync: \"false\"\n  clustermesh-enable-mcs-api: \"false\"\n  cni-exclusive: \"true\"\n  cni-log-file: /var/run/cilium/cilium-cni.log\n  custom-cni-conf: \"false\"\n  datapath-mode: veth\n  debug: \"false\"\n  debug-verbose: \"\"\n  default-lb-service-ipam: lbipam\n  direct-routing-skip-unreachable: \"false\"\n  dnsproxy-enable-transparent-mode: \"true\"\n  dnsproxy-socket-linger-timeout: \"10\"\n  egress-gateway-ha-reconciliation-trigger-interval: 1s\n  egress-gateway-reconciliation-trigger-interval: 1s\n  enable-auto-protect-node-port-range: \"true\"\n  enable-bfd: \"false\"\n  enable-bgp-control-plane: \"true\"\n  enable-bgp-control-plane-status-report: \"true\"\n  enable-bpf-clock-probe: \"false\"\n  enable-bpf-masquerade: \"true\"\n  enable-cluster-aware-addressing: \"false\"\n  enable-egress-gateway-ha-socket-termination: \"false\"\n  enable-endpoint-health-checking: \"true\"\n  enable-endpoint-lockdown-on-policy-overflow: \"false\"\n  enable-experimental-lb: \"false\"\n  enable-health-check-loadbalancer-ip: \"false\"\n  enable-health-check-nodeport: \"true\"\n  enable-health-checking: \"true\"\n  enable-hubble: \"true\"\n  enable-inter-cluster-snat: \"false\"\n  enable-internal-traffic-policy: \"true\"\n  enable-ipv4: \"true\"\n  enable-ipv4-big-tcp: \"false\"\n  enable-ipv4-masquerade: \"true\"\n  enable-ipv6: \"false\"\n  enable-ipv6-big-tcp: \"false\"\n  enable-ipv6-masquerade: \"true\"\n  enable-k8s-networkpolicy: \"true\"\n  enable-k8s-terminating-endpoint: \"true\"\n  enable-l2-neigh-discovery: \"true\"\n  enable-l7-proxy: \"true\"\n  enable-lb-ipam: \"true\"\n  enable-local-redirect-policy: \"false\"\n  enable-masquerade-to-route-source: \"false\"\n  enable-metrics: \"true\"\n  enable-node-selector-labels: \"false\"\n  enable-non-default-deny-policies: \"false\"\n  enable-phantom-services: \"false\"\n  enable-policy: default\n  enable-policy-secrets-sync: \"true\"\n  enable-runtime-device-detection: \"true\"\n  enable-sctp: \"false\"\n  enable-source-ip-verification: \"true\"\n  enable-srv6: \"false\"\n  enable-svc-source-range-check: \"true\"\n  enable-tcx: \"true\"\n  enable-vtep: \"false\"\n  enable-well-known-identities: \"false\"\n  enable-xt-socket-fallback: \"true\"\n  envoy-access-log-buffer-size: \"4096\"\n  envoy-base-id: \"0\"\n  envoy-keep-cap-netbindservice: \"false\"\n  export-aggregation: \"\"\n  export-aggregation-renew-ttl: \"true\"\n  export-aggregation-state-filter: \"\"\n  export-file-path: \"\"\n  external-envoy-proxy: \"true\"\n  feature-gates-approved: \"\"\n  feature-gates-strict: \"true\"\n  health-check-icmp-failure-threshold: \"3\"\n  http-retry-count: \"3\"\n  hubble-disable-tls: \"false\"\n  hubble-export-file-max-backups: \"5\"\n  hubble-export-file-max-size-mb: \"10\"\n  hubble-listen-address: :4244\n  hubble-socket-path: /var/run/cilium/hubble.sock\n  hubble-tls-cert-file: /var/lib/cilium/tls/hubble/server.crt\n  hubble-tls-client-ca-files: /var/lib/cilium/tls/hubble/client-ca.crt\n  hubble-tls-key-file: /var/lib/cilium/tls/hubble/server.key\n  identity-allocation-mode: crd\n  identity-gc-interval: 15m0s\n  identity-heartbeat-timeout: 30m0s\n  install-no-conntrack-iptables-rules: \"false\"\n  ipam: kubernetes\n  ipam-cilium-node-update-rate: 15s\n  iptables-random-fully: \"false\"\n  ipv4-native-routing-cidr: 172.16.0.0/20\n  k8s-require-ipv4-pod-cidr: \"true\"\n  k8s-require-ipv6-pod-cidr: \"false\"\n  kube-proxy-replacement: \"true\"\n  kube-proxy-replacement-healthz-bind-address: \"\"\n  max-connected-clusters: \"255\"\n  mesh-auth-enabled: \"true\"\n  mesh-auth-gc-interval: 5m0s\n  mesh-auth-queue-size: \"1024\"\n  mesh-auth-rotated-identities-queue-size: \"1024\"\n  monitor-aggregation: medium\n  monitor-aggregation-flags: all\n  monitor-aggregation-interval: 5s\n  multicast-enabled: \"false\"\n  nat-map-stats-entries: \"32\"\n  nat-map-stats-interval: 30s\n  node-port-bind-protection: \"true\"\n  nodeport-addresses: \"\"\n  nodes-gc-interval: 5m0s\n  operator-api-serve-addr: 127.0.0.1:9234\n  operator-prometheus-serve-addr: :9963\n  policy-cidr-match-mode: \"\"\n  policy-secrets-namespace: cilium-secrets\n  policy-secrets-only-from-secrets-namespace: \"true\"\n  preallocate-bpf-maps: \"false\"\n  procfs: /host/proc\n  proxy-connect-timeout: \"2\"\n  proxy-idle-timeout-seconds: \"60\"\n  proxy-initial-fetch-timeout: \"30\"\n  proxy-max-concurrent-retries: \"128\"\n  proxy-max-connection-duration-seconds: \"0\"\n  proxy-max-requests-per-connection: \"0\"\n  proxy-xff-num-trusted-hops-egress: \"0\"\n  proxy-xff-num-trusted-hops-ingress: \"0\"\n  remove-cilium-node-taints: \"true\"\n  routing-mode: native\n  service-no-backend-response: reject\n  set-cilium-is-up-condition: \"true\"\n  set-cilium-node-taints: \"true\"\n  srv6-encap-mode: reduced\n  srv6-locator-pool-enabled: \"false\"\n  synchronize-k8s-nodes: \"true\"\n  tofqdns-dns-reject-response-code: refused\n  tofqdns-enable-dns-compression: \"true\"\n  tofqdns-endpoint-max-ip-per-hostname: \"1000\"\n  tofqdns-idle-connection-grace-period: 0s\n  tofqdns-max-deferred-connection-deletes: \"10000\"\n  tofqdns-proxy-response-max-delay: 100ms\n  tunnel-protocol: vxlan\n  tunnel-source-port-range: 0-0\n  unmanaged-pod-watcher-interval: \"15\"\n  vtep-cidr: \"\"\n  vtep-endpoint: \"\"\n  vtep-mac: \"\"\n  vtep-mask: \"\"\n  write-cni-conf-when-ready: /host/etc/cni/net.d/05-cilium.conflist\nkind: ConfigMap\nmetadata:\n  annotations:\n    meta.helm.sh/release-name: cilium\n    meta.helm.sh/release-namespace: kube-system\n  creationTimestamp: \"2025-08-04T08:52:46Z\"\n  labels:\n    app.kubernetes.io/managed-by: Helm\n  name: cilium-config\n  namespace: kube-system\n  resourceVersion: \"436\"\n  uid: 614c6b36-9112-4fd0-bebf-e92741fa28da\nroot@k8s-node-1:~# kubectl exec -n kube-system -it cilium-45qr7 -- /bin/sh\nDefaulted container \"cilium-agent\" out of: cilium-agent, config (init), mount-cgroup (init), apply-sysctl-overwrites (init), mount-bpf-fs (init), clean-cilium-state (init), install-cni-binaries (init)\n/home/cilium # cilium status\nKVStore:                 Disabled   \nKubernetes:              Ok         1.33 (v1.33.3) [linux/amd64]\nKubernetes APIs:         [\"EndpointSliceOrEndpoint\", \"cilium/v2::CiliumClusterwideNetworkPolicy\", \"cilium/v2::CiliumEndpoint\", \"cilium/v2::CiliumNetworkPolicy\", \"cilium/v2::CiliumNode\", \"cilium/v2alpha1::CiliumCIDRGroup\", \"core/v1::Namespace\", \"core/v1::Pods\", \"core/v1::Service\", \"isovalent/v1alpha1::IsovalentClusterwideNetworkPolicy\", \"isovalent/v1alpha1::IsovalentNetworkPolicy\", \"networking.k8s.io/v1::NetworkPolicy\"]\nKubeProxyReplacement:    True   [enp1s0   10.75.59.83 fe80::5054:ff:fead:b814 (Direct Routing)]\nHost firewall:           Disabled\nSRv6:                    Disabled\nCNI Chaining:            none\nCNI Config file:         successfully wrote CNI configuration file to /host/etc/cni/net.d/05-cilium.conflist\nCilium:                  Ok   1.17.6-cee.1 (v1.17.6-cee.1-a33b0b85)\nNodeMonitor:             Listening for events on 4 CPUs with 64x4096 of shared memory\nCilium health daemon:    Ok   \nIPAM:                    IPv4: 5/254 allocated from 172.16.2.0/24, \nIPv4 BIG TCP:            Disabled\nIPv6 BIG TCP:            Disabled\nBandwidthManager:        Disabled\nRouting:                 Network: Native   Host: BPF\nAttach Mode:             TCX\nDevice Mode:             veth\nMasquerading:            BPF   [enp1s0]   172.16.0.0/20 [IPv4: Enabled, IPv6: Disabled]\nController Status:       36/36 healthy\nProxy Status:            OK, ip 172.16.2.88, 0 redirects active on ports 10000-20000, Envoy: external\nGlobal Identity Range:   min 256, max 65535\nHubble:                  Ok              Current/Max Flows: 2522/4095 (61.59%), Flows/s: 1.51   Metrics: Disabled\nEncryption:              Disabled        \nCluster health:          3/3 reachable   (2025-08-04T09:21:04Z)\nName                     IP              Node   Endpoints\nModules Health:          Stopped(0) Degraded(0) OK(68)\n/home/cilium # cilium status --verbose\nKVStore:                Disabled   \nKubernetes:             Ok         1.33 (v1.33.3) [linux/amd64]\nKubernetes APIs:        [\"EndpointSliceOrEndpoint\", \"cilium/v2::CiliumClusterwideNetworkPolicy\", \"cilium/v2::CiliumEndpoint\", \"cilium/v2::CiliumNetworkPolicy\", \"cilium/v2::CiliumNode\", \"cilium/v2alpha1::CiliumCIDRGroup\", \"core/v1::Namespace\", \"core/v1::Pods\", \"core/v1::Service\", \"isovalent/v1alpha1::IsovalentClusterwideNetworkPolicy\", \"isovalent/v1alpha1::IsovalentNetworkPolicy\", \"networking.k8s.io/v1::NetworkPolicy\"]\nKubeProxyReplacement:   True   [enp1s0   10.75.59.83 fe80::5054:ff:fead:b814 (Direct Routing)]\nHost firewall:          Disabled\nSRv6:                   Disabled\nCNI Chaining:           none\nCNI Config file:        successfully wrote CNI configuration file to /host/etc/cni/net.d/05-cilium.conflist\nCilium:                 Ok   1.17.6-cee.1 (v1.17.6-cee.1-a33b0b85)\nNodeMonitor:            Listening for events on 4 CPUs with 64x4096 of shared memory\nCilium health daemon:   Ok   \nIPAM:                   IPv4: 5/254 allocated from 172.16.2.0/24, \nAllocated addresses:\n  172.16.2.156 (star-wars/xwing)\n  172.16.2.180 (star-wars/tiefighter)\n  172.16.2.35 (health)\n  172.16.2.88 (router)\n  172.16.2.92 (star-wars/deathstar-86f85ffb4d-8xbb4)\nIPv4 BIG TCP:           Disabled\nIPv6 BIG TCP:           Disabled\nBandwidthManager:       Disabled\nRouting:                Network: Native   Host: BPF\nAttach Mode:            TCX\nDevice Mode:            veth\nMasquerading:           BPF   [enp1s0]   172.16.0.0/20 [IPv4: Enabled, IPv6: Disabled]\nClock Source for BPF:   ktime\nController Status:      36/36 healthy\n  Name                                                  Last success   Last error   Count   Message\n  cilium-health-ep                                      1m0s ago       never        0       no error   \n  ct-map-pressure                                       1s ago         never        0       no error   \n  daemon-validate-config                                35s ago        never        0       no error   \n  dns-garbage-collector-job                             3s ago         never        0       no error   \n  endpoint-1375-regeneration-recovery                   never          never        0       no error   \n  endpoint-196-regeneration-recovery                    never          never        0       no error   \n  endpoint-2338-regeneration-recovery                   never          never        0       no error   \n  endpoint-523-regeneration-recovery                    never          never        0       no error   \n  endpoint-640-regeneration-recovery                    never          never        0       no error   \n  endpoint-gc                                           2m3s ago       never        0       no error   \n  endpoint-periodic-regeneration                        1m3s ago       never        0       no error   \n  ep-bpf-prog-watchdog                                  1s ago         never        0       no error   \n  ipcache-inject-labels                                 1s ago         never        0       no error   \n  k8s-heartbeat                                         3s ago         never        0       no error   \n  link-cache                                            3s ago         never        0       no error   \n  node-neighbor-link-updater                            1s ago         never        0       no error   \n  proxy-ports-checkpoint                                27m1s ago      never        0       no error   \n  resolve-identity-1375                                 2m0s ago       never        0       no error   \n  resolve-identity-196                                  1m41s ago      never        0       no error   \n  resolve-identity-2338                                 1m41s ago      never        0       no error   \n  resolve-identity-523                                  2m1s ago       never        0       no error   \n  resolve-identity-640                                  1m41s ago      never        0       no error   \n  resolve-labels-star-wars/deathstar-86f85ffb4d-8xbb4   21m41s ago     never        0       no error   \n  resolve-labels-star-wars/tiefighter                   21m41s ago     never        0       no error   \n  resolve-labels-star-wars/xwing                        21m41s ago     never        0       no error   \n  sync-lb-maps-with-k8s-services                        27m1s ago      never        0       no error   \n  sync-policymap-1375                                   11m56s ago     never        0       no error   \n  sync-policymap-196                                    6m41s ago      never        0       no error   \n  sync-policymap-2338                                   6m41s ago      never        0       no error   \n  sync-policymap-523                                    11m57s ago     never        0       no error   \n  sync-policymap-640                                    6m41s ago      never        0       no error   \n  sync-to-k8s-ciliumendpoint (196)                      1s ago         never        0       no error   \n  sync-to-k8s-ciliumendpoint (2338)                     1s ago         never        0       no error   \n  sync-to-k8s-ciliumendpoint (640)                      1s ago         never        0       no error   \n  sync-utime                                            1s ago         never        0       no error   \n  write-cni-file                                        27m3s ago      never        0       no error   \nProxy Status:            OK, ip 172.16.2.88, 0 redirects active on ports 10000-20000, Envoy: external\nGlobal Identity Range:   min 256, max 65535\nHubble:                  Ok   Current/Max Flows: 2570/4095 (62.76%), Flows/s: 1.51   Metrics: Disabled\nKubeProxyReplacement Details:\n  Status:                 True\n  Socket LB:              Enabled\n  Socket LB Tracing:      Enabled\n  Socket LB Coverage:     Full\n  Devices:                enp1s0   10.75.59.83 fe80::5054:ff:fead:b814 (Direct Routing)\n  Mode:                   SNAT\n  Backend Selection:      Random\n  Session Affinity:       Enabled\n  Graceful Termination:   Enabled\n  NAT46/64 Support:       Disabled\n  XDP Acceleration:       Disabled\n  Services:\n  - ClusterIP:      Enabled\n  - NodePort:       Enabled (Range: 30000-32767) \n  - LoadBalancer:   Enabled \n  - externalIPs:    Enabled \n  - HostPort:       Enabled\n  Annotations:\n  - service.cilium.io/node\n  - service.cilium.io/src-ranges-policy\n  - service.cilium.io/type\nBPF Maps:   dynamic sizing: on (ratio: 0.002500)\n  Name                          Size\n  Auth                          524288\n  Non-TCP connection tracking   65536\n  TCP connection tracking       131072\n  Endpoint policy               65535\n  IP cache                      512000\n  IPv4 masquerading agent       16384\n  IPv6 masquerading agent       16384\n  IPv4 fragmentation            8192\n  IPv4 service                  65536\n  IPv6 service                  65536\n  IPv4 service backend          65536\n  IPv6 service backend          65536\n  IPv4 service reverse NAT      65536\n  IPv6 service reverse NAT      65536\n  Metrics                       1024\n  Ratelimit metrics             64\n  NAT                           131072\n  Neighbor table                131072\n  Global policy                 16384\n  Session affinity              65536\n  Sock reverse NAT              65536\nEncryption:       Disabled        \nCluster health:   3/3 reachable   (2025-08-04T09:21:04Z)\nName              IP              Node   Endpoints\n  k8s-node-3 (localhost):\n    Host connectivity to 10.75.59.83:\n      ICMP to stack:   OK, RTT=451.197µs\n      HTTP to agent:   OK, RTT=625.346µs\n    Endpoint connectivity to 172.16.2.35:\n      ICMP to stack:   OK, RTT=376.939µs\n      HTTP to agent:   OK, RTT=882.754µs\n  k8s-node-1:\n    Host connectivity to 10.75.59.81:\n      ICMP to stack:   OK, RTT=582.892µs\n      HTTP to agent:   OK, RTT=1.042743ms\n    Endpoint connectivity to 172.16.0.116:\n      ICMP to stack:   OK, RTT=703.331µs\n      HTTP to agent:   OK, RTT=1.533329ms\n  k8s-node-2:\n    Host connectivity to 10.75.59.82:\n      ICMP to stack:   OK, RTT=632.658µs\n      HTTP to agent:   OK, RTT=1.156736ms\n    Endpoint connectivity to 172.16.1.173:\n      ICMP to stack:   OK, RTT=636.518µs\n      HTTP to agent:   OK, RTT=1.37198ms\nModules Health:\n      enterprise-agent\n      ├── agent\n      │   ├── controlplane\n      │   │   ├── auth\n      │   │   │   ├── observer-job-auth-gc-identity-events            [OK] OK (1.812µs) [5] (21m, x1)\n      │   │   │   ├── observer-job-auth-request-authentication        [OK] Primed (27m, x1)\n      │   │   │   └── timer-job-auth-gc-cleanup                       [OK] OK (15.847µs) (2m3s, x1)\n      │   │   ├── bgp-control-plane\n      │   │   │   ├── job-bgp-controller                              [OK] Running (27m, x1)\n      │   │   │   ├── job-bgp-crd-status-initialize                   [OK] Running (27m, x1)\n      │   │   │   ├── job-bgp-crd-status-update-job                   [OK] Running (27m, x1)\n      │   │   │   ├── job-bgp-policy-observer                         [OK] Running (27m, x1)\n      │   │   │   ├── job-bgp-reconcile-error-statedb-tracker         [OK] Running (27m, x1)\n      │   │   │   ├── job-bgp-state-observer                          [OK] Running (27m, x1)\n      │   │   │   ├── job-bgpcp-resource-store-events                 [OK] Running (27m, x5)\n      │   │   │   └── job-diffstore-events                            [OK] Running (27m, x2)\n      │   │   ├── ciliumenvoyconfig\n      │   │   │   └── experimental\n      │   │   │       ├── job-reconcile                               [OK] OK, 0 object(s) (27m, x3)\n      │   │   │       └── job-refresh                                 [OK] Next refresh in 30m0s (27m, x1)\n      │   │   ├── daemon\n      │   │   │   ├──                                                 [OK] daemon-validate-config (35s, x27)\n      │   │   │   ├── ep-bpf-prog-watchdog\n      │   │   │   │   └── ep-bpf-prog-watchdog                        [OK] ep-bpf-prog-watchdog (1s, x55)\n      │   │   │   └── job-sync-hostips                                [OK] Synchronized (1s, x29)\n      │   │   ├── dynamic-lifecycle-manager\n      │   │   │   ├── job-reconcile                                   [OK] OK, 0 object(s) (27m, x3)\n      │   │   │   └── job-refresh                                     [OK] Next refresh in 30m0s (27m, x1)\n      │   │   ├── enabled-features\n      │   │   │   └── job-update-config-metric                        [OK] Waiting for agent config (27m, x1)\n      │   │   ├── endpoint-manager\n      │   │   │   ├── cilium-endpoint-1375 (/)\n      │   │   │   │   ├── datapath-regenerate                         [OK] Endpoint regeneration successful (63s, x15)\n      │   │   │   │   └── policymap-sync                              [OK] sync-policymap-1375 (11m, x2)\n      │   │   │   ├── cilium-endpoint-196 (star-wars/xwing)\n      │   │   │   │   ├── cep-k8s-sync                                [OK] sync-to-k8s-ciliumendpoint (196) (1s, x132)\n      │   │   │   │   ├── datapath-regenerate                         [OK] Endpoint regeneration successful (63s, x12)\n      │   │   │   │   └── policymap-sync                              [OK] sync-policymap-196 (6m41s, x2)\n      │   │   │   ├── cilium-endpoint-2338 (star-wars/tiefighter)\n      │   │   │   │   ├── cep-k8s-sync                                [OK] sync-to-k8s-ciliumendpoint (2338) (1s, x132)\n      │   │   │   │   ├── datapath-regenerate                         [OK] Endpoint regeneration successful (63s, x12)\n      │   │   │   │   └── policymap-sync                              [OK] sync-policymap-2338 (6m41s, x2)\n      │   │   │   ├── cilium-endpoint-523 (/)\n      │   │   │   │   ├── datapath-regenerate                         [OK] Endpoint regeneration successful (63s, x16)\n      │   │   │   │   └── policymap-sync                              [OK] sync-policymap-523 (11m, x2)\n      │   │   │   ├── cilium-endpoint-640 (star-wars/deathstar-86f85ffb4d-8xbb4)\n      │   │   │   │   ├── cep-k8s-sync                                [OK] sync-to-k8s-ciliumendpoint (640) (1s, x132)\n      │   │   │   │   ├── datapath-regenerate                         [OK] Endpoint regeneration successful (63s, x12)\n      │   │   │   │   └── policymap-sync                              [OK] sync-policymap-640 (6m41s, x2)\n      │   │   │   └── endpoint-gc                                     [OK] endpoint-gc (2m3s, x6)\n      │   │   ├── envoy-proxy\n      │   │   │   ├── observer-job-k8s-secrets-resource-events-cilium-secrets    [OK] Primed (27m, x1)\n      │   │   │   └── timer-job-version-check                         [OK] OK (13.805158ms) (2m1s, x1)\n      │   │   ├── hubble\n      │   │   │   └── job-hubble                                      [OK] Running (27m, x1)\n      │   │   ├── identity\n      │   │   │   └── timer-job-id-alloc-update-policy-maps           [OK] OK (103.031µs) (21m, x1)\n      │   │   ├── l2-announcer\n      │   │   │   └── job-l2-announcer-lease-gc                       [OK] Running (27m, x1)\n      │   │   ├── nat-stats\n      │   │   │   └── timer-job-nat-stats                             [OK] OK (2.520538ms) (1s, x1)\n      │   │   ├── node-manager\n      │   │   │   ├── background-sync                                 [OK] Node validation successful (66s, x19)\n      │   │   │   ├── neighbor-link-updater\n      │   │   │   │   ├── k8s-node-1                                  [OK] Node neighbor link update successful (61s, x20)\n      │   │   │   │   └── k8s-node-2                                  [OK] Node neighbor link update successful (31s, x20)\n      │   │   │   ├── node-checkpoint-writer                          [OK] node checkpoint written (25m, x3)\n      │   │   │   └── nodes-add                                       [OK] Node adds successful (27m, x3)\n      │   │   ├── policy\n      │   │   │   └── observer-job-policy-importer                    [OK] Primed (27m, x1)\n      │   │   ├── service-manager\n      │   │   │   ├── job-health-check-event-watcher                  [OK] Waiting for health check events (27m, x1)\n      │   │   │   └── job-service-reconciler                          [OK] 1 NodePort frontend addresses (27m, x1)\n      │   │   ├── service-resolver\n      │   │   │   └── job-service-reloader-initializer                [OK] Running (27m, x1)\n      │   │   └── stale-endpoint-cleanup\n      │   │       └── job-endpoint-cleanup                            [OK] Running (27m, x1)\n      │   ├── datapath\n      │   │   ├── agent-liveness-updater\n      │   │   │   └── timer-job-agent-liveness-updater                [OK] OK (82.885µs) (0s, x1)\n      │   │   ├── iptables\n      │   │   │   ├── ipset\n      │   │   │   │   ├── job-ipset-init-finalizer                    [OK] Running (27m, x1)\n      │   │   │   │   ├── job-reconcile                               [OK] OK, 0 object(s) (27m, x2)\n      │   │   │   │   └── job-refresh                                 [OK] Next refresh in 30m0s (27m, x1)\n      │   │   │   └── job-iptables-reconciliation-loop                [OK] iptables rules full reconciliation completed (27m, x1)\n      │   │   ├── l2-responder\n      │   │   │   └── job-l2-responder-reconciler                     [OK] Running (27m, x1)\n      │   │   ├── maps\n      │   │   │   └── bwmap\n      │   │   │       └── timer-job-pressure-metric-throttle          [OK] OK (18.336µs) (1s, x1)\n      │   │   ├── mtu\n      │   │   │   ├── job-endpoint-mtu-updater                        [OK] Endpoint MTU updated (27m, x1)\n      │   │   │   └── job-mtu-updater                                 [OK] MTU updated (1500) (27m, x1)\n      │   │   ├── node-address\n      │   │   │   └── job-node-address-update                         [OK] 172.16.2.88 (primary), fe80::7019:6fff:febf:e8a7 (primary) (27m, x1)\n      │   │   ├── orchestrator\n      │   │   │   └── job-reinitialize                                [OK] OK (26m, x2)\n      │   │   └── sysctl\n      │   │       ├── job-reconcile                                   [OK] OK, 16 object(s) (6m56s, x35)\n      │   │       └── job-refresh                                     [OK] Next refresh in 9m53.185634443s (6m56s, x1)\n      │   └── infra\n      │       ├── k8s-synced-crdsync\n      │       │   └── job-sync-crds                                   [OK] Running (27m, x1)\n      │       ├── metrics\n      │       │   ├── job-collect                                     [OK] Sampled 24 metrics in 4.183045ms, next collection at 2025-08-04 09:26:00.386029804 +0000 UTC m=+1803.177514891 (2m1s, x1)\n      │       │   └── timer-job-cleanup                               [OK] Primed (27m, x1)\n      │       └── shell\n      │           └── job-listener                                    [OK] Listening on /var/run/cilium/shell.sock (27m, x1)\n      └── enterprise-controlplane\n          └── cec-ingress-policy\n              └── timer-job-enterprise-endpoint-policy-periodic-regeneration      [OK] OK (21.899µs) (1s, x1)\n      \n/home/cilium # cilium service list\nID   Frontend                Service Type   Backend                               \n1    172.16.32.1:443/TCP     ClusterIP      1 => 10.75.59.81:6443/TCP (active)    \n2    172.16.42.186:443/TCP   ClusterIP      1 => 10.75.59.83:4244/TCP (active)    \n3    172.16.42.14:80/TCP     ClusterIP      1 => 172.16.1.115:4245/TCP (active)   \n4    172.16.38.134:80/TCP    ClusterIP      1 => 172.16.1.105:8081/TCP (active)   \n5    10.75.59.83:31708/TCP   NodePort       1 => 172.16.1.105:8081/TCP (active)   \n6    0.0.0.0:31708/TCP       NodePort       1 => 172.16.1.105:8081/TCP (active)   \n7    172.16.32.10:53/TCP     ClusterIP      1 => 172.16.0.161:53/TCP (active)     \n                                            2 => 172.16.0.105:53/TCP (active)     \n8    172.16.32.10:9153/TCP   ClusterIP      1 => 172.16.0.161:9153/TCP (active)   \n                                            2 => 172.16.0.105:9153/TCP (active)   \n9    172.16.32.10:53/UDP     ClusterIP      1 => 172.16.0.161:53/UDP (active)     \n                                            2 => 172.16.0.105:53/UDP (active)     \n10   172.16.34.108:80/TCP    ClusterIP      1 => 172.16.1.198:80/TCP (active)     \n                                            2 => 172.16.2.92:80/TCP (active)      \n11   10.75.59.83:30719/TCP   NodePort       1 => 172.16.1.198:80/TCP (active)     \n                                            2 => 172.16.2.92:80/TCP (active)      \n12   0.0.0.0:30719/TCP       NodePort       1 => 172.16.1.198:80/TCP (active)     \n                                            2 => 172.16.2.92:80/TCP (active)      \n/home/cilium # cilium bpf nat list\nTCP IN 10.75.59.82:4240 -> 10.75.59.83:35986 XLATE_DST 10.75.59.83:35986 Created=1076sec ago NeedsCT=1\nICMP IN 10.75.59.81:0 -> 10.75.59.83:63865 XLATE_DST 10.75.59.83:63865 Created=156sec ago NeedsCT=1\nTCP IN 10.75.59.81:4240 -> 10.75.59.83:58402 XLATE_DST 10.75.59.83:58402 Created=56sec ago NeedsCT=1\nICMP OUT 10.75.59.83:47633 -> 10.75.59.81:0 XLATE_SRC 10.75.59.83:47633 Created=56sec ago NeedsCT=1\nICMP OUT 10.75.59.83:56308 -> 172.16.0.116:0 XLATE_SRC 10.75.59.83:56308 Created=206sec ago NeedsCT=1\nICMP OUT 10.75.59.83:40570 -> 10.75.59.82:0 XLATE_SRC 10.75.59.83:40570 Created=226sec ago NeedsCT=1\nTCP IN 172.16.0.116:4240 -> 10.75.59.83:33274 XLATE_DST 10.75.59.83:33274 Created=706sec ago NeedsCT=1\nICMP IN 172.16.0.116:0 -> 10.75.59.83:56308 XLATE_DST 10.75.59.83:56308 Created=206sec ago NeedsCT=1\nTCP OUT 10.75.59.83:37066 -> 10.75.59.81:6443 XLATE_SRC 10.75.59.83:37066 Created=1655sec ago NeedsCT=1\nTCP OUT 10.75.59.83:44064 -> 172.16.1.173:4240 XLATE_SRC 10.75.59.83:44064 Created=1066sec ago NeedsCT=1\nTCP OUT 10.75.59.83:46184 -> 10.75.59.81:6443 XLATE_SRC 10.75.59.83:46184 Created=1651sec ago NeedsCT=1\nTCP OUT 10.75.59.83:43981 -> 10.75.59.86:179 XLATE_SRC 10.75.59.83:43981 Created=1648sec ago NeedsCT=1\nTCP OUT 10.75.59.83:57802 -> 10.75.59.81:4240 XLATE_SRC 10.75.59.83:57802 Created=716sec ago NeedsCT=1\nICMP IN 10.75.59.82:0 -> 10.75.59.83:43531 XLATE_DST 10.75.59.83:43531 Created=36sec ago NeedsCT=1\nTCP IN 10.75.59.86:179 -> 10.75.59.83:43981 XLATE_DST 10.75.59.83:43981 Created=1648sec ago NeedsCT=1\nTCP OUT 10.75.59.83:58402 -> 10.75.59.81:4240 XLATE_SRC 10.75.59.83:58402 Created=56sec ago NeedsCT=1\nICMP OUT 10.75.59.83:43619 -> 10.75.59.82:0 XLATE_SRC 10.75.59.83:43619 Created=176sec ago NeedsCT=1\nICMP OUT 10.75.59.83:40760 -> 10.75.59.81:0 XLATE_SRC 10.75.59.83:40760 Created=216sec ago NeedsCT=1\nTCP IN 142.250.199.100:443 -> 10.75.59.83:40732 XLATE_DST 172.16.2.180:40732 Created=205sec ago NeedsCT=0\nTCP OUT 10.75.59.83:34202 -> 172.16.0.116:4240 XLATE_SRC 10.75.59.83:34202 Created=46sec ago NeedsCT=1\nICMP IN 10.75.59.81:0 -> 10.75.59.83:47633 XLATE_DST 10.75.59.83:47633 Created=56sec ago NeedsCT=1\nTCP OUT 10.75.59.83:33274 -> 172.16.0.116:4240 XLATE_SRC 10.75.59.83:33274 Created=706sec ago NeedsCT=1\nICMP OUT 10.75.59.83:43531 -> 10.75.59.82:0 XLATE_SRC 10.75.59.83:43531 Created=36sec ago NeedsCT=1\nICMP IN 10.75.59.82:0 -> 10.75.59.83:43619 XLATE_DST 10.75.59.83:43619 Created=176sec ago NeedsCT=1\nTCP IN 10.75.59.81:6443 -> 10.75.59.83:37066 XLATE_DST 10.75.59.83:37066 Created=1655sec ago NeedsCT=1\nICMP OUT 10.75.59.83:36675 -> 172.16.1.173:0 XLATE_SRC 10.75.59.83:36675 Created=106sec ago NeedsCT=1\nTCP OUT 172.16.2.180:40732 -> 142.250.199.100:443 XLATE_SRC 10.75.59.83:40732 Created=205sec ago NeedsCT=0\nICMP IN 172.16.0.116:0 -> 10.75.59.83:38433 XLATE_DST 10.75.59.83:38433 Created=276sec ago NeedsCT=1\nTCP OUT 10.75.59.83:35986 -> 10.75.59.82:4240 XLATE_SRC 10.75.59.83:35986 Created=1076sec ago NeedsCT=1\nICMP IN 172.16.1.173:0 -> 10.75.59.83:36675 XLATE_DST 10.75.59.83:36675 Created=106sec ago NeedsCT=1\nTCP IN 10.75.59.81:6443 -> 10.75.59.83:46184 XLATE_DST 10.75.59.83:46184 Created=1651sec ago NeedsCT=1\nTCP IN 172.16.0.116:4240 -> 10.75.59.83:34202 XLATE_DST 10.75.59.83:34202 Created=46sec ago NeedsCT=1\nICMP OUT 10.75.59.83:63865 -> 10.75.59.81:0 XLATE_SRC 10.75.59.83:63865 Created=156sec ago NeedsCT=1\nICMP OUT 10.75.59.83:38433 -> 172.16.0.116:0 XLATE_SRC 10.75.59.83:38433 Created=276sec ago NeedsCT=1\nICMP IN 10.75.59.82:0 -> 10.75.59.83:40570 XLATE_DST 10.75.59.83:40570 Created=226sec ago NeedsCT=1\nICMP OUT 10.75.59.83:36899 -> 172.16.1.173:0 XLATE_SRC 10.75.59.83:36899 Created=236sec ago NeedsCT=1\nICMP IN 172.16.1.173:0 -> 10.75.59.83:36899 XLATE_DST 10.75.59.83:36899 Created=236sec ago NeedsCT=1\nTCP IN 10.75.59.81:4240 -> 10.75.59.83:57802 XLATE_DST 10.75.59.83:57802 Created=716sec ago NeedsCT=1\nICMP IN 10.75.59.81:0 -> 10.75.59.83:40760 XLATE_DST 10.75.59.83:40760 Created=216sec ago NeedsCT=1\nTCP IN 172.16.1.173:4240 -> 10.75.59.83:44064 XLATE_DST 10.75.59.83:44064 Created=1066sec ago NeedsCT=1\n\n/home/cilium # cilium config\n##### Read-write configurations #####\nConntrackAccounting               : Disabled\nConntrackLocal                    : Disabled\nDebug                             : Disabled\nDebugLB                           : Disabled\nDropNotification                  : Enabled\nMonitorAggregationLevel           : Medium\nPolicyAccounting                  : Enabled\nPolicyAuditMode                   : Disabled\nPolicyTracing                     : Disabled\nPolicyVerdictNotification         : Enabled\nSourceIPVerification              : Enabled\nTraceNotification                 : Enabled\nMonitorNumPages                   : 64\nPolicyEnforcement                 : default\n/home/cilium # exit\nroot@k8s-node-1:~# \n```\n## 11.2 BGP相关信息\n```bash\nroot@k8s-node-1:~# cilium bgp peers\nNode         Local AS   Peer AS   Peer Address   Session State   Uptime   Family         Received   Advertised\nk8s-node-1   65000      65000     10.75.59.86    established     41m41s   ipv4/unicast   1          8    \nk8s-node-2   65000      65000     10.75.59.86    established     39m53s   ipv4/unicast   1          8    \nk8s-node-3   65000      65000     10.75.59.86    established     39m52s   ipv4/unicast   1          8    \nroot@k8s-node-1:~# cilium bgp routes\n(Defaulting to `available ipv4 unicast` routes, please see help for more options)\n\nNode         VRouter   Prefix             NextHop   Age      Attrs\nk8s-node-1   65000     172.16.0.0/24      0.0.0.0   41m48s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n             65000     172.16.32.1/32     0.0.0.0   41m48s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n             65000     172.16.32.10/32    0.0.0.0   41m48s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n             65000     172.16.34.108/32   0.0.0.0   34m39s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n             65000     172.16.38.134/32   0.0.0.0   41m48s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n             65000     172.16.42.14/32    0.0.0.0   41m48s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n             65000     172.16.42.186/32   0.0.0.0   41m47s   [{Origin: i} {Nexthop: 0.0.0.0}]   \nk8s-node-2   65000     172.16.1.0/24      0.0.0.0   39m59s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n             65000     172.16.32.1/32     0.0.0.0   39m59s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n             65000     172.16.32.10/32    0.0.0.0   39m59s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n             65000     172.16.34.108/32   0.0.0.0   34m39s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n             65000     172.16.38.134/32   0.0.0.0   39m59s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n             65000     172.16.42.14/32    0.0.0.0   39m59s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n             65000     172.16.42.186/32   0.0.0.0   39m56s   [{Origin: i} {Nexthop: 0.0.0.0}]   \nk8s-node-3   65000     172.16.2.0/24      0.0.0.0   39m58s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n             65000     172.16.32.1/32     0.0.0.0   39m58s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n             65000     172.16.32.10/32    0.0.0.0   39m58s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n             65000     172.16.34.108/32   0.0.0.0   34m39s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n             65000     172.16.38.134/32   0.0.0.0   39m58s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n             65000     172.16.42.14/32    0.0.0.0   39m58s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n             65000     172.16.42.186/32   0.0.0.0   39m55s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n\nroot@dns-bgp-server:~# ip route show\ndefault via 10.75.59.1 dev enp1s0 proto static \n10.75.59.0/24 dev enp1s0 proto kernel scope link src 10.75.59.86 \n172.16.0.0/24 nhid 8 via 10.75.59.81 dev enp1s0 proto bgp metric 20 \n172.16.1.0/24 nhid 12 via 10.75.59.82 dev enp1s0 proto bgp metric 20 \n172.16.2.0/24 nhid 19 via 10.75.59.83 dev enp1s0 proto bgp metric 20 \n172.16.32.1 nhid 18 proto bgp metric 20 \n        nexthop via 10.75.59.81 dev enp1s0 weight 1 \n        nexthop via 10.75.59.82 dev enp1s0 weight 1 \n        nexthop via 10.75.59.83 dev enp1s0 weight 1 \n172.16.32.10 nhid 18 proto bgp metric 20 \n        nexthop via 10.75.59.81 dev enp1s0 weight 1 \n        nexthop via 10.75.59.82 dev enp1s0 weight 1 \n        nexthop via 10.75.59.83 dev enp1s0 weight 1 \n172.16.34.108 nhid 18 proto bgp metric 20 \n        nexthop via 10.75.59.81 dev enp1s0 weight 1 \n        nexthop via 10.75.59.82 dev enp1s0 weight 1 \n        nexthop via 10.75.59.83 dev enp1s0 weight 1 \n172.16.38.134 nhid 18 proto bgp metric 20 \n        nexthop via 10.75.59.81 dev enp1s0 weight 1 \n        nexthop via 10.75.59.82 dev enp1s0 weight 1 \n        nexthop via 10.75.59.83 dev enp1s0 weight 1 \n172.16.42.14 nhid 18 proto bgp metric 20 \n        nexthop via 10.75.59.81 dev enp1s0 weight 1 \n        nexthop via 10.75.59.82 dev enp1s0 weight 1 \n        nexthop via 10.75.59.83 dev enp1s0 weight 1 \n172.16.42.186 nhid 18 proto bgp metric 20 \n        nexthop via 10.75.59.81 dev enp1s0 weight 1 \n        nexthop via 10.75.59.82 dev enp1s0 weight 1 \n        nexthop via 10.75.59.83 dev enp1s0 weight 1 \nroot@dns-bgp-server:~# route -n\nKernel IP routing table\nDestination     Gateway         Genmask         Flags Metric Ref    Use Iface\n0.0.0.0         10.75.59.1      0.0.0.0         UG    0      0        0 enp1s0\n10.75.59.0      0.0.0.0         255.255.255.0   U     0      0        0 enp1s0\n172.16.0.0      10.75.59.81     255.255.255.0   UG    20     0        0 enp1s0\n172.16.1.0      10.75.59.82     255.255.255.0   UG    20     0        0 enp1s0\n172.16.2.0      10.75.59.83     255.255.255.0   UG    20     0        0 enp1s0\n172.16.32.1     10.75.59.81     255.255.255.255 UGH   20     0        0 enp1s0\n172.16.32.10    10.75.59.81     255.255.255.255 UGH   20     0        0 enp1s0\n172.16.34.108   10.75.59.81     255.255.255.255 UGH   20     0        0 enp1s0\n172.16.38.134   10.75.59.81     255.255.255.255 UGH   20     0        0 enp1s0\n172.16.42.14    10.75.59.81     255.255.255.255 UGH   20     0        0 enp1s0\n172.16.42.186   10.75.59.81     255.255.255.255 UGH   20     0        0 enp1s0\nroot@dns-bgp-server:~# vtysh -c \"show ip bgp\"\nBGP table version is 15, local router ID is 10.75.59.86, vrf id 0\nDefault local pref 100, local AS 65000\nStatus codes:  s suppressed, d damped, h history, * valid, > best, = multipath,\n               i internal, r RIB-failure, S Stale, R Removed\nNexthop codes: @NNN nexthop's vrf id, < announce-nh-self\nOrigin codes:  i - IGP, e - EGP, ? - incomplete\nRPKI validation codes: V valid, I invalid, N Not found\n\n   Network          Next Hop            Metric LocPrf Weight Path\n*> 10.75.59.0/24    0.0.0.0                  0         32768 ?\n*>i172.16.0.0/24    10.75.59.81                   100      0 i\n*>i172.16.1.0/24    10.75.59.82                   100      0 i\n*>i172.16.2.0/24    10.75.59.83                   100      0 i\n*=i172.16.32.1/32   10.75.59.83                   100      0 i\n*=i                 10.75.59.82                   100      0 i\n*>i                 10.75.59.81                   100      0 i\n*=i172.16.32.10/32  10.75.59.83                   100      0 i\n*=i                 10.75.59.82                   100      0 i\n*>i                 10.75.59.81                   100      0 i\n*>i172.16.34.108/32 10.75.59.81                   100      0 i\n*=i                 10.75.59.82                   100      0 i\n*=i                 10.75.59.83                   100      0 i\n*=i172.16.38.134/32 10.75.59.83                   100      0 i\n*=i                 10.75.59.82                   100      0 i\n*>i                 10.75.59.81                   100      0 i\n*=i172.16.42.14/32  10.75.59.83                   100      0 i\n*=i                 10.75.59.82                   100      0 i\n*>i                 10.75.59.81                   100      0 i\n*=i172.16.42.186/32 10.75.59.83                   100      0 i\n*=i                 10.75.59.82                   100      0 i\n*>i                 10.75.59.81                   100      0 i\n\nDisplayed  10 routes and 22 total paths\nroot@dns-bgp-server:~# vtysh -c \"show ip bgp summary\"\n\nIPv4 Unicast Summary (VRF default):\nBGP router identifier 10.75.59.86, local AS number 65000 vrf-id 0\nBGP table version 15\nRIB entries 19, using 3648 bytes of memory\nPeers 3, using 2172 KiB of memory\n\nNeighbor        V         AS   MsgRcvd   MsgSent   TblVer  InQ OutQ  Up/Down State/PfxRcd   PfxSnt Desc\n10.75.59.81     4      65000       247       244        0    0    0 00:40:09            7        1 N/A\n10.75.59.82     4      65000       240       234        0    0    0 00:38:20            7        1 N/A\n10.75.59.83     4      65000       239       233        0    0    0 00:38:19            7        1 N/A\n\nTotal number of neighbors 3\n```\n\n# 12. 项目文档结构\n\n```bash\nois@ois:~/data/k8s-cilium-lab$ tree\n.\n├── ansible.cfg\n├── group_vars\n│   └── all.yml\n├── host_vars\n│   ├── dns-bgp-server.yml\n│   ├── k8s-node-1.yml\n│   ├── k8s-node-2.yml\n│   └── k8s-node-3.yml\n├── inventory.ini\n├── nodevm_cfg\n│   ├── dns-bgp-server_meta-data\n│   ├── dns-bgp-server_network-config\n│   ├── dns-bgp-server_user-data\n│   ├── k8s-node-1_meta-data\n│   ├── k8s-node-1_network-config\n│   ├── k8s-node-1_user-data\n│   ├── k8s-node-2_meta-data\n│   ├── k8s-node-2_network-config\n│   ├── k8s-node-2_user-data\n│   ├── k8s-node-3_meta-data\n│   ├── k8s-node-3_network-config\n│   └── k8s-node-3_user-data\n├── nodevms\n│   ├── dns-bgp-server.qcow2\n│   ├── k8s-node-1.qcow2\n│   ├── k8s-node-2.qcow2\n│   └── k8s-node-3.qcow2\n├── playbooks\n│   ├── 1_create_vms.yml\n│   ├── 2_prepare_nodes.yml\n│   ├── 3_setup_cluster.yml\n│   └── 4_deploy_app.yml\n├── roles\n│   ├── common\n│   │   └── tasks\n│   │       └── main.yml\n│   ├── infra_server\n│   │   └── tasks\n│   │       └── main.yml\n│   └── k8s_node\n│       └── tasks\n│           └── main.yml\n└── templates\n    ├── cilium-bgp.yaml.j2\n    ├── containerd.toml.j2\n    ├── deploy-star-wars.sh.j2\n    ├── frr.conf.j2\n    ├── hosts.j2\n    ├── meta-data.j2\n    ├── network-config.j2\n    └── user-data.j2\n\n14 directories, 38 files\n```","slug":"Ansible-K8S-Cilium","published":1,"updated":"2025-12-14T12:13:52.382Z","comments":1,"layout":"post","photos":[],"_id":"cuidHmCcYvXfSfU-2T5R5edMO","content":"<h1 id=\"Setup-K8S-with-Ansible-from-zero\"><a href=\"#Setup-K8S-with-Ansible-from-zero\" class=\"headerlink\" title=\"Setup K8S with Ansible from zero\"></a>Setup K8S with Ansible from zero</h1><h1 id=\"1-删除之前的环境\"><a href=\"#1-删除之前的环境\" class=\"headerlink\" title=\"1. 删除之前的环境\"></a>1. 删除之前的环境</h1><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ois@ois:~/data/k8s-cilium-lab$ <span class=\"built_in\">cd</span> ..</span><br><span class=\"line\">ois@ois:~/data$ ./07-undefine-vms.sh </span><br><span class=\"line\">Domain <span class=\"string\">&#x27;k8s-node-1&#x27;</span> destroyed</span><br><span class=\"line\"></span><br><span class=\"line\">Domain <span class=\"string\">&#x27;k8s-node-1&#x27;</span> has been undefined</span><br><span class=\"line\">Volume <span class=\"string\">&#x27;vda&#x27;</span>(/home/ois/data/k8s-cilium-lab/nodevms/k8s-node-1.qcow2) removed.</span><br><span class=\"line\"></span><br><span class=\"line\">Domain <span class=\"string\">&#x27;k8s-node-2&#x27;</span> destroyed</span><br><span class=\"line\"></span><br><span class=\"line\">Domain <span class=\"string\">&#x27;k8s-node-2&#x27;</span> has been undefined</span><br><span class=\"line\">Volume <span class=\"string\">&#x27;vda&#x27;</span>(/home/ois/data/k8s-cilium-lab/nodevms/k8s-node-2.qcow2) removed.</span><br><span class=\"line\"></span><br><span class=\"line\">Domain <span class=\"string\">&#x27;k8s-node-3&#x27;</span> destroyed</span><br><span class=\"line\"></span><br><span class=\"line\">Domain <span class=\"string\">&#x27;k8s-node-3&#x27;</span> has been undefined</span><br><span class=\"line\">Volume <span class=\"string\">&#x27;vda&#x27;</span>(/home/ois/data/k8s-cilium-lab/nodevms/k8s-node-3.qcow2) removed.</span><br><span class=\"line\"></span><br><span class=\"line\">Domain <span class=\"string\">&#x27;dns-bgp-server&#x27;</span> destroyed</span><br><span class=\"line\"></span><br><span class=\"line\">Domain <span class=\"string\">&#x27;dns-bgp-server&#x27;</span> has been undefined</span><br><span class=\"line\">Volume <span class=\"string\">&#x27;vda&#x27;</span>(/home/ois/data/k8s-cilium-lab/nodevms/dns-bgp-server.qcow2) removed.</span><br><span class=\"line\"></span><br><span class=\"line\">ois@ois:~/data$ <span class=\"built_in\">rm</span> -rf k8s-cilium-lab/</span><br><span class=\"line\">ois@ois:~/data$ </span><br></pre></td></tr></table></figure>\n\n<h1 id=\"2-重新构建项目文件结构\"><a href=\"#2-重新构建项目文件结构\" class=\"headerlink\" title=\"2. 重新构建项目文件结构\"></a>2. 重新构建项目文件结构</h1><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ois@ois:~/data$ ./00-create-project-structure.sh </span><br><span class=\"line\">--- K8s + Cilium Lab Setup (Warning-Free) ---</span><br><span class=\"line\">This script will prepare a new Ansible project directory named <span class=\"string\">&#x27;k8s-cilium-lab&#x27;</span>.</span><br><span class=\"line\"></span><br><span class=\"line\">--- Step 1: Checking Prerequisites ---</span><br><span class=\"line\">✅ OS is Debian-based.</span><br><span class=\"line\">✅ Ansible is already installed.</span><br><span class=\"line\">--&gt; Ensuring libvirt and whois are up-to-date...</span><br><span class=\"line\">✅ Dependencies are present.</span><br><span class=\"line\">✅ SSH key already exists at ~/.ssh/id_rsa. Skipping generation.</span><br><span class=\"line\"></span><br><span class=\"line\">--- Step 2: Creating Project Structure ---</span><br><span class=\"line\">✅ Project directory structure created <span class=\"keyword\">in</span> <span class=\"string\">&#x27;k8s-cilium-lab/&#x27;</span>.</span><br><span class=\"line\"></span><br><span class=\"line\">--- Step 3: Configuring User Password Hash ---</span><br><span class=\"line\">A secure password <span class=\"built_in\">hash</span> is required <span class=\"keyword\">for</span> the <span class=\"string\">&#x27;ubuntu&#x27;</span> user on the VMs.</span><br><span class=\"line\">Enter the password <span class=\"keyword\">for</span> the <span class=\"string\">&#x27;ubuntu&#x27;</span> user (input will be hidden): </span><br><span class=\"line\">--&gt; Generating password <span class=\"built_in\">hash</span>...</span><br><span class=\"line\">✅ Password <span class=\"built_in\">hash</span> generated.</span><br><span class=\"line\"></span><br><span class=\"line\">--- Step 4: Generating Configuration Files ---</span><br><span class=\"line\">✅ Created ansible.cfg</span><br><span class=\"line\">✅ Created inventory.ini</span><br><span class=\"line\">✅ Created group_vars/all.yml with password <span class=\"built_in\">hash</span>.</span><br><span class=\"line\">✅ Created host_vars/k8s-node-1.yml</span><br><span class=\"line\">✅ Created host_vars/k8s-node-2.yml</span><br><span class=\"line\">✅ Created host_vars/k8s-node-3.yml</span><br><span class=\"line\">✅ Created host_vars/dns-bgp-server.yml</span><br><span class=\"line\"></span><br><span class=\"line\">--- Setup Complete! ---</span><br><span class=\"line\">✅ Project <span class=\"string\">&#x27;k8s-cilium-lab&#x27;</span> has been successfully configured.</span><br><span class=\"line\"></span><br><span class=\"line\">Next Steps:</span><br><span class=\"line\">1. Run the next script to generate the VM creation playbook:</span><br><span class=\"line\">   ../01-create-vms.sh</span><br><span class=\"line\">2. Run the playbook to create your lab VMs (no vault password needed):</span><br><span class=\"line\">   ansible-playbook playbooks/1_create_vms.yml</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"3-生成Playbook，用于构建Lab环境虚拟机\"><a href=\"#3-生成Playbook，用于构建Lab环境虚拟机\" class=\"headerlink\" title=\"3. 生成Playbook，用于构建Lab环境虚拟机\"></a>3. 生成Playbook，用于构建Lab环境虚拟机</h1><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ois@ois:~/data$ ./01-create-vms.sh </span><br><span class=\"line\">--- Lab VM Playbook Generator (Final Corrected Version) ---</span><br><span class=\"line\"></span><br><span class=\"line\">--- Step 1: Verifying Project Context ---</span><br><span class=\"line\">✅ Working inside project directory: /home/ois/data/k8s-cilium-lab</span><br><span class=\"line\"></span><br><span class=\"line\">--- Step 2: Ensuring Directories Exist ---</span><br><span class=\"line\">✅ Directories <span class=\"string\">&#x27;playbooks/&#x27;</span> and <span class=\"string\">&#x27;templates/&#x27;</span> are ready.</span><br><span class=\"line\"></span><br><span class=\"line\">--- Step 3: Generating Files ---</span><br><span class=\"line\">✅ Generated playbook: playbooks/1_create_vms.yml</span><br><span class=\"line\">✅ Generated template: templates/user-data.j2</span><br><span class=\"line\">✅ Generated template: templates/network-config.j2</span><br><span class=\"line\">✅ Generated template: templates/meta-data.j2</span><br><span class=\"line\"></span><br><span class=\"line\">--- Generation Complete! ---</span><br><span class=\"line\">✅ All necessary files have been created inside the <span class=\"string\">&#x27;k8s-cilium-lab&#x27;</span> directory.</span><br><span class=\"line\"></span><br><span class=\"line\">Next Step:</span><br><span class=\"line\">1. Change into the project directory: <span class=\"built_in\">cd</span> k8s-cilium-lab</span><br><span class=\"line\">2. Run the playbook to create your lab VMs:</span><br><span class=\"line\">   ansible-playbook playbooks/1_create_vms.yml</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"4-运行Playbook，构建虚拟机环境\"><a href=\"#4-运行Playbook，构建虚拟机环境\" class=\"headerlink\" title=\"4. 运行Playbook，构建虚拟机环境\"></a>4. 运行Playbook，构建虚拟机环境</h1><p>自动创建k8s-nodes 和 运行FRR的虚拟机，并进行联通性探测，添加到已知主机列表(known_hosts)</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ois@ois:~/data$ <span class=\"built_in\">cd</span> k8s-cilium-lab/</span><br><span class=\"line\">ois@ois:~/data/k8s-cilium-lab$ </span><br><span class=\"line\">ois@ois:~/data/k8s-cilium-lab$ </span><br><span class=\"line\">ois@ois:~/data/k8s-cilium-lab$ ansible-playbook playbooks/1_create_vms.yml</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY [Play 1 - Pre-flight Check <span class=\"keyword\">for</span> Existing VMs] ******************************************************************************************************************************************************</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Check status of each VM with virsh] **************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [dns-bgp-server]</span><br><span class=\"line\">ok: [k8s-node-2]</span><br><span class=\"line\">ok: [k8s-node-1]</span><br><span class=\"line\">ok: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY [Play 2 - Decide <span class=\"keyword\">if</span> Provisioning is Needed] *******************************************************************************************************************************************************</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Initialize an empty list <span class=\"keyword\">for</span> missing VMs] ********************************************************************************************************************************************************</span><br><span class=\"line\">ok: [localhost]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Populate the list of missing VMs] ****************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [localhost] =&gt; (item=dns-bgp-server)</span><br><span class=\"line\">ok: [localhost] =&gt; (item=k8s-node-1)</span><br><span class=\"line\">ok: [localhost] =&gt; (item=k8s-node-2)</span><br><span class=\"line\">ok: [localhost] =&gt; (item=k8s-node-3)</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Set global flag <span class=\"keyword\">if</span> provisioning is required] *****************************************************************************************************************************************************</span><br><span class=\"line\">ok: [localhost]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Report status] ***********************************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [localhost] =&gt; &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;msg&quot;</span>: <span class=\"string\">&quot;Provisioning needed: True. Missing VMs: [&#x27;dns-bgp-server&#x27;, &#x27;k8s-node-1&#x27;, &#x27;k8s-node-2&#x27;, &#x27;k8s-node-3&#x27;]&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY [Play 3 - Prepare VM Assets <span class=\"keyword\">in</span> Parallel] **********************************************************************************************************************************************************</span><br><span class=\"line\">[WARNING]: Using run_once with the free strategy is not currently supported. This task will still be executed <span class=\"keyword\">for</span> every host <span class=\"keyword\">in</span> the inventory list.</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Ensure VM directories exist] *********************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [dns-bgp-server] =&gt; (item=/home/ois/data/k8s-cilium-lab/nodevms)</span><br><span class=\"line\">ok: [k8s-node-2] =&gt; (item=/home/ois/data/k8s-cilium-lab/nodevms)</span><br><span class=\"line\">ok: [k8s-node-3] =&gt; (item=/home/ois/data/k8s-cilium-lab/nodevms)</span><br><span class=\"line\">ok: [k8s-node-1] =&gt; (item=/home/ois/data/k8s-cilium-lab/nodevms)</span><br><span class=\"line\">changed: [dns-bgp-server] =&gt; (item=/home/ois/data/k8s-cilium-lab/nodevm_cfg)</span><br><span class=\"line\">ok: [k8s-node-2] =&gt; (item=/home/ois/data/k8s-cilium-lab/nodevm_cfg)</span><br><span class=\"line\">ok: [k8s-node-3] =&gt; (item=/home/ois/data/k8s-cilium-lab/nodevm_cfg)</span><br><span class=\"line\">ok: [k8s-node-1] =&gt; (item=/home/ois/data/k8s-cilium-lab/nodevm_cfg)</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Check <span class=\"keyword\">if</span> VM disk image already exists] ***********************************************************************************************************************************************************</span><br><span class=\"line\">ok: [k8s-node-2]</span><br><span class=\"line\">ok: [dns-bgp-server]</span><br><span class=\"line\">ok: [k8s-node-1]</span><br><span class=\"line\">ok: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Create VM disk image from base image] ************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [dns-bgp-server]</span><br><span class=\"line\">changed: [k8s-node-2]</span><br><span class=\"line\">changed: [k8s-node-1]</span><br><span class=\"line\">changed: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Resize VM disk image] ****************************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [dns-bgp-server]</span><br><span class=\"line\">changed: [k8s-node-2]</span><br><span class=\"line\">changed: [k8s-node-3]</span><br><span class=\"line\">changed: [k8s-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Generate cloud-init files] ***********************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [k8s-node-2] =&gt; (item=&#123;<span class=\"string\">&#x27;src&#x27;</span>: <span class=\"string\">&#x27;../templates/user-data.j2&#x27;</span>, <span class=\"string\">&#x27;dest&#x27;</span>: <span class=\"string\">&#x27;/home/ois/data/k8s-cilium-lab/nodevm_cfg/k8s-node-2_user-data&#x27;</span>&#125;)</span><br><span class=\"line\">changed: [k8s-node-3] =&gt; (item=&#123;<span class=\"string\">&#x27;src&#x27;</span>: <span class=\"string\">&#x27;../templates/user-data.j2&#x27;</span>, <span class=\"string\">&#x27;dest&#x27;</span>: <span class=\"string\">&#x27;/home/ois/data/k8s-cilium-lab/nodevm_cfg/k8s-node-3_user-data&#x27;</span>&#125;)</span><br><span class=\"line\">changed: [dns-bgp-server] =&gt; (item=&#123;<span class=\"string\">&#x27;src&#x27;</span>: <span class=\"string\">&#x27;../templates/user-data.j2&#x27;</span>, <span class=\"string\">&#x27;dest&#x27;</span>: <span class=\"string\">&#x27;/home/ois/data/k8s-cilium-lab/nodevm_cfg/dns-bgp-server_user-data&#x27;</span>&#125;)</span><br><span class=\"line\">changed: [k8s-node-1] =&gt; (item=&#123;<span class=\"string\">&#x27;src&#x27;</span>: <span class=\"string\">&#x27;../templates/user-data.j2&#x27;</span>, <span class=\"string\">&#x27;dest&#x27;</span>: <span class=\"string\">&#x27;/home/ois/data/k8s-cilium-lab/nodevm_cfg/k8s-node-1_user-data&#x27;</span>&#125;)</span><br><span class=\"line\">changed: [k8s-node-3] =&gt; (item=&#123;<span class=\"string\">&#x27;src&#x27;</span>: <span class=\"string\">&#x27;../templates/network-config.j2&#x27;</span>, <span class=\"string\">&#x27;dest&#x27;</span>: <span class=\"string\">&#x27;/home/ois/data/k8s-cilium-lab/nodevm_cfg/k8s-node-3_network-config&#x27;</span>&#125;)</span><br><span class=\"line\">changed: [k8s-node-2] =&gt; (item=&#123;<span class=\"string\">&#x27;src&#x27;</span>: <span class=\"string\">&#x27;../templates/network-config.j2&#x27;</span>, <span class=\"string\">&#x27;dest&#x27;</span>: <span class=\"string\">&#x27;/home/ois/data/k8s-cilium-lab/nodevm_cfg/k8s-node-2_network-config&#x27;</span>&#125;)</span><br><span class=\"line\">changed: [k8s-node-1] =&gt; (item=&#123;<span class=\"string\">&#x27;src&#x27;</span>: <span class=\"string\">&#x27;../templates/network-config.j2&#x27;</span>, <span class=\"string\">&#x27;dest&#x27;</span>: <span class=\"string\">&#x27;/home/ois/data/k8s-cilium-lab/nodevm_cfg/k8s-node-1_network-config&#x27;</span>&#125;)</span><br><span class=\"line\">changed: [dns-bgp-server] =&gt; (item=&#123;<span class=\"string\">&#x27;src&#x27;</span>: <span class=\"string\">&#x27;../templates/network-config.j2&#x27;</span>, <span class=\"string\">&#x27;dest&#x27;</span>: <span class=\"string\">&#x27;/home/ois/data/k8s-cilium-lab/nodevm_cfg/dns-bgp-server_network-config&#x27;</span>&#125;)</span><br><span class=\"line\">changed: [k8s-node-3] =&gt; (item=&#123;<span class=\"string\">&#x27;src&#x27;</span>: <span class=\"string\">&#x27;../templates/meta-data.j2&#x27;</span>, <span class=\"string\">&#x27;dest&#x27;</span>: <span class=\"string\">&#x27;/home/ois/data/k8s-cilium-lab/nodevm_cfg/k8s-node-3_meta-data&#x27;</span>&#125;)</span><br><span class=\"line\">changed: [k8s-node-2] =&gt; (item=&#123;<span class=\"string\">&#x27;src&#x27;</span>: <span class=\"string\">&#x27;../templates/meta-data.j2&#x27;</span>, <span class=\"string\">&#x27;dest&#x27;</span>: <span class=\"string\">&#x27;/home/ois/data/k8s-cilium-lab/nodevm_cfg/k8s-node-2_meta-data&#x27;</span>&#125;)</span><br><span class=\"line\">changed: [k8s-node-1] =&gt; (item=&#123;<span class=\"string\">&#x27;src&#x27;</span>: <span class=\"string\">&#x27;../templates/meta-data.j2&#x27;</span>, <span class=\"string\">&#x27;dest&#x27;</span>: <span class=\"string\">&#x27;/home/ois/data/k8s-cilium-lab/nodevm_cfg/k8s-node-1_meta-data&#x27;</span>&#125;)</span><br><span class=\"line\">changed: [dns-bgp-server] =&gt; (item=&#123;<span class=\"string\">&#x27;src&#x27;</span>: <span class=\"string\">&#x27;../templates/meta-data.j2&#x27;</span>, <span class=\"string\">&#x27;dest&#x27;</span>: <span class=\"string\">&#x27;/home/ois/data/k8s-cilium-lab/nodevm_cfg/dns-bgp-server_meta-data&#x27;</span>&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY [Play 4 - Install VMs Sequentially to Avoid Race Condition] ***************************************************************************************************************************************</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Create and start the VM with virt-install] *******************************************************************************************************************************************************</span><br><span class=\"line\">changed: [dns-bgp-server]</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY [Play 4 - Install VMs Sequentially to Avoid Race Condition] ***************************************************************************************************************************************</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Create and start the VM with virt-install] *******************************************************************************************************************************************************</span><br><span class=\"line\">changed: [k8s-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY [Play 4 - Install VMs Sequentially to Avoid Race Condition] ***************************************************************************************************************************************</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Create and start the VM with virt-install] *******************************************************************************************************************************************************</span><br><span class=\"line\">changed: [k8s-node-2]</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY [Play 4 - Install VMs Sequentially to Avoid Race Condition] ***************************************************************************************************************************************</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Create and start the VM with virt-install] *******************************************************************************************************************************************************</span><br><span class=\"line\">changed: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY [Play 5 - Verify VM Connectivity <span class=\"keyword\">in</span> Parallel] *****************************************************************************************************************************************************</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Wait <span class=\"keyword\">for</span> VMs to boot and SSH to become available] ************************************************************************************************************************************************</span><br><span class=\"line\">ok: [dns-bgp-server -&gt; localhost]</span><br><span class=\"line\">ok: [k8s-node-1 -&gt; localhost]</span><br><span class=\"line\"><span class=\"comment\"># 10.75.59.86:22 SSH-2.0-OpenSSH_9.6p1 Ubuntu-3ubuntu13.12</span></span><br><span class=\"line\"><span class=\"comment\"># 10.75.59.81:22 SSH-2.0-OpenSSH_9.6p1 Ubuntu-3ubuntu13.12</span></span><br><span class=\"line\"><span class=\"comment\"># 10.75.59.81:22 SSH-2.0-OpenSSH_9.6p1 Ubuntu-3ubuntu13.12</span></span><br><span class=\"line\"><span class=\"comment\"># 10.75.59.86:22 SSH-2.0-OpenSSH_9.6p1 Ubuntu-3ubuntu13.12</span></span><br><span class=\"line\"><span class=\"comment\"># 10.75.59.81:22 SSH-2.0-OpenSSH_9.6p1 Ubuntu-3ubuntu13.12</span></span><br><span class=\"line\"><span class=\"comment\"># 10.75.59.81:22 SSH-2.0-OpenSSH_9.6p1 Ubuntu-3ubuntu13.12</span></span><br><span class=\"line\"><span class=\"comment\"># 10.75.59.86:22 SSH-2.0-OpenSSH_9.6p1 Ubuntu-3ubuntu13.12</span></span><br><span class=\"line\"><span class=\"comment\"># 10.75.59.81:22 SSH-2.0-OpenSSH_9.6p1 Ubuntu-3ubuntu13.12</span></span><br><span class=\"line\"><span class=\"comment\"># 10.75.59.86:22 SSH-2.0-OpenSSH_9.6p1 Ubuntu-3ubuntu13.12</span></span><br><span class=\"line\"><span class=\"comment\"># 10.75.59.86:22 SSH-2.0-OpenSSH_9.6p1 Ubuntu-3ubuntu13.12</span></span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Add host keys to known_hosts file] ***************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [k8s-node-1 -&gt; localhost]</span><br><span class=\"line\">changed: [dns-bgp-server -&gt; localhost]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Wait <span class=\"keyword\">for</span> VMs to boot and SSH to become available] ************************************************************************************************************************************************</span><br><span class=\"line\">ok: [k8s-node-3 -&gt; localhost]</span><br><span class=\"line\"><span class=\"comment\"># 10.75.59.83:22 SSH-2.0-OpenSSH_9.6p1 Ubuntu-3ubuntu13.12</span></span><br><span class=\"line\"><span class=\"comment\"># 10.75.59.83:22 SSH-2.0-OpenSSH_9.6p1 Ubuntu-3ubuntu13.12</span></span><br><span class=\"line\"><span class=\"comment\"># 10.75.59.83:22 SSH-2.0-OpenSSH_9.6p1 Ubuntu-3ubuntu13.12</span></span><br><span class=\"line\"><span class=\"comment\"># 10.75.59.83:22 SSH-2.0-OpenSSH_9.6p1 Ubuntu-3ubuntu13.12</span></span><br><span class=\"line\"><span class=\"comment\"># 10.75.59.83:22 SSH-2.0-OpenSSH_9.6p1 Ubuntu-3ubuntu13.12</span></span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Add host keys to known_hosts file] ***************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [k8s-node-3 -&gt; localhost]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Wait <span class=\"keyword\">for</span> VMs to boot and SSH to become available] ************************************************************************************************************************************************</span><br><span class=\"line\">ok: [k8s-node-2 -&gt; localhost]</span><br><span class=\"line\"><span class=\"comment\"># 10.75.59.82:22 SSH-2.0-OpenSSH_9.6p1 Ubuntu-3ubuntu13.12</span></span><br><span class=\"line\"><span class=\"comment\"># 10.75.59.82:22 SSH-2.0-OpenSSH_9.6p1 Ubuntu-3ubuntu13.12</span></span><br><span class=\"line\"><span class=\"comment\"># 10.75.59.82:22 SSH-2.0-OpenSSH_9.6p1 Ubuntu-3ubuntu13.12</span></span><br><span class=\"line\"><span class=\"comment\"># 10.75.59.82:22 SSH-2.0-OpenSSH_9.6p1 Ubuntu-3ubuntu13.12</span></span><br><span class=\"line\"><span class=\"comment\"># 10.75.59.82:22 SSH-2.0-OpenSSH_9.6p1 Ubuntu-3ubuntu13.12</span></span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Add host keys to known_hosts file] ***************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [k8s-node-2 -&gt; localhost]</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY RECAP *********************************************************************************************************************************************************************************************</span><br><span class=\"line\">dns-bgp-server             : ok=9    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class=\"line\">k8s-node-1                 : ok=9    changed=5    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class=\"line\">k8s-node-2                 : ok=9    changed=5    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class=\"line\">k8s-node-3                 : ok=9    changed=5    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class=\"line\">localhost                  : ok=4    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br></pre></td></tr></table></figure>\n\n<p>多次运行，以测试幂等性，多次运行不影响结果，已执行过的任务会自行跳过。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ois@ois:~/data/k8s-cilium-lab$ ansible-playbook playbooks/1_create_vms.yml</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY [Play 1 - Pre-flight Check <span class=\"keyword\">for</span> Existing VMs] ******************************************************************************************************************************************************</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Check status of each VM with virsh] **************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [k8s-node-3]</span><br><span class=\"line\">ok: [k8s-node-1]</span><br><span class=\"line\">ok: [dns-bgp-server]</span><br><span class=\"line\">ok: [k8s-node-2]</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY [Play 2 - Decide <span class=\"keyword\">if</span> Provisioning is Needed] *******************************************************************************************************************************************************</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Initialize an empty list <span class=\"keyword\">for</span> missing VMs] ********************************************************************************************************************************************************</span><br><span class=\"line\">ok: [localhost]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Populate the list of missing VMs] ****************************************************************************************************************************************************************</span><br><span class=\"line\">skipping: [localhost] =&gt; (item=dns-bgp-server) </span><br><span class=\"line\">skipping: [localhost] =&gt; (item=k8s-node-1) </span><br><span class=\"line\">skipping: [localhost] =&gt; (item=k8s-node-2) </span><br><span class=\"line\">skipping: [localhost] =&gt; (item=k8s-node-3) </span><br><span class=\"line\">skipping: [localhost]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Set global flag <span class=\"keyword\">if</span> provisioning is required] *****************************************************************************************************************************************************</span><br><span class=\"line\">ok: [localhost]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Report status] ***********************************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [localhost] =&gt; &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;msg&quot;</span>: <span class=\"string\">&quot;Provisioning needed: False. Missing VMs: []&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY [Play 3 - Prepare VM Assets <span class=\"keyword\">in</span> Parallel] **********************************************************************************************************************************************************</span><br><span class=\"line\">[WARNING]: Using run_once with the free strategy is not currently supported. This task will still be executed <span class=\"keyword\">for</span> every host <span class=\"keyword\">in</span> the inventory list.</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Ensure VM directories exist] *********************************************************************************************************************************************************************</span><br><span class=\"line\">skipping: [dns-bgp-server] =&gt; (item=/home/ois/data/k8s-cilium-lab/nodevms) </span><br><span class=\"line\">skipping: [dns-bgp-server] =&gt; (item=/home/ois/data/k8s-cilium-lab/nodevm_cfg) </span><br><span class=\"line\">skipping: [k8s-node-1] =&gt; (item=/home/ois/data/k8s-cilium-lab/nodevms) </span><br><span class=\"line\">skipping: [dns-bgp-server]</span><br><span class=\"line\">skipping: [k8s-node-1] =&gt; (item=/home/ois/data/k8s-cilium-lab/nodevm_cfg) </span><br><span class=\"line\">skipping: [k8s-node-2] =&gt; (item=/home/ois/data/k8s-cilium-lab/nodevms) </span><br><span class=\"line\">skipping: [k8s-node-2] =&gt; (item=/home/ois/data/k8s-cilium-lab/nodevm_cfg) </span><br><span class=\"line\">skipping: [k8s-node-3] =&gt; (item=/home/ois/data/k8s-cilium-lab/nodevms) </span><br><span class=\"line\">skipping: [k8s-node-3] =&gt; (item=/home/ois/data/k8s-cilium-lab/nodevm_cfg) </span><br><span class=\"line\">skipping: [k8s-node-1]</span><br><span class=\"line\">skipping: [k8s-node-2]</span><br><span class=\"line\">skipping: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Check <span class=\"keyword\">if</span> VM disk image already exists] ***********************************************************************************************************************************************************</span><br><span class=\"line\">skipping: [dns-bgp-server]</span><br><span class=\"line\">skipping: [k8s-node-1]</span><br><span class=\"line\">skipping: [k8s-node-2]</span><br><span class=\"line\">skipping: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Create VM disk image from base image] ************************************************************************************************************************************************************</span><br><span class=\"line\">skipping: [dns-bgp-server]</span><br><span class=\"line\">skipping: [k8s-node-1]</span><br><span class=\"line\">skipping: [k8s-node-2]</span><br><span class=\"line\">skipping: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Resize VM disk image] ****************************************************************************************************************************************************************************</span><br><span class=\"line\">skipping: [dns-bgp-server]</span><br><span class=\"line\">skipping: [k8s-node-1]</span><br><span class=\"line\">skipping: [k8s-node-2]</span><br><span class=\"line\">skipping: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Generate cloud-init files] ***********************************************************************************************************************************************************************</span><br><span class=\"line\">skipping: [k8s-node-1] =&gt; (item=&#123;<span class=\"string\">&#x27;src&#x27;</span>: <span class=\"string\">&#x27;../templates/user-data.j2&#x27;</span>, <span class=\"string\">&#x27;dest&#x27;</span>: <span class=\"string\">&#x27;/home/ois/data/k8s-cilium-lab/nodevm_cfg/k8s-node-1_user-data&#x27;</span>&#125;) </span><br><span class=\"line\">skipping: [k8s-node-1] =&gt; (item=&#123;<span class=\"string\">&#x27;src&#x27;</span>: <span class=\"string\">&#x27;../templates/network-config.j2&#x27;</span>, <span class=\"string\">&#x27;dest&#x27;</span>: <span class=\"string\">&#x27;/home/ois/data/k8s-cilium-lab/nodevm_cfg/k8s-node-1_network-config&#x27;</span>&#125;) </span><br><span class=\"line\">skipping: [k8s-node-2] =&gt; (item=&#123;<span class=\"string\">&#x27;src&#x27;</span>: <span class=\"string\">&#x27;../templates/user-data.j2&#x27;</span>, <span class=\"string\">&#x27;dest&#x27;</span>: <span class=\"string\">&#x27;/home/ois/data/k8s-cilium-lab/nodevm_cfg/k8s-node-2_user-data&#x27;</span>&#125;) </span><br><span class=\"line\">skipping: [k8s-node-1] =&gt; (item=&#123;<span class=\"string\">&#x27;src&#x27;</span>: <span class=\"string\">&#x27;../templates/meta-data.j2&#x27;</span>, <span class=\"string\">&#x27;dest&#x27;</span>: <span class=\"string\">&#x27;/home/ois/data/k8s-cilium-lab/nodevm_cfg/k8s-node-1_meta-data&#x27;</span>&#125;) </span><br><span class=\"line\">skipping: [k8s-node-1]</span><br><span class=\"line\">skipping: [k8s-node-2] =&gt; (item=&#123;<span class=\"string\">&#x27;src&#x27;</span>: <span class=\"string\">&#x27;../templates/network-config.j2&#x27;</span>, <span class=\"string\">&#x27;dest&#x27;</span>: <span class=\"string\">&#x27;/home/ois/data/k8s-cilium-lab/nodevm_cfg/k8s-node-2_network-config&#x27;</span>&#125;) </span><br><span class=\"line\">skipping: [dns-bgp-server] =&gt; (item=&#123;<span class=\"string\">&#x27;src&#x27;</span>: <span class=\"string\">&#x27;../templates/user-data.j2&#x27;</span>, <span class=\"string\">&#x27;dest&#x27;</span>: <span class=\"string\">&#x27;/home/ois/data/k8s-cilium-lab/nodevm_cfg/dns-bgp-server_user-data&#x27;</span>&#125;) </span><br><span class=\"line\">skipping: [k8s-node-2] =&gt; (item=&#123;<span class=\"string\">&#x27;src&#x27;</span>: <span class=\"string\">&#x27;../templates/meta-data.j2&#x27;</span>, <span class=\"string\">&#x27;dest&#x27;</span>: <span class=\"string\">&#x27;/home/ois/data/k8s-cilium-lab/nodevm_cfg/k8s-node-2_meta-data&#x27;</span>&#125;) </span><br><span class=\"line\">skipping: [k8s-node-2]</span><br><span class=\"line\">skipping: [dns-bgp-server] =&gt; (item=&#123;<span class=\"string\">&#x27;src&#x27;</span>: <span class=\"string\">&#x27;../templates/network-config.j2&#x27;</span>, <span class=\"string\">&#x27;dest&#x27;</span>: <span class=\"string\">&#x27;/home/ois/data/k8s-cilium-lab/nodevm_cfg/dns-bgp-server_network-config&#x27;</span>&#125;) </span><br><span class=\"line\">skipping: [dns-bgp-server] =&gt; (item=&#123;<span class=\"string\">&#x27;src&#x27;</span>: <span class=\"string\">&#x27;../templates/meta-data.j2&#x27;</span>, <span class=\"string\">&#x27;dest&#x27;</span>: <span class=\"string\">&#x27;/home/ois/data/k8s-cilium-lab/nodevm_cfg/dns-bgp-server_meta-data&#x27;</span>&#125;) </span><br><span class=\"line\">skipping: [k8s-node-3] =&gt; (item=&#123;<span class=\"string\">&#x27;src&#x27;</span>: <span class=\"string\">&#x27;../templates/user-data.j2&#x27;</span>, <span class=\"string\">&#x27;dest&#x27;</span>: <span class=\"string\">&#x27;/home/ois/data/k8s-cilium-lab/nodevm_cfg/k8s-node-3_user-data&#x27;</span>&#125;) </span><br><span class=\"line\">skipping: [dns-bgp-server]</span><br><span class=\"line\">skipping: [k8s-node-3] =&gt; (item=&#123;<span class=\"string\">&#x27;src&#x27;</span>: <span class=\"string\">&#x27;../templates/network-config.j2&#x27;</span>, <span class=\"string\">&#x27;dest&#x27;</span>: <span class=\"string\">&#x27;/home/ois/data/k8s-cilium-lab/nodevm_cfg/k8s-node-3_network-config&#x27;</span>&#125;) </span><br><span class=\"line\">skipping: [k8s-node-3] =&gt; (item=&#123;<span class=\"string\">&#x27;src&#x27;</span>: <span class=\"string\">&#x27;../templates/meta-data.j2&#x27;</span>, <span class=\"string\">&#x27;dest&#x27;</span>: <span class=\"string\">&#x27;/home/ois/data/k8s-cilium-lab/nodevm_cfg/k8s-node-3_meta-data&#x27;</span>&#125;) </span><br><span class=\"line\">skipping: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY [Play 4 - Install VMs Sequentially to Avoid Race Condition] ***************************************************************************************************************************************</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Create and start the VM with virt-install] *******************************************************************************************************************************************************</span><br><span class=\"line\">skipping: [dns-bgp-server]</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY [Play 4 - Install VMs Sequentially to Avoid Race Condition] ***************************************************************************************************************************************</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Create and start the VM with virt-install] *******************************************************************************************************************************************************</span><br><span class=\"line\">skipping: [k8s-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY [Play 4 - Install VMs Sequentially to Avoid Race Condition] ***************************************************************************************************************************************</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Create and start the VM with virt-install] *******************************************************************************************************************************************************</span><br><span class=\"line\">skipping: [k8s-node-2]</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY [Play 4 - Install VMs Sequentially to Avoid Race Condition] ***************************************************************************************************************************************</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Create and start the VM with virt-install] *******************************************************************************************************************************************************</span><br><span class=\"line\">skipping: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY [Play 5 - Verify VM Connectivity <span class=\"keyword\">in</span> Parallel] *****************************************************************************************************************************************************</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Wait <span class=\"keyword\">for</span> VMs to boot and SSH to become available] ************************************************************************************************************************************************</span><br><span class=\"line\">skipping: [dns-bgp-server]</span><br><span class=\"line\">skipping: [k8s-node-1]</span><br><span class=\"line\">skipping: [k8s-node-2]</span><br><span class=\"line\">skipping: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Add host keys to known_hosts file] ***************************************************************************************************************************************************************</span><br><span class=\"line\">skipping: [dns-bgp-server]</span><br><span class=\"line\">skipping: [k8s-node-1]</span><br><span class=\"line\">skipping: [k8s-node-2]</span><br><span class=\"line\">skipping: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY RECAP *********************************************************************************************************************************************************************************************</span><br><span class=\"line\">dns-bgp-server             : ok=1    changed=0    unreachable=0    failed=0    skipped=8    rescued=0    ignored=0   </span><br><span class=\"line\">k8s-node-1                 : ok=1    changed=0    unreachable=0    failed=0    skipped=8    rescued=0    ignored=0   </span><br><span class=\"line\">k8s-node-2                 : ok=1    changed=0    unreachable=0    failed=0    skipped=8    rescued=0    ignored=0   </span><br><span class=\"line\">k8s-node-3                 : ok=1    changed=0    unreachable=0    failed=0    skipped=8    rescued=0    ignored=0   </span><br><span class=\"line\">localhost                  : ok=3    changed=0    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   </span><br></pre></td></tr></table></figure>\n\n<h1 id=\"5-生成Playbook以便安装Containerd和K8S工具\"><a href=\"#5-生成Playbook以便安装Containerd和K8S工具\" class=\"headerlink\" title=\"5. 生成Playbook以便安装Containerd和K8S工具\"></a>5. 生成Playbook以便安装Containerd和K8S工具</h1><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ois@ois:~/data/k8s-cilium-lab$ <span class=\"built_in\">cd</span> ..</span><br><span class=\"line\">ois@ois:~/data$ ./02-prepare-nodes.sh </span><br><span class=\"line\">--- Node Preparation Playbook Generator (with cloud-init <span class=\"built_in\">wait</span>) ---</span><br><span class=\"line\"></span><br><span class=\"line\">--- Step 1: Verifying Project Context ---</span><br><span class=\"line\">✅ Working inside project directory: /home/ois/data/k8s-cilium-lab</span><br><span class=\"line\"></span><br><span class=\"line\">--- Step 2: Ensuring Role Directories Exist ---</span><br><span class=\"line\">✅ Role directories created.</span><br><span class=\"line\"></span><br><span class=\"line\">--- Step 3: Generating Role Task Files ---</span><br><span class=\"line\">✅ Created tasks <span class=\"keyword\">for</span> <span class=\"string\">&#x27;common&#x27;</span> role.</span><br><span class=\"line\">✅ Created tasks <span class=\"keyword\">for</span> <span class=\"string\">&#x27;k8s_node&#x27;</span> role.</span><br><span class=\"line\">✅ Created tasks <span class=\"keyword\">for</span> <span class=\"string\">&#x27;infra_server&#x27;</span> role.</span><br><span class=\"line\"></span><br><span class=\"line\">--- Step 4: Generating Config Templates ---</span><br><span class=\"line\">✅ Created /etc/hosts template.</span><br><span class=\"line\">✅ Created containerd config template.</span><br><span class=\"line\">✅ Created FRR config template.</span><br><span class=\"line\"></span><br><span class=\"line\">--- Step 5: Generating Main Playbook ---</span><br><span class=\"line\">✅ Created main playbook: playbooks/2_prepare_nodes.yml</span><br><span class=\"line\"></span><br><span class=\"line\">--- Generation Complete! ---</span><br><span class=\"line\">✅ All necessary files <span class=\"keyword\">for</span> node preparation have been created.</span><br><span class=\"line\"></span><br><span class=\"line\">Next Step:</span><br><span class=\"line\">1. Change into the project directory: <span class=\"built_in\">cd</span> k8s-cilium-lab</span><br><span class=\"line\">2. Run the playbook to prepare your nodes. You will be prompted <span class=\"keyword\">for</span> the <span class=\"built_in\">sudo</span> password:</span><br><span class=\"line\">   ansible-playbook playbooks/2_prepare_nodes.yml --ask-become-pass</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"6-执行Playbook，安装Containerd和K8S工具\"><a href=\"#6-执行Playbook，安装Containerd和K8S工具\" class=\"headerlink\" title=\"6. 执行Playbook，安装Containerd和K8S工具\"></a>6. 执行Playbook，安装Containerd和K8S工具</h1><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ois@ois:~/data$ <span class=\"built_in\">cd</span> k8s-cilium-lab/</span><br><span class=\"line\">ois@ois:~/data/k8s-cilium-lab$ ansible-playbook playbooks/2_prepare_nodes.yml --ask-become-pass</span><br><span class=\"line\">BECOME password: </span><br><span class=\"line\"></span><br><span class=\"line\">PLAY [Play 1 - Prepare All Nodes] **********************************************************************************************************************************************************************</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Gathering Facts] *********************************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [dns-bgp-server]</span><br><span class=\"line\">ok: [k8s-node-3]</span><br><span class=\"line\">ok: [k8s-node-2]</span><br><span class=\"line\">ok: [k8s-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common : Wait <span class=\"keyword\">for</span> cloud-init to complete] ********************************************************************************************************************************************************</span><br><span class=\"line\">ok: [dns-bgp-server]</span><br><span class=\"line\">ok: [k8s-node-2]</span><br><span class=\"line\">ok: [k8s-node-3]</span><br><span class=\"line\">ok: [k8s-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common : Update apt cache and upgrade all packages] **********************************************************************************************************************************************</span><br><span class=\"line\">changed: [dns-bgp-server]</span><br><span class=\"line\">changed: [k8s-node-3]</span><br><span class=\"line\">changed: [k8s-node-1]</span><br><span class=\"line\">changed: [k8s-node-2]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common : Configure /etc/hosts from template] *****************************************************************************************************************************************************</span><br><span class=\"line\">changed: [k8s-node-2]</span><br><span class=\"line\">changed: [dns-bgp-server]</span><br><span class=\"line\">changed: [k8s-node-3]</span><br><span class=\"line\">changed: [k8s-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common : Turn off all swap devices] **************************************************************************************************************************************************************</span><br><span class=\"line\">skipping: [dns-bgp-server]</span><br><span class=\"line\">skipping: [k8s-node-1]</span><br><span class=\"line\">skipping: [k8s-node-2]</span><br><span class=\"line\">skipping: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common : Comment out swap entries <span class=\"keyword\">in</span> /etc/fstab] *************************************************************************************************************************************************</span><br><span class=\"line\">skipping: [dns-bgp-server]</span><br><span class=\"line\">skipping: [k8s-node-1]</span><br><span class=\"line\">skipping: [k8s-node-2]</span><br><span class=\"line\">skipping: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common : Load required kernel modules] ***********************************************************************************************************************************************************</span><br><span class=\"line\">changed: [dns-bgp-server] =&gt; (item=overlay)</span><br><span class=\"line\">changed: [k8s-node-1] =&gt; (item=overlay)</span><br><span class=\"line\">changed: [k8s-node-2] =&gt; (item=overlay)</span><br><span class=\"line\">changed: [k8s-node-3] =&gt; (item=overlay)</span><br><span class=\"line\">changed: [k8s-node-2] =&gt; (item=br_netfilter)</span><br><span class=\"line\">changed: [dns-bgp-server] =&gt; (item=br_netfilter)</span><br><span class=\"line\">changed: [k8s-node-1] =&gt; (item=br_netfilter)</span><br><span class=\"line\">changed: [k8s-node-3] =&gt; (item=br_netfilter)</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common : Ensure kernel modules are loaded on boot] ***********************************************************************************************************************************************</span><br><span class=\"line\">changed: [dns-bgp-server]</span><br><span class=\"line\">changed: [k8s-node-1]</span><br><span class=\"line\">changed: [k8s-node-3]</span><br><span class=\"line\">changed: [k8s-node-2]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common : Configure sysctl parameters <span class=\"keyword\">for</span> Kubernetes networking] **********************************************************************************************************************************</span><br><span class=\"line\">changed: [dns-bgp-server]</span><br><span class=\"line\">changed: [k8s-node-1]</span><br><span class=\"line\">changed: [k8s-node-3]</span><br><span class=\"line\">changed: [k8s-node-2]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common : Apply sysctl settings without reboot] ***************************************************************************************************************************************************</span><br><span class=\"line\">ok: [dns-bgp-server]</span><br><span class=\"line\">ok: [k8s-node-1]</span><br><span class=\"line\">ok: [k8s-node-3]</span><br><span class=\"line\">ok: [k8s-node-2]</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY [Play 2 - Prepare Kubernetes Nodes] ***************************************************************************************************************************************************************</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Gathering Facts] *********************************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [k8s-node-3]</span><br><span class=\"line\">ok: [k8s-node-1]</span><br><span class=\"line\">ok: [k8s-node-2]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [k8s_node : Install prerequisite packages] ********************************************************************************************************************************************************</span><br><span class=\"line\">ok: [k8s-node-1]</span><br><span class=\"line\">ok: [k8s-node-2]</span><br><span class=\"line\">ok: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [k8s_node : Ensure apt keyrings directory exists] *************************************************************************************************************************************************</span><br><span class=\"line\">ok: [k8s-node-1]</span><br><span class=\"line\">ok: [k8s-node-3]</span><br><span class=\"line\">ok: [k8s-node-2]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [k8s_node : Add Docker<span class=\"string\">&#x27;s official GPG key] ********************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">changed: [k8s-node-2]</span></span><br><span class=\"line\"><span class=\"string\">changed: [k8s-node-3]</span></span><br><span class=\"line\"><span class=\"string\">changed: [k8s-node-1]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">TASK [k8s_node : Add Docker&#x27;</span>s repository to Apt sources] ***********************************************************************************************************************************************</span><br><span class=\"line\">changed: [k8s-node-2]</span><br><span class=\"line\">changed: [k8s-node-1]</span><br><span class=\"line\">changed: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [k8s_node : Install containerd] *******************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [k8s-node-1]</span><br><span class=\"line\">changed: [k8s-node-2]</span><br><span class=\"line\">changed: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [k8s_node : Configure containerd from template] ***************************************************************************************************************************************************</span><br><span class=\"line\">changed: [k8s-node-1]</span><br><span class=\"line\">changed: [k8s-node-2]</span><br><span class=\"line\">changed: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [k8s_node : Install prerequisite packages <span class=\"keyword\">for</span> Kubernetes repo] ************************************************************************************************************************************</span><br><span class=\"line\">changed: [k8s-node-2]</span><br><span class=\"line\">changed: [k8s-node-3]</span><br><span class=\"line\">changed: [k8s-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [k8s_node : Download the Kubernetes public signing key] *******************************************************************************************************************************************</span><br><span class=\"line\">changed: [k8s-node-2]</span><br><span class=\"line\">changed: [k8s-node-1]</span><br><span class=\"line\">changed: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [k8s_node : Dearmor the Kubernetes GPG key] *******************************************************************************************************************************************************</span><br><span class=\"line\">changed: [k8s-node-1]</span><br><span class=\"line\">changed: [k8s-node-2]</span><br><span class=\"line\">changed: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [k8s_node : Add Kubernetes APT repository] ********************************************************************************************************************************************************</span><br><span class=\"line\">changed: [k8s-node-2]</span><br><span class=\"line\">changed: [k8s-node-1]</span><br><span class=\"line\">changed: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [k8s_node : Clean up temporary key file] **********************************************************************************************************************************************************</span><br><span class=\"line\">changed: [k8s-node-1]</span><br><span class=\"line\">changed: [k8s-node-2]</span><br><span class=\"line\">changed: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [k8s_node : Install kubelet, kubeadm, and kubectl] ************************************************************************************************************************************************</span><br><span class=\"line\">changed: [k8s-node-3]</span><br><span class=\"line\">changed: [k8s-node-1]</span><br><span class=\"line\">changed: [k8s-node-2]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [k8s_node : Pin Kubernetes package versions] ******************************************************************************************************************************************************</span><br><span class=\"line\">changed: [k8s-node-2] =&gt; (item=kubelet)</span><br><span class=\"line\">changed: [k8s-node-3] =&gt; (item=kubelet)</span><br><span class=\"line\">changed: [k8s-node-1] =&gt; (item=kubelet)</span><br><span class=\"line\">changed: [k8s-node-2] =&gt; (item=kubeadm)</span><br><span class=\"line\">changed: [k8s-node-1] =&gt; (item=kubeadm)</span><br><span class=\"line\">changed: [k8s-node-3] =&gt; (item=kubeadm)</span><br><span class=\"line\">changed: [k8s-node-2] =&gt; (item=kubectl)</span><br><span class=\"line\">changed: [k8s-node-3] =&gt; (item=kubectl)</span><br><span class=\"line\">changed: [k8s-node-1] =&gt; (item=kubectl)</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [k8s_node : Enable and start kubelet service] *****************************************************************************************************************************************************</span><br><span class=\"line\">changed: [k8s-node-2]</span><br><span class=\"line\">changed: [k8s-node-3]</span><br><span class=\"line\">changed: [k8s-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">RUNNING HANDLER [Restart containerd] *******************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [k8s-node-2]</span><br><span class=\"line\">changed: [k8s-node-1]</span><br><span class=\"line\">changed: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY [Play 3 - Prepare Infrastructure Server] **********************************************************************************************************************************************************</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Gathering Facts] *********************************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [dns-bgp-server]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [infra_server : Install dnsmasq and FRR] **********************************************************************************************************************************************************</span><br><span class=\"line\">changed: [dns-bgp-server]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [infra_server : Configure dnsmasq] ****************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [dns-bgp-server]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [infra_server : Configure FRR daemons] ************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [dns-bgp-server] =&gt; (item=zebra)</span><br><span class=\"line\">changed: [dns-bgp-server] =&gt; (item=bgpd)</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [infra_server : Configure frr.conf] ***************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [dns-bgp-server]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [infra_server : Ensure FRR config has correct permissions] ****************************************************************************************************************************************</span><br><span class=\"line\">ok: [dns-bgp-server]</span><br><span class=\"line\"></span><br><span class=\"line\">RUNNING HANDLER [Restart dnsmasq] **********************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [dns-bgp-server]</span><br><span class=\"line\"></span><br><span class=\"line\">RUNNING HANDLER [Restart frr] **************************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [dns-bgp-server]</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY RECAP *********************************************************************************************************************************************************************************************</span><br><span class=\"line\">dns-bgp-server             : ok=16   changed=11   unreachable=0    failed=0    skipped=2    rescued=0    ignored=0   </span><br><span class=\"line\">k8s-node-1                 : ok=24   changed=18   unreachable=0    failed=0    skipped=2    rescued=0    ignored=0   </span><br><span class=\"line\">k8s-node-2                 : ok=24   changed=18   unreachable=0    failed=0    skipped=2    rescued=0    ignored=0   </span><br><span class=\"line\">k8s-node-3                 : ok=24   changed=18   unreachable=0    failed=0    skipped=2    rescued=0    ignored=0   </span><br></pre></td></tr></table></figure>\n\n<p>多次执行Playbook，验证幂等性</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ois@ois:~/data/k8s-cilium-lab$ ansible-playbook playbooks/2_prepare_nodes.yml --ask-become-pass</span><br><span class=\"line\">BECOME password: </span><br><span class=\"line\"></span><br><span class=\"line\">PLAY [Play 1 - Prepare All Nodes] **********************************************************************************************************************************************************************</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Gathering Facts] *********************************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [k8s-node-2]</span><br><span class=\"line\">ok: [dns-bgp-server]</span><br><span class=\"line\">ok: [k8s-node-3]</span><br><span class=\"line\">ok: [k8s-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common : Wait <span class=\"keyword\">for</span> cloud-init to complete] ********************************************************************************************************************************************************</span><br><span class=\"line\">ok: [k8s-node-1]</span><br><span class=\"line\">ok: [dns-bgp-server]</span><br><span class=\"line\">ok: [k8s-node-2]</span><br><span class=\"line\">ok: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common : Update apt cache and upgrade all packages] **********************************************************************************************************************************************</span><br><span class=\"line\">ok: [dns-bgp-server]</span><br><span class=\"line\">ok: [k8s-node-2]</span><br><span class=\"line\">ok: [k8s-node-3]</span><br><span class=\"line\">ok: [k8s-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common : Configure /etc/hosts from template] *****************************************************************************************************************************************************</span><br><span class=\"line\">ok: [k8s-node-1]</span><br><span class=\"line\">ok: [k8s-node-3]</span><br><span class=\"line\">ok: [dns-bgp-server]</span><br><span class=\"line\">ok: [k8s-node-2]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common : Turn off all swap devices] **************************************************************************************************************************************************************</span><br><span class=\"line\">skipping: [dns-bgp-server]</span><br><span class=\"line\">skipping: [k8s-node-1]</span><br><span class=\"line\">skipping: [k8s-node-2]</span><br><span class=\"line\">skipping: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common : Comment out swap entries <span class=\"keyword\">in</span> /etc/fstab] *************************************************************************************************************************************************</span><br><span class=\"line\">skipping: [dns-bgp-server]</span><br><span class=\"line\">skipping: [k8s-node-1]</span><br><span class=\"line\">skipping: [k8s-node-2]</span><br><span class=\"line\">skipping: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common : Load required kernel modules] ***********************************************************************************************************************************************************</span><br><span class=\"line\">ok: [k8s-node-2] =&gt; (item=overlay)</span><br><span class=\"line\">ok: [dns-bgp-server] =&gt; (item=overlay)</span><br><span class=\"line\">ok: [k8s-node-3] =&gt; (item=overlay)</span><br><span class=\"line\">ok: [k8s-node-1] =&gt; (item=overlay)</span><br><span class=\"line\">ok: [k8s-node-2] =&gt; (item=br_netfilter)</span><br><span class=\"line\">ok: [dns-bgp-server] =&gt; (item=br_netfilter)</span><br><span class=\"line\">ok: [k8s-node-3] =&gt; (item=br_netfilter)</span><br><span class=\"line\">ok: [k8s-node-1] =&gt; (item=br_netfilter)</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common : Ensure kernel modules are loaded on boot] ***********************************************************************************************************************************************</span><br><span class=\"line\">ok: [k8s-node-1]</span><br><span class=\"line\">ok: [dns-bgp-server]</span><br><span class=\"line\">ok: [k8s-node-2]</span><br><span class=\"line\">ok: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common : Configure sysctl parameters <span class=\"keyword\">for</span> Kubernetes networking] **********************************************************************************************************************************</span><br><span class=\"line\">ok: [dns-bgp-server]</span><br><span class=\"line\">ok: [k8s-node-1]</span><br><span class=\"line\">ok: [k8s-node-2]</span><br><span class=\"line\">ok: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common : Apply sysctl settings without reboot] ***************************************************************************************************************************************************</span><br><span class=\"line\">ok: [dns-bgp-server]</span><br><span class=\"line\">ok: [k8s-node-1]</span><br><span class=\"line\">ok: [k8s-node-2]</span><br><span class=\"line\">ok: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY [Play 2 - Prepare Kubernetes Nodes] ***************************************************************************************************************************************************************</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Gathering Facts] *********************************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [k8s-node-2]</span><br><span class=\"line\">ok: [k8s-node-1]</span><br><span class=\"line\">ok: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [k8s_node : Install prerequisite packages] ********************************************************************************************************************************************************</span><br><span class=\"line\">ok: [k8s-node-1]</span><br><span class=\"line\">ok: [k8s-node-2]</span><br><span class=\"line\">ok: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [k8s_node : Ensure apt keyrings directory exists] *************************************************************************************************************************************************</span><br><span class=\"line\">ok: [k8s-node-1]</span><br><span class=\"line\">ok: [k8s-node-2]</span><br><span class=\"line\">ok: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [k8s_node : Add Docker<span class=\"string\">&#x27;s official GPG key] ********************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">ok: [k8s-node-1]</span></span><br><span class=\"line\"><span class=\"string\">ok: [k8s-node-2]</span></span><br><span class=\"line\"><span class=\"string\">ok: [k8s-node-3]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">TASK [k8s_node : Add Docker&#x27;</span>s repository to Apt sources] ***********************************************************************************************************************************************</span><br><span class=\"line\">ok: [k8s-node-2]</span><br><span class=\"line\">ok: [k8s-node-1]</span><br><span class=\"line\">ok: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [k8s_node : Install containerd] *******************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [k8s-node-2]</span><br><span class=\"line\">ok: [k8s-node-1]</span><br><span class=\"line\">ok: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [k8s_node : Configure containerd from template] ***************************************************************************************************************************************************</span><br><span class=\"line\">ok: [k8s-node-1]</span><br><span class=\"line\">ok: [k8s-node-2]</span><br><span class=\"line\">ok: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [k8s_node : Install prerequisite packages <span class=\"keyword\">for</span> Kubernetes repo] ************************************************************************************************************************************</span><br><span class=\"line\">ok: [k8s-node-2]</span><br><span class=\"line\">ok: [k8s-node-1]</span><br><span class=\"line\">ok: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [k8s_node : Download the Kubernetes public signing key] *******************************************************************************************************************************************</span><br><span class=\"line\">changed: [k8s-node-2]</span><br><span class=\"line\">changed: [k8s-node-1]</span><br><span class=\"line\">changed: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [k8s_node : Dearmor the Kubernetes GPG key] *******************************************************************************************************************************************************</span><br><span class=\"line\">ok: [k8s-node-1]</span><br><span class=\"line\">ok: [k8s-node-2]</span><br><span class=\"line\">ok: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [k8s_node : Add Kubernetes APT repository] ********************************************************************************************************************************************************</span><br><span class=\"line\">ok: [k8s-node-1]</span><br><span class=\"line\">ok: [k8s-node-2]</span><br><span class=\"line\">ok: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [k8s_node : Clean up temporary key file] **********************************************************************************************************************************************************</span><br><span class=\"line\">changed: [k8s-node-1]</span><br><span class=\"line\">changed: [k8s-node-2]</span><br><span class=\"line\">changed: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [k8s_node : Install kubelet, kubeadm, and kubectl] ************************************************************************************************************************************************</span><br><span class=\"line\">ok: [k8s-node-1]</span><br><span class=\"line\">ok: [k8s-node-2]</span><br><span class=\"line\">ok: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [k8s_node : Pin Kubernetes package versions] ******************************************************************************************************************************************************</span><br><span class=\"line\">ok: [k8s-node-1] =&gt; (item=kubelet)</span><br><span class=\"line\">ok: [k8s-node-2] =&gt; (item=kubelet)</span><br><span class=\"line\">ok: [k8s-node-3] =&gt; (item=kubelet)</span><br><span class=\"line\">ok: [k8s-node-1] =&gt; (item=kubeadm)</span><br><span class=\"line\">ok: [k8s-node-2] =&gt; (item=kubeadm)</span><br><span class=\"line\">ok: [k8s-node-3] =&gt; (item=kubeadm)</span><br><span class=\"line\">ok: [k8s-node-1] =&gt; (item=kubectl)</span><br><span class=\"line\">ok: [k8s-node-2] =&gt; (item=kubectl)</span><br><span class=\"line\">ok: [k8s-node-3] =&gt; (item=kubectl)</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [k8s_node : Enable and start kubelet service] *****************************************************************************************************************************************************</span><br><span class=\"line\">ok: [k8s-node-1]</span><br><span class=\"line\">ok: [k8s-node-2]</span><br><span class=\"line\">ok: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY [Play 3 - Prepare Infrastructure Server] **********************************************************************************************************************************************************</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Gathering Facts] *********************************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [dns-bgp-server]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [infra_server : Install dnsmasq and FRR] **********************************************************************************************************************************************************</span><br><span class=\"line\">ok: [dns-bgp-server]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [infra_server : Configure dnsmasq] ****************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [dns-bgp-server]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [infra_server : Configure FRR daemons] ************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [dns-bgp-server] =&gt; (item=zebra)</span><br><span class=\"line\">ok: [dns-bgp-server] =&gt; (item=bgpd)</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [infra_server : Configure frr.conf] ***************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [dns-bgp-server]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [infra_server : Ensure FRR config has correct permissions] ****************************************************************************************************************************************</span><br><span class=\"line\">ok: [dns-bgp-server]</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY RECAP *********************************************************************************************************************************************************************************************</span><br><span class=\"line\">dns-bgp-server             : ok=14   changed=0    unreachable=0    failed=0    skipped=2    rescued=0    ignored=0   </span><br><span class=\"line\">k8s-node-1                 : ok=23   changed=2    unreachable=0    failed=0    skipped=2    rescued=0    ignored=0   </span><br><span class=\"line\">k8s-node-2                 : ok=23   changed=2    unreachable=0    failed=0    skipped=2    rescued=0    ignored=0   </span><br><span class=\"line\">k8s-node-3                 : ok=23   changed=2    unreachable=0    failed=0    skipped=2    rescued=0    ignored=0   </span><br></pre></td></tr></table></figure>\n\n<h1 id=\"7-执行脚本，构建设置K8S-Cluster的Playbook\"><a href=\"#7-执行脚本，构建设置K8S-Cluster的Playbook\" class=\"headerlink\" title=\"7. 执行脚本，构建设置K8S Cluster的Playbook\"></a>7. 执行脚本，构建设置K8S Cluster的Playbook</h1><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ois@ois:~/data/k8s-cilium-lab$ <span class=\"built_in\">cd</span> ..</span><br><span class=\"line\">ois@ois:~/data$ ./03-setup-cluster.sh </span><br><span class=\"line\">--- Kubernetes Cluster Setup Playbook Generator ---</span><br><span class=\"line\"></span><br><span class=\"line\">--- Step 1: Verifying Project Context ---</span><br><span class=\"line\">✅ Working inside project directory: /home/ois/data/k8s-cilium-lab</span><br><span class=\"line\"></span><br><span class=\"line\">--- Step 2: Checking <span class=\"keyword\">for</span> <span class=\"string\">&#x27;community.kubernetes&#x27;</span> Ansible Collection ---</span><br><span class=\"line\">✅ <span class=\"string\">&#x27;community.kubernetes&#x27;</span> collection is already installed.</span><br><span class=\"line\"></span><br><span class=\"line\">--- Step 3: Generating Cilium BGP Template ---</span><br><span class=\"line\">✅ Created Cilium BGP config template.</span><br><span class=\"line\"></span><br><span class=\"line\">--- Step 4: Generating Main Playbook ---</span><br><span class=\"line\">✅ Created main playbook: playbooks/3_setup_cluster.yml</span><br><span class=\"line\"></span><br><span class=\"line\">--- Generation Complete! ---</span><br><span class=\"line\">✅ All necessary files <span class=\"keyword\">for</span> cluster setup have been created.</span><br><span class=\"line\"></span><br><span class=\"line\">Next Step:</span><br><span class=\"line\">1. IMPORTANT: Reset your cluster nodes to ensure a clean state <span class=\"keyword\">for</span> this new workflow.</span><br><span class=\"line\">   On each K8s VM, run: <span class=\"built_in\">sudo</span> kubeadm reset -f</span><br><span class=\"line\">2. Change into the project directory: <span class=\"built_in\">cd</span> k8s-cilium-lab</span><br><span class=\"line\">3. Run the playbook to build your Kubernetes cluster. You will be prompted <span class=\"keyword\">for</span> the <span class=\"built_in\">sudo</span> password:</span><br><span class=\"line\">   ansible-playbook playbooks/3_setup_cluster.yml --ask-become-pass</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"8-执行Playbook-设置K8S-Cluster和Clium\"><a href=\"#8-执行Playbook-设置K8S-Cluster和Clium\" class=\"headerlink\" title=\"8. 执行Playbook 设置K8S Cluster和Clium\"></a>8. 执行Playbook 设置K8S Cluster和Clium</h1><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ois@ois:~/data$ <span class=\"built_in\">cd</span> k8s-cilium-lab/</span><br><span class=\"line\">ois@ois:~/data/k8s-cilium-lab$ ansible-playbook playbooks/3_setup_cluster.yml --ask-become-pass</span><br><span class=\"line\">BECOME password: </span><br><span class=\"line\">[DEPRECATION WARNING]: community.kubernetes.helm_repository has been deprecated. The community.kubernetes collection is being renamed to kubernetes.core. Please update your FQCNs to kubernetes.core </span><br><span class=\"line\">instead. This feature will be removed from community.kubernetes <span class=\"keyword\">in</span> version 3.0.0. Deprecation warnings can be disabled by setting deprecation_warnings=False <span class=\"keyword\">in</span> ansible.cfg.</span><br><span class=\"line\">[DEPRECATION WARNING]: community.kubernetes.helm has been deprecated. The community.kubernetes collection is being renamed to kubernetes.core. Please update your FQCNs to kubernetes.core instead. </span><br><span class=\"line\">This feature will be removed from community.kubernetes <span class=\"keyword\">in</span> version 3.0.0. Deprecation warnings can be disabled by setting deprecation_warnings=False <span class=\"keyword\">in</span> ansible.cfg.</span><br><span class=\"line\">[DEPRECATION WARNING]: community.kubernetes.k8s has been deprecated. The community.kubernetes collection is being renamed to kubernetes.core. Please update your FQCNs to kubernetes.core instead. This</span><br><span class=\"line\"> feature will be removed from community.kubernetes <span class=\"keyword\">in</span> version 3.0.0. Deprecation warnings can be disabled by setting deprecation_warnings=False <span class=\"keyword\">in</span> ansible.cfg.</span><br><span class=\"line\">[DEPRECATION WARNING]: community.kubernetes.k8s_info has been deprecated. The community.kubernetes collection is being renamed to kubernetes.core. Please update your FQCNs to kubernetes.core instead.</span><br><span class=\"line\"> This feature will be removed from community.kubernetes <span class=\"keyword\">in</span> version 3.0.0. Deprecation warnings can be disabled by setting deprecation_warnings=False <span class=\"keyword\">in</span> ansible.cfg.</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY [Play 1 - Initialize and Configure Control Plane] *************************************************************************************************************************************************</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Gathering Facts] *********************************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [k8s-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Check <span class=\"keyword\">if</span> cluster is already initialized] *********************************************************************************************************************************************************</span><br><span class=\"line\">ok: [k8s-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Initialize the cluster] **************************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [k8s-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Create .kube directory <span class=\"keyword\">for</span> ubuntu user] **********************************************************************************************************************************************************</span><br><span class=\"line\">changed: [k8s-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Copy admin.conf to user<span class=\"string\">&#x27;s kube config] ***********************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">changed: [k8s-node-1]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">TASK [Set KUBECONFIG for root user permanently] ********************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">changed: [k8s-node-1]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">TASK [Install prerequisites for Kubernetes modules] ****************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">changed: [k8s-node-1]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">TASK [Install Helm] ************************************************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">changed: [k8s-node-1]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">TASK [Install Cilium CLI] ******************************************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">changed: [k8s-node-1]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">TASK [Add Helm repositories] ***************************************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">changed: [k8s-node-1] =&gt; (item=&#123;&#x27;</span>name<span class=\"string\">&#x27;: &#x27;</span>cilium<span class=\"string\">&#x27;, &#x27;</span>url<span class=\"string\">&#x27;: &#x27;</span>https://helm.cilium.io/<span class=\"string\">&#x27;&#125;)</span></span><br><span class=\"line\"><span class=\"string\">changed: [k8s-node-1] =&gt; (item=&#123;&#x27;</span>name<span class=\"string\">&#x27;: &#x27;</span>isovalent<span class=\"string\">&#x27;, &#x27;</span>url<span class=\"string\">&#x27;: &#x27;</span>https://helm.isovalent.com/<span class=\"string\">&#x27;&#125;)</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">TASK [Deploy Cilium and Hubble with Helm] **************************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">changed: [k8s-node-1]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">TASK [Expose Hubble UI service via NodePort] ***********************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">[WARNING]: kubernetes&lt;24.2.0 is not supported or tested. Some features may not work.</span></span><br><span class=\"line\"><span class=\"string\">changed: [k8s-node-1]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">TASK [Wait for Cilium CRDs to become available] ********************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">FAILED - RETRYING: [k8s-node-1]: Wait for Cilium CRDs to become available (20 retries left).</span></span><br><span class=\"line\"><span class=\"string\">FAILED - RETRYING: [k8s-node-1]: Wait for Cilium CRDs to become available (19 retries left).</span></span><br><span class=\"line\"><span class=\"string\">FAILED - RETRYING: [k8s-node-1]: Wait for Cilium CRDs to become available (18 retries left).</span></span><br><span class=\"line\"><span class=\"string\">FAILED - RETRYING: [k8s-node-1]: Wait for Cilium CRDs to become available (17 retries left).</span></span><br><span class=\"line\"><span class=\"string\">FAILED - RETRYING: [k8s-node-1]: Wait for Cilium CRDs to become available (16 retries left).</span></span><br><span class=\"line\"><span class=\"string\">FAILED - RETRYING: [k8s-node-1]: Wait for Cilium CRDs to become available (15 retries left).</span></span><br><span class=\"line\"><span class=\"string\">FAILED - RETRYING: [k8s-node-1]: Wait for Cilium CRDs to become available (14 retries left).</span></span><br><span class=\"line\"><span class=\"string\">FAILED - RETRYING: [k8s-node-1]: Wait for Cilium CRDs to become available (13 retries left).</span></span><br><span class=\"line\"><span class=\"string\">FAILED - RETRYING: [k8s-node-1]: Wait for Cilium CRDs to become available (12 retries left).</span></span><br><span class=\"line\"><span class=\"string\">FAILED - RETRYING: [k8s-node-1]: Wait for Cilium CRDs to become available (11 retries left).</span></span><br><span class=\"line\"><span class=\"string\">FAILED - RETRYING: [k8s-node-1]: Wait for Cilium CRDs to become available (10 retries left).</span></span><br><span class=\"line\"><span class=\"string\">FAILED - RETRYING: [k8s-node-1]: Wait for Cilium CRDs to become available (9 retries left).</span></span><br><span class=\"line\"><span class=\"string\">ok: [k8s-node-1]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">TASK [Apply Cilium BGP Configuration from template] ****************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">changed: [k8s-node-1]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">TASK [Generate a token for workers to join] ************************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">changed: [k8s-node-1]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">TASK [Store the join command for other hosts to access] ************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">ok: [k8s-node-1]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">PLAY [Play 2 - Join Worker Nodes to the Fully Configured Cluster] **************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">TASK [Gathering Facts] *********************************************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">ok: [k8s-node-2]</span></span><br><span class=\"line\"><span class=\"string\">ok: [k8s-node-3]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">TASK [Check if node has already joined] ****************************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">ok: [k8s-node-2]</span></span><br><span class=\"line\"><span class=\"string\">ok: [k8s-node-3]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">TASK [Join the cluster] ********************************************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">changed: [k8s-node-2]</span></span><br><span class=\"line\"><span class=\"string\">changed: [k8s-node-3]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">PLAY [Play 3 - Display Final Access Information] *******************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">TASK [Get Hubble UI service details] *******************************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">ok: [k8s-node-1]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">TASK [Display the final access URL] ********************************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">ok: [k8s-node-1] =&gt; &#123;</span></span><br><span class=\"line\"><span class=\"string\">    &quot;msg&quot;: &quot;========================================================\\n🚀 Your Kubernetes Lab is Ready!\\n\\nAccess the Hubble UI at:\\nhttp://10.75.59.81:31708\\n========================================================\\n&quot;</span></span><br><span class=\"line\"><span class=\"string\">&#125;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">PLAY RECAP *********************************************************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">k8s-node-1                 : ok=18   changed=12   unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span></span><br><span class=\"line\"><span class=\"string\">k8s-node-2                 : ok=3    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span></span><br><span class=\"line\"><span class=\"string\">k8s-node-3                 : ok=3    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"9-多次执行Playbook，验证幂等性。\"><a href=\"#9-多次执行Playbook，验证幂等性。\" class=\"headerlink\" title=\"9. 多次执行Playbook，验证幂等性。\"></a>9. 多次执行Playbook，验证幂等性。</h1><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ois@ois:~/data/k8s-cilium-lab$ ansible-playbook playbooks/3_setup_cluster.yml --ask-become-pass</span><br><span class=\"line\">BECOME password: </span><br><span class=\"line\">[DEPRECATION WARNING]: community.kubernetes.helm_repository has been deprecated. The community.kubernetes collection is being renamed to kubernetes.core. Please update your FQCNs to kubernetes.core </span><br><span class=\"line\">instead. This feature will be removed from community.kubernetes <span class=\"keyword\">in</span> version 3.0.0. Deprecation warnings can be disabled by setting deprecation_warnings=False <span class=\"keyword\">in</span> ansible.cfg.</span><br><span class=\"line\">[DEPRECATION WARNING]: community.kubernetes.helm has been deprecated. The community.kubernetes collection is being renamed to kubernetes.core. Please update your FQCNs to kubernetes.core instead. </span><br><span class=\"line\">This feature will be removed from community.kubernetes <span class=\"keyword\">in</span> version 3.0.0. Deprecation warnings can be disabled by setting deprecation_warnings=False <span class=\"keyword\">in</span> ansible.cfg.</span><br><span class=\"line\">[DEPRECATION WARNING]: community.kubernetes.k8s has been deprecated. The community.kubernetes collection is being renamed to kubernetes.core. Please update your FQCNs to kubernetes.core instead. This</span><br><span class=\"line\"> feature will be removed from community.kubernetes <span class=\"keyword\">in</span> version 3.0.0. Deprecation warnings can be disabled by setting deprecation_warnings=False <span class=\"keyword\">in</span> ansible.cfg.</span><br><span class=\"line\">[DEPRECATION WARNING]: community.kubernetes.k8s_info has been deprecated. The community.kubernetes collection is being renamed to kubernetes.core. Please update your FQCNs to kubernetes.core instead.</span><br><span class=\"line\"> This feature will be removed from community.kubernetes <span class=\"keyword\">in</span> version 3.0.0. Deprecation warnings can be disabled by setting deprecation_warnings=False <span class=\"keyword\">in</span> ansible.cfg.</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY [Play 1 - Initialize and Configure Control Plane] *************************************************************************************************************************************************</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Gathering Facts] *********************************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [k8s-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Check <span class=\"keyword\">if</span> cluster is already initialized] *********************************************************************************************************************************************************</span><br><span class=\"line\">ok: [k8s-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Initialize the cluster] **************************************************************************************************************************************************************************</span><br><span class=\"line\">skipping: [k8s-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Create .kube directory <span class=\"keyword\">for</span> ubuntu user] **********************************************************************************************************************************************************</span><br><span class=\"line\">skipping: [k8s-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Copy admin.conf to user<span class=\"string\">&#x27;s kube config] ***********************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">skipping: [k8s-node-1]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">TASK [Set KUBECONFIG for root user permanently] ********************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">ok: [k8s-node-1]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">TASK [Install prerequisites for Kubernetes modules] ****************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">ok: [k8s-node-1]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">TASK [Install Helm] ************************************************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">skipping: [k8s-node-1]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">TASK [Install Cilium CLI] ******************************************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">skipping: [k8s-node-1]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">TASK [Add Helm repositories] ***************************************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">ok: [k8s-node-1] =&gt; (item=&#123;&#x27;</span>name<span class=\"string\">&#x27;: &#x27;</span>cilium<span class=\"string\">&#x27;, &#x27;</span>url<span class=\"string\">&#x27;: &#x27;</span>https://helm.cilium.io/<span class=\"string\">&#x27;&#125;)</span></span><br><span class=\"line\"><span class=\"string\">ok: [k8s-node-1] =&gt; (item=&#123;&#x27;</span>name<span class=\"string\">&#x27;: &#x27;</span>isovalent<span class=\"string\">&#x27;, &#x27;</span>url<span class=\"string\">&#x27;: &#x27;</span>https://helm.isovalent.com/<span class=\"string\">&#x27;&#125;)</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">TASK [Deploy Cilium and Hubble with Helm] **************************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">[WARNING]: The default idempotency check can fail to report changes in certain cases. Install helm diff &gt;= 3.4.1 for better results.</span></span><br><span class=\"line\"><span class=\"string\">ok: [k8s-node-1]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">TASK [Expose Hubble UI service via NodePort] ***********************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">[WARNING]: kubernetes&lt;24.2.0 is not supported or tested. Some features may not work.</span></span><br><span class=\"line\"><span class=\"string\">ok: [k8s-node-1]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">TASK [Wait for Cilium CRDs to become available] ********************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">ok: [k8s-node-1]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">TASK [Apply Cilium BGP Configuration from template] ****************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">ok: [k8s-node-1]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">TASK [Generate a token for workers to join] ************************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">changed: [k8s-node-1]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">TASK [Store the join command for other hosts to access] ************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">ok: [k8s-node-1]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">PLAY [Play 2 - Join Worker Nodes to the Fully Configured Cluster] **************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">TASK [Gathering Facts] *********************************************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">ok: [k8s-node-2]</span></span><br><span class=\"line\"><span class=\"string\">ok: [k8s-node-3]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">TASK [Check if node has already joined] ****************************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">ok: [k8s-node-2]</span></span><br><span class=\"line\"><span class=\"string\">ok: [k8s-node-3]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">TASK [Join the cluster] ********************************************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">skipping: [k8s-node-2]</span></span><br><span class=\"line\"><span class=\"string\">skipping: [k8s-node-3]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">PLAY [Play 3 - Display Final Access Information] *******************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">TASK [Get Hubble UI service details] *******************************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">ok: [k8s-node-1]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">TASK [Display the final access URL] ********************************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">ok: [k8s-node-1] =&gt; &#123;</span></span><br><span class=\"line\"><span class=\"string\">    &quot;msg&quot;: &quot;========================================================\\n🚀 Your Kubernetes Lab is Ready!\\n\\nAccess the Hubble UI at:\\nhttp://10.75.59.81:31708\\n========================================================\\n&quot;</span></span><br><span class=\"line\"><span class=\"string\">&#125;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">PLAY RECAP *********************************************************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">k8s-node-1                 : ok=13   changed=1    unreachable=0    failed=0    skipped=5    rescued=0    ignored=0   </span></span><br><span class=\"line\"><span class=\"string\">k8s-node-2                 : ok=2    changed=0    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   </span></span><br><span class=\"line\"><span class=\"string\">k8s-node-3                 : ok=2    changed=0    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   </span></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"10-部署Demo-App\"><a href=\"#10-部署Demo-App\" class=\"headerlink\" title=\"10. 部署Demo App\"></a>10. 部署Demo App</h1><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ois@ois:~/data/k8s-cilium-lab$ <span class=\"built_in\">cd</span> ../</span><br><span class=\"line\">ois@ois:~/data$ ./04-deploy-star-wars.sh </span><br><span class=\"line\">--- Star Wars Demo Script Deployer ---</span><br><span class=\"line\"></span><br><span class=\"line\">--- Step 1: Verifying Project Context ---</span><br><span class=\"line\">✅ Working inside project directory: /home/ois/data/k8s-cilium-lab</span><br><span class=\"line\"></span><br><span class=\"line\">--- Step 2: Generating the script template ---</span><br><span class=\"line\">✅ Created template: templates/deploy-star-wars.sh.j2</span><br><span class=\"line\"></span><br><span class=\"line\">--- Step 3: Generating the deployment playbook ---</span><br><span class=\"line\">✅ Created playbook: playbooks/4_deploy_app.yml</span><br><span class=\"line\"></span><br><span class=\"line\">--- Generation Complete! ---</span><br><span class=\"line\">✅ All necessary files <span class=\"keyword\">for</span> deploying the application script have been created.</span><br><span class=\"line\"></span><br><span class=\"line\">Next Steps:</span><br><span class=\"line\">1. Change into the project directory: <span class=\"built_in\">cd</span> k8s-cilium-lab</span><br><span class=\"line\">2. Run the playbook to copy the script to your control plane node:</span><br><span class=\"line\">   ansible-playbook playbooks/4_deploy_app.yml --ask-become-pass</span><br><span class=\"line\">3. SSH into the control plane and run the script:</span><br><span class=\"line\">   ssh ubuntu@k8s-node-1</span><br><span class=\"line\">   <span class=\"built_in\">sudo</span> /root/deploy-star-wars.sh</span><br><span class=\"line\">ois@ois:~/data$ <span class=\"built_in\">cd</span> k8s-cilium-lab/</span><br><span class=\"line\">ois@ois:~/data/k8s-cilium-lab$ ansible-playbook playbooks/4_deploy_app.yml --ask-become-pass</span><br><span class=\"line\">BECOME password: </span><br><span class=\"line\"></span><br><span class=\"line\">PLAY [Deploy Star Wars Demo Script] ********************************************************************************************************************************************************************</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Gathering Facts] *********************************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [k8s-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Copy the Star Wars deployment script to the control plane] ***************************************************************************************************************************************</span><br><span class=\"line\">changed: [k8s-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY RECAP *********************************************************************************************************************************************************************************************</span><br><span class=\"line\">k8s-node-1                 : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class=\"line\"></span><br><span class=\"line\">ois@ois:~/data/k8s-cilium-lab$ </span><br><span class=\"line\">ois@ois:~/data/k8s-cilium-lab$ ssh ubuntu@10.75.59.81</span><br><span class=\"line\">Welcome to Ubuntu 24.04.2 LTS (GNU/Linux 6.8.0-63-generic x86_64)</span><br><span class=\"line\"></span><br><span class=\"line\"> * Documentation:  https://help.ubuntu.com</span><br><span class=\"line\"> * Management:     https://landscape.canonical.com</span><br><span class=\"line\"> * Support:        https://ubuntu.com/pro</span><br><span class=\"line\"></span><br><span class=\"line\"> System information as of Mon Aug  4 05:00:52 PM CST 2025</span><br><span class=\"line\"></span><br><span class=\"line\">  System load:  0.26               Processes:               195</span><br><span class=\"line\">  Usage of /:   33.4% of 18.33GB   Users logged <span class=\"keyword\">in</span>:         0</span><br><span class=\"line\">  Memory usage: 16%                IPv4 address <span class=\"keyword\">for</span> enp1s0: 10.75.59.81</span><br><span class=\"line\">  Swap usage:   0%</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">Expanded Security Maintenance <span class=\"keyword\">for</span> Applications is not enabled.</span><br><span class=\"line\"></span><br><span class=\"line\">0 updates can be applied immediately.</span><br><span class=\"line\"></span><br><span class=\"line\">Enable ESM Apps to receive additional future security updates.</span><br><span class=\"line\">See https://ubuntu.com/esm or run: <span class=\"built_in\">sudo</span> pro status</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">*** System restart required ***</span><br><span class=\"line\">Last login: Mon Aug  4 16:55:53 2025 from 10.75.59.129</span><br><span class=\"line\">ubuntu@k8s-node-1:~$ <span class=\"built_in\">sudo</span> su</span><br><span class=\"line\">[<span class=\"built_in\">sudo</span>] password <span class=\"keyword\">for</span> ubuntu: </span><br><span class=\"line\">root@k8s-node-1:/home/ubuntu# <span class=\"built_in\">cd</span></span><br><span class=\"line\">root@k8s-node-1:~# cilium status</span><br><span class=\"line\">    /¯¯\\</span><br><span class=\"line\"> /¯¯\\__/¯¯\\    Cilium:             OK</span><br><span class=\"line\"> \\__/¯¯\\__/    Operator:           OK</span><br><span class=\"line\"> /¯¯\\__/¯¯\\    Envoy DaemonSet:    OK</span><br><span class=\"line\"> \\__/¯¯\\__/    Hubble Relay:       OK</span><br><span class=\"line\">    \\__/       ClusterMesh:        disabled</span><br><span class=\"line\"></span><br><span class=\"line\">DaemonSet              cilium                   Desired: 3, Ready: 3/3, Available: 3/3</span><br><span class=\"line\">DaemonSet              cilium-envoy             Desired: 3, Ready: 3/3, Available: 3/3</span><br><span class=\"line\">Deployment             cilium-operator          Desired: 2, Ready: 2/2, Available: 2/2</span><br><span class=\"line\">Deployment             hubble-relay             Desired: 1, Ready: 1/1, Available: 1/1</span><br><span class=\"line\">Deployment             hubble-ui                Desired: 1, Ready: 1/1, Available: 1/1</span><br><span class=\"line\">Containers:            cilium                   Running: 3</span><br><span class=\"line\">                       cilium-envoy             Running: 3</span><br><span class=\"line\">                       cilium-operator          Running: 2</span><br><span class=\"line\">                       clustermesh-apiserver    </span><br><span class=\"line\">                       hubble-relay             Running: 1</span><br><span class=\"line\">                       hubble-ui                Running: 1</span><br><span class=\"line\">Cluster Pods:          8/8 managed by Cilium</span><br><span class=\"line\">Helm chart version:    1.17.6</span><br><span class=\"line\">Image versions         cilium             quay.io/isovalent/cilium:v1.17.6-cee.1@sha256:2d01daf4f25f7d644889b49ca856e1a4269981fc963e50bd3962665b41b6adb3: 3</span><br><span class=\"line\">                       cilium-envoy       quay.io/isovalent/cilium-envoy:v1.17.6-cee.1@sha256:318eff387835ca2717baab42a84f35a83a5f9e7d519253df87269f80b9ff0171: 3</span><br><span class=\"line\">                       cilium-operator    quay.io/isovalent/operator-generic:v1.17.6-cee.1@sha256:2e602710a7c4f101831df679e5d8251bae8bf0f9fe26c20bbef87f1966ea8265: 2</span><br><span class=\"line\">                       hubble-relay       quay.io/isovalent/hubble-relay:v1.17.6-cee.1@sha256:d378e3607f7492374e65e2bd854cc0ec87480c63ba49a96dadcd75a6946b586e: 1</span><br><span class=\"line\">                       hubble-ui          quay.io/isovalent/hubble-ui-backend:v1.17.6-cee.1@sha256:a034b7e98e6ea796ed26df8f4e71f83fc16465a19d166eff67a03b822c0bfa15: 1</span><br><span class=\"line\">                       hubble-ui          quay.io/isovalent/hubble-ui:v1.17.6-cee.1@sha256:9e37c1296b802830834cc87342a9182ccbb71ffebb711971e849221bd9d59392: 1</span><br><span class=\"line\">root@k8s-node-1:~# </span><br><span class=\"line\">root@k8s-node-1:~# ./deploy-star-wars.sh </span><br><span class=\"line\">🚀 Starting Star Wars Demo Application Deployment...</span><br><span class=\"line\">=================================================</span><br><span class=\"line\"></span><br><span class=\"line\">--- Step 1: Ensuring <span class=\"string\">&#x27;star-wars&#x27;</span> namespace exists ---</span><br><span class=\"line\"></span><br><span class=\"line\">▶️  Running <span class=\"built_in\">command</span>:</span><br><span class=\"line\">  kubectl create namespace star-wars</span><br><span class=\"line\">namespace/star-wars created</span><br><span class=\"line\">✅ Namespace <span class=\"string\">&#x27;star-wars&#x27;</span> created.</span><br><span class=\"line\"></span><br><span class=\"line\">--- Step 2: Applying application manifest from GitHub ---</span><br><span class=\"line\"></span><br><span class=\"line\">▶️  Running <span class=\"built_in\">command</span>:</span><br><span class=\"line\">  kubectl apply -n star-wars -f https://raw.githubusercontent.com/cilium/cilium/HEAD/examples/minikube/http-sw-app.yaml</span><br><span class=\"line\">service/deathstar created</span><br><span class=\"line\">deployment.apps/deathstar created</span><br><span class=\"line\">pod/tiefighter created</span><br><span class=\"line\">pod/xwing created</span><br><span class=\"line\"></span><br><span class=\"line\">--- Step 3: Waiting <span class=\"keyword\">for</span> all application pods to be ready ---</span><br><span class=\"line\">  (This may take a minute as images are pulled...)</span><br><span class=\"line\"></span><br><span class=\"line\">▶️  Running <span class=\"built_in\">command</span>:</span><br><span class=\"line\">  kubectl <span class=\"built_in\">wait</span> --<span class=\"keyword\">for</span>=condition=ready pod --all -n star-wars --<span class=\"built_in\">timeout</span>=120s</span><br><span class=\"line\">pod/deathstar-86f85ffb4d-8xbb4 condition met</span><br><span class=\"line\">pod/deathstar-86f85ffb4d-dwfx5 condition met</span><br><span class=\"line\">pod/tiefighter condition met</span><br><span class=\"line\">pod/xwing condition met</span><br><span class=\"line\">✅ All pods are running and ready.</span><br><span class=\"line\"></span><br><span class=\"line\">--- Step 4: Displaying pod status ---</span><br><span class=\"line\"></span><br><span class=\"line\">▶️  Running <span class=\"built_in\">command</span>:</span><br><span class=\"line\">  kubectl -n star-wars get pod -o wide --show-labels</span><br><span class=\"line\">NAME                         READY   STATUS    RESTARTS   AGE   IP             NODE         NOMINATED NODE   READINESS GATES   LABELS</span><br><span class=\"line\">deathstar-86f85ffb4d-8xbb4   1/1     Running   0          24s   172.16.2.92    k8s-node-3   &lt;none&gt;           &lt;none&gt;            app.kubernetes.io/name=deathstar,class=deathstar,org=empire,pod-template-hash=86f85ffb4d</span><br><span class=\"line\">deathstar-86f85ffb4d-dwfx5   1/1     Running   0          24s   172.16.1.198   k8s-node-2   &lt;none&gt;           &lt;none&gt;            app.kubernetes.io/name=deathstar,class=deathstar,org=empire,pod-template-hash=86f85ffb4d</span><br><span class=\"line\">tiefighter                   1/1     Running   0          24s   172.16.2.180   k8s-node-3   &lt;none&gt;           &lt;none&gt;            app.kubernetes.io/name=tiefighter,class=tiefighter,org=empire</span><br><span class=\"line\">xwing                        1/1     Running   0          24s   172.16.2.156   k8s-node-3   &lt;none&gt;           &lt;none&gt;            app.kubernetes.io/name=xwing,class=xwing,org=alliance</span><br><span class=\"line\"></span><br><span class=\"line\">--- Step 5: Exposing <span class=\"string\">&#x27;deathstar&#x27;</span> service via NodePort ---</span><br><span class=\"line\"></span><br><span class=\"line\">▶️  Running <span class=\"built_in\">command</span>:</span><br><span class=\"line\">  kubectl -n star-wars patch service deathstar -p &#123;<span class=\"string\">&quot;spec&quot;</span>:&#123;<span class=\"string\">&quot;type&quot;</span>:<span class=\"string\">&quot;NodePort&quot;</span>&#125;&#125;</span><br><span class=\"line\">service/deathstar patched</span><br><span class=\"line\">✅ Service <span class=\"string\">&#x27;deathstar&#x27;</span> patched to NodePort.</span><br><span class=\"line\"></span><br><span class=\"line\">--- Step 6: Testing connectivity from client pods ---</span><br><span class=\"line\">  (A <span class=\"string\">&#x27;Ship landed&#x27;</span> message indicates success)</span><br><span class=\"line\"></span><br><span class=\"line\">▶️  Running <span class=\"built_in\">command</span>:</span><br><span class=\"line\">  kubectl -n star-wars <span class=\"built_in\">exec</span> tiefighter -- curl -s -XPOST http://deathstar.star-wars.svc.cluster.local/v1/request-landing</span><br><span class=\"line\">Ship landed</span><br><span class=\"line\"></span><br><span class=\"line\">▶️  Running <span class=\"built_in\">command</span>:</span><br><span class=\"line\">  kubectl -n star-wars <span class=\"built_in\">exec</span> xwing -- curl -s -XPOST http://deathstar.star-wars.svc.cluster.local/v1/request-landing</span><br><span class=\"line\">Ship landed</span><br><span class=\"line\"></span><br><span class=\"line\">--- Step 7: Displaying external access information ---</span><br><span class=\"line\"></span><br><span class=\"line\">=================================================</span><br><span class=\"line\">🎉 Star Wars Demo Application Deployed Successfully!</span><br><span class=\"line\">   You can access the Deathstar service from outside the cluster at:</span><br><span class=\"line\">   curl -XPOST http://10.75.59.81:30719/v1/request-landing</span><br><span class=\"line\">=================================================</span><br><span class=\"line\">root@k8s-node-1:~# curl -XPOST http://10.75.59.81:30719/v1/request-landing</span><br><span class=\"line\">Ship landed</span><br><span class=\"line\">root@k8s-node-1:~# <span class=\"built_in\">exit</span></span><br><span class=\"line\"><span class=\"built_in\">exit</span></span><br><span class=\"line\">ubuntu@k8s-node-1:~$ curl -XPOST http://10.75.59.81:30719/v1/request-landing</span><br><span class=\"line\">Ship landed</span><br><span class=\"line\">root@k8s-node-1:~# kubectl get nodes -o wide</span><br><span class=\"line\">NAME         STATUS   ROLES           AGE   VERSION   INTERNAL-IP   EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION     CONTAINER-RUNTIME</span><br><span class=\"line\">k8s-node-1   Ready    control-plane   21m   v1.33.3   10.75.59.81   &lt;none&gt;        Ubuntu 24.04.2 LTS   6.8.0-63-generic   containerd://1.7.27</span><br><span class=\"line\">k8s-node-2   Ready    &lt;none&gt;          19m   v1.33.3   10.75.59.82   &lt;none&gt;        Ubuntu 24.04.2 LTS   6.8.0-63-generic   containerd://1.7.27</span><br><span class=\"line\">k8s-node-3   Ready    &lt;none&gt;          19m   v1.33.3   10.75.59.83   &lt;none&gt;        Ubuntu 24.04.2 LTS   6.8.0-63-generic   containerd://1.7.27</span><br><span class=\"line\">root@k8s-node-1:~# kubectl get pods -A -o wide</span><br><span class=\"line\">NAMESPACE     NAME                                 READY   STATUS    RESTARTS   AGE   IP             NODE         NOMINATED NODE   READINESS GATES</span><br><span class=\"line\">kube-system   cilium-45qr7                         1/1     Running   0          19m   10.75.59.83    k8s-node-3   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">kube-system   cilium-9q5s7                         1/1     Running   0          19m   10.75.59.82    k8s-node-2   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">kube-system   cilium-envoy-72jj7                   1/1     Running   0          19m   10.75.59.82    k8s-node-2   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">kube-system   cilium-envoy-d8hb4                   1/1     Running   0          20m   10.75.59.81    k8s-node-1   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">kube-system   cilium-envoy-vvsms                   1/1     Running   0          19m   10.75.59.83    k8s-node-3   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">kube-system   cilium-operator-d67c55dc8-lfpjb      1/1     Running   0          20m   10.75.59.81    k8s-node-1   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">kube-system   cilium-operator-d67c55dc8-rpfv8      1/1     Running   0          20m   10.75.59.82    k8s-node-2   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">kube-system   cilium-xbjqm                         1/1     Running   0          20m   10.75.59.81    k8s-node-1   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">kube-system   coredns-674b8bbfcf-n9wgt             1/1     Running   0          21m   172.16.0.105   k8s-node-1   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">kube-system   coredns-674b8bbfcf-ntssg             1/1     Running   0          21m   172.16.0.161   k8s-node-1   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">kube-system   etcd-k8s-node-1                      1/1     Running   0          21m   10.75.59.81    k8s-node-1   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">kube-system   hubble-relay-cfb755899-46pzc         1/1     Running   0          20m   172.16.1.115   k8s-node-2   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">kube-system   hubble-ui-68c64498c4-p2nq4           2/2     Running   0          20m   172.16.1.105   k8s-node-2   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">kube-system   kube-apiserver-k8s-node-1            1/1     Running   0          21m   10.75.59.81    k8s-node-1   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">kube-system   kube-controller-manager-k8s-node-1   1/1     Running   0          21m   10.75.59.81    k8s-node-1   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">kube-system   kube-scheduler-k8s-node-1            1/1     Running   0          21m   10.75.59.81    k8s-node-1   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">star-wars     deathstar-86f85ffb4d-8xbb4           1/1     Running   0          12m   172.16.2.92    k8s-node-3   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">star-wars     deathstar-86f85ffb4d-dwfx5           1/1     Running   0          12m   172.16.1.198   k8s-node-2   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">star-wars     tiefighter                           1/1     Running   0          12m   172.16.2.180   k8s-node-3   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">star-wars     xwing                                1/1     Running   0          12m   172.16.2.156   k8s-node-3   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">root@k8s-node-1:~# kubectl get deployment -A -o wide</span><br><span class=\"line\">NAMESPACE     NAME              READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS         IMAGES                                                                                                                                                                                                                                        SELECTOR</span><br><span class=\"line\">kube-system   cilium-operator   2/2     2            2           21m   cilium-operator    quay.io/isovalent/operator-generic:v1.17.6-cee.1@sha256:2e602710a7c4f101831df679e5d8251bae8bf0f9fe26c20bbef87f1966ea8265                                                                                                                      io.cilium/app=operator,name=cilium-operator</span><br><span class=\"line\">kube-system   coredns           2/2     2            2           22m   coredns            registry.k8s.io/coredns/coredns:v1.12.0                                                                                                                                                                                                       k8s-app=kube-dns</span><br><span class=\"line\">kube-system   hubble-relay      1/1     1            1           21m   hubble-relay       quay.io/isovalent/hubble-relay:v1.17.6-cee.1@sha256:d378e3607f7492374e65e2bd854cc0ec87480c63ba49a96dadcd75a6946b586e                                                                                                                          k8s-app=hubble-relay</span><br><span class=\"line\">kube-system   hubble-ui         1/1     1            1           21m   frontend,backend   quay.io/isovalent/hubble-ui:v1.17.6-cee.1@sha256:9e37c1296b802830834cc87342a9182ccbb71ffebb711971e849221bd9d59392,quay.io/isovalent/hubble-ui-backend:v1.17.6-cee.1@sha256:a034b7e98e6ea796ed26df8f4e71f83fc16465a19d166eff67a03b822c0bfa15   k8s-app=hubble-ui</span><br><span class=\"line\">star-wars     deathstar         2/2     2            2           12m   deathstar          quay.io/cilium/starwars@sha256:896dc536ec505778c03efedb73c3b7b83c8de11e74264c8c35291ff6d5fe8ada                                                                                                                                               class=deathstar,org=empire</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h1 id=\"11-系统信息探索\"><a href=\"#11-系统信息探索\" class=\"headerlink\" title=\"11. 系统信息探索\"></a>11. 系统信息探索</h1><h2 id=\"11-1-K8S-和-Cilium相关信息\"><a href=\"#11-1-K8S-和-Cilium相关信息\" class=\"headerlink\" title=\"11.1 K8S 和 Cilium相关信息\"></a>11.1 K8S 和 Cilium相关信息</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br><span class=\"line\">252</span><br><span class=\"line\">253</span><br><span class=\"line\">254</span><br><span class=\"line\">255</span><br><span class=\"line\">256</span><br><span class=\"line\">257</span><br><span class=\"line\">258</span><br><span class=\"line\">259</span><br><span class=\"line\">260</span><br><span class=\"line\">261</span><br><span class=\"line\">262</span><br><span class=\"line\">263</span><br><span class=\"line\">264</span><br><span class=\"line\">265</span><br><span class=\"line\">266</span><br><span class=\"line\">267</span><br><span class=\"line\">268</span><br><span class=\"line\">269</span><br><span class=\"line\">270</span><br><span class=\"line\">271</span><br><span class=\"line\">272</span><br><span class=\"line\">273</span><br><span class=\"line\">274</span><br><span class=\"line\">275</span><br><span class=\"line\">276</span><br><span class=\"line\">277</span><br><span class=\"line\">278</span><br><span class=\"line\">279</span><br><span class=\"line\">280</span><br><span class=\"line\">281</span><br><span class=\"line\">282</span><br><span class=\"line\">283</span><br><span class=\"line\">284</span><br><span class=\"line\">285</span><br><span class=\"line\">286</span><br><span class=\"line\">287</span><br><span class=\"line\">288</span><br><span class=\"line\">289</span><br><span class=\"line\">290</span><br><span class=\"line\">291</span><br><span class=\"line\">292</span><br><span class=\"line\">293</span><br><span class=\"line\">294</span><br><span class=\"line\">295</span><br><span class=\"line\">296</span><br><span class=\"line\">297</span><br><span class=\"line\">298</span><br><span class=\"line\">299</span><br><span class=\"line\">300</span><br><span class=\"line\">301</span><br><span class=\"line\">302</span><br><span class=\"line\">303</span><br><span class=\"line\">304</span><br><span class=\"line\">305</span><br><span class=\"line\">306</span><br><span class=\"line\">307</span><br><span class=\"line\">308</span><br><span class=\"line\">309</span><br><span class=\"line\">310</span><br><span class=\"line\">311</span><br><span class=\"line\">312</span><br><span class=\"line\">313</span><br><span class=\"line\">314</span><br><span class=\"line\">315</span><br><span class=\"line\">316</span><br><span class=\"line\">317</span><br><span class=\"line\">318</span><br><span class=\"line\">319</span><br><span class=\"line\">320</span><br><span class=\"line\">321</span><br><span class=\"line\">322</span><br><span class=\"line\">323</span><br><span class=\"line\">324</span><br><span class=\"line\">325</span><br><span class=\"line\">326</span><br><span class=\"line\">327</span><br><span class=\"line\">328</span><br><span class=\"line\">329</span><br><span class=\"line\">330</span><br><span class=\"line\">331</span><br><span class=\"line\">332</span><br><span class=\"line\">333</span><br><span class=\"line\">334</span><br><span class=\"line\">335</span><br><span class=\"line\">336</span><br><span class=\"line\">337</span><br><span class=\"line\">338</span><br><span class=\"line\">339</span><br><span class=\"line\">340</span><br><span class=\"line\">341</span><br><span class=\"line\">342</span><br><span class=\"line\">343</span><br><span class=\"line\">344</span><br><span class=\"line\">345</span><br><span class=\"line\">346</span><br><span class=\"line\">347</span><br><span class=\"line\">348</span><br><span class=\"line\">349</span><br><span class=\"line\">350</span><br><span class=\"line\">351</span><br><span class=\"line\">352</span><br><span class=\"line\">353</span><br><span class=\"line\">354</span><br><span class=\"line\">355</span><br><span class=\"line\">356</span><br><span class=\"line\">357</span><br><span class=\"line\">358</span><br><span class=\"line\">359</span><br><span class=\"line\">360</span><br><span class=\"line\">361</span><br><span class=\"line\">362</span><br><span class=\"line\">363</span><br><span class=\"line\">364</span><br><span class=\"line\">365</span><br><span class=\"line\">366</span><br><span class=\"line\">367</span><br><span class=\"line\">368</span><br><span class=\"line\">369</span><br><span class=\"line\">370</span><br><span class=\"line\">371</span><br><span class=\"line\">372</span><br><span class=\"line\">373</span><br><span class=\"line\">374</span><br><span class=\"line\">375</span><br><span class=\"line\">376</span><br><span class=\"line\">377</span><br><span class=\"line\">378</span><br><span class=\"line\">379</span><br><span class=\"line\">380</span><br><span class=\"line\">381</span><br><span class=\"line\">382</span><br><span class=\"line\">383</span><br><span class=\"line\">384</span><br><span class=\"line\">385</span><br><span class=\"line\">386</span><br><span class=\"line\">387</span><br><span class=\"line\">388</span><br><span class=\"line\">389</span><br><span class=\"line\">390</span><br><span class=\"line\">391</span><br><span class=\"line\">392</span><br><span class=\"line\">393</span><br><span class=\"line\">394</span><br><span class=\"line\">395</span><br><span class=\"line\">396</span><br><span class=\"line\">397</span><br><span class=\"line\">398</span><br><span class=\"line\">399</span><br><span class=\"line\">400</span><br><span class=\"line\">401</span><br><span class=\"line\">402</span><br><span class=\"line\">403</span><br><span class=\"line\">404</span><br><span class=\"line\">405</span><br><span class=\"line\">406</span><br><span class=\"line\">407</span><br><span class=\"line\">408</span><br><span class=\"line\">409</span><br><span class=\"line\">410</span><br><span class=\"line\">411</span><br><span class=\"line\">412</span><br><span class=\"line\">413</span><br><span class=\"line\">414</span><br><span class=\"line\">415</span><br><span class=\"line\">416</span><br><span class=\"line\">417</span><br><span class=\"line\">418</span><br><span class=\"line\">419</span><br><span class=\"line\">420</span><br><span class=\"line\">421</span><br><span class=\"line\">422</span><br><span class=\"line\">423</span><br><span class=\"line\">424</span><br><span class=\"line\">425</span><br><span class=\"line\">426</span><br><span class=\"line\">427</span><br><span class=\"line\">428</span><br><span class=\"line\">429</span><br><span class=\"line\">430</span><br><span class=\"line\">431</span><br><span class=\"line\">432</span><br><span class=\"line\">433</span><br><span class=\"line\">434</span><br><span class=\"line\">435</span><br><span class=\"line\">436</span><br><span class=\"line\">437</span><br><span class=\"line\">438</span><br><span class=\"line\">439</span><br><span class=\"line\">440</span><br><span class=\"line\">441</span><br><span class=\"line\">442</span><br><span class=\"line\">443</span><br><span class=\"line\">444</span><br><span class=\"line\">445</span><br><span class=\"line\">446</span><br><span class=\"line\">447</span><br><span class=\"line\">448</span><br><span class=\"line\">449</span><br><span class=\"line\">450</span><br><span class=\"line\">451</span><br><span class=\"line\">452</span><br><span class=\"line\">453</span><br><span class=\"line\">454</span><br><span class=\"line\">455</span><br><span class=\"line\">456</span><br><span class=\"line\">457</span><br><span class=\"line\">458</span><br><span class=\"line\">459</span><br><span class=\"line\">460</span><br><span class=\"line\">461</span><br><span class=\"line\">462</span><br><span class=\"line\">463</span><br><span class=\"line\">464</span><br><span class=\"line\">465</span><br><span class=\"line\">466</span><br><span class=\"line\">467</span><br><span class=\"line\">468</span><br><span class=\"line\">469</span><br><span class=\"line\">470</span><br><span class=\"line\">471</span><br><span class=\"line\">472</span><br><span class=\"line\">473</span><br><span class=\"line\">474</span><br><span class=\"line\">475</span><br><span class=\"line\">476</span><br><span class=\"line\">477</span><br><span class=\"line\">478</span><br><span class=\"line\">479</span><br><span class=\"line\">480</span><br><span class=\"line\">481</span><br><span class=\"line\">482</span><br><span class=\"line\">483</span><br><span class=\"line\">484</span><br><span class=\"line\">485</span><br><span class=\"line\">486</span><br><span class=\"line\">487</span><br><span class=\"line\">488</span><br><span class=\"line\">489</span><br><span class=\"line\">490</span><br><span class=\"line\">491</span><br><span class=\"line\">492</span><br><span class=\"line\">493</span><br><span class=\"line\">494</span><br><span class=\"line\">495</span><br><span class=\"line\">496</span><br><span class=\"line\">497</span><br><span class=\"line\">498</span><br><span class=\"line\">499</span><br><span class=\"line\">500</span><br><span class=\"line\">501</span><br><span class=\"line\">502</span><br><span class=\"line\">503</span><br><span class=\"line\">504</span><br><span class=\"line\">505</span><br><span class=\"line\">506</span><br><span class=\"line\">507</span><br><span class=\"line\">508</span><br><span class=\"line\">509</span><br><span class=\"line\">510</span><br><span class=\"line\">511</span><br><span class=\"line\">512</span><br><span class=\"line\">513</span><br><span class=\"line\">514</span><br><span class=\"line\">515</span><br><span class=\"line\">516</span><br><span class=\"line\">517</span><br><span class=\"line\">518</span><br><span class=\"line\">519</span><br><span class=\"line\">520</span><br><span class=\"line\">521</span><br><span class=\"line\">522</span><br><span class=\"line\">523</span><br><span class=\"line\">524</span><br><span class=\"line\">525</span><br><span class=\"line\">526</span><br><span class=\"line\">527</span><br><span class=\"line\">528</span><br><span class=\"line\">529</span><br><span class=\"line\">530</span><br><span class=\"line\">531</span><br><span class=\"line\">532</span><br><span class=\"line\">533</span><br><span class=\"line\">534</span><br><span class=\"line\">535</span><br><span class=\"line\">536</span><br><span class=\"line\">537</span><br><span class=\"line\">538</span><br><span class=\"line\">539</span><br><span class=\"line\">540</span><br><span class=\"line\">541</span><br><span class=\"line\">542</span><br><span class=\"line\">543</span><br><span class=\"line\">544</span><br><span class=\"line\">545</span><br><span class=\"line\">546</span><br><span class=\"line\">547</span><br><span class=\"line\">548</span><br><span class=\"line\">549</span><br><span class=\"line\">550</span><br><span class=\"line\">551</span><br><span class=\"line\">552</span><br><span class=\"line\">553</span><br><span class=\"line\">554</span><br><span class=\"line\">555</span><br><span class=\"line\">556</span><br><span class=\"line\">557</span><br><span class=\"line\">558</span><br><span class=\"line\">559</span><br><span class=\"line\">560</span><br><span class=\"line\">561</span><br><span class=\"line\">562</span><br><span class=\"line\">563</span><br><span class=\"line\">564</span><br><span class=\"line\">565</span><br><span class=\"line\">566</span><br><span class=\"line\">567</span><br><span class=\"line\">568</span><br><span class=\"line\">569</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@k8s-node-1:~# helm get values cilium -n kube-system</span><br><span class=\"line\">USER-SUPPLIED VALUES:</span><br><span class=\"line\">autoDirectNodeRoutes: <span class=\"literal\">true</span></span><br><span class=\"line\">bgpControlPlane:</span><br><span class=\"line\">  announce:</span><br><span class=\"line\">    podCIDR: <span class=\"literal\">true</span></span><br><span class=\"line\">  enabled: <span class=\"literal\">true</span></span><br><span class=\"line\">bpf:</span><br><span class=\"line\">  lb:</span><br><span class=\"line\">    externalClusterIP: <span class=\"literal\">true</span></span><br><span class=\"line\">    sock: <span class=\"literal\">true</span></span><br><span class=\"line\">  masquerade: <span class=\"literal\">true</span></span><br><span class=\"line\">enableIPv4Masquerade: <span class=\"literal\">true</span></span><br><span class=\"line\">hubble:</span><br><span class=\"line\">  enabled: <span class=\"literal\">true</span></span><br><span class=\"line\">  relay:</span><br><span class=\"line\">    enabled: <span class=\"literal\">true</span></span><br><span class=\"line\">  ui:</span><br><span class=\"line\">    enabled: <span class=\"literal\">true</span></span><br><span class=\"line\">ipam:</span><br><span class=\"line\">  mode: kubernetes</span><br><span class=\"line\">ipv4NativeRoutingCIDR: 172.16.0.0/20</span><br><span class=\"line\">k8s:</span><br><span class=\"line\">  requireIPv4PodCIDR: <span class=\"literal\">true</span></span><br><span class=\"line\">k8sServiceHost: 10.75.59.81</span><br><span class=\"line\">k8sServicePort: 6443</span><br><span class=\"line\">kubeProxyReplacement: <span class=\"literal\">true</span></span><br><span class=\"line\">routingMode: native</span><br><span class=\"line\">root@k8s-node-1:~# </span><br><span class=\"line\">root@k8s-node-1:~# kubectl -n kube-system get configmap cilium-config -o yaml</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">data:</span><br><span class=\"line\">  agent-not-ready-taint-key: node.cilium.io/agent-not-ready</span><br><span class=\"line\">  arping-refresh-period: 30s</span><br><span class=\"line\">  auto-direct-node-routes: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  bgp-secrets-namespace: kube-system</span><br><span class=\"line\">  bpf-distributed-lru: <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">  bpf-events-drop-enabled: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  bpf-events-policy-verdict-enabled: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  bpf-events-trace-enabled: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  bpf-lb-acceleration: disabled</span><br><span class=\"line\">  bpf-lb-algorithm-annotation: <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">  bpf-lb-external-clusterip: <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">  bpf-lb-map-max: <span class=\"string\">&quot;65536&quot;</span></span><br><span class=\"line\">  bpf-lb-mode-annotation: <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">  bpf-lb-sock: <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">  bpf-lb-source-range-all-types: <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">  bpf-map-dynamic-size-ratio: <span class=\"string\">&quot;0.0025&quot;</span></span><br><span class=\"line\">  bpf-policy-map-max: <span class=\"string\">&quot;16384&quot;</span></span><br><span class=\"line\">  bpf-root: /sys/fs/bpf</span><br><span class=\"line\">  cgroup-root: /run/cilium/cgroupv2</span><br><span class=\"line\">  cilium-endpoint-gc-interval: 5m0s</span><br><span class=\"line\">  cluster-id: <span class=\"string\">&quot;0&quot;</span></span><br><span class=\"line\">  cluster-name: default</span><br><span class=\"line\">  clustermesh-enable-endpoint-sync: <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">  clustermesh-enable-mcs-api: <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">  cni-exclusive: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  cni-log-file: /var/run/cilium/cilium-cni.log</span><br><span class=\"line\">  custom-cni-conf: <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">  datapath-mode: veth</span><br><span class=\"line\">  debug: <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">  debug-verbose: <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">  default-lb-service-ipam: lbipam</span><br><span class=\"line\">  direct-routing-skip-unreachable: <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">  dnsproxy-enable-transparent-mode: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  dnsproxy-socket-linger-timeout: <span class=\"string\">&quot;10&quot;</span></span><br><span class=\"line\">  egress-gateway-ha-reconciliation-trigger-interval: 1s</span><br><span class=\"line\">  egress-gateway-reconciliation-trigger-interval: 1s</span><br><span class=\"line\">  enable-auto-protect-node-port-range: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  enable-bfd: <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">  enable-bgp-control-plane: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  enable-bgp-control-plane-status-report: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  enable-bpf-clock-probe: <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">  enable-bpf-masquerade: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  enable-cluster-aware-addressing: <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">  enable-egress-gateway-ha-socket-termination: <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">  enable-endpoint-health-checking: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  enable-endpoint-lockdown-on-policy-overflow: <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">  enable-experimental-lb: <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">  enable-health-check-loadbalancer-ip: <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">  enable-health-check-nodeport: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  enable-health-checking: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  enable-hubble: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  enable-inter-cluster-snat: <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">  enable-internal-traffic-policy: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  enable-ipv4: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  enable-ipv4-big-tcp: <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">  enable-ipv4-masquerade: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  enable-ipv6: <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">  enable-ipv6-big-tcp: <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">  enable-ipv6-masquerade: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  enable-k8s-networkpolicy: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  enable-k8s-terminating-endpoint: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  enable-l2-neigh-discovery: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  enable-l7-proxy: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  enable-lb-ipam: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  enable-local-redirect-policy: <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">  enable-masquerade-to-route-source: <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">  enable-metrics: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  enable-node-selector-labels: <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">  enable-non-default-deny-policies: <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">  enable-phantom-services: <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">  enable-policy: default</span><br><span class=\"line\">  enable-policy-secrets-sync: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  enable-runtime-device-detection: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  enable-sctp: <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">  enable-source-ip-verification: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  enable-srv6: <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">  enable-svc-source-range-check: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  enable-tcx: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  enable-vtep: <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">  enable-well-known-identities: <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">  enable-xt-socket-fallback: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  envoy-access-log-buffer-size: <span class=\"string\">&quot;4096&quot;</span></span><br><span class=\"line\">  envoy-base-id: <span class=\"string\">&quot;0&quot;</span></span><br><span class=\"line\">  envoy-keep-cap-netbindservice: <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">  export-aggregation: <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">  export-aggregation-renew-ttl: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  export-aggregation-state-filter: <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">  export-file-path: <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">  external-envoy-proxy: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  feature-gates-approved: <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">  feature-gates-strict: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  health-check-icmp-failure-threshold: <span class=\"string\">&quot;3&quot;</span></span><br><span class=\"line\">  http-retry-count: <span class=\"string\">&quot;3&quot;</span></span><br><span class=\"line\">  hubble-disable-tls: <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">  hubble-export-file-max-backups: <span class=\"string\">&quot;5&quot;</span></span><br><span class=\"line\">  hubble-export-file-max-size-mb: <span class=\"string\">&quot;10&quot;</span></span><br><span class=\"line\">  hubble-listen-address: :4244</span><br><span class=\"line\">  hubble-socket-path: /var/run/cilium/hubble.sock</span><br><span class=\"line\">  hubble-tls-cert-file: /var/lib/cilium/tls/hubble/server.crt</span><br><span class=\"line\">  hubble-tls-client-ca-files: /var/lib/cilium/tls/hubble/client-ca.crt</span><br><span class=\"line\">  hubble-tls-key-file: /var/lib/cilium/tls/hubble/server.key</span><br><span class=\"line\">  identity-allocation-mode: crd</span><br><span class=\"line\">  identity-gc-interval: 15m0s</span><br><span class=\"line\">  identity-heartbeat-timeout: 30m0s</span><br><span class=\"line\">  install-no-conntrack-iptables-rules: <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">  ipam: kubernetes</span><br><span class=\"line\">  ipam-cilium-node-update-rate: 15s</span><br><span class=\"line\">  iptables-random-fully: <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">  ipv4-native-routing-cidr: 172.16.0.0/20</span><br><span class=\"line\">  k8s-require-ipv4-pod-cidr: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  k8s-require-ipv6-pod-cidr: <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">  kube-proxy-replacement: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  kube-proxy-replacement-healthz-bind-address: <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">  max-connected-clusters: <span class=\"string\">&quot;255&quot;</span></span><br><span class=\"line\">  mesh-auth-enabled: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  mesh-auth-gc-interval: 5m0s</span><br><span class=\"line\">  mesh-auth-queue-size: <span class=\"string\">&quot;1024&quot;</span></span><br><span class=\"line\">  mesh-auth-rotated-identities-queue-size: <span class=\"string\">&quot;1024&quot;</span></span><br><span class=\"line\">  monitor-aggregation: medium</span><br><span class=\"line\">  monitor-aggregation-flags: all</span><br><span class=\"line\">  monitor-aggregation-interval: 5s</span><br><span class=\"line\">  multicast-enabled: <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">  nat-map-stats-entries: <span class=\"string\">&quot;32&quot;</span></span><br><span class=\"line\">  nat-map-stats-interval: 30s</span><br><span class=\"line\">  node-port-bind-protection: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  nodeport-addresses: <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">  nodes-gc-interval: 5m0s</span><br><span class=\"line\">  operator-api-serve-addr: 127.0.0.1:9234</span><br><span class=\"line\">  operator-prometheus-serve-addr: :9963</span><br><span class=\"line\">  policy-cidr-match-mode: <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">  policy-secrets-namespace: cilium-secrets</span><br><span class=\"line\">  policy-secrets-only-from-secrets-namespace: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  preallocate-bpf-maps: <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">  procfs: /host/proc</span><br><span class=\"line\">  proxy-connect-timeout: <span class=\"string\">&quot;2&quot;</span></span><br><span class=\"line\">  proxy-idle-timeout-seconds: <span class=\"string\">&quot;60&quot;</span></span><br><span class=\"line\">  proxy-initial-fetch-timeout: <span class=\"string\">&quot;30&quot;</span></span><br><span class=\"line\">  proxy-max-concurrent-retries: <span class=\"string\">&quot;128&quot;</span></span><br><span class=\"line\">  proxy-max-connection-duration-seconds: <span class=\"string\">&quot;0&quot;</span></span><br><span class=\"line\">  proxy-max-requests-per-connection: <span class=\"string\">&quot;0&quot;</span></span><br><span class=\"line\">  proxy-xff-num-trusted-hops-egress: <span class=\"string\">&quot;0&quot;</span></span><br><span class=\"line\">  proxy-xff-num-trusted-hops-ingress: <span class=\"string\">&quot;0&quot;</span></span><br><span class=\"line\">  remove-cilium-node-taints: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  routing-mode: native</span><br><span class=\"line\">  service-no-backend-response: reject</span><br><span class=\"line\">  set-cilium-is-up-condition: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  set-cilium-node-taints: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  srv6-encap-mode: reduced</span><br><span class=\"line\">  srv6-locator-pool-enabled: <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">  synchronize-k8s-nodes: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  tofqdns-dns-reject-response-code: refused</span><br><span class=\"line\">  tofqdns-enable-dns-compression: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  tofqdns-endpoint-max-ip-per-hostname: <span class=\"string\">&quot;1000&quot;</span></span><br><span class=\"line\">  tofqdns-idle-connection-grace-period: 0s</span><br><span class=\"line\">  tofqdns-max-deferred-connection-deletes: <span class=\"string\">&quot;10000&quot;</span></span><br><span class=\"line\">  tofqdns-proxy-response-max-delay: 100ms</span><br><span class=\"line\">  tunnel-protocol: vxlan</span><br><span class=\"line\">  tunnel-source-port-range: 0-0</span><br><span class=\"line\">  unmanaged-pod-watcher-interval: <span class=\"string\">&quot;15&quot;</span></span><br><span class=\"line\">  vtep-cidr: <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">  vtep-endpoint: <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">  vtep-mac: <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">  vtep-mask: <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">  write-cni-conf-when-ready: /host/etc/cni/net.d/05-cilium.conflist</span><br><span class=\"line\">kind: ConfigMap</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  annotations:</span><br><span class=\"line\">    meta.helm.sh/release-name: cilium</span><br><span class=\"line\">    meta.helm.sh/release-namespace: kube-system</span><br><span class=\"line\">  creationTimestamp: <span class=\"string\">&quot;2025-08-04T08:52:46Z&quot;</span></span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app.kubernetes.io/managed-by: Helm</span><br><span class=\"line\">  name: cilium-config</span><br><span class=\"line\">  namespace: kube-system</span><br><span class=\"line\">  resourceVersion: <span class=\"string\">&quot;436&quot;</span></span><br><span class=\"line\">  uid: 614c6b36-9112-4fd0-bebf-e92741fa28da</span><br><span class=\"line\">root@k8s-node-1:~# kubectl <span class=\"built_in\">exec</span> -n kube-system -it cilium-45qr7 -- /bin/sh</span><br><span class=\"line\">Defaulted container <span class=\"string\">&quot;cilium-agent&quot;</span> out of: cilium-agent, config (init), mount-cgroup (init), apply-sysctl-overwrites (init), mount-bpf-fs (init), clean-cilium-state (init), install-cni-binaries (init)</span><br><span class=\"line\">/home/cilium <span class=\"comment\"># cilium status</span></span><br><span class=\"line\">KVStore:                 Disabled   </span><br><span class=\"line\">Kubernetes:              Ok         1.33 (v1.33.3) [linux/amd64]</span><br><span class=\"line\">Kubernetes APIs:         [<span class=\"string\">&quot;EndpointSliceOrEndpoint&quot;</span>, <span class=\"string\">&quot;cilium/v2::CiliumClusterwideNetworkPolicy&quot;</span>, <span class=\"string\">&quot;cilium/v2::CiliumEndpoint&quot;</span>, <span class=\"string\">&quot;cilium/v2::CiliumNetworkPolicy&quot;</span>, <span class=\"string\">&quot;cilium/v2::CiliumNode&quot;</span>, <span class=\"string\">&quot;cilium/v2alpha1::CiliumCIDRGroup&quot;</span>, <span class=\"string\">&quot;core/v1::Namespace&quot;</span>, <span class=\"string\">&quot;core/v1::Pods&quot;</span>, <span class=\"string\">&quot;core/v1::Service&quot;</span>, <span class=\"string\">&quot;isovalent/v1alpha1::IsovalentClusterwideNetworkPolicy&quot;</span>, <span class=\"string\">&quot;isovalent/v1alpha1::IsovalentNetworkPolicy&quot;</span>, <span class=\"string\">&quot;networking.k8s.io/v1::NetworkPolicy&quot;</span>]</span><br><span class=\"line\">KubeProxyReplacement:    True   [enp1s0   10.75.59.83 fe80::5054:ff:fead:b814 (Direct Routing)]</span><br><span class=\"line\">Host firewall:           Disabled</span><br><span class=\"line\">SRv6:                    Disabled</span><br><span class=\"line\">CNI Chaining:            none</span><br><span class=\"line\">CNI Config file:         successfully wrote CNI configuration file to /host/etc/cni/net.d/05-cilium.conflist</span><br><span class=\"line\">Cilium:                  Ok   1.17.6-cee.1 (v1.17.6-cee.1-a33b0b85)</span><br><span class=\"line\">NodeMonitor:             Listening <span class=\"keyword\">for</span> events on 4 CPUs with 64x4096 of shared memory</span><br><span class=\"line\">Cilium health daemon:    Ok   </span><br><span class=\"line\">IPAM:                    IPv4: 5/254 allocated from 172.16.2.0/24, </span><br><span class=\"line\">IPv4 BIG TCP:            Disabled</span><br><span class=\"line\">IPv6 BIG TCP:            Disabled</span><br><span class=\"line\">BandwidthManager:        Disabled</span><br><span class=\"line\">Routing:                 Network: Native   Host: BPF</span><br><span class=\"line\">Attach Mode:             TCX</span><br><span class=\"line\">Device Mode:             veth</span><br><span class=\"line\">Masquerading:            BPF   [enp1s0]   172.16.0.0/20 [IPv4: Enabled, IPv6: Disabled]</span><br><span class=\"line\">Controller Status:       36/36 healthy</span><br><span class=\"line\">Proxy Status:            OK, ip 172.16.2.88, 0 redirects active on ports 10000-20000, Envoy: external</span><br><span class=\"line\">Global Identity Range:   min 256, max 65535</span><br><span class=\"line\">Hubble:                  Ok              Current/Max Flows: 2522/4095 (61.59%), Flows/s: 1.51   Metrics: Disabled</span><br><span class=\"line\">Encryption:              Disabled        </span><br><span class=\"line\">Cluster health:          3/3 reachable   (2025-08-04T09:21:04Z)</span><br><span class=\"line\">Name                     IP              Node   Endpoints</span><br><span class=\"line\">Modules Health:          Stopped(0) Degraded(0) OK(68)</span><br><span class=\"line\">/home/cilium <span class=\"comment\"># cilium status --verbose</span></span><br><span class=\"line\">KVStore:                Disabled   </span><br><span class=\"line\">Kubernetes:             Ok         1.33 (v1.33.3) [linux/amd64]</span><br><span class=\"line\">Kubernetes APIs:        [<span class=\"string\">&quot;EndpointSliceOrEndpoint&quot;</span>, <span class=\"string\">&quot;cilium/v2::CiliumClusterwideNetworkPolicy&quot;</span>, <span class=\"string\">&quot;cilium/v2::CiliumEndpoint&quot;</span>, <span class=\"string\">&quot;cilium/v2::CiliumNetworkPolicy&quot;</span>, <span class=\"string\">&quot;cilium/v2::CiliumNode&quot;</span>, <span class=\"string\">&quot;cilium/v2alpha1::CiliumCIDRGroup&quot;</span>, <span class=\"string\">&quot;core/v1::Namespace&quot;</span>, <span class=\"string\">&quot;core/v1::Pods&quot;</span>, <span class=\"string\">&quot;core/v1::Service&quot;</span>, <span class=\"string\">&quot;isovalent/v1alpha1::IsovalentClusterwideNetworkPolicy&quot;</span>, <span class=\"string\">&quot;isovalent/v1alpha1::IsovalentNetworkPolicy&quot;</span>, <span class=\"string\">&quot;networking.k8s.io/v1::NetworkPolicy&quot;</span>]</span><br><span class=\"line\">KubeProxyReplacement:   True   [enp1s0   10.75.59.83 fe80::5054:ff:fead:b814 (Direct Routing)]</span><br><span class=\"line\">Host firewall:          Disabled</span><br><span class=\"line\">SRv6:                   Disabled</span><br><span class=\"line\">CNI Chaining:           none</span><br><span class=\"line\">CNI Config file:        successfully wrote CNI configuration file to /host/etc/cni/net.d/05-cilium.conflist</span><br><span class=\"line\">Cilium:                 Ok   1.17.6-cee.1 (v1.17.6-cee.1-a33b0b85)</span><br><span class=\"line\">NodeMonitor:            Listening <span class=\"keyword\">for</span> events on 4 CPUs with 64x4096 of shared memory</span><br><span class=\"line\">Cilium health daemon:   Ok   </span><br><span class=\"line\">IPAM:                   IPv4: 5/254 allocated from 172.16.2.0/24, </span><br><span class=\"line\">Allocated addresses:</span><br><span class=\"line\">  172.16.2.156 (star-wars/xwing)</span><br><span class=\"line\">  172.16.2.180 (star-wars/tiefighter)</span><br><span class=\"line\">  172.16.2.35 (health)</span><br><span class=\"line\">  172.16.2.88 (router)</span><br><span class=\"line\">  172.16.2.92 (star-wars/deathstar-86f85ffb4d-8xbb4)</span><br><span class=\"line\">IPv4 BIG TCP:           Disabled</span><br><span class=\"line\">IPv6 BIG TCP:           Disabled</span><br><span class=\"line\">BandwidthManager:       Disabled</span><br><span class=\"line\">Routing:                Network: Native   Host: BPF</span><br><span class=\"line\">Attach Mode:            TCX</span><br><span class=\"line\">Device Mode:            veth</span><br><span class=\"line\">Masquerading:           BPF   [enp1s0]   172.16.0.0/20 [IPv4: Enabled, IPv6: Disabled]</span><br><span class=\"line\">Clock Source <span class=\"keyword\">for</span> BPF:   ktime</span><br><span class=\"line\">Controller Status:      36/36 healthy</span><br><span class=\"line\">  Name                                                  Last success   Last error   Count   Message</span><br><span class=\"line\">  cilium-health-ep                                      1m0s ago       never        0       no error   </span><br><span class=\"line\">  ct-map-pressure                                       1s ago         never        0       no error   </span><br><span class=\"line\">  daemon-validate-config                                35s ago        never        0       no error   </span><br><span class=\"line\">  dns-garbage-collector-job                             3s ago         never        0       no error   </span><br><span class=\"line\">  endpoint-1375-regeneration-recovery                   never          never        0       no error   </span><br><span class=\"line\">  endpoint-196-regeneration-recovery                    never          never        0       no error   </span><br><span class=\"line\">  endpoint-2338-regeneration-recovery                   never          never        0       no error   </span><br><span class=\"line\">  endpoint-523-regeneration-recovery                    never          never        0       no error   </span><br><span class=\"line\">  endpoint-640-regeneration-recovery                    never          never        0       no error   </span><br><span class=\"line\">  endpoint-gc                                           2m3s ago       never        0       no error   </span><br><span class=\"line\">  endpoint-periodic-regeneration                        1m3s ago       never        0       no error   </span><br><span class=\"line\">  ep-bpf-prog-watchdog                                  1s ago         never        0       no error   </span><br><span class=\"line\">  ipcache-inject-labels                                 1s ago         never        0       no error   </span><br><span class=\"line\">  k8s-heartbeat                                         3s ago         never        0       no error   </span><br><span class=\"line\">  link-cache                                            3s ago         never        0       no error   </span><br><span class=\"line\">  node-neighbor-link-updater                            1s ago         never        0       no error   </span><br><span class=\"line\">  proxy-ports-checkpoint                                27m1s ago      never        0       no error   </span><br><span class=\"line\">  resolve-identity-1375                                 2m0s ago       never        0       no error   </span><br><span class=\"line\">  resolve-identity-196                                  1m41s ago      never        0       no error   </span><br><span class=\"line\">  resolve-identity-2338                                 1m41s ago      never        0       no error   </span><br><span class=\"line\">  resolve-identity-523                                  2m1s ago       never        0       no error   </span><br><span class=\"line\">  resolve-identity-640                                  1m41s ago      never        0       no error   </span><br><span class=\"line\">  resolve-labels-star-wars/deathstar-86f85ffb4d-8xbb4   21m41s ago     never        0       no error   </span><br><span class=\"line\">  resolve-labels-star-wars/tiefighter                   21m41s ago     never        0       no error   </span><br><span class=\"line\">  resolve-labels-star-wars/xwing                        21m41s ago     never        0       no error   </span><br><span class=\"line\">  sync-lb-maps-with-k8s-services                        27m1s ago      never        0       no error   </span><br><span class=\"line\">  sync-policymap-1375                                   11m56s ago     never        0       no error   </span><br><span class=\"line\">  sync-policymap-196                                    6m41s ago      never        0       no error   </span><br><span class=\"line\">  sync-policymap-2338                                   6m41s ago      never        0       no error   </span><br><span class=\"line\">  sync-policymap-523                                    11m57s ago     never        0       no error   </span><br><span class=\"line\">  sync-policymap-640                                    6m41s ago      never        0       no error   </span><br><span class=\"line\">  sync-to-k8s-ciliumendpoint (196)                      1s ago         never        0       no error   </span><br><span class=\"line\">  sync-to-k8s-ciliumendpoint (2338)                     1s ago         never        0       no error   </span><br><span class=\"line\">  sync-to-k8s-ciliumendpoint (640)                      1s ago         never        0       no error   </span><br><span class=\"line\">  sync-utime                                            1s ago         never        0       no error   </span><br><span class=\"line\">  write-cni-file                                        27m3s ago      never        0       no error   </span><br><span class=\"line\">Proxy Status:            OK, ip 172.16.2.88, 0 redirects active on ports 10000-20000, Envoy: external</span><br><span class=\"line\">Global Identity Range:   min 256, max 65535</span><br><span class=\"line\">Hubble:                  Ok   Current/Max Flows: 2570/4095 (62.76%), Flows/s: 1.51   Metrics: Disabled</span><br><span class=\"line\">KubeProxyReplacement Details:</span><br><span class=\"line\">  Status:                 True</span><br><span class=\"line\">  Socket LB:              Enabled</span><br><span class=\"line\">  Socket LB Tracing:      Enabled</span><br><span class=\"line\">  Socket LB Coverage:     Full</span><br><span class=\"line\">  Devices:                enp1s0   10.75.59.83 fe80::5054:ff:fead:b814 (Direct Routing)</span><br><span class=\"line\">  Mode:                   SNAT</span><br><span class=\"line\">  Backend Selection:      Random</span><br><span class=\"line\">  Session Affinity:       Enabled</span><br><span class=\"line\">  Graceful Termination:   Enabled</span><br><span class=\"line\">  NAT46/64 Support:       Disabled</span><br><span class=\"line\">  XDP Acceleration:       Disabled</span><br><span class=\"line\">  Services:</span><br><span class=\"line\">  - ClusterIP:      Enabled</span><br><span class=\"line\">  - NodePort:       Enabled (Range: 30000-32767) </span><br><span class=\"line\">  - LoadBalancer:   Enabled </span><br><span class=\"line\">  - externalIPs:    Enabled </span><br><span class=\"line\">  - HostPort:       Enabled</span><br><span class=\"line\">  Annotations:</span><br><span class=\"line\">  - service.cilium.io/node</span><br><span class=\"line\">  - service.cilium.io/src-ranges-policy</span><br><span class=\"line\">  - service.cilium.io/type</span><br><span class=\"line\">BPF Maps:   dynamic sizing: on (ratio: 0.002500)</span><br><span class=\"line\">  Name                          Size</span><br><span class=\"line\">  Auth                          524288</span><br><span class=\"line\">  Non-TCP connection tracking   65536</span><br><span class=\"line\">  TCP connection tracking       131072</span><br><span class=\"line\">  Endpoint policy               65535</span><br><span class=\"line\">  IP cache                      512000</span><br><span class=\"line\">  IPv4 masquerading agent       16384</span><br><span class=\"line\">  IPv6 masquerading agent       16384</span><br><span class=\"line\">  IPv4 fragmentation            8192</span><br><span class=\"line\">  IPv4 service                  65536</span><br><span class=\"line\">  IPv6 service                  65536</span><br><span class=\"line\">  IPv4 service backend          65536</span><br><span class=\"line\">  IPv6 service backend          65536</span><br><span class=\"line\">  IPv4 service reverse NAT      65536</span><br><span class=\"line\">  IPv6 service reverse NAT      65536</span><br><span class=\"line\">  Metrics                       1024</span><br><span class=\"line\">  Ratelimit metrics             64</span><br><span class=\"line\">  NAT                           131072</span><br><span class=\"line\">  Neighbor table                131072</span><br><span class=\"line\">  Global policy                 16384</span><br><span class=\"line\">  Session affinity              65536</span><br><span class=\"line\">  Sock reverse NAT              65536</span><br><span class=\"line\">Encryption:       Disabled        </span><br><span class=\"line\">Cluster health:   3/3 reachable   (2025-08-04T09:21:04Z)</span><br><span class=\"line\">Name              IP              Node   Endpoints</span><br><span class=\"line\">  k8s-node-3 (localhost):</span><br><span class=\"line\">    Host connectivity to 10.75.59.83:</span><br><span class=\"line\">      ICMP to stack:   OK, RTT=451.197µs</span><br><span class=\"line\">      HTTP to agent:   OK, RTT=625.346µs</span><br><span class=\"line\">    Endpoint connectivity to 172.16.2.35:</span><br><span class=\"line\">      ICMP to stack:   OK, RTT=376.939µs</span><br><span class=\"line\">      HTTP to agent:   OK, RTT=882.754µs</span><br><span class=\"line\">  k8s-node-1:</span><br><span class=\"line\">    Host connectivity to 10.75.59.81:</span><br><span class=\"line\">      ICMP to stack:   OK, RTT=582.892µs</span><br><span class=\"line\">      HTTP to agent:   OK, RTT=1.042743ms</span><br><span class=\"line\">    Endpoint connectivity to 172.16.0.116:</span><br><span class=\"line\">      ICMP to stack:   OK, RTT=703.331µs</span><br><span class=\"line\">      HTTP to agent:   OK, RTT=1.533329ms</span><br><span class=\"line\">  k8s-node-2:</span><br><span class=\"line\">    Host connectivity to 10.75.59.82:</span><br><span class=\"line\">      ICMP to stack:   OK, RTT=632.658µs</span><br><span class=\"line\">      HTTP to agent:   OK, RTT=1.156736ms</span><br><span class=\"line\">    Endpoint connectivity to 172.16.1.173:</span><br><span class=\"line\">      ICMP to stack:   OK, RTT=636.518µs</span><br><span class=\"line\">      HTTP to agent:   OK, RTT=1.37198ms</span><br><span class=\"line\">Modules Health:</span><br><span class=\"line\">      enterprise-agent</span><br><span class=\"line\">      ├── agent</span><br><span class=\"line\">      │   ├── controlplane</span><br><span class=\"line\">      │   │   ├── auth</span><br><span class=\"line\">      │   │   │   ├── observer-job-auth-gc-identity-events            [OK] OK (1.812µs) [5] (21m, x1)</span><br><span class=\"line\">      │   │   │   ├── observer-job-auth-request-authentication        [OK] Primed (27m, x1)</span><br><span class=\"line\">      │   │   │   └── timer-job-auth-gc-cleanup                       [OK] OK (15.847µs) (2m3s, x1)</span><br><span class=\"line\">      │   │   ├── bgp-control-plane</span><br><span class=\"line\">      │   │   │   ├── job-bgp-controller                              [OK] Running (27m, x1)</span><br><span class=\"line\">      │   │   │   ├── job-bgp-crd-status-initialize                   [OK] Running (27m, x1)</span><br><span class=\"line\">      │   │   │   ├── job-bgp-crd-status-update-job                   [OK] Running (27m, x1)</span><br><span class=\"line\">      │   │   │   ├── job-bgp-policy-observer                         [OK] Running (27m, x1)</span><br><span class=\"line\">      │   │   │   ├── job-bgp-reconcile-error-statedb-tracker         [OK] Running (27m, x1)</span><br><span class=\"line\">      │   │   │   ├── job-bgp-state-observer                          [OK] Running (27m, x1)</span><br><span class=\"line\">      │   │   │   ├── job-bgpcp-resource-store-events                 [OK] Running (27m, x5)</span><br><span class=\"line\">      │   │   │   └── job-diffstore-events                            [OK] Running (27m, x2)</span><br><span class=\"line\">      │   │   ├── ciliumenvoyconfig</span><br><span class=\"line\">      │   │   │   └── experimental</span><br><span class=\"line\">      │   │   │       ├── job-reconcile                               [OK] OK, 0 object(s) (27m, x3)</span><br><span class=\"line\">      │   │   │       └── job-refresh                                 [OK] Next refresh <span class=\"keyword\">in</span> 30m0s (27m, x1)</span><br><span class=\"line\">      │   │   ├── daemon</span><br><span class=\"line\">      │   │   │   ├──                                                 [OK] daemon-validate-config (35s, x27)</span><br><span class=\"line\">      │   │   │   ├── ep-bpf-prog-watchdog</span><br><span class=\"line\">      │   │   │   │   └── ep-bpf-prog-watchdog                        [OK] ep-bpf-prog-watchdog (1s, x55)</span><br><span class=\"line\">      │   │   │   └── job-sync-hostips                                [OK] Synchronized (1s, x29)</span><br><span class=\"line\">      │   │   ├── dynamic-lifecycle-manager</span><br><span class=\"line\">      │   │   │   ├── job-reconcile                                   [OK] OK, 0 object(s) (27m, x3)</span><br><span class=\"line\">      │   │   │   └── job-refresh                                     [OK] Next refresh <span class=\"keyword\">in</span> 30m0s (27m, x1)</span><br><span class=\"line\">      │   │   ├── enabled-features</span><br><span class=\"line\">      │   │   │   └── job-update-config-metric                        [OK] Waiting <span class=\"keyword\">for</span> agent config (27m, x1)</span><br><span class=\"line\">      │   │   ├── endpoint-manager</span><br><span class=\"line\">      │   │   │   ├── cilium-endpoint-1375 (/)</span><br><span class=\"line\">      │   │   │   │   ├── datapath-regenerate                         [OK] Endpoint regeneration successful (63s, x15)</span><br><span class=\"line\">      │   │   │   │   └── policymap-sync                              [OK] sync-policymap-1375 (11m, x2)</span><br><span class=\"line\">      │   │   │   ├── cilium-endpoint-196 (star-wars/xwing)</span><br><span class=\"line\">      │   │   │   │   ├── cep-k8s-sync                                [OK] sync-to-k8s-ciliumendpoint (196) (1s, x132)</span><br><span class=\"line\">      │   │   │   │   ├── datapath-regenerate                         [OK] Endpoint regeneration successful (63s, x12)</span><br><span class=\"line\">      │   │   │   │   └── policymap-sync                              [OK] sync-policymap-196 (6m41s, x2)</span><br><span class=\"line\">      │   │   │   ├── cilium-endpoint-2338 (star-wars/tiefighter)</span><br><span class=\"line\">      │   │   │   │   ├── cep-k8s-sync                                [OK] sync-to-k8s-ciliumendpoint (2338) (1s, x132)</span><br><span class=\"line\">      │   │   │   │   ├── datapath-regenerate                         [OK] Endpoint regeneration successful (63s, x12)</span><br><span class=\"line\">      │   │   │   │   └── policymap-sync                              [OK] sync-policymap-2338 (6m41s, x2)</span><br><span class=\"line\">      │   │   │   ├── cilium-endpoint-523 (/)</span><br><span class=\"line\">      │   │   │   │   ├── datapath-regenerate                         [OK] Endpoint regeneration successful (63s, x16)</span><br><span class=\"line\">      │   │   │   │   └── policymap-sync                              [OK] sync-policymap-523 (11m, x2)</span><br><span class=\"line\">      │   │   │   ├── cilium-endpoint-640 (star-wars/deathstar-86f85ffb4d-8xbb4)</span><br><span class=\"line\">      │   │   │   │   ├── cep-k8s-sync                                [OK] sync-to-k8s-ciliumendpoint (640) (1s, x132)</span><br><span class=\"line\">      │   │   │   │   ├── datapath-regenerate                         [OK] Endpoint regeneration successful (63s, x12)</span><br><span class=\"line\">      │   │   │   │   └── policymap-sync                              [OK] sync-policymap-640 (6m41s, x2)</span><br><span class=\"line\">      │   │   │   └── endpoint-gc                                     [OK] endpoint-gc (2m3s, x6)</span><br><span class=\"line\">      │   │   ├── envoy-proxy</span><br><span class=\"line\">      │   │   │   ├── observer-job-k8s-secrets-resource-events-cilium-secrets    [OK] Primed (27m, x1)</span><br><span class=\"line\">      │   │   │   └── timer-job-version-check                         [OK] OK (13.805158ms) (2m1s, x1)</span><br><span class=\"line\">      │   │   ├── hubble</span><br><span class=\"line\">      │   │   │   └── job-hubble                                      [OK] Running (27m, x1)</span><br><span class=\"line\">      │   │   ├── identity</span><br><span class=\"line\">      │   │   │   └── timer-job-id-alloc-update-policy-maps           [OK] OK (103.031µs) (21m, x1)</span><br><span class=\"line\">      │   │   ├── l2-announcer</span><br><span class=\"line\">      │   │   │   └── job-l2-announcer-lease-gc                       [OK] Running (27m, x1)</span><br><span class=\"line\">      │   │   ├── nat-stats</span><br><span class=\"line\">      │   │   │   └── timer-job-nat-stats                             [OK] OK (2.520538ms) (1s, x1)</span><br><span class=\"line\">      │   │   ├── node-manager</span><br><span class=\"line\">      │   │   │   ├── background-sync                                 [OK] Node validation successful (66s, x19)</span><br><span class=\"line\">      │   │   │   ├── neighbor-link-updater</span><br><span class=\"line\">      │   │   │   │   ├── k8s-node-1                                  [OK] Node neighbor <span class=\"built_in\">link</span> update successful (61s, x20)</span><br><span class=\"line\">      │   │   │   │   └── k8s-node-2                                  [OK] Node neighbor <span class=\"built_in\">link</span> update successful (31s, x20)</span><br><span class=\"line\">      │   │   │   ├── node-checkpoint-writer                          [OK] node checkpoint written (25m, x3)</span><br><span class=\"line\">      │   │   │   └── nodes-add                                       [OK] Node adds successful (27m, x3)</span><br><span class=\"line\">      │   │   ├── policy</span><br><span class=\"line\">      │   │   │   └── observer-job-policy-importer                    [OK] Primed (27m, x1)</span><br><span class=\"line\">      │   │   ├── service-manager</span><br><span class=\"line\">      │   │   │   ├── job-health-check-event-watcher                  [OK] Waiting <span class=\"keyword\">for</span> health check events (27m, x1)</span><br><span class=\"line\">      │   │   │   └── job-service-reconciler                          [OK] 1 NodePort frontend addresses (27m, x1)</span><br><span class=\"line\">      │   │   ├── service-resolver</span><br><span class=\"line\">      │   │   │   └── job-service-reloader-initializer                [OK] Running (27m, x1)</span><br><span class=\"line\">      │   │   └── stale-endpoint-cleanup</span><br><span class=\"line\">      │   │       └── job-endpoint-cleanup                            [OK] Running (27m, x1)</span><br><span class=\"line\">      │   ├── datapath</span><br><span class=\"line\">      │   │   ├── agent-liveness-updater</span><br><span class=\"line\">      │   │   │   └── timer-job-agent-liveness-updater                [OK] OK (82.885µs) (0s, x1)</span><br><span class=\"line\">      │   │   ├── iptables</span><br><span class=\"line\">      │   │   │   ├── ipset</span><br><span class=\"line\">      │   │   │   │   ├── job-ipset-init-finalizer                    [OK] Running (27m, x1)</span><br><span class=\"line\">      │   │   │   │   ├── job-reconcile                               [OK] OK, 0 object(s) (27m, x2)</span><br><span class=\"line\">      │   │   │   │   └── job-refresh                                 [OK] Next refresh <span class=\"keyword\">in</span> 30m0s (27m, x1)</span><br><span class=\"line\">      │   │   │   └── job-iptables-reconciliation-loop                [OK] iptables rules full reconciliation completed (27m, x1)</span><br><span class=\"line\">      │   │   ├── l2-responder</span><br><span class=\"line\">      │   │   │   └── job-l2-responder-reconciler                     [OK] Running (27m, x1)</span><br><span class=\"line\">      │   │   ├── maps</span><br><span class=\"line\">      │   │   │   └── bwmap</span><br><span class=\"line\">      │   │   │       └── timer-job-pressure-metric-throttle          [OK] OK (18.336µs) (1s, x1)</span><br><span class=\"line\">      │   │   ├── mtu</span><br><span class=\"line\">      │   │   │   ├── job-endpoint-mtu-updater                        [OK] Endpoint MTU updated (27m, x1)</span><br><span class=\"line\">      │   │   │   └── job-mtu-updater                                 [OK] MTU updated (1500) (27m, x1)</span><br><span class=\"line\">      │   │   ├── node-address</span><br><span class=\"line\">      │   │   │   └── job-node-address-update                         [OK] 172.16.2.88 (primary), fe80::7019:6fff:febf:e8a7 (primary) (27m, x1)</span><br><span class=\"line\">      │   │   ├── orchestrator</span><br><span class=\"line\">      │   │   │   └── job-reinitialize                                [OK] OK (26m, x2)</span><br><span class=\"line\">      │   │   └── sysctl</span><br><span class=\"line\">      │   │       ├── job-reconcile                                   [OK] OK, 16 object(s) (6m56s, x35)</span><br><span class=\"line\">      │   │       └── job-refresh                                     [OK] Next refresh <span class=\"keyword\">in</span> 9m53.185634443s (6m56s, x1)</span><br><span class=\"line\">      │   └── infra</span><br><span class=\"line\">      │       ├── k8s-synced-crdsync</span><br><span class=\"line\">      │       │   └── job-sync-crds                                   [OK] Running (27m, x1)</span><br><span class=\"line\">      │       ├── metrics</span><br><span class=\"line\">      │       │   ├── job-collect                                     [OK] Sampled 24 metrics <span class=\"keyword\">in</span> 4.183045ms, next collection at 2025-08-04 09:26:00.386029804 +0000 UTC m=+1803.177514891 (2m1s, x1)</span><br><span class=\"line\">      │       │   └── timer-job-cleanup                               [OK] Primed (27m, x1)</span><br><span class=\"line\">      │       └── shell</span><br><span class=\"line\">      │           └── job-listener                                    [OK] Listening on /var/run/cilium/shell.sock (27m, x1)</span><br><span class=\"line\">      └── enterprise-controlplane</span><br><span class=\"line\">          └── cec-ingress-policy</span><br><span class=\"line\">              └── timer-job-enterprise-endpoint-policy-periodic-regeneration      [OK] OK (21.899µs) (1s, x1)</span><br><span class=\"line\">      </span><br><span class=\"line\">/home/cilium <span class=\"comment\"># cilium service list</span></span><br><span class=\"line\">ID   Frontend                Service Type   Backend                               </span><br><span class=\"line\">1    172.16.32.1:443/TCP     ClusterIP      1 =&gt; 10.75.59.81:6443/TCP (active)    </span><br><span class=\"line\">2    172.16.42.186:443/TCP   ClusterIP      1 =&gt; 10.75.59.83:4244/TCP (active)    </span><br><span class=\"line\">3    172.16.42.14:80/TCP     ClusterIP      1 =&gt; 172.16.1.115:4245/TCP (active)   </span><br><span class=\"line\">4    172.16.38.134:80/TCP    ClusterIP      1 =&gt; 172.16.1.105:8081/TCP (active)   </span><br><span class=\"line\">5    10.75.59.83:31708/TCP   NodePort       1 =&gt; 172.16.1.105:8081/TCP (active)   </span><br><span class=\"line\">6    0.0.0.0:31708/TCP       NodePort       1 =&gt; 172.16.1.105:8081/TCP (active)   </span><br><span class=\"line\">7    172.16.32.10:53/TCP     ClusterIP      1 =&gt; 172.16.0.161:53/TCP (active)     </span><br><span class=\"line\">                                            2 =&gt; 172.16.0.105:53/TCP (active)     </span><br><span class=\"line\">8    172.16.32.10:9153/TCP   ClusterIP      1 =&gt; 172.16.0.161:9153/TCP (active)   </span><br><span class=\"line\">                                            2 =&gt; 172.16.0.105:9153/TCP (active)   </span><br><span class=\"line\">9    172.16.32.10:53/UDP     ClusterIP      1 =&gt; 172.16.0.161:53/UDP (active)     </span><br><span class=\"line\">                                            2 =&gt; 172.16.0.105:53/UDP (active)     </span><br><span class=\"line\">10   172.16.34.108:80/TCP    ClusterIP      1 =&gt; 172.16.1.198:80/TCP (active)     </span><br><span class=\"line\">                                            2 =&gt; 172.16.2.92:80/TCP (active)      </span><br><span class=\"line\">11   10.75.59.83:30719/TCP   NodePort       1 =&gt; 172.16.1.198:80/TCP (active)     </span><br><span class=\"line\">                                            2 =&gt; 172.16.2.92:80/TCP (active)      </span><br><span class=\"line\">12   0.0.0.0:30719/TCP       NodePort       1 =&gt; 172.16.1.198:80/TCP (active)     </span><br><span class=\"line\">                                            2 =&gt; 172.16.2.92:80/TCP (active)      </span><br><span class=\"line\">/home/cilium <span class=\"comment\"># cilium bpf nat list</span></span><br><span class=\"line\">TCP IN 10.75.59.82:4240 -&gt; 10.75.59.83:35986 XLATE_DST 10.75.59.83:35986 Created=1076sec ago NeedsCT=1</span><br><span class=\"line\">ICMP IN 10.75.59.81:0 -&gt; 10.75.59.83:63865 XLATE_DST 10.75.59.83:63865 Created=156sec ago NeedsCT=1</span><br><span class=\"line\">TCP IN 10.75.59.81:4240 -&gt; 10.75.59.83:58402 XLATE_DST 10.75.59.83:58402 Created=56sec ago NeedsCT=1</span><br><span class=\"line\">ICMP OUT 10.75.59.83:47633 -&gt; 10.75.59.81:0 XLATE_SRC 10.75.59.83:47633 Created=56sec ago NeedsCT=1</span><br><span class=\"line\">ICMP OUT 10.75.59.83:56308 -&gt; 172.16.0.116:0 XLATE_SRC 10.75.59.83:56308 Created=206sec ago NeedsCT=1</span><br><span class=\"line\">ICMP OUT 10.75.59.83:40570 -&gt; 10.75.59.82:0 XLATE_SRC 10.75.59.83:40570 Created=226sec ago NeedsCT=1</span><br><span class=\"line\">TCP IN 172.16.0.116:4240 -&gt; 10.75.59.83:33274 XLATE_DST 10.75.59.83:33274 Created=706sec ago NeedsCT=1</span><br><span class=\"line\">ICMP IN 172.16.0.116:0 -&gt; 10.75.59.83:56308 XLATE_DST 10.75.59.83:56308 Created=206sec ago NeedsCT=1</span><br><span class=\"line\">TCP OUT 10.75.59.83:37066 -&gt; 10.75.59.81:6443 XLATE_SRC 10.75.59.83:37066 Created=1655sec ago NeedsCT=1</span><br><span class=\"line\">TCP OUT 10.75.59.83:44064 -&gt; 172.16.1.173:4240 XLATE_SRC 10.75.59.83:44064 Created=1066sec ago NeedsCT=1</span><br><span class=\"line\">TCP OUT 10.75.59.83:46184 -&gt; 10.75.59.81:6443 XLATE_SRC 10.75.59.83:46184 Created=1651sec ago NeedsCT=1</span><br><span class=\"line\">TCP OUT 10.75.59.83:43981 -&gt; 10.75.59.86:179 XLATE_SRC 10.75.59.83:43981 Created=1648sec ago NeedsCT=1</span><br><span class=\"line\">TCP OUT 10.75.59.83:57802 -&gt; 10.75.59.81:4240 XLATE_SRC 10.75.59.83:57802 Created=716sec ago NeedsCT=1</span><br><span class=\"line\">ICMP IN 10.75.59.82:0 -&gt; 10.75.59.83:43531 XLATE_DST 10.75.59.83:43531 Created=36sec ago NeedsCT=1</span><br><span class=\"line\">TCP IN 10.75.59.86:179 -&gt; 10.75.59.83:43981 XLATE_DST 10.75.59.83:43981 Created=1648sec ago NeedsCT=1</span><br><span class=\"line\">TCP OUT 10.75.59.83:58402 -&gt; 10.75.59.81:4240 XLATE_SRC 10.75.59.83:58402 Created=56sec ago NeedsCT=1</span><br><span class=\"line\">ICMP OUT 10.75.59.83:43619 -&gt; 10.75.59.82:0 XLATE_SRC 10.75.59.83:43619 Created=176sec ago NeedsCT=1</span><br><span class=\"line\">ICMP OUT 10.75.59.83:40760 -&gt; 10.75.59.81:0 XLATE_SRC 10.75.59.83:40760 Created=216sec ago NeedsCT=1</span><br><span class=\"line\">TCP IN 142.250.199.100:443 -&gt; 10.75.59.83:40732 XLATE_DST 172.16.2.180:40732 Created=205sec ago NeedsCT=0</span><br><span class=\"line\">TCP OUT 10.75.59.83:34202 -&gt; 172.16.0.116:4240 XLATE_SRC 10.75.59.83:34202 Created=46sec ago NeedsCT=1</span><br><span class=\"line\">ICMP IN 10.75.59.81:0 -&gt; 10.75.59.83:47633 XLATE_DST 10.75.59.83:47633 Created=56sec ago NeedsCT=1</span><br><span class=\"line\">TCP OUT 10.75.59.83:33274 -&gt; 172.16.0.116:4240 XLATE_SRC 10.75.59.83:33274 Created=706sec ago NeedsCT=1</span><br><span class=\"line\">ICMP OUT 10.75.59.83:43531 -&gt; 10.75.59.82:0 XLATE_SRC 10.75.59.83:43531 Created=36sec ago NeedsCT=1</span><br><span class=\"line\">ICMP IN 10.75.59.82:0 -&gt; 10.75.59.83:43619 XLATE_DST 10.75.59.83:43619 Created=176sec ago NeedsCT=1</span><br><span class=\"line\">TCP IN 10.75.59.81:6443 -&gt; 10.75.59.83:37066 XLATE_DST 10.75.59.83:37066 Created=1655sec ago NeedsCT=1</span><br><span class=\"line\">ICMP OUT 10.75.59.83:36675 -&gt; 172.16.1.173:0 XLATE_SRC 10.75.59.83:36675 Created=106sec ago NeedsCT=1</span><br><span class=\"line\">TCP OUT 172.16.2.180:40732 -&gt; 142.250.199.100:443 XLATE_SRC 10.75.59.83:40732 Created=205sec ago NeedsCT=0</span><br><span class=\"line\">ICMP IN 172.16.0.116:0 -&gt; 10.75.59.83:38433 XLATE_DST 10.75.59.83:38433 Created=276sec ago NeedsCT=1</span><br><span class=\"line\">TCP OUT 10.75.59.83:35986 -&gt; 10.75.59.82:4240 XLATE_SRC 10.75.59.83:35986 Created=1076sec ago NeedsCT=1</span><br><span class=\"line\">ICMP IN 172.16.1.173:0 -&gt; 10.75.59.83:36675 XLATE_DST 10.75.59.83:36675 Created=106sec ago NeedsCT=1</span><br><span class=\"line\">TCP IN 10.75.59.81:6443 -&gt; 10.75.59.83:46184 XLATE_DST 10.75.59.83:46184 Created=1651sec ago NeedsCT=1</span><br><span class=\"line\">TCP IN 172.16.0.116:4240 -&gt; 10.75.59.83:34202 XLATE_DST 10.75.59.83:34202 Created=46sec ago NeedsCT=1</span><br><span class=\"line\">ICMP OUT 10.75.59.83:63865 -&gt; 10.75.59.81:0 XLATE_SRC 10.75.59.83:63865 Created=156sec ago NeedsCT=1</span><br><span class=\"line\">ICMP OUT 10.75.59.83:38433 -&gt; 172.16.0.116:0 XLATE_SRC 10.75.59.83:38433 Created=276sec ago NeedsCT=1</span><br><span class=\"line\">ICMP IN 10.75.59.82:0 -&gt; 10.75.59.83:40570 XLATE_DST 10.75.59.83:40570 Created=226sec ago NeedsCT=1</span><br><span class=\"line\">ICMP OUT 10.75.59.83:36899 -&gt; 172.16.1.173:0 XLATE_SRC 10.75.59.83:36899 Created=236sec ago NeedsCT=1</span><br><span class=\"line\">ICMP IN 172.16.1.173:0 -&gt; 10.75.59.83:36899 XLATE_DST 10.75.59.83:36899 Created=236sec ago NeedsCT=1</span><br><span class=\"line\">TCP IN 10.75.59.81:4240 -&gt; 10.75.59.83:57802 XLATE_DST 10.75.59.83:57802 Created=716sec ago NeedsCT=1</span><br><span class=\"line\">ICMP IN 10.75.59.81:0 -&gt; 10.75.59.83:40760 XLATE_DST 10.75.59.83:40760 Created=216sec ago NeedsCT=1</span><br><span class=\"line\">TCP IN 172.16.1.173:4240 -&gt; 10.75.59.83:44064 XLATE_DST 10.75.59.83:44064 Created=1066sec ago NeedsCT=1</span><br><span class=\"line\"></span><br><span class=\"line\">/home/cilium <span class=\"comment\"># cilium config</span></span><br><span class=\"line\"><span class=\"comment\">##### Read-write configurations #####</span></span><br><span class=\"line\">ConntrackAccounting               : Disabled</span><br><span class=\"line\">ConntrackLocal                    : Disabled</span><br><span class=\"line\">Debug                             : Disabled</span><br><span class=\"line\">DebugLB                           : Disabled</span><br><span class=\"line\">DropNotification                  : Enabled</span><br><span class=\"line\">MonitorAggregationLevel           : Medium</span><br><span class=\"line\">PolicyAccounting                  : Enabled</span><br><span class=\"line\">PolicyAuditMode                   : Disabled</span><br><span class=\"line\">PolicyTracing                     : Disabled</span><br><span class=\"line\">PolicyVerdictNotification         : Enabled</span><br><span class=\"line\">SourceIPVerification              : Enabled</span><br><span class=\"line\">TraceNotification                 : Enabled</span><br><span class=\"line\">MonitorNumPages                   : 64</span><br><span class=\"line\">PolicyEnforcement                 : default</span><br><span class=\"line\">/home/cilium <span class=\"comment\"># exit</span></span><br><span class=\"line\">root@k8s-node-1:~# </span><br></pre></td></tr></table></figure>\n<h2 id=\"11-2-BGP相关信息\"><a href=\"#11-2-BGP相关信息\" class=\"headerlink\" title=\"11.2 BGP相关信息\"></a>11.2 BGP相关信息</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@k8s-node-1:~# cilium bgp peers</span><br><span class=\"line\">Node         Local AS   Peer AS   Peer Address   Session State   Uptime   Family         Received   Advertised</span><br><span class=\"line\">k8s-node-1   65000      65000     10.75.59.86    established     41m41s   ipv4/unicast   1          8    </span><br><span class=\"line\">k8s-node-2   65000      65000     10.75.59.86    established     39m53s   ipv4/unicast   1          8    </span><br><span class=\"line\">k8s-node-3   65000      65000     10.75.59.86    established     39m52s   ipv4/unicast   1          8    </span><br><span class=\"line\">root@k8s-node-1:~# cilium bgp routes</span><br><span class=\"line\">(Defaulting to `available ipv4 unicast` routes, please see <span class=\"built_in\">help</span> <span class=\"keyword\">for</span> more options)</span><br><span class=\"line\"></span><br><span class=\"line\">Node         VRouter   Prefix             NextHop   Age      Attrs</span><br><span class=\"line\">k8s-node-1   65000     172.16.0.0/24      0.0.0.0   41m48s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class=\"line\">             65000     172.16.32.1/32     0.0.0.0   41m48s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class=\"line\">             65000     172.16.32.10/32    0.0.0.0   41m48s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class=\"line\">             65000     172.16.34.108/32   0.0.0.0   34m39s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class=\"line\">             65000     172.16.38.134/32   0.0.0.0   41m48s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class=\"line\">             65000     172.16.42.14/32    0.0.0.0   41m48s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class=\"line\">             65000     172.16.42.186/32   0.0.0.0   41m47s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class=\"line\">k8s-node-2   65000     172.16.1.0/24      0.0.0.0   39m59s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class=\"line\">             65000     172.16.32.1/32     0.0.0.0   39m59s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class=\"line\">             65000     172.16.32.10/32    0.0.0.0   39m59s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class=\"line\">             65000     172.16.34.108/32   0.0.0.0   34m39s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class=\"line\">             65000     172.16.38.134/32   0.0.0.0   39m59s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class=\"line\">             65000     172.16.42.14/32    0.0.0.0   39m59s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class=\"line\">             65000     172.16.42.186/32   0.0.0.0   39m56s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class=\"line\">k8s-node-3   65000     172.16.2.0/24      0.0.0.0   39m58s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class=\"line\">             65000     172.16.32.1/32     0.0.0.0   39m58s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class=\"line\">             65000     172.16.32.10/32    0.0.0.0   39m58s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class=\"line\">             65000     172.16.34.108/32   0.0.0.0   34m39s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class=\"line\">             65000     172.16.38.134/32   0.0.0.0   39m58s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class=\"line\">             65000     172.16.42.14/32    0.0.0.0   39m58s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class=\"line\">             65000     172.16.42.186/32   0.0.0.0   39m55s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class=\"line\"></span><br><span class=\"line\">root@dns-bgp-server:~# ip route show</span><br><span class=\"line\">default via 10.75.59.1 dev enp1s0 proto static </span><br><span class=\"line\">10.75.59.0/24 dev enp1s0 proto kernel scope <span class=\"built_in\">link</span> src 10.75.59.86 </span><br><span class=\"line\">172.16.0.0/24 nhid 8 via 10.75.59.81 dev enp1s0 proto bgp metric 20 </span><br><span class=\"line\">172.16.1.0/24 nhid 12 via 10.75.59.82 dev enp1s0 proto bgp metric 20 </span><br><span class=\"line\">172.16.2.0/24 nhid 19 via 10.75.59.83 dev enp1s0 proto bgp metric 20 </span><br><span class=\"line\">172.16.32.1 nhid 18 proto bgp metric 20 </span><br><span class=\"line\">        nexthop via 10.75.59.81 dev enp1s0 weight 1 </span><br><span class=\"line\">        nexthop via 10.75.59.82 dev enp1s0 weight 1 </span><br><span class=\"line\">        nexthop via 10.75.59.83 dev enp1s0 weight 1 </span><br><span class=\"line\">172.16.32.10 nhid 18 proto bgp metric 20 </span><br><span class=\"line\">        nexthop via 10.75.59.81 dev enp1s0 weight 1 </span><br><span class=\"line\">        nexthop via 10.75.59.82 dev enp1s0 weight 1 </span><br><span class=\"line\">        nexthop via 10.75.59.83 dev enp1s0 weight 1 </span><br><span class=\"line\">172.16.34.108 nhid 18 proto bgp metric 20 </span><br><span class=\"line\">        nexthop via 10.75.59.81 dev enp1s0 weight 1 </span><br><span class=\"line\">        nexthop via 10.75.59.82 dev enp1s0 weight 1 </span><br><span class=\"line\">        nexthop via 10.75.59.83 dev enp1s0 weight 1 </span><br><span class=\"line\">172.16.38.134 nhid 18 proto bgp metric 20 </span><br><span class=\"line\">        nexthop via 10.75.59.81 dev enp1s0 weight 1 </span><br><span class=\"line\">        nexthop via 10.75.59.82 dev enp1s0 weight 1 </span><br><span class=\"line\">        nexthop via 10.75.59.83 dev enp1s0 weight 1 </span><br><span class=\"line\">172.16.42.14 nhid 18 proto bgp metric 20 </span><br><span class=\"line\">        nexthop via 10.75.59.81 dev enp1s0 weight 1 </span><br><span class=\"line\">        nexthop via 10.75.59.82 dev enp1s0 weight 1 </span><br><span class=\"line\">        nexthop via 10.75.59.83 dev enp1s0 weight 1 </span><br><span class=\"line\">172.16.42.186 nhid 18 proto bgp metric 20 </span><br><span class=\"line\">        nexthop via 10.75.59.81 dev enp1s0 weight 1 </span><br><span class=\"line\">        nexthop via 10.75.59.82 dev enp1s0 weight 1 </span><br><span class=\"line\">        nexthop via 10.75.59.83 dev enp1s0 weight 1 </span><br><span class=\"line\">root@dns-bgp-server:~# route -n</span><br><span class=\"line\">Kernel IP routing table</span><br><span class=\"line\">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class=\"line\">0.0.0.0         10.75.59.1      0.0.0.0         UG    0      0        0 enp1s0</span><br><span class=\"line\">10.75.59.0      0.0.0.0         255.255.255.0   U     0      0        0 enp1s0</span><br><span class=\"line\">172.16.0.0      10.75.59.81     255.255.255.0   UG    20     0        0 enp1s0</span><br><span class=\"line\">172.16.1.0      10.75.59.82     255.255.255.0   UG    20     0        0 enp1s0</span><br><span class=\"line\">172.16.2.0      10.75.59.83     255.255.255.0   UG    20     0        0 enp1s0</span><br><span class=\"line\">172.16.32.1     10.75.59.81     255.255.255.255 UGH   20     0        0 enp1s0</span><br><span class=\"line\">172.16.32.10    10.75.59.81     255.255.255.255 UGH   20     0        0 enp1s0</span><br><span class=\"line\">172.16.34.108   10.75.59.81     255.255.255.255 UGH   20     0        0 enp1s0</span><br><span class=\"line\">172.16.38.134   10.75.59.81     255.255.255.255 UGH   20     0        0 enp1s0</span><br><span class=\"line\">172.16.42.14    10.75.59.81     255.255.255.255 UGH   20     0        0 enp1s0</span><br><span class=\"line\">172.16.42.186   10.75.59.81     255.255.255.255 UGH   20     0        0 enp1s0</span><br><span class=\"line\">root@dns-bgp-server:~# vtysh -c <span class=\"string\">&quot;show ip bgp&quot;</span></span><br><span class=\"line\">BGP table version is 15, <span class=\"built_in\">local</span> router ID is 10.75.59.86, vrf <span class=\"built_in\">id</span> 0</span><br><span class=\"line\">Default <span class=\"built_in\">local</span> pref 100, <span class=\"built_in\">local</span> AS 65000</span><br><span class=\"line\">Status codes:  s suppressed, d damped, h <span class=\"built_in\">history</span>, * valid, &gt; best, = multipath,</span><br><span class=\"line\">               i internal, r RIB-failure, S Stale, R Removed</span><br><span class=\"line\">Nexthop codes: @NNN nexthop<span class=\"string\">&#x27;s vrf id, &lt; announce-nh-self</span></span><br><span class=\"line\"><span class=\"string\">Origin codes:  i - IGP, e - EGP, ? - incomplete</span></span><br><span class=\"line\"><span class=\"string\">RPKI validation codes: V valid, I invalid, N Not found</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">   Network          Next Hop            Metric LocPrf Weight Path</span></span><br><span class=\"line\"><span class=\"string\">*&gt; 10.75.59.0/24    0.0.0.0                  0         32768 ?</span></span><br><span class=\"line\"><span class=\"string\">*&gt;i172.16.0.0/24    10.75.59.81                   100      0 i</span></span><br><span class=\"line\"><span class=\"string\">*&gt;i172.16.1.0/24    10.75.59.82                   100      0 i</span></span><br><span class=\"line\"><span class=\"string\">*&gt;i172.16.2.0/24    10.75.59.83                   100      0 i</span></span><br><span class=\"line\"><span class=\"string\">*=i172.16.32.1/32   10.75.59.83                   100      0 i</span></span><br><span class=\"line\"><span class=\"string\">*=i                 10.75.59.82                   100      0 i</span></span><br><span class=\"line\"><span class=\"string\">*&gt;i                 10.75.59.81                   100      0 i</span></span><br><span class=\"line\"><span class=\"string\">*=i172.16.32.10/32  10.75.59.83                   100      0 i</span></span><br><span class=\"line\"><span class=\"string\">*=i                 10.75.59.82                   100      0 i</span></span><br><span class=\"line\"><span class=\"string\">*&gt;i                 10.75.59.81                   100      0 i</span></span><br><span class=\"line\"><span class=\"string\">*&gt;i172.16.34.108/32 10.75.59.81                   100      0 i</span></span><br><span class=\"line\"><span class=\"string\">*=i                 10.75.59.82                   100      0 i</span></span><br><span class=\"line\"><span class=\"string\">*=i                 10.75.59.83                   100      0 i</span></span><br><span class=\"line\"><span class=\"string\">*=i172.16.38.134/32 10.75.59.83                   100      0 i</span></span><br><span class=\"line\"><span class=\"string\">*=i                 10.75.59.82                   100      0 i</span></span><br><span class=\"line\"><span class=\"string\">*&gt;i                 10.75.59.81                   100      0 i</span></span><br><span class=\"line\"><span class=\"string\">*=i172.16.42.14/32  10.75.59.83                   100      0 i</span></span><br><span class=\"line\"><span class=\"string\">*=i                 10.75.59.82                   100      0 i</span></span><br><span class=\"line\"><span class=\"string\">*&gt;i                 10.75.59.81                   100      0 i</span></span><br><span class=\"line\"><span class=\"string\">*=i172.16.42.186/32 10.75.59.83                   100      0 i</span></span><br><span class=\"line\"><span class=\"string\">*=i                 10.75.59.82                   100      0 i</span></span><br><span class=\"line\"><span class=\"string\">*&gt;i                 10.75.59.81                   100      0 i</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">Displayed  10 routes and 22 total paths</span></span><br><span class=\"line\"><span class=\"string\">root@dns-bgp-server:~# vtysh -c &quot;show ip bgp summary&quot;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">IPv4 Unicast Summary (VRF default):</span></span><br><span class=\"line\"><span class=\"string\">BGP router identifier 10.75.59.86, local AS number 65000 vrf-id 0</span></span><br><span class=\"line\"><span class=\"string\">BGP table version 15</span></span><br><span class=\"line\"><span class=\"string\">RIB entries 19, using 3648 bytes of memory</span></span><br><span class=\"line\"><span class=\"string\">Peers 3, using 2172 KiB of memory</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">Neighbor        V         AS   MsgRcvd   MsgSent   TblVer  InQ OutQ  Up/Down State/PfxRcd   PfxSnt Desc</span></span><br><span class=\"line\"><span class=\"string\">10.75.59.81     4      65000       247       244        0    0    0 00:40:09            7        1 N/A</span></span><br><span class=\"line\"><span class=\"string\">10.75.59.82     4      65000       240       234        0    0    0 00:38:20            7        1 N/A</span></span><br><span class=\"line\"><span class=\"string\">10.75.59.83     4      65000       239       233        0    0    0 00:38:19            7        1 N/A</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">Total number of neighbors 3</span></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"12-项目文档结构\"><a href=\"#12-项目文档结构\" class=\"headerlink\" title=\"12. 项目文档结构\"></a>12. 项目文档结构</h1><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ois@ois:~/data/k8s-cilium-lab$ tree</span><br><span class=\"line\">.</span><br><span class=\"line\">├── ansible.cfg</span><br><span class=\"line\">├── group_vars</span><br><span class=\"line\">│   └── all.yml</span><br><span class=\"line\">├── host_vars</span><br><span class=\"line\">│   ├── dns-bgp-server.yml</span><br><span class=\"line\">│   ├── k8s-node-1.yml</span><br><span class=\"line\">│   ├── k8s-node-2.yml</span><br><span class=\"line\">│   └── k8s-node-3.yml</span><br><span class=\"line\">├── inventory.ini</span><br><span class=\"line\">├── nodevm_cfg</span><br><span class=\"line\">│   ├── dns-bgp-server_meta-data</span><br><span class=\"line\">│   ├── dns-bgp-server_network-config</span><br><span class=\"line\">│   ├── dns-bgp-server_user-data</span><br><span class=\"line\">│   ├── k8s-node-1_meta-data</span><br><span class=\"line\">│   ├── k8s-node-1_network-config</span><br><span class=\"line\">│   ├── k8s-node-1_user-data</span><br><span class=\"line\">│   ├── k8s-node-2_meta-data</span><br><span class=\"line\">│   ├── k8s-node-2_network-config</span><br><span class=\"line\">│   ├── k8s-node-2_user-data</span><br><span class=\"line\">│   ├── k8s-node-3_meta-data</span><br><span class=\"line\">│   ├── k8s-node-3_network-config</span><br><span class=\"line\">│   └── k8s-node-3_user-data</span><br><span class=\"line\">├── nodevms</span><br><span class=\"line\">│   ├── dns-bgp-server.qcow2</span><br><span class=\"line\">│   ├── k8s-node-1.qcow2</span><br><span class=\"line\">│   ├── k8s-node-2.qcow2</span><br><span class=\"line\">│   └── k8s-node-3.qcow2</span><br><span class=\"line\">├── playbooks</span><br><span class=\"line\">│   ├── 1_create_vms.yml</span><br><span class=\"line\">│   ├── 2_prepare_nodes.yml</span><br><span class=\"line\">│   ├── 3_setup_cluster.yml</span><br><span class=\"line\">│   └── 4_deploy_app.yml</span><br><span class=\"line\">├── roles</span><br><span class=\"line\">│   ├── common</span><br><span class=\"line\">│   │   └── tasks</span><br><span class=\"line\">│   │       └── main.yml</span><br><span class=\"line\">│   ├── infra_server</span><br><span class=\"line\">│   │   └── tasks</span><br><span class=\"line\">│   │       └── main.yml</span><br><span class=\"line\">│   └── k8s_node</span><br><span class=\"line\">│       └── tasks</span><br><span class=\"line\">│           └── main.yml</span><br><span class=\"line\">└── templates</span><br><span class=\"line\">    ├── cilium-bgp.yaml.j2</span><br><span class=\"line\">    ├── containerd.toml.j2</span><br><span class=\"line\">    ├── deploy-star-wars.sh.j2</span><br><span class=\"line\">    ├── frr.conf.j2</span><br><span class=\"line\">    ├── hosts.j2</span><br><span class=\"line\">    ├── meta-data.j2</span><br><span class=\"line\">    ├── network-config.j2</span><br><span class=\"line\">    └── user-data.j2</span><br><span class=\"line\"></span><br><span class=\"line\">14 directories, 38 files</span><br></pre></td></tr></table></figure>","length":11566,"excerpt":"","more":"<h1 id=\"Setup-K8S-with-Ansible-from-zero\"><a href=\"#Setup-K8S-with-Ansible-from-zero\" class=\"headerlink\" title=\"Setup K8S with Ansible from zero\"></a>Setup K8S with Ansible from zero</h1><h1 id=\"1-删除之前的环境\"><a href=\"#1-删除之前的环境\" class=\"headerlink\" title=\"1. 删除之前的环境\"></a>1. 删除之前的环境</h1><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ois@ois:~/data/k8s-cilium-lab$ <span class=\"built_in\">cd</span> ..</span><br><span class=\"line\">ois@ois:~/data$ ./07-undefine-vms.sh </span><br><span class=\"line\">Domain <span class=\"string\">&#x27;k8s-node-1&#x27;</span> destroyed</span><br><span class=\"line\"></span><br><span class=\"line\">Domain <span class=\"string\">&#x27;k8s-node-1&#x27;</span> has been undefined</span><br><span class=\"line\">Volume <span class=\"string\">&#x27;vda&#x27;</span>(/home/ois/data/k8s-cilium-lab/nodevms/k8s-node-1.qcow2) removed.</span><br><span class=\"line\"></span><br><span class=\"line\">Domain <span class=\"string\">&#x27;k8s-node-2&#x27;</span> destroyed</span><br><span class=\"line\"></span><br><span class=\"line\">Domain <span class=\"string\">&#x27;k8s-node-2&#x27;</span> has been undefined</span><br><span class=\"line\">Volume <span class=\"string\">&#x27;vda&#x27;</span>(/home/ois/data/k8s-cilium-lab/nodevms/k8s-node-2.qcow2) removed.</span><br><span class=\"line\"></span><br><span class=\"line\">Domain <span class=\"string\">&#x27;k8s-node-3&#x27;</span> destroyed</span><br><span class=\"line\"></span><br><span class=\"line\">Domain <span class=\"string\">&#x27;k8s-node-3&#x27;</span> has been undefined</span><br><span class=\"line\">Volume <span class=\"string\">&#x27;vda&#x27;</span>(/home/ois/data/k8s-cilium-lab/nodevms/k8s-node-3.qcow2) removed.</span><br><span class=\"line\"></span><br><span class=\"line\">Domain <span class=\"string\">&#x27;dns-bgp-server&#x27;</span> destroyed</span><br><span class=\"line\"></span><br><span class=\"line\">Domain <span class=\"string\">&#x27;dns-bgp-server&#x27;</span> has been undefined</span><br><span class=\"line\">Volume <span class=\"string\">&#x27;vda&#x27;</span>(/home/ois/data/k8s-cilium-lab/nodevms/dns-bgp-server.qcow2) removed.</span><br><span class=\"line\"></span><br><span class=\"line\">ois@ois:~/data$ <span class=\"built_in\">rm</span> -rf k8s-cilium-lab/</span><br><span class=\"line\">ois@ois:~/data$ </span><br></pre></td></tr></table></figure>\n\n<h1 id=\"2-重新构建项目文件结构\"><a href=\"#2-重新构建项目文件结构\" class=\"headerlink\" title=\"2. 重新构建项目文件结构\"></a>2. 重新构建项目文件结构</h1><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ois@ois:~/data$ ./00-create-project-structure.sh </span><br><span class=\"line\">--- K8s + Cilium Lab Setup (Warning-Free) ---</span><br><span class=\"line\">This script will prepare a new Ansible project directory named <span class=\"string\">&#x27;k8s-cilium-lab&#x27;</span>.</span><br><span class=\"line\"></span><br><span class=\"line\">--- Step 1: Checking Prerequisites ---</span><br><span class=\"line\">✅ OS is Debian-based.</span><br><span class=\"line\">✅ Ansible is already installed.</span><br><span class=\"line\">--&gt; Ensuring libvirt and whois are up-to-date...</span><br><span class=\"line\">✅ Dependencies are present.</span><br><span class=\"line\">✅ SSH key already exists at ~/.ssh/id_rsa. Skipping generation.</span><br><span class=\"line\"></span><br><span class=\"line\">--- Step 2: Creating Project Structure ---</span><br><span class=\"line\">✅ Project directory structure created <span class=\"keyword\">in</span> <span class=\"string\">&#x27;k8s-cilium-lab/&#x27;</span>.</span><br><span class=\"line\"></span><br><span class=\"line\">--- Step 3: Configuring User Password Hash ---</span><br><span class=\"line\">A secure password <span class=\"built_in\">hash</span> is required <span class=\"keyword\">for</span> the <span class=\"string\">&#x27;ubuntu&#x27;</span> user on the VMs.</span><br><span class=\"line\">Enter the password <span class=\"keyword\">for</span> the <span class=\"string\">&#x27;ubuntu&#x27;</span> user (input will be hidden): </span><br><span class=\"line\">--&gt; Generating password <span class=\"built_in\">hash</span>...</span><br><span class=\"line\">✅ Password <span class=\"built_in\">hash</span> generated.</span><br><span class=\"line\"></span><br><span class=\"line\">--- Step 4: Generating Configuration Files ---</span><br><span class=\"line\">✅ Created ansible.cfg</span><br><span class=\"line\">✅ Created inventory.ini</span><br><span class=\"line\">✅ Created group_vars/all.yml with password <span class=\"built_in\">hash</span>.</span><br><span class=\"line\">✅ Created host_vars/k8s-node-1.yml</span><br><span class=\"line\">✅ Created host_vars/k8s-node-2.yml</span><br><span class=\"line\">✅ Created host_vars/k8s-node-3.yml</span><br><span class=\"line\">✅ Created host_vars/dns-bgp-server.yml</span><br><span class=\"line\"></span><br><span class=\"line\">--- Setup Complete! ---</span><br><span class=\"line\">✅ Project <span class=\"string\">&#x27;k8s-cilium-lab&#x27;</span> has been successfully configured.</span><br><span class=\"line\"></span><br><span class=\"line\">Next Steps:</span><br><span class=\"line\">1. Run the next script to generate the VM creation playbook:</span><br><span class=\"line\">   ../01-create-vms.sh</span><br><span class=\"line\">2. Run the playbook to create your lab VMs (no vault password needed):</span><br><span class=\"line\">   ansible-playbook playbooks/1_create_vms.yml</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"3-生成Playbook，用于构建Lab环境虚拟机\"><a href=\"#3-生成Playbook，用于构建Lab环境虚拟机\" class=\"headerlink\" title=\"3. 生成Playbook，用于构建Lab环境虚拟机\"></a>3. 生成Playbook，用于构建Lab环境虚拟机</h1><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ois@ois:~/data$ ./01-create-vms.sh </span><br><span class=\"line\">--- Lab VM Playbook Generator (Final Corrected Version) ---</span><br><span class=\"line\"></span><br><span class=\"line\">--- Step 1: Verifying Project Context ---</span><br><span class=\"line\">✅ Working inside project directory: /home/ois/data/k8s-cilium-lab</span><br><span class=\"line\"></span><br><span class=\"line\">--- Step 2: Ensuring Directories Exist ---</span><br><span class=\"line\">✅ Directories <span class=\"string\">&#x27;playbooks/&#x27;</span> and <span class=\"string\">&#x27;templates/&#x27;</span> are ready.</span><br><span class=\"line\"></span><br><span class=\"line\">--- Step 3: Generating Files ---</span><br><span class=\"line\">✅ Generated playbook: playbooks/1_create_vms.yml</span><br><span class=\"line\">✅ Generated template: templates/user-data.j2</span><br><span class=\"line\">✅ Generated template: templates/network-config.j2</span><br><span class=\"line\">✅ Generated template: templates/meta-data.j2</span><br><span class=\"line\"></span><br><span class=\"line\">--- Generation Complete! ---</span><br><span class=\"line\">✅ All necessary files have been created inside the <span class=\"string\">&#x27;k8s-cilium-lab&#x27;</span> directory.</span><br><span class=\"line\"></span><br><span class=\"line\">Next Step:</span><br><span class=\"line\">1. Change into the project directory: <span class=\"built_in\">cd</span> k8s-cilium-lab</span><br><span class=\"line\">2. Run the playbook to create your lab VMs:</span><br><span class=\"line\">   ansible-playbook playbooks/1_create_vms.yml</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"4-运行Playbook，构建虚拟机环境\"><a href=\"#4-运行Playbook，构建虚拟机环境\" class=\"headerlink\" title=\"4. 运行Playbook，构建虚拟机环境\"></a>4. 运行Playbook，构建虚拟机环境</h1><p>自动创建k8s-nodes 和 运行FRR的虚拟机，并进行联通性探测，添加到已知主机列表(known_hosts)</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ois@ois:~/data$ <span class=\"built_in\">cd</span> k8s-cilium-lab/</span><br><span class=\"line\">ois@ois:~/data/k8s-cilium-lab$ </span><br><span class=\"line\">ois@ois:~/data/k8s-cilium-lab$ </span><br><span class=\"line\">ois@ois:~/data/k8s-cilium-lab$ ansible-playbook playbooks/1_create_vms.yml</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY [Play 1 - Pre-flight Check <span class=\"keyword\">for</span> Existing VMs] ******************************************************************************************************************************************************</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Check status of each VM with virsh] **************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [dns-bgp-server]</span><br><span class=\"line\">ok: [k8s-node-2]</span><br><span class=\"line\">ok: [k8s-node-1]</span><br><span class=\"line\">ok: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY [Play 2 - Decide <span class=\"keyword\">if</span> Provisioning is Needed] *******************************************************************************************************************************************************</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Initialize an empty list <span class=\"keyword\">for</span> missing VMs] ********************************************************************************************************************************************************</span><br><span class=\"line\">ok: [localhost]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Populate the list of missing VMs] ****************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [localhost] =&gt; (item=dns-bgp-server)</span><br><span class=\"line\">ok: [localhost] =&gt; (item=k8s-node-1)</span><br><span class=\"line\">ok: [localhost] =&gt; (item=k8s-node-2)</span><br><span class=\"line\">ok: [localhost] =&gt; (item=k8s-node-3)</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Set global flag <span class=\"keyword\">if</span> provisioning is required] *****************************************************************************************************************************************************</span><br><span class=\"line\">ok: [localhost]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Report status] ***********************************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [localhost] =&gt; &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;msg&quot;</span>: <span class=\"string\">&quot;Provisioning needed: True. Missing VMs: [&#x27;dns-bgp-server&#x27;, &#x27;k8s-node-1&#x27;, &#x27;k8s-node-2&#x27;, &#x27;k8s-node-3&#x27;]&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY [Play 3 - Prepare VM Assets <span class=\"keyword\">in</span> Parallel] **********************************************************************************************************************************************************</span><br><span class=\"line\">[WARNING]: Using run_once with the free strategy is not currently supported. This task will still be executed <span class=\"keyword\">for</span> every host <span class=\"keyword\">in</span> the inventory list.</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Ensure VM directories exist] *********************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [dns-bgp-server] =&gt; (item=/home/ois/data/k8s-cilium-lab/nodevms)</span><br><span class=\"line\">ok: [k8s-node-2] =&gt; (item=/home/ois/data/k8s-cilium-lab/nodevms)</span><br><span class=\"line\">ok: [k8s-node-3] =&gt; (item=/home/ois/data/k8s-cilium-lab/nodevms)</span><br><span class=\"line\">ok: [k8s-node-1] =&gt; (item=/home/ois/data/k8s-cilium-lab/nodevms)</span><br><span class=\"line\">changed: [dns-bgp-server] =&gt; (item=/home/ois/data/k8s-cilium-lab/nodevm_cfg)</span><br><span class=\"line\">ok: [k8s-node-2] =&gt; (item=/home/ois/data/k8s-cilium-lab/nodevm_cfg)</span><br><span class=\"line\">ok: [k8s-node-3] =&gt; (item=/home/ois/data/k8s-cilium-lab/nodevm_cfg)</span><br><span class=\"line\">ok: [k8s-node-1] =&gt; (item=/home/ois/data/k8s-cilium-lab/nodevm_cfg)</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Check <span class=\"keyword\">if</span> VM disk image already exists] ***********************************************************************************************************************************************************</span><br><span class=\"line\">ok: [k8s-node-2]</span><br><span class=\"line\">ok: [dns-bgp-server]</span><br><span class=\"line\">ok: [k8s-node-1]</span><br><span class=\"line\">ok: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Create VM disk image from base image] ************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [dns-bgp-server]</span><br><span class=\"line\">changed: [k8s-node-2]</span><br><span class=\"line\">changed: [k8s-node-1]</span><br><span class=\"line\">changed: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Resize VM disk image] ****************************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [dns-bgp-server]</span><br><span class=\"line\">changed: [k8s-node-2]</span><br><span class=\"line\">changed: [k8s-node-3]</span><br><span class=\"line\">changed: [k8s-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Generate cloud-init files] ***********************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [k8s-node-2] =&gt; (item=&#123;<span class=\"string\">&#x27;src&#x27;</span>: <span class=\"string\">&#x27;../templates/user-data.j2&#x27;</span>, <span class=\"string\">&#x27;dest&#x27;</span>: <span class=\"string\">&#x27;/home/ois/data/k8s-cilium-lab/nodevm_cfg/k8s-node-2_user-data&#x27;</span>&#125;)</span><br><span class=\"line\">changed: [k8s-node-3] =&gt; (item=&#123;<span class=\"string\">&#x27;src&#x27;</span>: <span class=\"string\">&#x27;../templates/user-data.j2&#x27;</span>, <span class=\"string\">&#x27;dest&#x27;</span>: <span class=\"string\">&#x27;/home/ois/data/k8s-cilium-lab/nodevm_cfg/k8s-node-3_user-data&#x27;</span>&#125;)</span><br><span class=\"line\">changed: [dns-bgp-server] =&gt; (item=&#123;<span class=\"string\">&#x27;src&#x27;</span>: <span class=\"string\">&#x27;../templates/user-data.j2&#x27;</span>, <span class=\"string\">&#x27;dest&#x27;</span>: <span class=\"string\">&#x27;/home/ois/data/k8s-cilium-lab/nodevm_cfg/dns-bgp-server_user-data&#x27;</span>&#125;)</span><br><span class=\"line\">changed: [k8s-node-1] =&gt; (item=&#123;<span class=\"string\">&#x27;src&#x27;</span>: <span class=\"string\">&#x27;../templates/user-data.j2&#x27;</span>, <span class=\"string\">&#x27;dest&#x27;</span>: <span class=\"string\">&#x27;/home/ois/data/k8s-cilium-lab/nodevm_cfg/k8s-node-1_user-data&#x27;</span>&#125;)</span><br><span class=\"line\">changed: [k8s-node-3] =&gt; (item=&#123;<span class=\"string\">&#x27;src&#x27;</span>: <span class=\"string\">&#x27;../templates/network-config.j2&#x27;</span>, <span class=\"string\">&#x27;dest&#x27;</span>: <span class=\"string\">&#x27;/home/ois/data/k8s-cilium-lab/nodevm_cfg/k8s-node-3_network-config&#x27;</span>&#125;)</span><br><span class=\"line\">changed: [k8s-node-2] =&gt; (item=&#123;<span class=\"string\">&#x27;src&#x27;</span>: <span class=\"string\">&#x27;../templates/network-config.j2&#x27;</span>, <span class=\"string\">&#x27;dest&#x27;</span>: <span class=\"string\">&#x27;/home/ois/data/k8s-cilium-lab/nodevm_cfg/k8s-node-2_network-config&#x27;</span>&#125;)</span><br><span class=\"line\">changed: [k8s-node-1] =&gt; (item=&#123;<span class=\"string\">&#x27;src&#x27;</span>: <span class=\"string\">&#x27;../templates/network-config.j2&#x27;</span>, <span class=\"string\">&#x27;dest&#x27;</span>: <span class=\"string\">&#x27;/home/ois/data/k8s-cilium-lab/nodevm_cfg/k8s-node-1_network-config&#x27;</span>&#125;)</span><br><span class=\"line\">changed: [dns-bgp-server] =&gt; (item=&#123;<span class=\"string\">&#x27;src&#x27;</span>: <span class=\"string\">&#x27;../templates/network-config.j2&#x27;</span>, <span class=\"string\">&#x27;dest&#x27;</span>: <span class=\"string\">&#x27;/home/ois/data/k8s-cilium-lab/nodevm_cfg/dns-bgp-server_network-config&#x27;</span>&#125;)</span><br><span class=\"line\">changed: [k8s-node-3] =&gt; (item=&#123;<span class=\"string\">&#x27;src&#x27;</span>: <span class=\"string\">&#x27;../templates/meta-data.j2&#x27;</span>, <span class=\"string\">&#x27;dest&#x27;</span>: <span class=\"string\">&#x27;/home/ois/data/k8s-cilium-lab/nodevm_cfg/k8s-node-3_meta-data&#x27;</span>&#125;)</span><br><span class=\"line\">changed: [k8s-node-2] =&gt; (item=&#123;<span class=\"string\">&#x27;src&#x27;</span>: <span class=\"string\">&#x27;../templates/meta-data.j2&#x27;</span>, <span class=\"string\">&#x27;dest&#x27;</span>: <span class=\"string\">&#x27;/home/ois/data/k8s-cilium-lab/nodevm_cfg/k8s-node-2_meta-data&#x27;</span>&#125;)</span><br><span class=\"line\">changed: [k8s-node-1] =&gt; (item=&#123;<span class=\"string\">&#x27;src&#x27;</span>: <span class=\"string\">&#x27;../templates/meta-data.j2&#x27;</span>, <span class=\"string\">&#x27;dest&#x27;</span>: <span class=\"string\">&#x27;/home/ois/data/k8s-cilium-lab/nodevm_cfg/k8s-node-1_meta-data&#x27;</span>&#125;)</span><br><span class=\"line\">changed: [dns-bgp-server] =&gt; (item=&#123;<span class=\"string\">&#x27;src&#x27;</span>: <span class=\"string\">&#x27;../templates/meta-data.j2&#x27;</span>, <span class=\"string\">&#x27;dest&#x27;</span>: <span class=\"string\">&#x27;/home/ois/data/k8s-cilium-lab/nodevm_cfg/dns-bgp-server_meta-data&#x27;</span>&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY [Play 4 - Install VMs Sequentially to Avoid Race Condition] ***************************************************************************************************************************************</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Create and start the VM with virt-install] *******************************************************************************************************************************************************</span><br><span class=\"line\">changed: [dns-bgp-server]</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY [Play 4 - Install VMs Sequentially to Avoid Race Condition] ***************************************************************************************************************************************</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Create and start the VM with virt-install] *******************************************************************************************************************************************************</span><br><span class=\"line\">changed: [k8s-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY [Play 4 - Install VMs Sequentially to Avoid Race Condition] ***************************************************************************************************************************************</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Create and start the VM with virt-install] *******************************************************************************************************************************************************</span><br><span class=\"line\">changed: [k8s-node-2]</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY [Play 4 - Install VMs Sequentially to Avoid Race Condition] ***************************************************************************************************************************************</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Create and start the VM with virt-install] *******************************************************************************************************************************************************</span><br><span class=\"line\">changed: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY [Play 5 - Verify VM Connectivity <span class=\"keyword\">in</span> Parallel] *****************************************************************************************************************************************************</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Wait <span class=\"keyword\">for</span> VMs to boot and SSH to become available] ************************************************************************************************************************************************</span><br><span class=\"line\">ok: [dns-bgp-server -&gt; localhost]</span><br><span class=\"line\">ok: [k8s-node-1 -&gt; localhost]</span><br><span class=\"line\"><span class=\"comment\"># 10.75.59.86:22 SSH-2.0-OpenSSH_9.6p1 Ubuntu-3ubuntu13.12</span></span><br><span class=\"line\"><span class=\"comment\"># 10.75.59.81:22 SSH-2.0-OpenSSH_9.6p1 Ubuntu-3ubuntu13.12</span></span><br><span class=\"line\"><span class=\"comment\"># 10.75.59.81:22 SSH-2.0-OpenSSH_9.6p1 Ubuntu-3ubuntu13.12</span></span><br><span class=\"line\"><span class=\"comment\"># 10.75.59.86:22 SSH-2.0-OpenSSH_9.6p1 Ubuntu-3ubuntu13.12</span></span><br><span class=\"line\"><span class=\"comment\"># 10.75.59.81:22 SSH-2.0-OpenSSH_9.6p1 Ubuntu-3ubuntu13.12</span></span><br><span class=\"line\"><span class=\"comment\"># 10.75.59.81:22 SSH-2.0-OpenSSH_9.6p1 Ubuntu-3ubuntu13.12</span></span><br><span class=\"line\"><span class=\"comment\"># 10.75.59.86:22 SSH-2.0-OpenSSH_9.6p1 Ubuntu-3ubuntu13.12</span></span><br><span class=\"line\"><span class=\"comment\"># 10.75.59.81:22 SSH-2.0-OpenSSH_9.6p1 Ubuntu-3ubuntu13.12</span></span><br><span class=\"line\"><span class=\"comment\"># 10.75.59.86:22 SSH-2.0-OpenSSH_9.6p1 Ubuntu-3ubuntu13.12</span></span><br><span class=\"line\"><span class=\"comment\"># 10.75.59.86:22 SSH-2.0-OpenSSH_9.6p1 Ubuntu-3ubuntu13.12</span></span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Add host keys to known_hosts file] ***************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [k8s-node-1 -&gt; localhost]</span><br><span class=\"line\">changed: [dns-bgp-server -&gt; localhost]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Wait <span class=\"keyword\">for</span> VMs to boot and SSH to become available] ************************************************************************************************************************************************</span><br><span class=\"line\">ok: [k8s-node-3 -&gt; localhost]</span><br><span class=\"line\"><span class=\"comment\"># 10.75.59.83:22 SSH-2.0-OpenSSH_9.6p1 Ubuntu-3ubuntu13.12</span></span><br><span class=\"line\"><span class=\"comment\"># 10.75.59.83:22 SSH-2.0-OpenSSH_9.6p1 Ubuntu-3ubuntu13.12</span></span><br><span class=\"line\"><span class=\"comment\"># 10.75.59.83:22 SSH-2.0-OpenSSH_9.6p1 Ubuntu-3ubuntu13.12</span></span><br><span class=\"line\"><span class=\"comment\"># 10.75.59.83:22 SSH-2.0-OpenSSH_9.6p1 Ubuntu-3ubuntu13.12</span></span><br><span class=\"line\"><span class=\"comment\"># 10.75.59.83:22 SSH-2.0-OpenSSH_9.6p1 Ubuntu-3ubuntu13.12</span></span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Add host keys to known_hosts file] ***************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [k8s-node-3 -&gt; localhost]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Wait <span class=\"keyword\">for</span> VMs to boot and SSH to become available] ************************************************************************************************************************************************</span><br><span class=\"line\">ok: [k8s-node-2 -&gt; localhost]</span><br><span class=\"line\"><span class=\"comment\"># 10.75.59.82:22 SSH-2.0-OpenSSH_9.6p1 Ubuntu-3ubuntu13.12</span></span><br><span class=\"line\"><span class=\"comment\"># 10.75.59.82:22 SSH-2.0-OpenSSH_9.6p1 Ubuntu-3ubuntu13.12</span></span><br><span class=\"line\"><span class=\"comment\"># 10.75.59.82:22 SSH-2.0-OpenSSH_9.6p1 Ubuntu-3ubuntu13.12</span></span><br><span class=\"line\"><span class=\"comment\"># 10.75.59.82:22 SSH-2.0-OpenSSH_9.6p1 Ubuntu-3ubuntu13.12</span></span><br><span class=\"line\"><span class=\"comment\"># 10.75.59.82:22 SSH-2.0-OpenSSH_9.6p1 Ubuntu-3ubuntu13.12</span></span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Add host keys to known_hosts file] ***************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [k8s-node-2 -&gt; localhost]</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY RECAP *********************************************************************************************************************************************************************************************</span><br><span class=\"line\">dns-bgp-server             : ok=9    changed=6    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class=\"line\">k8s-node-1                 : ok=9    changed=5    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class=\"line\">k8s-node-2                 : ok=9    changed=5    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class=\"line\">k8s-node-3                 : ok=9    changed=5    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class=\"line\">localhost                  : ok=4    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br></pre></td></tr></table></figure>\n\n<p>多次运行，以测试幂等性，多次运行不影响结果，已执行过的任务会自行跳过。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ois@ois:~/data/k8s-cilium-lab$ ansible-playbook playbooks/1_create_vms.yml</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY [Play 1 - Pre-flight Check <span class=\"keyword\">for</span> Existing VMs] ******************************************************************************************************************************************************</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Check status of each VM with virsh] **************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [k8s-node-3]</span><br><span class=\"line\">ok: [k8s-node-1]</span><br><span class=\"line\">ok: [dns-bgp-server]</span><br><span class=\"line\">ok: [k8s-node-2]</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY [Play 2 - Decide <span class=\"keyword\">if</span> Provisioning is Needed] *******************************************************************************************************************************************************</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Initialize an empty list <span class=\"keyword\">for</span> missing VMs] ********************************************************************************************************************************************************</span><br><span class=\"line\">ok: [localhost]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Populate the list of missing VMs] ****************************************************************************************************************************************************************</span><br><span class=\"line\">skipping: [localhost] =&gt; (item=dns-bgp-server) </span><br><span class=\"line\">skipping: [localhost] =&gt; (item=k8s-node-1) </span><br><span class=\"line\">skipping: [localhost] =&gt; (item=k8s-node-2) </span><br><span class=\"line\">skipping: [localhost] =&gt; (item=k8s-node-3) </span><br><span class=\"line\">skipping: [localhost]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Set global flag <span class=\"keyword\">if</span> provisioning is required] *****************************************************************************************************************************************************</span><br><span class=\"line\">ok: [localhost]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Report status] ***********************************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [localhost] =&gt; &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;msg&quot;</span>: <span class=\"string\">&quot;Provisioning needed: False. Missing VMs: []&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY [Play 3 - Prepare VM Assets <span class=\"keyword\">in</span> Parallel] **********************************************************************************************************************************************************</span><br><span class=\"line\">[WARNING]: Using run_once with the free strategy is not currently supported. This task will still be executed <span class=\"keyword\">for</span> every host <span class=\"keyword\">in</span> the inventory list.</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Ensure VM directories exist] *********************************************************************************************************************************************************************</span><br><span class=\"line\">skipping: [dns-bgp-server] =&gt; (item=/home/ois/data/k8s-cilium-lab/nodevms) </span><br><span class=\"line\">skipping: [dns-bgp-server] =&gt; (item=/home/ois/data/k8s-cilium-lab/nodevm_cfg) </span><br><span class=\"line\">skipping: [k8s-node-1] =&gt; (item=/home/ois/data/k8s-cilium-lab/nodevms) </span><br><span class=\"line\">skipping: [dns-bgp-server]</span><br><span class=\"line\">skipping: [k8s-node-1] =&gt; (item=/home/ois/data/k8s-cilium-lab/nodevm_cfg) </span><br><span class=\"line\">skipping: [k8s-node-2] =&gt; (item=/home/ois/data/k8s-cilium-lab/nodevms) </span><br><span class=\"line\">skipping: [k8s-node-2] =&gt; (item=/home/ois/data/k8s-cilium-lab/nodevm_cfg) </span><br><span class=\"line\">skipping: [k8s-node-3] =&gt; (item=/home/ois/data/k8s-cilium-lab/nodevms) </span><br><span class=\"line\">skipping: [k8s-node-3] =&gt; (item=/home/ois/data/k8s-cilium-lab/nodevm_cfg) </span><br><span class=\"line\">skipping: [k8s-node-1]</span><br><span class=\"line\">skipping: [k8s-node-2]</span><br><span class=\"line\">skipping: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Check <span class=\"keyword\">if</span> VM disk image already exists] ***********************************************************************************************************************************************************</span><br><span class=\"line\">skipping: [dns-bgp-server]</span><br><span class=\"line\">skipping: [k8s-node-1]</span><br><span class=\"line\">skipping: [k8s-node-2]</span><br><span class=\"line\">skipping: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Create VM disk image from base image] ************************************************************************************************************************************************************</span><br><span class=\"line\">skipping: [dns-bgp-server]</span><br><span class=\"line\">skipping: [k8s-node-1]</span><br><span class=\"line\">skipping: [k8s-node-2]</span><br><span class=\"line\">skipping: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Resize VM disk image] ****************************************************************************************************************************************************************************</span><br><span class=\"line\">skipping: [dns-bgp-server]</span><br><span class=\"line\">skipping: [k8s-node-1]</span><br><span class=\"line\">skipping: [k8s-node-2]</span><br><span class=\"line\">skipping: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Generate cloud-init files] ***********************************************************************************************************************************************************************</span><br><span class=\"line\">skipping: [k8s-node-1] =&gt; (item=&#123;<span class=\"string\">&#x27;src&#x27;</span>: <span class=\"string\">&#x27;../templates/user-data.j2&#x27;</span>, <span class=\"string\">&#x27;dest&#x27;</span>: <span class=\"string\">&#x27;/home/ois/data/k8s-cilium-lab/nodevm_cfg/k8s-node-1_user-data&#x27;</span>&#125;) </span><br><span class=\"line\">skipping: [k8s-node-1] =&gt; (item=&#123;<span class=\"string\">&#x27;src&#x27;</span>: <span class=\"string\">&#x27;../templates/network-config.j2&#x27;</span>, <span class=\"string\">&#x27;dest&#x27;</span>: <span class=\"string\">&#x27;/home/ois/data/k8s-cilium-lab/nodevm_cfg/k8s-node-1_network-config&#x27;</span>&#125;) </span><br><span class=\"line\">skipping: [k8s-node-2] =&gt; (item=&#123;<span class=\"string\">&#x27;src&#x27;</span>: <span class=\"string\">&#x27;../templates/user-data.j2&#x27;</span>, <span class=\"string\">&#x27;dest&#x27;</span>: <span class=\"string\">&#x27;/home/ois/data/k8s-cilium-lab/nodevm_cfg/k8s-node-2_user-data&#x27;</span>&#125;) </span><br><span class=\"line\">skipping: [k8s-node-1] =&gt; (item=&#123;<span class=\"string\">&#x27;src&#x27;</span>: <span class=\"string\">&#x27;../templates/meta-data.j2&#x27;</span>, <span class=\"string\">&#x27;dest&#x27;</span>: <span class=\"string\">&#x27;/home/ois/data/k8s-cilium-lab/nodevm_cfg/k8s-node-1_meta-data&#x27;</span>&#125;) </span><br><span class=\"line\">skipping: [k8s-node-1]</span><br><span class=\"line\">skipping: [k8s-node-2] =&gt; (item=&#123;<span class=\"string\">&#x27;src&#x27;</span>: <span class=\"string\">&#x27;../templates/network-config.j2&#x27;</span>, <span class=\"string\">&#x27;dest&#x27;</span>: <span class=\"string\">&#x27;/home/ois/data/k8s-cilium-lab/nodevm_cfg/k8s-node-2_network-config&#x27;</span>&#125;) </span><br><span class=\"line\">skipping: [dns-bgp-server] =&gt; (item=&#123;<span class=\"string\">&#x27;src&#x27;</span>: <span class=\"string\">&#x27;../templates/user-data.j2&#x27;</span>, <span class=\"string\">&#x27;dest&#x27;</span>: <span class=\"string\">&#x27;/home/ois/data/k8s-cilium-lab/nodevm_cfg/dns-bgp-server_user-data&#x27;</span>&#125;) </span><br><span class=\"line\">skipping: [k8s-node-2] =&gt; (item=&#123;<span class=\"string\">&#x27;src&#x27;</span>: <span class=\"string\">&#x27;../templates/meta-data.j2&#x27;</span>, <span class=\"string\">&#x27;dest&#x27;</span>: <span class=\"string\">&#x27;/home/ois/data/k8s-cilium-lab/nodevm_cfg/k8s-node-2_meta-data&#x27;</span>&#125;) </span><br><span class=\"line\">skipping: [k8s-node-2]</span><br><span class=\"line\">skipping: [dns-bgp-server] =&gt; (item=&#123;<span class=\"string\">&#x27;src&#x27;</span>: <span class=\"string\">&#x27;../templates/network-config.j2&#x27;</span>, <span class=\"string\">&#x27;dest&#x27;</span>: <span class=\"string\">&#x27;/home/ois/data/k8s-cilium-lab/nodevm_cfg/dns-bgp-server_network-config&#x27;</span>&#125;) </span><br><span class=\"line\">skipping: [dns-bgp-server] =&gt; (item=&#123;<span class=\"string\">&#x27;src&#x27;</span>: <span class=\"string\">&#x27;../templates/meta-data.j2&#x27;</span>, <span class=\"string\">&#x27;dest&#x27;</span>: <span class=\"string\">&#x27;/home/ois/data/k8s-cilium-lab/nodevm_cfg/dns-bgp-server_meta-data&#x27;</span>&#125;) </span><br><span class=\"line\">skipping: [k8s-node-3] =&gt; (item=&#123;<span class=\"string\">&#x27;src&#x27;</span>: <span class=\"string\">&#x27;../templates/user-data.j2&#x27;</span>, <span class=\"string\">&#x27;dest&#x27;</span>: <span class=\"string\">&#x27;/home/ois/data/k8s-cilium-lab/nodevm_cfg/k8s-node-3_user-data&#x27;</span>&#125;) </span><br><span class=\"line\">skipping: [dns-bgp-server]</span><br><span class=\"line\">skipping: [k8s-node-3] =&gt; (item=&#123;<span class=\"string\">&#x27;src&#x27;</span>: <span class=\"string\">&#x27;../templates/network-config.j2&#x27;</span>, <span class=\"string\">&#x27;dest&#x27;</span>: <span class=\"string\">&#x27;/home/ois/data/k8s-cilium-lab/nodevm_cfg/k8s-node-3_network-config&#x27;</span>&#125;) </span><br><span class=\"line\">skipping: [k8s-node-3] =&gt; (item=&#123;<span class=\"string\">&#x27;src&#x27;</span>: <span class=\"string\">&#x27;../templates/meta-data.j2&#x27;</span>, <span class=\"string\">&#x27;dest&#x27;</span>: <span class=\"string\">&#x27;/home/ois/data/k8s-cilium-lab/nodevm_cfg/k8s-node-3_meta-data&#x27;</span>&#125;) </span><br><span class=\"line\">skipping: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY [Play 4 - Install VMs Sequentially to Avoid Race Condition] ***************************************************************************************************************************************</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Create and start the VM with virt-install] *******************************************************************************************************************************************************</span><br><span class=\"line\">skipping: [dns-bgp-server]</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY [Play 4 - Install VMs Sequentially to Avoid Race Condition] ***************************************************************************************************************************************</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Create and start the VM with virt-install] *******************************************************************************************************************************************************</span><br><span class=\"line\">skipping: [k8s-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY [Play 4 - Install VMs Sequentially to Avoid Race Condition] ***************************************************************************************************************************************</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Create and start the VM with virt-install] *******************************************************************************************************************************************************</span><br><span class=\"line\">skipping: [k8s-node-2]</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY [Play 4 - Install VMs Sequentially to Avoid Race Condition] ***************************************************************************************************************************************</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Create and start the VM with virt-install] *******************************************************************************************************************************************************</span><br><span class=\"line\">skipping: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY [Play 5 - Verify VM Connectivity <span class=\"keyword\">in</span> Parallel] *****************************************************************************************************************************************************</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Wait <span class=\"keyword\">for</span> VMs to boot and SSH to become available] ************************************************************************************************************************************************</span><br><span class=\"line\">skipping: [dns-bgp-server]</span><br><span class=\"line\">skipping: [k8s-node-1]</span><br><span class=\"line\">skipping: [k8s-node-2]</span><br><span class=\"line\">skipping: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Add host keys to known_hosts file] ***************************************************************************************************************************************************************</span><br><span class=\"line\">skipping: [dns-bgp-server]</span><br><span class=\"line\">skipping: [k8s-node-1]</span><br><span class=\"line\">skipping: [k8s-node-2]</span><br><span class=\"line\">skipping: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY RECAP *********************************************************************************************************************************************************************************************</span><br><span class=\"line\">dns-bgp-server             : ok=1    changed=0    unreachable=0    failed=0    skipped=8    rescued=0    ignored=0   </span><br><span class=\"line\">k8s-node-1                 : ok=1    changed=0    unreachable=0    failed=0    skipped=8    rescued=0    ignored=0   </span><br><span class=\"line\">k8s-node-2                 : ok=1    changed=0    unreachable=0    failed=0    skipped=8    rescued=0    ignored=0   </span><br><span class=\"line\">k8s-node-3                 : ok=1    changed=0    unreachable=0    failed=0    skipped=8    rescued=0    ignored=0   </span><br><span class=\"line\">localhost                  : ok=3    changed=0    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   </span><br></pre></td></tr></table></figure>\n\n<h1 id=\"5-生成Playbook以便安装Containerd和K8S工具\"><a href=\"#5-生成Playbook以便安装Containerd和K8S工具\" class=\"headerlink\" title=\"5. 生成Playbook以便安装Containerd和K8S工具\"></a>5. 生成Playbook以便安装Containerd和K8S工具</h1><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ois@ois:~/data/k8s-cilium-lab$ <span class=\"built_in\">cd</span> ..</span><br><span class=\"line\">ois@ois:~/data$ ./02-prepare-nodes.sh </span><br><span class=\"line\">--- Node Preparation Playbook Generator (with cloud-init <span class=\"built_in\">wait</span>) ---</span><br><span class=\"line\"></span><br><span class=\"line\">--- Step 1: Verifying Project Context ---</span><br><span class=\"line\">✅ Working inside project directory: /home/ois/data/k8s-cilium-lab</span><br><span class=\"line\"></span><br><span class=\"line\">--- Step 2: Ensuring Role Directories Exist ---</span><br><span class=\"line\">✅ Role directories created.</span><br><span class=\"line\"></span><br><span class=\"line\">--- Step 3: Generating Role Task Files ---</span><br><span class=\"line\">✅ Created tasks <span class=\"keyword\">for</span> <span class=\"string\">&#x27;common&#x27;</span> role.</span><br><span class=\"line\">✅ Created tasks <span class=\"keyword\">for</span> <span class=\"string\">&#x27;k8s_node&#x27;</span> role.</span><br><span class=\"line\">✅ Created tasks <span class=\"keyword\">for</span> <span class=\"string\">&#x27;infra_server&#x27;</span> role.</span><br><span class=\"line\"></span><br><span class=\"line\">--- Step 4: Generating Config Templates ---</span><br><span class=\"line\">✅ Created /etc/hosts template.</span><br><span class=\"line\">✅ Created containerd config template.</span><br><span class=\"line\">✅ Created FRR config template.</span><br><span class=\"line\"></span><br><span class=\"line\">--- Step 5: Generating Main Playbook ---</span><br><span class=\"line\">✅ Created main playbook: playbooks/2_prepare_nodes.yml</span><br><span class=\"line\"></span><br><span class=\"line\">--- Generation Complete! ---</span><br><span class=\"line\">✅ All necessary files <span class=\"keyword\">for</span> node preparation have been created.</span><br><span class=\"line\"></span><br><span class=\"line\">Next Step:</span><br><span class=\"line\">1. Change into the project directory: <span class=\"built_in\">cd</span> k8s-cilium-lab</span><br><span class=\"line\">2. Run the playbook to prepare your nodes. You will be prompted <span class=\"keyword\">for</span> the <span class=\"built_in\">sudo</span> password:</span><br><span class=\"line\">   ansible-playbook playbooks/2_prepare_nodes.yml --ask-become-pass</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"6-执行Playbook，安装Containerd和K8S工具\"><a href=\"#6-执行Playbook，安装Containerd和K8S工具\" class=\"headerlink\" title=\"6. 执行Playbook，安装Containerd和K8S工具\"></a>6. 执行Playbook，安装Containerd和K8S工具</h1><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ois@ois:~/data$ <span class=\"built_in\">cd</span> k8s-cilium-lab/</span><br><span class=\"line\">ois@ois:~/data/k8s-cilium-lab$ ansible-playbook playbooks/2_prepare_nodes.yml --ask-become-pass</span><br><span class=\"line\">BECOME password: </span><br><span class=\"line\"></span><br><span class=\"line\">PLAY [Play 1 - Prepare All Nodes] **********************************************************************************************************************************************************************</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Gathering Facts] *********************************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [dns-bgp-server]</span><br><span class=\"line\">ok: [k8s-node-3]</span><br><span class=\"line\">ok: [k8s-node-2]</span><br><span class=\"line\">ok: [k8s-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common : Wait <span class=\"keyword\">for</span> cloud-init to complete] ********************************************************************************************************************************************************</span><br><span class=\"line\">ok: [dns-bgp-server]</span><br><span class=\"line\">ok: [k8s-node-2]</span><br><span class=\"line\">ok: [k8s-node-3]</span><br><span class=\"line\">ok: [k8s-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common : Update apt cache and upgrade all packages] **********************************************************************************************************************************************</span><br><span class=\"line\">changed: [dns-bgp-server]</span><br><span class=\"line\">changed: [k8s-node-3]</span><br><span class=\"line\">changed: [k8s-node-1]</span><br><span class=\"line\">changed: [k8s-node-2]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common : Configure /etc/hosts from template] *****************************************************************************************************************************************************</span><br><span class=\"line\">changed: [k8s-node-2]</span><br><span class=\"line\">changed: [dns-bgp-server]</span><br><span class=\"line\">changed: [k8s-node-3]</span><br><span class=\"line\">changed: [k8s-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common : Turn off all swap devices] **************************************************************************************************************************************************************</span><br><span class=\"line\">skipping: [dns-bgp-server]</span><br><span class=\"line\">skipping: [k8s-node-1]</span><br><span class=\"line\">skipping: [k8s-node-2]</span><br><span class=\"line\">skipping: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common : Comment out swap entries <span class=\"keyword\">in</span> /etc/fstab] *************************************************************************************************************************************************</span><br><span class=\"line\">skipping: [dns-bgp-server]</span><br><span class=\"line\">skipping: [k8s-node-1]</span><br><span class=\"line\">skipping: [k8s-node-2]</span><br><span class=\"line\">skipping: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common : Load required kernel modules] ***********************************************************************************************************************************************************</span><br><span class=\"line\">changed: [dns-bgp-server] =&gt; (item=overlay)</span><br><span class=\"line\">changed: [k8s-node-1] =&gt; (item=overlay)</span><br><span class=\"line\">changed: [k8s-node-2] =&gt; (item=overlay)</span><br><span class=\"line\">changed: [k8s-node-3] =&gt; (item=overlay)</span><br><span class=\"line\">changed: [k8s-node-2] =&gt; (item=br_netfilter)</span><br><span class=\"line\">changed: [dns-bgp-server] =&gt; (item=br_netfilter)</span><br><span class=\"line\">changed: [k8s-node-1] =&gt; (item=br_netfilter)</span><br><span class=\"line\">changed: [k8s-node-3] =&gt; (item=br_netfilter)</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common : Ensure kernel modules are loaded on boot] ***********************************************************************************************************************************************</span><br><span class=\"line\">changed: [dns-bgp-server]</span><br><span class=\"line\">changed: [k8s-node-1]</span><br><span class=\"line\">changed: [k8s-node-3]</span><br><span class=\"line\">changed: [k8s-node-2]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common : Configure sysctl parameters <span class=\"keyword\">for</span> Kubernetes networking] **********************************************************************************************************************************</span><br><span class=\"line\">changed: [dns-bgp-server]</span><br><span class=\"line\">changed: [k8s-node-1]</span><br><span class=\"line\">changed: [k8s-node-3]</span><br><span class=\"line\">changed: [k8s-node-2]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common : Apply sysctl settings without reboot] ***************************************************************************************************************************************************</span><br><span class=\"line\">ok: [dns-bgp-server]</span><br><span class=\"line\">ok: [k8s-node-1]</span><br><span class=\"line\">ok: [k8s-node-3]</span><br><span class=\"line\">ok: [k8s-node-2]</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY [Play 2 - Prepare Kubernetes Nodes] ***************************************************************************************************************************************************************</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Gathering Facts] *********************************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [k8s-node-3]</span><br><span class=\"line\">ok: [k8s-node-1]</span><br><span class=\"line\">ok: [k8s-node-2]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [k8s_node : Install prerequisite packages] ********************************************************************************************************************************************************</span><br><span class=\"line\">ok: [k8s-node-1]</span><br><span class=\"line\">ok: [k8s-node-2]</span><br><span class=\"line\">ok: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [k8s_node : Ensure apt keyrings directory exists] *************************************************************************************************************************************************</span><br><span class=\"line\">ok: [k8s-node-1]</span><br><span class=\"line\">ok: [k8s-node-3]</span><br><span class=\"line\">ok: [k8s-node-2]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [k8s_node : Add Docker<span class=\"string\">&#x27;s official GPG key] ********************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">changed: [k8s-node-2]</span></span><br><span class=\"line\"><span class=\"string\">changed: [k8s-node-3]</span></span><br><span class=\"line\"><span class=\"string\">changed: [k8s-node-1]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">TASK [k8s_node : Add Docker&#x27;</span>s repository to Apt sources] ***********************************************************************************************************************************************</span><br><span class=\"line\">changed: [k8s-node-2]</span><br><span class=\"line\">changed: [k8s-node-1]</span><br><span class=\"line\">changed: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [k8s_node : Install containerd] *******************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [k8s-node-1]</span><br><span class=\"line\">changed: [k8s-node-2]</span><br><span class=\"line\">changed: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [k8s_node : Configure containerd from template] ***************************************************************************************************************************************************</span><br><span class=\"line\">changed: [k8s-node-1]</span><br><span class=\"line\">changed: [k8s-node-2]</span><br><span class=\"line\">changed: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [k8s_node : Install prerequisite packages <span class=\"keyword\">for</span> Kubernetes repo] ************************************************************************************************************************************</span><br><span class=\"line\">changed: [k8s-node-2]</span><br><span class=\"line\">changed: [k8s-node-3]</span><br><span class=\"line\">changed: [k8s-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [k8s_node : Download the Kubernetes public signing key] *******************************************************************************************************************************************</span><br><span class=\"line\">changed: [k8s-node-2]</span><br><span class=\"line\">changed: [k8s-node-1]</span><br><span class=\"line\">changed: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [k8s_node : Dearmor the Kubernetes GPG key] *******************************************************************************************************************************************************</span><br><span class=\"line\">changed: [k8s-node-1]</span><br><span class=\"line\">changed: [k8s-node-2]</span><br><span class=\"line\">changed: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [k8s_node : Add Kubernetes APT repository] ********************************************************************************************************************************************************</span><br><span class=\"line\">changed: [k8s-node-2]</span><br><span class=\"line\">changed: [k8s-node-1]</span><br><span class=\"line\">changed: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [k8s_node : Clean up temporary key file] **********************************************************************************************************************************************************</span><br><span class=\"line\">changed: [k8s-node-1]</span><br><span class=\"line\">changed: [k8s-node-2]</span><br><span class=\"line\">changed: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [k8s_node : Install kubelet, kubeadm, and kubectl] ************************************************************************************************************************************************</span><br><span class=\"line\">changed: [k8s-node-3]</span><br><span class=\"line\">changed: [k8s-node-1]</span><br><span class=\"line\">changed: [k8s-node-2]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [k8s_node : Pin Kubernetes package versions] ******************************************************************************************************************************************************</span><br><span class=\"line\">changed: [k8s-node-2] =&gt; (item=kubelet)</span><br><span class=\"line\">changed: [k8s-node-3] =&gt; (item=kubelet)</span><br><span class=\"line\">changed: [k8s-node-1] =&gt; (item=kubelet)</span><br><span class=\"line\">changed: [k8s-node-2] =&gt; (item=kubeadm)</span><br><span class=\"line\">changed: [k8s-node-1] =&gt; (item=kubeadm)</span><br><span class=\"line\">changed: [k8s-node-3] =&gt; (item=kubeadm)</span><br><span class=\"line\">changed: [k8s-node-2] =&gt; (item=kubectl)</span><br><span class=\"line\">changed: [k8s-node-3] =&gt; (item=kubectl)</span><br><span class=\"line\">changed: [k8s-node-1] =&gt; (item=kubectl)</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [k8s_node : Enable and start kubelet service] *****************************************************************************************************************************************************</span><br><span class=\"line\">changed: [k8s-node-2]</span><br><span class=\"line\">changed: [k8s-node-3]</span><br><span class=\"line\">changed: [k8s-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">RUNNING HANDLER [Restart containerd] *******************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [k8s-node-2]</span><br><span class=\"line\">changed: [k8s-node-1]</span><br><span class=\"line\">changed: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY [Play 3 - Prepare Infrastructure Server] **********************************************************************************************************************************************************</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Gathering Facts] *********************************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [dns-bgp-server]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [infra_server : Install dnsmasq and FRR] **********************************************************************************************************************************************************</span><br><span class=\"line\">changed: [dns-bgp-server]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [infra_server : Configure dnsmasq] ****************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [dns-bgp-server]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [infra_server : Configure FRR daemons] ************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [dns-bgp-server] =&gt; (item=zebra)</span><br><span class=\"line\">changed: [dns-bgp-server] =&gt; (item=bgpd)</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [infra_server : Configure frr.conf] ***************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [dns-bgp-server]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [infra_server : Ensure FRR config has correct permissions] ****************************************************************************************************************************************</span><br><span class=\"line\">ok: [dns-bgp-server]</span><br><span class=\"line\"></span><br><span class=\"line\">RUNNING HANDLER [Restart dnsmasq] **********************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [dns-bgp-server]</span><br><span class=\"line\"></span><br><span class=\"line\">RUNNING HANDLER [Restart frr] **************************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [dns-bgp-server]</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY RECAP *********************************************************************************************************************************************************************************************</span><br><span class=\"line\">dns-bgp-server             : ok=16   changed=11   unreachable=0    failed=0    skipped=2    rescued=0    ignored=0   </span><br><span class=\"line\">k8s-node-1                 : ok=24   changed=18   unreachable=0    failed=0    skipped=2    rescued=0    ignored=0   </span><br><span class=\"line\">k8s-node-2                 : ok=24   changed=18   unreachable=0    failed=0    skipped=2    rescued=0    ignored=0   </span><br><span class=\"line\">k8s-node-3                 : ok=24   changed=18   unreachable=0    failed=0    skipped=2    rescued=0    ignored=0   </span><br></pre></td></tr></table></figure>\n\n<p>多次执行Playbook，验证幂等性</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ois@ois:~/data/k8s-cilium-lab$ ansible-playbook playbooks/2_prepare_nodes.yml --ask-become-pass</span><br><span class=\"line\">BECOME password: </span><br><span class=\"line\"></span><br><span class=\"line\">PLAY [Play 1 - Prepare All Nodes] **********************************************************************************************************************************************************************</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Gathering Facts] *********************************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [k8s-node-2]</span><br><span class=\"line\">ok: [dns-bgp-server]</span><br><span class=\"line\">ok: [k8s-node-3]</span><br><span class=\"line\">ok: [k8s-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common : Wait <span class=\"keyword\">for</span> cloud-init to complete] ********************************************************************************************************************************************************</span><br><span class=\"line\">ok: [k8s-node-1]</span><br><span class=\"line\">ok: [dns-bgp-server]</span><br><span class=\"line\">ok: [k8s-node-2]</span><br><span class=\"line\">ok: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common : Update apt cache and upgrade all packages] **********************************************************************************************************************************************</span><br><span class=\"line\">ok: [dns-bgp-server]</span><br><span class=\"line\">ok: [k8s-node-2]</span><br><span class=\"line\">ok: [k8s-node-3]</span><br><span class=\"line\">ok: [k8s-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common : Configure /etc/hosts from template] *****************************************************************************************************************************************************</span><br><span class=\"line\">ok: [k8s-node-1]</span><br><span class=\"line\">ok: [k8s-node-3]</span><br><span class=\"line\">ok: [dns-bgp-server]</span><br><span class=\"line\">ok: [k8s-node-2]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common : Turn off all swap devices] **************************************************************************************************************************************************************</span><br><span class=\"line\">skipping: [dns-bgp-server]</span><br><span class=\"line\">skipping: [k8s-node-1]</span><br><span class=\"line\">skipping: [k8s-node-2]</span><br><span class=\"line\">skipping: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common : Comment out swap entries <span class=\"keyword\">in</span> /etc/fstab] *************************************************************************************************************************************************</span><br><span class=\"line\">skipping: [dns-bgp-server]</span><br><span class=\"line\">skipping: [k8s-node-1]</span><br><span class=\"line\">skipping: [k8s-node-2]</span><br><span class=\"line\">skipping: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common : Load required kernel modules] ***********************************************************************************************************************************************************</span><br><span class=\"line\">ok: [k8s-node-2] =&gt; (item=overlay)</span><br><span class=\"line\">ok: [dns-bgp-server] =&gt; (item=overlay)</span><br><span class=\"line\">ok: [k8s-node-3] =&gt; (item=overlay)</span><br><span class=\"line\">ok: [k8s-node-1] =&gt; (item=overlay)</span><br><span class=\"line\">ok: [k8s-node-2] =&gt; (item=br_netfilter)</span><br><span class=\"line\">ok: [dns-bgp-server] =&gt; (item=br_netfilter)</span><br><span class=\"line\">ok: [k8s-node-3] =&gt; (item=br_netfilter)</span><br><span class=\"line\">ok: [k8s-node-1] =&gt; (item=br_netfilter)</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common : Ensure kernel modules are loaded on boot] ***********************************************************************************************************************************************</span><br><span class=\"line\">ok: [k8s-node-1]</span><br><span class=\"line\">ok: [dns-bgp-server]</span><br><span class=\"line\">ok: [k8s-node-2]</span><br><span class=\"line\">ok: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common : Configure sysctl parameters <span class=\"keyword\">for</span> Kubernetes networking] **********************************************************************************************************************************</span><br><span class=\"line\">ok: [dns-bgp-server]</span><br><span class=\"line\">ok: [k8s-node-1]</span><br><span class=\"line\">ok: [k8s-node-2]</span><br><span class=\"line\">ok: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common : Apply sysctl settings without reboot] ***************************************************************************************************************************************************</span><br><span class=\"line\">ok: [dns-bgp-server]</span><br><span class=\"line\">ok: [k8s-node-1]</span><br><span class=\"line\">ok: [k8s-node-2]</span><br><span class=\"line\">ok: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY [Play 2 - Prepare Kubernetes Nodes] ***************************************************************************************************************************************************************</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Gathering Facts] *********************************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [k8s-node-2]</span><br><span class=\"line\">ok: [k8s-node-1]</span><br><span class=\"line\">ok: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [k8s_node : Install prerequisite packages] ********************************************************************************************************************************************************</span><br><span class=\"line\">ok: [k8s-node-1]</span><br><span class=\"line\">ok: [k8s-node-2]</span><br><span class=\"line\">ok: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [k8s_node : Ensure apt keyrings directory exists] *************************************************************************************************************************************************</span><br><span class=\"line\">ok: [k8s-node-1]</span><br><span class=\"line\">ok: [k8s-node-2]</span><br><span class=\"line\">ok: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [k8s_node : Add Docker<span class=\"string\">&#x27;s official GPG key] ********************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">ok: [k8s-node-1]</span></span><br><span class=\"line\"><span class=\"string\">ok: [k8s-node-2]</span></span><br><span class=\"line\"><span class=\"string\">ok: [k8s-node-3]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">TASK [k8s_node : Add Docker&#x27;</span>s repository to Apt sources] ***********************************************************************************************************************************************</span><br><span class=\"line\">ok: [k8s-node-2]</span><br><span class=\"line\">ok: [k8s-node-1]</span><br><span class=\"line\">ok: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [k8s_node : Install containerd] *******************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [k8s-node-2]</span><br><span class=\"line\">ok: [k8s-node-1]</span><br><span class=\"line\">ok: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [k8s_node : Configure containerd from template] ***************************************************************************************************************************************************</span><br><span class=\"line\">ok: [k8s-node-1]</span><br><span class=\"line\">ok: [k8s-node-2]</span><br><span class=\"line\">ok: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [k8s_node : Install prerequisite packages <span class=\"keyword\">for</span> Kubernetes repo] ************************************************************************************************************************************</span><br><span class=\"line\">ok: [k8s-node-2]</span><br><span class=\"line\">ok: [k8s-node-1]</span><br><span class=\"line\">ok: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [k8s_node : Download the Kubernetes public signing key] *******************************************************************************************************************************************</span><br><span class=\"line\">changed: [k8s-node-2]</span><br><span class=\"line\">changed: [k8s-node-1]</span><br><span class=\"line\">changed: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [k8s_node : Dearmor the Kubernetes GPG key] *******************************************************************************************************************************************************</span><br><span class=\"line\">ok: [k8s-node-1]</span><br><span class=\"line\">ok: [k8s-node-2]</span><br><span class=\"line\">ok: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [k8s_node : Add Kubernetes APT repository] ********************************************************************************************************************************************************</span><br><span class=\"line\">ok: [k8s-node-1]</span><br><span class=\"line\">ok: [k8s-node-2]</span><br><span class=\"line\">ok: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [k8s_node : Clean up temporary key file] **********************************************************************************************************************************************************</span><br><span class=\"line\">changed: [k8s-node-1]</span><br><span class=\"line\">changed: [k8s-node-2]</span><br><span class=\"line\">changed: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [k8s_node : Install kubelet, kubeadm, and kubectl] ************************************************************************************************************************************************</span><br><span class=\"line\">ok: [k8s-node-1]</span><br><span class=\"line\">ok: [k8s-node-2]</span><br><span class=\"line\">ok: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [k8s_node : Pin Kubernetes package versions] ******************************************************************************************************************************************************</span><br><span class=\"line\">ok: [k8s-node-1] =&gt; (item=kubelet)</span><br><span class=\"line\">ok: [k8s-node-2] =&gt; (item=kubelet)</span><br><span class=\"line\">ok: [k8s-node-3] =&gt; (item=kubelet)</span><br><span class=\"line\">ok: [k8s-node-1] =&gt; (item=kubeadm)</span><br><span class=\"line\">ok: [k8s-node-2] =&gt; (item=kubeadm)</span><br><span class=\"line\">ok: [k8s-node-3] =&gt; (item=kubeadm)</span><br><span class=\"line\">ok: [k8s-node-1] =&gt; (item=kubectl)</span><br><span class=\"line\">ok: [k8s-node-2] =&gt; (item=kubectl)</span><br><span class=\"line\">ok: [k8s-node-3] =&gt; (item=kubectl)</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [k8s_node : Enable and start kubelet service] *****************************************************************************************************************************************************</span><br><span class=\"line\">ok: [k8s-node-1]</span><br><span class=\"line\">ok: [k8s-node-2]</span><br><span class=\"line\">ok: [k8s-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY [Play 3 - Prepare Infrastructure Server] **********************************************************************************************************************************************************</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Gathering Facts] *********************************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [dns-bgp-server]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [infra_server : Install dnsmasq and FRR] **********************************************************************************************************************************************************</span><br><span class=\"line\">ok: [dns-bgp-server]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [infra_server : Configure dnsmasq] ****************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [dns-bgp-server]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [infra_server : Configure FRR daemons] ************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [dns-bgp-server] =&gt; (item=zebra)</span><br><span class=\"line\">ok: [dns-bgp-server] =&gt; (item=bgpd)</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [infra_server : Configure frr.conf] ***************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [dns-bgp-server]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [infra_server : Ensure FRR config has correct permissions] ****************************************************************************************************************************************</span><br><span class=\"line\">ok: [dns-bgp-server]</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY RECAP *********************************************************************************************************************************************************************************************</span><br><span class=\"line\">dns-bgp-server             : ok=14   changed=0    unreachable=0    failed=0    skipped=2    rescued=0    ignored=0   </span><br><span class=\"line\">k8s-node-1                 : ok=23   changed=2    unreachable=0    failed=0    skipped=2    rescued=0    ignored=0   </span><br><span class=\"line\">k8s-node-2                 : ok=23   changed=2    unreachable=0    failed=0    skipped=2    rescued=0    ignored=0   </span><br><span class=\"line\">k8s-node-3                 : ok=23   changed=2    unreachable=0    failed=0    skipped=2    rescued=0    ignored=0   </span><br></pre></td></tr></table></figure>\n\n<h1 id=\"7-执行脚本，构建设置K8S-Cluster的Playbook\"><a href=\"#7-执行脚本，构建设置K8S-Cluster的Playbook\" class=\"headerlink\" title=\"7. 执行脚本，构建设置K8S Cluster的Playbook\"></a>7. 执行脚本，构建设置K8S Cluster的Playbook</h1><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ois@ois:~/data/k8s-cilium-lab$ <span class=\"built_in\">cd</span> ..</span><br><span class=\"line\">ois@ois:~/data$ ./03-setup-cluster.sh </span><br><span class=\"line\">--- Kubernetes Cluster Setup Playbook Generator ---</span><br><span class=\"line\"></span><br><span class=\"line\">--- Step 1: Verifying Project Context ---</span><br><span class=\"line\">✅ Working inside project directory: /home/ois/data/k8s-cilium-lab</span><br><span class=\"line\"></span><br><span class=\"line\">--- Step 2: Checking <span class=\"keyword\">for</span> <span class=\"string\">&#x27;community.kubernetes&#x27;</span> Ansible Collection ---</span><br><span class=\"line\">✅ <span class=\"string\">&#x27;community.kubernetes&#x27;</span> collection is already installed.</span><br><span class=\"line\"></span><br><span class=\"line\">--- Step 3: Generating Cilium BGP Template ---</span><br><span class=\"line\">✅ Created Cilium BGP config template.</span><br><span class=\"line\"></span><br><span class=\"line\">--- Step 4: Generating Main Playbook ---</span><br><span class=\"line\">✅ Created main playbook: playbooks/3_setup_cluster.yml</span><br><span class=\"line\"></span><br><span class=\"line\">--- Generation Complete! ---</span><br><span class=\"line\">✅ All necessary files <span class=\"keyword\">for</span> cluster setup have been created.</span><br><span class=\"line\"></span><br><span class=\"line\">Next Step:</span><br><span class=\"line\">1. IMPORTANT: Reset your cluster nodes to ensure a clean state <span class=\"keyword\">for</span> this new workflow.</span><br><span class=\"line\">   On each K8s VM, run: <span class=\"built_in\">sudo</span> kubeadm reset -f</span><br><span class=\"line\">2. Change into the project directory: <span class=\"built_in\">cd</span> k8s-cilium-lab</span><br><span class=\"line\">3. Run the playbook to build your Kubernetes cluster. You will be prompted <span class=\"keyword\">for</span> the <span class=\"built_in\">sudo</span> password:</span><br><span class=\"line\">   ansible-playbook playbooks/3_setup_cluster.yml --ask-become-pass</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"8-执行Playbook-设置K8S-Cluster和Clium\"><a href=\"#8-执行Playbook-设置K8S-Cluster和Clium\" class=\"headerlink\" title=\"8. 执行Playbook 设置K8S Cluster和Clium\"></a>8. 执行Playbook 设置K8S Cluster和Clium</h1><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ois@ois:~/data$ <span class=\"built_in\">cd</span> k8s-cilium-lab/</span><br><span class=\"line\">ois@ois:~/data/k8s-cilium-lab$ ansible-playbook playbooks/3_setup_cluster.yml --ask-become-pass</span><br><span class=\"line\">BECOME password: </span><br><span class=\"line\">[DEPRECATION WARNING]: community.kubernetes.helm_repository has been deprecated. The community.kubernetes collection is being renamed to kubernetes.core. Please update your FQCNs to kubernetes.core </span><br><span class=\"line\">instead. This feature will be removed from community.kubernetes <span class=\"keyword\">in</span> version 3.0.0. Deprecation warnings can be disabled by setting deprecation_warnings=False <span class=\"keyword\">in</span> ansible.cfg.</span><br><span class=\"line\">[DEPRECATION WARNING]: community.kubernetes.helm has been deprecated. The community.kubernetes collection is being renamed to kubernetes.core. Please update your FQCNs to kubernetes.core instead. </span><br><span class=\"line\">This feature will be removed from community.kubernetes <span class=\"keyword\">in</span> version 3.0.0. Deprecation warnings can be disabled by setting deprecation_warnings=False <span class=\"keyword\">in</span> ansible.cfg.</span><br><span class=\"line\">[DEPRECATION WARNING]: community.kubernetes.k8s has been deprecated. The community.kubernetes collection is being renamed to kubernetes.core. Please update your FQCNs to kubernetes.core instead. This</span><br><span class=\"line\"> feature will be removed from community.kubernetes <span class=\"keyword\">in</span> version 3.0.0. Deprecation warnings can be disabled by setting deprecation_warnings=False <span class=\"keyword\">in</span> ansible.cfg.</span><br><span class=\"line\">[DEPRECATION WARNING]: community.kubernetes.k8s_info has been deprecated. The community.kubernetes collection is being renamed to kubernetes.core. Please update your FQCNs to kubernetes.core instead.</span><br><span class=\"line\"> This feature will be removed from community.kubernetes <span class=\"keyword\">in</span> version 3.0.0. Deprecation warnings can be disabled by setting deprecation_warnings=False <span class=\"keyword\">in</span> ansible.cfg.</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY [Play 1 - Initialize and Configure Control Plane] *************************************************************************************************************************************************</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Gathering Facts] *********************************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [k8s-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Check <span class=\"keyword\">if</span> cluster is already initialized] *********************************************************************************************************************************************************</span><br><span class=\"line\">ok: [k8s-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Initialize the cluster] **************************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [k8s-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Create .kube directory <span class=\"keyword\">for</span> ubuntu user] **********************************************************************************************************************************************************</span><br><span class=\"line\">changed: [k8s-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Copy admin.conf to user<span class=\"string\">&#x27;s kube config] ***********************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">changed: [k8s-node-1]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">TASK [Set KUBECONFIG for root user permanently] ********************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">changed: [k8s-node-1]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">TASK [Install prerequisites for Kubernetes modules] ****************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">changed: [k8s-node-1]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">TASK [Install Helm] ************************************************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">changed: [k8s-node-1]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">TASK [Install Cilium CLI] ******************************************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">changed: [k8s-node-1]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">TASK [Add Helm repositories] ***************************************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">changed: [k8s-node-1] =&gt; (item=&#123;&#x27;</span>name<span class=\"string\">&#x27;: &#x27;</span>cilium<span class=\"string\">&#x27;, &#x27;</span>url<span class=\"string\">&#x27;: &#x27;</span>https://helm.cilium.io/<span class=\"string\">&#x27;&#125;)</span></span><br><span class=\"line\"><span class=\"string\">changed: [k8s-node-1] =&gt; (item=&#123;&#x27;</span>name<span class=\"string\">&#x27;: &#x27;</span>isovalent<span class=\"string\">&#x27;, &#x27;</span>url<span class=\"string\">&#x27;: &#x27;</span>https://helm.isovalent.com/<span class=\"string\">&#x27;&#125;)</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">TASK [Deploy Cilium and Hubble with Helm] **************************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">changed: [k8s-node-1]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">TASK [Expose Hubble UI service via NodePort] ***********************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">[WARNING]: kubernetes&lt;24.2.0 is not supported or tested. Some features may not work.</span></span><br><span class=\"line\"><span class=\"string\">changed: [k8s-node-1]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">TASK [Wait for Cilium CRDs to become available] ********************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">FAILED - RETRYING: [k8s-node-1]: Wait for Cilium CRDs to become available (20 retries left).</span></span><br><span class=\"line\"><span class=\"string\">FAILED - RETRYING: [k8s-node-1]: Wait for Cilium CRDs to become available (19 retries left).</span></span><br><span class=\"line\"><span class=\"string\">FAILED - RETRYING: [k8s-node-1]: Wait for Cilium CRDs to become available (18 retries left).</span></span><br><span class=\"line\"><span class=\"string\">FAILED - RETRYING: [k8s-node-1]: Wait for Cilium CRDs to become available (17 retries left).</span></span><br><span class=\"line\"><span class=\"string\">FAILED - RETRYING: [k8s-node-1]: Wait for Cilium CRDs to become available (16 retries left).</span></span><br><span class=\"line\"><span class=\"string\">FAILED - RETRYING: [k8s-node-1]: Wait for Cilium CRDs to become available (15 retries left).</span></span><br><span class=\"line\"><span class=\"string\">FAILED - RETRYING: [k8s-node-1]: Wait for Cilium CRDs to become available (14 retries left).</span></span><br><span class=\"line\"><span class=\"string\">FAILED - RETRYING: [k8s-node-1]: Wait for Cilium CRDs to become available (13 retries left).</span></span><br><span class=\"line\"><span class=\"string\">FAILED - RETRYING: [k8s-node-1]: Wait for Cilium CRDs to become available (12 retries left).</span></span><br><span class=\"line\"><span class=\"string\">FAILED - RETRYING: [k8s-node-1]: Wait for Cilium CRDs to become available (11 retries left).</span></span><br><span class=\"line\"><span class=\"string\">FAILED - RETRYING: [k8s-node-1]: Wait for Cilium CRDs to become available (10 retries left).</span></span><br><span class=\"line\"><span class=\"string\">FAILED - RETRYING: [k8s-node-1]: Wait for Cilium CRDs to become available (9 retries left).</span></span><br><span class=\"line\"><span class=\"string\">ok: [k8s-node-1]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">TASK [Apply Cilium BGP Configuration from template] ****************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">changed: [k8s-node-1]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">TASK [Generate a token for workers to join] ************************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">changed: [k8s-node-1]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">TASK [Store the join command for other hosts to access] ************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">ok: [k8s-node-1]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">PLAY [Play 2 - Join Worker Nodes to the Fully Configured Cluster] **************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">TASK [Gathering Facts] *********************************************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">ok: [k8s-node-2]</span></span><br><span class=\"line\"><span class=\"string\">ok: [k8s-node-3]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">TASK [Check if node has already joined] ****************************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">ok: [k8s-node-2]</span></span><br><span class=\"line\"><span class=\"string\">ok: [k8s-node-3]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">TASK [Join the cluster] ********************************************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">changed: [k8s-node-2]</span></span><br><span class=\"line\"><span class=\"string\">changed: [k8s-node-3]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">PLAY [Play 3 - Display Final Access Information] *******************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">TASK [Get Hubble UI service details] *******************************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">ok: [k8s-node-1]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">TASK [Display the final access URL] ********************************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">ok: [k8s-node-1] =&gt; &#123;</span></span><br><span class=\"line\"><span class=\"string\">    &quot;msg&quot;: &quot;========================================================\\n🚀 Your Kubernetes Lab is Ready!\\n\\nAccess the Hubble UI at:\\nhttp://10.75.59.81:31708\\n========================================================\\n&quot;</span></span><br><span class=\"line\"><span class=\"string\">&#125;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">PLAY RECAP *********************************************************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">k8s-node-1                 : ok=18   changed=12   unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span></span><br><span class=\"line\"><span class=\"string\">k8s-node-2                 : ok=3    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span></span><br><span class=\"line\"><span class=\"string\">k8s-node-3                 : ok=3    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"9-多次执行Playbook，验证幂等性。\"><a href=\"#9-多次执行Playbook，验证幂等性。\" class=\"headerlink\" title=\"9. 多次执行Playbook，验证幂等性。\"></a>9. 多次执行Playbook，验证幂等性。</h1><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ois@ois:~/data/k8s-cilium-lab$ ansible-playbook playbooks/3_setup_cluster.yml --ask-become-pass</span><br><span class=\"line\">BECOME password: </span><br><span class=\"line\">[DEPRECATION WARNING]: community.kubernetes.helm_repository has been deprecated. The community.kubernetes collection is being renamed to kubernetes.core. Please update your FQCNs to kubernetes.core </span><br><span class=\"line\">instead. This feature will be removed from community.kubernetes <span class=\"keyword\">in</span> version 3.0.0. Deprecation warnings can be disabled by setting deprecation_warnings=False <span class=\"keyword\">in</span> ansible.cfg.</span><br><span class=\"line\">[DEPRECATION WARNING]: community.kubernetes.helm has been deprecated. The community.kubernetes collection is being renamed to kubernetes.core. Please update your FQCNs to kubernetes.core instead. </span><br><span class=\"line\">This feature will be removed from community.kubernetes <span class=\"keyword\">in</span> version 3.0.0. Deprecation warnings can be disabled by setting deprecation_warnings=False <span class=\"keyword\">in</span> ansible.cfg.</span><br><span class=\"line\">[DEPRECATION WARNING]: community.kubernetes.k8s has been deprecated. The community.kubernetes collection is being renamed to kubernetes.core. Please update your FQCNs to kubernetes.core instead. This</span><br><span class=\"line\"> feature will be removed from community.kubernetes <span class=\"keyword\">in</span> version 3.0.0. Deprecation warnings can be disabled by setting deprecation_warnings=False <span class=\"keyword\">in</span> ansible.cfg.</span><br><span class=\"line\">[DEPRECATION WARNING]: community.kubernetes.k8s_info has been deprecated. The community.kubernetes collection is being renamed to kubernetes.core. Please update your FQCNs to kubernetes.core instead.</span><br><span class=\"line\"> This feature will be removed from community.kubernetes <span class=\"keyword\">in</span> version 3.0.0. Deprecation warnings can be disabled by setting deprecation_warnings=False <span class=\"keyword\">in</span> ansible.cfg.</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY [Play 1 - Initialize and Configure Control Plane] *************************************************************************************************************************************************</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Gathering Facts] *********************************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [k8s-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Check <span class=\"keyword\">if</span> cluster is already initialized] *********************************************************************************************************************************************************</span><br><span class=\"line\">ok: [k8s-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Initialize the cluster] **************************************************************************************************************************************************************************</span><br><span class=\"line\">skipping: [k8s-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Create .kube directory <span class=\"keyword\">for</span> ubuntu user] **********************************************************************************************************************************************************</span><br><span class=\"line\">skipping: [k8s-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Copy admin.conf to user<span class=\"string\">&#x27;s kube config] ***********************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">skipping: [k8s-node-1]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">TASK [Set KUBECONFIG for root user permanently] ********************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">ok: [k8s-node-1]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">TASK [Install prerequisites for Kubernetes modules] ****************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">ok: [k8s-node-1]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">TASK [Install Helm] ************************************************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">skipping: [k8s-node-1]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">TASK [Install Cilium CLI] ******************************************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">skipping: [k8s-node-1]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">TASK [Add Helm repositories] ***************************************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">ok: [k8s-node-1] =&gt; (item=&#123;&#x27;</span>name<span class=\"string\">&#x27;: &#x27;</span>cilium<span class=\"string\">&#x27;, &#x27;</span>url<span class=\"string\">&#x27;: &#x27;</span>https://helm.cilium.io/<span class=\"string\">&#x27;&#125;)</span></span><br><span class=\"line\"><span class=\"string\">ok: [k8s-node-1] =&gt; (item=&#123;&#x27;</span>name<span class=\"string\">&#x27;: &#x27;</span>isovalent<span class=\"string\">&#x27;, &#x27;</span>url<span class=\"string\">&#x27;: &#x27;</span>https://helm.isovalent.com/<span class=\"string\">&#x27;&#125;)</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">TASK [Deploy Cilium and Hubble with Helm] **************************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">[WARNING]: The default idempotency check can fail to report changes in certain cases. Install helm diff &gt;= 3.4.1 for better results.</span></span><br><span class=\"line\"><span class=\"string\">ok: [k8s-node-1]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">TASK [Expose Hubble UI service via NodePort] ***********************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">[WARNING]: kubernetes&lt;24.2.0 is not supported or tested. Some features may not work.</span></span><br><span class=\"line\"><span class=\"string\">ok: [k8s-node-1]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">TASK [Wait for Cilium CRDs to become available] ********************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">ok: [k8s-node-1]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">TASK [Apply Cilium BGP Configuration from template] ****************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">ok: [k8s-node-1]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">TASK [Generate a token for workers to join] ************************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">changed: [k8s-node-1]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">TASK [Store the join command for other hosts to access] ************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">ok: [k8s-node-1]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">PLAY [Play 2 - Join Worker Nodes to the Fully Configured Cluster] **************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">TASK [Gathering Facts] *********************************************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">ok: [k8s-node-2]</span></span><br><span class=\"line\"><span class=\"string\">ok: [k8s-node-3]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">TASK [Check if node has already joined] ****************************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">ok: [k8s-node-2]</span></span><br><span class=\"line\"><span class=\"string\">ok: [k8s-node-3]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">TASK [Join the cluster] ********************************************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">skipping: [k8s-node-2]</span></span><br><span class=\"line\"><span class=\"string\">skipping: [k8s-node-3]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">PLAY [Play 3 - Display Final Access Information] *******************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">TASK [Get Hubble UI service details] *******************************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">ok: [k8s-node-1]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">TASK [Display the final access URL] ********************************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">ok: [k8s-node-1] =&gt; &#123;</span></span><br><span class=\"line\"><span class=\"string\">    &quot;msg&quot;: &quot;========================================================\\n🚀 Your Kubernetes Lab is Ready!\\n\\nAccess the Hubble UI at:\\nhttp://10.75.59.81:31708\\n========================================================\\n&quot;</span></span><br><span class=\"line\"><span class=\"string\">&#125;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">PLAY RECAP *********************************************************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">k8s-node-1                 : ok=13   changed=1    unreachable=0    failed=0    skipped=5    rescued=0    ignored=0   </span></span><br><span class=\"line\"><span class=\"string\">k8s-node-2                 : ok=2    changed=0    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   </span></span><br><span class=\"line\"><span class=\"string\">k8s-node-3                 : ok=2    changed=0    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   </span></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"10-部署Demo-App\"><a href=\"#10-部署Demo-App\" class=\"headerlink\" title=\"10. 部署Demo App\"></a>10. 部署Demo App</h1><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ois@ois:~/data/k8s-cilium-lab$ <span class=\"built_in\">cd</span> ../</span><br><span class=\"line\">ois@ois:~/data$ ./04-deploy-star-wars.sh </span><br><span class=\"line\">--- Star Wars Demo Script Deployer ---</span><br><span class=\"line\"></span><br><span class=\"line\">--- Step 1: Verifying Project Context ---</span><br><span class=\"line\">✅ Working inside project directory: /home/ois/data/k8s-cilium-lab</span><br><span class=\"line\"></span><br><span class=\"line\">--- Step 2: Generating the script template ---</span><br><span class=\"line\">✅ Created template: templates/deploy-star-wars.sh.j2</span><br><span class=\"line\"></span><br><span class=\"line\">--- Step 3: Generating the deployment playbook ---</span><br><span class=\"line\">✅ Created playbook: playbooks/4_deploy_app.yml</span><br><span class=\"line\"></span><br><span class=\"line\">--- Generation Complete! ---</span><br><span class=\"line\">✅ All necessary files <span class=\"keyword\">for</span> deploying the application script have been created.</span><br><span class=\"line\"></span><br><span class=\"line\">Next Steps:</span><br><span class=\"line\">1. Change into the project directory: <span class=\"built_in\">cd</span> k8s-cilium-lab</span><br><span class=\"line\">2. Run the playbook to copy the script to your control plane node:</span><br><span class=\"line\">   ansible-playbook playbooks/4_deploy_app.yml --ask-become-pass</span><br><span class=\"line\">3. SSH into the control plane and run the script:</span><br><span class=\"line\">   ssh ubuntu@k8s-node-1</span><br><span class=\"line\">   <span class=\"built_in\">sudo</span> /root/deploy-star-wars.sh</span><br><span class=\"line\">ois@ois:~/data$ <span class=\"built_in\">cd</span> k8s-cilium-lab/</span><br><span class=\"line\">ois@ois:~/data/k8s-cilium-lab$ ansible-playbook playbooks/4_deploy_app.yml --ask-become-pass</span><br><span class=\"line\">BECOME password: </span><br><span class=\"line\"></span><br><span class=\"line\">PLAY [Deploy Star Wars Demo Script] ********************************************************************************************************************************************************************</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Gathering Facts] *********************************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [k8s-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Copy the Star Wars deployment script to the control plane] ***************************************************************************************************************************************</span><br><span class=\"line\">changed: [k8s-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY RECAP *********************************************************************************************************************************************************************************************</span><br><span class=\"line\">k8s-node-1                 : ok=2    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class=\"line\"></span><br><span class=\"line\">ois@ois:~/data/k8s-cilium-lab$ </span><br><span class=\"line\">ois@ois:~/data/k8s-cilium-lab$ ssh ubuntu@10.75.59.81</span><br><span class=\"line\">Welcome to Ubuntu 24.04.2 LTS (GNU/Linux 6.8.0-63-generic x86_64)</span><br><span class=\"line\"></span><br><span class=\"line\"> * Documentation:  https://help.ubuntu.com</span><br><span class=\"line\"> * Management:     https://landscape.canonical.com</span><br><span class=\"line\"> * Support:        https://ubuntu.com/pro</span><br><span class=\"line\"></span><br><span class=\"line\"> System information as of Mon Aug  4 05:00:52 PM CST 2025</span><br><span class=\"line\"></span><br><span class=\"line\">  System load:  0.26               Processes:               195</span><br><span class=\"line\">  Usage of /:   33.4% of 18.33GB   Users logged <span class=\"keyword\">in</span>:         0</span><br><span class=\"line\">  Memory usage: 16%                IPv4 address <span class=\"keyword\">for</span> enp1s0: 10.75.59.81</span><br><span class=\"line\">  Swap usage:   0%</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">Expanded Security Maintenance <span class=\"keyword\">for</span> Applications is not enabled.</span><br><span class=\"line\"></span><br><span class=\"line\">0 updates can be applied immediately.</span><br><span class=\"line\"></span><br><span class=\"line\">Enable ESM Apps to receive additional future security updates.</span><br><span class=\"line\">See https://ubuntu.com/esm or run: <span class=\"built_in\">sudo</span> pro status</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">*** System restart required ***</span><br><span class=\"line\">Last login: Mon Aug  4 16:55:53 2025 from 10.75.59.129</span><br><span class=\"line\">ubuntu@k8s-node-1:~$ <span class=\"built_in\">sudo</span> su</span><br><span class=\"line\">[<span class=\"built_in\">sudo</span>] password <span class=\"keyword\">for</span> ubuntu: </span><br><span class=\"line\">root@k8s-node-1:/home/ubuntu# <span class=\"built_in\">cd</span></span><br><span class=\"line\">root@k8s-node-1:~# cilium status</span><br><span class=\"line\">    /¯¯\\</span><br><span class=\"line\"> /¯¯\\__/¯¯\\    Cilium:             OK</span><br><span class=\"line\"> \\__/¯¯\\__/    Operator:           OK</span><br><span class=\"line\"> /¯¯\\__/¯¯\\    Envoy DaemonSet:    OK</span><br><span class=\"line\"> \\__/¯¯\\__/    Hubble Relay:       OK</span><br><span class=\"line\">    \\__/       ClusterMesh:        disabled</span><br><span class=\"line\"></span><br><span class=\"line\">DaemonSet              cilium                   Desired: 3, Ready: 3/3, Available: 3/3</span><br><span class=\"line\">DaemonSet              cilium-envoy             Desired: 3, Ready: 3/3, Available: 3/3</span><br><span class=\"line\">Deployment             cilium-operator          Desired: 2, Ready: 2/2, Available: 2/2</span><br><span class=\"line\">Deployment             hubble-relay             Desired: 1, Ready: 1/1, Available: 1/1</span><br><span class=\"line\">Deployment             hubble-ui                Desired: 1, Ready: 1/1, Available: 1/1</span><br><span class=\"line\">Containers:            cilium                   Running: 3</span><br><span class=\"line\">                       cilium-envoy             Running: 3</span><br><span class=\"line\">                       cilium-operator          Running: 2</span><br><span class=\"line\">                       clustermesh-apiserver    </span><br><span class=\"line\">                       hubble-relay             Running: 1</span><br><span class=\"line\">                       hubble-ui                Running: 1</span><br><span class=\"line\">Cluster Pods:          8/8 managed by Cilium</span><br><span class=\"line\">Helm chart version:    1.17.6</span><br><span class=\"line\">Image versions         cilium             quay.io/isovalent/cilium:v1.17.6-cee.1@sha256:2d01daf4f25f7d644889b49ca856e1a4269981fc963e50bd3962665b41b6adb3: 3</span><br><span class=\"line\">                       cilium-envoy       quay.io/isovalent/cilium-envoy:v1.17.6-cee.1@sha256:318eff387835ca2717baab42a84f35a83a5f9e7d519253df87269f80b9ff0171: 3</span><br><span class=\"line\">                       cilium-operator    quay.io/isovalent/operator-generic:v1.17.6-cee.1@sha256:2e602710a7c4f101831df679e5d8251bae8bf0f9fe26c20bbef87f1966ea8265: 2</span><br><span class=\"line\">                       hubble-relay       quay.io/isovalent/hubble-relay:v1.17.6-cee.1@sha256:d378e3607f7492374e65e2bd854cc0ec87480c63ba49a96dadcd75a6946b586e: 1</span><br><span class=\"line\">                       hubble-ui          quay.io/isovalent/hubble-ui-backend:v1.17.6-cee.1@sha256:a034b7e98e6ea796ed26df8f4e71f83fc16465a19d166eff67a03b822c0bfa15: 1</span><br><span class=\"line\">                       hubble-ui          quay.io/isovalent/hubble-ui:v1.17.6-cee.1@sha256:9e37c1296b802830834cc87342a9182ccbb71ffebb711971e849221bd9d59392: 1</span><br><span class=\"line\">root@k8s-node-1:~# </span><br><span class=\"line\">root@k8s-node-1:~# ./deploy-star-wars.sh </span><br><span class=\"line\">🚀 Starting Star Wars Demo Application Deployment...</span><br><span class=\"line\">=================================================</span><br><span class=\"line\"></span><br><span class=\"line\">--- Step 1: Ensuring <span class=\"string\">&#x27;star-wars&#x27;</span> namespace exists ---</span><br><span class=\"line\"></span><br><span class=\"line\">▶️  Running <span class=\"built_in\">command</span>:</span><br><span class=\"line\">  kubectl create namespace star-wars</span><br><span class=\"line\">namespace/star-wars created</span><br><span class=\"line\">✅ Namespace <span class=\"string\">&#x27;star-wars&#x27;</span> created.</span><br><span class=\"line\"></span><br><span class=\"line\">--- Step 2: Applying application manifest from GitHub ---</span><br><span class=\"line\"></span><br><span class=\"line\">▶️  Running <span class=\"built_in\">command</span>:</span><br><span class=\"line\">  kubectl apply -n star-wars -f https://raw.githubusercontent.com/cilium/cilium/HEAD/examples/minikube/http-sw-app.yaml</span><br><span class=\"line\">service/deathstar created</span><br><span class=\"line\">deployment.apps/deathstar created</span><br><span class=\"line\">pod/tiefighter created</span><br><span class=\"line\">pod/xwing created</span><br><span class=\"line\"></span><br><span class=\"line\">--- Step 3: Waiting <span class=\"keyword\">for</span> all application pods to be ready ---</span><br><span class=\"line\">  (This may take a minute as images are pulled...)</span><br><span class=\"line\"></span><br><span class=\"line\">▶️  Running <span class=\"built_in\">command</span>:</span><br><span class=\"line\">  kubectl <span class=\"built_in\">wait</span> --<span class=\"keyword\">for</span>=condition=ready pod --all -n star-wars --<span class=\"built_in\">timeout</span>=120s</span><br><span class=\"line\">pod/deathstar-86f85ffb4d-8xbb4 condition met</span><br><span class=\"line\">pod/deathstar-86f85ffb4d-dwfx5 condition met</span><br><span class=\"line\">pod/tiefighter condition met</span><br><span class=\"line\">pod/xwing condition met</span><br><span class=\"line\">✅ All pods are running and ready.</span><br><span class=\"line\"></span><br><span class=\"line\">--- Step 4: Displaying pod status ---</span><br><span class=\"line\"></span><br><span class=\"line\">▶️  Running <span class=\"built_in\">command</span>:</span><br><span class=\"line\">  kubectl -n star-wars get pod -o wide --show-labels</span><br><span class=\"line\">NAME                         READY   STATUS    RESTARTS   AGE   IP             NODE         NOMINATED NODE   READINESS GATES   LABELS</span><br><span class=\"line\">deathstar-86f85ffb4d-8xbb4   1/1     Running   0          24s   172.16.2.92    k8s-node-3   &lt;none&gt;           &lt;none&gt;            app.kubernetes.io/name=deathstar,class=deathstar,org=empire,pod-template-hash=86f85ffb4d</span><br><span class=\"line\">deathstar-86f85ffb4d-dwfx5   1/1     Running   0          24s   172.16.1.198   k8s-node-2   &lt;none&gt;           &lt;none&gt;            app.kubernetes.io/name=deathstar,class=deathstar,org=empire,pod-template-hash=86f85ffb4d</span><br><span class=\"line\">tiefighter                   1/1     Running   0          24s   172.16.2.180   k8s-node-3   &lt;none&gt;           &lt;none&gt;            app.kubernetes.io/name=tiefighter,class=tiefighter,org=empire</span><br><span class=\"line\">xwing                        1/1     Running   0          24s   172.16.2.156   k8s-node-3   &lt;none&gt;           &lt;none&gt;            app.kubernetes.io/name=xwing,class=xwing,org=alliance</span><br><span class=\"line\"></span><br><span class=\"line\">--- Step 5: Exposing <span class=\"string\">&#x27;deathstar&#x27;</span> service via NodePort ---</span><br><span class=\"line\"></span><br><span class=\"line\">▶️  Running <span class=\"built_in\">command</span>:</span><br><span class=\"line\">  kubectl -n star-wars patch service deathstar -p &#123;<span class=\"string\">&quot;spec&quot;</span>:&#123;<span class=\"string\">&quot;type&quot;</span>:<span class=\"string\">&quot;NodePort&quot;</span>&#125;&#125;</span><br><span class=\"line\">service/deathstar patched</span><br><span class=\"line\">✅ Service <span class=\"string\">&#x27;deathstar&#x27;</span> patched to NodePort.</span><br><span class=\"line\"></span><br><span class=\"line\">--- Step 6: Testing connectivity from client pods ---</span><br><span class=\"line\">  (A <span class=\"string\">&#x27;Ship landed&#x27;</span> message indicates success)</span><br><span class=\"line\"></span><br><span class=\"line\">▶️  Running <span class=\"built_in\">command</span>:</span><br><span class=\"line\">  kubectl -n star-wars <span class=\"built_in\">exec</span> tiefighter -- curl -s -XPOST http://deathstar.star-wars.svc.cluster.local/v1/request-landing</span><br><span class=\"line\">Ship landed</span><br><span class=\"line\"></span><br><span class=\"line\">▶️  Running <span class=\"built_in\">command</span>:</span><br><span class=\"line\">  kubectl -n star-wars <span class=\"built_in\">exec</span> xwing -- curl -s -XPOST http://deathstar.star-wars.svc.cluster.local/v1/request-landing</span><br><span class=\"line\">Ship landed</span><br><span class=\"line\"></span><br><span class=\"line\">--- Step 7: Displaying external access information ---</span><br><span class=\"line\"></span><br><span class=\"line\">=================================================</span><br><span class=\"line\">🎉 Star Wars Demo Application Deployed Successfully!</span><br><span class=\"line\">   You can access the Deathstar service from outside the cluster at:</span><br><span class=\"line\">   curl -XPOST http://10.75.59.81:30719/v1/request-landing</span><br><span class=\"line\">=================================================</span><br><span class=\"line\">root@k8s-node-1:~# curl -XPOST http://10.75.59.81:30719/v1/request-landing</span><br><span class=\"line\">Ship landed</span><br><span class=\"line\">root@k8s-node-1:~# <span class=\"built_in\">exit</span></span><br><span class=\"line\"><span class=\"built_in\">exit</span></span><br><span class=\"line\">ubuntu@k8s-node-1:~$ curl -XPOST http://10.75.59.81:30719/v1/request-landing</span><br><span class=\"line\">Ship landed</span><br><span class=\"line\">root@k8s-node-1:~# kubectl get nodes -o wide</span><br><span class=\"line\">NAME         STATUS   ROLES           AGE   VERSION   INTERNAL-IP   EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION     CONTAINER-RUNTIME</span><br><span class=\"line\">k8s-node-1   Ready    control-plane   21m   v1.33.3   10.75.59.81   &lt;none&gt;        Ubuntu 24.04.2 LTS   6.8.0-63-generic   containerd://1.7.27</span><br><span class=\"line\">k8s-node-2   Ready    &lt;none&gt;          19m   v1.33.3   10.75.59.82   &lt;none&gt;        Ubuntu 24.04.2 LTS   6.8.0-63-generic   containerd://1.7.27</span><br><span class=\"line\">k8s-node-3   Ready    &lt;none&gt;          19m   v1.33.3   10.75.59.83   &lt;none&gt;        Ubuntu 24.04.2 LTS   6.8.0-63-generic   containerd://1.7.27</span><br><span class=\"line\">root@k8s-node-1:~# kubectl get pods -A -o wide</span><br><span class=\"line\">NAMESPACE     NAME                                 READY   STATUS    RESTARTS   AGE   IP             NODE         NOMINATED NODE   READINESS GATES</span><br><span class=\"line\">kube-system   cilium-45qr7                         1/1     Running   0          19m   10.75.59.83    k8s-node-3   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">kube-system   cilium-9q5s7                         1/1     Running   0          19m   10.75.59.82    k8s-node-2   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">kube-system   cilium-envoy-72jj7                   1/1     Running   0          19m   10.75.59.82    k8s-node-2   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">kube-system   cilium-envoy-d8hb4                   1/1     Running   0          20m   10.75.59.81    k8s-node-1   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">kube-system   cilium-envoy-vvsms                   1/1     Running   0          19m   10.75.59.83    k8s-node-3   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">kube-system   cilium-operator-d67c55dc8-lfpjb      1/1     Running   0          20m   10.75.59.81    k8s-node-1   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">kube-system   cilium-operator-d67c55dc8-rpfv8      1/1     Running   0          20m   10.75.59.82    k8s-node-2   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">kube-system   cilium-xbjqm                         1/1     Running   0          20m   10.75.59.81    k8s-node-1   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">kube-system   coredns-674b8bbfcf-n9wgt             1/1     Running   0          21m   172.16.0.105   k8s-node-1   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">kube-system   coredns-674b8bbfcf-ntssg             1/1     Running   0          21m   172.16.0.161   k8s-node-1   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">kube-system   etcd-k8s-node-1                      1/1     Running   0          21m   10.75.59.81    k8s-node-1   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">kube-system   hubble-relay-cfb755899-46pzc         1/1     Running   0          20m   172.16.1.115   k8s-node-2   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">kube-system   hubble-ui-68c64498c4-p2nq4           2/2     Running   0          20m   172.16.1.105   k8s-node-2   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">kube-system   kube-apiserver-k8s-node-1            1/1     Running   0          21m   10.75.59.81    k8s-node-1   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">kube-system   kube-controller-manager-k8s-node-1   1/1     Running   0          21m   10.75.59.81    k8s-node-1   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">kube-system   kube-scheduler-k8s-node-1            1/1     Running   0          21m   10.75.59.81    k8s-node-1   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">star-wars     deathstar-86f85ffb4d-8xbb4           1/1     Running   0          12m   172.16.2.92    k8s-node-3   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">star-wars     deathstar-86f85ffb4d-dwfx5           1/1     Running   0          12m   172.16.1.198   k8s-node-2   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">star-wars     tiefighter                           1/1     Running   0          12m   172.16.2.180   k8s-node-3   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">star-wars     xwing                                1/1     Running   0          12m   172.16.2.156   k8s-node-3   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">root@k8s-node-1:~# kubectl get deployment -A -o wide</span><br><span class=\"line\">NAMESPACE     NAME              READY   UP-TO-DATE   AVAILABLE   AGE   CONTAINERS         IMAGES                                                                                                                                                                                                                                        SELECTOR</span><br><span class=\"line\">kube-system   cilium-operator   2/2     2            2           21m   cilium-operator    quay.io/isovalent/operator-generic:v1.17.6-cee.1@sha256:2e602710a7c4f101831df679e5d8251bae8bf0f9fe26c20bbef87f1966ea8265                                                                                                                      io.cilium/app=operator,name=cilium-operator</span><br><span class=\"line\">kube-system   coredns           2/2     2            2           22m   coredns            registry.k8s.io/coredns/coredns:v1.12.0                                                                                                                                                                                                       k8s-app=kube-dns</span><br><span class=\"line\">kube-system   hubble-relay      1/1     1            1           21m   hubble-relay       quay.io/isovalent/hubble-relay:v1.17.6-cee.1@sha256:d378e3607f7492374e65e2bd854cc0ec87480c63ba49a96dadcd75a6946b586e                                                                                                                          k8s-app=hubble-relay</span><br><span class=\"line\">kube-system   hubble-ui         1/1     1            1           21m   frontend,backend   quay.io/isovalent/hubble-ui:v1.17.6-cee.1@sha256:9e37c1296b802830834cc87342a9182ccbb71ffebb711971e849221bd9d59392,quay.io/isovalent/hubble-ui-backend:v1.17.6-cee.1@sha256:a034b7e98e6ea796ed26df8f4e71f83fc16465a19d166eff67a03b822c0bfa15   k8s-app=hubble-ui</span><br><span class=\"line\">star-wars     deathstar         2/2     2            2           12m   deathstar          quay.io/cilium/starwars@sha256:896dc536ec505778c03efedb73c3b7b83c8de11e74264c8c35291ff6d5fe8ada                                                                                                                                               class=deathstar,org=empire</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h1 id=\"11-系统信息探索\"><a href=\"#11-系统信息探索\" class=\"headerlink\" title=\"11. 系统信息探索\"></a>11. 系统信息探索</h1><h2 id=\"11-1-K8S-和-Cilium相关信息\"><a href=\"#11-1-K8S-和-Cilium相关信息\" class=\"headerlink\" title=\"11.1 K8S 和 Cilium相关信息\"></a>11.1 K8S 和 Cilium相关信息</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br><span class=\"line\">252</span><br><span class=\"line\">253</span><br><span class=\"line\">254</span><br><span class=\"line\">255</span><br><span class=\"line\">256</span><br><span class=\"line\">257</span><br><span class=\"line\">258</span><br><span class=\"line\">259</span><br><span class=\"line\">260</span><br><span class=\"line\">261</span><br><span class=\"line\">262</span><br><span class=\"line\">263</span><br><span class=\"line\">264</span><br><span class=\"line\">265</span><br><span class=\"line\">266</span><br><span class=\"line\">267</span><br><span class=\"line\">268</span><br><span class=\"line\">269</span><br><span class=\"line\">270</span><br><span class=\"line\">271</span><br><span class=\"line\">272</span><br><span class=\"line\">273</span><br><span class=\"line\">274</span><br><span class=\"line\">275</span><br><span class=\"line\">276</span><br><span class=\"line\">277</span><br><span class=\"line\">278</span><br><span class=\"line\">279</span><br><span class=\"line\">280</span><br><span class=\"line\">281</span><br><span class=\"line\">282</span><br><span class=\"line\">283</span><br><span class=\"line\">284</span><br><span class=\"line\">285</span><br><span class=\"line\">286</span><br><span class=\"line\">287</span><br><span class=\"line\">288</span><br><span class=\"line\">289</span><br><span class=\"line\">290</span><br><span class=\"line\">291</span><br><span class=\"line\">292</span><br><span class=\"line\">293</span><br><span class=\"line\">294</span><br><span class=\"line\">295</span><br><span class=\"line\">296</span><br><span class=\"line\">297</span><br><span class=\"line\">298</span><br><span class=\"line\">299</span><br><span class=\"line\">300</span><br><span class=\"line\">301</span><br><span class=\"line\">302</span><br><span class=\"line\">303</span><br><span class=\"line\">304</span><br><span class=\"line\">305</span><br><span class=\"line\">306</span><br><span class=\"line\">307</span><br><span class=\"line\">308</span><br><span class=\"line\">309</span><br><span class=\"line\">310</span><br><span class=\"line\">311</span><br><span class=\"line\">312</span><br><span class=\"line\">313</span><br><span class=\"line\">314</span><br><span class=\"line\">315</span><br><span class=\"line\">316</span><br><span class=\"line\">317</span><br><span class=\"line\">318</span><br><span class=\"line\">319</span><br><span class=\"line\">320</span><br><span class=\"line\">321</span><br><span class=\"line\">322</span><br><span class=\"line\">323</span><br><span class=\"line\">324</span><br><span class=\"line\">325</span><br><span class=\"line\">326</span><br><span class=\"line\">327</span><br><span class=\"line\">328</span><br><span class=\"line\">329</span><br><span class=\"line\">330</span><br><span class=\"line\">331</span><br><span class=\"line\">332</span><br><span class=\"line\">333</span><br><span class=\"line\">334</span><br><span class=\"line\">335</span><br><span class=\"line\">336</span><br><span class=\"line\">337</span><br><span class=\"line\">338</span><br><span class=\"line\">339</span><br><span class=\"line\">340</span><br><span class=\"line\">341</span><br><span class=\"line\">342</span><br><span class=\"line\">343</span><br><span class=\"line\">344</span><br><span class=\"line\">345</span><br><span class=\"line\">346</span><br><span class=\"line\">347</span><br><span class=\"line\">348</span><br><span class=\"line\">349</span><br><span class=\"line\">350</span><br><span class=\"line\">351</span><br><span class=\"line\">352</span><br><span class=\"line\">353</span><br><span class=\"line\">354</span><br><span class=\"line\">355</span><br><span class=\"line\">356</span><br><span class=\"line\">357</span><br><span class=\"line\">358</span><br><span class=\"line\">359</span><br><span class=\"line\">360</span><br><span class=\"line\">361</span><br><span class=\"line\">362</span><br><span class=\"line\">363</span><br><span class=\"line\">364</span><br><span class=\"line\">365</span><br><span class=\"line\">366</span><br><span class=\"line\">367</span><br><span class=\"line\">368</span><br><span class=\"line\">369</span><br><span class=\"line\">370</span><br><span class=\"line\">371</span><br><span class=\"line\">372</span><br><span class=\"line\">373</span><br><span class=\"line\">374</span><br><span class=\"line\">375</span><br><span class=\"line\">376</span><br><span class=\"line\">377</span><br><span class=\"line\">378</span><br><span class=\"line\">379</span><br><span class=\"line\">380</span><br><span class=\"line\">381</span><br><span class=\"line\">382</span><br><span class=\"line\">383</span><br><span class=\"line\">384</span><br><span class=\"line\">385</span><br><span class=\"line\">386</span><br><span class=\"line\">387</span><br><span class=\"line\">388</span><br><span class=\"line\">389</span><br><span class=\"line\">390</span><br><span class=\"line\">391</span><br><span class=\"line\">392</span><br><span class=\"line\">393</span><br><span class=\"line\">394</span><br><span class=\"line\">395</span><br><span class=\"line\">396</span><br><span class=\"line\">397</span><br><span class=\"line\">398</span><br><span class=\"line\">399</span><br><span class=\"line\">400</span><br><span class=\"line\">401</span><br><span class=\"line\">402</span><br><span class=\"line\">403</span><br><span class=\"line\">404</span><br><span class=\"line\">405</span><br><span class=\"line\">406</span><br><span class=\"line\">407</span><br><span class=\"line\">408</span><br><span class=\"line\">409</span><br><span class=\"line\">410</span><br><span class=\"line\">411</span><br><span class=\"line\">412</span><br><span class=\"line\">413</span><br><span class=\"line\">414</span><br><span class=\"line\">415</span><br><span class=\"line\">416</span><br><span class=\"line\">417</span><br><span class=\"line\">418</span><br><span class=\"line\">419</span><br><span class=\"line\">420</span><br><span class=\"line\">421</span><br><span class=\"line\">422</span><br><span class=\"line\">423</span><br><span class=\"line\">424</span><br><span class=\"line\">425</span><br><span class=\"line\">426</span><br><span class=\"line\">427</span><br><span class=\"line\">428</span><br><span class=\"line\">429</span><br><span class=\"line\">430</span><br><span class=\"line\">431</span><br><span class=\"line\">432</span><br><span class=\"line\">433</span><br><span class=\"line\">434</span><br><span class=\"line\">435</span><br><span class=\"line\">436</span><br><span class=\"line\">437</span><br><span class=\"line\">438</span><br><span class=\"line\">439</span><br><span class=\"line\">440</span><br><span class=\"line\">441</span><br><span class=\"line\">442</span><br><span class=\"line\">443</span><br><span class=\"line\">444</span><br><span class=\"line\">445</span><br><span class=\"line\">446</span><br><span class=\"line\">447</span><br><span class=\"line\">448</span><br><span class=\"line\">449</span><br><span class=\"line\">450</span><br><span class=\"line\">451</span><br><span class=\"line\">452</span><br><span class=\"line\">453</span><br><span class=\"line\">454</span><br><span class=\"line\">455</span><br><span class=\"line\">456</span><br><span class=\"line\">457</span><br><span class=\"line\">458</span><br><span class=\"line\">459</span><br><span class=\"line\">460</span><br><span class=\"line\">461</span><br><span class=\"line\">462</span><br><span class=\"line\">463</span><br><span class=\"line\">464</span><br><span class=\"line\">465</span><br><span class=\"line\">466</span><br><span class=\"line\">467</span><br><span class=\"line\">468</span><br><span class=\"line\">469</span><br><span class=\"line\">470</span><br><span class=\"line\">471</span><br><span class=\"line\">472</span><br><span class=\"line\">473</span><br><span class=\"line\">474</span><br><span class=\"line\">475</span><br><span class=\"line\">476</span><br><span class=\"line\">477</span><br><span class=\"line\">478</span><br><span class=\"line\">479</span><br><span class=\"line\">480</span><br><span class=\"line\">481</span><br><span class=\"line\">482</span><br><span class=\"line\">483</span><br><span class=\"line\">484</span><br><span class=\"line\">485</span><br><span class=\"line\">486</span><br><span class=\"line\">487</span><br><span class=\"line\">488</span><br><span class=\"line\">489</span><br><span class=\"line\">490</span><br><span class=\"line\">491</span><br><span class=\"line\">492</span><br><span class=\"line\">493</span><br><span class=\"line\">494</span><br><span class=\"line\">495</span><br><span class=\"line\">496</span><br><span class=\"line\">497</span><br><span class=\"line\">498</span><br><span class=\"line\">499</span><br><span class=\"line\">500</span><br><span class=\"line\">501</span><br><span class=\"line\">502</span><br><span class=\"line\">503</span><br><span class=\"line\">504</span><br><span class=\"line\">505</span><br><span class=\"line\">506</span><br><span class=\"line\">507</span><br><span class=\"line\">508</span><br><span class=\"line\">509</span><br><span class=\"line\">510</span><br><span class=\"line\">511</span><br><span class=\"line\">512</span><br><span class=\"line\">513</span><br><span class=\"line\">514</span><br><span class=\"line\">515</span><br><span class=\"line\">516</span><br><span class=\"line\">517</span><br><span class=\"line\">518</span><br><span class=\"line\">519</span><br><span class=\"line\">520</span><br><span class=\"line\">521</span><br><span class=\"line\">522</span><br><span class=\"line\">523</span><br><span class=\"line\">524</span><br><span class=\"line\">525</span><br><span class=\"line\">526</span><br><span class=\"line\">527</span><br><span class=\"line\">528</span><br><span class=\"line\">529</span><br><span class=\"line\">530</span><br><span class=\"line\">531</span><br><span class=\"line\">532</span><br><span class=\"line\">533</span><br><span class=\"line\">534</span><br><span class=\"line\">535</span><br><span class=\"line\">536</span><br><span class=\"line\">537</span><br><span class=\"line\">538</span><br><span class=\"line\">539</span><br><span class=\"line\">540</span><br><span class=\"line\">541</span><br><span class=\"line\">542</span><br><span class=\"line\">543</span><br><span class=\"line\">544</span><br><span class=\"line\">545</span><br><span class=\"line\">546</span><br><span class=\"line\">547</span><br><span class=\"line\">548</span><br><span class=\"line\">549</span><br><span class=\"line\">550</span><br><span class=\"line\">551</span><br><span class=\"line\">552</span><br><span class=\"line\">553</span><br><span class=\"line\">554</span><br><span class=\"line\">555</span><br><span class=\"line\">556</span><br><span class=\"line\">557</span><br><span class=\"line\">558</span><br><span class=\"line\">559</span><br><span class=\"line\">560</span><br><span class=\"line\">561</span><br><span class=\"line\">562</span><br><span class=\"line\">563</span><br><span class=\"line\">564</span><br><span class=\"line\">565</span><br><span class=\"line\">566</span><br><span class=\"line\">567</span><br><span class=\"line\">568</span><br><span class=\"line\">569</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@k8s-node-1:~# helm get values cilium -n kube-system</span><br><span class=\"line\">USER-SUPPLIED VALUES:</span><br><span class=\"line\">autoDirectNodeRoutes: <span class=\"literal\">true</span></span><br><span class=\"line\">bgpControlPlane:</span><br><span class=\"line\">  announce:</span><br><span class=\"line\">    podCIDR: <span class=\"literal\">true</span></span><br><span class=\"line\">  enabled: <span class=\"literal\">true</span></span><br><span class=\"line\">bpf:</span><br><span class=\"line\">  lb:</span><br><span class=\"line\">    externalClusterIP: <span class=\"literal\">true</span></span><br><span class=\"line\">    sock: <span class=\"literal\">true</span></span><br><span class=\"line\">  masquerade: <span class=\"literal\">true</span></span><br><span class=\"line\">enableIPv4Masquerade: <span class=\"literal\">true</span></span><br><span class=\"line\">hubble:</span><br><span class=\"line\">  enabled: <span class=\"literal\">true</span></span><br><span class=\"line\">  relay:</span><br><span class=\"line\">    enabled: <span class=\"literal\">true</span></span><br><span class=\"line\">  ui:</span><br><span class=\"line\">    enabled: <span class=\"literal\">true</span></span><br><span class=\"line\">ipam:</span><br><span class=\"line\">  mode: kubernetes</span><br><span class=\"line\">ipv4NativeRoutingCIDR: 172.16.0.0/20</span><br><span class=\"line\">k8s:</span><br><span class=\"line\">  requireIPv4PodCIDR: <span class=\"literal\">true</span></span><br><span class=\"line\">k8sServiceHost: 10.75.59.81</span><br><span class=\"line\">k8sServicePort: 6443</span><br><span class=\"line\">kubeProxyReplacement: <span class=\"literal\">true</span></span><br><span class=\"line\">routingMode: native</span><br><span class=\"line\">root@k8s-node-1:~# </span><br><span class=\"line\">root@k8s-node-1:~# kubectl -n kube-system get configmap cilium-config -o yaml</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">data:</span><br><span class=\"line\">  agent-not-ready-taint-key: node.cilium.io/agent-not-ready</span><br><span class=\"line\">  arping-refresh-period: 30s</span><br><span class=\"line\">  auto-direct-node-routes: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  bgp-secrets-namespace: kube-system</span><br><span class=\"line\">  bpf-distributed-lru: <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">  bpf-events-drop-enabled: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  bpf-events-policy-verdict-enabled: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  bpf-events-trace-enabled: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  bpf-lb-acceleration: disabled</span><br><span class=\"line\">  bpf-lb-algorithm-annotation: <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">  bpf-lb-external-clusterip: <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">  bpf-lb-map-max: <span class=\"string\">&quot;65536&quot;</span></span><br><span class=\"line\">  bpf-lb-mode-annotation: <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">  bpf-lb-sock: <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">  bpf-lb-source-range-all-types: <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">  bpf-map-dynamic-size-ratio: <span class=\"string\">&quot;0.0025&quot;</span></span><br><span class=\"line\">  bpf-policy-map-max: <span class=\"string\">&quot;16384&quot;</span></span><br><span class=\"line\">  bpf-root: /sys/fs/bpf</span><br><span class=\"line\">  cgroup-root: /run/cilium/cgroupv2</span><br><span class=\"line\">  cilium-endpoint-gc-interval: 5m0s</span><br><span class=\"line\">  cluster-id: <span class=\"string\">&quot;0&quot;</span></span><br><span class=\"line\">  cluster-name: default</span><br><span class=\"line\">  clustermesh-enable-endpoint-sync: <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">  clustermesh-enable-mcs-api: <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">  cni-exclusive: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  cni-log-file: /var/run/cilium/cilium-cni.log</span><br><span class=\"line\">  custom-cni-conf: <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">  datapath-mode: veth</span><br><span class=\"line\">  debug: <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">  debug-verbose: <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">  default-lb-service-ipam: lbipam</span><br><span class=\"line\">  direct-routing-skip-unreachable: <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">  dnsproxy-enable-transparent-mode: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  dnsproxy-socket-linger-timeout: <span class=\"string\">&quot;10&quot;</span></span><br><span class=\"line\">  egress-gateway-ha-reconciliation-trigger-interval: 1s</span><br><span class=\"line\">  egress-gateway-reconciliation-trigger-interval: 1s</span><br><span class=\"line\">  enable-auto-protect-node-port-range: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  enable-bfd: <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">  enable-bgp-control-plane: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  enable-bgp-control-plane-status-report: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  enable-bpf-clock-probe: <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">  enable-bpf-masquerade: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  enable-cluster-aware-addressing: <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">  enable-egress-gateway-ha-socket-termination: <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">  enable-endpoint-health-checking: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  enable-endpoint-lockdown-on-policy-overflow: <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">  enable-experimental-lb: <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">  enable-health-check-loadbalancer-ip: <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">  enable-health-check-nodeport: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  enable-health-checking: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  enable-hubble: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  enable-inter-cluster-snat: <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">  enable-internal-traffic-policy: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  enable-ipv4: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  enable-ipv4-big-tcp: <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">  enable-ipv4-masquerade: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  enable-ipv6: <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">  enable-ipv6-big-tcp: <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">  enable-ipv6-masquerade: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  enable-k8s-networkpolicy: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  enable-k8s-terminating-endpoint: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  enable-l2-neigh-discovery: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  enable-l7-proxy: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  enable-lb-ipam: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  enable-local-redirect-policy: <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">  enable-masquerade-to-route-source: <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">  enable-metrics: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  enable-node-selector-labels: <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">  enable-non-default-deny-policies: <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">  enable-phantom-services: <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">  enable-policy: default</span><br><span class=\"line\">  enable-policy-secrets-sync: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  enable-runtime-device-detection: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  enable-sctp: <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">  enable-source-ip-verification: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  enable-srv6: <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">  enable-svc-source-range-check: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  enable-tcx: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  enable-vtep: <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">  enable-well-known-identities: <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">  enable-xt-socket-fallback: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  envoy-access-log-buffer-size: <span class=\"string\">&quot;4096&quot;</span></span><br><span class=\"line\">  envoy-base-id: <span class=\"string\">&quot;0&quot;</span></span><br><span class=\"line\">  envoy-keep-cap-netbindservice: <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">  export-aggregation: <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">  export-aggregation-renew-ttl: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  export-aggregation-state-filter: <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">  export-file-path: <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">  external-envoy-proxy: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  feature-gates-approved: <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">  feature-gates-strict: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  health-check-icmp-failure-threshold: <span class=\"string\">&quot;3&quot;</span></span><br><span class=\"line\">  http-retry-count: <span class=\"string\">&quot;3&quot;</span></span><br><span class=\"line\">  hubble-disable-tls: <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">  hubble-export-file-max-backups: <span class=\"string\">&quot;5&quot;</span></span><br><span class=\"line\">  hubble-export-file-max-size-mb: <span class=\"string\">&quot;10&quot;</span></span><br><span class=\"line\">  hubble-listen-address: :4244</span><br><span class=\"line\">  hubble-socket-path: /var/run/cilium/hubble.sock</span><br><span class=\"line\">  hubble-tls-cert-file: /var/lib/cilium/tls/hubble/server.crt</span><br><span class=\"line\">  hubble-tls-client-ca-files: /var/lib/cilium/tls/hubble/client-ca.crt</span><br><span class=\"line\">  hubble-tls-key-file: /var/lib/cilium/tls/hubble/server.key</span><br><span class=\"line\">  identity-allocation-mode: crd</span><br><span class=\"line\">  identity-gc-interval: 15m0s</span><br><span class=\"line\">  identity-heartbeat-timeout: 30m0s</span><br><span class=\"line\">  install-no-conntrack-iptables-rules: <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">  ipam: kubernetes</span><br><span class=\"line\">  ipam-cilium-node-update-rate: 15s</span><br><span class=\"line\">  iptables-random-fully: <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">  ipv4-native-routing-cidr: 172.16.0.0/20</span><br><span class=\"line\">  k8s-require-ipv4-pod-cidr: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  k8s-require-ipv6-pod-cidr: <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">  kube-proxy-replacement: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  kube-proxy-replacement-healthz-bind-address: <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">  max-connected-clusters: <span class=\"string\">&quot;255&quot;</span></span><br><span class=\"line\">  mesh-auth-enabled: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  mesh-auth-gc-interval: 5m0s</span><br><span class=\"line\">  mesh-auth-queue-size: <span class=\"string\">&quot;1024&quot;</span></span><br><span class=\"line\">  mesh-auth-rotated-identities-queue-size: <span class=\"string\">&quot;1024&quot;</span></span><br><span class=\"line\">  monitor-aggregation: medium</span><br><span class=\"line\">  monitor-aggregation-flags: all</span><br><span class=\"line\">  monitor-aggregation-interval: 5s</span><br><span class=\"line\">  multicast-enabled: <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">  nat-map-stats-entries: <span class=\"string\">&quot;32&quot;</span></span><br><span class=\"line\">  nat-map-stats-interval: 30s</span><br><span class=\"line\">  node-port-bind-protection: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  nodeport-addresses: <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">  nodes-gc-interval: 5m0s</span><br><span class=\"line\">  operator-api-serve-addr: 127.0.0.1:9234</span><br><span class=\"line\">  operator-prometheus-serve-addr: :9963</span><br><span class=\"line\">  policy-cidr-match-mode: <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">  policy-secrets-namespace: cilium-secrets</span><br><span class=\"line\">  policy-secrets-only-from-secrets-namespace: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  preallocate-bpf-maps: <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">  procfs: /host/proc</span><br><span class=\"line\">  proxy-connect-timeout: <span class=\"string\">&quot;2&quot;</span></span><br><span class=\"line\">  proxy-idle-timeout-seconds: <span class=\"string\">&quot;60&quot;</span></span><br><span class=\"line\">  proxy-initial-fetch-timeout: <span class=\"string\">&quot;30&quot;</span></span><br><span class=\"line\">  proxy-max-concurrent-retries: <span class=\"string\">&quot;128&quot;</span></span><br><span class=\"line\">  proxy-max-connection-duration-seconds: <span class=\"string\">&quot;0&quot;</span></span><br><span class=\"line\">  proxy-max-requests-per-connection: <span class=\"string\">&quot;0&quot;</span></span><br><span class=\"line\">  proxy-xff-num-trusted-hops-egress: <span class=\"string\">&quot;0&quot;</span></span><br><span class=\"line\">  proxy-xff-num-trusted-hops-ingress: <span class=\"string\">&quot;0&quot;</span></span><br><span class=\"line\">  remove-cilium-node-taints: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  routing-mode: native</span><br><span class=\"line\">  service-no-backend-response: reject</span><br><span class=\"line\">  set-cilium-is-up-condition: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  set-cilium-node-taints: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  srv6-encap-mode: reduced</span><br><span class=\"line\">  srv6-locator-pool-enabled: <span class=\"string\">&quot;false&quot;</span></span><br><span class=\"line\">  synchronize-k8s-nodes: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  tofqdns-dns-reject-response-code: refused</span><br><span class=\"line\">  tofqdns-enable-dns-compression: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  tofqdns-endpoint-max-ip-per-hostname: <span class=\"string\">&quot;1000&quot;</span></span><br><span class=\"line\">  tofqdns-idle-connection-grace-period: 0s</span><br><span class=\"line\">  tofqdns-max-deferred-connection-deletes: <span class=\"string\">&quot;10000&quot;</span></span><br><span class=\"line\">  tofqdns-proxy-response-max-delay: 100ms</span><br><span class=\"line\">  tunnel-protocol: vxlan</span><br><span class=\"line\">  tunnel-source-port-range: 0-0</span><br><span class=\"line\">  unmanaged-pod-watcher-interval: <span class=\"string\">&quot;15&quot;</span></span><br><span class=\"line\">  vtep-cidr: <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">  vtep-endpoint: <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">  vtep-mac: <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">  vtep-mask: <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">  write-cni-conf-when-ready: /host/etc/cni/net.d/05-cilium.conflist</span><br><span class=\"line\">kind: ConfigMap</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  annotations:</span><br><span class=\"line\">    meta.helm.sh/release-name: cilium</span><br><span class=\"line\">    meta.helm.sh/release-namespace: kube-system</span><br><span class=\"line\">  creationTimestamp: <span class=\"string\">&quot;2025-08-04T08:52:46Z&quot;</span></span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app.kubernetes.io/managed-by: Helm</span><br><span class=\"line\">  name: cilium-config</span><br><span class=\"line\">  namespace: kube-system</span><br><span class=\"line\">  resourceVersion: <span class=\"string\">&quot;436&quot;</span></span><br><span class=\"line\">  uid: 614c6b36-9112-4fd0-bebf-e92741fa28da</span><br><span class=\"line\">root@k8s-node-1:~# kubectl <span class=\"built_in\">exec</span> -n kube-system -it cilium-45qr7 -- /bin/sh</span><br><span class=\"line\">Defaulted container <span class=\"string\">&quot;cilium-agent&quot;</span> out of: cilium-agent, config (init), mount-cgroup (init), apply-sysctl-overwrites (init), mount-bpf-fs (init), clean-cilium-state (init), install-cni-binaries (init)</span><br><span class=\"line\">/home/cilium <span class=\"comment\"># cilium status</span></span><br><span class=\"line\">KVStore:                 Disabled   </span><br><span class=\"line\">Kubernetes:              Ok         1.33 (v1.33.3) [linux/amd64]</span><br><span class=\"line\">Kubernetes APIs:         [<span class=\"string\">&quot;EndpointSliceOrEndpoint&quot;</span>, <span class=\"string\">&quot;cilium/v2::CiliumClusterwideNetworkPolicy&quot;</span>, <span class=\"string\">&quot;cilium/v2::CiliumEndpoint&quot;</span>, <span class=\"string\">&quot;cilium/v2::CiliumNetworkPolicy&quot;</span>, <span class=\"string\">&quot;cilium/v2::CiliumNode&quot;</span>, <span class=\"string\">&quot;cilium/v2alpha1::CiliumCIDRGroup&quot;</span>, <span class=\"string\">&quot;core/v1::Namespace&quot;</span>, <span class=\"string\">&quot;core/v1::Pods&quot;</span>, <span class=\"string\">&quot;core/v1::Service&quot;</span>, <span class=\"string\">&quot;isovalent/v1alpha1::IsovalentClusterwideNetworkPolicy&quot;</span>, <span class=\"string\">&quot;isovalent/v1alpha1::IsovalentNetworkPolicy&quot;</span>, <span class=\"string\">&quot;networking.k8s.io/v1::NetworkPolicy&quot;</span>]</span><br><span class=\"line\">KubeProxyReplacement:    True   [enp1s0   10.75.59.83 fe80::5054:ff:fead:b814 (Direct Routing)]</span><br><span class=\"line\">Host firewall:           Disabled</span><br><span class=\"line\">SRv6:                    Disabled</span><br><span class=\"line\">CNI Chaining:            none</span><br><span class=\"line\">CNI Config file:         successfully wrote CNI configuration file to /host/etc/cni/net.d/05-cilium.conflist</span><br><span class=\"line\">Cilium:                  Ok   1.17.6-cee.1 (v1.17.6-cee.1-a33b0b85)</span><br><span class=\"line\">NodeMonitor:             Listening <span class=\"keyword\">for</span> events on 4 CPUs with 64x4096 of shared memory</span><br><span class=\"line\">Cilium health daemon:    Ok   </span><br><span class=\"line\">IPAM:                    IPv4: 5/254 allocated from 172.16.2.0/24, </span><br><span class=\"line\">IPv4 BIG TCP:            Disabled</span><br><span class=\"line\">IPv6 BIG TCP:            Disabled</span><br><span class=\"line\">BandwidthManager:        Disabled</span><br><span class=\"line\">Routing:                 Network: Native   Host: BPF</span><br><span class=\"line\">Attach Mode:             TCX</span><br><span class=\"line\">Device Mode:             veth</span><br><span class=\"line\">Masquerading:            BPF   [enp1s0]   172.16.0.0/20 [IPv4: Enabled, IPv6: Disabled]</span><br><span class=\"line\">Controller Status:       36/36 healthy</span><br><span class=\"line\">Proxy Status:            OK, ip 172.16.2.88, 0 redirects active on ports 10000-20000, Envoy: external</span><br><span class=\"line\">Global Identity Range:   min 256, max 65535</span><br><span class=\"line\">Hubble:                  Ok              Current/Max Flows: 2522/4095 (61.59%), Flows/s: 1.51   Metrics: Disabled</span><br><span class=\"line\">Encryption:              Disabled        </span><br><span class=\"line\">Cluster health:          3/3 reachable   (2025-08-04T09:21:04Z)</span><br><span class=\"line\">Name                     IP              Node   Endpoints</span><br><span class=\"line\">Modules Health:          Stopped(0) Degraded(0) OK(68)</span><br><span class=\"line\">/home/cilium <span class=\"comment\"># cilium status --verbose</span></span><br><span class=\"line\">KVStore:                Disabled   </span><br><span class=\"line\">Kubernetes:             Ok         1.33 (v1.33.3) [linux/amd64]</span><br><span class=\"line\">Kubernetes APIs:        [<span class=\"string\">&quot;EndpointSliceOrEndpoint&quot;</span>, <span class=\"string\">&quot;cilium/v2::CiliumClusterwideNetworkPolicy&quot;</span>, <span class=\"string\">&quot;cilium/v2::CiliumEndpoint&quot;</span>, <span class=\"string\">&quot;cilium/v2::CiliumNetworkPolicy&quot;</span>, <span class=\"string\">&quot;cilium/v2::CiliumNode&quot;</span>, <span class=\"string\">&quot;cilium/v2alpha1::CiliumCIDRGroup&quot;</span>, <span class=\"string\">&quot;core/v1::Namespace&quot;</span>, <span class=\"string\">&quot;core/v1::Pods&quot;</span>, <span class=\"string\">&quot;core/v1::Service&quot;</span>, <span class=\"string\">&quot;isovalent/v1alpha1::IsovalentClusterwideNetworkPolicy&quot;</span>, <span class=\"string\">&quot;isovalent/v1alpha1::IsovalentNetworkPolicy&quot;</span>, <span class=\"string\">&quot;networking.k8s.io/v1::NetworkPolicy&quot;</span>]</span><br><span class=\"line\">KubeProxyReplacement:   True   [enp1s0   10.75.59.83 fe80::5054:ff:fead:b814 (Direct Routing)]</span><br><span class=\"line\">Host firewall:          Disabled</span><br><span class=\"line\">SRv6:                   Disabled</span><br><span class=\"line\">CNI Chaining:           none</span><br><span class=\"line\">CNI Config file:        successfully wrote CNI configuration file to /host/etc/cni/net.d/05-cilium.conflist</span><br><span class=\"line\">Cilium:                 Ok   1.17.6-cee.1 (v1.17.6-cee.1-a33b0b85)</span><br><span class=\"line\">NodeMonitor:            Listening <span class=\"keyword\">for</span> events on 4 CPUs with 64x4096 of shared memory</span><br><span class=\"line\">Cilium health daemon:   Ok   </span><br><span class=\"line\">IPAM:                   IPv4: 5/254 allocated from 172.16.2.0/24, </span><br><span class=\"line\">Allocated addresses:</span><br><span class=\"line\">  172.16.2.156 (star-wars/xwing)</span><br><span class=\"line\">  172.16.2.180 (star-wars/tiefighter)</span><br><span class=\"line\">  172.16.2.35 (health)</span><br><span class=\"line\">  172.16.2.88 (router)</span><br><span class=\"line\">  172.16.2.92 (star-wars/deathstar-86f85ffb4d-8xbb4)</span><br><span class=\"line\">IPv4 BIG TCP:           Disabled</span><br><span class=\"line\">IPv6 BIG TCP:           Disabled</span><br><span class=\"line\">BandwidthManager:       Disabled</span><br><span class=\"line\">Routing:                Network: Native   Host: BPF</span><br><span class=\"line\">Attach Mode:            TCX</span><br><span class=\"line\">Device Mode:            veth</span><br><span class=\"line\">Masquerading:           BPF   [enp1s0]   172.16.0.0/20 [IPv4: Enabled, IPv6: Disabled]</span><br><span class=\"line\">Clock Source <span class=\"keyword\">for</span> BPF:   ktime</span><br><span class=\"line\">Controller Status:      36/36 healthy</span><br><span class=\"line\">  Name                                                  Last success   Last error   Count   Message</span><br><span class=\"line\">  cilium-health-ep                                      1m0s ago       never        0       no error   </span><br><span class=\"line\">  ct-map-pressure                                       1s ago         never        0       no error   </span><br><span class=\"line\">  daemon-validate-config                                35s ago        never        0       no error   </span><br><span class=\"line\">  dns-garbage-collector-job                             3s ago         never        0       no error   </span><br><span class=\"line\">  endpoint-1375-regeneration-recovery                   never          never        0       no error   </span><br><span class=\"line\">  endpoint-196-regeneration-recovery                    never          never        0       no error   </span><br><span class=\"line\">  endpoint-2338-regeneration-recovery                   never          never        0       no error   </span><br><span class=\"line\">  endpoint-523-regeneration-recovery                    never          never        0       no error   </span><br><span class=\"line\">  endpoint-640-regeneration-recovery                    never          never        0       no error   </span><br><span class=\"line\">  endpoint-gc                                           2m3s ago       never        0       no error   </span><br><span class=\"line\">  endpoint-periodic-regeneration                        1m3s ago       never        0       no error   </span><br><span class=\"line\">  ep-bpf-prog-watchdog                                  1s ago         never        0       no error   </span><br><span class=\"line\">  ipcache-inject-labels                                 1s ago         never        0       no error   </span><br><span class=\"line\">  k8s-heartbeat                                         3s ago         never        0       no error   </span><br><span class=\"line\">  link-cache                                            3s ago         never        0       no error   </span><br><span class=\"line\">  node-neighbor-link-updater                            1s ago         never        0       no error   </span><br><span class=\"line\">  proxy-ports-checkpoint                                27m1s ago      never        0       no error   </span><br><span class=\"line\">  resolve-identity-1375                                 2m0s ago       never        0       no error   </span><br><span class=\"line\">  resolve-identity-196                                  1m41s ago      never        0       no error   </span><br><span class=\"line\">  resolve-identity-2338                                 1m41s ago      never        0       no error   </span><br><span class=\"line\">  resolve-identity-523                                  2m1s ago       never        0       no error   </span><br><span class=\"line\">  resolve-identity-640                                  1m41s ago      never        0       no error   </span><br><span class=\"line\">  resolve-labels-star-wars/deathstar-86f85ffb4d-8xbb4   21m41s ago     never        0       no error   </span><br><span class=\"line\">  resolve-labels-star-wars/tiefighter                   21m41s ago     never        0       no error   </span><br><span class=\"line\">  resolve-labels-star-wars/xwing                        21m41s ago     never        0       no error   </span><br><span class=\"line\">  sync-lb-maps-with-k8s-services                        27m1s ago      never        0       no error   </span><br><span class=\"line\">  sync-policymap-1375                                   11m56s ago     never        0       no error   </span><br><span class=\"line\">  sync-policymap-196                                    6m41s ago      never        0       no error   </span><br><span class=\"line\">  sync-policymap-2338                                   6m41s ago      never        0       no error   </span><br><span class=\"line\">  sync-policymap-523                                    11m57s ago     never        0       no error   </span><br><span class=\"line\">  sync-policymap-640                                    6m41s ago      never        0       no error   </span><br><span class=\"line\">  sync-to-k8s-ciliumendpoint (196)                      1s ago         never        0       no error   </span><br><span class=\"line\">  sync-to-k8s-ciliumendpoint (2338)                     1s ago         never        0       no error   </span><br><span class=\"line\">  sync-to-k8s-ciliumendpoint (640)                      1s ago         never        0       no error   </span><br><span class=\"line\">  sync-utime                                            1s ago         never        0       no error   </span><br><span class=\"line\">  write-cni-file                                        27m3s ago      never        0       no error   </span><br><span class=\"line\">Proxy Status:            OK, ip 172.16.2.88, 0 redirects active on ports 10000-20000, Envoy: external</span><br><span class=\"line\">Global Identity Range:   min 256, max 65535</span><br><span class=\"line\">Hubble:                  Ok   Current/Max Flows: 2570/4095 (62.76%), Flows/s: 1.51   Metrics: Disabled</span><br><span class=\"line\">KubeProxyReplacement Details:</span><br><span class=\"line\">  Status:                 True</span><br><span class=\"line\">  Socket LB:              Enabled</span><br><span class=\"line\">  Socket LB Tracing:      Enabled</span><br><span class=\"line\">  Socket LB Coverage:     Full</span><br><span class=\"line\">  Devices:                enp1s0   10.75.59.83 fe80::5054:ff:fead:b814 (Direct Routing)</span><br><span class=\"line\">  Mode:                   SNAT</span><br><span class=\"line\">  Backend Selection:      Random</span><br><span class=\"line\">  Session Affinity:       Enabled</span><br><span class=\"line\">  Graceful Termination:   Enabled</span><br><span class=\"line\">  NAT46/64 Support:       Disabled</span><br><span class=\"line\">  XDP Acceleration:       Disabled</span><br><span class=\"line\">  Services:</span><br><span class=\"line\">  - ClusterIP:      Enabled</span><br><span class=\"line\">  - NodePort:       Enabled (Range: 30000-32767) </span><br><span class=\"line\">  - LoadBalancer:   Enabled </span><br><span class=\"line\">  - externalIPs:    Enabled </span><br><span class=\"line\">  - HostPort:       Enabled</span><br><span class=\"line\">  Annotations:</span><br><span class=\"line\">  - service.cilium.io/node</span><br><span class=\"line\">  - service.cilium.io/src-ranges-policy</span><br><span class=\"line\">  - service.cilium.io/type</span><br><span class=\"line\">BPF Maps:   dynamic sizing: on (ratio: 0.002500)</span><br><span class=\"line\">  Name                          Size</span><br><span class=\"line\">  Auth                          524288</span><br><span class=\"line\">  Non-TCP connection tracking   65536</span><br><span class=\"line\">  TCP connection tracking       131072</span><br><span class=\"line\">  Endpoint policy               65535</span><br><span class=\"line\">  IP cache                      512000</span><br><span class=\"line\">  IPv4 masquerading agent       16384</span><br><span class=\"line\">  IPv6 masquerading agent       16384</span><br><span class=\"line\">  IPv4 fragmentation            8192</span><br><span class=\"line\">  IPv4 service                  65536</span><br><span class=\"line\">  IPv6 service                  65536</span><br><span class=\"line\">  IPv4 service backend          65536</span><br><span class=\"line\">  IPv6 service backend          65536</span><br><span class=\"line\">  IPv4 service reverse NAT      65536</span><br><span class=\"line\">  IPv6 service reverse NAT      65536</span><br><span class=\"line\">  Metrics                       1024</span><br><span class=\"line\">  Ratelimit metrics             64</span><br><span class=\"line\">  NAT                           131072</span><br><span class=\"line\">  Neighbor table                131072</span><br><span class=\"line\">  Global policy                 16384</span><br><span class=\"line\">  Session affinity              65536</span><br><span class=\"line\">  Sock reverse NAT              65536</span><br><span class=\"line\">Encryption:       Disabled        </span><br><span class=\"line\">Cluster health:   3/3 reachable   (2025-08-04T09:21:04Z)</span><br><span class=\"line\">Name              IP              Node   Endpoints</span><br><span class=\"line\">  k8s-node-3 (localhost):</span><br><span class=\"line\">    Host connectivity to 10.75.59.83:</span><br><span class=\"line\">      ICMP to stack:   OK, RTT=451.197µs</span><br><span class=\"line\">      HTTP to agent:   OK, RTT=625.346µs</span><br><span class=\"line\">    Endpoint connectivity to 172.16.2.35:</span><br><span class=\"line\">      ICMP to stack:   OK, RTT=376.939µs</span><br><span class=\"line\">      HTTP to agent:   OK, RTT=882.754µs</span><br><span class=\"line\">  k8s-node-1:</span><br><span class=\"line\">    Host connectivity to 10.75.59.81:</span><br><span class=\"line\">      ICMP to stack:   OK, RTT=582.892µs</span><br><span class=\"line\">      HTTP to agent:   OK, RTT=1.042743ms</span><br><span class=\"line\">    Endpoint connectivity to 172.16.0.116:</span><br><span class=\"line\">      ICMP to stack:   OK, RTT=703.331µs</span><br><span class=\"line\">      HTTP to agent:   OK, RTT=1.533329ms</span><br><span class=\"line\">  k8s-node-2:</span><br><span class=\"line\">    Host connectivity to 10.75.59.82:</span><br><span class=\"line\">      ICMP to stack:   OK, RTT=632.658µs</span><br><span class=\"line\">      HTTP to agent:   OK, RTT=1.156736ms</span><br><span class=\"line\">    Endpoint connectivity to 172.16.1.173:</span><br><span class=\"line\">      ICMP to stack:   OK, RTT=636.518µs</span><br><span class=\"line\">      HTTP to agent:   OK, RTT=1.37198ms</span><br><span class=\"line\">Modules Health:</span><br><span class=\"line\">      enterprise-agent</span><br><span class=\"line\">      ├── agent</span><br><span class=\"line\">      │   ├── controlplane</span><br><span class=\"line\">      │   │   ├── auth</span><br><span class=\"line\">      │   │   │   ├── observer-job-auth-gc-identity-events            [OK] OK (1.812µs) [5] (21m, x1)</span><br><span class=\"line\">      │   │   │   ├── observer-job-auth-request-authentication        [OK] Primed (27m, x1)</span><br><span class=\"line\">      │   │   │   └── timer-job-auth-gc-cleanup                       [OK] OK (15.847µs) (2m3s, x1)</span><br><span class=\"line\">      │   │   ├── bgp-control-plane</span><br><span class=\"line\">      │   │   │   ├── job-bgp-controller                              [OK] Running (27m, x1)</span><br><span class=\"line\">      │   │   │   ├── job-bgp-crd-status-initialize                   [OK] Running (27m, x1)</span><br><span class=\"line\">      │   │   │   ├── job-bgp-crd-status-update-job                   [OK] Running (27m, x1)</span><br><span class=\"line\">      │   │   │   ├── job-bgp-policy-observer                         [OK] Running (27m, x1)</span><br><span class=\"line\">      │   │   │   ├── job-bgp-reconcile-error-statedb-tracker         [OK] Running (27m, x1)</span><br><span class=\"line\">      │   │   │   ├── job-bgp-state-observer                          [OK] Running (27m, x1)</span><br><span class=\"line\">      │   │   │   ├── job-bgpcp-resource-store-events                 [OK] Running (27m, x5)</span><br><span class=\"line\">      │   │   │   └── job-diffstore-events                            [OK] Running (27m, x2)</span><br><span class=\"line\">      │   │   ├── ciliumenvoyconfig</span><br><span class=\"line\">      │   │   │   └── experimental</span><br><span class=\"line\">      │   │   │       ├── job-reconcile                               [OK] OK, 0 object(s) (27m, x3)</span><br><span class=\"line\">      │   │   │       └── job-refresh                                 [OK] Next refresh <span class=\"keyword\">in</span> 30m0s (27m, x1)</span><br><span class=\"line\">      │   │   ├── daemon</span><br><span class=\"line\">      │   │   │   ├──                                                 [OK] daemon-validate-config (35s, x27)</span><br><span class=\"line\">      │   │   │   ├── ep-bpf-prog-watchdog</span><br><span class=\"line\">      │   │   │   │   └── ep-bpf-prog-watchdog                        [OK] ep-bpf-prog-watchdog (1s, x55)</span><br><span class=\"line\">      │   │   │   └── job-sync-hostips                                [OK] Synchronized (1s, x29)</span><br><span class=\"line\">      │   │   ├── dynamic-lifecycle-manager</span><br><span class=\"line\">      │   │   │   ├── job-reconcile                                   [OK] OK, 0 object(s) (27m, x3)</span><br><span class=\"line\">      │   │   │   └── job-refresh                                     [OK] Next refresh <span class=\"keyword\">in</span> 30m0s (27m, x1)</span><br><span class=\"line\">      │   │   ├── enabled-features</span><br><span class=\"line\">      │   │   │   └── job-update-config-metric                        [OK] Waiting <span class=\"keyword\">for</span> agent config (27m, x1)</span><br><span class=\"line\">      │   │   ├── endpoint-manager</span><br><span class=\"line\">      │   │   │   ├── cilium-endpoint-1375 (/)</span><br><span class=\"line\">      │   │   │   │   ├── datapath-regenerate                         [OK] Endpoint regeneration successful (63s, x15)</span><br><span class=\"line\">      │   │   │   │   └── policymap-sync                              [OK] sync-policymap-1375 (11m, x2)</span><br><span class=\"line\">      │   │   │   ├── cilium-endpoint-196 (star-wars/xwing)</span><br><span class=\"line\">      │   │   │   │   ├── cep-k8s-sync                                [OK] sync-to-k8s-ciliumendpoint (196) (1s, x132)</span><br><span class=\"line\">      │   │   │   │   ├── datapath-regenerate                         [OK] Endpoint regeneration successful (63s, x12)</span><br><span class=\"line\">      │   │   │   │   └── policymap-sync                              [OK] sync-policymap-196 (6m41s, x2)</span><br><span class=\"line\">      │   │   │   ├── cilium-endpoint-2338 (star-wars/tiefighter)</span><br><span class=\"line\">      │   │   │   │   ├── cep-k8s-sync                                [OK] sync-to-k8s-ciliumendpoint (2338) (1s, x132)</span><br><span class=\"line\">      │   │   │   │   ├── datapath-regenerate                         [OK] Endpoint regeneration successful (63s, x12)</span><br><span class=\"line\">      │   │   │   │   └── policymap-sync                              [OK] sync-policymap-2338 (6m41s, x2)</span><br><span class=\"line\">      │   │   │   ├── cilium-endpoint-523 (/)</span><br><span class=\"line\">      │   │   │   │   ├── datapath-regenerate                         [OK] Endpoint regeneration successful (63s, x16)</span><br><span class=\"line\">      │   │   │   │   └── policymap-sync                              [OK] sync-policymap-523 (11m, x2)</span><br><span class=\"line\">      │   │   │   ├── cilium-endpoint-640 (star-wars/deathstar-86f85ffb4d-8xbb4)</span><br><span class=\"line\">      │   │   │   │   ├── cep-k8s-sync                                [OK] sync-to-k8s-ciliumendpoint (640) (1s, x132)</span><br><span class=\"line\">      │   │   │   │   ├── datapath-regenerate                         [OK] Endpoint regeneration successful (63s, x12)</span><br><span class=\"line\">      │   │   │   │   └── policymap-sync                              [OK] sync-policymap-640 (6m41s, x2)</span><br><span class=\"line\">      │   │   │   └── endpoint-gc                                     [OK] endpoint-gc (2m3s, x6)</span><br><span class=\"line\">      │   │   ├── envoy-proxy</span><br><span class=\"line\">      │   │   │   ├── observer-job-k8s-secrets-resource-events-cilium-secrets    [OK] Primed (27m, x1)</span><br><span class=\"line\">      │   │   │   └── timer-job-version-check                         [OK] OK (13.805158ms) (2m1s, x1)</span><br><span class=\"line\">      │   │   ├── hubble</span><br><span class=\"line\">      │   │   │   └── job-hubble                                      [OK] Running (27m, x1)</span><br><span class=\"line\">      │   │   ├── identity</span><br><span class=\"line\">      │   │   │   └── timer-job-id-alloc-update-policy-maps           [OK] OK (103.031µs) (21m, x1)</span><br><span class=\"line\">      │   │   ├── l2-announcer</span><br><span class=\"line\">      │   │   │   └── job-l2-announcer-lease-gc                       [OK] Running (27m, x1)</span><br><span class=\"line\">      │   │   ├── nat-stats</span><br><span class=\"line\">      │   │   │   └── timer-job-nat-stats                             [OK] OK (2.520538ms) (1s, x1)</span><br><span class=\"line\">      │   │   ├── node-manager</span><br><span class=\"line\">      │   │   │   ├── background-sync                                 [OK] Node validation successful (66s, x19)</span><br><span class=\"line\">      │   │   │   ├── neighbor-link-updater</span><br><span class=\"line\">      │   │   │   │   ├── k8s-node-1                                  [OK] Node neighbor <span class=\"built_in\">link</span> update successful (61s, x20)</span><br><span class=\"line\">      │   │   │   │   └── k8s-node-2                                  [OK] Node neighbor <span class=\"built_in\">link</span> update successful (31s, x20)</span><br><span class=\"line\">      │   │   │   ├── node-checkpoint-writer                          [OK] node checkpoint written (25m, x3)</span><br><span class=\"line\">      │   │   │   └── nodes-add                                       [OK] Node adds successful (27m, x3)</span><br><span class=\"line\">      │   │   ├── policy</span><br><span class=\"line\">      │   │   │   └── observer-job-policy-importer                    [OK] Primed (27m, x1)</span><br><span class=\"line\">      │   │   ├── service-manager</span><br><span class=\"line\">      │   │   │   ├── job-health-check-event-watcher                  [OK] Waiting <span class=\"keyword\">for</span> health check events (27m, x1)</span><br><span class=\"line\">      │   │   │   └── job-service-reconciler                          [OK] 1 NodePort frontend addresses (27m, x1)</span><br><span class=\"line\">      │   │   ├── service-resolver</span><br><span class=\"line\">      │   │   │   └── job-service-reloader-initializer                [OK] Running (27m, x1)</span><br><span class=\"line\">      │   │   └── stale-endpoint-cleanup</span><br><span class=\"line\">      │   │       └── job-endpoint-cleanup                            [OK] Running (27m, x1)</span><br><span class=\"line\">      │   ├── datapath</span><br><span class=\"line\">      │   │   ├── agent-liveness-updater</span><br><span class=\"line\">      │   │   │   └── timer-job-agent-liveness-updater                [OK] OK (82.885µs) (0s, x1)</span><br><span class=\"line\">      │   │   ├── iptables</span><br><span class=\"line\">      │   │   │   ├── ipset</span><br><span class=\"line\">      │   │   │   │   ├── job-ipset-init-finalizer                    [OK] Running (27m, x1)</span><br><span class=\"line\">      │   │   │   │   ├── job-reconcile                               [OK] OK, 0 object(s) (27m, x2)</span><br><span class=\"line\">      │   │   │   │   └── job-refresh                                 [OK] Next refresh <span class=\"keyword\">in</span> 30m0s (27m, x1)</span><br><span class=\"line\">      │   │   │   └── job-iptables-reconciliation-loop                [OK] iptables rules full reconciliation completed (27m, x1)</span><br><span class=\"line\">      │   │   ├── l2-responder</span><br><span class=\"line\">      │   │   │   └── job-l2-responder-reconciler                     [OK] Running (27m, x1)</span><br><span class=\"line\">      │   │   ├── maps</span><br><span class=\"line\">      │   │   │   └── bwmap</span><br><span class=\"line\">      │   │   │       └── timer-job-pressure-metric-throttle          [OK] OK (18.336µs) (1s, x1)</span><br><span class=\"line\">      │   │   ├── mtu</span><br><span class=\"line\">      │   │   │   ├── job-endpoint-mtu-updater                        [OK] Endpoint MTU updated (27m, x1)</span><br><span class=\"line\">      │   │   │   └── job-mtu-updater                                 [OK] MTU updated (1500) (27m, x1)</span><br><span class=\"line\">      │   │   ├── node-address</span><br><span class=\"line\">      │   │   │   └── job-node-address-update                         [OK] 172.16.2.88 (primary), fe80::7019:6fff:febf:e8a7 (primary) (27m, x1)</span><br><span class=\"line\">      │   │   ├── orchestrator</span><br><span class=\"line\">      │   │   │   └── job-reinitialize                                [OK] OK (26m, x2)</span><br><span class=\"line\">      │   │   └── sysctl</span><br><span class=\"line\">      │   │       ├── job-reconcile                                   [OK] OK, 16 object(s) (6m56s, x35)</span><br><span class=\"line\">      │   │       └── job-refresh                                     [OK] Next refresh <span class=\"keyword\">in</span> 9m53.185634443s (6m56s, x1)</span><br><span class=\"line\">      │   └── infra</span><br><span class=\"line\">      │       ├── k8s-synced-crdsync</span><br><span class=\"line\">      │       │   └── job-sync-crds                                   [OK] Running (27m, x1)</span><br><span class=\"line\">      │       ├── metrics</span><br><span class=\"line\">      │       │   ├── job-collect                                     [OK] Sampled 24 metrics <span class=\"keyword\">in</span> 4.183045ms, next collection at 2025-08-04 09:26:00.386029804 +0000 UTC m=+1803.177514891 (2m1s, x1)</span><br><span class=\"line\">      │       │   └── timer-job-cleanup                               [OK] Primed (27m, x1)</span><br><span class=\"line\">      │       └── shell</span><br><span class=\"line\">      │           └── job-listener                                    [OK] Listening on /var/run/cilium/shell.sock (27m, x1)</span><br><span class=\"line\">      └── enterprise-controlplane</span><br><span class=\"line\">          └── cec-ingress-policy</span><br><span class=\"line\">              └── timer-job-enterprise-endpoint-policy-periodic-regeneration      [OK] OK (21.899µs) (1s, x1)</span><br><span class=\"line\">      </span><br><span class=\"line\">/home/cilium <span class=\"comment\"># cilium service list</span></span><br><span class=\"line\">ID   Frontend                Service Type   Backend                               </span><br><span class=\"line\">1    172.16.32.1:443/TCP     ClusterIP      1 =&gt; 10.75.59.81:6443/TCP (active)    </span><br><span class=\"line\">2    172.16.42.186:443/TCP   ClusterIP      1 =&gt; 10.75.59.83:4244/TCP (active)    </span><br><span class=\"line\">3    172.16.42.14:80/TCP     ClusterIP      1 =&gt; 172.16.1.115:4245/TCP (active)   </span><br><span class=\"line\">4    172.16.38.134:80/TCP    ClusterIP      1 =&gt; 172.16.1.105:8081/TCP (active)   </span><br><span class=\"line\">5    10.75.59.83:31708/TCP   NodePort       1 =&gt; 172.16.1.105:8081/TCP (active)   </span><br><span class=\"line\">6    0.0.0.0:31708/TCP       NodePort       1 =&gt; 172.16.1.105:8081/TCP (active)   </span><br><span class=\"line\">7    172.16.32.10:53/TCP     ClusterIP      1 =&gt; 172.16.0.161:53/TCP (active)     </span><br><span class=\"line\">                                            2 =&gt; 172.16.0.105:53/TCP (active)     </span><br><span class=\"line\">8    172.16.32.10:9153/TCP   ClusterIP      1 =&gt; 172.16.0.161:9153/TCP (active)   </span><br><span class=\"line\">                                            2 =&gt; 172.16.0.105:9153/TCP (active)   </span><br><span class=\"line\">9    172.16.32.10:53/UDP     ClusterIP      1 =&gt; 172.16.0.161:53/UDP (active)     </span><br><span class=\"line\">                                            2 =&gt; 172.16.0.105:53/UDP (active)     </span><br><span class=\"line\">10   172.16.34.108:80/TCP    ClusterIP      1 =&gt; 172.16.1.198:80/TCP (active)     </span><br><span class=\"line\">                                            2 =&gt; 172.16.2.92:80/TCP (active)      </span><br><span class=\"line\">11   10.75.59.83:30719/TCP   NodePort       1 =&gt; 172.16.1.198:80/TCP (active)     </span><br><span class=\"line\">                                            2 =&gt; 172.16.2.92:80/TCP (active)      </span><br><span class=\"line\">12   0.0.0.0:30719/TCP       NodePort       1 =&gt; 172.16.1.198:80/TCP (active)     </span><br><span class=\"line\">                                            2 =&gt; 172.16.2.92:80/TCP (active)      </span><br><span class=\"line\">/home/cilium <span class=\"comment\"># cilium bpf nat list</span></span><br><span class=\"line\">TCP IN 10.75.59.82:4240 -&gt; 10.75.59.83:35986 XLATE_DST 10.75.59.83:35986 Created=1076sec ago NeedsCT=1</span><br><span class=\"line\">ICMP IN 10.75.59.81:0 -&gt; 10.75.59.83:63865 XLATE_DST 10.75.59.83:63865 Created=156sec ago NeedsCT=1</span><br><span class=\"line\">TCP IN 10.75.59.81:4240 -&gt; 10.75.59.83:58402 XLATE_DST 10.75.59.83:58402 Created=56sec ago NeedsCT=1</span><br><span class=\"line\">ICMP OUT 10.75.59.83:47633 -&gt; 10.75.59.81:0 XLATE_SRC 10.75.59.83:47633 Created=56sec ago NeedsCT=1</span><br><span class=\"line\">ICMP OUT 10.75.59.83:56308 -&gt; 172.16.0.116:0 XLATE_SRC 10.75.59.83:56308 Created=206sec ago NeedsCT=1</span><br><span class=\"line\">ICMP OUT 10.75.59.83:40570 -&gt; 10.75.59.82:0 XLATE_SRC 10.75.59.83:40570 Created=226sec ago NeedsCT=1</span><br><span class=\"line\">TCP IN 172.16.0.116:4240 -&gt; 10.75.59.83:33274 XLATE_DST 10.75.59.83:33274 Created=706sec ago NeedsCT=1</span><br><span class=\"line\">ICMP IN 172.16.0.116:0 -&gt; 10.75.59.83:56308 XLATE_DST 10.75.59.83:56308 Created=206sec ago NeedsCT=1</span><br><span class=\"line\">TCP OUT 10.75.59.83:37066 -&gt; 10.75.59.81:6443 XLATE_SRC 10.75.59.83:37066 Created=1655sec ago NeedsCT=1</span><br><span class=\"line\">TCP OUT 10.75.59.83:44064 -&gt; 172.16.1.173:4240 XLATE_SRC 10.75.59.83:44064 Created=1066sec ago NeedsCT=1</span><br><span class=\"line\">TCP OUT 10.75.59.83:46184 -&gt; 10.75.59.81:6443 XLATE_SRC 10.75.59.83:46184 Created=1651sec ago NeedsCT=1</span><br><span class=\"line\">TCP OUT 10.75.59.83:43981 -&gt; 10.75.59.86:179 XLATE_SRC 10.75.59.83:43981 Created=1648sec ago NeedsCT=1</span><br><span class=\"line\">TCP OUT 10.75.59.83:57802 -&gt; 10.75.59.81:4240 XLATE_SRC 10.75.59.83:57802 Created=716sec ago NeedsCT=1</span><br><span class=\"line\">ICMP IN 10.75.59.82:0 -&gt; 10.75.59.83:43531 XLATE_DST 10.75.59.83:43531 Created=36sec ago NeedsCT=1</span><br><span class=\"line\">TCP IN 10.75.59.86:179 -&gt; 10.75.59.83:43981 XLATE_DST 10.75.59.83:43981 Created=1648sec ago NeedsCT=1</span><br><span class=\"line\">TCP OUT 10.75.59.83:58402 -&gt; 10.75.59.81:4240 XLATE_SRC 10.75.59.83:58402 Created=56sec ago NeedsCT=1</span><br><span class=\"line\">ICMP OUT 10.75.59.83:43619 -&gt; 10.75.59.82:0 XLATE_SRC 10.75.59.83:43619 Created=176sec ago NeedsCT=1</span><br><span class=\"line\">ICMP OUT 10.75.59.83:40760 -&gt; 10.75.59.81:0 XLATE_SRC 10.75.59.83:40760 Created=216sec ago NeedsCT=1</span><br><span class=\"line\">TCP IN 142.250.199.100:443 -&gt; 10.75.59.83:40732 XLATE_DST 172.16.2.180:40732 Created=205sec ago NeedsCT=0</span><br><span class=\"line\">TCP OUT 10.75.59.83:34202 -&gt; 172.16.0.116:4240 XLATE_SRC 10.75.59.83:34202 Created=46sec ago NeedsCT=1</span><br><span class=\"line\">ICMP IN 10.75.59.81:0 -&gt; 10.75.59.83:47633 XLATE_DST 10.75.59.83:47633 Created=56sec ago NeedsCT=1</span><br><span class=\"line\">TCP OUT 10.75.59.83:33274 -&gt; 172.16.0.116:4240 XLATE_SRC 10.75.59.83:33274 Created=706sec ago NeedsCT=1</span><br><span class=\"line\">ICMP OUT 10.75.59.83:43531 -&gt; 10.75.59.82:0 XLATE_SRC 10.75.59.83:43531 Created=36sec ago NeedsCT=1</span><br><span class=\"line\">ICMP IN 10.75.59.82:0 -&gt; 10.75.59.83:43619 XLATE_DST 10.75.59.83:43619 Created=176sec ago NeedsCT=1</span><br><span class=\"line\">TCP IN 10.75.59.81:6443 -&gt; 10.75.59.83:37066 XLATE_DST 10.75.59.83:37066 Created=1655sec ago NeedsCT=1</span><br><span class=\"line\">ICMP OUT 10.75.59.83:36675 -&gt; 172.16.1.173:0 XLATE_SRC 10.75.59.83:36675 Created=106sec ago NeedsCT=1</span><br><span class=\"line\">TCP OUT 172.16.2.180:40732 -&gt; 142.250.199.100:443 XLATE_SRC 10.75.59.83:40732 Created=205sec ago NeedsCT=0</span><br><span class=\"line\">ICMP IN 172.16.0.116:0 -&gt; 10.75.59.83:38433 XLATE_DST 10.75.59.83:38433 Created=276sec ago NeedsCT=1</span><br><span class=\"line\">TCP OUT 10.75.59.83:35986 -&gt; 10.75.59.82:4240 XLATE_SRC 10.75.59.83:35986 Created=1076sec ago NeedsCT=1</span><br><span class=\"line\">ICMP IN 172.16.1.173:0 -&gt; 10.75.59.83:36675 XLATE_DST 10.75.59.83:36675 Created=106sec ago NeedsCT=1</span><br><span class=\"line\">TCP IN 10.75.59.81:6443 -&gt; 10.75.59.83:46184 XLATE_DST 10.75.59.83:46184 Created=1651sec ago NeedsCT=1</span><br><span class=\"line\">TCP IN 172.16.0.116:4240 -&gt; 10.75.59.83:34202 XLATE_DST 10.75.59.83:34202 Created=46sec ago NeedsCT=1</span><br><span class=\"line\">ICMP OUT 10.75.59.83:63865 -&gt; 10.75.59.81:0 XLATE_SRC 10.75.59.83:63865 Created=156sec ago NeedsCT=1</span><br><span class=\"line\">ICMP OUT 10.75.59.83:38433 -&gt; 172.16.0.116:0 XLATE_SRC 10.75.59.83:38433 Created=276sec ago NeedsCT=1</span><br><span class=\"line\">ICMP IN 10.75.59.82:0 -&gt; 10.75.59.83:40570 XLATE_DST 10.75.59.83:40570 Created=226sec ago NeedsCT=1</span><br><span class=\"line\">ICMP OUT 10.75.59.83:36899 -&gt; 172.16.1.173:0 XLATE_SRC 10.75.59.83:36899 Created=236sec ago NeedsCT=1</span><br><span class=\"line\">ICMP IN 172.16.1.173:0 -&gt; 10.75.59.83:36899 XLATE_DST 10.75.59.83:36899 Created=236sec ago NeedsCT=1</span><br><span class=\"line\">TCP IN 10.75.59.81:4240 -&gt; 10.75.59.83:57802 XLATE_DST 10.75.59.83:57802 Created=716sec ago NeedsCT=1</span><br><span class=\"line\">ICMP IN 10.75.59.81:0 -&gt; 10.75.59.83:40760 XLATE_DST 10.75.59.83:40760 Created=216sec ago NeedsCT=1</span><br><span class=\"line\">TCP IN 172.16.1.173:4240 -&gt; 10.75.59.83:44064 XLATE_DST 10.75.59.83:44064 Created=1066sec ago NeedsCT=1</span><br><span class=\"line\"></span><br><span class=\"line\">/home/cilium <span class=\"comment\"># cilium config</span></span><br><span class=\"line\"><span class=\"comment\">##### Read-write configurations #####</span></span><br><span class=\"line\">ConntrackAccounting               : Disabled</span><br><span class=\"line\">ConntrackLocal                    : Disabled</span><br><span class=\"line\">Debug                             : Disabled</span><br><span class=\"line\">DebugLB                           : Disabled</span><br><span class=\"line\">DropNotification                  : Enabled</span><br><span class=\"line\">MonitorAggregationLevel           : Medium</span><br><span class=\"line\">PolicyAccounting                  : Enabled</span><br><span class=\"line\">PolicyAuditMode                   : Disabled</span><br><span class=\"line\">PolicyTracing                     : Disabled</span><br><span class=\"line\">PolicyVerdictNotification         : Enabled</span><br><span class=\"line\">SourceIPVerification              : Enabled</span><br><span class=\"line\">TraceNotification                 : Enabled</span><br><span class=\"line\">MonitorNumPages                   : 64</span><br><span class=\"line\">PolicyEnforcement                 : default</span><br><span class=\"line\">/home/cilium <span class=\"comment\"># exit</span></span><br><span class=\"line\">root@k8s-node-1:~# </span><br></pre></td></tr></table></figure>\n<h2 id=\"11-2-BGP相关信息\"><a href=\"#11-2-BGP相关信息\" class=\"headerlink\" title=\"11.2 BGP相关信息\"></a>11.2 BGP相关信息</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@k8s-node-1:~# cilium bgp peers</span><br><span class=\"line\">Node         Local AS   Peer AS   Peer Address   Session State   Uptime   Family         Received   Advertised</span><br><span class=\"line\">k8s-node-1   65000      65000     10.75.59.86    established     41m41s   ipv4/unicast   1          8    </span><br><span class=\"line\">k8s-node-2   65000      65000     10.75.59.86    established     39m53s   ipv4/unicast   1          8    </span><br><span class=\"line\">k8s-node-3   65000      65000     10.75.59.86    established     39m52s   ipv4/unicast   1          8    </span><br><span class=\"line\">root@k8s-node-1:~# cilium bgp routes</span><br><span class=\"line\">(Defaulting to `available ipv4 unicast` routes, please see <span class=\"built_in\">help</span> <span class=\"keyword\">for</span> more options)</span><br><span class=\"line\"></span><br><span class=\"line\">Node         VRouter   Prefix             NextHop   Age      Attrs</span><br><span class=\"line\">k8s-node-1   65000     172.16.0.0/24      0.0.0.0   41m48s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class=\"line\">             65000     172.16.32.1/32     0.0.0.0   41m48s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class=\"line\">             65000     172.16.32.10/32    0.0.0.0   41m48s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class=\"line\">             65000     172.16.34.108/32   0.0.0.0   34m39s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class=\"line\">             65000     172.16.38.134/32   0.0.0.0   41m48s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class=\"line\">             65000     172.16.42.14/32    0.0.0.0   41m48s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class=\"line\">             65000     172.16.42.186/32   0.0.0.0   41m47s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class=\"line\">k8s-node-2   65000     172.16.1.0/24      0.0.0.0   39m59s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class=\"line\">             65000     172.16.32.1/32     0.0.0.0   39m59s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class=\"line\">             65000     172.16.32.10/32    0.0.0.0   39m59s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class=\"line\">             65000     172.16.34.108/32   0.0.0.0   34m39s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class=\"line\">             65000     172.16.38.134/32   0.0.0.0   39m59s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class=\"line\">             65000     172.16.42.14/32    0.0.0.0   39m59s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class=\"line\">             65000     172.16.42.186/32   0.0.0.0   39m56s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class=\"line\">k8s-node-3   65000     172.16.2.0/24      0.0.0.0   39m58s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class=\"line\">             65000     172.16.32.1/32     0.0.0.0   39m58s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class=\"line\">             65000     172.16.32.10/32    0.0.0.0   39m58s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class=\"line\">             65000     172.16.34.108/32   0.0.0.0   34m39s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class=\"line\">             65000     172.16.38.134/32   0.0.0.0   39m58s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class=\"line\">             65000     172.16.42.14/32    0.0.0.0   39m58s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class=\"line\">             65000     172.16.42.186/32   0.0.0.0   39m55s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class=\"line\"></span><br><span class=\"line\">root@dns-bgp-server:~# ip route show</span><br><span class=\"line\">default via 10.75.59.1 dev enp1s0 proto static </span><br><span class=\"line\">10.75.59.0/24 dev enp1s0 proto kernel scope <span class=\"built_in\">link</span> src 10.75.59.86 </span><br><span class=\"line\">172.16.0.0/24 nhid 8 via 10.75.59.81 dev enp1s0 proto bgp metric 20 </span><br><span class=\"line\">172.16.1.0/24 nhid 12 via 10.75.59.82 dev enp1s0 proto bgp metric 20 </span><br><span class=\"line\">172.16.2.0/24 nhid 19 via 10.75.59.83 dev enp1s0 proto bgp metric 20 </span><br><span class=\"line\">172.16.32.1 nhid 18 proto bgp metric 20 </span><br><span class=\"line\">        nexthop via 10.75.59.81 dev enp1s0 weight 1 </span><br><span class=\"line\">        nexthop via 10.75.59.82 dev enp1s0 weight 1 </span><br><span class=\"line\">        nexthop via 10.75.59.83 dev enp1s0 weight 1 </span><br><span class=\"line\">172.16.32.10 nhid 18 proto bgp metric 20 </span><br><span class=\"line\">        nexthop via 10.75.59.81 dev enp1s0 weight 1 </span><br><span class=\"line\">        nexthop via 10.75.59.82 dev enp1s0 weight 1 </span><br><span class=\"line\">        nexthop via 10.75.59.83 dev enp1s0 weight 1 </span><br><span class=\"line\">172.16.34.108 nhid 18 proto bgp metric 20 </span><br><span class=\"line\">        nexthop via 10.75.59.81 dev enp1s0 weight 1 </span><br><span class=\"line\">        nexthop via 10.75.59.82 dev enp1s0 weight 1 </span><br><span class=\"line\">        nexthop via 10.75.59.83 dev enp1s0 weight 1 </span><br><span class=\"line\">172.16.38.134 nhid 18 proto bgp metric 20 </span><br><span class=\"line\">        nexthop via 10.75.59.81 dev enp1s0 weight 1 </span><br><span class=\"line\">        nexthop via 10.75.59.82 dev enp1s0 weight 1 </span><br><span class=\"line\">        nexthop via 10.75.59.83 dev enp1s0 weight 1 </span><br><span class=\"line\">172.16.42.14 nhid 18 proto bgp metric 20 </span><br><span class=\"line\">        nexthop via 10.75.59.81 dev enp1s0 weight 1 </span><br><span class=\"line\">        nexthop via 10.75.59.82 dev enp1s0 weight 1 </span><br><span class=\"line\">        nexthop via 10.75.59.83 dev enp1s0 weight 1 </span><br><span class=\"line\">172.16.42.186 nhid 18 proto bgp metric 20 </span><br><span class=\"line\">        nexthop via 10.75.59.81 dev enp1s0 weight 1 </span><br><span class=\"line\">        nexthop via 10.75.59.82 dev enp1s0 weight 1 </span><br><span class=\"line\">        nexthop via 10.75.59.83 dev enp1s0 weight 1 </span><br><span class=\"line\">root@dns-bgp-server:~# route -n</span><br><span class=\"line\">Kernel IP routing table</span><br><span class=\"line\">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class=\"line\">0.0.0.0         10.75.59.1      0.0.0.0         UG    0      0        0 enp1s0</span><br><span class=\"line\">10.75.59.0      0.0.0.0         255.255.255.0   U     0      0        0 enp1s0</span><br><span class=\"line\">172.16.0.0      10.75.59.81     255.255.255.0   UG    20     0        0 enp1s0</span><br><span class=\"line\">172.16.1.0      10.75.59.82     255.255.255.0   UG    20     0        0 enp1s0</span><br><span class=\"line\">172.16.2.0      10.75.59.83     255.255.255.0   UG    20     0        0 enp1s0</span><br><span class=\"line\">172.16.32.1     10.75.59.81     255.255.255.255 UGH   20     0        0 enp1s0</span><br><span class=\"line\">172.16.32.10    10.75.59.81     255.255.255.255 UGH   20     0        0 enp1s0</span><br><span class=\"line\">172.16.34.108   10.75.59.81     255.255.255.255 UGH   20     0        0 enp1s0</span><br><span class=\"line\">172.16.38.134   10.75.59.81     255.255.255.255 UGH   20     0        0 enp1s0</span><br><span class=\"line\">172.16.42.14    10.75.59.81     255.255.255.255 UGH   20     0        0 enp1s0</span><br><span class=\"line\">172.16.42.186   10.75.59.81     255.255.255.255 UGH   20     0        0 enp1s0</span><br><span class=\"line\">root@dns-bgp-server:~# vtysh -c <span class=\"string\">&quot;show ip bgp&quot;</span></span><br><span class=\"line\">BGP table version is 15, <span class=\"built_in\">local</span> router ID is 10.75.59.86, vrf <span class=\"built_in\">id</span> 0</span><br><span class=\"line\">Default <span class=\"built_in\">local</span> pref 100, <span class=\"built_in\">local</span> AS 65000</span><br><span class=\"line\">Status codes:  s suppressed, d damped, h <span class=\"built_in\">history</span>, * valid, &gt; best, = multipath,</span><br><span class=\"line\">               i internal, r RIB-failure, S Stale, R Removed</span><br><span class=\"line\">Nexthop codes: @NNN nexthop<span class=\"string\">&#x27;s vrf id, &lt; announce-nh-self</span></span><br><span class=\"line\"><span class=\"string\">Origin codes:  i - IGP, e - EGP, ? - incomplete</span></span><br><span class=\"line\"><span class=\"string\">RPKI validation codes: V valid, I invalid, N Not found</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">   Network          Next Hop            Metric LocPrf Weight Path</span></span><br><span class=\"line\"><span class=\"string\">*&gt; 10.75.59.0/24    0.0.0.0                  0         32768 ?</span></span><br><span class=\"line\"><span class=\"string\">*&gt;i172.16.0.0/24    10.75.59.81                   100      0 i</span></span><br><span class=\"line\"><span class=\"string\">*&gt;i172.16.1.0/24    10.75.59.82                   100      0 i</span></span><br><span class=\"line\"><span class=\"string\">*&gt;i172.16.2.0/24    10.75.59.83                   100      0 i</span></span><br><span class=\"line\"><span class=\"string\">*=i172.16.32.1/32   10.75.59.83                   100      0 i</span></span><br><span class=\"line\"><span class=\"string\">*=i                 10.75.59.82                   100      0 i</span></span><br><span class=\"line\"><span class=\"string\">*&gt;i                 10.75.59.81                   100      0 i</span></span><br><span class=\"line\"><span class=\"string\">*=i172.16.32.10/32  10.75.59.83                   100      0 i</span></span><br><span class=\"line\"><span class=\"string\">*=i                 10.75.59.82                   100      0 i</span></span><br><span class=\"line\"><span class=\"string\">*&gt;i                 10.75.59.81                   100      0 i</span></span><br><span class=\"line\"><span class=\"string\">*&gt;i172.16.34.108/32 10.75.59.81                   100      0 i</span></span><br><span class=\"line\"><span class=\"string\">*=i                 10.75.59.82                   100      0 i</span></span><br><span class=\"line\"><span class=\"string\">*=i                 10.75.59.83                   100      0 i</span></span><br><span class=\"line\"><span class=\"string\">*=i172.16.38.134/32 10.75.59.83                   100      0 i</span></span><br><span class=\"line\"><span class=\"string\">*=i                 10.75.59.82                   100      0 i</span></span><br><span class=\"line\"><span class=\"string\">*&gt;i                 10.75.59.81                   100      0 i</span></span><br><span class=\"line\"><span class=\"string\">*=i172.16.42.14/32  10.75.59.83                   100      0 i</span></span><br><span class=\"line\"><span class=\"string\">*=i                 10.75.59.82                   100      0 i</span></span><br><span class=\"line\"><span class=\"string\">*&gt;i                 10.75.59.81                   100      0 i</span></span><br><span class=\"line\"><span class=\"string\">*=i172.16.42.186/32 10.75.59.83                   100      0 i</span></span><br><span class=\"line\"><span class=\"string\">*=i                 10.75.59.82                   100      0 i</span></span><br><span class=\"line\"><span class=\"string\">*&gt;i                 10.75.59.81                   100      0 i</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">Displayed  10 routes and 22 total paths</span></span><br><span class=\"line\"><span class=\"string\">root@dns-bgp-server:~# vtysh -c &quot;show ip bgp summary&quot;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">IPv4 Unicast Summary (VRF default):</span></span><br><span class=\"line\"><span class=\"string\">BGP router identifier 10.75.59.86, local AS number 65000 vrf-id 0</span></span><br><span class=\"line\"><span class=\"string\">BGP table version 15</span></span><br><span class=\"line\"><span class=\"string\">RIB entries 19, using 3648 bytes of memory</span></span><br><span class=\"line\"><span class=\"string\">Peers 3, using 2172 KiB of memory</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">Neighbor        V         AS   MsgRcvd   MsgSent   TblVer  InQ OutQ  Up/Down State/PfxRcd   PfxSnt Desc</span></span><br><span class=\"line\"><span class=\"string\">10.75.59.81     4      65000       247       244        0    0    0 00:40:09            7        1 N/A</span></span><br><span class=\"line\"><span class=\"string\">10.75.59.82     4      65000       240       234        0    0    0 00:38:20            7        1 N/A</span></span><br><span class=\"line\"><span class=\"string\">10.75.59.83     4      65000       239       233        0    0    0 00:38:19            7        1 N/A</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">Total number of neighbors 3</span></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"12-项目文档结构\"><a href=\"#12-项目文档结构\" class=\"headerlink\" title=\"12. 项目文档结构\"></a>12. 项目文档结构</h1><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ois@ois:~/data/k8s-cilium-lab$ tree</span><br><span class=\"line\">.</span><br><span class=\"line\">├── ansible.cfg</span><br><span class=\"line\">├── group_vars</span><br><span class=\"line\">│   └── all.yml</span><br><span class=\"line\">├── host_vars</span><br><span class=\"line\">│   ├── dns-bgp-server.yml</span><br><span class=\"line\">│   ├── k8s-node-1.yml</span><br><span class=\"line\">│   ├── k8s-node-2.yml</span><br><span class=\"line\">│   └── k8s-node-3.yml</span><br><span class=\"line\">├── inventory.ini</span><br><span class=\"line\">├── nodevm_cfg</span><br><span class=\"line\">│   ├── dns-bgp-server_meta-data</span><br><span class=\"line\">│   ├── dns-bgp-server_network-config</span><br><span class=\"line\">│   ├── dns-bgp-server_user-data</span><br><span class=\"line\">│   ├── k8s-node-1_meta-data</span><br><span class=\"line\">│   ├── k8s-node-1_network-config</span><br><span class=\"line\">│   ├── k8s-node-1_user-data</span><br><span class=\"line\">│   ├── k8s-node-2_meta-data</span><br><span class=\"line\">│   ├── k8s-node-2_network-config</span><br><span class=\"line\">│   ├── k8s-node-2_user-data</span><br><span class=\"line\">│   ├── k8s-node-3_meta-data</span><br><span class=\"line\">│   ├── k8s-node-3_network-config</span><br><span class=\"line\">│   └── k8s-node-3_user-data</span><br><span class=\"line\">├── nodevms</span><br><span class=\"line\">│   ├── dns-bgp-server.qcow2</span><br><span class=\"line\">│   ├── k8s-node-1.qcow2</span><br><span class=\"line\">│   ├── k8s-node-2.qcow2</span><br><span class=\"line\">│   └── k8s-node-3.qcow2</span><br><span class=\"line\">├── playbooks</span><br><span class=\"line\">│   ├── 1_create_vms.yml</span><br><span class=\"line\">│   ├── 2_prepare_nodes.yml</span><br><span class=\"line\">│   ├── 3_setup_cluster.yml</span><br><span class=\"line\">│   └── 4_deploy_app.yml</span><br><span class=\"line\">├── roles</span><br><span class=\"line\">│   ├── common</span><br><span class=\"line\">│   │   └── tasks</span><br><span class=\"line\">│   │       └── main.yml</span><br><span class=\"line\">│   ├── infra_server</span><br><span class=\"line\">│   │   └── tasks</span><br><span class=\"line\">│   │       └── main.yml</span><br><span class=\"line\">│   └── k8s_node</span><br><span class=\"line\">│       └── tasks</span><br><span class=\"line\">│           └── main.yml</span><br><span class=\"line\">└── templates</span><br><span class=\"line\">    ├── cilium-bgp.yaml.j2</span><br><span class=\"line\">    ├── containerd.toml.j2</span><br><span class=\"line\">    ├── deploy-star-wars.sh.j2</span><br><span class=\"line\">    ├── frr.conf.j2</span><br><span class=\"line\">    ├── hosts.j2</span><br><span class=\"line\">    ├── meta-data.j2</span><br><span class=\"line\">    ├── network-config.j2</span><br><span class=\"line\">    └── user-data.j2</span><br><span class=\"line\"></span><br><span class=\"line\">14 directories, 38 files</span><br></pre></td></tr></table></figure>"},{"title":"有关AnyCast","date":"2021-07-06T06:00:00.000Z","description":null,"_content":"\nAnyCast，一组服务器拥有相同的IP地址，当客户端访问该组服务器时，网络会将请求发送至最近的服务器进行处理，从而极大的缩短途径的公网路径，减少延时、抖动、丢包的情况。\n\nAnyCast通常和BGP路由协议关联在一起，其实现的主要原理是：位于不同地理位置的路由器向外发布同一段IP网段的BGP路由，路由在Internet中传播后，访问发起端所处网络的路由器会选择最短的BGP AS Path路由，从而实现最短路径的访问。如果BGP选路区分不出最近的路径，那就由IGP最短路径进行转发。\n\nAnyCast的好处：\n\n- 就近访问，减少时延、提升性能\n- 获得高冗余性和可用性，即当任意目的节点异常时，可自动路由到就近目的节点\n- 实现负载均衡，且对客户端是透明的（由网络路由实现）\n- 缓解DDOS攻击，AnyCast将DDOS攻击流量引导至本地服务器，极大的减少了DDOS流量的范围以及规模\n\n<!-- more -->\n\nOffice 365 的SharePoint使用了AnyCast，例如nslookup 解析[cisco.sharepoint.com](https://cisco.sharepoint.com)、[citrix.sharepoint.com](http://citrix.sharepoint.com)、[intel.sharepoint.com](http://intel.sharepoint.com) 得到相同的地址\n\n```bash\n➜  ~ nslookup cisco.sharepoint.com | tail -n 2 | grep Address\nAddress: 13.107.136.9\n➜  ~ nslookup citrix.sharepoint.com | tail -n 2 | grep Address\nAddress: 13.107.136.9\n➜  ~ nslookup intel.sharepoint.com | tail -n 2 | grep Address\nAddress: 13.107.136.9\n➜  ~ nslookup nike.sharepoint.com | tail -n 2 | grep Address\nAddress: 13.107.136.9\n➜  ~ nslookup bmw.sharepoint.com | tail -n 2 | grep Address\nAddress: 13.107.136.9\n```\n\nTelnet 至 route-views3.routeviews.org 查询13.107.136.9的路由，发现该地址命中的路由是13.107.136.0/24，从AS 8068 -- AS 8075发布出来，这都是Microsoft的AS号。\n\n```\nroute-views3.routeviews.org> show bgp ipv4 13.107.136.9\nBGP routing table entry for 13.107.136.0/24\nPaths: (40 available, best #33, table default)\n  Not advertised to any peer\n  61568 8075 8068\n    190.15.124.18 from 190.15.124.18 (190.15.124.18)\n      Origin IGP, valid, external\n      Last update: Mon Jul  5 21:13:03 2021\n  202365 49697 8075 8068\n    194.50.19.4 from 194.50.19.4 (185.1.166.50)\n      Origin IGP, valid, external\n      Community: 49697:3000 65101:1002 65102:1000 65103:276 65104:150\n      Last update: Sun Jul  4 17:31:02 2021\n  39120 8075 8068\n    89.21.210.85 from 89.21.210.85 (195.60.191.13)\n      Origin IGP, valid, external\n      Last update: Sat Jul  3 20:46:17 2021\n  40630 6939 8075 8068\n    208.94.118.10 from 208.94.118.10 (208.94.118.10)\n      Origin IGP, valid, external\n      Community: 40630:100 40630:11701\n      Last update: Mon Jul  5 19:14:13 2021\n  54574 8075 8068\n    154.18.7.114 from 154.18.7.114 (193.41.248.191)\n      Origin IGP, valid, external\n      Community: 54574:1000\n      Last update: Wed Jun 30 02:40:58 2021\n  39120 8075 8068\n    89.21.210.86 from 89.21.210.86 (195.60.190.28)\n      Origin IGP, valid, external\n      Last update: Mon Jun 28 17:54:55 2021\n  64116 7195 8075 8068\n    45.183.45.1 from 45.183.45.1 (10.7.1.1)\n      Origin IGP, valid, external\n      Community: 7195:1000 7195:1001 7195:1300 7195:1302\n      Last update: Fri Jul  2 00:44:52 2021\n  54574 6461 8075 8068\n    38.19.140.162 from 38.19.140.162 (193.41.248.193)\n      Origin IGP, valid, external\n      Community: 6461:5997 54574:2000 54574:6461\n      Last update: Mon Jun 28 07:19:51 2021\n  39351 8075 8068\n    193.138.216.164 from 193.138.216.164 (193.138.216.164)\n      Origin IGP, valid, external\n      Last update: Fri Jun 25 20:17:33 2021\n  202365 57866 8075 8068\n    5.255.90.109 from 5.255.90.109 (185.255.155.66)\n      Origin IGP, metric 0, valid, external\n      Community: 57866:12 57866:304 57866:501\n      Large Community: 57866:41441:41441\n      Last update: Sun Jun 27 19:25:03 2021\n  3216 12389 8075 8068\n    195.239.252.124 from 195.239.252.124 (195.239.252.124)\n      Origin IGP, valid, external\n      Community: 3216:1000 3216:1077 3216:1101\n      Last update: Thu Jun 24 09:16:54 2021\n  3216 12389 8075 8068\n    195.239.77.236 from 195.239.77.236 (195.239.77.236)\n      Origin IGP, valid, external\n      Community: 3216:1000 3216:1077 3216:1101\n      Last update: Thu Jun 24 09:14:17 2021\n  11537 8075 8068\n    64.57.28.241 from 64.57.28.241 (64.57.28.241)\n      Origin IGP, metric 17, valid, external\n      Community: 11537:254 11537:3500 11537:5000 11537:5002 11537:5014\n      Last update: Thu Jun 24 08:50:42 2021\n  19653 8075 8068\n    67.219.192.5 from 67.219.192.5 (67.219.192.5)\n      Origin IGP, valid, external\n      Last update: Wed Jun 30 11:14:51 2021\n  14315 6453 6453 8075 8068\n    104.251.122.1 from 104.251.122.1 (104.251.122.1)\n      Origin IGP, valid, external\n      Community: 14315:5000\n      Last update: Tue Jun 22 10:36:25 2021\n  38136 38008 8075 8068\n    103.152.35.22 from 103.152.35.22 (103.152.35.22)\n      Origin IGP, valid, external\n      Community: 38008:103 65521:10\n      Large Community: 38136:1000:11\n      Last update: Tue Jun 22 07:22:58 2021\n  17920 6939 8075 8068\n    103.149.144.251 from 103.149.144.251 (103.149.144.251)\n      Origin IGP, valid, external\n      Community: 17920:1000 17920:1008\n      Last update: Sat Jun 19 01:43:19 2021\n  50236 34549 8075 8068\n    2.56.9.2 from 2.56.9.2 (2.56.9.2)\n      Origin IGP, valid, external\n      Community: 34549:200 34549:10000 50236:10010\n      Last update: Thu Jun 17 16:09:18 2021\n  3280 39737 8075 8068\n    77.83.243.7 from 77.83.243.7 (77.83.243.7)\n      Origin IGP, valid, external\n      Community: 39737:80 39737:2040\n      Last update: Sat Jul  3 23:45:54 2021\n  39120 8075 8068\n    94.101.60.146 from 94.101.60.146 (94.161.60.146)\n      Origin IGP, valid, external\n      Last update: Fri Jun 18 15:06:50 2021\n  207740 58057 8075 8068\n    136.243.0.23 from 136.243.0.23 (136.243.0.23)\n      Origin IGP, valid, external\n      Last update: Tue Jun 22 18:11:37 2021\n  38136 50131 53340 174 8075 8068\n    172.83.155.50 from 172.83.155.50 (172.83.155.50)\n      Origin IGP, valid, external\n      Large Community: 38136:1000:17\n      Last update: Tue Jun  8 08:24:12 2021\n  40387 11537 8075 8068\n    72.36.126.8 from 72.36.126.8 (72.36.126.8)\n      Origin IGP, valid, external\n      Community: 40387:1400\n      Last update: Tue Jun  8 07:02:44 2021\n  38136 57695 8075 8068\n    170.39.224.212 from 170.39.224.212 (170.39.224.212)\n      Origin IGP, valid, external\n      Community: 57695:12000 57695:12002\n      Large Community: 38136:1000:1\n      Last update: Thu May 27 15:18:00 2021\n  3561 209 3356 8075 8068\n    206.24.210.80 from 206.24.210.80 (206.24.210.80)\n      Origin IGP, valid, external\n      Last update: Thu May 27 09:50:45 2021\n  29479 50304 8075 8068\n    109.233.62.1 from 109.233.62.1 (109.233.62.2)\n      Origin IGP, valid, external\n      Last update: Thu May 27 09:50:11 2021\n  209 3356 8075 8068\n    205.171.8.123 from 205.171.8.123 (205.171.8.123)\n      Origin IGP, metric 8000051, valid, external\n      Community: 209:88 209:888 3356:3 3356:22 3356:86 3356:575 3356:666 3356:901 3356:2057 3356:12341\n      Last update: Thu May 27 09:48:26 2021\n  14840 8075 8068\n    186.211.128.32 from 186.211.128.32 (201.16.22.1)\n      Origin IGP, valid, external\n      Community: 14840:10 14840:40 14840:6004 14840:7110\n      Last update: Wed Jun 23 00:56:13 2021\n  209 3356 8075 8068\n    205.171.200.245 from 205.171.200.245 (205.171.200.245)\n      Origin IGP, metric 0, valid, external\n      Community: 209:88 209:888 3356:3 3356:22 3356:86 3356:575 3356:666 3356:901 3356:2059 3356:10327\n      Last update: Thu May 27 09:48:23 2021\n  209 3356 8075 8068\n    205.171.3.54 from 205.171.3.54 (205.171.3.54)\n      Origin IGP, metric 8000036, valid, external\n      Community: 209:88 209:888 3356:3 3356:22 3356:86 3356:575 3356:666 3356:901 3356:2011 3356:11918\n      Last update: Thu May 27 09:48:17 2021\n  23367 8075 8068\n    64.250.124.251 from 64.250.124.251 (64.250.124.251)\n      Origin IGP, valid, external\n      Last update: Thu May 27 09:48:06 2021\n  5650 8075 8068\n    74.40.7.35 from 74.40.7.35 (74.40.0.100)\n      Origin IGP, metric 0, valid, external\n      Last update: Tue May 25 23:52:37 2021\n  38001 8075 8068\n    202.150.221.33 from 202.150.221.33 (10.11.33.29)\n      Origin IGP, valid, external, best (Older Path)\n      Community: 38001:420 38001:2406 38001:3001 38001:8009\n      Last update: Fri May 21 11:01:01 2021\n  6939 8075 8068\n    64.71.137.241 from 64.71.137.241 (216.218.252.164)\n      Origin IGP, valid, external\n      Last update: Fri May 21 10:58:51 2021\n  45352 8075 8068\n    210.5.41.225 from 210.5.41.225 (210.5.40.186)\n      Origin IGP, valid, external\n      Last update: Fri May 21 10:57:46 2021\n  3292 8075 8068\n    195.215.109.247 from 195.215.109.247 (83.88.49.1)\n      Origin IGP, valid, external\n      Community: 3292:1100 3292:24500 3292:24580\n      Last update: Wed Jun  9 23:59:27 2021\n  3257 8075 8068\n    89.149.178.10 from 89.149.178.10 (213.200.83.26)\n      Origin IGP, metric 10, valid, external\n      Community: 3257:4000 3257:8052 3257:50001 3257:50110 3257:54900 3257:54901\n      Last update: Fri Jul  2 03:36:10 2021\n  46450 8075 8068\n    158.106.197.135 from 158.106.197.135 (158.106.197.135)\n      Origin IGP, valid, external\n      Community: 46450:31111\n      Last update: Fri May 21 10:53:55 2021\n  5645 8075 8068\n    206.248.155.130 from 206.248.155.130 (206.248.155.130)\n      Origin IGP, valid, external\n      Community: no-advertise\n      Last update: Fri May 21 10:53:54 2021\n  55222 8075 8068\n    162.211.99.255 from 162.211.99.255 (162.211.99.255)\n      Origin IGP, valid, external\n      Community: 55222:101 55222:200 55222:6001 55222:20020\n      Last update: Fri May 21 10:53:45 2021\n```\n\nAnyCast 典型应用场景：\n\n- DNS：\n- CDN\n- 负载均衡\n- 分散DDOS攻击\n\nReference：\n\nhttps://www.cnblogs.com/itzgr/p/10192799.html\n\nhttps://www.imperva.com/blog/how-anycast-works/\n","source":"_posts/anycast-brief.md","raw":"---\ntitle: 有关AnyCast\ndate: 2021-07-06 14:00:00\ntags: anycast\ndescription: \n---\n\nAnyCast，一组服务器拥有相同的IP地址，当客户端访问该组服务器时，网络会将请求发送至最近的服务器进行处理，从而极大的缩短途径的公网路径，减少延时、抖动、丢包的情况。\n\nAnyCast通常和BGP路由协议关联在一起，其实现的主要原理是：位于不同地理位置的路由器向外发布同一段IP网段的BGP路由，路由在Internet中传播后，访问发起端所处网络的路由器会选择最短的BGP AS Path路由，从而实现最短路径的访问。如果BGP选路区分不出最近的路径，那就由IGP最短路径进行转发。\n\nAnyCast的好处：\n\n- 就近访问，减少时延、提升性能\n- 获得高冗余性和可用性，即当任意目的节点异常时，可自动路由到就近目的节点\n- 实现负载均衡，且对客户端是透明的（由网络路由实现）\n- 缓解DDOS攻击，AnyCast将DDOS攻击流量引导至本地服务器，极大的减少了DDOS流量的范围以及规模\n\n<!-- more -->\n\nOffice 365 的SharePoint使用了AnyCast，例如nslookup 解析[cisco.sharepoint.com](https://cisco.sharepoint.com)、[citrix.sharepoint.com](http://citrix.sharepoint.com)、[intel.sharepoint.com](http://intel.sharepoint.com) 得到相同的地址\n\n```bash\n➜  ~ nslookup cisco.sharepoint.com | tail -n 2 | grep Address\nAddress: 13.107.136.9\n➜  ~ nslookup citrix.sharepoint.com | tail -n 2 | grep Address\nAddress: 13.107.136.9\n➜  ~ nslookup intel.sharepoint.com | tail -n 2 | grep Address\nAddress: 13.107.136.9\n➜  ~ nslookup nike.sharepoint.com | tail -n 2 | grep Address\nAddress: 13.107.136.9\n➜  ~ nslookup bmw.sharepoint.com | tail -n 2 | grep Address\nAddress: 13.107.136.9\n```\n\nTelnet 至 route-views3.routeviews.org 查询13.107.136.9的路由，发现该地址命中的路由是13.107.136.0/24，从AS 8068 -- AS 8075发布出来，这都是Microsoft的AS号。\n\n```\nroute-views3.routeviews.org> show bgp ipv4 13.107.136.9\nBGP routing table entry for 13.107.136.0/24\nPaths: (40 available, best #33, table default)\n  Not advertised to any peer\n  61568 8075 8068\n    190.15.124.18 from 190.15.124.18 (190.15.124.18)\n      Origin IGP, valid, external\n      Last update: Mon Jul  5 21:13:03 2021\n  202365 49697 8075 8068\n    194.50.19.4 from 194.50.19.4 (185.1.166.50)\n      Origin IGP, valid, external\n      Community: 49697:3000 65101:1002 65102:1000 65103:276 65104:150\n      Last update: Sun Jul  4 17:31:02 2021\n  39120 8075 8068\n    89.21.210.85 from 89.21.210.85 (195.60.191.13)\n      Origin IGP, valid, external\n      Last update: Sat Jul  3 20:46:17 2021\n  40630 6939 8075 8068\n    208.94.118.10 from 208.94.118.10 (208.94.118.10)\n      Origin IGP, valid, external\n      Community: 40630:100 40630:11701\n      Last update: Mon Jul  5 19:14:13 2021\n  54574 8075 8068\n    154.18.7.114 from 154.18.7.114 (193.41.248.191)\n      Origin IGP, valid, external\n      Community: 54574:1000\n      Last update: Wed Jun 30 02:40:58 2021\n  39120 8075 8068\n    89.21.210.86 from 89.21.210.86 (195.60.190.28)\n      Origin IGP, valid, external\n      Last update: Mon Jun 28 17:54:55 2021\n  64116 7195 8075 8068\n    45.183.45.1 from 45.183.45.1 (10.7.1.1)\n      Origin IGP, valid, external\n      Community: 7195:1000 7195:1001 7195:1300 7195:1302\n      Last update: Fri Jul  2 00:44:52 2021\n  54574 6461 8075 8068\n    38.19.140.162 from 38.19.140.162 (193.41.248.193)\n      Origin IGP, valid, external\n      Community: 6461:5997 54574:2000 54574:6461\n      Last update: Mon Jun 28 07:19:51 2021\n  39351 8075 8068\n    193.138.216.164 from 193.138.216.164 (193.138.216.164)\n      Origin IGP, valid, external\n      Last update: Fri Jun 25 20:17:33 2021\n  202365 57866 8075 8068\n    5.255.90.109 from 5.255.90.109 (185.255.155.66)\n      Origin IGP, metric 0, valid, external\n      Community: 57866:12 57866:304 57866:501\n      Large Community: 57866:41441:41441\n      Last update: Sun Jun 27 19:25:03 2021\n  3216 12389 8075 8068\n    195.239.252.124 from 195.239.252.124 (195.239.252.124)\n      Origin IGP, valid, external\n      Community: 3216:1000 3216:1077 3216:1101\n      Last update: Thu Jun 24 09:16:54 2021\n  3216 12389 8075 8068\n    195.239.77.236 from 195.239.77.236 (195.239.77.236)\n      Origin IGP, valid, external\n      Community: 3216:1000 3216:1077 3216:1101\n      Last update: Thu Jun 24 09:14:17 2021\n  11537 8075 8068\n    64.57.28.241 from 64.57.28.241 (64.57.28.241)\n      Origin IGP, metric 17, valid, external\n      Community: 11537:254 11537:3500 11537:5000 11537:5002 11537:5014\n      Last update: Thu Jun 24 08:50:42 2021\n  19653 8075 8068\n    67.219.192.5 from 67.219.192.5 (67.219.192.5)\n      Origin IGP, valid, external\n      Last update: Wed Jun 30 11:14:51 2021\n  14315 6453 6453 8075 8068\n    104.251.122.1 from 104.251.122.1 (104.251.122.1)\n      Origin IGP, valid, external\n      Community: 14315:5000\n      Last update: Tue Jun 22 10:36:25 2021\n  38136 38008 8075 8068\n    103.152.35.22 from 103.152.35.22 (103.152.35.22)\n      Origin IGP, valid, external\n      Community: 38008:103 65521:10\n      Large Community: 38136:1000:11\n      Last update: Tue Jun 22 07:22:58 2021\n  17920 6939 8075 8068\n    103.149.144.251 from 103.149.144.251 (103.149.144.251)\n      Origin IGP, valid, external\n      Community: 17920:1000 17920:1008\n      Last update: Sat Jun 19 01:43:19 2021\n  50236 34549 8075 8068\n    2.56.9.2 from 2.56.9.2 (2.56.9.2)\n      Origin IGP, valid, external\n      Community: 34549:200 34549:10000 50236:10010\n      Last update: Thu Jun 17 16:09:18 2021\n  3280 39737 8075 8068\n    77.83.243.7 from 77.83.243.7 (77.83.243.7)\n      Origin IGP, valid, external\n      Community: 39737:80 39737:2040\n      Last update: Sat Jul  3 23:45:54 2021\n  39120 8075 8068\n    94.101.60.146 from 94.101.60.146 (94.161.60.146)\n      Origin IGP, valid, external\n      Last update: Fri Jun 18 15:06:50 2021\n  207740 58057 8075 8068\n    136.243.0.23 from 136.243.0.23 (136.243.0.23)\n      Origin IGP, valid, external\n      Last update: Tue Jun 22 18:11:37 2021\n  38136 50131 53340 174 8075 8068\n    172.83.155.50 from 172.83.155.50 (172.83.155.50)\n      Origin IGP, valid, external\n      Large Community: 38136:1000:17\n      Last update: Tue Jun  8 08:24:12 2021\n  40387 11537 8075 8068\n    72.36.126.8 from 72.36.126.8 (72.36.126.8)\n      Origin IGP, valid, external\n      Community: 40387:1400\n      Last update: Tue Jun  8 07:02:44 2021\n  38136 57695 8075 8068\n    170.39.224.212 from 170.39.224.212 (170.39.224.212)\n      Origin IGP, valid, external\n      Community: 57695:12000 57695:12002\n      Large Community: 38136:1000:1\n      Last update: Thu May 27 15:18:00 2021\n  3561 209 3356 8075 8068\n    206.24.210.80 from 206.24.210.80 (206.24.210.80)\n      Origin IGP, valid, external\n      Last update: Thu May 27 09:50:45 2021\n  29479 50304 8075 8068\n    109.233.62.1 from 109.233.62.1 (109.233.62.2)\n      Origin IGP, valid, external\n      Last update: Thu May 27 09:50:11 2021\n  209 3356 8075 8068\n    205.171.8.123 from 205.171.8.123 (205.171.8.123)\n      Origin IGP, metric 8000051, valid, external\n      Community: 209:88 209:888 3356:3 3356:22 3356:86 3356:575 3356:666 3356:901 3356:2057 3356:12341\n      Last update: Thu May 27 09:48:26 2021\n  14840 8075 8068\n    186.211.128.32 from 186.211.128.32 (201.16.22.1)\n      Origin IGP, valid, external\n      Community: 14840:10 14840:40 14840:6004 14840:7110\n      Last update: Wed Jun 23 00:56:13 2021\n  209 3356 8075 8068\n    205.171.200.245 from 205.171.200.245 (205.171.200.245)\n      Origin IGP, metric 0, valid, external\n      Community: 209:88 209:888 3356:3 3356:22 3356:86 3356:575 3356:666 3356:901 3356:2059 3356:10327\n      Last update: Thu May 27 09:48:23 2021\n  209 3356 8075 8068\n    205.171.3.54 from 205.171.3.54 (205.171.3.54)\n      Origin IGP, metric 8000036, valid, external\n      Community: 209:88 209:888 3356:3 3356:22 3356:86 3356:575 3356:666 3356:901 3356:2011 3356:11918\n      Last update: Thu May 27 09:48:17 2021\n  23367 8075 8068\n    64.250.124.251 from 64.250.124.251 (64.250.124.251)\n      Origin IGP, valid, external\n      Last update: Thu May 27 09:48:06 2021\n  5650 8075 8068\n    74.40.7.35 from 74.40.7.35 (74.40.0.100)\n      Origin IGP, metric 0, valid, external\n      Last update: Tue May 25 23:52:37 2021\n  38001 8075 8068\n    202.150.221.33 from 202.150.221.33 (10.11.33.29)\n      Origin IGP, valid, external, best (Older Path)\n      Community: 38001:420 38001:2406 38001:3001 38001:8009\n      Last update: Fri May 21 11:01:01 2021\n  6939 8075 8068\n    64.71.137.241 from 64.71.137.241 (216.218.252.164)\n      Origin IGP, valid, external\n      Last update: Fri May 21 10:58:51 2021\n  45352 8075 8068\n    210.5.41.225 from 210.5.41.225 (210.5.40.186)\n      Origin IGP, valid, external\n      Last update: Fri May 21 10:57:46 2021\n  3292 8075 8068\n    195.215.109.247 from 195.215.109.247 (83.88.49.1)\n      Origin IGP, valid, external\n      Community: 3292:1100 3292:24500 3292:24580\n      Last update: Wed Jun  9 23:59:27 2021\n  3257 8075 8068\n    89.149.178.10 from 89.149.178.10 (213.200.83.26)\n      Origin IGP, metric 10, valid, external\n      Community: 3257:4000 3257:8052 3257:50001 3257:50110 3257:54900 3257:54901\n      Last update: Fri Jul  2 03:36:10 2021\n  46450 8075 8068\n    158.106.197.135 from 158.106.197.135 (158.106.197.135)\n      Origin IGP, valid, external\n      Community: 46450:31111\n      Last update: Fri May 21 10:53:55 2021\n  5645 8075 8068\n    206.248.155.130 from 206.248.155.130 (206.248.155.130)\n      Origin IGP, valid, external\n      Community: no-advertise\n      Last update: Fri May 21 10:53:54 2021\n  55222 8075 8068\n    162.211.99.255 from 162.211.99.255 (162.211.99.255)\n      Origin IGP, valid, external\n      Community: 55222:101 55222:200 55222:6001 55222:20020\n      Last update: Fri May 21 10:53:45 2021\n```\n\nAnyCast 典型应用场景：\n\n- DNS：\n- CDN\n- 负载均衡\n- 分散DDOS攻击\n\nReference：\n\nhttps://www.cnblogs.com/itzgr/p/10192799.html\n\nhttps://www.imperva.com/blog/how-anycast-works/\n","slug":"anycast-brief","published":1,"updated":"2025-12-14T09:50:07.440Z","comments":1,"layout":"post","photos":[],"_id":"cuiduwhVLGliVaOsJLVasBbIs","content":"<p>AnyCast，一组服务器拥有相同的IP地址，当客户端访问该组服务器时，网络会将请求发送至最近的服务器进行处理，从而极大的缩短途径的公网路径，减少延时、抖动、丢包的情况。</p>\n<p>AnyCast通常和BGP路由协议关联在一起，其实现的主要原理是：位于不同地理位置的路由器向外发布同一段IP网段的BGP路由，路由在Internet中传播后，访问发起端所处网络的路由器会选择最短的BGP AS Path路由，从而实现最短路径的访问。如果BGP选路区分不出最近的路径，那就由IGP最短路径进行转发。</p>\n<p>AnyCast的好处：</p>\n<ul>\n<li>就近访问，减少时延、提升性能</li>\n<li>获得高冗余性和可用性，即当任意目的节点异常时，可自动路由到就近目的节点</li>\n<li>实现负载均衡，且对客户端是透明的（由网络路由实现）</li>\n<li>缓解DDOS攻击，AnyCast将DDOS攻击流量引导至本地服务器，极大的减少了DDOS流量的范围以及规模</li>\n</ul>\n<span id=\"more\"></span>\n\n<p>Office 365 的SharePoint使用了AnyCast，例如nslookup 解析<a href=\"https://cisco.sharepoint.com/\">cisco.sharepoint.com</a>、<a href=\"http://citrix.sharepoint.com/\">citrix.sharepoint.com</a>、<a href=\"http://intel.sharepoint.com/\">intel.sharepoint.com</a> 得到相同的地址</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  ~ nslookup cisco.sharepoint.com | <span class=\"built_in\">tail</span> -n 2 | grep Address</span><br><span class=\"line\">Address: 13.107.136.9</span><br><span class=\"line\">➜  ~ nslookup citrix.sharepoint.com | <span class=\"built_in\">tail</span> -n 2 | grep Address</span><br><span class=\"line\">Address: 13.107.136.9</span><br><span class=\"line\">➜  ~ nslookup intel.sharepoint.com | <span class=\"built_in\">tail</span> -n 2 | grep Address</span><br><span class=\"line\">Address: 13.107.136.9</span><br><span class=\"line\">➜  ~ nslookup nike.sharepoint.com | <span class=\"built_in\">tail</span> -n 2 | grep Address</span><br><span class=\"line\">Address: 13.107.136.9</span><br><span class=\"line\">➜  ~ nslookup bmw.sharepoint.com | <span class=\"built_in\">tail</span> -n 2 | grep Address</span><br><span class=\"line\">Address: 13.107.136.9</span><br></pre></td></tr></table></figure>\n\n<p>Telnet 至 route-views3.routeviews.org 查询13.107.136.9的路由，发现该地址命中的路由是13.107.136.0&#x2F;24，从AS 8068 – AS 8075发布出来，这都是Microsoft的AS号。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">route-views3.routeviews.org&gt; show bgp ipv4 13.107.136.9</span><br><span class=\"line\">BGP routing table entry for 13.107.136.0/24</span><br><span class=\"line\">Paths: (40 available, best #33, table default)</span><br><span class=\"line\">  Not advertised to any peer</span><br><span class=\"line\">  61568 8075 8068</span><br><span class=\"line\">    190.15.124.18 from 190.15.124.18 (190.15.124.18)</span><br><span class=\"line\">      Origin IGP, valid, external</span><br><span class=\"line\">      Last update: Mon Jul  5 21:13:03 2021</span><br><span class=\"line\">  202365 49697 8075 8068</span><br><span class=\"line\">    194.50.19.4 from 194.50.19.4 (185.1.166.50)</span><br><span class=\"line\">      Origin IGP, valid, external</span><br><span class=\"line\">      Community: 49697:3000 65101:1002 65102:1000 65103:276 65104:150</span><br><span class=\"line\">      Last update: Sun Jul  4 17:31:02 2021</span><br><span class=\"line\">  39120 8075 8068</span><br><span class=\"line\">    89.21.210.85 from 89.21.210.85 (195.60.191.13)</span><br><span class=\"line\">      Origin IGP, valid, external</span><br><span class=\"line\">      Last update: Sat Jul  3 20:46:17 2021</span><br><span class=\"line\">  40630 6939 8075 8068</span><br><span class=\"line\">    208.94.118.10 from 208.94.118.10 (208.94.118.10)</span><br><span class=\"line\">      Origin IGP, valid, external</span><br><span class=\"line\">      Community: 40630:100 40630:11701</span><br><span class=\"line\">      Last update: Mon Jul  5 19:14:13 2021</span><br><span class=\"line\">  54574 8075 8068</span><br><span class=\"line\">    154.18.7.114 from 154.18.7.114 (193.41.248.191)</span><br><span class=\"line\">      Origin IGP, valid, external</span><br><span class=\"line\">      Community: 54574:1000</span><br><span class=\"line\">      Last update: Wed Jun 30 02:40:58 2021</span><br><span class=\"line\">  39120 8075 8068</span><br><span class=\"line\">    89.21.210.86 from 89.21.210.86 (195.60.190.28)</span><br><span class=\"line\">      Origin IGP, valid, external</span><br><span class=\"line\">      Last update: Mon Jun 28 17:54:55 2021</span><br><span class=\"line\">  64116 7195 8075 8068</span><br><span class=\"line\">    45.183.45.1 from 45.183.45.1 (10.7.1.1)</span><br><span class=\"line\">      Origin IGP, valid, external</span><br><span class=\"line\">      Community: 7195:1000 7195:1001 7195:1300 7195:1302</span><br><span class=\"line\">      Last update: Fri Jul  2 00:44:52 2021</span><br><span class=\"line\">  54574 6461 8075 8068</span><br><span class=\"line\">    38.19.140.162 from 38.19.140.162 (193.41.248.193)</span><br><span class=\"line\">      Origin IGP, valid, external</span><br><span class=\"line\">      Community: 6461:5997 54574:2000 54574:6461</span><br><span class=\"line\">      Last update: Mon Jun 28 07:19:51 2021</span><br><span class=\"line\">  39351 8075 8068</span><br><span class=\"line\">    193.138.216.164 from 193.138.216.164 (193.138.216.164)</span><br><span class=\"line\">      Origin IGP, valid, external</span><br><span class=\"line\">      Last update: Fri Jun 25 20:17:33 2021</span><br><span class=\"line\">  202365 57866 8075 8068</span><br><span class=\"line\">    5.255.90.109 from 5.255.90.109 (185.255.155.66)</span><br><span class=\"line\">      Origin IGP, metric 0, valid, external</span><br><span class=\"line\">      Community: 57866:12 57866:304 57866:501</span><br><span class=\"line\">      Large Community: 57866:41441:41441</span><br><span class=\"line\">      Last update: Sun Jun 27 19:25:03 2021</span><br><span class=\"line\">  3216 12389 8075 8068</span><br><span class=\"line\">    195.239.252.124 from 195.239.252.124 (195.239.252.124)</span><br><span class=\"line\">      Origin IGP, valid, external</span><br><span class=\"line\">      Community: 3216:1000 3216:1077 3216:1101</span><br><span class=\"line\">      Last update: Thu Jun 24 09:16:54 2021</span><br><span class=\"line\">  3216 12389 8075 8068</span><br><span class=\"line\">    195.239.77.236 from 195.239.77.236 (195.239.77.236)</span><br><span class=\"line\">      Origin IGP, valid, external</span><br><span class=\"line\">      Community: 3216:1000 3216:1077 3216:1101</span><br><span class=\"line\">      Last update: Thu Jun 24 09:14:17 2021</span><br><span class=\"line\">  11537 8075 8068</span><br><span class=\"line\">    64.57.28.241 from 64.57.28.241 (64.57.28.241)</span><br><span class=\"line\">      Origin IGP, metric 17, valid, external</span><br><span class=\"line\">      Community: 11537:254 11537:3500 11537:5000 11537:5002 11537:5014</span><br><span class=\"line\">      Last update: Thu Jun 24 08:50:42 2021</span><br><span class=\"line\">  19653 8075 8068</span><br><span class=\"line\">    67.219.192.5 from 67.219.192.5 (67.219.192.5)</span><br><span class=\"line\">      Origin IGP, valid, external</span><br><span class=\"line\">      Last update: Wed Jun 30 11:14:51 2021</span><br><span class=\"line\">  14315 6453 6453 8075 8068</span><br><span class=\"line\">    104.251.122.1 from 104.251.122.1 (104.251.122.1)</span><br><span class=\"line\">      Origin IGP, valid, external</span><br><span class=\"line\">      Community: 14315:5000</span><br><span class=\"line\">      Last update: Tue Jun 22 10:36:25 2021</span><br><span class=\"line\">  38136 38008 8075 8068</span><br><span class=\"line\">    103.152.35.22 from 103.152.35.22 (103.152.35.22)</span><br><span class=\"line\">      Origin IGP, valid, external</span><br><span class=\"line\">      Community: 38008:103 65521:10</span><br><span class=\"line\">      Large Community: 38136:1000:11</span><br><span class=\"line\">      Last update: Tue Jun 22 07:22:58 2021</span><br><span class=\"line\">  17920 6939 8075 8068</span><br><span class=\"line\">    103.149.144.251 from 103.149.144.251 (103.149.144.251)</span><br><span class=\"line\">      Origin IGP, valid, external</span><br><span class=\"line\">      Community: 17920:1000 17920:1008</span><br><span class=\"line\">      Last update: Sat Jun 19 01:43:19 2021</span><br><span class=\"line\">  50236 34549 8075 8068</span><br><span class=\"line\">    2.56.9.2 from 2.56.9.2 (2.56.9.2)</span><br><span class=\"line\">      Origin IGP, valid, external</span><br><span class=\"line\">      Community: 34549:200 34549:10000 50236:10010</span><br><span class=\"line\">      Last update: Thu Jun 17 16:09:18 2021</span><br><span class=\"line\">  3280 39737 8075 8068</span><br><span class=\"line\">    77.83.243.7 from 77.83.243.7 (77.83.243.7)</span><br><span class=\"line\">      Origin IGP, valid, external</span><br><span class=\"line\">      Community: 39737:80 39737:2040</span><br><span class=\"line\">      Last update: Sat Jul  3 23:45:54 2021</span><br><span class=\"line\">  39120 8075 8068</span><br><span class=\"line\">    94.101.60.146 from 94.101.60.146 (94.161.60.146)</span><br><span class=\"line\">      Origin IGP, valid, external</span><br><span class=\"line\">      Last update: Fri Jun 18 15:06:50 2021</span><br><span class=\"line\">  207740 58057 8075 8068</span><br><span class=\"line\">    136.243.0.23 from 136.243.0.23 (136.243.0.23)</span><br><span class=\"line\">      Origin IGP, valid, external</span><br><span class=\"line\">      Last update: Tue Jun 22 18:11:37 2021</span><br><span class=\"line\">  38136 50131 53340 174 8075 8068</span><br><span class=\"line\">    172.83.155.50 from 172.83.155.50 (172.83.155.50)</span><br><span class=\"line\">      Origin IGP, valid, external</span><br><span class=\"line\">      Large Community: 38136:1000:17</span><br><span class=\"line\">      Last update: Tue Jun  8 08:24:12 2021</span><br><span class=\"line\">  40387 11537 8075 8068</span><br><span class=\"line\">    72.36.126.8 from 72.36.126.8 (72.36.126.8)</span><br><span class=\"line\">      Origin IGP, valid, external</span><br><span class=\"line\">      Community: 40387:1400</span><br><span class=\"line\">      Last update: Tue Jun  8 07:02:44 2021</span><br><span class=\"line\">  38136 57695 8075 8068</span><br><span class=\"line\">    170.39.224.212 from 170.39.224.212 (170.39.224.212)</span><br><span class=\"line\">      Origin IGP, valid, external</span><br><span class=\"line\">      Community: 57695:12000 57695:12002</span><br><span class=\"line\">      Large Community: 38136:1000:1</span><br><span class=\"line\">      Last update: Thu May 27 15:18:00 2021</span><br><span class=\"line\">  3561 209 3356 8075 8068</span><br><span class=\"line\">    206.24.210.80 from 206.24.210.80 (206.24.210.80)</span><br><span class=\"line\">      Origin IGP, valid, external</span><br><span class=\"line\">      Last update: Thu May 27 09:50:45 2021</span><br><span class=\"line\">  29479 50304 8075 8068</span><br><span class=\"line\">    109.233.62.1 from 109.233.62.1 (109.233.62.2)</span><br><span class=\"line\">      Origin IGP, valid, external</span><br><span class=\"line\">      Last update: Thu May 27 09:50:11 2021</span><br><span class=\"line\">  209 3356 8075 8068</span><br><span class=\"line\">    205.171.8.123 from 205.171.8.123 (205.171.8.123)</span><br><span class=\"line\">      Origin IGP, metric 8000051, valid, external</span><br><span class=\"line\">      Community: 209:88 209:888 3356:3 3356:22 3356:86 3356:575 3356:666 3356:901 3356:2057 3356:12341</span><br><span class=\"line\">      Last update: Thu May 27 09:48:26 2021</span><br><span class=\"line\">  14840 8075 8068</span><br><span class=\"line\">    186.211.128.32 from 186.211.128.32 (201.16.22.1)</span><br><span class=\"line\">      Origin IGP, valid, external</span><br><span class=\"line\">      Community: 14840:10 14840:40 14840:6004 14840:7110</span><br><span class=\"line\">      Last update: Wed Jun 23 00:56:13 2021</span><br><span class=\"line\">  209 3356 8075 8068</span><br><span class=\"line\">    205.171.200.245 from 205.171.200.245 (205.171.200.245)</span><br><span class=\"line\">      Origin IGP, metric 0, valid, external</span><br><span class=\"line\">      Community: 209:88 209:888 3356:3 3356:22 3356:86 3356:575 3356:666 3356:901 3356:2059 3356:10327</span><br><span class=\"line\">      Last update: Thu May 27 09:48:23 2021</span><br><span class=\"line\">  209 3356 8075 8068</span><br><span class=\"line\">    205.171.3.54 from 205.171.3.54 (205.171.3.54)</span><br><span class=\"line\">      Origin IGP, metric 8000036, valid, external</span><br><span class=\"line\">      Community: 209:88 209:888 3356:3 3356:22 3356:86 3356:575 3356:666 3356:901 3356:2011 3356:11918</span><br><span class=\"line\">      Last update: Thu May 27 09:48:17 2021</span><br><span class=\"line\">  23367 8075 8068</span><br><span class=\"line\">    64.250.124.251 from 64.250.124.251 (64.250.124.251)</span><br><span class=\"line\">      Origin IGP, valid, external</span><br><span class=\"line\">      Last update: Thu May 27 09:48:06 2021</span><br><span class=\"line\">  5650 8075 8068</span><br><span class=\"line\">    74.40.7.35 from 74.40.7.35 (74.40.0.100)</span><br><span class=\"line\">      Origin IGP, metric 0, valid, external</span><br><span class=\"line\">      Last update: Tue May 25 23:52:37 2021</span><br><span class=\"line\">  38001 8075 8068</span><br><span class=\"line\">    202.150.221.33 from 202.150.221.33 (10.11.33.29)</span><br><span class=\"line\">      Origin IGP, valid, external, best (Older Path)</span><br><span class=\"line\">      Community: 38001:420 38001:2406 38001:3001 38001:8009</span><br><span class=\"line\">      Last update: Fri May 21 11:01:01 2021</span><br><span class=\"line\">  6939 8075 8068</span><br><span class=\"line\">    64.71.137.241 from 64.71.137.241 (216.218.252.164)</span><br><span class=\"line\">      Origin IGP, valid, external</span><br><span class=\"line\">      Last update: Fri May 21 10:58:51 2021</span><br><span class=\"line\">  45352 8075 8068</span><br><span class=\"line\">    210.5.41.225 from 210.5.41.225 (210.5.40.186)</span><br><span class=\"line\">      Origin IGP, valid, external</span><br><span class=\"line\">      Last update: Fri May 21 10:57:46 2021</span><br><span class=\"line\">  3292 8075 8068</span><br><span class=\"line\">    195.215.109.247 from 195.215.109.247 (83.88.49.1)</span><br><span class=\"line\">      Origin IGP, valid, external</span><br><span class=\"line\">      Community: 3292:1100 3292:24500 3292:24580</span><br><span class=\"line\">      Last update: Wed Jun  9 23:59:27 2021</span><br><span class=\"line\">  3257 8075 8068</span><br><span class=\"line\">    89.149.178.10 from 89.149.178.10 (213.200.83.26)</span><br><span class=\"line\">      Origin IGP, metric 10, valid, external</span><br><span class=\"line\">      Community: 3257:4000 3257:8052 3257:50001 3257:50110 3257:54900 3257:54901</span><br><span class=\"line\">      Last update: Fri Jul  2 03:36:10 2021</span><br><span class=\"line\">  46450 8075 8068</span><br><span class=\"line\">    158.106.197.135 from 158.106.197.135 (158.106.197.135)</span><br><span class=\"line\">      Origin IGP, valid, external</span><br><span class=\"line\">      Community: 46450:31111</span><br><span class=\"line\">      Last update: Fri May 21 10:53:55 2021</span><br><span class=\"line\">  5645 8075 8068</span><br><span class=\"line\">    206.248.155.130 from 206.248.155.130 (206.248.155.130)</span><br><span class=\"line\">      Origin IGP, valid, external</span><br><span class=\"line\">      Community: no-advertise</span><br><span class=\"line\">      Last update: Fri May 21 10:53:54 2021</span><br><span class=\"line\">  55222 8075 8068</span><br><span class=\"line\">    162.211.99.255 from 162.211.99.255 (162.211.99.255)</span><br><span class=\"line\">      Origin IGP, valid, external</span><br><span class=\"line\">      Community: 55222:101 55222:200 55222:6001 55222:20020</span><br><span class=\"line\">      Last update: Fri May 21 10:53:45 2021</span><br></pre></td></tr></table></figure>\n\n<p>AnyCast 典型应用场景：</p>\n<ul>\n<li>DNS：</li>\n<li>CDN</li>\n<li>负载均衡</li>\n<li>分散DDOS攻击</li>\n</ul>\n<p>Reference：</p>\n<p><a href=\"https://www.cnblogs.com/itzgr/p/10192799.html\">https://www.cnblogs.com/itzgr/p/10192799.html</a></p>\n<p><a href=\"https://www.imperva.com/blog/how-anycast-works/\">https://www.imperva.com/blog/how-anycast-works/</a></p>\n","length":1540,"excerpt":"<p>AnyCast，一组服务器拥有相同的IP地址，当客户端访问该组服务器时，网络会将请求发送至最近的服务器进行处理，从而极大的缩短途径的公网路径，减少延时、抖动、丢包的情况。</p>\n<p>AnyCast通常和BGP路由协议关联在一起，其实现的主要原理是：位于不同地理位置的路由器向外发布同一段IP网段的BGP路由，路由在Internet中传播后，访问发起端所处网络的路由器会选择最短的BGP AS Path路由，从而实现最短路径的访问。如果BGP选路区分不出最近的路径，那就由IGP最短路径进行转发。</p>\n<p>AnyCast的好处：</p>\n<ul>\n<li>就近访问，减少时延、提升性能</li>\n<li>获得高冗余性和可用性，即当任意目的节点异常时，可自动路由到就近目的节点</li>\n<li>实现负载均衡，且对客户端是透明的（由网络路由实现）</li>\n<li>缓解DDOS攻击，AnyCast将DDOS攻击流量引导至本地服务器，极大的减少了DDOS流量的范围以及规模</li>\n</ul>","more":"<p>Office 365 的SharePoint使用了AnyCast，例如nslookup 解析<a href=\"https://cisco.sharepoint.com/\">cisco.sharepoint.com</a>、<a href=\"http://citrix.sharepoint.com/\">citrix.sharepoint.com</a>、<a href=\"http://intel.sharepoint.com/\">intel.sharepoint.com</a> 得到相同的地址</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  ~ nslookup cisco.sharepoint.com | <span class=\"built_in\">tail</span> -n 2 | grep Address</span><br><span class=\"line\">Address: 13.107.136.9</span><br><span class=\"line\">➜  ~ nslookup citrix.sharepoint.com | <span class=\"built_in\">tail</span> -n 2 | grep Address</span><br><span class=\"line\">Address: 13.107.136.9</span><br><span class=\"line\">➜  ~ nslookup intel.sharepoint.com | <span class=\"built_in\">tail</span> -n 2 | grep Address</span><br><span class=\"line\">Address: 13.107.136.9</span><br><span class=\"line\">➜  ~ nslookup nike.sharepoint.com | <span class=\"built_in\">tail</span> -n 2 | grep Address</span><br><span class=\"line\">Address: 13.107.136.9</span><br><span class=\"line\">➜  ~ nslookup bmw.sharepoint.com | <span class=\"built_in\">tail</span> -n 2 | grep Address</span><br><span class=\"line\">Address: 13.107.136.9</span><br></pre></td></tr></table></figure>\n\n<p>Telnet 至 route-views3.routeviews.org 查询13.107.136.9的路由，发现该地址命中的路由是13.107.136.0&#x2F;24，从AS 8068 – AS 8075发布出来，这都是Microsoft的AS号。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">route-views3.routeviews.org&gt; show bgp ipv4 13.107.136.9</span><br><span class=\"line\">BGP routing table entry for 13.107.136.0/24</span><br><span class=\"line\">Paths: (40 available, best #33, table default)</span><br><span class=\"line\">  Not advertised to any peer</span><br><span class=\"line\">  61568 8075 8068</span><br><span class=\"line\">    190.15.124.18 from 190.15.124.18 (190.15.124.18)</span><br><span class=\"line\">      Origin IGP, valid, external</span><br><span class=\"line\">      Last update: Mon Jul  5 21:13:03 2021</span><br><span class=\"line\">  202365 49697 8075 8068</span><br><span class=\"line\">    194.50.19.4 from 194.50.19.4 (185.1.166.50)</span><br><span class=\"line\">      Origin IGP, valid, external</span><br><span class=\"line\">      Community: 49697:3000 65101:1002 65102:1000 65103:276 65104:150</span><br><span class=\"line\">      Last update: Sun Jul  4 17:31:02 2021</span><br><span class=\"line\">  39120 8075 8068</span><br><span class=\"line\">    89.21.210.85 from 89.21.210.85 (195.60.191.13)</span><br><span class=\"line\">      Origin IGP, valid, external</span><br><span class=\"line\">      Last update: Sat Jul  3 20:46:17 2021</span><br><span class=\"line\">  40630 6939 8075 8068</span><br><span class=\"line\">    208.94.118.10 from 208.94.118.10 (208.94.118.10)</span><br><span class=\"line\">      Origin IGP, valid, external</span><br><span class=\"line\">      Community: 40630:100 40630:11701</span><br><span class=\"line\">      Last update: Mon Jul  5 19:14:13 2021</span><br><span class=\"line\">  54574 8075 8068</span><br><span class=\"line\">    154.18.7.114 from 154.18.7.114 (193.41.248.191)</span><br><span class=\"line\">      Origin IGP, valid, external</span><br><span class=\"line\">      Community: 54574:1000</span><br><span class=\"line\">      Last update: Wed Jun 30 02:40:58 2021</span><br><span class=\"line\">  39120 8075 8068</span><br><span class=\"line\">    89.21.210.86 from 89.21.210.86 (195.60.190.28)</span><br><span class=\"line\">      Origin IGP, valid, external</span><br><span class=\"line\">      Last update: Mon Jun 28 17:54:55 2021</span><br><span class=\"line\">  64116 7195 8075 8068</span><br><span class=\"line\">    45.183.45.1 from 45.183.45.1 (10.7.1.1)</span><br><span class=\"line\">      Origin IGP, valid, external</span><br><span class=\"line\">      Community: 7195:1000 7195:1001 7195:1300 7195:1302</span><br><span class=\"line\">      Last update: Fri Jul  2 00:44:52 2021</span><br><span class=\"line\">  54574 6461 8075 8068</span><br><span class=\"line\">    38.19.140.162 from 38.19.140.162 (193.41.248.193)</span><br><span class=\"line\">      Origin IGP, valid, external</span><br><span class=\"line\">      Community: 6461:5997 54574:2000 54574:6461</span><br><span class=\"line\">      Last update: Mon Jun 28 07:19:51 2021</span><br><span class=\"line\">  39351 8075 8068</span><br><span class=\"line\">    193.138.216.164 from 193.138.216.164 (193.138.216.164)</span><br><span class=\"line\">      Origin IGP, valid, external</span><br><span class=\"line\">      Last update: Fri Jun 25 20:17:33 2021</span><br><span class=\"line\">  202365 57866 8075 8068</span><br><span class=\"line\">    5.255.90.109 from 5.255.90.109 (185.255.155.66)</span><br><span class=\"line\">      Origin IGP, metric 0, valid, external</span><br><span class=\"line\">      Community: 57866:12 57866:304 57866:501</span><br><span class=\"line\">      Large Community: 57866:41441:41441</span><br><span class=\"line\">      Last update: Sun Jun 27 19:25:03 2021</span><br><span class=\"line\">  3216 12389 8075 8068</span><br><span class=\"line\">    195.239.252.124 from 195.239.252.124 (195.239.252.124)</span><br><span class=\"line\">      Origin IGP, valid, external</span><br><span class=\"line\">      Community: 3216:1000 3216:1077 3216:1101</span><br><span class=\"line\">      Last update: Thu Jun 24 09:16:54 2021</span><br><span class=\"line\">  3216 12389 8075 8068</span><br><span class=\"line\">    195.239.77.236 from 195.239.77.236 (195.239.77.236)</span><br><span class=\"line\">      Origin IGP, valid, external</span><br><span class=\"line\">      Community: 3216:1000 3216:1077 3216:1101</span><br><span class=\"line\">      Last update: Thu Jun 24 09:14:17 2021</span><br><span class=\"line\">  11537 8075 8068</span><br><span class=\"line\">    64.57.28.241 from 64.57.28.241 (64.57.28.241)</span><br><span class=\"line\">      Origin IGP, metric 17, valid, external</span><br><span class=\"line\">      Community: 11537:254 11537:3500 11537:5000 11537:5002 11537:5014</span><br><span class=\"line\">      Last update: Thu Jun 24 08:50:42 2021</span><br><span class=\"line\">  19653 8075 8068</span><br><span class=\"line\">    67.219.192.5 from 67.219.192.5 (67.219.192.5)</span><br><span class=\"line\">      Origin IGP, valid, external</span><br><span class=\"line\">      Last update: Wed Jun 30 11:14:51 2021</span><br><span class=\"line\">  14315 6453 6453 8075 8068</span><br><span class=\"line\">    104.251.122.1 from 104.251.122.1 (104.251.122.1)</span><br><span class=\"line\">      Origin IGP, valid, external</span><br><span class=\"line\">      Community: 14315:5000</span><br><span class=\"line\">      Last update: Tue Jun 22 10:36:25 2021</span><br><span class=\"line\">  38136 38008 8075 8068</span><br><span class=\"line\">    103.152.35.22 from 103.152.35.22 (103.152.35.22)</span><br><span class=\"line\">      Origin IGP, valid, external</span><br><span class=\"line\">      Community: 38008:103 65521:10</span><br><span class=\"line\">      Large Community: 38136:1000:11</span><br><span class=\"line\">      Last update: Tue Jun 22 07:22:58 2021</span><br><span class=\"line\">  17920 6939 8075 8068</span><br><span class=\"line\">    103.149.144.251 from 103.149.144.251 (103.149.144.251)</span><br><span class=\"line\">      Origin IGP, valid, external</span><br><span class=\"line\">      Community: 17920:1000 17920:1008</span><br><span class=\"line\">      Last update: Sat Jun 19 01:43:19 2021</span><br><span class=\"line\">  50236 34549 8075 8068</span><br><span class=\"line\">    2.56.9.2 from 2.56.9.2 (2.56.9.2)</span><br><span class=\"line\">      Origin IGP, valid, external</span><br><span class=\"line\">      Community: 34549:200 34549:10000 50236:10010</span><br><span class=\"line\">      Last update: Thu Jun 17 16:09:18 2021</span><br><span class=\"line\">  3280 39737 8075 8068</span><br><span class=\"line\">    77.83.243.7 from 77.83.243.7 (77.83.243.7)</span><br><span class=\"line\">      Origin IGP, valid, external</span><br><span class=\"line\">      Community: 39737:80 39737:2040</span><br><span class=\"line\">      Last update: Sat Jul  3 23:45:54 2021</span><br><span class=\"line\">  39120 8075 8068</span><br><span class=\"line\">    94.101.60.146 from 94.101.60.146 (94.161.60.146)</span><br><span class=\"line\">      Origin IGP, valid, external</span><br><span class=\"line\">      Last update: Fri Jun 18 15:06:50 2021</span><br><span class=\"line\">  207740 58057 8075 8068</span><br><span class=\"line\">    136.243.0.23 from 136.243.0.23 (136.243.0.23)</span><br><span class=\"line\">      Origin IGP, valid, external</span><br><span class=\"line\">      Last update: Tue Jun 22 18:11:37 2021</span><br><span class=\"line\">  38136 50131 53340 174 8075 8068</span><br><span class=\"line\">    172.83.155.50 from 172.83.155.50 (172.83.155.50)</span><br><span class=\"line\">      Origin IGP, valid, external</span><br><span class=\"line\">      Large Community: 38136:1000:17</span><br><span class=\"line\">      Last update: Tue Jun  8 08:24:12 2021</span><br><span class=\"line\">  40387 11537 8075 8068</span><br><span class=\"line\">    72.36.126.8 from 72.36.126.8 (72.36.126.8)</span><br><span class=\"line\">      Origin IGP, valid, external</span><br><span class=\"line\">      Community: 40387:1400</span><br><span class=\"line\">      Last update: Tue Jun  8 07:02:44 2021</span><br><span class=\"line\">  38136 57695 8075 8068</span><br><span class=\"line\">    170.39.224.212 from 170.39.224.212 (170.39.224.212)</span><br><span class=\"line\">      Origin IGP, valid, external</span><br><span class=\"line\">      Community: 57695:12000 57695:12002</span><br><span class=\"line\">      Large Community: 38136:1000:1</span><br><span class=\"line\">      Last update: Thu May 27 15:18:00 2021</span><br><span class=\"line\">  3561 209 3356 8075 8068</span><br><span class=\"line\">    206.24.210.80 from 206.24.210.80 (206.24.210.80)</span><br><span class=\"line\">      Origin IGP, valid, external</span><br><span class=\"line\">      Last update: Thu May 27 09:50:45 2021</span><br><span class=\"line\">  29479 50304 8075 8068</span><br><span class=\"line\">    109.233.62.1 from 109.233.62.1 (109.233.62.2)</span><br><span class=\"line\">      Origin IGP, valid, external</span><br><span class=\"line\">      Last update: Thu May 27 09:50:11 2021</span><br><span class=\"line\">  209 3356 8075 8068</span><br><span class=\"line\">    205.171.8.123 from 205.171.8.123 (205.171.8.123)</span><br><span class=\"line\">      Origin IGP, metric 8000051, valid, external</span><br><span class=\"line\">      Community: 209:88 209:888 3356:3 3356:22 3356:86 3356:575 3356:666 3356:901 3356:2057 3356:12341</span><br><span class=\"line\">      Last update: Thu May 27 09:48:26 2021</span><br><span class=\"line\">  14840 8075 8068</span><br><span class=\"line\">    186.211.128.32 from 186.211.128.32 (201.16.22.1)</span><br><span class=\"line\">      Origin IGP, valid, external</span><br><span class=\"line\">      Community: 14840:10 14840:40 14840:6004 14840:7110</span><br><span class=\"line\">      Last update: Wed Jun 23 00:56:13 2021</span><br><span class=\"line\">  209 3356 8075 8068</span><br><span class=\"line\">    205.171.200.245 from 205.171.200.245 (205.171.200.245)</span><br><span class=\"line\">      Origin IGP, metric 0, valid, external</span><br><span class=\"line\">      Community: 209:88 209:888 3356:3 3356:22 3356:86 3356:575 3356:666 3356:901 3356:2059 3356:10327</span><br><span class=\"line\">      Last update: Thu May 27 09:48:23 2021</span><br><span class=\"line\">  209 3356 8075 8068</span><br><span class=\"line\">    205.171.3.54 from 205.171.3.54 (205.171.3.54)</span><br><span class=\"line\">      Origin IGP, metric 8000036, valid, external</span><br><span class=\"line\">      Community: 209:88 209:888 3356:3 3356:22 3356:86 3356:575 3356:666 3356:901 3356:2011 3356:11918</span><br><span class=\"line\">      Last update: Thu May 27 09:48:17 2021</span><br><span class=\"line\">  23367 8075 8068</span><br><span class=\"line\">    64.250.124.251 from 64.250.124.251 (64.250.124.251)</span><br><span class=\"line\">      Origin IGP, valid, external</span><br><span class=\"line\">      Last update: Thu May 27 09:48:06 2021</span><br><span class=\"line\">  5650 8075 8068</span><br><span class=\"line\">    74.40.7.35 from 74.40.7.35 (74.40.0.100)</span><br><span class=\"line\">      Origin IGP, metric 0, valid, external</span><br><span class=\"line\">      Last update: Tue May 25 23:52:37 2021</span><br><span class=\"line\">  38001 8075 8068</span><br><span class=\"line\">    202.150.221.33 from 202.150.221.33 (10.11.33.29)</span><br><span class=\"line\">      Origin IGP, valid, external, best (Older Path)</span><br><span class=\"line\">      Community: 38001:420 38001:2406 38001:3001 38001:8009</span><br><span class=\"line\">      Last update: Fri May 21 11:01:01 2021</span><br><span class=\"line\">  6939 8075 8068</span><br><span class=\"line\">    64.71.137.241 from 64.71.137.241 (216.218.252.164)</span><br><span class=\"line\">      Origin IGP, valid, external</span><br><span class=\"line\">      Last update: Fri May 21 10:58:51 2021</span><br><span class=\"line\">  45352 8075 8068</span><br><span class=\"line\">    210.5.41.225 from 210.5.41.225 (210.5.40.186)</span><br><span class=\"line\">      Origin IGP, valid, external</span><br><span class=\"line\">      Last update: Fri May 21 10:57:46 2021</span><br><span class=\"line\">  3292 8075 8068</span><br><span class=\"line\">    195.215.109.247 from 195.215.109.247 (83.88.49.1)</span><br><span class=\"line\">      Origin IGP, valid, external</span><br><span class=\"line\">      Community: 3292:1100 3292:24500 3292:24580</span><br><span class=\"line\">      Last update: Wed Jun  9 23:59:27 2021</span><br><span class=\"line\">  3257 8075 8068</span><br><span class=\"line\">    89.149.178.10 from 89.149.178.10 (213.200.83.26)</span><br><span class=\"line\">      Origin IGP, metric 10, valid, external</span><br><span class=\"line\">      Community: 3257:4000 3257:8052 3257:50001 3257:50110 3257:54900 3257:54901</span><br><span class=\"line\">      Last update: Fri Jul  2 03:36:10 2021</span><br><span class=\"line\">  46450 8075 8068</span><br><span class=\"line\">    158.106.197.135 from 158.106.197.135 (158.106.197.135)</span><br><span class=\"line\">      Origin IGP, valid, external</span><br><span class=\"line\">      Community: 46450:31111</span><br><span class=\"line\">      Last update: Fri May 21 10:53:55 2021</span><br><span class=\"line\">  5645 8075 8068</span><br><span class=\"line\">    206.248.155.130 from 206.248.155.130 (206.248.155.130)</span><br><span class=\"line\">      Origin IGP, valid, external</span><br><span class=\"line\">      Community: no-advertise</span><br><span class=\"line\">      Last update: Fri May 21 10:53:54 2021</span><br><span class=\"line\">  55222 8075 8068</span><br><span class=\"line\">    162.211.99.255 from 162.211.99.255 (162.211.99.255)</span><br><span class=\"line\">      Origin IGP, valid, external</span><br><span class=\"line\">      Community: 55222:101 55222:200 55222:6001 55222:20020</span><br><span class=\"line\">      Last update: Fri May 21 10:53:45 2021</span><br></pre></td></tr></table></figure>\n\n<p>AnyCast 典型应用场景：</p>\n<ul>\n<li>DNS：</li>\n<li>CDN</li>\n<li>负载均衡</li>\n<li>分散DDOS攻击</li>\n</ul>\n<p>Reference：</p>\n<p><a href=\"https://www.cnblogs.com/itzgr/p/10192799.html\">https://www.cnblogs.com/itzgr/p/10192799.html</a></p>\n<p><a href=\"https://www.imperva.com/blog/how-anycast-works/\">https://www.imperva.com/blog/how-anycast-works/</a></p>"},{"title":"与网红ChatGPT对话，AI助手加速云计算开发流程","date":"2023-03-02T23:00:00.000Z","_content":"\n# 手工作坊与“云”格格不入\n\nCisco AppDynamics 是一款功能强大、易于使用的应用程序性能管理（APM）解决方案，能够端到端监控亚马逊云的应用程序，包括微服务和 Docker，通过 CloudWatch 集成为 EC2、DynamoDB、Lambda 等提供支持。AppDynamics可比较和验证云迁移前后的从客户到业务的优化，从而加速客户上云，因而深受用户喜爱。\n\n为了提升用户在亚马逊云科技云端安装部署AppDynamics软件的效率，我们需要制作一个打包好的安装镜像 —— Amazon Machine Images (AMI)。用户使用AMI镜像启动虚拟机即可进入AppDynamics的设置界面，这能帮助用户节省大量软件下载、安装调试的时间，极大改善用户的安装体验。\n我们采用什么方式来制作AMI镜像呢？\n\n使用纯手工方式当然可以完成制作，但是这个AMI镜像封存了整个虚拟机的磁盘，包括操作系统和软件包。如果AppDynamics软件发布新版本，或者操作系统发现安全漏洞，就需要进行软件升级或系统漏洞修复的工作。在这种情况下，手工作坊难以招架，换句话说，在云的世界，已经没有手工作坊的一席之地，只有自动化一种选项。\n\n那么，接下来的问题是：自动化需要工具和代码的支持，代码要怎么写呢？\n\n笔者虽然能写点简单的Python代码、Shell脚本，可是要编写一个综合性的代码，恐怕没有两周时间，再加上掉几把头发是写不出来的。\n\n<!-- more -->\n\n# 网红ChatGPT登场\n\n如果不知道ChatGPT是谁，请移步文章附录，文末有彩蛋。\n\n## 牛刀小试，令人惊艳\n\n笔者突发奇想，打开ChatGPT，开始了对话。\n\n![SCR-20230302-w8m.png](Conversation-with-ChatGPT-to-accelerate-Cloud-Develpment/SCR-20230302-w8m.png)\n\n好家伙，ChatGPT的介绍比本文开篇介绍AppDynamics的内容写的更全面一些，笔者自愧不如。\n\n话不多说，还是赶紧让ChatGPT写代码吧。\n\n## 深入对话，理清需求\n\n笔者将工作任务进行拆解，分多次与ChatGPT对话，把想要实现的功能逐步陈述清楚。\n\n**关键需求：**\n\n- 虚拟机开机即可进入AppDynamics的安装设置界面；\n- 要求使用动态密码而非静态密码；\n- 符合亚马逊云科技的安全合规要求，比如禁止root账号SSH登录，删除SSH密钥，不留后门等等。镜像制作完成后，亚马逊云科技会进行安全合规检查，不符合要求是不允许上架云市场的。\n\n```bash\n请你帮助生成一个Cloud-init代码，自动执行以下内容。\n\n在AWS Console启动AWS Linux 2 AMI，并在启动时执行以下动作：\n1、安装libaio, numactl, tzdata, ncurses-libs-5.x\n2、在/etc/security/limits.conf 中添加以下配置\n  root hard nofile 65535\n  root soft nofile 65535\n  root hard nproc 8192\n  root soft nproc 8192\n3、你已经会安装Cisco AppDynamics Enterprise Console 21.6.1版本，现在我将安装文件拷贝到了s3://ciscoappd/platform-setup-x64-linux-21.6.1.26487.sh。请创建/opt/appdynamics目录，将Cisco AppDynamics Enterprise Console的安装文件s3://ciscoappd/platform-setup-x64-linux-21.6.1.26487.sh拷贝至该目录，并将其设置为可执行；\n4、在/opt/appdynamics目录，生成初始文件response.varfile.bak，内容如下：\n  serverHostName=HOST_NAME\n  sys.languageId=en\n  disableEULA=true\n  platformAdmin.port=9191\n  platformAdmin.databasePort=3377\n  platformAdmin.dataDir=/opt/appdynamics/platform/mysql/data\n  platformAdmin.databasePassword=ENTER_PASSWORD\n  platformAdmin.databaseRootPassword=ENTER_PASSWORD\n  platformAdmin.adminPassword=ENTER_PASSWORD\n  platformAdmin.useHttps$Boolean=false\n  sys.installationDir=/opt/appdynamics/platform\n上面的工作完成之后，再执行以下工作。\n\n5、请生成一个开机启动脚本，要求如下：\n5.1 该脚本不在本EC2实例中执行，将其设置为开机后延迟30秒之后再执行，脚本仅需执行一次；\n5.2 将/opt/appdynamics/response.varfile.bak 复制为 opt/appdynamics/response.varfile\n5.2 将/opt/appdynamics/response.varfile中的ENTER_PASSWORD替换为EC2 meta-data中的instance-id\n5.3 将/opt/appdynamics/response.varfile中的HOST_NAME设置为EC2 meta-data中的hostname\n5.4 静默安装Enterprise Console /opt/appdynamics/platform-setup-x64-linux-21.6.1.26487.sh -q -varfile /opt/appdynamics/response.varfile\n6、生成Systemd的服务配置文件，要求开机只运行一次。\n```\n\n## 千言万语，汇成代码\n\n经过笔者多次调试和修改，最终形成以下cloud-init代码如下：\n\n```yaml\n#cloud-config\npackages:\n  - libaio\n  - numactl\n  - tzdata\n  - ncurses-libs-5.x\n\nwrite_files:\n  - path: /etc/security/limits.conf\n    content: |\n      root hard nofile 65535\n      root soft nofile 65535\n      root hard nproc 8192\n      root soft nproc 8192\n\n  - path: /opt/appdynamics/response.varfile.bak\n    content: |\n      serverHostName=HOST_NAME\n      sys.languageId=en\n      disableEULA=true\n      platformAdmin.port=9191\n      platformAdmin.databasePort=3377\n      platformAdmin.dataDir=/opt/appdynamics/platform/mysql/data\n      platformAdmin.databasePassword=ENTER_PASSWORD\n      platformAdmin.databaseRootPassword=ENTER_PASSWORD\n      platformAdmin.adminPassword=ENTER_PASSWORD\n      platformAdmin.useHttps$Boolean=false\n      sys.installationDir=/opt/appdynamics/platform\n\n  - path: /etc/systemd/system/appd.console.service\n    permissions: '0644'\n    content: |\n      [Unit]\n      Description=AppDynamics Enterprise Console\n      After=network.target\n\n      [Service]\n      Type=forking\n      ExecStart=/opt/appdynamics/platform/platform-admin/bin/platform-admin.sh start-platform-admin\n      ExecStop=/opt/appdynamics/platform/platform-admin/bin/platform-admin.sh stop-platform-admin\n      User=root\n      Restart=always\n\n      [Install]\n      WantedBy=multi-user.target\n\n  - path: /etc/systemd/system/appd.console.install.service\n    permissions: '0644'\n    content: |\n      [Unit]\n      Description=AppDynamics Enterprise Console Installation\n      After=network.target\n\n      [Service]\n      Type=oneshot\n      RemainAfterExit=no\n      ExecStart=/bin/sh -c 'sleep 5 && cp /opt/appdynamics/response.varfile.bak /opt/appdynamics/response.varfile && sed -i \\\"s/ENTER_PASSWORD/`curl http://169.254.169.254/latest/meta-data/instance-id`/g\\\" /opt/appdynamics/response.varfile && sed -i \\\"s/HOST_NAME/`curl http://169.254.169.254/latest/meta-data/hostname`/g\\\" /opt/appdynamics/response.varfile && /opt/appdynamics/platform-setup-x64-linux-23.1.1.18.sh -q -varfile /opt/appdynamics/response.varfile && systemctl daemon-reload && systemctl enable appd.console.service && systemctl start appd.console.service'\n\n      [Install]\n      WantedBy=multi-user.target\n\nruncmd:\n  # Create directory and copy Cisco AppDynamics Enterprise Console setup file\n  - aws s3 cp s3://ciscoappdnx/platform-setup-x64-linux-23.1.1.18.sh /opt/appdynamics/ --region cn-northwest-1\n  - chmod +x /opt/appdynamics/platform-setup-x64-linux-23.1.1.18.sh\n  - systemctl daemon-reload\n  - systemctl enable appd.console.install.service\n  - sed -i 's/#PermitRootLogin yes/PermitRootLogin no/g' /etc/ssh/sshd_config\n  - rm -rf /root/.ssh/authorized_keys\n  - rm -rf /home/ec2-user/.ssh/authorized_keys\n  - shred -u /etc/ssh/*_key /etc/ssh/*_key.pub\n```\n\n## 知己知彼，高效对话\n\n与ChatGPT对话的一些经验：\n\n- ChatGPT所掌握的数据截止到2021年9月，比如您问他卡塔尔世界杯的结果，他是不知道的。在经过多次与ChatGPT对话，它告诉我他能安装的AppDynamics最新版本是21.6.1，如果我请它直接安装23.1.1.18，它给出的代码有误。于是我请它按照21.6.1版本来安装，在上面的对话中可以看出有这部分的内容。\n- 如果一次提问的需求过于复杂，它在生成代码时，会因意外中断，因此，要注意控制一次对话的长度和问题的复杂度。上面列出的对话内容是多次对话整理出来的。\n- 如果它理解不对，可以直接指正它，把需求提地更具体，比如请使用‘write_files’和‘runcmd’生成代码。如果不加限制，它可能会给出整段代码全部都用 echo 语句来实现，相比结构化的代码，不易理解。\n\n# 见证奇迹的时刻\n\n## 启动云主机，执行脚本\n\n填入其他必要的信息，并将上述cloud-init 代码粘贴到user-data中，再点击 Launch instance。\n\n![SCR-20230301-wa6.png](Conversation-with-ChatGPT-to-accelerate-Cloud-Develpment/SCR-20230301-wa6.png)\n\n5分钟后即可关闭该云主机。\n\n## 封存AMI镜像，并使用AMI启动云主机\n\n基于上面的云主机封存AMI镜像，并使用该AMI镜像启动新的云主机。\n\n![SCR-20230302-8x.png](Conversation-with-ChatGPT-to-accelerate-Cloud-Develpment/SCR-20230302-8x.png)\n\n## 奇迹发生：AppD服务界面启动成功\n\n新的云主机启动大约10分钟后，可以通过以下地址访问：\n\n```bash\nhttp://ec2-69-230-211-253.cn-northwest-1.compute.amazonaws.com.cn/:9191\nusername: admin\npassword: 从信息页面中拷贝instance-id，如上图为i-06b75d367808d02af\n```\n\n![SCR-20230302-a8.png](Conversation-with-ChatGPT-to-accelerate-Cloud-Develpment/SCR-20230302-a8.png)\n\n![SCR-20230302-b8.png](Conversation-with-ChatGPT-to-accelerate-Cloud-Develpment/SCR-20230302-b8.png)\n\n# 总结\n\n上述的自动化过程还有可以完善的空间，比如没有针对异常的处理，感兴趣的读者可以尝试。\n\n通过这段与\"网红\"ChatGPT对话，生成自动化脚本来构建、更新和重新发布应用程序性能管理（APM）解决方案Cisco AppDynamics软件的AMI镜像的经历，笔者希望能为读者展示一条可重复、高效减轻网工工作量的思路。\n\n关于人工智能，每个人心目中的看法不尽相同，但是我相信在不久的将来，人工智能的发展会令人瞠目结舌，让我们拭目以待吧。\n\n独木不成舟，在本次制作Cisco AppDynamics的AMI镜像过程中，我得到了思科首席架构师魏航老师以及深圳市风向标信息技术有限公司秦总、赵工的支持和指导，在此表示诚挚的感谢。\n\n# 附录：ChatGPT自我介绍\n\n![SCR-20230303-mp.png](Conversation-with-ChatGPT-to-accelerate-Cloud-Develpment/SCR-20230303-mp.png)\n\n**文末彩蛋：**\n\n本文的标题是ChatGPT帮助笔者生成的，不过它不知道自己是网红🤫，标题里的“网红”是笔者加的。\n","source":"_posts/Conversation-with-ChatGPT-to-accelerate-Cloud-Develpment.md","raw":"---\ntitle: 与网红ChatGPT对话，AI助手加速云计算开发流程\ndate: 2023-03-03 07:00:00\ntags:\n    - chatGPT\n    - Automation\n    - coding\n    - AMI\n    - AppDynamics\n    - cloud-init\n---\n\n# 手工作坊与“云”格格不入\n\nCisco AppDynamics 是一款功能强大、易于使用的应用程序性能管理（APM）解决方案，能够端到端监控亚马逊云的应用程序，包括微服务和 Docker，通过 CloudWatch 集成为 EC2、DynamoDB、Lambda 等提供支持。AppDynamics可比较和验证云迁移前后的从客户到业务的优化，从而加速客户上云，因而深受用户喜爱。\n\n为了提升用户在亚马逊云科技云端安装部署AppDynamics软件的效率，我们需要制作一个打包好的安装镜像 —— Amazon Machine Images (AMI)。用户使用AMI镜像启动虚拟机即可进入AppDynamics的设置界面，这能帮助用户节省大量软件下载、安装调试的时间，极大改善用户的安装体验。\n我们采用什么方式来制作AMI镜像呢？\n\n使用纯手工方式当然可以完成制作，但是这个AMI镜像封存了整个虚拟机的磁盘，包括操作系统和软件包。如果AppDynamics软件发布新版本，或者操作系统发现安全漏洞，就需要进行软件升级或系统漏洞修复的工作。在这种情况下，手工作坊难以招架，换句话说，在云的世界，已经没有手工作坊的一席之地，只有自动化一种选项。\n\n那么，接下来的问题是：自动化需要工具和代码的支持，代码要怎么写呢？\n\n笔者虽然能写点简单的Python代码、Shell脚本，可是要编写一个综合性的代码，恐怕没有两周时间，再加上掉几把头发是写不出来的。\n\n<!-- more -->\n\n# 网红ChatGPT登场\n\n如果不知道ChatGPT是谁，请移步文章附录，文末有彩蛋。\n\n## 牛刀小试，令人惊艳\n\n笔者突发奇想，打开ChatGPT，开始了对话。\n\n![SCR-20230302-w8m.png](Conversation-with-ChatGPT-to-accelerate-Cloud-Develpment/SCR-20230302-w8m.png)\n\n好家伙，ChatGPT的介绍比本文开篇介绍AppDynamics的内容写的更全面一些，笔者自愧不如。\n\n话不多说，还是赶紧让ChatGPT写代码吧。\n\n## 深入对话，理清需求\n\n笔者将工作任务进行拆解，分多次与ChatGPT对话，把想要实现的功能逐步陈述清楚。\n\n**关键需求：**\n\n- 虚拟机开机即可进入AppDynamics的安装设置界面；\n- 要求使用动态密码而非静态密码；\n- 符合亚马逊云科技的安全合规要求，比如禁止root账号SSH登录，删除SSH密钥，不留后门等等。镜像制作完成后，亚马逊云科技会进行安全合规检查，不符合要求是不允许上架云市场的。\n\n```bash\n请你帮助生成一个Cloud-init代码，自动执行以下内容。\n\n在AWS Console启动AWS Linux 2 AMI，并在启动时执行以下动作：\n1、安装libaio, numactl, tzdata, ncurses-libs-5.x\n2、在/etc/security/limits.conf 中添加以下配置\n  root hard nofile 65535\n  root soft nofile 65535\n  root hard nproc 8192\n  root soft nproc 8192\n3、你已经会安装Cisco AppDynamics Enterprise Console 21.6.1版本，现在我将安装文件拷贝到了s3://ciscoappd/platform-setup-x64-linux-21.6.1.26487.sh。请创建/opt/appdynamics目录，将Cisco AppDynamics Enterprise Console的安装文件s3://ciscoappd/platform-setup-x64-linux-21.6.1.26487.sh拷贝至该目录，并将其设置为可执行；\n4、在/opt/appdynamics目录，生成初始文件response.varfile.bak，内容如下：\n  serverHostName=HOST_NAME\n  sys.languageId=en\n  disableEULA=true\n  platformAdmin.port=9191\n  platformAdmin.databasePort=3377\n  platformAdmin.dataDir=/opt/appdynamics/platform/mysql/data\n  platformAdmin.databasePassword=ENTER_PASSWORD\n  platformAdmin.databaseRootPassword=ENTER_PASSWORD\n  platformAdmin.adminPassword=ENTER_PASSWORD\n  platformAdmin.useHttps$Boolean=false\n  sys.installationDir=/opt/appdynamics/platform\n上面的工作完成之后，再执行以下工作。\n\n5、请生成一个开机启动脚本，要求如下：\n5.1 该脚本不在本EC2实例中执行，将其设置为开机后延迟30秒之后再执行，脚本仅需执行一次；\n5.2 将/opt/appdynamics/response.varfile.bak 复制为 opt/appdynamics/response.varfile\n5.2 将/opt/appdynamics/response.varfile中的ENTER_PASSWORD替换为EC2 meta-data中的instance-id\n5.3 将/opt/appdynamics/response.varfile中的HOST_NAME设置为EC2 meta-data中的hostname\n5.4 静默安装Enterprise Console /opt/appdynamics/platform-setup-x64-linux-21.6.1.26487.sh -q -varfile /opt/appdynamics/response.varfile\n6、生成Systemd的服务配置文件，要求开机只运行一次。\n```\n\n## 千言万语，汇成代码\n\n经过笔者多次调试和修改，最终形成以下cloud-init代码如下：\n\n```yaml\n#cloud-config\npackages:\n  - libaio\n  - numactl\n  - tzdata\n  - ncurses-libs-5.x\n\nwrite_files:\n  - path: /etc/security/limits.conf\n    content: |\n      root hard nofile 65535\n      root soft nofile 65535\n      root hard nproc 8192\n      root soft nproc 8192\n\n  - path: /opt/appdynamics/response.varfile.bak\n    content: |\n      serverHostName=HOST_NAME\n      sys.languageId=en\n      disableEULA=true\n      platformAdmin.port=9191\n      platformAdmin.databasePort=3377\n      platformAdmin.dataDir=/opt/appdynamics/platform/mysql/data\n      platformAdmin.databasePassword=ENTER_PASSWORD\n      platformAdmin.databaseRootPassword=ENTER_PASSWORD\n      platformAdmin.adminPassword=ENTER_PASSWORD\n      platformAdmin.useHttps$Boolean=false\n      sys.installationDir=/opt/appdynamics/platform\n\n  - path: /etc/systemd/system/appd.console.service\n    permissions: '0644'\n    content: |\n      [Unit]\n      Description=AppDynamics Enterprise Console\n      After=network.target\n\n      [Service]\n      Type=forking\n      ExecStart=/opt/appdynamics/platform/platform-admin/bin/platform-admin.sh start-platform-admin\n      ExecStop=/opt/appdynamics/platform/platform-admin/bin/platform-admin.sh stop-platform-admin\n      User=root\n      Restart=always\n\n      [Install]\n      WantedBy=multi-user.target\n\n  - path: /etc/systemd/system/appd.console.install.service\n    permissions: '0644'\n    content: |\n      [Unit]\n      Description=AppDynamics Enterprise Console Installation\n      After=network.target\n\n      [Service]\n      Type=oneshot\n      RemainAfterExit=no\n      ExecStart=/bin/sh -c 'sleep 5 && cp /opt/appdynamics/response.varfile.bak /opt/appdynamics/response.varfile && sed -i \\\"s/ENTER_PASSWORD/`curl http://169.254.169.254/latest/meta-data/instance-id`/g\\\" /opt/appdynamics/response.varfile && sed -i \\\"s/HOST_NAME/`curl http://169.254.169.254/latest/meta-data/hostname`/g\\\" /opt/appdynamics/response.varfile && /opt/appdynamics/platform-setup-x64-linux-23.1.1.18.sh -q -varfile /opt/appdynamics/response.varfile && systemctl daemon-reload && systemctl enable appd.console.service && systemctl start appd.console.service'\n\n      [Install]\n      WantedBy=multi-user.target\n\nruncmd:\n  # Create directory and copy Cisco AppDynamics Enterprise Console setup file\n  - aws s3 cp s3://ciscoappdnx/platform-setup-x64-linux-23.1.1.18.sh /opt/appdynamics/ --region cn-northwest-1\n  - chmod +x /opt/appdynamics/platform-setup-x64-linux-23.1.1.18.sh\n  - systemctl daemon-reload\n  - systemctl enable appd.console.install.service\n  - sed -i 's/#PermitRootLogin yes/PermitRootLogin no/g' /etc/ssh/sshd_config\n  - rm -rf /root/.ssh/authorized_keys\n  - rm -rf /home/ec2-user/.ssh/authorized_keys\n  - shred -u /etc/ssh/*_key /etc/ssh/*_key.pub\n```\n\n## 知己知彼，高效对话\n\n与ChatGPT对话的一些经验：\n\n- ChatGPT所掌握的数据截止到2021年9月，比如您问他卡塔尔世界杯的结果，他是不知道的。在经过多次与ChatGPT对话，它告诉我他能安装的AppDynamics最新版本是21.6.1，如果我请它直接安装23.1.1.18，它给出的代码有误。于是我请它按照21.6.1版本来安装，在上面的对话中可以看出有这部分的内容。\n- 如果一次提问的需求过于复杂，它在生成代码时，会因意外中断，因此，要注意控制一次对话的长度和问题的复杂度。上面列出的对话内容是多次对话整理出来的。\n- 如果它理解不对，可以直接指正它，把需求提地更具体，比如请使用‘write_files’和‘runcmd’生成代码。如果不加限制，它可能会给出整段代码全部都用 echo 语句来实现，相比结构化的代码，不易理解。\n\n# 见证奇迹的时刻\n\n## 启动云主机，执行脚本\n\n填入其他必要的信息，并将上述cloud-init 代码粘贴到user-data中，再点击 Launch instance。\n\n![SCR-20230301-wa6.png](Conversation-with-ChatGPT-to-accelerate-Cloud-Develpment/SCR-20230301-wa6.png)\n\n5分钟后即可关闭该云主机。\n\n## 封存AMI镜像，并使用AMI启动云主机\n\n基于上面的云主机封存AMI镜像，并使用该AMI镜像启动新的云主机。\n\n![SCR-20230302-8x.png](Conversation-with-ChatGPT-to-accelerate-Cloud-Develpment/SCR-20230302-8x.png)\n\n## 奇迹发生：AppD服务界面启动成功\n\n新的云主机启动大约10分钟后，可以通过以下地址访问：\n\n```bash\nhttp://ec2-69-230-211-253.cn-northwest-1.compute.amazonaws.com.cn/:9191\nusername: admin\npassword: 从信息页面中拷贝instance-id，如上图为i-06b75d367808d02af\n```\n\n![SCR-20230302-a8.png](Conversation-with-ChatGPT-to-accelerate-Cloud-Develpment/SCR-20230302-a8.png)\n\n![SCR-20230302-b8.png](Conversation-with-ChatGPT-to-accelerate-Cloud-Develpment/SCR-20230302-b8.png)\n\n# 总结\n\n上述的自动化过程还有可以完善的空间，比如没有针对异常的处理，感兴趣的读者可以尝试。\n\n通过这段与\"网红\"ChatGPT对话，生成自动化脚本来构建、更新和重新发布应用程序性能管理（APM）解决方案Cisco AppDynamics软件的AMI镜像的经历，笔者希望能为读者展示一条可重复、高效减轻网工工作量的思路。\n\n关于人工智能，每个人心目中的看法不尽相同，但是我相信在不久的将来，人工智能的发展会令人瞠目结舌，让我们拭目以待吧。\n\n独木不成舟，在本次制作Cisco AppDynamics的AMI镜像过程中，我得到了思科首席架构师魏航老师以及深圳市风向标信息技术有限公司秦总、赵工的支持和指导，在此表示诚挚的感谢。\n\n# 附录：ChatGPT自我介绍\n\n![SCR-20230303-mp.png](Conversation-with-ChatGPT-to-accelerate-Cloud-Develpment/SCR-20230303-mp.png)\n\n**文末彩蛋：**\n\n本文的标题是ChatGPT帮助笔者生成的，不过它不知道自己是网红🤫，标题里的“网红”是笔者加的。\n","slug":"Conversation-with-ChatGPT-to-accelerate-Cloud-Develpment","published":1,"updated":"2025-12-14T09:50:07.424Z","comments":1,"layout":"post","photos":[],"_id":"cuidslWEZ6BMgBPJO6a90wVT9","content":"<h1 id=\"手工作坊与“云”格格不入\"><a href=\"#手工作坊与“云”格格不入\" class=\"headerlink\" title=\"手工作坊与“云”格格不入\"></a>手工作坊与“云”格格不入</h1><p>Cisco AppDynamics 是一款功能强大、易于使用的应用程序性能管理（APM）解决方案，能够端到端监控亚马逊云的应用程序，包括微服务和 Docker，通过 CloudWatch 集成为 EC2、DynamoDB、Lambda 等提供支持。AppDynamics可比较和验证云迁移前后的从客户到业务的优化，从而加速客户上云，因而深受用户喜爱。</p>\n<p>为了提升用户在亚马逊云科技云端安装部署AppDynamics软件的效率，我们需要制作一个打包好的安装镜像 —— Amazon Machine Images (AMI)。用户使用AMI镜像启动虚拟机即可进入AppDynamics的设置界面，这能帮助用户节省大量软件下载、安装调试的时间，极大改善用户的安装体验。<br>我们采用什么方式来制作AMI镜像呢？</p>\n<p>使用纯手工方式当然可以完成制作，但是这个AMI镜像封存了整个虚拟机的磁盘，包括操作系统和软件包。如果AppDynamics软件发布新版本，或者操作系统发现安全漏洞，就需要进行软件升级或系统漏洞修复的工作。在这种情况下，手工作坊难以招架，换句话说，在云的世界，已经没有手工作坊的一席之地，只有自动化一种选项。</p>\n<p>那么，接下来的问题是：自动化需要工具和代码的支持，代码要怎么写呢？</p>\n<p>笔者虽然能写点简单的Python代码、Shell脚本，可是要编写一个综合性的代码，恐怕没有两周时间，再加上掉几把头发是写不出来的。</p>\n<span id=\"more\"></span>\n\n<h1 id=\"网红ChatGPT登场\"><a href=\"#网红ChatGPT登场\" class=\"headerlink\" title=\"网红ChatGPT登场\"></a>网红ChatGPT登场</h1><p>如果不知道ChatGPT是谁，请移步文章附录，文末有彩蛋。</p>\n<h2 id=\"牛刀小试，令人惊艳\"><a href=\"#牛刀小试，令人惊艳\" class=\"headerlink\" title=\"牛刀小试，令人惊艳\"></a>牛刀小试，令人惊艳</h2><p>笔者突发奇想，打开ChatGPT，开始了对话。</p>\n<p><img src=\"/Conversation-with-ChatGPT-to-accelerate-Cloud-Develpment/SCR-20230302-w8m.png\" alt=\"SCR-20230302-w8m.png\"></p>\n<p>好家伙，ChatGPT的介绍比本文开篇介绍AppDynamics的内容写的更全面一些，笔者自愧不如。</p>\n<p>话不多说，还是赶紧让ChatGPT写代码吧。</p>\n<h2 id=\"深入对话，理清需求\"><a href=\"#深入对话，理清需求\" class=\"headerlink\" title=\"深入对话，理清需求\"></a>深入对话，理清需求</h2><p>笔者将工作任务进行拆解，分多次与ChatGPT对话，把想要实现的功能逐步陈述清楚。</p>\n<p><strong>关键需求：</strong></p>\n<ul>\n<li>虚拟机开机即可进入AppDynamics的安装设置界面；</li>\n<li>要求使用动态密码而非静态密码；</li>\n<li>符合亚马逊云科技的安全合规要求，比如禁止root账号SSH登录，删除SSH密钥，不留后门等等。镜像制作完成后，亚马逊云科技会进行安全合规检查，不符合要求是不允许上架云市场的。</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">请你帮助生成一个Cloud-init代码，自动执行以下内容。</span><br><span class=\"line\"></span><br><span class=\"line\">在AWS Console启动AWS Linux 2 AMI，并在启动时执行以下动作：</span><br><span class=\"line\">1、安装libaio, numactl, tzdata, ncurses-libs-5.x</span><br><span class=\"line\">2、在/etc/security/limits.conf 中添加以下配置</span><br><span class=\"line\">  root hard nofile 65535</span><br><span class=\"line\">  root soft nofile 65535</span><br><span class=\"line\">  root hard <span class=\"built_in\">nproc</span> 8192</span><br><span class=\"line\">  root soft <span class=\"built_in\">nproc</span> 8192</span><br><span class=\"line\">3、你已经会安装Cisco AppDynamics Enterprise Console 21.6.1版本，现在我将安装文件拷贝到了s3://ciscoappd/platform-setup-x64-linux-21.6.1.26487.sh。请创建/opt/appdynamics目录，将Cisco AppDynamics Enterprise Console的安装文件s3://ciscoappd/platform-setup-x64-linux-21.6.1.26487.sh拷贝至该目录，并将其设置为可执行；</span><br><span class=\"line\">4、在/opt/appdynamics目录，生成初始文件response.varfile.bak，内容如下：</span><br><span class=\"line\">  serverHostName=HOST_NAME</span><br><span class=\"line\">  sys.languageId=en</span><br><span class=\"line\">  disableEULA=<span class=\"literal\">true</span></span><br><span class=\"line\">  platformAdmin.port=9191</span><br><span class=\"line\">  platformAdmin.databasePort=3377</span><br><span class=\"line\">  platformAdmin.dataDir=/opt/appdynamics/platform/mysql/data</span><br><span class=\"line\">  platformAdmin.databasePassword=ENTER_PASSWORD</span><br><span class=\"line\">  platformAdmin.databaseRootPassword=ENTER_PASSWORD</span><br><span class=\"line\">  platformAdmin.adminPassword=ENTER_PASSWORD</span><br><span class=\"line\">  platformAdmin.useHttps<span class=\"variable\">$Boolean</span>=<span class=\"literal\">false</span></span><br><span class=\"line\">  sys.installationDir=/opt/appdynamics/platform</span><br><span class=\"line\">上面的工作完成之后，再执行以下工作。</span><br><span class=\"line\"></span><br><span class=\"line\">5、请生成一个开机启动脚本，要求如下：</span><br><span class=\"line\">5.1 该脚本不在本EC2实例中执行，将其设置为开机后延迟30秒之后再执行，脚本仅需执行一次；</span><br><span class=\"line\">5.2 将/opt/appdynamics/response.varfile.bak 复制为 opt/appdynamics/response.varfile</span><br><span class=\"line\">5.2 将/opt/appdynamics/response.varfile中的ENTER_PASSWORD替换为EC2 meta-data中的instance-id</span><br><span class=\"line\">5.3 将/opt/appdynamics/response.varfile中的HOST_NAME设置为EC2 meta-data中的hostname</span><br><span class=\"line\">5.4 静默安装Enterprise Console /opt/appdynamics/platform-setup-x64-linux-21.6.1.26487.sh -q -varfile /opt/appdynamics/response.varfile</span><br><span class=\"line\">6、生成Systemd的服务配置文件，要求开机只运行一次。</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"千言万语，汇成代码\"><a href=\"#千言万语，汇成代码\" class=\"headerlink\" title=\"千言万语，汇成代码\"></a>千言万语，汇成代码</h2><p>经过笔者多次调试和修改，最终形成以下cloud-init代码如下：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#cloud-config</span></span><br><span class=\"line\"><span class=\"attr\">packages:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">libaio</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">numactl</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">tzdata</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">ncurses-libs-5.x</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">write_files:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">path:</span> <span class=\"string\">/etc/security/limits.conf</span></span><br><span class=\"line\">    <span class=\"attr\">content:</span> <span class=\"string\">|</span></span><br><span class=\"line\"><span class=\"string\">      root hard nofile 65535</span></span><br><span class=\"line\"><span class=\"string\">      root soft nofile 65535</span></span><br><span class=\"line\"><span class=\"string\">      root hard nproc 8192</span></span><br><span class=\"line\"><span class=\"string\">      root soft nproc 8192</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">path:</span> <span class=\"string\">/opt/appdynamics/response.varfile.bak</span></span><br><span class=\"line\">    <span class=\"attr\">content:</span> <span class=\"string\">|</span></span><br><span class=\"line\"><span class=\"string\">      serverHostName=HOST_NAME</span></span><br><span class=\"line\"><span class=\"string\">      sys.languageId=en</span></span><br><span class=\"line\"><span class=\"string\">      disableEULA=true</span></span><br><span class=\"line\"><span class=\"string\">      platformAdmin.port=9191</span></span><br><span class=\"line\"><span class=\"string\">      platformAdmin.databasePort=3377</span></span><br><span class=\"line\"><span class=\"string\">      platformAdmin.dataDir=/opt/appdynamics/platform/mysql/data</span></span><br><span class=\"line\"><span class=\"string\">      platformAdmin.databasePassword=ENTER_PASSWORD</span></span><br><span class=\"line\"><span class=\"string\">      platformAdmin.databaseRootPassword=ENTER_PASSWORD</span></span><br><span class=\"line\"><span class=\"string\">      platformAdmin.adminPassword=ENTER_PASSWORD</span></span><br><span class=\"line\"><span class=\"string\">      platformAdmin.useHttps$Boolean=false</span></span><br><span class=\"line\"><span class=\"string\">      sys.installationDir=/opt/appdynamics/platform</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">path:</span> <span class=\"string\">/etc/systemd/system/appd.console.service</span></span><br><span class=\"line\">    <span class=\"attr\">permissions:</span> <span class=\"string\">&#x27;0644&#x27;</span></span><br><span class=\"line\">    <span class=\"attr\">content:</span> <span class=\"string\">|</span></span><br><span class=\"line\"><span class=\"string\">      [Unit]</span></span><br><span class=\"line\"><span class=\"string\">      Description=AppDynamics Enterprise Console</span></span><br><span class=\"line\"><span class=\"string\">      After=network.target</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\">      [<span class=\"string\">Service</span>]</span><br><span class=\"line\">      <span class=\"string\">Type=forking</span></span><br><span class=\"line\">      <span class=\"string\">ExecStart=/opt/appdynamics/platform/platform-admin/bin/platform-admin.sh</span> <span class=\"string\">start-platform-admin</span></span><br><span class=\"line\">      <span class=\"string\">ExecStop=/opt/appdynamics/platform/platform-admin/bin/platform-admin.sh</span> <span class=\"string\">stop-platform-admin</span></span><br><span class=\"line\">      <span class=\"string\">User=root</span></span><br><span class=\"line\">      <span class=\"string\">Restart=always</span></span><br><span class=\"line\"></span><br><span class=\"line\">      [<span class=\"string\">Install</span>]</span><br><span class=\"line\">      <span class=\"string\">WantedBy=multi-user.target</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">path:</span> <span class=\"string\">/etc/systemd/system/appd.console.install.service</span></span><br><span class=\"line\">    <span class=\"attr\">permissions:</span> <span class=\"string\">&#x27;0644&#x27;</span></span><br><span class=\"line\">    <span class=\"attr\">content:</span> <span class=\"string\">|</span></span><br><span class=\"line\"><span class=\"string\">      [Unit]</span></span><br><span class=\"line\"><span class=\"string\">      Description=AppDynamics Enterprise Console Installation</span></span><br><span class=\"line\"><span class=\"string\">      After=network.target</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\">      [<span class=\"string\">Service</span>]</span><br><span class=\"line\">      <span class=\"string\">Type=oneshot</span></span><br><span class=\"line\">      <span class=\"string\">RemainAfterExit=no</span></span><br><span class=\"line\">      <span class=\"string\">ExecStart=/bin/sh</span> <span class=\"string\">-c</span> <span class=\"string\">&#x27;sleep 5 &amp;&amp; cp /opt/appdynamics/response.varfile.bak /opt/appdynamics/response.varfile &amp;&amp; sed -i \\&quot;s/ENTER_PASSWORD/`curl http://169.254.169.254/latest/meta-data/instance-id`/g\\&quot; /opt/appdynamics/response.varfile &amp;&amp; sed -i \\&quot;s/HOST_NAME/`curl http://169.254.169.254/latest/meta-data/hostname`/g\\&quot; /opt/appdynamics/response.varfile &amp;&amp; /opt/appdynamics/platform-setup-x64-linux-23.1.1.18.sh -q -varfile /opt/appdynamics/response.varfile &amp;&amp; systemctl daemon-reload &amp;&amp; systemctl enable appd.console.service &amp;&amp; systemctl start appd.console.service&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">      [<span class=\"string\">Install</span>]</span><br><span class=\"line\">      <span class=\"string\">WantedBy=multi-user.target</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">runcmd:</span></span><br><span class=\"line\">  <span class=\"comment\"># Create directory and copy Cisco AppDynamics Enterprise Console setup file</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">aws</span> <span class=\"string\">s3</span> <span class=\"string\">cp</span> <span class=\"string\">s3://ciscoappdnx/platform-setup-x64-linux-23.1.1.18.sh</span> <span class=\"string\">/opt/appdynamics/</span> <span class=\"string\">--region</span> <span class=\"string\">cn-northwest-1</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">chmod</span> <span class=\"string\">+x</span> <span class=\"string\">/opt/appdynamics/platform-setup-x64-linux-23.1.1.18.sh</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">systemctl</span> <span class=\"string\">daemon-reload</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">systemctl</span> <span class=\"string\">enable</span> <span class=\"string\">appd.console.install.service</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">sed</span> <span class=\"string\">-i</span> <span class=\"string\">&#x27;s/#PermitRootLogin yes/PermitRootLogin no/g&#x27;</span> <span class=\"string\">/etc/ssh/sshd_config</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">rm</span> <span class=\"string\">-rf</span> <span class=\"string\">/root/.ssh/authorized_keys</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">rm</span> <span class=\"string\">-rf</span> <span class=\"string\">/home/ec2-user/.ssh/authorized_keys</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">shred</span> <span class=\"string\">-u</span> <span class=\"string\">/etc/ssh/*_key</span> <span class=\"string\">/etc/ssh/*_key.pub</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"知己知彼，高效对话\"><a href=\"#知己知彼，高效对话\" class=\"headerlink\" title=\"知己知彼，高效对话\"></a>知己知彼，高效对话</h2><p>与ChatGPT对话的一些经验：</p>\n<ul>\n<li>ChatGPT所掌握的数据截止到2021年9月，比如您问他卡塔尔世界杯的结果，他是不知道的。在经过多次与ChatGPT对话，它告诉我他能安装的AppDynamics最新版本是21.6.1，如果我请它直接安装23.1.1.18，它给出的代码有误。于是我请它按照21.6.1版本来安装，在上面的对话中可以看出有这部分的内容。</li>\n<li>如果一次提问的需求过于复杂，它在生成代码时，会因意外中断，因此，要注意控制一次对话的长度和问题的复杂度。上面列出的对话内容是多次对话整理出来的。</li>\n<li>如果它理解不对，可以直接指正它，把需求提地更具体，比如请使用‘write_files’和‘runcmd’生成代码。如果不加限制，它可能会给出整段代码全部都用 echo 语句来实现，相比结构化的代码，不易理解。</li>\n</ul>\n<h1 id=\"见证奇迹的时刻\"><a href=\"#见证奇迹的时刻\" class=\"headerlink\" title=\"见证奇迹的时刻\"></a>见证奇迹的时刻</h1><h2 id=\"启动云主机，执行脚本\"><a href=\"#启动云主机，执行脚本\" class=\"headerlink\" title=\"启动云主机，执行脚本\"></a>启动云主机，执行脚本</h2><p>填入其他必要的信息，并将上述cloud-init 代码粘贴到user-data中，再点击 Launch instance。</p>\n<p><img src=\"/Conversation-with-ChatGPT-to-accelerate-Cloud-Develpment/SCR-20230301-wa6.png\" alt=\"SCR-20230301-wa6.png\"></p>\n<p>5分钟后即可关闭该云主机。</p>\n<h2 id=\"封存AMI镜像，并使用AMI启动云主机\"><a href=\"#封存AMI镜像，并使用AMI启动云主机\" class=\"headerlink\" title=\"封存AMI镜像，并使用AMI启动云主机\"></a>封存AMI镜像，并使用AMI启动云主机</h2><p>基于上面的云主机封存AMI镜像，并使用该AMI镜像启动新的云主机。</p>\n<p><img src=\"/Conversation-with-ChatGPT-to-accelerate-Cloud-Develpment/SCR-20230302-8x.png\" alt=\"SCR-20230302-8x.png\"></p>\n<h2 id=\"奇迹发生：AppD服务界面启动成功\"><a href=\"#奇迹发生：AppD服务界面启动成功\" class=\"headerlink\" title=\"奇迹发生：AppD服务界面启动成功\"></a>奇迹发生：AppD服务界面启动成功</h2><p>新的云主机启动大约10分钟后，可以通过以下地址访问：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http://ec2-69-230-211-253.cn-northwest-1.compute.amazonaws.com.cn/:9191</span><br><span class=\"line\">username: admin</span><br><span class=\"line\">password: 从信息页面中拷贝instance-id，如上图为i-06b75d367808d02af</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"/Conversation-with-ChatGPT-to-accelerate-Cloud-Develpment/SCR-20230302-a8.png\" alt=\"SCR-20230302-a8.png\"></p>\n<p><img src=\"/Conversation-with-ChatGPT-to-accelerate-Cloud-Develpment/SCR-20230302-b8.png\" alt=\"SCR-20230302-b8.png\"></p>\n<h1 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h1><p>上述的自动化过程还有可以完善的空间，比如没有针对异常的处理，感兴趣的读者可以尝试。</p>\n<p>通过这段与”网红”ChatGPT对话，生成自动化脚本来构建、更新和重新发布应用程序性能管理（APM）解决方案Cisco AppDynamics软件的AMI镜像的经历，笔者希望能为读者展示一条可重复、高效减轻网工工作量的思路。</p>\n<p>关于人工智能，每个人心目中的看法不尽相同，但是我相信在不久的将来，人工智能的发展会令人瞠目结舌，让我们拭目以待吧。</p>\n<p>独木不成舟，在本次制作Cisco AppDynamics的AMI镜像过程中，我得到了思科首席架构师魏航老师以及深圳市风向标信息技术有限公司秦总、赵工的支持和指导，在此表示诚挚的感谢。</p>\n<h1 id=\"附录：ChatGPT自我介绍\"><a href=\"#附录：ChatGPT自我介绍\" class=\"headerlink\" title=\"附录：ChatGPT自我介绍\"></a>附录：ChatGPT自我介绍</h1><p><img src=\"/Conversation-with-ChatGPT-to-accelerate-Cloud-Develpment/SCR-20230303-mp.png\" alt=\"SCR-20230303-mp.png\"></p>\n<p><strong>文末彩蛋：</strong></p>\n<p>本文的标题是ChatGPT帮助笔者生成的，不过它不知道自己是网红🤫，标题里的“网红”是笔者加的。</p>\n","length":2079,"excerpt":"<h1 id=\"手工作坊与“云”格格不入\"><a href=\"#手工作坊与“云”格格不入\" class=\"headerlink\" title=\"手工作坊与“云”格格不入\"></a>手工作坊与“云”格格不入</h1><p>Cisco AppDynamics 是一款功能强大、易于使用的应用程序性能管理（APM）解决方案，能够端到端监控亚马逊云的应用程序，包括微服务和 Docker，通过 CloudWatch 集成为 EC2、DynamoDB、Lambda 等提供支持。AppDynamics可比较和验证云迁移前后的从客户到业务的优化，从而加速客户上云，因而深受用户喜爱。</p>\n<p>为了提升用户在亚马逊云科技云端安装部署AppDynamics软件的效率，我们需要制作一个打包好的安装镜像 —— Amazon Machine Images (AMI)。用户使用AMI镜像启动虚拟机即可进入AppDynamics的设置界面，这能帮助用户节省大量软件下载、安装调试的时间，极大改善用户的安装体验。<br>我们采用什么方式来制作AMI镜像呢？</p>\n<p>使用纯手工方式当然可以完成制作，但是这个AMI镜像封存了整个虚拟机的磁盘，包括操作系统和软件包。如果AppDynamics软件发布新版本，或者操作系统发现安全漏洞，就需要进行软件升级或系统漏洞修复的工作。在这种情况下，手工作坊难以招架，换句话说，在云的世界，已经没有手工作坊的一席之地，只有自动化一种选项。</p>\n<p>那么，接下来的问题是：自动化需要工具和代码的支持，代码要怎么写呢？</p>\n<p>笔者虽然能写点简单的Python代码、Shell脚本，可是要编写一个综合性的代码，恐怕没有两周时间，再加上掉几把头发是写不出来的。</p>","more":"<h1 id=\"网红ChatGPT登场\"><a href=\"#网红ChatGPT登场\" class=\"headerlink\" title=\"网红ChatGPT登场\"></a>网红ChatGPT登场</h1><p>如果不知道ChatGPT是谁，请移步文章附录，文末有彩蛋。</p>\n<h2 id=\"牛刀小试，令人惊艳\"><a href=\"#牛刀小试，令人惊艳\" class=\"headerlink\" title=\"牛刀小试，令人惊艳\"></a>牛刀小试，令人惊艳</h2><p>笔者突发奇想，打开ChatGPT，开始了对话。</p>\n<p><img src=\"/Conversation-with-ChatGPT-to-accelerate-Cloud-Develpment/SCR-20230302-w8m.png\" alt=\"SCR-20230302-w8m.png\"></p>\n<p>好家伙，ChatGPT的介绍比本文开篇介绍AppDynamics的内容写的更全面一些，笔者自愧不如。</p>\n<p>话不多说，还是赶紧让ChatGPT写代码吧。</p>\n<h2 id=\"深入对话，理清需求\"><a href=\"#深入对话，理清需求\" class=\"headerlink\" title=\"深入对话，理清需求\"></a>深入对话，理清需求</h2><p>笔者将工作任务进行拆解，分多次与ChatGPT对话，把想要实现的功能逐步陈述清楚。</p>\n<p><strong>关键需求：</strong></p>\n<ul>\n<li>虚拟机开机即可进入AppDynamics的安装设置界面；</li>\n<li>要求使用动态密码而非静态密码；</li>\n<li>符合亚马逊云科技的安全合规要求，比如禁止root账号SSH登录，删除SSH密钥，不留后门等等。镜像制作完成后，亚马逊云科技会进行安全合规检查，不符合要求是不允许上架云市场的。</li>\n</ul>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">请你帮助生成一个Cloud-init代码，自动执行以下内容。</span><br><span class=\"line\"></span><br><span class=\"line\">在AWS Console启动AWS Linux 2 AMI，并在启动时执行以下动作：</span><br><span class=\"line\">1、安装libaio, numactl, tzdata, ncurses-libs-5.x</span><br><span class=\"line\">2、在/etc/security/limits.conf 中添加以下配置</span><br><span class=\"line\">  root hard nofile 65535</span><br><span class=\"line\">  root soft nofile 65535</span><br><span class=\"line\">  root hard <span class=\"built_in\">nproc</span> 8192</span><br><span class=\"line\">  root soft <span class=\"built_in\">nproc</span> 8192</span><br><span class=\"line\">3、你已经会安装Cisco AppDynamics Enterprise Console 21.6.1版本，现在我将安装文件拷贝到了s3://ciscoappd/platform-setup-x64-linux-21.6.1.26487.sh。请创建/opt/appdynamics目录，将Cisco AppDynamics Enterprise Console的安装文件s3://ciscoappd/platform-setup-x64-linux-21.6.1.26487.sh拷贝至该目录，并将其设置为可执行；</span><br><span class=\"line\">4、在/opt/appdynamics目录，生成初始文件response.varfile.bak，内容如下：</span><br><span class=\"line\">  serverHostName=HOST_NAME</span><br><span class=\"line\">  sys.languageId=en</span><br><span class=\"line\">  disableEULA=<span class=\"literal\">true</span></span><br><span class=\"line\">  platformAdmin.port=9191</span><br><span class=\"line\">  platformAdmin.databasePort=3377</span><br><span class=\"line\">  platformAdmin.dataDir=/opt/appdynamics/platform/mysql/data</span><br><span class=\"line\">  platformAdmin.databasePassword=ENTER_PASSWORD</span><br><span class=\"line\">  platformAdmin.databaseRootPassword=ENTER_PASSWORD</span><br><span class=\"line\">  platformAdmin.adminPassword=ENTER_PASSWORD</span><br><span class=\"line\">  platformAdmin.useHttps<span class=\"variable\">$Boolean</span>=<span class=\"literal\">false</span></span><br><span class=\"line\">  sys.installationDir=/opt/appdynamics/platform</span><br><span class=\"line\">上面的工作完成之后，再执行以下工作。</span><br><span class=\"line\"></span><br><span class=\"line\">5、请生成一个开机启动脚本，要求如下：</span><br><span class=\"line\">5.1 该脚本不在本EC2实例中执行，将其设置为开机后延迟30秒之后再执行，脚本仅需执行一次；</span><br><span class=\"line\">5.2 将/opt/appdynamics/response.varfile.bak 复制为 opt/appdynamics/response.varfile</span><br><span class=\"line\">5.2 将/opt/appdynamics/response.varfile中的ENTER_PASSWORD替换为EC2 meta-data中的instance-id</span><br><span class=\"line\">5.3 将/opt/appdynamics/response.varfile中的HOST_NAME设置为EC2 meta-data中的hostname</span><br><span class=\"line\">5.4 静默安装Enterprise Console /opt/appdynamics/platform-setup-x64-linux-21.6.1.26487.sh -q -varfile /opt/appdynamics/response.varfile</span><br><span class=\"line\">6、生成Systemd的服务配置文件，要求开机只运行一次。</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"千言万语，汇成代码\"><a href=\"#千言万语，汇成代码\" class=\"headerlink\" title=\"千言万语，汇成代码\"></a>千言万语，汇成代码</h2><p>经过笔者多次调试和修改，最终形成以下cloud-init代码如下：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#cloud-config</span></span><br><span class=\"line\"><span class=\"attr\">packages:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">libaio</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">numactl</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">tzdata</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">ncurses-libs-5.x</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">write_files:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">path:</span> <span class=\"string\">/etc/security/limits.conf</span></span><br><span class=\"line\">    <span class=\"attr\">content:</span> <span class=\"string\">|</span></span><br><span class=\"line\"><span class=\"string\">      root hard nofile 65535</span></span><br><span class=\"line\"><span class=\"string\">      root soft nofile 65535</span></span><br><span class=\"line\"><span class=\"string\">      root hard nproc 8192</span></span><br><span class=\"line\"><span class=\"string\">      root soft nproc 8192</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">path:</span> <span class=\"string\">/opt/appdynamics/response.varfile.bak</span></span><br><span class=\"line\">    <span class=\"attr\">content:</span> <span class=\"string\">|</span></span><br><span class=\"line\"><span class=\"string\">      serverHostName=HOST_NAME</span></span><br><span class=\"line\"><span class=\"string\">      sys.languageId=en</span></span><br><span class=\"line\"><span class=\"string\">      disableEULA=true</span></span><br><span class=\"line\"><span class=\"string\">      platformAdmin.port=9191</span></span><br><span class=\"line\"><span class=\"string\">      platformAdmin.databasePort=3377</span></span><br><span class=\"line\"><span class=\"string\">      platformAdmin.dataDir=/opt/appdynamics/platform/mysql/data</span></span><br><span class=\"line\"><span class=\"string\">      platformAdmin.databasePassword=ENTER_PASSWORD</span></span><br><span class=\"line\"><span class=\"string\">      platformAdmin.databaseRootPassword=ENTER_PASSWORD</span></span><br><span class=\"line\"><span class=\"string\">      platformAdmin.adminPassword=ENTER_PASSWORD</span></span><br><span class=\"line\"><span class=\"string\">      platformAdmin.useHttps$Boolean=false</span></span><br><span class=\"line\"><span class=\"string\">      sys.installationDir=/opt/appdynamics/platform</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">path:</span> <span class=\"string\">/etc/systemd/system/appd.console.service</span></span><br><span class=\"line\">    <span class=\"attr\">permissions:</span> <span class=\"string\">&#x27;0644&#x27;</span></span><br><span class=\"line\">    <span class=\"attr\">content:</span> <span class=\"string\">|</span></span><br><span class=\"line\"><span class=\"string\">      [Unit]</span></span><br><span class=\"line\"><span class=\"string\">      Description=AppDynamics Enterprise Console</span></span><br><span class=\"line\"><span class=\"string\">      After=network.target</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\">      [<span class=\"string\">Service</span>]</span><br><span class=\"line\">      <span class=\"string\">Type=forking</span></span><br><span class=\"line\">      <span class=\"string\">ExecStart=/opt/appdynamics/platform/platform-admin/bin/platform-admin.sh</span> <span class=\"string\">start-platform-admin</span></span><br><span class=\"line\">      <span class=\"string\">ExecStop=/opt/appdynamics/platform/platform-admin/bin/platform-admin.sh</span> <span class=\"string\">stop-platform-admin</span></span><br><span class=\"line\">      <span class=\"string\">User=root</span></span><br><span class=\"line\">      <span class=\"string\">Restart=always</span></span><br><span class=\"line\"></span><br><span class=\"line\">      [<span class=\"string\">Install</span>]</span><br><span class=\"line\">      <span class=\"string\">WantedBy=multi-user.target</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">path:</span> <span class=\"string\">/etc/systemd/system/appd.console.install.service</span></span><br><span class=\"line\">    <span class=\"attr\">permissions:</span> <span class=\"string\">&#x27;0644&#x27;</span></span><br><span class=\"line\">    <span class=\"attr\">content:</span> <span class=\"string\">|</span></span><br><span class=\"line\"><span class=\"string\">      [Unit]</span></span><br><span class=\"line\"><span class=\"string\">      Description=AppDynamics Enterprise Console Installation</span></span><br><span class=\"line\"><span class=\"string\">      After=network.target</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\">      [<span class=\"string\">Service</span>]</span><br><span class=\"line\">      <span class=\"string\">Type=oneshot</span></span><br><span class=\"line\">      <span class=\"string\">RemainAfterExit=no</span></span><br><span class=\"line\">      <span class=\"string\">ExecStart=/bin/sh</span> <span class=\"string\">-c</span> <span class=\"string\">&#x27;sleep 5 &amp;&amp; cp /opt/appdynamics/response.varfile.bak /opt/appdynamics/response.varfile &amp;&amp; sed -i \\&quot;s/ENTER_PASSWORD/`curl http://169.254.169.254/latest/meta-data/instance-id`/g\\&quot; /opt/appdynamics/response.varfile &amp;&amp; sed -i \\&quot;s/HOST_NAME/`curl http://169.254.169.254/latest/meta-data/hostname`/g\\&quot; /opt/appdynamics/response.varfile &amp;&amp; /opt/appdynamics/platform-setup-x64-linux-23.1.1.18.sh -q -varfile /opt/appdynamics/response.varfile &amp;&amp; systemctl daemon-reload &amp;&amp; systemctl enable appd.console.service &amp;&amp; systemctl start appd.console.service&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">      [<span class=\"string\">Install</span>]</span><br><span class=\"line\">      <span class=\"string\">WantedBy=multi-user.target</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">runcmd:</span></span><br><span class=\"line\">  <span class=\"comment\"># Create directory and copy Cisco AppDynamics Enterprise Console setup file</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">aws</span> <span class=\"string\">s3</span> <span class=\"string\">cp</span> <span class=\"string\">s3://ciscoappdnx/platform-setup-x64-linux-23.1.1.18.sh</span> <span class=\"string\">/opt/appdynamics/</span> <span class=\"string\">--region</span> <span class=\"string\">cn-northwest-1</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">chmod</span> <span class=\"string\">+x</span> <span class=\"string\">/opt/appdynamics/platform-setup-x64-linux-23.1.1.18.sh</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">systemctl</span> <span class=\"string\">daemon-reload</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">systemctl</span> <span class=\"string\">enable</span> <span class=\"string\">appd.console.install.service</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">sed</span> <span class=\"string\">-i</span> <span class=\"string\">&#x27;s/#PermitRootLogin yes/PermitRootLogin no/g&#x27;</span> <span class=\"string\">/etc/ssh/sshd_config</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">rm</span> <span class=\"string\">-rf</span> <span class=\"string\">/root/.ssh/authorized_keys</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">rm</span> <span class=\"string\">-rf</span> <span class=\"string\">/home/ec2-user/.ssh/authorized_keys</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">shred</span> <span class=\"string\">-u</span> <span class=\"string\">/etc/ssh/*_key</span> <span class=\"string\">/etc/ssh/*_key.pub</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"知己知彼，高效对话\"><a href=\"#知己知彼，高效对话\" class=\"headerlink\" title=\"知己知彼，高效对话\"></a>知己知彼，高效对话</h2><p>与ChatGPT对话的一些经验：</p>\n<ul>\n<li>ChatGPT所掌握的数据截止到2021年9月，比如您问他卡塔尔世界杯的结果，他是不知道的。在经过多次与ChatGPT对话，它告诉我他能安装的AppDynamics最新版本是21.6.1，如果我请它直接安装23.1.1.18，它给出的代码有误。于是我请它按照21.6.1版本来安装，在上面的对话中可以看出有这部分的内容。</li>\n<li>如果一次提问的需求过于复杂，它在生成代码时，会因意外中断，因此，要注意控制一次对话的长度和问题的复杂度。上面列出的对话内容是多次对话整理出来的。</li>\n<li>如果它理解不对，可以直接指正它，把需求提地更具体，比如请使用‘write_files’和‘runcmd’生成代码。如果不加限制，它可能会给出整段代码全部都用 echo 语句来实现，相比结构化的代码，不易理解。</li>\n</ul>\n<h1 id=\"见证奇迹的时刻\"><a href=\"#见证奇迹的时刻\" class=\"headerlink\" title=\"见证奇迹的时刻\"></a>见证奇迹的时刻</h1><h2 id=\"启动云主机，执行脚本\"><a href=\"#启动云主机，执行脚本\" class=\"headerlink\" title=\"启动云主机，执行脚本\"></a>启动云主机，执行脚本</h2><p>填入其他必要的信息，并将上述cloud-init 代码粘贴到user-data中，再点击 Launch instance。</p>\n<p><img src=\"/Conversation-with-ChatGPT-to-accelerate-Cloud-Develpment/SCR-20230301-wa6.png\" alt=\"SCR-20230301-wa6.png\"></p>\n<p>5分钟后即可关闭该云主机。</p>\n<h2 id=\"封存AMI镜像，并使用AMI启动云主机\"><a href=\"#封存AMI镜像，并使用AMI启动云主机\" class=\"headerlink\" title=\"封存AMI镜像，并使用AMI启动云主机\"></a>封存AMI镜像，并使用AMI启动云主机</h2><p>基于上面的云主机封存AMI镜像，并使用该AMI镜像启动新的云主机。</p>\n<p><img src=\"/Conversation-with-ChatGPT-to-accelerate-Cloud-Develpment/SCR-20230302-8x.png\" alt=\"SCR-20230302-8x.png\"></p>\n<h2 id=\"奇迹发生：AppD服务界面启动成功\"><a href=\"#奇迹发生：AppD服务界面启动成功\" class=\"headerlink\" title=\"奇迹发生：AppD服务界面启动成功\"></a>奇迹发生：AppD服务界面启动成功</h2><p>新的云主机启动大约10分钟后，可以通过以下地址访问：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http://ec2-69-230-211-253.cn-northwest-1.compute.amazonaws.com.cn/:9191</span><br><span class=\"line\">username: admin</span><br><span class=\"line\">password: 从信息页面中拷贝instance-id，如上图为i-06b75d367808d02af</span><br></pre></td></tr></table></figure>\n\n<p><img src=\"/Conversation-with-ChatGPT-to-accelerate-Cloud-Develpment/SCR-20230302-a8.png\" alt=\"SCR-20230302-a8.png\"></p>\n<p><img src=\"/Conversation-with-ChatGPT-to-accelerate-Cloud-Develpment/SCR-20230302-b8.png\" alt=\"SCR-20230302-b8.png\"></p>\n<h1 id=\"总结\"><a href=\"#总结\" class=\"headerlink\" title=\"总结\"></a>总结</h1><p>上述的自动化过程还有可以完善的空间，比如没有针对异常的处理，感兴趣的读者可以尝试。</p>\n<p>通过这段与”网红”ChatGPT对话，生成自动化脚本来构建、更新和重新发布应用程序性能管理（APM）解决方案Cisco AppDynamics软件的AMI镜像的经历，笔者希望能为读者展示一条可重复、高效减轻网工工作量的思路。</p>\n<p>关于人工智能，每个人心目中的看法不尽相同，但是我相信在不久的将来，人工智能的发展会令人瞠目结舌，让我们拭目以待吧。</p>\n<p>独木不成舟，在本次制作Cisco AppDynamics的AMI镜像过程中，我得到了思科首席架构师魏航老师以及深圳市风向标信息技术有限公司秦总、赵工的支持和指导，在此表示诚挚的感谢。</p>\n<h1 id=\"附录：ChatGPT自我介绍\"><a href=\"#附录：ChatGPT自我介绍\" class=\"headerlink\" title=\"附录：ChatGPT自我介绍\"></a>附录：ChatGPT自我介绍</h1><p><img src=\"/Conversation-with-ChatGPT-to-accelerate-Cloud-Develpment/SCR-20230303-mp.png\" alt=\"SCR-20230303-mp.png\"></p>\n<p><strong>文末彩蛋：</strong></p>\n<p>本文的标题是ChatGPT帮助笔者生成的，不过它不知道自己是网红🤫，标题里的“网红”是笔者加的。</p>"},{"title":"Kubernetes with CNI Cilium 安装学习","date":"2025-08-01T08:06:36.000Z","description":"本文从零开始部署Ubuntu虚拟机，然后在Ubuntu上安装K8S，使用Cilium作为CNI。","_content":"# Kubernetes with CNI Cilium 安装学习\n\n# 1. 使用自动化脚本安装Ubuntu 24.04虚拟机\n\n## 1.1 准备工作\n\n```bash\n密码加密字符串\nois@ois:~$ mkpasswd --method=SHA-512 --rounds=4096\nPassword: \n$6$rounds=4096$LDu9pXXXXXXXXXXXXXXOh/Iunw372/TVfst1\n\n生成ssh-key，以便实现无密码登录。\nssh-keygen -t rsa -b 4096\nGenerating public/private rsa key pair.\nEnter file in which to save the key (/root/.ssh/id_rsa): \nEnter passphrase (empty for no passphrase): \nEnter same passphrase again: \nYour identification has been saved in /root/.ssh/id_rsa\nYour public key has been saved in /root/.ssh/id_rsa.pub\nThe key fingerprint is:\nSHA256:1+BaD0K3fe6saxPFf41r0SyZEpqhq29AVeRwz+WEXiU \nThe key's randomart image is:\n+---[RSA 4096]----+\n|        .o+  .E..|\n|        .+ o.+.. |\n|       .. +.oo.  |\n|      .. o.=o o  |\n|     .  S.*+oo.B.|\n|      . .=oooo* *|\n|       ...  .o.+.|\n|        o   ooo  |\n|      .+.  .o=o  |\n+----[SHA256]-----+\n```\n\n## 1.2 自动化脚本创建虚拟机节点— 由Gemini生成\n\n### create-vms.sh\n\n```bash\n#!/bin/bash\n\n# --- Configuration ---\nBASE_IMAGE_PATH=\"/home/ois/data/vmimages/noble-server-cloudimg-amd64.img\"\nVM_IMAGE_DIR=\"/home/ois/data/k8s/nodevms\"\nVM_CONFIG_DIR=\"/home/ois/data/k8s/nodevm_cfg\"\nRAM_MB=8192\nVCPUS=4\nDISK_SIZE_GB=20 # <--- ADDED: Increased disk size to 20 GB\nBRIDGE_INTERFACE=\"br0\"\nBASE_IP=\"10.75.59\"\nNETWORK_PREFIX=\"/24\"\nGATEWAY=\"10.75.59.1\"\nNAMESERVER1=\"64.104.76.247\"\nNAMESERVER2=\"64.104.14.184\"\nSEARCH_DOMAIN=\"cisco.com\"\nVNC_PORT_START=5905 # VNC ports will be 5905, 5906, 5907\nPASSWORD_HASH='$6$rounds=4096$LDu9pXXXXXXXXXXXXXXOh/Iunw372/TVfst1'\nSSH_PUB_KEY=$(cat ~/.ssh/id_rsa.pub)\n\n# --- Loop to create 3 VMs ---\nfor i in {1..3}; do\n    VM_NAME=\"kube-node-$i\"\n    VM_IP=\"${BASE_IP}.$((70 + i))\" # IPs will be 10.75.59.71, 10.75.59.72, 10.75.59.73\n    VM_IMAGE_PATH=\"${VM_IMAGE_DIR}/${VM_NAME}.qcow2\"\n    VM_VNC_PORT=$((VNC_PORT_START + i - 1)) # VNC ports will be 5905, 5906, 5907\n\n    echo \"--- Preparing for $VM_NAME (IP: $VM_IP) ---\"\n\n    # Create directories if they don't exist\n    mkdir -p \"$VM_IMAGE_DIR\"\n    mkdir -p \"$VM_CONFIG_DIR\"\n\n    # Create a fresh image for each VM\n    if [ -f \"$VM_IMAGE_PATH\" ]; then\n        echo \"Removing existing image for $VM_NAME...\"\n        rm \"$VM_IMAGE_PATH\"\n    fi\n    echo \"Copying base image to $VM_IMAGE_PATH...\"\n    cp \"$BASE_IMAGE_PATH\" \"$VM_IMAGE_PATH\"\n\n    # --- NEW: Resize the copied image before virt-install ---\n    echo \"Resizing VM image to ${DISK_SIZE_GB}GB...\"\n    qemu-img resize \"$VM_IMAGE_PATH\" \"${DISK_SIZE_GB}G\"\n    # --- END NEW ---\n\n    # Generate user-data for the current VM\n    USER_DATA_FILE=\"${VM_CONFIG_DIR}/${VM_NAME}_user-data\"\n    cat <<EOF > \"$USER_DATA_FILE\"\n#cloud-config\n\nlocale: en_US\nkeyboard:\n  layout: us\ntimezone: Asia/Shanghai\nhostname: ${VM_NAME}\ncreate_hostname_file: true\n\nssh_pwauth: yes\n\ngroups:\n  - ubuntu\n\nusers:\n  - name: ubuntu\n    gecos: ubuntu\n    primary_group: ubuntu\n    groups: sudo, cdrom\n    sudo: ALL=(ALL:ALL) ALL\n    shell: /bin/bash\n    lock_passwd: false\n    passwd: ${PASSWORD_HASH}\n    ssh_authorized_keys:\n      - \"${SSH_PUB_KEY}\"\n\napt:\n  primary:\n    - arches: [default]\n      uri: http://us.archive.ubuntu.com/ubuntu/\n\npackages:\n  - openssh-server\n  - net-tools\n  - iftop\n  - htop\n  - iperf3\n  - vim\n  - curl\n  - wget\n  - cloud-guest-utils # Ensure growpart is available\n\nntp:\n  servers: ['ntp.esl.cisco.com']\n\nruncmd:\n  - echo \"Attempting to resize root partition and filesystem...\"\n  - growpart /dev/vda 1 # Expand the first partition on /dev/vda\n  - resize2fs /dev/vda1 # Expand the ext4 filesystem on /dev/vda1\n  - echo \"Disk resize commands executed. Verify with 'df -h' after boot.\"\nEOF\n\n    # Generate network-config for the current VM\n    NETWORK_CONFIG_FILE=\"${VM_CONFIG_DIR}/${VM_NAME}_network-config\"\n    cat <<EOF > \"$NETWORK_CONFIG_FILE\"\nnetwork:\n  version: 2\n  ethernets:\n    enp1s0:\n      addresses:\n      - \"${VM_IP}${NETWORK_PREFIX}\"\n      nameservers:\n        addresses:\n        - ${NAMESERVER1}\n        - ${NAMESERVER2}\n        search:\n        - ${SEARCH_DOMAIN}\n      routes:\n      - to: \"default\"\n        via: \"${GATEWAY}\"\nEOF\n\n    # Generate meta-data (can be static for now)\n    META_DATA_FILE=\"${VM_CONFIG_DIR}/${VM_NAME}_meta-data\"\n    cat <<EOF > \"$META_DATA_FILE\"\ninstance-id: ${VM_NAME}\nlocal-hostname: ${VM_NAME}\nEOF\n\n    echo \"--- Installing $VM_NAME ---\"\n    virt-install --name \"${VM_NAME}\" --ram \"${RAM_MB}\" --vcpus \"${VCPUS}\" --noreboot \\\n        --os-variant ubuntu24.04 \\\n        --network bridge=\"${BRIDGE_INTERFACE}\" \\\n        --graphics vnc,listen=0.0.0.0,port=\"${VM_VNC_PORT}\" \\\n        --disk path=\"${VM_IMAGE_PATH}\",format=qcow2 \\\n        --console pty,target_type=serial \\\n        --cloud-init user-data=\"${USER_DATA_FILE}\",meta-data=\"${META_DATA_FILE}\",network-config=\"${NETWORK_CONFIG_FILE}\" \\\n        --import \\\n        --wait 0\n\n    echo \"Successfully initiated creation of $VM_NAME.\"\n    echo \"You can connect to VNC on port ${VM_VNC_PORT} to monitor installation (optional).\"\n    echo \"Wait a few minutes for the VM to boot and cloud-init to run.\"\n    echo \"--------------------------------------------------------\"\ndone\n\necho \"All 3 VMs have been initiated. Please wait for them to fully provision.\"\necho \"You can SSH into them using 'ssh ubuntu@<IP_ADDRESS>' where IP addresses are 10.75.59.71, 10.75.59.72, 10.75.59.73.\"\n\n```\n\n上述脚本可自动生成三个虚拟机，并可以使用 ssh ubuntu@10.75.59.71 登录\n\n```bash\nchmod +x create-vms.sh\n\nois@ois:~/data/k8s$ ./create-vms.sh \n--- Preparing for kube-node-1 (IP: 10.75.59.71) ---\nRemoving existing image for kube-node-1...\nCopying base image to /home/ois/data/k8s/nodevms/kube-node-1.qcow2...\nResizing VM image to 20GB...\nImage resized.\n--- Installing kube-node-1 ---\nWARNING  Treating --wait 0 as --noautoconsole\n\nStarting install...\nAllocating 'virtinst-3jev55ba-cloudinit.iso'                                                                                                                                                                                             |    0 B  00:00:00 ... \nTransferring 'virtinst-3jev55ba-cloudinit.iso'                                                                                                                                                                                           |    0 B  00:00:00 ... \nCreating domain...                                                                                                                                                                                                                       |    0 B  00:00:00     \nDomain creation completed.\nSuccessfully initiated creation of kube-node-1.\nYou can connect to VNC on port 5905 to monitor installation (optional).\nWait a few minutes for the VM to boot and cloud-init to run.\n--------------------------------------------------------\n--- Preparing for kube-node-2 (IP: 10.75.59.72) ---\nRemoving existing image for kube-node-2...\nCopying base image to /home/ois/data/k8s/nodevms/kube-node-2.qcow2...\nResizing VM image to 20GB...\nImage resized.\n--- Installing kube-node-2 ---\nWARNING  Treating --wait 0 as --noautoconsole\n\nStarting install...\nAllocating 'virtinst-c4ruhql3-cloudinit.iso'                                                                                                                                                                                             |    0 B  00:00:00 ... \nTransferring 'virtinst-c4ruhql3-cloudinit.iso'                                                                                                                                                                                           |    0 B  00:00:00 ... \nCreating domain...                                                                                                                                                                                                                       |    0 B  00:00:00     \nDomain creation completed.\nSuccessfully initiated creation of kube-node-2.\nYou can connect to VNC on port 5906 to monitor installation (optional).\nWait a few minutes for the VM to boot and cloud-init to run.\n--------------------------------------------------------\n--- Preparing for kube-node-3 (IP: 10.75.59.73) ---\nRemoving existing image for kube-node-3...\nCopying base image to /home/ois/data/k8s/nodevms/kube-node-3.qcow2...\nResizing VM image to 20GB...\nImage resized.\n--- Installing kube-node-3 ---\nWARNING  Treating --wait 0 as --noautoconsole\n\nStarting install...\nAllocating 'virtinst-u5e8k9a9-cloudinit.iso'                                                                                                                                                                                             |    0 B  00:00:00 ... \nTransferring 'virtinst-u5e8k9a9-cloudinit.iso'                                                                                                                                                                                           |    0 B  00:00:00 ... \nCreating domain...                                                                                                                                                                                                                       |    0 B  00:00:00     \nDomain creation completed.\nSuccessfully initiated creation of kube-node-3.\nYou can connect to VNC on port 5907 to monitor installation (optional).\nWait a few minutes for the VM to boot and cloud-init to run.\n--------------------------------------------------------\nAll 3 VMs have been initiated. Please wait for them to fully provision.\nYou can SSH into them using 'ssh ubuntu@<IP_ADDRESS>' where IP addresses are 10.75.59.71, 10.75.59.72, 10.75.59.73.\n\nois@ois:~/data/k8s$ virsh list\n Id   Name                  State\n-------------------------------------\n 83   kube-node-1           running\n 84   kube-node-2           running\n 85   kube-node-3           running\n```\n\n### user-data 示例\n\n```bash\n#cloud-config\n\nlocale: en_US\nkeyboard:\n  layout: us\ntimezone: Asia/Shanghai\nhostname: kube-node-1\ncreate_hostname_file: true\n\nssh_pwauth: yes\n\ngroups:\n  - ubuntu\n\nusers:\n  - name: ubuntu\n    gecos: ubuntu\n    primary_group: ubuntu\n    groups: sudo, cdrom\n    sudo: ALL=(ALL:ALL) ALL\n    shell: /bin/bash\n    lock_passwd: false\n    passwd: $6$rounds=4096$LDu9pXXXXXXXXXXXXXXOh/Iunw372/TVfst1\n    ssh_authorized_keys:\n      - \"ssh-rsa AAAAB3NzaC1yXXXXXXXXXX==\"\n\napt:\n  primary:\n    - arches: [default]\n      uri: http://us.archive.ubuntu.com/ubuntu/\n\npackages:\n  - openssh-server\n  - net-tools\n  - iftop\n  - htop\n  - iperf3\n  - vim\n  - curl\n  - wget\n  - cloud-guest-utils # Ensure growpart is available\n\nntp:\n  servers: ['ntp.esl.cisco.com']\n\nruncmd:\n  - echo \"Attempting to resize root partition and filesystem...\"\n  - growpart /dev/vda 1 # Expand the first partition on /dev/vda\n  - resize2fs /dev/vda1 # Expand the ext4 filesystem on /dev/vda1\n  - echo \"Disk resize commands executed. Verify with 'df -h' after boot.\"\n\n```\n\n### network-config\n\n```bash\nnetwork:\n  version: 2\n  ethernets:\n    enp1s0:\n      addresses:\n      - \"10.75.59.71/24\"\n      nameservers:\n        addresses:\n        - 64.104.76.247\n        - 64.104.14.184\n        search:\n        - cisco.com\n      routes:\n      - to: \"default\"\n        via: \"10.75.59.1\"\n```\n\n### meta-data\n\n```bash\ninstance-id: kube-node-1\nlocal-hostname: kube-node-1\n```\n\n# 2. 使用Ansible安装Kubernetes\n\n## 2.1 脚本内容\n\n以下脚本可用于自动化安装Ansible，并生成Playbook，可直接执行安装任务。\n\n```bash\n#!/bin/bash\n\n# This script automates the setup of an Ansible environment for Kubernetes cluster deployment.\n# It installs Ansible, creates the project directory, inventory, configuration,\n# and defines common Kubernetes setup tasks.\n# This version stops after installing Kubernetes components, allowing manual kubeadm init/join.\n# Includes a robust fix for Containerd's SystemdCgroup configuration and CRI plugin enabling,\n# defines the necessary handler for restarting Containerd, dynamically adds host entries to /etc/hosts,\n# and updates the pause image version in the manual instructions.\n# This update also addresses the runc runtime root configuration in containerd and fixes\n# YAML escape character issues in the hosts file regex, and updates the sandbox image in containerd config.\n\n# --- Configuration ---\nPROJECT_DIR=\"k8s_cluster_setup\"\nMASTER_NODE_IP=\"10.75.59.71\" # Based on your previous script's IP assignment for kube-node-1\nWORKER_NODE_IP_1=\"10.75.59.72\" # Based on your previous script's IP assignment for kube-node-2\nWORKER_NODE_IP_2=\"10.75.59.73\" # Based on your previous script's IP address for kube-node-3\nANSIBLE_USER=\"ubuntu\" # The user created by cloud-init on your VMs\nSSH_PRIVATE_KEY_PATH=\"~/.ssh/id_rsa\" # Path to your SSH private key on the Ansible control machine\n\n# --- Functions ---\n\n# Function to install Ansible\ninstall_ansible() {\n    echo \"--- Installing Ansible ---\"\n    if ! command -v ansible &> /dev/null; then\n        sudo apt update -y\n        sudo apt install -y ansible\n        echo \"Ansible installed successfully.\"\n    else\n        echo \"Ansible is already installed.\"\n    fi\n}\n\n# Function to create project directory and navigate into it\ncreate_project_dir() {\n    echo \"--- Creating project directory: ${PROJECT_DIR} ---\"\n    mkdir -p \"${PROJECT_DIR}\"\n    cd \"${PROJECT_DIR}\" || { echo \"Failed to change directory to ${PROJECT_DIR}. Exiting.\"; exit 1; }\n    echo \"Changed to directory: $(pwd)\"\n}\n\n# Function to create ansible.cfg\ncreate_ansible_cfg() {\n    echo \"--- Creating ansible.cfg ---\"\n    cat <<EOF > ansible.cfg\n[defaults]\ninventory = inventory.ini\nroles_path = ./roles\nhost_key_checking = False # WARNING: Disable host key checking for convenience during initial setup. Re-enable for production!\nEOF\n    echo \"ansible.cfg created.\"\n}\n\n# Function to create inventory.ini (UPDATED with IP variables)\ncreate_inventory() {\n    echo \"--- Creating inventory.ini ---\"\n    cat <<EOF > inventory.ini\n[master]\nkube-node-1 ansible_host=${MASTER_NODE_IP}\n\n[workers]\nkube-node-2 ansible_host=${WORKER_NODE_IP_1}\nkube-node-3 ansible_host=${WORKER_NODE_IP_2}\n\n[all:vars]\nansible_user=${ANSIBLE_USER}\nansible_ssh_private_key_file=${SSH_PRIVATE_KEY_PATH}\nansible_python_interpreter=/usr/bin/python3\n# These variables are now primarily for documentation/script clarity,\n# as the hosts file task will dynamically read from inventory groups.\nmaster_node_ip=${MASTER_NODE_IP}\nworker_node_ip_1=${WORKER_NODE_IP_1}\nworker_node_ip_2=${WORKER_NODE_IP_2}\nEOF\n    echo \"inventory.ini created.\"\n}\n\n# Function to create main playbook.yml (Modified to only include common setup)\ncreate_playbook() {\n    echo \"--- Creating playbook.yml ---\"\n    cat <<EOF > playbook.yml\n---\n- name: Common Kubernetes Setup for all nodes\n  hosts: all\n  become: yes\n  roles:\n    - common_k8s_setup\nEOF\n    echo \"playbook.yml created (only common setup included).\"\n}\n\n# Function to create roles and their tasks\ncreate_roles() {\n    echo \"--- Creating Ansible roles and tasks ---\"\n\n    # common_k8s_setup role\n    mkdir -p roles/common_k8s_setup/tasks\n    # UPDATED: main.yml to include the new hosts entry task first\n    cat <<EOF > roles/common_k8s_setup/tasks/main.yml\n---\n- name: Include add hosts entries task\n  ansible.builtin.include_tasks: 00_add_hosts_entries.yml\n\n- name: Include disable swap task\n  ansible.builtin.include_tasks: 01_disable_swap.yml\n\n- name: Include containerd setup task\n  ansible.builtin.include_tasks: 02_containerd_setup.yml\n\n- name: Include kernel modules and sysctl task\n  ansible.builtin.include_tasks: 03_kernel_modules_sysctl.yml\n\n- name: Include kube repo, install, and hold task\n  ansible.builtin.include_tasks: 04_kube_repo_install_hold.yml\n\n- name: Include initial apt upgrade task\n  ansible.builtin.include_tasks: 05_initial_upgrade.yml\n\n- name: Include configure weekly updates task\n  ansible.builtin.include_tasks: 06_configure_weekly_updates.yml\nEOF\n\n    # NEW FILE: 00_add_hosts_entries.yml (Dynamically adds hosts from inventory, FIXED: Escaped backslashes in regex)\n    cat <<EOF > roles/common_k8s_setup/tasks/00_add_hosts_entries.yml\n---\n- name: Add all inventory hosts to /etc/hosts on each node\n  ansible.builtin.lineinfile:\n    path: /etc/hosts\n    regexp: \"^{{ hostvars[item]['ansible_host'] }}\\\\\\\\s+{{ item }}\" # Fixed: \\\\\\\\s for escaped backslash in regex\n    line: \"{{ hostvars[item]['ansible_host'] }} {{ item }}\"\n    state: present\n    create: yes\n    mode: '0644'\n    owner: root\n    group: root\n  loop: \"{{ groups['all'] }}\" # Loop over all hosts defined in the inventory\nEOF\n\n    # Create handlers directory and file\n    mkdir -p roles/common_k8s_setup/handlers\n    cat <<EOF > roles/common_k8s_setup/handlers/main.yml\n---\n- name: Restart containerd service\n  ansible.builtin.systemd:\n    name: containerd\n    state: restarted\n    daemon_reload: yes\nEOF\n\n    # 01_disable_swap.yml\n    cat <<EOF > roles/common_k8s_setup/tasks/01_disable_swap.yml\n---\n- name: Check if swap is active\n  ansible.builtin.command: swapon --show\n  register: swap_check_result\n  changed_when: false # This command itself doesn't change state\n  failed_when: false  # Don't fail if swapon --show returns non-zero (e.g., no swap enabled)\n\n- name: Disable swap\n  ansible.builtin.command: swapoff -a\n  when: swap_check_result.rc == 0 # Only run if swapon --show indicated swap is active\n\n- name: Persistently disable swap (comment out swapfile in fstab)\n  ansible.builtin.replace:\n    path: /etc/fstab\n    regexp: '^(/swapfile.*)$'\n    replace: '#\\1'\n  when: swap_check_result.rc == 0 # Only run if swap was found to be active\nEOF\n\n    # 02_containerd_setup.yml (UPDATED for sandbox_image)\n    cat <<EOF > roles/common_k8s_setup/tasks/02_containerd_setup.yml\n---\n- name: Install required packages for Containerd\n  ansible.builtin.apt:\n    name:\n      - ca-certificates\n      - curl\n      - gnupg\n      - lsb-release\n      - apt-transport-https\n      - software-properties-common\n    state: present\n    update_cache: yes\n\n- name: Add Docker GPG key\n  ansible.builtin.apt_key:\n    url: https://download.docker.com/linux/ubuntu/gpg\n    state: present\n    keyring: /etc/apt/keyrings/docker.gpg # Use keyring for modern apt\n\n- name: Add Docker APT repository\n  ansible.builtin.apt_repository:\n    repo: \"deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable\"\n    state: present\n    filename: docker\n\n- name: Install Containerd\n  ansible.builtin.apt:\n    name: containerd.io\n    state: present\n    update_cache: yes\n\n- name: Create containerd configuration directory\n  ansible.builtin.file:\n    path: /etc/containerd\n    state: directory\n    mode: '0755'\n\n- name: Generate default containerd configuration directly to final path\n  ansible.builtin.shell: containerd config default > /etc/containerd/config.toml\n  changed_when: true # Always report change as we're ensuring a default state\n\n- name: Ensure CRI plugin is enabled (remove any disabled_plugins line containing \"cri\")\n  ansible.builtin.lineinfile:\n    path: /etc/containerd/config.toml\n    regexp: '^\\s*disabled_plugins = \\[.*\"cri\".*\\]' # More general regexp\n    state: absent\n    backup: yes\n  notify: Restart containerd service\n\n- name: Remove top-level systemd_cgroup from CRI plugin section\n  ansible.builtin.lineinfile:\n    path: /etc/containerd/config.toml\n    regexp: '^\\s*systemd_cgroup = (true|false)' # Matches the 'systemd_cgroup' directly under [plugins.\"io.containerd.grpc.v1.cri\"]\n    state: absent # Remove this line\n    backup: yes\n  notify: Restart containerd service\n\n- name: Remove old runtime_root from runc runtime section\n  ansible.builtin.lineinfile:\n    path: /etc/containerd/config.toml\n    regexp: '^\\s*runtime_root = \".*\"' # Matches runtime_root line\n    state: absent\n    backup: yes\n  notify: Restart containerd service\n\n- name: Configure runc runtime to use SystemdCgroup = true\n  ansible.builtin.lineinfile:\n    path: /etc/containerd/config.toml\n    regexp: '^\\s*#?\\s*SystemdCgroup = (true|false)' # Matches the 'SystemdCgroup' under runc.options\n    line: '            SystemdCgroup = true' # Ensure correct indentation\n    insertafter: '^\\s*\\[plugins\\.\"io\\.containerd\\.grpc\\.v1\\.cri\"\\.containerd\\.runtimes\\.runc\\.options\\]'\n    backup: yes\n  notify: Restart containerd service\n\n- name: Add Root path to runc options\n  ansible.builtin.lineinfile:\n    path: /etc/containerd/config.toml\n    regexp: '^\\s*Root = \".*\"' # Matches existing Root line if any\n    line: '            Root = \"/run/containerd/runc\"' # New Root path\n    insertafter: '^\\s*\\[plugins\\.\"io\\.containerd\\.grpc\\.v1\\.cri\"\\.containerd\\.runtimes\\.runc\\.options\\]'\n    backup: yes\n  notify: Restart containerd service\n\n- name: Update sandbox_image to pause:3.10\n  ansible.builtin.lineinfile:\n    path: /etc/containerd/config.toml\n    regexp: '^\\s*sandbox_image = \"registry.k8s.io/pause:.*\"'\n    line: '    sandbox_image = \"registry.k8s.io/pause:3.10\"'\n    insertafter: '^\\s*\\[plugins\\.\"io\\.containerd\\.grpc\\.v1\\.cri\"\\]' # Insert after the CRI plugin section start\n    backup: yes\n  notify: Restart containerd service\nEOF\n\n    # 03_kernel_modules_sysctl.yml\n    cat <<EOF > roles/common_k8s_setup/tasks/03_kernel_modules_sysctl.yml\n---\n- name: Load overlay module\n  ansible.builtin.command: modprobe overlay\n  args:\n    creates: /sys/module/overlay # Check if module is loaded\n  changed_when: false\n\n- name: Load br_netfilter module\n  ansible.builtin.command: modprobe br_netfilter\n  args:\n    creates: /sys/module/br_netfilter # Check if module is loaded\n  changed_when: false\n\n- name: Add modules to /etc/modules-load.d/k8s.conf\n  ansible.builtin.copy:\n    dest: /etc/modules-load.d/k8s.conf\n    content: |\n      overlay\n      br_netfilter\n\n- name: Configure sysctl parameters for Kubernetes networking\n  ansible.builtin.copy:\n    dest: /etc/sysctl.d/k8s.conf\n    content: |\n      net.bridge.bridge-nf-call-iptables = 1\n      net.bridge.bridge-nf-call-ip6tables = 1\n      net.ipv4.ip_forward = 1\n\n- name: Apply sysctl parameters\n  ansible.builtin.command: sysctl --system\n  changed_when: false\nEOF\n\n    # 04_kube_repo_install_hold.yml\n    cat <<EOF > roles/common_k8s_setup/tasks/04_kube_repo_install_hold.yml\n---\n- name: Create Kubernetes apt keyring directory\n  ansible.builtin.file:\n    path: /etc/apt/keyrings\n    state: directory\n    mode: '0755'\n\n- name: Download Kubernetes GPG key and dearmor\n  ansible.builtin.shell: |\n    curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.33/deb/Release.key | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg\n  args:\n    creates: /etc/apt/keyrings/kubernetes-apt-keyring.gpg\n  changed_when: false # This command is idempotent enough for our purposes\n\n- name: Add Kubernetes APT repository source list\n  ansible.builtin.copy:\n    dest: /etc/apt/sources.list.d/kubernetes.list\n    content: \"deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.33/deb/ /\\n\"\n    mode: '0644'\n    backup: yes\n\n- name: Update apt cache after adding Kubernetes repo\n  ansible.builtin.apt:\n    update_cache: yes\n\n- name: Install kubelet, kubeadm, kubectl\n  ansible.builtin.apt:\n    name:\n      - kubelet\n      - kubeadm\n      - kubectl\n    state: present\n    update_cache: yes # Ensure apt cache is updated after adding repo.\n\n- name: Hold kubelet, kubeadm, kubectl packages\n  ansible.builtin.dpkg_selections:\n    name: \"{{ item }}\"\n    selection: hold\n  loop:\n    - kubelet\n    - kubeadm\n    - kubectl\n\n- name: Enable and start kubelet service\n  ansible.builtin.systemd:\n    name: kubelet\n    state: started\n    enabled: yes\nEOF\n\n    # NEW FILE: 05_initial_upgrade.yml\n    cat <<EOF > roles/common_k8s_setup/tasks/05_initial_upgrade.yml\n---\n- name: Perform initial apt update and upgrade\n  ansible.builtin.apt:\n    update_cache: yes\n    upgrade: yes\n    autoremove: yes\n    purge: yes\nEOF\n\n    # NEW FILE: 06_configure_weekly_updates.yml\n    cat <<EOF > roles/common_k8s_setup/tasks/06_configure_weekly_updates.yml\n---\n- name: Configure weekly apt update and upgrade cron job\n  ansible.builtin.cron:\n    name: \"weekly apt update and upgrade\"\n    weekday: \"0\" # Sunday\n    hour: \"3\"    # 3 AM\n    minute: \"0\"\n    job: \"/usr/bin/apt update && /usr/bin/apt upgrade -y && /usr/bin/apt autoremove -y && /usr/bin/apt clean\"\n    user: root\n    state: present\nEOF\n\n    # Master and Worker roles are still created for structure, but not called by playbook.yml\n    mkdir -p roles/k8s-master/tasks\n    cat <<EOF > roles/k8s-master/tasks/main.yml\n---\n- name: This role is intentionally skipped by the main playbook for manual setup.\n  ansible.builtin.debug:\n    msg: \"This master role is not executed by default. Run 'kubeadm init' manually on the master node.\"\nEOF\n\n    mkdir -p roles/k8s-worker/tasks\n    cat <<EOF > roles/k8s-worker/tasks/main.yml\n---\n- name: This role is intentionally skipped by the main playbook for manual setup.\n  ansible.builtin.debug:\n    msg: \"This worker role is not executed by default. Run 'kubeadm join' manually on worker nodes.\"\nEOF\n\n    echo \"Ansible roles and tasks created.\"\n}\n\n# --- Main execution ---\ninstall_ansible\ncreate_project_dir\ncreate_ansible_cfg\ncreate_inventory\ncreate_playbook\ncreate_roles\n\necho \"\"\necho \"--- Ansible setup for Kubernetes installation is complete! ---\"\necho \"Navigate to the project directory:\"\necho \"cd ${PROJECT_DIR}\"\necho \"\"\necho \"Then, run the Ansible playbook to install Kubernetes components on all nodes:\"\necho \"ansible-playbook playbook.yml -K\"\necho \"\"\necho \"After the playbook finishes, you will need to manually initialize the Kubernetes cluster:\"\necho \"1. SSH into the master node (kube-node-1):\"\necho \"   ssh ubuntu@${MASTER_NODE_IP}\"\necho \"\"\necho \"2. Initialize the Kubernetes control plane on the master node:\"\necho \"   sudo kubeadm init --control-plane-endpoint=kube-node-1 --pod-network-cidr=172.16.0.0/20 --service-cidr=172.16.32.0/20 --skip-phases=addon/kube-proxy --pod-infra-container-image=registry.k8s.io/pause:3.10\"\necho \"\"\necho \"3. After 'kubeadm init' completes, it will print instructions to set up kubectl and the 'kubeadm join' command.\"\necho \"   Follow the instructions to set up kubectl for the 'ubuntu' user:\"\necho \"   mkdir -p \\$HOME/.kube\"\necho \"   sudo cp -i /etc/kubernetes/admin.conf \\$HOME/.kube/config\"\necho \"   sudo chown \\$(id -u):\\$(id -g) \\$HOME/.kube/config\"\necho \"\"\necho \"4. Copy the 'kubeadm join' command (including the token and discovery-token-ca-cert-hash) printed by 'kubeadm init'.\"\necho \"   It will look something like: 'kubeadm join <master-ip>:6443 --token <token> --discovery-token-ca-cert-hash sha256:<hash>'\"\necho \"\"\necho \"5. SSH into each worker node (kube-node-2, kube-node-3) and run the join command:\"\necho \"   ssh ubuntu@${WORKER_NODE_IP_1} (for kube-node-2)\"\necho \"   sudo <PASTE_YOUR_KUBEADM_JOIN_COMMAND_HERE>\"\necho \"\"\necho \"   ssh ubuntu@${WORKER_NODE_IP_2} (for kube-node-3)\"\necho \"   sudo <PASTE_YOUR_KUBEADM_JOIN_COMMAND_HERE>\"\necho \"\"\necho \"6. Verify your cluster status from the master node:\"\necho \"   ssh ubuntu@${MASTER_NODE_IP}\"\necho \"   kubectl get nodes\"\necho \"   kubectl get pods --all-namespaces\"\n```\n\n上述脚本执行完后，创建以下文档\n\n```bash\nroot@ois:/home/ois/data/k8s/k8s_cluster_setup# ls -R1\n.:\nansible.cfg\ninventory.ini\nplaybook.yml\nroles\n\n./roles:\ncommon_k8s_setup\nk8s-master\nk8s-worker\n\n./roles/common_k8s_setup:\nhandlers\ntasks\n\n./roles/common_k8s_setup/handlers:\nmain.yml\n\n./roles/common_k8s_setup/tasks:\n00_add_hosts_entries.yml\n01_disable_swap.yml\n02_containerd_setup.yml\n03_kernel_modules_sysctl.yml\n04_kube_repo_install_hold.yml\n05_initial_upgrade.yml\n06_configure_weekly_updates.yml\nmain.yml\n\n./roles/k8s-master:\ntasks\n\n./roles/k8s-master/tasks:\nmain.yml\n\n./roles/k8s-worker:\ntasks\n\n./roles/k8s-worker/tasks:\nmain.yml\n```\n\n## 2.2 执行过程\n\n在执行前，需要让.ssh/known_hosts 文件保存这些主机的SSH Key。\n\n```bash\n#!/bin/bash\n\n# This script prepares the Ansible control node by adding the SSH host keys\n# of the target nodes to the ~/.ssh/known_hosts file.\n# It first removes any outdated keys for the specified hosts before scanning\n# for the new ones, preventing \"REMOTE HOST IDENTIFICATION HAS CHANGED\" errors.\n\n# --- Configuration ---\n# List of hosts (IPs or FQDNs) to scan.\n# These should be the same hosts you have in your Ansible inventory.\nHOSTS=(\n    \"10.75.59.71\"\n    \"10.75.59.72\"\n    \"10.75.59.73\"\n)\n\n# The location of your known_hosts file.\nKNOWN_HOSTS_FILE=~/.ssh/known_hosts\n\n# --- Main Logic ---\necho \"Starting SSH host key scan to update ${KNOWN_HOSTS_FILE}...\"\necho \"\"\n\n# Ensure the .ssh directory exists with the correct permissions.\nmkdir -p ~/.ssh\nchmod 700 ~/.ssh\n\n# Loop through each host defined in the HOSTS array.\nfor host in \"${HOSTS[@]}\"; do\n    echo \"--- Processing host: ${host} ---\"\n\n    # 1. Remove the old host key (if it exists).\n    # This is the key step to ensure we replace outdated entries.\n    # The command is silent if no key is found.\n    echo \"Step 1: Removing any old key for ${host}...\"\n    ssh-keygen -R \"${host}\"\n\n    # 2. Scan for the new host key and append it.\n    # The -H flag hashes the hostname, which is a security best practice.\n    echo \"Step 2: Scanning for new key and adding it to known_hosts...\"\n    ssh-keyscan -H \"${host}\" >> \"${KNOWN_HOSTS_FILE}\"\n\n    echo \"Successfully updated key for ${host}.\"\n    echo \"\"\ndone\n\n# Set the correct permissions for the known_hosts file, as SSH is strict about this.\nchmod 600 \"${KNOWN_HOSTS_FILE}\"\n\necho \"✅ All hosts have been scanned and keys have been updated.\"\necho \"You can now run your Ansible playbook without host key verification prompts.\"\n```\n\n```bash\nchmod +x ansible-k8s-v2.sh \nois@ois:~/data/k8s$ ./ansible-k8s-v2.sh \n--- Installing Ansible ---\nAnsible is already installed.\n--- Creating project directory: k8s_cluster_setup ---\nChanged to directory: /home/ois/data/k8s/k8s_cluster_setup\n--- Creating ansible.cfg ---\nansible.cfg created.\n--- Creating inventory.ini ---\ninventory.ini created.\n--- Creating playbook.yml ---\nplaybook.yml created (only common setup included).\n--- Creating Ansible roles and tasks ---\nAnsible roles and tasks created.\n\n--- Ansible setup for Kubernetes installation is complete! ---\nNavigate to the project directory:\ncd k8s_cluster_setup\n\nThen, run the Ansible playbook to install Kubernetes components on all nodes:\nansible-playbook playbook.yml -K\n\nAfter the playbook finishes, you will need to manually initialize the Kubernetes cluster:\n1. SSH into the master node (kube-node-1):\n   ssh ubuntu@10.75.59.71\n\n2. Initialize the Kubernetes control plane on the master node:\n   sudo kubeadm init --control-plane-endpoint=kube-node-1 --pod-network-cidr=172.16.0.0/20 --service-cidr=172.16.32.0/20 --skip-phases=addon/kube-proxy --pod-infra-container-image=registry.k8s.io/pause:3.10\n\n3. After 'kubeadm init' completes, it will print instructions to set up kubectl and the 'kubeadm join' command.\n   Follow the instructions to set up kubectl for the 'ubuntu' user:\n   mkdir -p $HOME/.kube\n   sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config\n   sudo chown $(id -u):$(id -g) $HOME/.kube/config\n\n4. Copy the 'kubeadm join' command (including the token and discovery-token-ca-cert-hash) printed by 'kubeadm init'.\n   It will look something like: 'kubeadm join <master-ip>:6443 --token <token> --discovery-token-ca-cert-hash sha256:<hash>'\n\n5. SSH into each worker node (kube-node-2, kube-node-3) and run the join command:\n   ssh ubuntu@10.75.59.72 (for kube-node-2)\n   sudo <PASTE_YOUR_KUBEADM_JOIN_COMMAND_HERE>\n\n   ssh ubuntu@10.75.59.73 (for kube-node-3)\n   sudo <PASTE_YOUR_KUBEADM_JOIN_COMMAND_HERE>\n\n6. Verify your cluster status from the master node:\n   ssh ubuntu@10.75.59.71\n   kubectl get nodes\n   kubectl get pods --all-namespaces\nois@ois:~/data/k8s$ cd k8s_cluster_setup/\n```\n\n```bash\nois@ois:~/data/k8s/k8s_cluster_setup$ ansible-playbook playbook.yml -K\nBECOME password: \n\nPLAY [Common Kubernetes Setup for all nodes] *******************************************************************************************************************************************************************************************************************\n\nTASK [Gathering Facts] *****************************************************************************************************************************************************************************************************************************************\nok: [kube-node-1]\nok: [kube-node-2]\nok: [kube-node-3]\n\nTASK [common_k8s_setup : Include add hosts entries task] *******************************************************************************************************************************************************************************************************\nincluded: /home/ois/data/k8s/k8s_cluster_setup/roles/common_k8s_setup/tasks/00_add_hosts_entries.yml for kube-node-1, kube-node-2, kube-node-3\n\nTASK [common_k8s_setup : Add all inventory hosts to /etc/hosts on each node] ***********************************************************************************************************************************************************************************\nchanged: [kube-node-2] => (item=kube-node-1)\nchanged: [kube-node-1] => (item=kube-node-1)\nchanged: [kube-node-3] => (item=kube-node-1)\nchanged: [kube-node-1] => (item=kube-node-2)\nchanged: [kube-node-2] => (item=kube-node-2)\nchanged: [kube-node-3] => (item=kube-node-2)\nchanged: [kube-node-2] => (item=kube-node-3)\nchanged: [kube-node-1] => (item=kube-node-3)\nchanged: [kube-node-3] => (item=kube-node-3)\n\nTASK [common_k8s_setup : Include disable swap task] ************************************************************************************************************************************************************************************************************\nincluded: /home/ois/data/k8s/k8s_cluster_setup/roles/common_k8s_setup/tasks/01_disable_swap.yml for kube-node-1, kube-node-2, kube-node-3\n\nTASK [common_k8s_setup : Check if swap is active] **************************************************************************************************************************************************************************************************************\nok: [kube-node-2]\nok: [kube-node-1]\nok: [kube-node-3]\n\nTASK [common_k8s_setup : Disable swap] *************************************************************************************************************************************************************************************************************************\nchanged: [kube-node-1]\nchanged: [kube-node-2]\nchanged: [kube-node-3]\n\nTASK [common_k8s_setup : Persistently disable swap (comment out swapfile in fstab)] ****************************************************************************************************************************************************************************\nok: [kube-node-2]\nok: [kube-node-3]\nok: [kube-node-1]\n\nTASK [common_k8s_setup : Include containerd setup task] ********************************************************************************************************************************************************************************************************\nincluded: /home/ois/data/k8s/k8s_cluster_setup/roles/common_k8s_setup/tasks/02_containerd_setup.yml for kube-node-1, kube-node-2, kube-node-3\n\nTASK [common_k8s_setup : Install required packages for Containerd] *********************************************************************************************************************************************************************************************\nchanged: [kube-node-2]\nchanged: [kube-node-1]\nchanged: [kube-node-3]\n\nTASK [common_k8s_setup : Add Docker GPG key] *******************************************************************************************************************************************************************************************************************\nchanged: [kube-node-1]\nchanged: [kube-node-2]\nchanged: [kube-node-3]\n\nTASK [common_k8s_setup : Add Docker APT repository] ************************************************************************************************************************************************************************************************************\nchanged: [kube-node-2]\nchanged: [kube-node-1]\nchanged: [kube-node-3]\n\nTASK [common_k8s_setup : Install Containerd] *******************************************************************************************************************************************************************************************************************\nchanged: [kube-node-3]\nchanged: [kube-node-1]\nchanged: [kube-node-2]\n\nTASK [common_k8s_setup : Create containerd configuration directory] ********************************************************************************************************************************************************************************************\nok: [kube-node-2]\nok: [kube-node-3]\nok: [kube-node-1]\n\nTASK [common_k8s_setup : Generate default containerd configuration directly to final path] *********************************************************************************************************************************************************************\nchanged: [kube-node-1]\nchanged: [kube-node-3]\nchanged: [kube-node-2]\n\nTASK [common_k8s_setup : Ensure CRI plugin is enabled (remove any disabled_plugins line containing \"cri\")] *****************************************************************************************************************************************************\nok: [kube-node-1]\nok: [kube-node-2]\nok: [kube-node-3]\n\nTASK [common_k8s_setup : Remove top-level systemd_cgroup from CRI plugin section] ******************************************************************************************************************************************************************************\nchanged: [kube-node-1]\nchanged: [kube-node-2]\nchanged: [kube-node-3]\n\nTASK [common_k8s_setup : Remove old runtime_root from runc runtime section] ************************************************************************************************************************************************************************************\nchanged: [kube-node-1]\nchanged: [kube-node-3]\nchanged: [kube-node-2]\n\nTASK [common_k8s_setup : Configure runc runtime to use SystemdCgroup = true] ***********************************************************************************************************************************************************************************\nchanged: [kube-node-1]\nchanged: [kube-node-2]\nchanged: [kube-node-3]\n\nTASK [common_k8s_setup : Add Root path to runc options] ********************************************************************************************************************************************************************************************************\nchanged: [kube-node-1]\nchanged: [kube-node-3]\nchanged: [kube-node-2]\n\nTASK [common_k8s_setup : Update sandbox_image to pause:3.10] ***************************************************************************************************************************************************************************************************\nchanged: [kube-node-1]\nchanged: [kube-node-2]\nchanged: [kube-node-3]\n\nTASK [common_k8s_setup : Include kernel modules and sysctl task] ***********************************************************************************************************************************************************************************************\nincluded: /home/ois/data/k8s/k8s_cluster_setup/roles/common_k8s_setup/tasks/03_kernel_modules_sysctl.yml for kube-node-1, kube-node-2, kube-node-3\n\nTASK [common_k8s_setup : Load overlay module] ******************************************************************************************************************************************************************************************************************\nok: [kube-node-1]\nok: [kube-node-2]\nok: [kube-node-3]\n\nTASK [common_k8s_setup : Load br_netfilter module] *************************************************************************************************************************************************************************************************************\nok: [kube-node-1]\nok: [kube-node-2]\nok: [kube-node-3]\n\nTASK [common_k8s_setup : Add modules to /etc/modules-load.d/k8s.conf] ******************************************************************************************************************************************************************************************\nchanged: [kube-node-1]\nchanged: [kube-node-2]\nchanged: [kube-node-3]\n\nTASK [common_k8s_setup : Configure sysctl parameters for Kubernetes networking] ********************************************************************************************************************************************************************************\nchanged: [kube-node-1]\nchanged: [kube-node-2]\nchanged: [kube-node-3]\n\nTASK [common_k8s_setup : Apply sysctl parameters] **************************************************************************************************************************************************************************************************************\nok: [kube-node-1]\nok: [kube-node-2]\nok: [kube-node-3]\n\nTASK [common_k8s_setup : Include kube repo, install, and hold task] ********************************************************************************************************************************************************************************************\nincluded: /home/ois/data/k8s/k8s_cluster_setup/roles/common_k8s_setup/tasks/04_kube_repo_install_hold.yml for kube-node-1, kube-node-2, kube-node-3\n\nTASK [common_k8s_setup : Create Kubernetes apt keyring directory] **********************************************************************************************************************************************************************************************\nok: [kube-node-1]\nok: [kube-node-2]\nok: [kube-node-3]\n\nTASK [common_k8s_setup : Download Kubernetes GPG key and dearmor] **********************************************************************************************************************************************************************************************\nok: [kube-node-2]\nok: [kube-node-1]\nok: [kube-node-3]\n\nTASK [common_k8s_setup : Add Kubernetes APT repository source list] ********************************************************************************************************************************************************************************************\nchanged: [kube-node-2]\nchanged: [kube-node-3]\nchanged: [kube-node-1]\n\nTASK [common_k8s_setup : Update apt cache after adding Kubernetes repo] ****************************************************************************************************************************************************************************************\nchanged: [kube-node-2]\nchanged: [kube-node-1]\nchanged: [kube-node-3]\n\nTASK [common_k8s_setup : Install kubelet, kubeadm, kubectl] ****************************************************************************************************************************************************************************************************\nchanged: [kube-node-3]\nchanged: [kube-node-2]\nchanged: [kube-node-1]\n\nTASK [common_k8s_setup : Hold kubelet, kubeadm, kubectl packages] **********************************************************************************************************************************************************************************************\nchanged: [kube-node-1] => (item=kubelet)\nchanged: [kube-node-3] => (item=kubelet)\nchanged: [kube-node-2] => (item=kubelet)\nchanged: [kube-node-3] => (item=kubeadm)\nchanged: [kube-node-1] => (item=kubeadm)\nchanged: [kube-node-2] => (item=kubeadm)\nchanged: [kube-node-3] => (item=kubectl)\nchanged: [kube-node-1] => (item=kubectl)\nchanged: [kube-node-2] => (item=kubectl)\n\nTASK [common_k8s_setup : Enable and start kubelet service] *****************************************************************************************************************************************************************************************************\nchanged: [kube-node-3]\nchanged: [kube-node-2]\nchanged: [kube-node-1]\n\nTASK [common_k8s_setup : Include initial apt upgrade task] *****************************************************************************************************************************************************************************************************\nincluded: /home/ois/data/k8s/k8s_cluster_setup/roles/common_k8s_setup/tasks/05_initial_upgrade.yml for kube-node-1, kube-node-2, kube-node-3\n\nTASK [common_k8s_setup : Perform initial apt update and upgrade] ***********************************************************************************************************************************************************************************************\nchanged: [kube-node-3]\nchanged: [kube-node-2]\nchanged: [kube-node-1]\n\nTASK [common_k8s_setup : Include configure weekly updates task] ************************************************************************************************************************************************************************************************\nincluded: /home/ois/data/k8s/k8s_cluster_setup/roles/common_k8s_setup/tasks/06_configure_weekly_updates.yml for kube-node-1, kube-node-2, kube-node-3\n\nTASK [common_k8s_setup : Configure weekly apt update and upgrade cron job] *************************************************************************************************************************************************************************************\nchanged: [kube-node-1]\nchanged: [kube-node-2]\nchanged: [kube-node-3]\n\nRUNNING HANDLER [common_k8s_setup : Restart containerd service] ************************************************************************************************************************************************************************************************\nchanged: [kube-node-2]\nchanged: [kube-node-1]\nchanged: [kube-node-3]\n\nPLAY RECAP *****************************************************************************************************************************************************************************************************************************************************\nkube-node-1                : ok=39   changed=22   unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   \nkube-node-2                : ok=39   changed=22   unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   \nkube-node-3                : ok=39   changed=22   unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   \n```\n\n# 3. 设置本地DNS和BGP\n\n设置一个本地DNS和BGP服务器用于测试。\n\n## 3.1 create-dns.sh\n\n```bash\n#!/bin/bash\n\n# --- Configuration ---\nBASE_IMAGE_PATH=\"/home/ois/data/vmimages/noble-server-cloudimg-amd64.img\"\nVM_IMAGE_DIR=\"/home/ois/data/k8s/nodevms\"\nVM_CONFIG_DIR=\"/home/ois/data/k8s/nodevm_cfg\"\nRAM_MB=8192\nVCPUS=4\nDISK_SIZE_GB=20\nBRIDGE_INTERFACE=\"br0\"\n# Specific IP for the single VM\nVM_IP=\"10.75.59.76\"\nNETWORK_PREFIX=\"/24\"\nGATEWAY=\"10.75.59.1\"\n# DNS servers for the VM's initial resolution (for internet access)\nVM_NAMESERVER1=\"64.104.76.247\"\nVM_NAMESERVER2=\"64.104.14.184\"\nSEARCH_DOMAIN=\"cisco.com\"\nVNC_PORT=5909 # Fixed VNC port for the single VM\nPASSWORD_HASH='$6$rounds=4096$LDu9pXXXXXXXXXXXXXXOh/Iunw372/TVfst1'\nSSH_PUB_KEY=$(cat ~/.ssh/id_rsa.pub)\n\n# --- VM Details ---\nVM_NAME=\"dns-server-vm\"\nVM_IMAGE_PATH=\"${VM_IMAGE_DIR}/${VM_NAME}.qcow2\"\n\necho \"--- Preparing for $VM_NAME (IP: $VM_IP) ---\"\n\n# Create directories if they don't exist\nmkdir -p \"$VM_IMAGE_DIR\"\nmkdir -p \"$VM_CONFIG_DIR\"\n\n# Create a fresh image for the VM\nif [ -f \"$VM_IMAGE_PATH\" ]; then\n    echo \"Removing existing image for $VM_NAME...\"\n    rm \"$VM_IMAGE_PATH\"\nfi\necho \"Copying base image to $VM_IMAGE_PATH...\"\ncp \"$BASE_IMAGE_PATH\" \"$VM_IMAGE_PATH\"\n\n# Resize the copied image before virt-install\necho \"Resizing VM image to ${DISK_SIZE_GB}GB...\"\nqemu-img resize \"$VM_IMAGE_PATH\" \"${DISK_SIZE_GB}G\"\n\n# Generate user-data for the VM (installing dnsmasq, no UFW, no dnsmasq config here)\nUSER_DATA_FILE=\"${VM_CONFIG_DIR}/${VM_NAME}_user-data\"\ncat <<EOF > \"$USER_DATA_FILE\"\n#cloud-config\n\nlocale: en_US\nkeyboard:\n  layout: us\ntimezone: Asia/Tokyo\nhostname: ${VM_NAME}\ncreate_hostname_file: true\n\nssh_pwauth: yes\n\ngroups:\n  - ubuntu\n\nusers:\n  - name: ubuntu\n    gecos: ubuntu\n    primary_group: ubuntu\n    groups: sudo, cdrom\n    sudo: ALL=(ALL:ALL) ALL\n    shell: /bin/bash\n    lock_passwd: false\n    passwd: ${PASSWORD_HASH}\n    ssh_authorized_keys:\n      - \"${SSH_PUB_KEY}\"\n\napt:\n  primary:\n    - arches: [default]\n      uri: http://us.archive.ubuntu.com/ubuntu/\n\npackages:\n  - openssh-server\n  - net-tools\n  - iftop\n  - htop\n  - iperf3\n  - vim\n  - curl\n  - wget\n  - cloud-guest-utils # Ensure growpart is available\n  - dnsmasq # Install dnsmasq for DNS server functionality\n\nntp:\n  servers: ['ntp.esl.cisco.com']\n\nruncmd:\n  - echo \"Attempting to resize root partition and filesystem...\"\n  - growpart /dev/vda 1 # Expand the first partition on /dev/vda\n  - resize2fs /dev/vda1 # Expand the ext4 filesystem on /dev/vda1\n  - echo \"Disk resize commands executed. Verify with 'df -h' after boot.\"\nEOF\n\n# Generate network-config for the VM (pointing to external DNS for initial connectivity)\nNETWORK_CONFIG_FILE=\"${VM_CONFIG_DIR}/${VM_NAME}_network-config\"\ncat <<EOF > \"$NETWORK_CONFIG_FILE\"\nnetwork:\n  version: 2\n  ethernets:\n    enp1s0:\n      addresses:\n      - \"${VM_IP}${NETWORK_PREFIX}\"\n      nameservers:\n        addresses:\n        - ${VM_NAMESERVER1} # Point VM to external DNS for initial internet access\n        - ${VM_NAMESERVER2}\n        search:\n        - ${SEARCH_DOMAIN}\n      routes:\n      - to: \"default\"\n        via: \"${GATEWAY}\"\nEOF\n\n# Generate meta-data\nMETA_DATA_FILE=\"${VM_CONFIG_DIR}/${VM_NAME}_meta-data\"\ncat <<EOF > \"$META_DATA_FILE\"\ninstance-id: ${VM_NAME}\nlocal-hostname: ${VM_NAME}\nEOF\n\necho \"--- Installing $VM_NAME ---\"\nvirt-install --name \"${VM_NAME}\" --ram \"${RAM_MB}\" --vcpus \"${VCPUS}\" --noreboot \\\n    --os-variant ubuntu24.04 \\\n    --network bridge=\"${BRIDGE_INTERFACE}\" \\\n    --graphics vnc,listen=0.0.0.0,port=\"${VNC_PORT}\" \\\n    --disk path=\"${VM_IMAGE_PATH}\",format=qcow2 \\\n    --console pty,target_type=serial \\\n    --cloud-init user-data=\"${USER_DATA_FILE}\",meta-data=\"${META_DATA_FILE}\",network-config=\"${NETWORK_CONFIG_FILE}\" \\\n    --import \\\n    --wait 0\n\necho \"Successfully initiated creation of $VM_NAME.\"\necho \"You can connect to VNC on port ${VNC_PORT} to monitor installation (optional).\"\necho \"Wait a few minutes for the VM to boot and cloud-init to run.\"\necho \"--------------------------------------------------------\"\n\necho \"The DNS server VM has been initiated. Please wait for it to fully provision.\"\necho \"You can SSH into it using 'ssh ubuntu@${VM_IP}'.\"\necho \"Once provisioned, proceed to use the 'setup-dnsmasq-ansible.sh' script to configure DNS using Ansible.\"\n\nois@ois:~/data/k8s$ ./create-dns.sh \n--- Preparing for dns-server-vm (IP: 10.75.59.76) ---\nCopying base image to /home/ois/data/k8s/nodevms/dns-server-vm.qcow2...\nResizing VM image to 20GB...\nImage resized.\n--- Installing dns-server-vm ---\nWARNING  Treating --wait 0 as --noautoconsole\n\nStarting install...\nAllocating 'virtinst-y1pxxrj5-cloudinit.iso'                                                                                                                                                                                             |    0 B  00:00:00 ... \nTransferring 'virtinst-y1pxxrj5-cloudinit.iso'                                                                                                                                                                                           |    0 B  00:00:00 ... \nCreating domain...                                                                                                                                                                                                                       |    0 B  00:00:00     \nDomain creation completed.\nSuccessfully initiated creation of dns-server-vm.\nYou can connect to VNC on port 5909 to monitor installation (optional).\nWait a few minutes for the VM to boot and cloud-init to run.\n--------------------------------------------------------\nThe DNS server VM has been initiated. Please wait for it to fully provision.\nYou can SSH into it using 'ssh ubuntu@10.75.59.76'.\nOnce provisioned, you can test the DNS forwarding by configuring another machine to use 10.75.59.76 as its DNS server and performing a DNS query.\n```\n\n## 3.2 使用Ansible设置dnsmasq\n\n```bash\n#!/bin/bash\n\n# --- Configuration for Ansible and DNSmasq ---\nVM_IP=\"10.75.59.76\"\nSSH_USER=\"ubuntu\"\nSSH_PRIVATE_KEY_PATH=\"~/.ssh/id_rsa\" # Ensure this path is correct for your setup\nFORWARD_NAMESERVER1=\"64.104.76.247\"\nFORWARD_NAMESERVER2=\"64.104.14.184\"\nSEARCH_DOMAIN=\"cisco.com\"\nANSIBLE_DIR=\"ansible_dnsmasq_setup\"\n\necho \"--- Setting up Ansible environment and configuring DNSmasq on ${VM_IP} ---\"\n\n# Create a directory for Ansible files\nmkdir -p \"$ANSIBLE_DIR\"\ncd \"$ANSIBLE_DIR\" || exit 1\n\n# --- Install Ansible if not already installed ---\nif ! command -v ansible &> /dev/null\nthen\n    echo \"Ansible not found. Installing Ansible...\"\n    # Check OS and install accordingly\n    if [ -f /etc/os-release ]; then\n        . /etc/os-release\n        if [[ \"$ID\" == \"ubuntu\" || \"$ID\" == \"debian\" ]]; then\n            sudo apt update\n            sudo apt install -y software-properties-common\n            sudo apt-add-repository --yes --update ppa:ansible/ansible\n            sudo apt install -y ansible\n        elif [[ \"$ID\" == \"centos\" || \"$ID\" == \"rhel\" || \"$ID\" == \"fedora\" ]]; then\n            sudo yum install -y epel-release\n            sudo yum install -y ansible\n        else\n            echo \"Unsupported OS for automatic Ansible installation. Please install Ansible manually.\"\n            exit 1\n        fi\n    else\n        echo \"Could not determine OS for automatic Ansible installation. Please install Ansible manually.\"\n        exit 1\n    fi\nelse\n    echo \"Ansible is already installed.\"\nfi\n\n# --- Create Ansible Inventory File ---\necho \"Creating Ansible inventory file: inventory.ini\"\ncat <<EOF > inventory.ini\n[dns_server]\n${VM_IP} ansible_user=${SSH_USER} ansible_ssh_private_key_file=${SSH_PRIVATE_KEY_PATH} ansible_python_interpreter=/usr/bin/python3\nEOF\n\n# --- Create Ansible Playbook (setup-dnsmasq.yml) ---\necho \"Creating Ansible playbook: setup-dnsmasq.yml\"\ncat <<EOF > setup-dnsmasq.yml\n---\n- name: Configure DNSmasq Server on Ubuntu VM\n  hosts: dns_server\n  become: yes # Run tasks with sudo privileges\n  vars:\n    dns_forwarder_1: \"${FORWARD_NAMESERVER1}\"\n    dns_forwarder_2: \"${FORWARD_NAMESERVER2}\"\n    vm_ip: \"${VM_IP}\"\n    search_domain: \"${SEARCH_DOMAIN}\"\n\n  tasks:\n    - name: Ensure apt cache is updated\n      ansible.builtin.apt:\n        update_cache: yes\n        cache_valid_time: 3600 # Cache for 1 hour\n\n    - name: Install dnsmasq package\n      ansible.builtin.apt:\n        name: dnsmasq\n        state: present\n\n    - name: Stop dnsmasq service before configuration\n      ansible.builtin.systemd:\n        name: dnsmasq\n        state: stopped\n      ignore_errors: yes # Ignore if it's not running initially\n\n    - name: Backup original dnsmasq.conf\n      ansible.builtin.command: mv /etc/dnsmasq.conf /etc/dnsmasq.conf.bak\n      args:\n        removes: /etc/dnsmasq.conf # Only run if dnsmasq.conf exists\n      ignore_errors: yes\n\n    - name: Configure dnsmasq for forwarding\n      ansible.builtin.template:\n        src: dnsmasq.conf.j2\n        dest: /etc/dnsmasq.conf\n        owner: root\n        group: root\n        mode: '0644'\n      notify: Restart dnsmasq\n\n    - name: Set VM's /etc/resolv.conf to point to itself (local DNS)\n      ansible.builtin.template:\n        src: resolv.conf.j2\n        dest: /etc/resolv.conf\n        owner: root\n        group: root\n        mode: '0644'\n      vars:\n        local_dns_ip: \"127.0.0.1\" # dnsmasq listens on 127.0.0.1\n        # Removed: search_domain: \"{{ search_domain }}\" - it's already available from play vars\n      notify: Restart systemd-resolved # Or NetworkManager, depending on Ubuntu version\n\n  handlers:\n    - name: Restart dnsmasq\n      ansible.builtin.systemd:\n        name: dnsmasq\n        state: restarted\n        enabled: yes # Ensure it's enabled to start on boot\n\n    - name: Restart systemd-resolved\n      ansible.builtin.systemd:\n        name: systemd-resolved\n        state: restarted\n      ignore_errors: yes # systemd-resolved might not be used on server installs\nEOF\n\n# --- Create dnsmasq.conf.j2 template ---\necho \"Creating dnsmasq.conf.j2 template\"\ncat <<EOF > dnsmasq.conf.j2\n# This file is managed by Ansible. Do not edit manually.\n\n# Do not read /etc/resolv.conf, use the servers below\nno-resolv\n\n# Specify upstream DNS servers for forwarding\nserver={{ dns_forwarder_1 }}\nserver={{ dns_forwarder_2 }}\n\n# Listen on localhost and the VM's primary IP\nlisten-address=127.0.0.1,{{ vm_ip }}\n\n# Allow queries from any interface\ninterface={{ ansible_default_ipv4.interface }} # Listen on the primary network interface\n\n# Bind to the interfaces to prevent dnsmasq from listening on all interfaces\nbind-interfaces\n\n# Cache DNS results\ncache-size=150\nEOF\n\n# --- Create resolv.conf.j2 template ---\necho \"Creating resolv.conf.j2 template\"\ncat <<EOF > resolv.conf.j2\n# This file is managed by Ansible. Do not edit manually.\nnameserver {{ local_dns_ip }}\nsearch {{ search_domain }}\nEOF\n\n# --- Run the Ansible Playbook ---\necho \"Running Ansible playbook to configure DNSmasq...\"\nansible-playbook -i inventory.ini setup-dnsmasq.yml -K\n\n# --- Final Instructions ---\necho \"--------------------------------------------------------\"\necho \"DNSmasq configuration complete on ${VM_IP}.\"\necho \"You can now test the DNS server from the VM or from another machine.\"\necho \"From the VM, run: dig @127.0.0.1 www.cisco.com\"\necho \"From another machine on the same network, configure its DNS to ${VM_IP} and run: dig www.cisco.com\"\necho \"Remember to exit the '${ANSIBLE_DIR}' directory when done (cd ..).\"\n```\n\n执行效果\n\n```bash\nois@ois:~/data/k8s$ ./ansible-dnsmasq.sh \n--- Setting up Ansible environment and configuring DNSmasq on 10.75.59.76 ---\nAnsible is already installed.\nCreating Ansible inventory file: inventory.ini\nCreating Ansible playbook: setup-dnsmasq.yml\nCreating dnsmasq.conf.j2 template\nCreating resolv.conf.j2 template\nRunning Ansible playbook to configure DNSmasq...\nBECOME password: \n\nPLAY [Configure DNSmasq Server on Ubuntu VM] *******************************************************************************************************************************************************************************************************************\n\nTASK [Gathering Facts] *****************************************************************************************************************************************************************************************************************************************\nok: [10.75.59.76]\n\nTASK [Ensure apt cache is updated] *****************************************************************************************************************************************************************************************************************************\nok: [10.75.59.76]\n\nTASK [Install dnsmasq package] *********************************************************************************************************************************************************************************************************************************\nok: [10.75.59.76]\n\nTASK [Stop dnsmasq service before configuration] ***************************************************************************************************************************************************************************************************************\nok: [10.75.59.76]\n\nTASK [Backup original dnsmasq.conf] ****************************************************************************************************************************************************************************************************************************\nchanged: [10.75.59.76]\n\nTASK [Configure dnsmasq for forwarding] ************************************************************************************************************************************************************************************************************************\nchanged: [10.75.59.76]\n\nTASK [Set VM's /etc/resolv.conf to point to itself (local DNS)] ************************************************************************************************************************************************************************************************\nchanged: [10.75.59.76]\n\nRUNNING HANDLER [Restart dnsmasq] ******************************************************************************************************************************************************************************************************************************\nchanged: [10.75.59.76]\n\nRUNNING HANDLER [Restart systemd-resolved] *********************************************************************************************************************************************************************************************************************\nchanged: [10.75.59.76]\n\nPLAY RECAP *****************************************************************************************************************************************************************************************************************************************************\n10.75.59.76                : ok=9    changed=5    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   \n\n--------------------------------------------------------\nDNSmasq configuration complete on 10.75.59.76.\nYou can now test the DNS server from the VM or from another machine.\nFrom the VM, run: dig @127.0.0.1 www.cisco.com\nFrom another machine on the same network, configure its DNS to 10.75.59.76 and run: dig www.cisco.com\nRemember to exit the 'ansible_dnsmasq_setup' directory when done (cd ..).\n```\n\n```bash\nroot@dns-server-vm:~# dig @127.0.0.1 www.cisco.com\n\n; <<>> DiG 9.18.30-0ubuntu0.24.04.2-Ubuntu <<>> @127.0.0.1 www.cisco.com\n; (1 server found)\n;; global options: +cmd\n;; Got answer:\n;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 10545\n;; flags: qr aa rd ra; QUERY: 1, ANSWER: 3, AUTHORITY: 0, ADDITIONAL: 1\n\n;; OPT PSEUDOSECTION:\n; EDNS: version: 0, flags:; udp: 1232\n; COOKIE: ba16202024b9dc8301000000688b40f90daaa0a500a50d2d (good)\n;; QUESTION SECTION:\n;www.cisco.com.                 IN      A\n\n;; ANSWER SECTION:\nwww.cisco.com.          3600    IN      CNAME   origin-www.cisco.com.\norigin-www.cisco.com.   1800    IN      CNAME   origin-www.xgslb-v3.cisco.com.\norigin-www.xgslb-v3.CISCO.com. 10 IN    A       72.163.4.161\n\n;; Query time: 71 msec\n;; SERVER: 127.0.0.1#53(127.0.0.1) (UDP)\n;; WHEN: Thu Jul 31 19:10:01 JST 2025\n;; MSG SIZE  rcvd: 183\n\n```\n\n## 3.3 使用Ansible更新Node 的DNS配置\n\n```bash\n#!/bin/bash\n\n# --- Configuration ---\nANSIBLE_DIR=\"ansible_dns_update\"\nINVENTORY_FILE=\"${ANSIBLE_DIR}/hosts.ini\"\nPLAYBOOK_FILE=\"${ANSIBLE_DIR}/update_dns.yml\"\n\n# Kubernetes Node IPs (ensure these match your actual VM IPs)\nKUBE_NODE_1_IP=\"10.75.59.71\"\nKUBE_NODE_2_IP=\"10.75.59.72\"\nKUBE_NODE_3_IP=\"10.75.59.73\"\n\n# Common Ansible user and Python interpreter\nANSIBLE_USER=\"ubuntu\"\nANSIBLE_PYTHON_INTERPRETER=\"/usr/bin/python3\"\n\n# --- Functions ---\n\n# Function to check and install Ansible\ninstall_ansible() {\n    if ! command -v ansible &> /dev/null\n    then\n        echo \"Ansible not found. Attempting to install Ansible...\"\n        if [ -f /etc/debian_version ]; then\n            # Debian/Ubuntu\n            sudo apt update\n            sudo apt install -y software-properties-common\n            sudo add-apt-repository --yes --update ppa:ansible/ansible\n            sudo apt install -y ansible\n        elif [ -f /etc/redhat-release ]; then\n            # CentOS/RHEL/Fedora\n            sudo yum install -y epel-release\n            sudo yum install -y ansible\n        else\n            echo \"Unsupported OS for automatic Ansible installation. Please install Ansible manually.\"\n            exit 1\n        fi\n        if ! command -v ansible &> /dev/null; then\n            echo \"Ansible installation failed. Please install it manually and re-run this script.\"\n            exit 1\n        fi\n        echo \"Ansible installed successfully.\"\n    else\n        echo \"Ansible is already installed.\"\n    fi\n}\n\n# Function to create Ansible inventory file\ncreate_inventory() {\n    echo \"Creating Ansible inventory file: ${INVENTORY_FILE}\"\n    mkdir -p \"$ANSIBLE_DIR\"\n    cat <<EOF > \"$INVENTORY_FILE\"\n[kubernetes_nodes]\nkube-node-1 ansible_host=${KUBE_NODE_1_IP}\nkube-node-2 ansible_host=${KUBE_NODE_2_IP}\nkube-node-3 ansible_host=${KUBE_NODE_3_IP}\n\n[all:vars]\nansible_user=${ANSIBLE_USER}\nansible_python_interpreter=${ANSIBLE_PYTHON_INTERPRETER}\nEOF\n    echo \"Inventory file created.\"\n}\n\n# Function to create Ansible playbook file\ncreate_playbook() {\n    echo \"Creating Ansible playbook file: ${PLAYBOOK_FILE}\"\n    mkdir -p \"$ANSIBLE_DIR\"\n    cat <<'EOF' > \"$PLAYBOOK_FILE\"\n---\n- name: Update DNS server on Kubernetes nodes to use local DNS only\n  hosts: kubernetes_nodes\n  become: yes # This allows Ansible to run commands with sudo privileges\n\n  tasks:\n    - name: Ensure netplan configuration directory exists\n      ansible.builtin.file:\n        path: /etc/netplan\n        state: directory\n        mode: '0755'\n\n    - name: Get current network configuration file (e.g., 00-installer-config.yaml)\n      ansible.builtin.find:\n        paths: /etc/netplan\n        patterns: '*.yaml'\n        # We assume there's only one primary netplan config file for simplicity.\n        # If there are multiple, you might need to specify which one.\n      register: netplan_files\n\n    - name: Set network config file variable\n      ansible.builtin.set_fact:\n        netplan_config_file: \"{{ netplan_files.files[0].path }}\"\n      when: netplan_files.files | length > 0\n\n    - name: Fail if no netplan config file found\n      ansible.builtin.fail:\n        msg: \"No Netplan configuration file found in /etc/netplan. Cannot proceed.\"\n      when: netplan_files.files | length == 0\n\n    - name: Read current netplan configuration\n      ansible.builtin.slurp:\n        src: \"{{ netplan_config_file }}\"\n      register: current_netplan_config\n\n    - name: Parse current netplan configuration\n      ansible.builtin.set_fact:\n        parsed_netplan: \"{{ current_netplan_config['content'] | b64decode | from_yaml }}\"\n\n    - name: Update nameservers in netplan configuration to local DNS only\n      ansible.builtin.set_fact:\n        updated_netplan: \"{{ parsed_netplan | combine(\n            {\n              'network': {\n                'ethernets': {\n                  'enp1s0': {\n                    'nameservers': {\n                      'addresses': ['10.75.59.76'],\n                      'search': ['cisco.com']\n                    }\n                  }\n                }\n              }\n            }, recursive=True) }}\"\n\n    - name: Write updated netplan configuration\n      ansible.builtin.copy:\n        content: \"{{ updated_netplan | to_yaml }}\"\n        dest: \"{{ netplan_config_file }}\"\n        mode: '0600'\n      notify: Apply Netplan Configuration\n\n  handlers:\n    - name: Apply Netplan Configuration\n      ansible.builtin.command: netplan apply\n      listen: \"Apply Netplan Configuration\"\nEOF\n    echo \"Playbook file created.\"\n}\n\n# --- Main Script Execution ---\n\necho \"Starting Ansible DNS update process...\"\n\n# 1. Install Ansible if not present\ninstall_ansible\n\n# 2. Create Ansible inventory file\ncreate_inventory\n\n# 3. Create Ansible playbook file\ncreate_playbook\n\n# 4. Run the Ansible playbook\necho \"Running Ansible playbook to update DNS on Kubernetes nodes...\"\necho \"You will be prompted for the 'sudo' password for the 'ubuntu' user on your VMs.\"\nansible-playbook -i \"$INVENTORY_FILE\" \"$PLAYBOOK_FILE\" --ask-become-pass\n\nif [ $? -eq 0 ]; then\n    echo \"Ansible playbook executed successfully.\"\n    echo \"Your Kubernetes nodes should now be configured to use 10.75.59.76 as their only DNS server.\"\nelse\n    echo \"Ansible playbook failed. Please check the output for errors.\"\nfi\n\necho \"Process complete.\"\n```\n\n```bash\nois@ois:~/data/k8s$ ./updatedns.sh \nStarting Ansible DNS update process...\nAnsible is already installed.\nCreating Ansible inventory file: ansible_dns_update/hosts.ini\nInventory file created.\nCreating Ansible playbook file: ansible_dns_update/update_dns.yml\nPlaybook file created.\nRunning Ansible playbook to update DNS on Kubernetes nodes...\nYou will be prompted for the 'sudo' password for the 'ubuntu' user on your VMs.\nBECOME password: \n\nPLAY [Update DNS server on Kubernetes nodes to use local DNS only] *********************************************************************************************************************************************************************************************\n\nTASK [Gathering Facts] *****************************************************************************************************************************************************************************************************************************************\nok: [kube-node-1]\nok: [kube-node-2]\nok: [kube-node-3]\n\nTASK [Ensure netplan configuration directory exists] ***********************************************************************************************************************************************************************************************************\nok: [kube-node-3]\nok: [kube-node-2]\nok: [kube-node-1]\n\nTASK [Get current network configuration file (e.g., 00-installer-config.yaml)] *********************************************************************************************************************************************************************************\nok: [kube-node-3]\nok: [kube-node-1]\nok: [kube-node-2]\n\nTASK [Set network config file variable] ************************************************************************************************************************************************************************************************************************\nok: [kube-node-1]\nok: [kube-node-2]\nok: [kube-node-3]\n\nTASK [Fail if no netplan config file found] ********************************************************************************************************************************************************************************************************************\nskipping: [kube-node-1]\nskipping: [kube-node-2]\nskipping: [kube-node-3]\n\nTASK [Read current netplan configuration] **********************************************************************************************************************************************************************************************************************\nok: [kube-node-3]\nok: [kube-node-1]\nok: [kube-node-2]\n\nTASK [Parse current netplan configuration] *********************************************************************************************************************************************************************************************************************\nok: [kube-node-1]\nok: [kube-node-2]\nok: [kube-node-3]\n\nTASK [Update nameservers in netplan configuration to local DNS only] *******************************************************************************************************************************************************************************************\nok: [kube-node-1]\nok: [kube-node-2]\nok: [kube-node-3]\n\nTASK [Write updated netplan configuration] *********************************************************************************************************************************************************************************************************************\nok: [kube-node-3]\nok: [kube-node-1]\nok: [kube-node-2]\n\nPLAY RECAP *****************************************************************************************************************************************************************************************************************************************************\nkube-node-1                : ok=8    changed=0    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   \nkube-node-2                : ok=8    changed=0    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   \nkube-node-3                : ok=8    changed=0    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   \n\nAnsible playbook executed successfully.\nYour Kubernetes nodes should now be configured to use 10.75.59.76 as their only DNS server.\nProcess complete.\n\nroot@kube-node-1:~# cat /etc/resolv.conf \n# This is /run/systemd/resolve/stub-resolv.conf managed by man:systemd-resolved(8).\n# Do not edit.\n#\n# This file might be symlinked as /etc/resolv.conf. If you're looking at\n# /etc/resolv.conf and seeing this text, you have followed the symlink.\n#\n# This is a dynamic resolv.conf file for connecting local clients to the\n# internal DNS stub resolver of systemd-resolved. This file lists all\n# configured search domains.\n#\n# Run \"resolvectl status\" to see details about the uplink DNS servers\n# currently in use.\n#\n# Third party programs should typically not access this file directly, but only\n# through the symlink at /etc/resolv.conf. To manage man:resolv.conf(5) in a\n# different way, replace this symlink by a static file or a different symlink.\n#\n# See man:systemd-resolved.service(8) for details about the supported modes of\n# operation for /etc/resolv.conf.\n\nnameserver 127.0.0.53\noptions edns0 trust-ad\nsearch cisco.com\nroot@kube-node-1:~# cat /etc/netplan/50-cloud-init.yaml \nnetwork:\n  ethernets:\n    enp1s0:\n      addresses: [10.75.59.71/24]\n      nameservers:\n        addresses: [10.75.59.76]\n        search: [cisco.com]\n      routes:\n      - {to: default, via: 10.75.59.1}\n  version: 2\n```\n\n## 3.4 使用Ansible配置FRR BGP\n\n```bash\n#!/bin/bash\n\n# This script automates the setup of an Ansible environment for installing and configuring FRRouting (FRR).\n# It creates the project directory, inventory, configuration, and the playbook\n# with an idempotent role to install and configure FRR.\n\n# --- Configuration ---\nPROJECT_DIR=\"ansible-frr-setup\" # Changed project directory name\nFRR_NODE_IP=\"10.75.59.76\" # IP address of your FRR VM (frr-server-vm)\nANSIBLE_USER=\"ubuntu\" # The user created by cloud-init on your VMs\nSSH_PRIVATE_KEY_PATH=\"~/.ssh/id_rsa\" # Path to your SSH private key on the Ansible control machine\n\n# FRR specific configuration\nFRR_AS=65000 # The Autonomous System number for this FRR node (example AS, choose your own)\nK8S_MASTER_IP=\"10.75.59.71\" # From your create-vms.sh script\nK8S_WORKER_1_IP=\"10.75.59.72\" # From your create-vms.sh script\nK8S_WORKER_2_IP=\"10.75.59.73\" # From your create-vms.sh script\nCILIUM_BGP_AS=65000 # AS for Cilium as per your CiliumBGPClusterConfig\n\n# --- Functions ---\n\n# Function to install Ansible (if not already installed)\ninstall_ansible() {\n    echo \"--- Installing Ansible ---\"\n    if ! command -v ansible &> /dev/null; then\n        sudo apt update -y\n        sudo apt install -y ansible\n        echo \"Ansible installed successfully.\"\n    else\n        echo \"Ansible is already installed.\"\n    fi\n}\n\n# Function to create project directory and navigate into it\ncreate_project_dir() {\n    echo \"--- Creating project directory: ${PROJECT_DIR} ---\"\n    # Check if directory exists, if so, just navigate, otherwise create and navigate\n    if [ ! -d \"${PROJECT_DIR}\" ]; then\n        mkdir -p \"${PROJECT_DIR}\"\n        echo \"Created new directory: ${PROJECT_DIR}\"\n    else\n        echo \"Directory ${PROJECT_DIR} already exists.\"\n    fi\n    cd \"${PROJECT_DIR}\" || { echo \"Failed to change directory to ${PROJECT_DIR}. Exiting.\"; exit 1; }\n    echo \"Changed to directory: $(pwd)\"\n}\n\n# Function to create ansible.cfg\ncreate_ansible_cfg() {\n    echo \"--- Creating ansible.cfg ---\"\n    cat <<EOF > ansible.cfg\n[defaults]\ninventory = inventory.ini\nroles_path = ./roles\nhost_key_checking = False # WARNING: Disable host key checking for convenience. Re-enable for production!\nEOF\n    echo \"ansible.cfg created.\"\n}\n\n# Function to create inventory.ini\ncreate_inventory() {\n    echo \"--- Creating inventory.ini ---\"\n    cat <<EOF > inventory.ini\n[frr_nodes]\nfrr-node-1 ansible_host=${FRR_NODE_IP}\n\n[all:vars]\nansible_user=${ANSIBLE_USER}\nansible_ssh_private_key_file=${SSH_PRIVATE_KEY_PATH}\nansible_python_interpreter=/usr/bin/python3\nFRR_AS=${FRR_AS}\nK8S_MASTER_IP=${K8S_MASTER_IP}\nK8S_WORKER_1_IP=${K8S_WORKER_1_IP}\nK8S_WORKER_2_IP=${K8S_WORKER_2_IP}\nCILIUM_BGP_AS=${CILIUM_BGP_AS}\nEOF\n    echo \"inventory.ini created.\"\n}\n\n# Function to create the main playbook.yml\ncreate_playbook() {\n    echo \"--- Creating playbook.yml ---\"\n    cat <<EOF > playbook.yml\n---\n- name: Install and Configure FRRouting (FRR)\n  hosts: frr_nodes\n  become: yes\n  roles:\n    - frr_setup # Changed role name to frr_setup\nEOF\n    echo \"playbook.yml created.\"\n}\n\n# Function to create the FRR installation and configuration role\ncreate_frr_role() { # Changed function name from create_gobgp_role\n    echo \"--- Creating Ansible role for FRR setup ---\"\n    mkdir -p roles/frr_setup/tasks\n    cat <<EOF > roles/frr_setup/tasks/main.yml\n---\n- name: Install FRRouting (FRR)\n  ansible.builtin.apt:\n    name: frr\n    state: present\n    update_cache: yes\n\n- name: Configure FRR daemons (enable zebra and bgpd)\n  ansible.builtin.lineinfile:\n    path: /etc/frr/daemons\n    regexp: '^(zebra|bgpd)='\n    line: '\\1=yes'\n    state: present\n    backrefs: yes # Required to make regexp work for replacement\n  notify: Restart FRR service\n\n- name: Configure frr.conf\n  ansible.builtin.copy:\n    dest: /etc/frr/frr.conf\n    content: |\n      !\n      hostname {{ ansible_hostname }}\n      password zebra\n      enable password zebra\n      !\n      log syslog informational\n      !\n      router bgp {{ FRR_AS }}\n       bgp router-id {{ ansible_host }}\n       !\n       neighbor {{ K8S_MASTER_IP }} remote-as {{ CILIUM_BGP_AS }}\n       neighbor {{ K8S_WORKER_1_IP }} remote-as {{ CILIUM_BGP_AS }}\n       neighbor {{ K8S_WORKER_2_IP }} remote-as {{ CILIUM_BGP_AS }}\n       !\n       address-family ipv4 unicast\n        # Crucial: Redistribute BGP learned routes into the kernel\n        redistribute connected\n        redistribute static\n        redistribute kernel\n       exit-address-family\n      !\n      line vty\n      !\n    mode: '0644'\n  notify: Restart FRR service # Handler only runs if file content changes\n\n- name: Set permissions for frr.conf\n  ansible.builtin.file:\n    path: /etc/frr/frr.conf\n    owner: frr\n    group: frr\n    mode: '0640'\n\n- name: Enable and start FRR service\n  ansible.builtin.systemd:\n    name: frr\n    state: started\n    enabled: yes\n    daemon_reload: yes # Ensure systemd reloads unit files if service file changed\n\nEOF\n\n    mkdir -p roles/frr_setup/handlers\n    cat <<EOF > roles/frr_setup/handlers/main.yml\n---\n- name: Restart FRR service\n  ansible.builtin.systemd:\n    name: frr\n    state: restarted\nEOF\n    echo \"FRR Ansible role created.\"\n}\n\n# --- Main execution ---\ninstall_ansible\ncreate_project_dir\ncreate_ansible_cfg\ncreate_inventory\ncreate_playbook\ncreate_frr_role # Changed function call\n\necho \"\"\necho \"--- Ansible setup for FRR installation is complete! ---\"\necho \"Navigate to the new project directory:\"\necho \"cd ${PROJECT_DIR}\"\necho \"\"\necho \"Then, run the Ansible playbook to install and configure FRR on your VM:\"\necho \"ansible-playbook playbook.yml -K\"\necho \"\"\necho \"After the playbook finishes, FRR should be running and configured on ${FRR_NODE_IP}.\"\necho \"You can SSH into the VM and verify with 'sudo vtysh -c \\\"show ip bgp summary\\\"' and 'sudo ip route show'.\"\n\nois@ois:~/data/k8s$ ./ansible-frr.sh \n--- Installing Ansible ---\nAnsible is already installed.\n--- Creating project directory: ansible-frr-setup ---\nCreated new directory: ansible-frr-setup\nChanged to directory: /home/ois/data/k8s/ansible-frr-setup\n--- Creating ansible.cfg ---\nansible.cfg created.\n--- Creating inventory.ini ---\ninventory.ini created.\n--- Creating playbook.yml ---\nplaybook.yml created.\n--- Creating Ansible role for FRR setup ---\nFRR Ansible role created.\n\n--- Ansible setup for FRR installation is complete! ---\nNavigate to the new project directory:\ncd ansible-frr-setup\n\nThen, run the Ansible playbook to install and configure FRR on your VM:\nansible-playbook playbook.yml -K\n\nAfter the playbook finishes, FRR should be running and configured on 10.75.59.76.\nYou can SSH into the VM and verify with 'sudo vtysh -c \"show ip bgp summary\"' and 'sudo ip route show'.\nois@ois:~/data/k8s$ cd ansible-frr-setup/\nois@ois:~/data/k8s/ansible-frr-setup$ ansible-playbook playbook.yml -K\nBECOME password: \n\nPLAY [Install and Configure FRRouting (FRR)] *******************************************************************************************************************************************************************************************************************\n\nTASK [Gathering Facts] *****************************************************************************************************************************************************************************************************************************************\nok: [frr-node-1]\n\nTASK [frr_setup : Install FRRouting (FRR)] *********************************************************************************************************************************************************************************************************************\nchanged: [frr-node-1]\n\nTASK [frr_setup : Configure FRR daemons (enable zebra and bgpd)] ***********************************************************************************************************************************************************************************************\nchanged: [frr-node-1]\n\nTASK [frr_setup : Configure frr.conf] **************************************************************************************************************************************************************************************************************************\nchanged: [frr-node-1]\n\nTASK [frr_setup : Set permissions for frr.conf] ****************************************************************************************************************************************************************************************************************\nchanged: [frr-node-1]\n\nTASK [frr_setup : Enable and start FRR service] ****************************************************************************************************************************************************************************************************************\nok: [frr-node-1]\n\nRUNNING HANDLER [frr_setup : Restart FRR service] **************************************************************************************************************************************************************************************************************\nchanged: [frr-node-1]\n\nPLAY RECAP *****************************************************************************************************************************************************************************************************************************************************\nfrr-node-1                 : ok=7    changed=5    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   \n\n```\n\n```bash\nroot@dns-server-vm:~# cat /etc/frr/frr.conf \n!\nhostname dns-server-vm\npassword zebra\nenable password zebra\n!\nlog syslog informational\n!\nrouter bgp 65000\n bgp router-id 10.75.59.76\n !\n neighbor 10.75.59.71 remote-as 65000\n neighbor 10.75.59.72 remote-as 65000\n neighbor 10.75.59.73 remote-as 65000\n !\n address-family ipv4 unicast\n  # Crucial: Redistribute BGP learned routes into the kernel\n  redistribute connected\n  redistribute static\n  redistribute kernel\n exit-address-family\n!\nline vty\n!\nroot@dns-server-vm:~# systemctl status frr\n* frr.service - FRRouting\n     Loaded: loaded (/usr/lib/systemd/system/frr.service; enabled; preset: enabled)\n     Active: active (running) since Wed 2025-07-23 12:16:58 JST; 1 week 1 day ago\n       Docs: https://frrouting.readthedocs.io/en/latest/setup.html\n    Process: 15611 ExecStart=/usr/lib/frr/frrinit.sh start (code=exited, status=0/SUCCESS)\n   Main PID: 15623 (watchfrr)\n     Status: \"FRR Operational\"\n      Tasks: 13 (limit: 9486)\n     Memory: 21.1M (peak: 28.3M)\n        CPU: 5min 23.845s\n     CGroup: /system.slice/frr.service\n             |-15623 /usr/lib/frr/watchfrr -d -F traditional zebra bgpd staticd\n             |-15636 /usr/lib/frr/zebra -d -F traditional -A 127.0.0.1 -s 90000000\n             |-15641 /usr/lib/frr/bgpd -d -F traditional -A 127.0.0.1\n             `-15648 /usr/lib/frr/staticd -d -F traditional -A 127.0.0.1\n\nJul 31 16:26:25 dns-server-vm bgpd[15641]: [M59KS-A3ZXZ] bgp_update_receive: rcvd End-of-RIB for IPv4 Unicast from 10.75.59.71 in vrf default\nJul 31 16:27:24 dns-server-vm bgpd[15641]: [M59KS-A3ZXZ] bgp_update_receive: rcvd End-of-RIB for IPv4 Unicast from 10.75.59.73 in vrf default\nJul 31 16:27:24 dns-server-vm bgpd[15641]: [M59KS-A3ZXZ] bgp_update_receive: rcvd End-of-RIB for IPv4 Unicast from 10.75.59.72 in vrf default\nJul 31 16:27:24 dns-server-vm bgpd[15641]: [M59KS-A3ZXZ] bgp_update_receive: rcvd End-of-RIB for IPv4 Unicast from 10.75.59.71 in vrf default\nJul 31 16:46:48 dns-server-vm bgpd[15641]: [M59KS-A3ZXZ] bgp_update_receive: rcvd End-of-RIB for IPv4 Unicast from 10.75.59.72 in vrf default\nJul 31 16:46:48 dns-server-vm bgpd[15641]: [M59KS-A3ZXZ] bgp_update_receive: rcvd End-of-RIB for IPv4 Unicast from 10.75.59.73 in vrf default\nJul 31 16:46:48 dns-server-vm bgpd[15641]: [M59KS-A3ZXZ] bgp_update_receive: rcvd End-of-RIB for IPv4 Unicast from 10.75.59.71 in vrf default\nJul 31 16:47:54 dns-server-vm bgpd[15641]: [M59KS-A3ZXZ] bgp_update_receive: rcvd End-of-RIB for IPv4 Unicast from 10.75.59.73 in vrf default\nJul 31 16:47:54 dns-server-vm bgpd[15641]: [M59KS-A3ZXZ] bgp_update_receive: rcvd End-of-RIB for IPv4 Unicast from 10.75.59.72 in vrf default\nJul 31 16:47:54 dns-server-vm bgpd[15641]: [M59KS-A3ZXZ] bgp_update_receive: rcvd End-of-RIB for IPv4 Unicast from 10.75.59.71 in vrf default\nroot@dns-server-vm:~# ip route show\ndefault via 10.75.59.1 dev enp1s0 proto static \n10.75.59.0/24 dev enp1s0 proto kernel scope link src 10.75.59.76 \n172.16.0.0/24 nhid 95 via 10.75.59.71 dev enp1s0 proto bgp metric 20 \n172.16.1.0/24 nhid 90 via 10.75.59.72 dev enp1s0 proto bgp metric 20 \n172.16.2.0/24 nhid 100 via 10.75.59.73 dev enp1s0 proto bgp metric 20 \n172.16.16.1 nhid 202 proto bgp metric 20 \n        nexthop via 10.75.59.72 dev enp1s0 weight 1 \n        nexthop via 10.75.59.71 dev enp1s0 weight 1 \n        nexthop via 10.75.59.73 dev enp1s0 weight 1 \n172.16.16.10 nhid 202 proto bgp metric 20 \n        nexthop via 10.75.59.72 dev enp1s0 weight 1 \n        nexthop via 10.75.59.71 dev enp1s0 weight 1 \n        nexthop via 10.75.59.73 dev enp1s0 weight 1 \n172.16.20.119 nhid 202 proto bgp metric 20 \n        nexthop via 10.75.59.72 dev enp1s0 weight 1 \n        nexthop via 10.75.59.71 dev enp1s0 weight 1 \n        nexthop via 10.75.59.73 dev enp1s0 weight 1 \n172.16.22.26 nhid 202 proto bgp metric 20 \n        nexthop via 10.75.59.72 dev enp1s0 weight 1 \n        nexthop via 10.75.59.71 dev enp1s0 weight 1 \n        nexthop via 10.75.59.73 dev enp1s0 weight 1 \n172.16.23.18 nhid 202 proto bgp metric 20 \n        nexthop via 10.75.59.72 dev enp1s0 weight 1 \n        nexthop via 10.75.59.71 dev enp1s0 weight 1 \n        nexthop via 10.75.59.73 dev enp1s0 weight 1 \n172.16.30.170 nhid 202 proto bgp metric 20 \n        nexthop via 10.75.59.72 dev enp1s0 weight 1 \n        nexthop via 10.75.59.71 dev enp1s0 weight 1 \n        nexthop via 10.75.59.73 dev enp1s0 weight 1 \nroot@dns-server-vm:~# vtysh -c 'show ip bgp summary'\n\nIPv4 Unicast Summary (VRF default):\nBGP router identifier 10.75.59.76, local AS number 65000 vrf-id 0\nBGP table version 222\nRIB entries 19, using 3648 bytes of memory\nPeers 3, using 2172 KiB of memory\n\nNeighbor        V         AS   MsgRcvd   MsgSent   TblVer  InQ OutQ  Up/Down State/PfxRcd   PfxSnt Desc\n10.75.59.71     4      65000     71265     71182        0    0    0 03:21:08            7        2 N/A\n10.75.59.72     4      65000     71344     71264        0    0    0 03:21:09            7        2 N/A\n10.75.59.73     4      65000     71240     71162        0    0    0 03:21:09            7        2 N/A\n\nTotal number of neighbors 3\n```\n\n# 4. 设置Kubernetes集群并安装CNI Cilium\n\n## 4.1 使用kubeadm设置Kubernetes\n\n使用以下命令进行集群初始化\n\n```bash\nkubeadm config images pull\n\nkubeadm init --control-plane-endpoint=kube-node-1 --pod-network-cidr=172.16.0.0/20 --service-cidr=172.16.32.0/20 --skip-phases=addon/kube-proxy\n\n--skip-phases=addon/kube-proxy 表示不安装kube-proxy，会用Cilium进行替代\n```\n\n```bash\nubuntu@kube-node-1:~$ sudo kubeadm init --control-plane-endpoint=kube-node-1 --pod-network-cidr=172.16.0.0/20 --service-cidr=172.16.32.0/20 --skip-phases=addon/kube-proxy[sudo] password for ubuntu: \n[init] Using Kubernetes version: v1.33.3\n[preflight] Running pre-flight checks\n[preflight] Pulling images required for setting up a Kubernetes cluster\n[preflight] This might take a minute or two, depending on the speed of your internet connection\n[preflight] You can also perform this action beforehand using 'kubeadm config images pull'\n[certs] Using certificateDir folder \"/etc/kubernetes/pki\"\n[certs] Generating \"ca\" certificate and key\n[certs] Generating \"apiserver\" certificate and key\n[certs] apiserver serving cert is signed for DNS names [kube-node-1 kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local] and IPs [10.248.0.1 10.75.59.71]\n[certs] Generating \"apiserver-kubelet-client\" certificate and key\n[certs] Generating \"front-proxy-ca\" certificate and key\n[certs] Generating \"front-proxy-client\" certificate and key\n[certs] Generating \"etcd/ca\" certificate and key\n[certs] Generating \"etcd/server\" certificate and key\n[certs] etcd/server serving cert is signed for DNS names [kube-node-1 localhost] and IPs [10.75.59.71 127.0.0.1 ::1]\n[certs] Generating \"etcd/peer\" certificate and key\n[certs] etcd/peer serving cert is signed for DNS names [kube-node-1 localhost] and IPs [10.75.59.71 127.0.0.1 ::1]\n[certs] Generating \"etcd/healthcheck-client\" certificate and key\n[certs] Generating \"apiserver-etcd-client\" certificate and key\n[certs] Generating \"sa\" key and public key\n[kubeconfig] Using kubeconfig folder \"/etc/kubernetes\"\n[kubeconfig] Writing \"admin.conf\" kubeconfig file\n[kubeconfig] Writing \"super-admin.conf\" kubeconfig file\n[kubeconfig] Writing \"kubelet.conf\" kubeconfig file\n[kubeconfig] Writing \"controller-manager.conf\" kubeconfig file\n[kubeconfig] Writing \"scheduler.conf\" kubeconfig file\n[etcd] Creating static Pod manifest for local etcd in \"/etc/kubernetes/manifests\"\n[control-plane] Using manifest folder \"/etc/kubernetes/manifests\"\n[control-plane] Creating static Pod manifest for \"kube-apiserver\"\n[control-plane] Creating static Pod manifest for \"kube-controller-manager\"\n[control-plane] Creating static Pod manifest for \"kube-scheduler\"\n[kubelet-start] Writing kubelet environment file with flags to file \"/var/lib/kubelet/kubeadm-flags.env\"\n[kubelet-start] Writing kubelet configuration to file \"/var/lib/kubelet/config.yaml\"\n[kubelet-start] Starting the kubelet\n[wait-control-plane] Waiting for the kubelet to boot up the control plane as static Pods from directory \"/etc/kubernetes/manifests\"\n[kubelet-check] Waiting for a healthy kubelet at http://127.0.0.1:10248/healthz. This can take up to 4m0s\n[kubelet-check] The kubelet is healthy after 1.002649961s\n[control-plane-check] Waiting for healthy control plane components. This can take up to 4m0s\n[control-plane-check] Checking kube-apiserver at https://10.75.59.71:6443/livez\n[control-plane-check] Checking kube-controller-manager at https://127.0.0.1:10257/healthz\n[control-plane-check] Checking kube-scheduler at https://127.0.0.1:10259/livez\n[control-plane-check] kube-controller-manager is healthy after 1.813351787s\n[control-plane-check] kube-scheduler is healthy after 3.309147352s\n[control-plane-check] kube-apiserver is healthy after 5.505049123s\n[upload-config] Storing the configuration used in ConfigMap \"kubeadm-config\" in the \"kube-system\" Namespace\n[kubelet] Creating a ConfigMap \"kubelet-config\" in namespace kube-system with the configuration for the kubelets in the cluster\n[upload-certs] Skipping phase. Please see --upload-certs\n[mark-control-plane] Marking the node kube-node-1 as control-plane by adding the labels: [node-role.kubernetes.io/control-plane node.kubernetes.io/exclude-from-external-load-balancers]\n[mark-control-plane] Marking the node kube-node-1 as control-plane by adding the taints [node-role.kubernetes.io/control-plane:NoSchedule]\n[bootstrap-token] Using token: 1r5ugd.o2pjzipcq69z71l8\n[bootstrap-token] Configuring bootstrap tokens, cluster-info ConfigMap, RBAC Roles\n[bootstrap-token] Configured RBAC rules to allow Node Bootstrap tokens to get nodes\n[bootstrap-token] Configured RBAC rules to allow Node Bootstrap tokens to post CSRs in order for nodes to get long term certificate credentials\n[bootstrap-token] Configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token\n[bootstrap-token] Configured RBAC rules to allow certificate rotation for all node client certificates in the cluster\n[bootstrap-token] Creating the \"cluster-info\" ConfigMap in the \"kube-public\" namespace\n[kubelet-finalize] Updating \"/etc/kubernetes/kubelet.conf\" to point to a rotatable kubelet client certificate and key\n[addons] Applied essential addon: CoreDNS\n\nYour Kubernetes control-plane has initialized successfully!\n\nTo start using your cluster, you need to run the following as a regular user:\n\n  mkdir -p $HOME/.kube\n  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config\n  sudo chown $(id -u):$(id -g) $HOME/.kube/config\n\nAlternatively, if you are the root user, you can run:\n\n  export KUBECONFIG=/etc/kubernetes/admin.conf\n\nYou should now deploy a pod network to the cluster.\nRun \"kubectl apply -f [podnetwork].yaml\" with one of the options listed at:\n  https://kubernetes.io/docs/concepts/cluster-administration/addons/\n\nYou can now join any number of control-plane nodes by copying certificate authorities\nand service account keys on each node and then running the following as root:\n\n  kubeadm join kube-node-1:6443 --token 1r5ugd.o2pjzipcq69z71l8 \\\n        --discovery-token-ca-cert-hash sha256:e29fb62581a4d21268585c3b345f9e060827c52a8325b1d28b8437c792ba7923 \\\n        --control-plane \n\nThen you can join any number of worker nodes by running the following on each as root:\n\nkubeadm join kube-node-1:6443 --token 1r5ugd.o2pjzipcq69z71l8 \\\n        --discovery-token-ca-cert-hash sha256:e29fb62581a4d21268585c3b345f9e060827c52a8325b1d28b8437c792ba7923 \nubuntu@kube-node-1:~$ \nubuntu@kube-node-1:~$   mkdir -p $HOME/.kube\n  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config\n  sudo chown $(id -u):$(id -g) $HOME/.kube/config\nubuntu@kube-node-1:~$ sudo su\nroot@kube-node-1:/home/ubuntu# cd\n\n在.bashrc 中增加以下内容\nroot@kube-node-1:~# cat .bashrc | grep export\nexport KUBECONFIG=/etc/kubernetes/admin.conf\n\n这样root才能执行 kubectl 命令与 api-server通信.\n\nroot@kube-node-1:~# kubectl cluster-info\nKubernetes control plane is running at https://kube-node-1:6443\nCoreDNS is running at https://kube-node-1:6443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy\n\nTo further debug and diagnose cluster problems, use 'kubectl cluster-info dump'.\nroot@kube-node-1:~# kubectl get node -o wide\nNAME          STATUS     ROLES           AGE   VERSION   INTERNAL-IP   EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION     CONTAINER-RUNTIME\nkube-node-1   NotReady   control-plane   68s   v1.33.3   10.75.59.71   <none>        Ubuntu 24.04.2 LTS   6.8.0-63-generic   containerd://1.7.27\n\n还没有安装CNI，Node NotReady\n\n```\n\n## 4.2 使用Ansible安装Helm\n\n设置Helm的目的是为了安装Cilium，并非一定要使用Ansible来进行设置，供参考。\n\n```bash\n#!/bin/bash\n\n# This script automates the setup of an Ansible environment for installing Helm.\n# It creates the project directory, inventory, configuration, and the playbook\n# with an idempotent role to install Helm.\n\n# --- Configuration ---\nPROJECT_DIR=\"ansible-helm\"\nMASTER_NODE_IP=\"10.75.59.71\" # IP address of your Kubernetes master node (kube-node-1)\nANSIBLE_USER=\"ubuntu\" # The user created by cloud-init on your VMs\nSSH_PRIVATE_KEY_PATH=\"~/.ssh/id_rsa\" # Path to your SSH private key on the Ansible control machine\n\n# Helm version to install\nHELM_VERSION=\"v3.18.4\" # You can change this to a desired stable version\n\n# --- Functions ---\n\n# Function to create project directory and navigate into it\ncreate_project_dir() {\n    echo \"--- Creating project directory: ${PROJECT_DIR} ---\"\n    # Check if directory exists, if so, just navigate, otherwise create and navigate\n    if [ ! -d \"${PROJECT_DIR}\" ]; then\n        mkdir -p \"${PROJECT_DIR}\"\n        echo \"Created new directory: ${PROJECT_DIR}\"\n    else\n        echo \"Directory ${PROJECT_DIR} already exists.\"\n    fi\n    cd \"${PROJECT_DIR}\" || { echo \"Failed to change directory to ${PROJECT_DIR}. Exiting.\"; exit 1; }\n    echo \"Changed to directory: $(pwd)\"\n}\n\n# Function to create ansible.cfg\ncreate_ansible_cfg() {\n    echo \"--- Creating ansible.cfg ---\"\n    cat <<EOF > ansible.cfg\n[defaults]\ninventory = inventory.ini\nroles_path = ./roles\nhost_key_checking = False # WARNING: Disable host key checking for convenience. Re-enable for production!\nEOF\n    echo \"ansible.cfg created.\"\n}\n\n# Function to create inventory.ini\ncreate_inventory() {\n    echo \"--- Creating inventory.ini ---\"\n    cat <<EOF > inventory.ini\n[kubernetes_master]\nkube-node-1 ansible_host=${MASTER_NODE_IP}\n\n[all:vars]\nansible_user=${ANSIBLE_USER}\nansible_ssh_private_key_file=${SSH_PRIVATE_KEY_PATH}\nansible_python_interpreter=/usr/bin/python3\nHELM_VERSION=${HELM_VERSION}\nEOF\n    echo \"inventory.ini created.\"\n}\n\n# Function to create the main playbook.yml\ncreate_playbook() {\n    echo \"--- Creating playbook.yml ---\"\n    cat <<EOF > playbook.yml\n---\n- name: Install Helm on Kubernetes Master Node\n  hosts: kubernetes_master\n  become: yes\n  environment: # Ensure KUBECONFIG is set for helm commands run with become\n    KUBECONFIG: /etc/kubernetes/admin.conf # Use the admin kubeconfig on the master\n  roles:\n    - helm_install\nEOF\n    echo \"playbook.yml created.\"\n}\n\n# Function to create the Helm installation role (with idempotent check)\ncreate_helm_role() {\n    echo \"--- Creating Ansible role for Helm installation ---\"\n    mkdir -p roles/helm_install/tasks\n    cat <<EOF > roles/helm_install/tasks/main.yml\n---\n- name: Check if Helm is installed and get version\n  ansible.builtin.command: helm version --short\n  register: helm_version_raw\n  ignore_errors: yes\n  changed_when: false\n\n- name: Set installed Helm version fact\n  ansible.builtin.set_fact:\n    installed_helm_version: \"{{ (helm_version_raw.stdout | default('') | regex_findall('^(v[0-9]+\\\\\\\\.[0-9]+\\\\\\\\.[0-9]+)') | first | default('') | trim) }}\"\n  changed_when: false\n\n- name: Debug installed Helm version\n  ansible.builtin.debug:\n    msg: \"Current installed Helm version: {{ installed_helm_version | default('Not installed') }}\"\n\n- name: Debug raw Helm version output\n  ansible.builtin.debug:\n    msg: \"Raw Helm version output: {{ helm_version_raw.stdout | default('No output') }}\"\n  when: helm_version_raw.stdout is defined and helm_version_raw.stdout | length > 0\n\n- name: Check if Helm binary exists\n  ansible.builtin.stat:\n    path: /usr/local/bin/helm\n  register: helm_binary_stat\n  when: installed_helm_version == HELM_VERSION\n\n- name: Download Helm tarball\n  ansible.builtin.get_url:\n    url: \"https://get.helm.sh/helm-{{ HELM_VERSION }}-linux-amd64.tar.gz\"\n    dest: \"/tmp/helm-{{ HELM_VERSION }}-linux-amd64.tar.gz\"\n    mode: '0644'\n    checksum: \"sha256:{{ lookup('url', 'https://get.helm.sh/helm-{{ HELM_VERSION }}-linux-amd64.tar.gz.sha256sum', wantlist=True)[0].split(' ')[0] }}\"\n  register: download_helm_result\n  until: download_helm_result is success\n  retries: 5\n  delay: 5\n  when: installed_helm_version != HELM_VERSION or not helm_binary_stat.stat.exists\n\n- name: Create Helm installation directory\n  ansible.builtin.file:\n    path: /usr/local/bin\n    state: directory\n    mode: '0755'\n  when: installed_helm_version != HELM_VERSION or not helm_binary_stat.stat.exists\n\n- name: Extract Helm binary\n  ansible.builtin.unarchive:\n    src: \"/tmp/helm-{{ HELM_VERSION }}-linux-amd64.tar.gz\"\n    dest: \"/tmp\"\n    remote_src: yes\n    creates: \"/tmp/linux-amd64/helm\"\n  when: installed_helm_version != HELM_VERSION or not helm_binary_stat.stat.exists\n\n- name: Move Helm binary to /usr/local/bin\n  ansible.builtin.copy:\n    src: \"/tmp/linux-amd64/helm\"\n    dest: \"/usr/local/bin/helm\"\n    mode: '0755'\n    remote_src: yes\n    owner: root\n    group: root\n  when: installed_helm_version != HELM_VERSION or not helm_binary_stat.stat.exists\n\n- name: Clean up Helm tarball and extracted directory\n  ansible.builtin.file:\n    path: \"{{ item }}\"\n    state: absent\n  loop:\n    - \"/tmp/helm-{{ HELM_VERSION }}-linux-amd64.tar.gz\"\n    - \"/tmp/linux-amd64\"\n  when: installed_helm_version != HELM_VERSION or not helm_binary_stat.stat.exists\n\n- name: Verify Helm installation\n  ansible.builtin.command: helm version --client\n  register: helm_version_output\n  changed_when: false\n\n- name: Display Helm version\n  ansible.builtin.debug:\n    msg: \"{{ helm_version_output.stdout }}\"\nEOF\n    echo \"Helm installation role created.\"\n}\n\n# --- Main execution ---\ncreate_project_dir\ncreate_ansible_cfg\ncreate_inventory\ncreate_playbook\ncreate_helm_role\n\necho \"\"\necho \"--- Ansible setup for Helm installation is complete! ---\"\necho \"Navigate to the new project directory:\"\necho \"cd ${PROJECT_DIR}\"\necho \"\"\necho \"Then, run the Ansible playbook to install only Helm on your master node:\"\necho \"ansible-playbook playbook.yml -K\"\necho \"\"\necho \"After Helm is installed, you can SSH into your master node (kube-node-1) and manage Cilium Enterprise installation directly using Helm.\"\necho \"Remember to use the correct Cilium chart version and your custom values file.\"\necho \"Example steps for manual Cilium installation via Helm:\"\necho \"ssh ubuntu@${MASTER_NODE_IP}\"\necho \"sudo helm repo add cilium https://helm.cilium.io/\"\necho \"sudo helm repo add isovalent https://helm.isovalent.com\"\necho \"sudo helm repo update\"\necho \"sudo helm install cilium isovalent/cilium --version 1.17.6 --namespace kube-system -f <path_to_your_cilium_values_file.yaml> --wait\"\necho \"Example content for /tmp/cilium-enterprise-values.yaml:\"\necho \"hubble:\"\necho \"  enabled: true\"\necho \"  relay:\"\necho \"    enabled: true\"\necho \"  ui:\"\necho \"    enabled: false\"\necho \"kubeProxyReplacement: strict\"\necho \"ipam:\"\necho \"  mode: kubernetes\"\necho \"ipv4NativeRoutingCIDR: 10.244.0.0/16\"\necho \"k8s:\"\necho \"  requireIPv4PodCIDR: true\"\necho \"routingMode: native\"\necho \"autoDirectNodeRoutes: false\"\necho \"bgpControlPlane:\"\necho \"  enabled: true\"\n```\n\n执行效果如下：\n\n```bash\nois@ois:~/data/k8s$ ./ansible-helm.sh \n--- Creating project directory: ansible-helm ---\nCreated new directory: ansible-helm\nChanged to directory: /home/ois/data/k8s/ansible-helm\n--- Creating ansible.cfg ---\nansible.cfg created.\n--- Creating inventory.ini ---\ninventory.ini created.\n--- Creating playbook.yml ---\nplaybook.yml created.\n--- Creating Ansible role for Helm installation ---\nHelm installation role created.\n\n--- Ansible setup for Helm installation is complete! ---\nNavigate to the new project directory:\ncd ansible-helm\n\nThen, run the Ansible playbook to install only Helm on your master node:\nansible-playbook playbook.yml -K\n\nAfter Helm is installed, you can SSH into your master node (kube-node-1) and manage Cilium Enterprise installation directly using Helm.\nRemember to use the correct Cilium chart version and your custom values file.\nExample steps for manual Cilium installation via Helm:\nssh ubuntu@10.75.59.71\nsudo helm repo add cilium https://helm.cilium.io/\nsudo helm repo add isovalent https://helm.isovalent.com\nsudo helm repo update\nsudo helm install cilium isovalent/cilium --version 1.17.6 --namespace kube-system -f <path_to_your_cilium_values_file.yaml> --wait\nExample content for /tmp/cilium-enterprise-values.yaml:\nhubble:\n  enabled: true\n  relay:\n    enabled: true\n  ui:\n    enabled: false\nkubeProxyReplacement: strict\nipam:\n  mode: kubernetes\nipv4NativeRoutingCIDR: 172.16.0.0/20\nk8s:\n  requireIPv4PodCIDR: true\nroutingMode: native\nautoDirectNodeRoutes: false\nbgpControlPlane:\n  enabled: true\nois@ois:~/data/k8s$ cd ansible-helm\nois@ois:~/data/k8s/ansible-helm$ ansible-playbook playbook.yml -K\nBECOME password: \n\nPLAY [Install Helm on Kubernetes Master Node] ******************************************************************************************************************************************************************************************************************\n\nTASK [Gathering Facts] *****************************************************************************************************************************************************************************************************************************************\nok: [kube-node-1]\n\nTASK [helm_install : Check if Helm is installed and get version] ***********************************************************************************************************************************************************************************************\nfatal: [kube-node-1]: FAILED! => {\"changed\": false, \"cmd\": \"helm version --short\", \"msg\": \"[Errno 2] No such file or directory: b'helm'\", \"rc\": 2, \"stderr\": \"\", \"stderr_lines\": [], \"stdout\": \"\", \"stdout_lines\": []}\n...ignoring\n\nTASK [helm_install : Set installed Helm version fact] **********************************************************************************************************************************************************************************************************\nok: [kube-node-1]\n\nTASK [helm_install : Debug installed Helm version] *************************************************************************************************************************************************************************************************************\nok: [kube-node-1] => {\n    \"msg\": \"Current installed Helm version: \"\n}\n\nTASK [helm_install : Debug raw Helm version output] ************************************************************************************************************************************************************************************************************\nskipping: [kube-node-1]\n\nTASK [helm_install : Check if Helm binary exists] **************************************************************************************************************************************************************************************************************\nskipping: [kube-node-1]\n\nTASK [helm_install : Download Helm tarball] ********************************************************************************************************************************************************************************************************************\nchanged: [kube-node-1]\n\nTASK [helm_install : Create Helm installation directory] *******************************************************************************************************************************************************************************************************\nok: [kube-node-1]\n\nTASK [helm_install : Extract Helm binary] **********************************************************************************************************************************************************************************************************************\nchanged: [kube-node-1]\n\nTASK [helm_install : Move Helm binary to /usr/local/bin] *******************************************************************************************************************************************************************************************************\nchanged: [kube-node-1]\n\nTASK [helm_install : Clean up Helm tarball and extracted directory] ********************************************************************************************************************************************************************************************\nchanged: [kube-node-1] => (item=/tmp/helm-v3.18.4-linux-amd64.tar.gz)\nchanged: [kube-node-1] => (item=/tmp/linux-amd64)\n\nTASK [helm_install : Verify Helm installation] *****************************************************************************************************************************************************************************************************************\nok: [kube-node-1]\n\nTASK [helm_install : Display Helm version] *********************************************************************************************************************************************************************************************************************\nok: [kube-node-1] => {\n    \"msg\": \"version.BuildInfo{Version:\\\"v3.18.4\\\", GitCommit:\\\"d80839cf37d860c8aa9a0503fe463278f26cd5e2\\\", GitTreeState:\\\"clean\\\", GoVersion:\\\"go1.24.4\\\"}\"\n}\n\nPLAY RECAP *****************************************************************************************************************************************************************************************************************************************************\nkube-node-1                : ok=11   changed=4    unreachable=0    failed=0    skipped=2    rescued=0    ignored=1   \n```\n\n## 4.3 使用Helm安装Cilium\n\n```bash\n\nroot@kube-node-1:~# helm repo add cilium https://helm.cilium.io/\n\"cilium\" has been added to your repositories\nroot@kube-node-1:~# helm repo add isovalent https://helm.isovalent.com\n\"isovalent\" has been added to your repositories\nroot@kube-node-1:~# \n\n准备配置文件如下：\n\nroot@kube-node-1:~# cat > cilium-enterprise-values.yaml <<EOF\nhubble:\n  enabled: true\n  relay:\n    enabled: true\n  ui:\n    enabled: false\n\n# Enable Gateway API\n#gatewayAPI:\n#  enabled: true\n\n# Explicitly disable Egress Gateway\n#egressGateway:\n#  enabled: false\n\n# BGP native-routing configuration\nipam:\n  mode: kubernetes\nipv4NativeRoutingCIDR: 172.16.0.0/20 # Advertises all pod CIDRs; ensure BGP router supports this\nk8s:\n  requireIPv4PodCIDR: true\nroutingMode: native\nautoDirectNodeRoutes: true\nbgpControlPlane:\n  enabled: true\n  # Configure BGP peers (replace with your BGP router details)\n  announce:\n    podCIDR: true # Advertise pod CIDRs to BGP peers\nenableIPv4Masquerade: true\n\n# Enable kube-proxy replacement\nkubeProxyReplacement: true\n\nbpf:\n  masquerade: true\n  lb:\n    externalClusterIP: true\n    sock: true\nEOF\n\nroot@kube-node-1:~# helm install cilium isovalent/cilium --version 1.17.6 \\\n    --namespace kube-system \\\n    --set kubeProxyReplacement=true \\\n    --set k8sServiceHost=10.75.59.71 \\\n    --set k8sServicePort=6443 \\\n    -f cilium-enterprise-values.yaml\nNAME: cilium\nLAST DEPLOYED: Fri Aug  1 09:54:27 2025\nNAMESPACE: kube-system\nSTATUS: deployed\nREVISION: 1\nTEST SUITE: None\nNOTES:\nYou have successfully installed Cilium with Hubble Relay.\n\nYour release version is 1.17.6.\n\nFor any further help, visit https://docs.isovalent.com/v1.17\n\n上述命令中的参数k8sServiceHost=10.75.59.71 和 k8sServicePort=6443 是不能少的。\n```\n\n```bash\n在其他Node上执行kubeadm join\n\nubuntu@kube-node-2:~$ sudo su\n[sudo] password for ubuntu: \nroot@kube-node-2:/home/ubuntu# cd\nroot@kube-node-2:~# kubeadm join kube-node-1:6443 --token wnc2sl.st6g6c4o0cd42bi4 \\\n        --discovery-token-ca-cert-hash sha256:381868d3e0faab6dbd3e240d8f40e0e81ab46cb54b2f15ffbfe0f587fac5d982 \n[preflight] Running pre-flight checks\n[preflight] Reading configuration from the \"kubeadm-config\" ConfigMap in namespace \"kube-system\"...\n[preflight] Use 'kubeadm init phase upload-config --config your-config-file' to re-upload it.\nW0801 09:56:27.830756   47851 configset.go:78] Warning: No kubeproxy.config.k8s.io/v1alpha1 config is loaded. Continuing without it: configmaps \"kube-proxy\" is forbidden: User \"system:bootstrap:wnc2sl\" cannot get resource \"configmaps\" in API group \"\" in the namespace \"kube-system\"\n[kubelet-start] Writing kubelet configuration to file \"/var/lib/kubelet/config.yaml\"\n[kubelet-start] Writing kubelet environment file with flags to file \"/var/lib/kubelet/kubeadm-flags.env\"\n[kubelet-start] Starting the kubelet\n[kubelet-check] Waiting for a healthy kubelet at http://127.0.0.1:10248/healthz. This can take up to 4m0s\n[kubelet-check] The kubelet is healthy after 1.503396779s\n[kubelet-start] Waiting for the kubelet to perform the TLS Bootstrap\n\nThis node has joined the cluster:\n* Certificate signing request was sent to apiserver and a response was received.\n* The Kubelet was informed of the new secure connection details.\n\nRun 'kubectl get nodes' on the control-plane to see this node join the cluster.\n\n```\n\n等待一段时间，Cilium、Hubble Relay即可Ready\n\n```bash\nroot@kube-node-1:~# kubectl get pods -n kube-system -o wide\nNAME                                  READY   STATUS    RESTARTS   AGE     IP            NODE          NOMINATED NODE   READINESS GATES\ncilium-2vrgj                          1/1     Running   0          3m58s   10.75.59.73   kube-node-3   <none>           <none>\ncilium-65kvc                          1/1     Running   0          4m14s   10.75.59.72   kube-node-2   <none>           <none>\ncilium-envoy-24sd7                    1/1     Running   0          4m14s   10.75.59.72   kube-node-2   <none>           <none>\ncilium-envoy-7pr4g                    1/1     Running   0          6m12s   10.75.59.71   kube-node-1   <none>           <none>\ncilium-envoy-k86tp                    1/1     Running   0          3m58s   10.75.59.73   kube-node-3   <none>           <none>\ncilium-operator-867fb7f659-2vnld      1/1     Running   0          6m12s   10.75.59.72   kube-node-2   <none>           <none>\ncilium-operator-867fb7f659-5998x      1/1     Running   0          6m12s   10.75.59.71   kube-node-1   <none>           <none>\ncilium-x4pr7                          1/1     Running   0          6m12s   10.75.59.71   kube-node-1   <none>           <none>\ncoredns-674b8bbfcf-6t8np              1/1     Running   0          13m     172.16.1.40   kube-node-2   <none>           <none>\ncoredns-674b8bbfcf-bx8xd              1/1     Running   0          13m     172.16.1.64   kube-node-2   <none>           <none>\netcd-kube-node-1                      1/1     Running   1          13m     10.75.59.71   kube-node-1   <none>           <none>\nhubble-relay-cfb755899-gch8w          1/1     Running   0          6m12s   172.16.1.81   kube-node-2   <none>           <none>\nkube-apiserver-kube-node-1            1/1     Running   1          13m     10.75.59.71   kube-node-1   <none>           <none>\nkube-controller-manager-kube-node-1   1/1     Running   1          13m     10.75.59.71   kube-node-1   <none>           <none>\nkube-scheduler-kube-node-1            1/1     Running   1          13m     10.75.59.71   kube-node-1   <none>           <none>\n```\n\n## 4.4 安装企业版Cilium-cli\n\n```bash\ncurl -L --remote-name-all https://github.com/isovalent/cilium-cli-releases/releases/latest/download/cilium-linux-amd64.tar.gz{,.sha256sum}\n\nsha256sum --check cilium-linux-amd64.tar.gz.sha256sum\n\ntar xzvfC cilium-linux-amd64.tar.gz /usr/local/bin\n\nroot@kube-node-1:~# cilium status\n    /¯¯\\\n /¯¯\\__/¯¯\\    Cilium:             OK\n \\__/¯¯\\__/    Operator:           OK\n /¯¯\\__/¯¯\\    Envoy DaemonSet:    OK\n \\__/¯¯\\__/    Hubble Relay:       OK\n    \\__/       ClusterMesh:        disabled\n\nDaemonSet              cilium                   Desired: 3, Ready: 3/3, Available: 3/3\nDaemonSet              cilium-envoy             Desired: 3, Ready: 3/3, Available: 3/3\nDeployment             cilium-operator          Desired: 2, Ready: 2/2, Available: 2/2\nDeployment             hubble-relay             Desired: 1, Ready: 1/1, Available: 1/1\nContainers:            cilium                   Running: 3\n                       cilium-envoy             Running: 3\n                       cilium-operator          Running: 2\n                       clustermesh-apiserver    \n                       hubble-relay             Running: 1\nCluster Pods:          3/3 managed by Cilium\nHelm chart version:    1.17.6\nImage versions         cilium             quay.io/isovalent/cilium:v1.17.6-cee.1@sha256:2d01daf4f25f7d644889b49ca856e1a4269981fc963e50bd3962665b41b6adb3: 3\n                       cilium-envoy       quay.io/isovalent/cilium-envoy:v1.17.6-cee.1@sha256:318eff387835ca2717baab42a84f35a83a5f9e7d519253df87269f80b9ff0171: 3\n                       cilium-operator    quay.io/isovalent/operator-generic:v1.17.6-cee.1@sha256:2e602710a7c4f101831df679e5d8251bae8bf0f9fe26c20bbef87f1966ea8265: 2\n                       hubble-relay       quay.io/isovalent/hubble-relay:v1.17.6-cee.1@sha256:d378e3607f7492374e65e2bd854cc0ec87480c63ba49a96dadcd75a6946b586e: 1\nroot@kube-node-1:~# \n```\n\n## 4.5 设置Cilium BGP\n\n```bash\nroot@kube-node-1:~#cat > cilium-bgp.yaml << EOF\n--- #bgp的对外宣告策略，宣告POD和serviceip\napiVersion: cilium.io/v2alpha1\nkind: CiliumBGPAdvertisement\nmetadata:\n  name: bgp-advertisements\n  labels:\n    advertise: bgp\nspec:\n  advertisements:\n    - advertisementType: \"PodCIDR\"              # Only for Kubernetes or ClusterPool IPAM cluster-pool\n    - advertisementType: \"Service\"\n      service:\n        addresses:\n          - ClusterIP\n          - ExternalIP\n          #- LoadBalancerIP\n      selector:\n        matchExpressions:\n        - {key: somekey, operator: NotIn, values: ['never-used-value']}                  # 等同于宣告所有\n\n--- #bgp邻居组的配置，类似template peer ,里面调用相关的advertisement策略\napiVersion: cilium.io/v2alpha1\nkind: CiliumBGPPeerConfig\nmetadata:\n  name: cilium-peer\nspec:\n  timers:\n    holdTimeSeconds: 30             #default 90s\n    keepAliveTimeSeconds: 10  #default 30s\n    connectRetryTimeSeconds: 40  #default 120s\n  gracefulRestart:\n    enabled: true\n    restartTimeSeconds: 120        #default 120s\n  #transport:\n  #  peerPort: 179\n  families:\n    - afi: ipv4\n      safi: unicast\n      advertisements:\n        matchLabels:\n          advertise: \"bgp\"\n\n--- #bgp的邻居配置\napiVersion: cilium.io/v2alpha1\nkind: CiliumBGPClusterConfig\nmetadata:\n  name: cilium-bgp-default\nspec:\n  bgpInstances:\n  - name: \"instance-65000\"\n    localASN: 65000\n    peers:\n    - name: \"GoBGP\"\n      peerASN: 65000\n      peerAddress: 10.75.59.76\n      peerConfigRef:\n        name: \"cilium-peer\"\nEOF\nroot@kube-node-1:~# \nroot@kube-node-1:~# \nroot@kube-node-1:~# kubectl apply -f cilium-bgp.yaml \nciliumbgpadvertisement.cilium.io/bgp-advertisements created\nciliumbgppeerconfig.cilium.io/cilium-peer created\nciliumbgpclusterconfig.cilium.io/cilium-bgp-default created\nroot@kube-node-1:~# cilium bgp peers\nNode          Local AS   Peer AS   Peer Address   Session State   Uptime   Family         Received   Advertised\nkube-node-1   65000      65000     10.75.59.76    established     7s       ipv4/unicast   2          6    \nkube-node-2   65000      65000     10.75.59.76    established     6s       ipv4/unicast   2          6    \nkube-node-3   65000      65000     10.75.59.76    established     6s       ipv4/unicast   2          6    \nroot@kube-node-1:~# cilium bgp routes\n(Defaulting to `available ipv4 unicast` routes, please see help for more options)\n\nNode          VRouter   Prefix             NextHop   Age   Attrs\nkube-node-1   65000     172.16.0.0/24      0.0.0.0   12s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n              65000     172.16.32.1/32     0.0.0.0   12s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n              65000     172.16.32.10/32    0.0.0.0   12s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n              65000     172.16.37.239/32   0.0.0.0   12s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n              65000     172.16.43.10/32    0.0.0.0   12s   [{Origin: i} {Nexthop: 0.0.0.0}]   \nkube-node-2   65000     172.16.1.0/24      0.0.0.0   12s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n              65000     172.16.32.1/32     0.0.0.0   12s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n              65000     172.16.32.10/32    0.0.0.0   12s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n              65000     172.16.37.239/32   0.0.0.0   12s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n              65000     172.16.43.10/32    0.0.0.0   12s   [{Origin: i} {Nexthop: 0.0.0.0}]   \nkube-node-3   65000     172.16.3.0/24      0.0.0.0   12s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n              65000     172.16.32.1/32     0.0.0.0   12s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n              65000     172.16.32.10/32    0.0.0.0   12s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n              65000     172.16.37.239/32   0.0.0.0   12s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n              65000     172.16.43.10/32    0.0.0.0   12s   [{Origin: i} {Nexthop: 0.0.0.0}]   \nroot@kube-node-1:~# \n```\n\n## 4.6 安装Hubble UI\n\n```bash\nroot@kube-node-1:~# helm search repo isovalent/hubble-ui -l\nNAME                    CHART VERSION   APP VERSION     DESCRIPTION         \nisovalent/hubble-ui     1.3.6           1.3.6           Hubble UI Enterprise\nisovalent/hubble-ui     1.3.5           1.3.5           Hubble UI Enterprise\n\nroot@kube-node-1:~# cat > hubble-ui-values.yaml << EOF\nrelay:\n  address: \"hubble-relay.kube-system.svc.cluster.local\"\nEOF\nroot@kube-node-1:~#  \nroot@kube-node-1:~# helm install hubble-ui isovalent/hubble-ui --version 1.3.6 --namespace kube-system --values hubble-ui-values.yaml --wait\nNAME: hubble-ui\nLAST DEPLOYED: Fri Aug  1 10:47:58 2025\nNAMESPACE: kube-system\nSTATUS: deployed\nREVISION: 1\nTEST SUITE: None\nNOTES:\nYou have successfully installed Hubble-Ui.\nYour release version is 1.3.6.\n\nFor any further help, visit https://docs.isovalent.com\nroot@kube-node-1:~# kubectl patch service hubble-ui -n kube-system -p '{\"spec\": {\"type\": \"NodePort\"}}'\nservice/hubble-ui patched\nroot@kube-node-1:~# kubectl get svc -n kube-system -o wide                                                                  \nNAME           TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                  AGE   SELECTOR\ncilium-envoy   ClusterIP   None            <none>        9964/TCP                 54m   k8s-app=cilium-envoy\nhubble-peer    ClusterIP   172.16.43.10    <none>        443/TCP                  54m   k8s-app=cilium\nhubble-relay   NodePort    172.16.37.239   <none>        80:31234/TCP             54m   k8s-app=hubble-relay\nhubble-ui      NodePort    172.16.35.177   <none>        80:31225/TCP             64s   k8s-app=hubble-ui\nkube-dns       ClusterIP   172.16.32.10    <none>        53/UDP,53/TCP,9153/TCP   61m   k8s-app=kube-dns\nroot@kube-node-1:~# kubectl -n kube-system exec ds/cilium -- cilium service list\nDefaulted container \"cilium-agent\" out of: cilium-agent, config (init), mount-cgroup (init), apply-sysctl-overwrites (init), mount-bpf-fs (init), clean-cilium-state (init), install-cni-binaries (init)\nID   Frontend                Service Type   Backend                               \n1    172.16.32.1:443/TCP     ClusterIP      1 => 10.75.59.71:6443/TCP (active)    \n2    172.16.43.10:443/TCP    ClusterIP      1 => 10.75.59.71:4244/TCP (active)    \n3    172.16.37.239:80/TCP    ClusterIP      1 => 172.16.1.81:4245/TCP (active)    \n4    10.75.59.71:31234/TCP   NodePort       1 => 172.16.1.81:4245/TCP (active)    \n5    0.0.0.0:31234/TCP       NodePort       1 => 172.16.1.81:4245/TCP (active)    \n6    172.16.32.10:53/TCP     ClusterIP      1 => 172.16.1.64:53/TCP (active)      \n                                            2 => 172.16.1.40:53/TCP (active)      \n7    172.16.32.10:9153/TCP   ClusterIP      1 => 172.16.1.64:9153/TCP (active)    \n                                            2 => 172.16.1.40:9153/TCP (active)    \n8    172.16.32.10:53/UDP     ClusterIP      1 => 172.16.1.64:53/UDP (active)      \n                                            2 => 172.16.1.40:53/UDP (active)      \n9    172.16.35.177:80/TCP    ClusterIP      1 => 172.16.3.127:8081/TCP (active)   \n10   10.75.59.71:31225/TCP   NodePort       1 => 172.16.3.127:8081/TCP (active)   \n11   0.0.0.0:31225/TCP       NodePort       1 => 172.16.3.127:8081/TCP (active)  \n\n浏览器可以通过http://10.75.59.71:31225/ 访问Hubble-ui\n\nroot@dns-server-vm:~# curl http://10.75.59.71:31225/\n<!doctype html><html><head><meta charset=\"utf-8\"/><title>Hubble UI Enterprise</title><meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge\"/><meta name=\"viewport\" content=\"width=device-width,user-scalable=0,initial-scale=1,minimum-scale=1,maximum-scale=1\"/><link rel=\"icon\" type=\"image/png\" sizes=\"32x32\" href=\"/favicon-32x32.png\"/><link rel=\"icon\" type=\"image/png\" sizes=\"16x16\" href=\"/favicon-16x16.png\"/><link rel=\"shortcut icon\" href=\"/favicon.ico\"/><link rel=\"stylesheet\" href=\"/fonts/inter/stylesheet.css\"/><link rel=\"stylesheet\" href=\"/fonts/roboto-mono/stylesheet.css\"/><script defer=\"defer\" src=\"/bundle.app.77bec96f333a96efe6ea.js\"></script><link href=\"/bundle.app.f1e6c0c33f1535bc8508.css\" rel=\"stylesheet\"><script type=\"text/template\" id=\"hubble-ui/feature-flags\">[10, 0, 18, 0, 26, 0, 34, 0, 42, 0, 50, 0]</script><script type=\"text/template\" id=\"hubble-ui/authorization\">[8, 1, 26, 4, 24, 1, 32, 1]</script></head><body><div id=\"test-process-tree-char\" style=\"font-family: 'Roboto Mono', monospace;\n        font-size: 16px;\n        position: absolute;\n        visibility: hidden;\n        height: auto;\n        width: auto;\n        white-space: nowrap;\">a</div><div id=\"app\"></div></body></html>root@dns-server-vm:~# \nroot@dns-server-vm:~# \n```\n\n# 5. 部署Star Wars App\n\n## 5.1 部署APP\n\nIsovalent 提供了一个Demo APP，以下是部署脚本。\n\n```bash\nroot@kube-node-1:~# kubectl create namespace star-wars\nnamespace/star-wars created\nroot@kube-node-1:~# kubectl apply -n star-wars -f https://raw.githubusercontent.com/cilium/cilium/HEAD/examples/minikube/http-sw-app.yaml\nservice/deathstar created\ndeployment.apps/deathstar created\npod/tiefighter created\npod/xwing created\nroot@kube-node-1:~# kubectl -n star-wars get pod -o wide --show-labels\nNAME                         READY   STATUS    RESTARTS   AGE   IP             NODE          NOMINATED NODE   READINESS GATES   LABELS\ndeathstar-86f85ffb4d-4ldsj   1/1     Running   0          39s   172.16.1.231   kube-node-2   <none>           <none>            app.kubernetes.io/name=deathstar,class=deathstar,org=empire,pod-template-hash=86f85ffb4d\ndeathstar-86f85ffb4d-dbzft   1/1     Running   0          39s   172.16.3.161   kube-node-3   <none>           <none>            app.kubernetes.io/name=deathstar,class=deathstar,org=empire,pod-template-hash=86f85ffb4d\ntiefighter                   1/1     Running   0          39s   172.16.3.247   kube-node-3   <none>           <none>            app.kubernetes.io/name=tiefighter,class=tiefighter,org=empire\nxwing                        1/1     Running   0          39s   172.16.3.155   kube-node-3   <none>           <none>            app.kubernetes.io/name=xwing,class=xwing,org=alliance\nroot@kube-node-1:~# kubectl -n star-wars get service -o wide\nNAME        TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE   SELECTOR\ndeathstar   ClusterIP   172.16.39.138   <none>        80/TCP    82s   class=deathstar,org=empire\nroot@kube-node-1:~# kubectl -n star-wars patch service deathstar -p '{\"spec\":{\"type\":\"NodePort\"}}'\nservice/deathstar patched\nroot@kube-node-1:~# kubectl -n star-wars get service -o wide\nNAME        TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE    SELECTOR\ndeathstar   NodePort   172.16.39.138   <none>        80:32271/TCP   112s   class=deathstar,org=empire\nroot@kube-node-1:~# kubectl -n kube-system exec ds/cilium -- cilium service list\nDefaulted container \"cilium-agent\" out of: cilium-agent, config (init), mount-cgroup (init), apply-sysctl-overwrites (init), mount-bpf-fs (init), clean-cilium-state (init), install-cni-binaries (init)\nID   Frontend                Service Type   Backend                               \n1    172.16.32.1:443/TCP     ClusterIP      1 => 10.75.59.71:6443/TCP (active)    \n2    172.16.43.10:443/TCP    ClusterIP      1 => 10.75.59.71:4244/TCP (active)    \n3    172.16.37.239:80/TCP    ClusterIP      1 => 172.16.1.81:4245/TCP (active)    \n4    10.75.59.71:31234/TCP   NodePort       1 => 172.16.1.81:4245/TCP (active)    \n5    0.0.0.0:31234/TCP       NodePort       1 => 172.16.1.81:4245/TCP (active)    \n6    172.16.32.10:53/TCP     ClusterIP      1 => 172.16.1.64:53/TCP (active)      \n                                            2 => 172.16.1.40:53/TCP (active)      \n7    172.16.32.10:9153/TCP   ClusterIP      1 => 172.16.1.64:9153/TCP (active)    \n                                            2 => 172.16.1.40:9153/TCP (active)    \n8    172.16.32.10:53/UDP     ClusterIP      1 => 172.16.1.64:53/UDP (active)      \n                                            2 => 172.16.1.40:53/UDP (active)      \n9    172.16.35.177:80/TCP    ClusterIP      1 => 172.16.3.127:8081/TCP (active)   \n10   10.75.59.71:31225/TCP   NodePort       1 => 172.16.3.127:8081/TCP (active)   \n11   0.0.0.0:31225/TCP       NodePort       1 => 172.16.3.127:8081/TCP (active)   \n12   172.16.39.138:80/TCP    ClusterIP      1 => 172.16.3.161:80/TCP (active)     \n                                            2 => 172.16.1.231:80/TCP (active)     \n13   10.75.59.71:32271/TCP   NodePort       1 => 172.16.3.161:80/TCP (active)     \n                                            2 => 172.16.1.231:80/TCP (active)     \n14   0.0.0.0:32271/TCP       NodePort       1 => 172.16.3.161:80/TCP (active)     \n                                            2 => 172.16.1.231:80/TCP (active)     \n到这里就算部署成功了。\n\nroot@kube-node-1:~# kubectl -n star-wars exec tiefighter --   curl -s -XPOST http://deathstar.star-wars.svc.cluster.local/v1/request-landing\nShip landed\nroot@kube-node-1:~# kubectl -n star-wars exec xwing --   curl -s -XPOST http://deathstar.star-wars.svc.cluster.local/v1/request-landing\nShip landed\nroot@kube-node-1:~# \n\n在外部的设备也可以通过节点IP访问。\n\nroot@dns-server-vm:~# curl -s -XPOST http://10.75.59.72:32271/v1/request-landing\nShip landed\nroot@dns-server-vm:~# curl -s -XPOST http://10.75.59.71:32271/v1/request-landing\nShip landed\nroot@dns-server-vm:~# curl -s -XPOST http://10.75.59.73:32271/v1/request-landing\nShip landed\n```\n\n## 5.2 在Node外部抓包 ( Pod to Pod )\n\n```bash\n查找虚拟机连接在网桥上的网卡\n\nroot@ois:/home/ois/data/k8s# virsh list\n Id    Name                  State\n--------------------------------------\n 4     win1                  running\n 17    r1                    running\n 69    ubuntu-2404-desktop   running\n 96    dns-server-vm         running\n 97    u1                    running\n 98    ubuntu24042           running\n 99    kube-node-1           running\n 100   kube-node-2           running\n 101   kube-node-3           running\n\nroot@ois:/home/ois/data/k8s# virsh domiflist 99\n Interface   Type     Source   Model    MAC\n-----------------------------------------------------------\n vnet90      bridge   br0      virtio   52:54:00:90:8c:cf\n\nroot@ois:/home/ois/data/k8s# virsh domiflist 100\n Interface   Type     Source   Model    MAC\n-----------------------------------------------------------\n vnet91      bridge   br0      virtio   52:54:00:ba:d4:1f\n\nroot@ois:/home/ois/data/k8s# virsh domiflist 101\n Interface   Type     Source   Model    MAC\n-----------------------------------------------------------\n vnet92      bridge   br0      virtio   52:54:00:37:e0:96\n \n \n```\n\n```bash\n在Pod中发起访问\n\nroot@kube-node-1:~# kubectl -n star-wars get pods -o wide\nNAME                         READY   STATUS    RESTARTS   AGE    IP             NODE          NOMINATED NODE   READINESS GATES\ndeathstar-86f85ffb4d-4ldsj   1/1     Running   0          4m1s   172.16.1.231   kube-node-2   <none>           <none>\ndeathstar-86f85ffb4d-dbzft   1/1     Running   0          4m1s   172.16.3.161   kube-node-3   <none>           <none>\ntiefighter                   1/1     Running   0          4m1s   172.16.3.247   kube-node-3   <none>           <none>\nxwing                        1/1     Running   0          4m1s   172.16.3.155   kube-node-3   <none>           <none>\nroot@kube-node-1:~# kubectl -n star-wars exec xwing -- ip a                                                                            \n1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000\n    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00\n    inet 127.0.0.1/8 scope host lo\n       valid_lft forever preferred_lft forever\n    inet6 ::1/128 scope host \n       valid_lft forever preferred_lft forever\n11: eth0@if12: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP group default qlen 1000\n    link/ether f2:2a:b8:da:e7:d2 brd ff:ff:ff:ff:ff:ff link-netnsid 0\n    inet 172.16.3.155/32 scope global eth0\n       valid_lft forever preferred_lft forever\n    inet6 fe80::f02a:b8ff:feda:e7d2/64 scope link \n       valid_lft forever preferred_lft forever\nroot@kube-node-1:~# kubectl -n star-wars exec xwing -- ping 172.16.1.231\nerror: Internal error occurred: Internal error occurred: error executing command in container: failed to exec in container: failed to start exec \"1b1120795a5b60f35bac5a4056a1714a5c0df32762e2a79f272cf2c82089e970\": OCI runtime exec failed: exec failed: unable to start container process: exec: \"ping\": executable file not found in $PATH: unknown\nroot@kube-node-1:~# kubectl -n star-wars exec xwing -- curl -s http://172.16.1.231/v1\n{\n        \"name\": \"Death Star\",\n        \"hostname\": \"deathstar-86f85ffb4d-4ldsj\",\n        \"model\": \"DS-1 Orbital Battle Station\",\n        \"manufacturer\": \"Imperial Department of Military Research, Sienar Fleet Systems\",\n        \"cost_in_credits\": \"1000000000000\",\n        \"length\": \"120000\",\n        \"crew\": \"342953\",\n        \"passengers\": \"843342\",\n        \"cargo_capacity\": \"1000000000000\",\n        \"hyperdrive_rating\": \"4.0\",\n        \"starship_class\": \"Deep Space Mobile Battlestation\",\n        \"api\": [\n                \"GET   /v1\",\n                \"GET   /v1/healthz\",\n                \"POST  /v1/request-landing\",\n                \"PUT   /v1/cargobay\",\n                \"GET   /v1/hyper-matter-reactor/status\",\n                \"PUT   /v1/exhaust-port\"\n        ]\n}\n\n在宿主机上进行抓包，可以看到两者之间是直接路由的。\n\nroot@ois:/home/ois/data/k8s# tcpdump -i vnet92 -vn 'tcp port 80'\ntcpdump: listening on vnet92, link-type EN10MB (Ethernet), snapshot length 262144 bytes\n11:11:11.478887 IP (tos 0x0, ttl 63, id 25688, offset 0, flags [DF], proto TCP (6), length 60)\n    172.16.3.155.37162 > 172.16.1.231.80: Flags [S], cksum 0x5dd1 (incorrect -> 0xdb07), seq 542023762, win 64240, options [mss 1460,sackOK,TS val 1624400247 ecr 0,nop,wscale 7], length 0\n11:11:11.479178 IP (tos 0x0, ttl 63, id 0, offset 0, flags [DF], proto TCP (6), length 60)\n    172.16.1.231.80 > 172.16.3.155.37162: Flags [S.], cksum 0x5dd1 (incorrect -> 0x7b14), seq 3892089835, ack 542023763, win 65160, options [mss 1460,sackOK,TS val 727758081 ecr 1624400247,nop,wscale 7], length 0\n11:11:11.479479 IP (tos 0x0, ttl 63, id 25689, offset 0, flags [DF], proto TCP (6), length 52)\n    172.16.3.155.37162 > 172.16.1.231.80: Flags [.], cksum 0x5dc9 (incorrect -> 0xa673), ack 1, win 502, options [nop,nop,TS val 1624400247 ecr 727758081], length 0\n11:11:11.479552 IP (tos 0x0, ttl 63, id 25690, offset 0, flags [DF], proto TCP (6), length 130)\n    172.16.3.155.37162 > 172.16.1.231.80: Flags [P.], cksum 0x5e17 (incorrect -> 0x366d), seq 1:79, ack 1, win 502, options [nop,nop,TS val 1624400247 ecr 727758081], length 78: HTTP, length: 78\n        GET /v1 HTTP/1.1\n        Host: 172.16.1.231\n        User-Agent: curl/7.88.1\n        Accept: */*\n\n11:11:11.479684 IP (tos 0x0, ttl 63, id 13836, offset 0, flags [DF], proto TCP (6), length 52)\n    172.16.1.231.80 > 172.16.3.155.37162: Flags [.], cksum 0x5dc9 (incorrect -> 0xa61e), ack 79, win 509, options [nop,nop,TS val 727758081 ecr 1624400247], length 0\n11:11:11.480420 IP (tos 0x0, ttl 63, id 13837, offset 0, flags [DF], proto TCP (6), length 746)\n    172.16.1.231.80 > 172.16.3.155.37162: Flags [P.], cksum 0x607f (incorrect -> 0xc657), seq 1:695, ack 79, win 509, options [nop,nop,TS val 727758082 ecr 1624400247], length 694: HTTP, length: 694\n        HTTP/1.1 200 OK\n        Content-Type: text/plain\n        Date: Fri, 01 Aug 2025 03:11:11 GMT\n        Content-Length: 591\n\n        {\n                \"name\": \"Death Star\",\n                \"hostname\": \"deathstar-86f85ffb4d-4ldsj\",\n                \"model\": \"DS-1 Orbital Battle Station\",\n                \"manufacturer\": \"Imperial Department of Military Research, Sienar Fleet Systems\",\n                \"cost_in_credits\": \"1000000000000\",\n                \"length\": \"120000\",\n                \"crew\": \"342953\",\n                \"passengers\": \"843342\",\n                \"cargo_capacity\": \"1000000000000\",\n                \"hyperdrive_rating\": \"4.0\",\n                \"starship_class\": \"Deep Space Mobile Battlestation\",\n                \"api\": [\n                        \"GET   /v1\",\n                        \"GET   /v1/healthz\",\n                        \"POST  /v1/request-landing\",\n                        \"PUT   /v1/cargobay\",\n                        \"GET   /v1/hyper-matter-reactor/status\",\n                        \"PUT   /v1/exhaust-port\"\n                ]\n        }       \n```\n\nCilium将各个Node对应的Pod路由自动安装了\n\n```bash\nroot@kube-node-3:~# ip route show\ndefault via 10.75.59.1 dev enp1s0 proto static \n10.75.59.0/24 dev enp1s0 proto kernel scope link src 10.75.59.73 \n172.16.0.0/24 via 10.75.59.71 dev enp1s0 proto kernel \n172.16.1.0/24 via 10.75.59.72 dev enp1s0 proto kernel \n172.16.3.0/24 via 172.16.3.22 dev cilium_host proto kernel src 172.16.3.22 \n172.16.3.22 dev cilium_host proto kernel scope link \nroot@kube-node-3:~# route -n\nKernel IP routing table\nDestination     Gateway         Genmask         Flags Metric Ref    Use Iface\n0.0.0.0         10.75.59.1      0.0.0.0         UG    0      0        0 enp1s0\n10.75.59.0      0.0.0.0         255.255.255.0   U     0      0        0 enp1s0\n172.16.0.0      10.75.59.71     255.255.255.0   UG    0      0        0 enp1s0\n172.16.1.0      10.75.59.72     255.255.255.0   UG    0      0        0 enp1s0\n172.16.3.0      172.16.3.22     255.255.255.0   UG    0      0        0 cilium_host\n172.16.3.22     0.0.0.0         255.255.255.255 UH    0      0        0 cilium_host\n\nroot@kube-node-2:~# ip route show\ndefault via 10.75.59.1 dev enp1s0 proto static \n10.75.59.0/24 dev enp1s0 proto kernel scope link src 10.75.59.72 \n172.16.0.0/24 via 10.75.59.71 dev enp1s0 proto kernel \n172.16.1.0/24 via 172.16.1.128 dev cilium_host proto kernel src 172.16.1.128 \n172.16.1.128 dev cilium_host proto kernel scope link \n172.16.3.0/24 via 10.75.59.73 dev enp1s0 proto kernel \nroot@kube-node-2:~# route -n\nKernel IP routing table\nDestination     Gateway         Genmask         Flags Metric Ref    Use Iface\n0.0.0.0         10.75.59.1      0.0.0.0         UG    0      0        0 enp1s0\n10.75.59.0      0.0.0.0         255.255.255.0   U     0      0        0 enp1s0\n172.16.0.0      10.75.59.71     255.255.255.0   UG    0      0        0 enp1s0\n172.16.1.0      172.16.1.128    255.255.255.0   UG    0      0        0 cilium_host\n172.16.1.128    0.0.0.0         255.255.255.255 UH    0      0        0 cilium_host\n172.16.3.0      10.75.59.73     255.255.255.0   UG    0      0        0 enp1s0\n```\n\n在Hubble UI中，可以看到详细的Flow\n\n```json\n{\n  \"uuid\": \"2af76725-f6f9-49b4-b9f1-8d01b3f14930\",\n  \"verdict\": 1,\n  \"drop_reason\": 0,\n  \"auth_type\": 0,\n  \"Type\": 1,\n  \"node_name\": \"kube-node-2\",\n  \"node_labels\": [\n    \"beta.kubernetes.io/arch=amd64\",\n    \"beta.kubernetes.io/os=linux\",\n    \"kubernetes.io/arch=amd64\",\n    \"kubernetes.io/hostname=kube-node-2\",\n    \"kubernetes.io/os=linux\"\n  ],\n  \"source_names\": [],\n  \"destination_names\": [],\n  \"reply\": false,\n  \"traffic_direction\": 2,\n  \"policy_match_type\": 0,\n  \"trace_observation_point\": 101,\n  \"trace_reason\": 1,\n  \"drop_reason_desc\": 0,\n  \"debug_capture_point\": 0,\n  \"proxy_port\": 0,\n  \"sock_xlate_point\": 0,\n  \"socket_cookie\": 0,\n  \"cgroup_id\": 0,\n  \"Summary\": \"TCP Flags: SYN\",\n  \"egress_allowed_by\": [],\n  \"ingress_allowed_by\": [],\n  \"egress_denied_by\": [],\n  \"ingress_denied_by\": [],\n  \"time\": {\n    \"seconds\": 1754022736,\n    \"nanos\": 962926009\n  },\n  \"ethernet\": {\n    \"source\": \"f2:64:9f:b5:8e:81\",\n    \"destination\": \"82:31:36:d1:5a:00\"\n  },\n  \"IP\": {\n    \"source\": \"172.16.3.155\",\n    \"source_xlated\": \"\",\n    \"destination\": \"172.16.1.231\",\n    \"ipVersion\": 1,\n    \"encrypted\": false\n  },\n  \"l4\": {\n    \"protocol\": {\n      \"oneofKind\": \"TCP\",\n      \"TCP\": {\n        \"source_port\": 38680,\n        \"destination_port\": 80,\n        \"flags\": {\n          \"FIN\": false,\n          \"SYN\": true,\n          \"RST\": false,\n          \"PSH\": false,\n          \"ACK\": false,\n          \"URG\": false,\n          \"ECE\": false,\n          \"CWR\": false,\n          \"NS\": false\n        }\n      }\n    }\n  },\n  \"source\": {\n    \"ID\": 0,\n    \"identity\": 36770,\n    \"cluster_name\": \"default\",\n    \"namespace\": \"star-wars\",\n    \"labels\": [\n      \"k8s:app.kubernetes.io/name=xwing\",\n      \"k8s:class=xwing\",\n      \"k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=star-wars\",\n      \"k8s:io.cilium.k8s.policy.cluster=default\",\n      \"k8s:io.cilium.k8s.policy.serviceaccount=default\",\n      \"k8s:io.kubernetes.pod.namespace=star-wars\",\n      \"k8s:org=alliance\"\n    ],\n    \"pod_name\": \"xwing\",\n    \"workloads\": []\n  },\n  \"destination\": {\n    \"ID\": 284,\n    \"identity\": 15153,\n    \"cluster_name\": \"default\",\n    \"namespace\": \"star-wars\",\n    \"labels\": [\n      \"k8s:app.kubernetes.io/name=deathstar\",\n      \"k8s:class=deathstar\",\n      \"k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=star-wars\",\n      \"k8s:io.cilium.k8s.policy.cluster=default\",\n      \"k8s:io.cilium.k8s.policy.serviceaccount=default\",\n      \"k8s:io.kubernetes.pod.namespace=star-wars\",\n      \"k8s:org=empire\"\n    ],\n    \"pod_name\": \"deathstar-86f85ffb4d-4ldsj\",\n    \"workloads\": [\n      {\n        \"name\": \"deathstar\",\n        \"kind\": \"Deployment\"\n      }\n    ]\n  },\n  \"event_type\": {\n    \"type\": 4,\n    \"sub_type\": 0\n  },\n  \"is_reply\": {\n    \"value\": false\n  },\n  \"interface\": {\n    \"index\": 14,\n    \"name\": \"lxcf734e435e18a\"\n  }\n}\n```\n\n## 5.3 在Node外部抓包 ( Pod to External )\n\n接下来，在Pod内部访问Internet进行测试。\n\n```bash\nroot@kube-node-1:~# kubectl get configmap cilium-config -n kube-system -o yaml | grep -E 'enable-ipv4-masquerade|enable-bpf-masquerade'\n  enable-bpf-masquerade: \"true\"\n  enable-ipv4-masquerade: \"true\"\n  \nPod xwing 位于Kube-node3，在Node3查看\n\nroot@kube-node-1:~# kubectl get pods -n kube-system -l k8s-app=cilium -o wide | grep kube-node-3\ncilium-2vrgj   1/1     Running   0          106m   10.75.59.73   kube-node-3   <none>           <none>\n\nroot@kube-node-1:~# kubectl -n star-wars exec xwing -- curl -s https://echo.free.beeceptor.com\n{\n  \"method\": \"GET\",\n  \"protocol\": \"https\",\n  \"host\": \"echo.free.beeceptor.com\",\n  \"path\": \"/\",\n  \"ip\": \"64.104.44.105:35834\",\n  \"headers\": {\n    \"Host\": \"echo.free.beeceptor.com\",\n    \"User-Agent\": \"curl/7.88.1\",\n    \"Accept\": \"*/*\",\n    \"Via\": \"2.0 Caddy\",\n    \"Accept-Encoding\": \"gzip\"\n  },\n  \"parsedQueryParams\": {}\n}root@kube-node-1:~# \nroot@kube-node-1:~# \n\n使用 cilium bpf nat list 查看NAT表\n\nroot@kube-node-1:~# kubectl exec -n kube-system cilium-2vrgj -- cilium bpf nat list | grep 172.16.3.155\nDefaulted container \"cilium-agent\" out of: cilium-agent, config (init), mount-cgroup (init), apply-sysctl-overwrites (init), mount-bpf-fs (init), clean-cilium-state (init), install-cni-binaries (init)\nTCP OUT 172.16.3.155:35834 -> 147.182.252.2:443 XLATE_SRC 10.75.59.73:35834 Created=4sec ago NeedsCT=0\nTCP IN 147.182.252.2:443 -> 10.75.59.73:35834 XLATE_DST 172.16.3.155:35834 Created=4sec ago NeedsCT=0\nroot@kube-node-1:~# \nroot@kube-node-1:~# \n\n在外部的抓包：\nroot@ois:/home/ois/data/k8s# tcpdump -i vnet92 -vn 'tcp port 443'\ntcpdump: listening on vnet92, link-type EN10MB (Ethernet), snapshot length 262144 bytes\n12:28:22.307306 IP (tos 0x0, ttl 63, id 45759, offset 0, flags [DF], proto TCP (6), length 60)\n    10.75.59.73.49208 > 147.182.252.2.443: Flags [S], cksum 0xd57b (incorrect -> 0x363a), seq 3275650602, win 64240, options [mss 1460,sackOK,TS val 493037768 ecr 0,nop,wscale 7], length 0\n12:28:22.477754 IP (tos 0x0, ttl 42, id 0, offset 0, flags [DF], proto TCP (6), length 60)\n    147.182.252.2.443 > 10.75.59.73.49208: Flags [S.], cksum 0xed16 (correct), seq 450982431, ack 3275650603, win 65160, options [mss 1254,sackOK,TS val 1573215106 ecr 493037768,nop,wscale 7], length 0\n12:28:22.478053 IP (tos 0x0, ttl 63, id 45760, offset 0, flags [DF], proto TCP (6), length 52)\n    10.75.59.73.49208 > 147.182.252.2.443: Flags [.], cksum 0xd573 (incorrect -> 0x16fd), ack 1, win 502, options [nop,nop,TS val 493037939 ecr 1573215106], length 0\n12:28:22.490922 IP (tos 0x0, ttl 63, id 45761, offset 0, flags [DF], proto TCP (6), length 569)\n    10.75.59.73.49208 > 147.182.252.2.443: Flags [P.], cksum 0xd778 (incorrect -> 0x1d27), seq 1:518, ack 1, win 502, options [nop,nop,TS val 493037952 ecr 1573215106], length 517\n```\n\n# 6. 安装K8S和Cilium脚本自动化\n\n接下来打算把K8S和Cilium的安装脚本自动化。\n\n首先需要解决在kube-node-1 能 无密码登录到kube-node-2 和 kube-node-3。\n\n## 6.1 无密码登录设置\n\n```bash\n#!/bin/bash\n\n# --- Configuration ---\nANSIBLE_DIR=\"ansible_ssh_setup\"\nINVENTORY_FILE=\"${ANSIBLE_DIR}/hosts.ini\"\nPLAYBOOK_FILE=\"${ANSIBLE_DIR}/setup_ssh.yml\"\n\n# Kubernetes Node IPs\nKUBE_NODE_1_IP=\"10.75.59.71\"\nKUBE_NODE_2_IP=\"10.75.59.72\"\nKUBE_NODE_3_IP=\"10.75.59.73\"\n\n# Common Ansible user and Python interpreter\nANSIBLE_USER=\"ubuntu\"\nANSIBLE_PYTHON_INTERPRETER=\"/usr/bin/python3\"\n\n# --- Functions ---\n\n# Function to check and install Ansible\ninstall_ansible() {\n    if ! command -v ansible &> /dev/null\n    then\n        echo \"Ansible not found. Attempting to install Ansible...\"\n        if [ -f /etc/debian_version ]; then\n            # Debian/Ubuntu\n            sudo apt update\n            sudo apt install -y software-properties-common\n            sudo add-apt-repository --yes --update ppa:ansible/ansible\n            sudo apt install -y ansible\n        elif [ -f /etc/redhat-release ]; then\n            # CentOS/RHEL/Fedora\n            sudo yum install -y epel-release\n            sudo yum install -y ansible\n        else\n            echo \"Unsupported OS for automatic Ansible installation. Please install Ansible manually.\"\n            exit 1\n        fi\n        if ! command -v ansible &> /dev/null; then\n            echo \"Ansible installation failed. Please install it manually and re-run this script.\"\n            exit 1\n        fi\n        echo \"Ansible installed successfully.\"\n    else\n        echo \"Ansible is already installed.\"\n    fi\n}\n\n# Function to create Ansible inventory file\ncreate_inventory() {\n    echo \"Creating Ansible inventory file: ${INVENTORY_FILE}\"\n    mkdir -p \"$ANSIBLE_DIR\"\n    cat <<EOF > \"$INVENTORY_FILE\"\n[kubernetes_nodes]\nkube-node-1 ansible_host=${KUBE_NODE_1_IP}\nkube-node-2 ansible_host=${KUBE_NODE_2_IP}\nkube-node-3 ansible_host=${KUBE_NODE_3_IP}\n\n[all:vars]\nansible_user=${ANSIBLE_USER}\nansible_python_interpreter=${ANSIBLE_PYTHON_INTERPRETER}\nEOF\n    echo \"Inventory file created.\"\n}\n\n# Function to create Ansible playbook file\ncreate_playbook() {\n    echo \"Creating Ansible playbook file: ${PLAYBOOK_FILE}\"\n    mkdir -p \"$ANSIBLE_DIR\"\n    cat <<'EOF' > \"$PLAYBOOK_FILE\"\n---\n- name: Generate SSH key on kube-node-1 and distribute to other nodes\n  hosts: kubernetes_nodes\n  become: yes\n\n  tasks:\n    - name: Generate SSH key on kube-node-1\n      ansible.builtin.command:\n        cmd: ssh-keygen -t rsa -b 4096 -N \"\" -f /root/.ssh/id_rsa\n        creates: /root/.ssh/id_rsa\n      when: inventory_hostname == 'kube-node-1'\n\n    - name: Ensure .ssh directory exists on all nodes\n      ansible.builtin.file:\n        path: /root/.ssh\n        state: directory\n        mode: '0700'\n\n    - name: Ensure authorized_keys file exists\n      ansible.builtin.file:\n        path: /root/.ssh/authorized_keys\n        state: touch\n        mode: '0600'\n\n    - name: Fetch public key from kube-node-1\n      ansible.builtin.slurp:\n        src: /root/.ssh/id_rsa.pub\n      register: ssh_public_key\n      when: inventory_hostname == 'kube-node-1'\n\n    - name: Distribute public key to kube-node-2 and kube-node-3\n      ansible.builtin.lineinfile:\n        path: /root/.ssh/authorized_keys\n        line: \"{{ hostvars['kube-node-1']['ssh_public_key']['content'] | b64decode }}\"\n        state: present\n      when: inventory_hostname in ['kube-node-2', 'kube-node-3']\nEOF\n    echo \"Playbook file created.\"\n}\n\n# --- Main Script Execution ---\n\necho \"Starting Ansible SSH key setup process...\"\n\n# 1. Install Ansible if not present\ninstall_ansible\n\n# 2. Create Ansible inventory file\ncreate_inventory\n\n# 3. Create Ansible playbook file\ncreate_playbook\n\necho \"Setup complete. You can now run the Ansible playbook manually using:\"\necho \"ansible-playbook -i \\\"$INVENTORY_FILE\\\" \\\"$PLAYBOOK_FILE\\\" --ask-become-pass\"\necho \"You will be prompted for the 'sudo' password for the 'ubuntu' user on your VMs.\"\necho \"Process complete.\"\n```\n\n```bash\nchmod +x ansible_ssh.sh\n./ansible_ssh.sh\n\nois@ois:~/data/k8s$ ./ansible_ssh.sh\nStarting Ansible SSH key setup process...\nAnsible is already installed.\nCreating Ansible inventory file: ansible_ssh_setup/hosts.ini\nInventory file created.\nCreating Ansible playbook file: ansible_ssh_setup/setup_ssh.yml\nPlaybook file created.\nSetup complete. You can now run the Ansible playbook manually using:\nansible-playbook -i \"ansible_ssh_setup/hosts.ini\" \"ansible_ssh_setup/setup_ssh.yml\" --ask-become-pass\nYou will be prompted for the 'sudo' password for the 'ubuntu' user on your VMs.\nProcess complete.\nois@ois:~/data/k8s$ cd ansible_ssh_setup/\nois@ois:~/data/k8s/ansible_ssh_setup$ ansible-playbook setup_ssh.yml -i hosts.ini -K\nBECOME password: \n\nPLAY [Generate SSH key on kube-node-1 and distribute to other nodes] ********************************************************************************************************\n\nTASK [Gathering Facts] ******************************************************************************************************************************************************\nok: [kube-node-1]\nok: [kube-node-3]\nok: [kube-node-2]\n\nTASK [Generate SSH key on kube-node-1] **************************************************************************************************************************************\nskipping: [kube-node-2]\nskipping: [kube-node-3]\nchanged: [kube-node-1]\n\nTASK [Ensure .ssh directory exists on all nodes] ****************************************************************************************************************************\nok: [kube-node-2]\nok: [kube-node-1]\nok: [kube-node-3]\n\nTASK [Ensure authorized_keys file exists] ***********************************************************************************************************************************\nchanged: [kube-node-1]\nchanged: [kube-node-2]\nchanged: [kube-node-3]\n\nTASK [Fetch public key from kube-node-1] ************************************************************************************************************************************\nskipping: [kube-node-2]\nskipping: [kube-node-3]\nok: [kube-node-1]\n\nTASK [Distribute public key to kube-node-2 and kube-node-3] *****************************************************************************************************************\nskipping: [kube-node-1]\nchanged: [kube-node-3]\nchanged: [kube-node-2]\n\nPLAY RECAP ******************************************************************************************************************************************************************\nkube-node-1                : ok=5    changed=2    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   \nkube-node-2                : ok=4    changed=2    unreachable=0    failed=0    skipped=2    rescued=0    ignored=0   \nkube-node-3                : ok=4    changed=2    unreachable=0    failed=0    skipped=2    rescued=0    ignored=0   \n```\n\n效果：\n\n```bash\nroot@kube-node-1:~# ssh root@10.75.59.72\nWelcome to Ubuntu 24.04.2 LTS (GNU/Linux 6.8.0-63-generic x86_64)\n\n * Documentation:  https://help.ubuntu.com\n * Management:     https://landscape.canonical.com\n * Support:        https://ubuntu.com/pro\n\n System information as of Fri Aug  1 02:28:23 PM CST 2025\n\n  System load:  0.13               Processes:               188\n  Usage of /:   30.2% of 18.33GB   Users logged in:         1\n  Memory usage: 10%                IPv4 address for enp1s0: 10.75.59.72\n  Swap usage:   0%\n\n * Strictly confined Kubernetes makes edge and IoT secure. Learn how MicroK8s\n   just raised the bar for easy, resilient and secure K8s cluster deployment.\n\n   https://ubuntu.com/engage/secure-kubernetes-at-the-edge\n\nExpanded Security Maintenance for Applications is not enabled.\n\n0 updates can be applied immediately.\n\nEnable ESM Apps to receive additional future security updates.\nSee https://ubuntu.com/esm or run: sudo pro status\n\n*** System restart required ***\n```\n\n## 6.2 自动化安装设置脚本\n\n```bash\n#!/bin/bash\n\n# ==============================================================================\n# Idempotent Kubernetes and Cilium Setup Script\n#\n# This script can be run multiple times. It checks the current state\n# at each step and only performs actions if necessary.\n# It must be run as root on the primary control-plane node.\n# ==============================================================================\n\n# --- Configuration ---\nCONTROL_PLANE_ENDPOINT=\"kube-node-1\"\nCONTROL_PLANE_IP=\"10.75.59.71\"\nWORKER_NODES=(\"10.75.59.72\" \"10.75.59.73\")\nPOD_CIDR=\"172.16.0.0/20\"\nSERVICE_CIDR=\"172.16.32.0/20\"\nBGP_PEER_IP=\"10.75.59.76\"\nLOCAL_ASN=65000\nPEER_ASN=65000\nCILIUM_VERSION=\"1.17.6\"\nHUBBLE_UI_VERSION=\"1.3.6\"\n\n# ==============================================================================\n# Helper Function\n# ==============================================================================\nprint_header() { echo -e \"\\n### $1 ###\"; }\n\n# ==============================================================================\n# STEP 1: Initialize Kubernetes Control-Plane\n# ==============================================================================\nprint_header \"STEP 1: Initializing Kubernetes Control-Plane\"\n\nif kubectl get nodes &> /dev/null; then\n  echo \"✅ Kubernetes cluster is already running. Skipping kubeadm init.\"\nelse\n  echo \"--> Kubernetes cluster not found. Initializing...\"\n  kubeadm config images pull\n  kubeadm init \\\n    --control-plane-endpoint=${CONTROL_PLANE_ENDPOINT} \\\n    --pod-network-cidr=${POD_CIDR} \\\n    --service-cidr=${SERVICE_CIDR} \\\n    --skip-phases=addon/kube-proxy\n  mkdir -p /root/.kube\n  cp -i /etc/kubernetes/admin.conf /root/.kube/config\n  echo \"✅ Control-Plane initialization complete.\"\nfi\n\n# ==============================================================================\n# STEP 2: Install or Upgrade Cilium CNI\n# ==============================================================================\nprint_header \"STEP 2: Installing or Upgrading Cilium CNI\"\n\nhelm repo add cilium https://helm.cilium.io/ &> /dev/null\nhelm repo add isovalent https://helm.isovalent.com/ &> /dev/null\nhelm repo update > /dev/null\n\ncat > cilium-values.yaml <<EOF\nhubble:\n  enabled: true\n  relay:\n    enabled: true\n  ui:\n    enabled: false\nipam:\n  mode: kubernetes\nipv4NativeRoutingCIDR: ${POD_CIDR}\nk8s:\n  requireIPv4PodCIDR: true\nroutingMode: native\nautoDirectNodeRoutes: true\nenableIPv4Masquerade: true\nbgpControlPlane:\n  enabled: true\n  announce:\n    podCIDR: true\nkubeProxyReplacement: true\nbpf:\n  masquerade: true\n  lb:\n    externalClusterIP: true\n    sock: true\nEOF\n\nif helm status cilium -n kube-system &> /dev/null; then\n  echo \"--> Cilium is already installed. Upgrading to apply latest configuration...\"\n  helm upgrade cilium isovalent/cilium --version ${CILIUM_VERSION} --namespace kube-system --set k8sServiceHost=${CONTROL_PLANE_IP},k8sServicePort=6443 -f cilium-values.yaml\nelse\n  echo \"--> Cilium not found. Installing...\"\n  helm install cilium isovalent/cilium --version ${CILIUM_VERSION} --namespace kube-system --set k8sServiceHost=${CONTROL_PLANE_IP},k8sServicePort=6443 -f cilium-values.yaml\nfi\necho \"--> Waiting for Cilium pods to become ready...\"\nkubectl -n kube-system wait --for=condition=Ready pod -l k8s-app=cilium --timeout=5m\necho \"✅ Cilium is configured.\"\n\n# ==============================================================================\n# STEP 3: Join Worker Nodes to the Cluster\n# ==============================================================================\nprint_header \"STEP 3: Joining Worker Nodes\"\n\nfor NODE_IP in \"${WORKER_NODES[@]}\"; do\n  if kubectl get nodes -o wide | grep -q \"$NODE_IP\"; then\n    echo \"✅ Node ${NODE_IP} is already in the cluster. Skipping join.\"\n  else\n    echo \"--> Node ${NODE_IP} not found in cluster. Attempting to join...\"\n    JOIN_COMMAND=$(kubeadm token create --print-join-command)\n    ssh -o StrictHostKeyChecking=no root@${NODE_IP} \"${JOIN_COMMAND}\"\n    if [ $? -ne 0 ]; then\n      echo \"❌ Failed to join node ${NODE_IP}. Please check SSH connectivity and logs.\" >&2\n      exit 1\n    fi\n    echo \"✅ Node ${NODE_IP} joined successfully.\"\n  fi\ndone\n\n# ==============================================================================\n# STEP 4: Install Cilium CLI\n# ==============================================================================\nprint_header \"STEP 4: Installing Cilium CLI\"\n\nif command -v cilium &> /dev/null; then\n  echo \"✅ Cilium CLI is already installed. Skipping.\"\nelse\n  echo \"--> Installing Cilium CLI...\"\n  curl -L --silent --remote-name-all https://github.com/isovalent/cilium-cli-releases/releases/latest/download/cilium-linux-amd64.tar.gz{,.sha256sum}\n  sha256sum --check cilium-linux-amd64.tar.gz.sha256sum > /dev/null\n  tar xzvfC cilium-linux-amd64.tar.gz /usr/local/bin > /dev/null\n  rm cilium-linux-amd64.tar.gz cilium-linux-amd64.tar.gz.sha256sum\n  echo \"✅ Cilium CLI installed.\"\nfi\n\n# ==============================================================================\n# STEP 5: Configure Cilium BGP Peering\n# ==============================================================================\nprint_header \"STEP 5: Configuring Cilium BGP Peering\"\n\necho \"--> Applying BGP configuration. 'unchanged' means it's already correct.\"\n# CORRECTION: Using the correct schema with matchLabels.\ncat > cilium-bgp.yaml << EOF\n---\napiVersion: cilium.io/v2alpha1\nkind: CiliumBGPAdvertisement\nmetadata:\n  name: bgp-advertisements\n  labels:\n    advertise: bgp\nspec:\n  advertisements:\n    - advertisementType: \"PodCIDR\"              # Only for Kubernetes or ClusterPool IPAM cluster-pool\n    - advertisementType: \"Service\"\n      service:\n        addresses:\n          - ClusterIP\n          - ExternalIP\n          #- LoadBalancerIP\n      selector:\n        matchExpressions:\n        - {key: somekey, operator: NotIn, values: ['never-used-value']} \n\n---\napiVersion: cilium.io/v2alpha1\nkind: CiliumBGPPeerConfig\nmetadata:\n  name: cilium-peer\nspec:\n  timers:\n    holdTimeSeconds: 30             #default 90s\n    keepAliveTimeSeconds: 10  #default 30s\n    connectRetryTimeSeconds: 40  #default 120s\n  gracefulRestart:\n    enabled: true\n    restartTimeSeconds: 120        #default 120s\n  #transport:\n  #  peerPort: 179\n  families:\n    - afi: ipv4\n      safi: unicast\n      advertisements:\n        matchLabels:\n          advertise: \"bgp\"\n\n---\napiVersion: cilium.io/v2alpha1\nkind: CiliumBGPClusterConfig\nmetadata:\n  name: cilium-bgp-default\nspec:\n  bgpInstances:\n  - name: \"instance-65000\"\n    localASN: ${LOCAL_ASN}\n    peers:\n    - name: \"FRR_BGP\"\n      peerASN: ${PEER_ASN}\n      peerAddress: ${BGP_PEER_IP}\n      peerConfigRef:\n        name: \"cilium-peer\"\nEOF\n\n# Apply the configuration and check for errors\nkubectl apply -f cilium-bgp.yaml\nif [ $? -ne 0 ]; then\n  echo \"❌ Failed to apply BGP configuration. Please check the errors above.\" >&2\n  exit 1\nfi\necho \"✅ BGP configuration applied.\"\n\n# ==============================================================================\n# STEP 6: Install or Upgrade Hubble UI\n# ==============================================================================\nprint_header \"STEP 6: Installing or Upgrading Hubble UI\"\n\ncat > hubble-ui-values.yaml << EOF\nrelay:\n  address: \"hubble-relay.kube-system.svc.cluster.local\"\nEOF\n\nif helm status hubble-ui -n kube-system &> /dev/null; then\n  echo \"--> Hubble UI is already installed. Upgrading...\"\n  helm upgrade hubble-ui isovalent/hubble-ui --version ${HUBBLE_UI_VERSION} --namespace kube-system --values hubble-ui-values.yaml --wait\nelse\n  echo \"--> Hubble UI not found. Installing...\"\n  helm install hubble-ui isovalent/hubble-ui --version ${HUBBLE_UI_VERSION} --namespace kube-system --values hubble-ui-values.yaml --wait\nfi\n\nSERVICE_TYPE=$(kubectl get service hubble-ui -n kube-system -o jsonpath='{.spec.type}')\nif [ \"$SERVICE_TYPE\" != \"NodePort\" ]; then\n  echo \"--> Patching Hubble UI service to NodePort...\"\n  kubectl patch service hubble-ui -n kube-system -p '{\"spec\": {\"type\": \"NodePort\"}}'\nelse\n  echo \"--> Hubble UI service is already of type NodePort.\"\nfi\necho \"✅ Hubble UI is configured.\"\n\n# ==============================================================================\n# STEP 7: Final Verification\n# ==============================================================================\nprint_header \"STEP 7: Final Verification\"\necho \"--> Waiting for all nodes to be ready...\"\nkubectl wait --for=condition=Ready node --all --timeout=5m\necho \"--> Checking Cilium status...\"\ncilium status --wait\n\nHUBBLE_UI_PORT=$(kubectl get service hubble-ui -n kube-system -o jsonpath='{.spec.ports[0].nodePort}')\necho -e \"\\n----------------------------------------------------------------\"\necho \"🚀 Cluster setup is complete and verified!\"\necho \"Access Hubble UI at: http://${CONTROL_PLANE_IP}:${HUBBLE_UI_PORT}\"\necho \"----------------------------------------------------------------\"\n```\n\n```bash\nroot@kube-node-1:~# ./k8s-cilium-setup.sh \n### STEP 1: Initializing Kubernetes Control-Plane on kube-node-1... ###\n--> Pulling Kubernetes container images...\n[config/images] Pulled registry.k8s.io/kube-apiserver:v1.33.3\n[config/images] Pulled registry.k8s.io/kube-controller-manager:v1.33.3\n[config/images] Pulled registry.k8s.io/kube-scheduler:v1.33.3\n[config/images] Pulled registry.k8s.io/kube-proxy:v1.33.3\n[config/images] Pulled registry.k8s.io/coredns/coredns:v1.12.0\n[config/images] Pulled registry.k8s.io/pause:3.10\n[config/images] Pulled registry.k8s.io/etcd:3.5.21-0\n--> Running kubeadm init...\n[init] Using Kubernetes version: v1.33.3\n[preflight] Running pre-flight checks\n[preflight] Pulling images required for setting up a Kubernetes cluster\n[preflight] This might take a minute or two, depending on the speed of your internet connection\n[preflight] You can also perform this action beforehand using 'kubeadm config images pull'\n[certs] Using certificateDir folder \"/etc/kubernetes/pki\"\n[certs] Generating \"ca\" certificate and key\n[certs] Generating \"apiserver\" certificate and key\n[certs] apiserver serving cert is signed for DNS names [kube-node-1 kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local] and IPs [172.16.32.1 10.75.59.71]\n[certs] Generating \"apiserver-kubelet-client\" certificate and key\n[certs] Generating \"front-proxy-ca\" certificate and key\n[certs] Generating \"front-proxy-client\" certificate and key\n[certs] Generating \"etcd/ca\" certificate and key\n[certs] Generating \"etcd/server\" certificate and key\n[certs] etcd/server serving cert is signed for DNS names [kube-node-1 localhost] and IPs [10.75.59.71 127.0.0.1 ::1]\n[certs] Generating \"etcd/peer\" certificate and key\n[certs] etcd/peer serving cert is signed for DNS names [kube-node-1 localhost] and IPs [10.75.59.71 127.0.0.1 ::1]\n[certs] Generating \"etcd/healthcheck-client\" certificate and key\n[certs] Generating \"apiserver-etcd-client\" certificate and key\n[certs] Generating \"sa\" key and public key\n[kubeconfig] Using kubeconfig folder \"/etc/kubernetes\"\n[kubeconfig] Writing \"admin.conf\" kubeconfig file\n[kubeconfig] Writing \"super-admin.conf\" kubeconfig file\n[kubeconfig] Writing \"kubelet.conf\" kubeconfig file\n[kubeconfig] Writing \"controller-manager.conf\" kubeconfig file\n[kubeconfig] Writing \"scheduler.conf\" kubeconfig file\n[etcd] Creating static Pod manifest for local etcd in \"/etc/kubernetes/manifests\"\n[control-plane] Using manifest folder \"/etc/kubernetes/manifests\"\n[control-plane] Creating static Pod manifest for \"kube-apiserver\"\n[control-plane] Creating static Pod manifest for \"kube-controller-manager\"\n[control-plane] Creating static Pod manifest for \"kube-scheduler\"\n[kubelet-start] Writing kubelet environment file with flags to file \"/var/lib/kubelet/kubeadm-flags.env\"\n[kubelet-start] Writing kubelet configuration to file \"/var/lib/kubelet/config.yaml\"\n[kubelet-start] Starting the kubelet\n[wait-control-plane] Waiting for the kubelet to boot up the control plane as static Pods from directory \"/etc/kubernetes/manifests\"\n[kubelet-check] Waiting for a healthy kubelet at http://127.0.0.1:10248/healthz. This can take up to 4m0s\n[kubelet-check] The kubelet is healthy after 1.001873284s\n[control-plane-check] Waiting for healthy control plane components. This can take up to 4m0s\n[control-plane-check] Checking kube-apiserver at https://10.75.59.71:6443/livez\n[control-plane-check] Checking kube-controller-manager at https://127.0.0.1:10257/healthz\n[control-plane-check] Checking kube-scheduler at https://127.0.0.1:10259/livez\n[control-plane-check] kube-controller-manager is healthy after 2.272937689s\n[control-plane-check] kube-scheduler is healthy after 3.04977489s\n[control-plane-check] kube-apiserver is healthy after 5.003048769s\n[upload-config] Storing the configuration used in ConfigMap \"kubeadm-config\" in the \"kube-system\" Namespace\n[kubelet] Creating a ConfigMap \"kubelet-config\" in namespace kube-system with the configuration for the kubelets in the cluster\n[upload-certs] Skipping phase. Please see --upload-certs\n[mark-control-plane] Marking the node kube-node-1 as control-plane by adding the labels: [node-role.kubernetes.io/control-plane node.kubernetes.io/exclude-from-external-load-balancers]\n[mark-control-plane] Marking the node kube-node-1 as control-plane by adding the taints [node-role.kubernetes.io/control-plane:NoSchedule]\n[bootstrap-token] Using token: 0q5m6l.5pc7hz15orcc0b6b\n[bootstrap-token] Configuring bootstrap tokens, cluster-info ConfigMap, RBAC Roles\n[bootstrap-token] Configured RBAC rules to allow Node Bootstrap tokens to get nodes\n[bootstrap-token] Configured RBAC rules to allow Node Bootstrap tokens to post CSRs in order for nodes to get long term certificate credentials\n[bootstrap-token] Configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token\n[bootstrap-token] Configured RBAC rules to allow certificate rotation for all node client certificates in the cluster\n[bootstrap-token] Creating the \"cluster-info\" ConfigMap in the \"kube-public\" namespace\n[kubelet-finalize] Updating \"/etc/kubernetes/kubelet.conf\" to point to a rotatable kubelet client certificate and key\n[addons] Applied essential addon: CoreDNS\n\nYour Kubernetes control-plane has initialized successfully!\n\nTo start using your cluster, you need to run the following as a regular user:\n\n  mkdir -p $HOME/.kube\n  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config\n  sudo chown $(id -u):$(id -g) $HOME/.kube/config\n\nAlternatively, if you are the root user, you can run:\n\n  export KUBECONFIG=/etc/kubernetes/admin.conf\n\nYou should now deploy a pod network to the cluster.\nRun \"kubectl apply -f [podnetwork].yaml\" with one of the options listed at:\n  https://kubernetes.io/docs/concepts/cluster-administration/addons/\n\nYou can now join any number of control-plane nodes by copying certificate authorities\nand service account keys on each node and then running the following as root:\n\n  kubeadm join kube-node-1:6443 --token 0q5m6l.5pc7hz15orcc0b6b \\\n        --discovery-token-ca-cert-hash sha256:4795595e8237c54f1bf20c7fb56feea9a1960af5802c08c410733d54b5e317a6 \\\n        --control-plane \n\nThen you can join any number of worker nodes by running the following on each as root:\n\nkubeadm join kube-node-1:6443 --token 0q5m6l.5pc7hz15orcc0b6b \\\n        --discovery-token-ca-cert-hash sha256:4795595e8237c54f1bf20c7fb56feea9a1960af5802c08c410733d54b5e317a6 \n--> Configuring kubectl...\n✅ Control-Plane initialization complete.\n### STEP 2: Installing Cilium... ###\n--> Adding Helm repositories...\n\"cilium\" has been added to your repositories\n\"isovalent\" has been added to your repositories\nHang tight while we grab the latest from your chart repositories...\n...Successfully got an update from the \"cilium\" chart repository\n...Successfully got an update from the \"isovalent\" chart repository\nUpdate Complete. ⎈Happy Helming!⎈\n--> Creating cilium-enterprise-values.yaml...\n--> Installing Cilium with Helm...\nNAME: cilium\nLAST DEPLOYED: Fri Aug  1 14:16:16 2025\nNAMESPACE: kube-system\nSTATUS: deployed\nREVISION: 1\nTEST SUITE: None\nNOTES:\nYou have successfully installed Cilium with Hubble Relay.\n\nYour release version is 1.17.6.\n\nFor any further help, visit https://docs.isovalent.com/v1.17\n--> Waiting for Cilium pods to become ready...\npod/cilium-5ngcm condition met\n✅ Cilium installation complete.\n### STEP 3: Joining Worker Nodes... ###\n--> Generated join command: kubeadm join kube-node-1:6443 --token whltm8.4zs5af6hiht167da --discovery-token-ca-cert-hash sha256:4795595e8237c54f1bf20c7fb56feea9a1960af5802c08c410733d54b5e317a6 \n--> Joining node 10.75.59.72 to the cluster...\n[preflight] Running pre-flight checks\n[preflight] Reading configuration from the \"kubeadm-config\" ConfigMap in namespace \"kube-system\"...\n[preflight] Use 'kubeadm init phase upload-config --config your-config-file' to re-upload it.\nW0801 14:18:01.674767   20870 configset.go:78] Warning: No kubeproxy.config.k8s.io/v1alpha1 config is loaded. Continuing without it: configmaps \"kube-proxy\" is forbidden: User \"system:bootstrap:whltm8\" cannot get resource \"configmaps\" in API group \"\" in the namespace \"kube-system\"\n[kubelet-start] Writing kubelet configuration to file \"/var/lib/kubelet/config.yaml\"\n[kubelet-start] Writing kubelet environment file with flags to file \"/var/lib/kubelet/kubeadm-flags.env\"\n[kubelet-start] Starting the kubelet\n[kubelet-check] Waiting for a healthy kubelet at http://127.0.0.1:10248/healthz. This can take up to 4m0s\n[kubelet-check] The kubelet is healthy after 1.501212696s\n[kubelet-start] Waiting for the kubelet to perform the TLS Bootstrap\n\nThis node has joined the cluster:\n* Certificate signing request was sent to apiserver and a response was received.\n* The Kubelet was informed of the new secure connection details.\n\nRun 'kubectl get nodes' on the control-plane to see this node join the cluster.\n\n✅ Node 10.75.59.72 joined successfully.\n--> Joining node 10.75.59.73 to the cluster...\n[preflight] Running pre-flight checks\n[preflight] Reading configuration from the \"kubeadm-config\" ConfigMap in namespace \"kube-system\"...\n[preflight] Use 'kubeadm init phase upload-config --config your-config-file' to re-upload it.\nW0801 14:18:07.347008   20684 configset.go:78] Warning: No kubeproxy.config.k8s.io/v1alpha1 config is loaded. Continuing without it: configmaps \"kube-proxy\" is forbidden: User \"system:bootstrap:whltm8\" cannot get resource \"configmaps\" in API group \"\" in the namespace \"kube-system\"\n[kubelet-start] Writing kubelet configuration to file \"/var/lib/kubelet/config.yaml\"\n[kubelet-start] Writing kubelet environment file with flags to file \"/var/lib/kubelet/kubeadm-flags.env\"\n[kubelet-start] Starting the kubelet\n[kubelet-check] Waiting for a healthy kubelet at http://127.0.0.1:10248/healthz. This can take up to 4m0s\n[kubelet-check] The kubelet is healthy after 1.002187345s\n[kubelet-start] Waiting for the kubelet to perform the TLS Bootstrap\n\nThis node has joined the cluster:\n* Certificate signing request was sent to apiserver and a response was received.\n* The Kubelet was informed of the new secure connection details.\n\nRun 'kubectl get nodes' on the control-plane to see this node join the cluster.\n\n✅ Node 10.75.59.73 joined successfully.\n### STEP 4: Installing the Cilium CLI... ###\n  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current\n                                 Dload  Upload   Total   Spent    Left  Speed\n  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0\n  0     0    0     0    0     0      0      0 --:--:--  0:00:01 --:--:--     0\n100 59.2M  100 59.2M    0     0  13.1M      0  0:00:04  0:00:04 --:--:-- 23.8M\n  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current\n                                 Dload  Upload   Total   Spent    Left  Speed\n  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0\n  0     0    0     0    0     0      0      0 --:--:--  0:00:01 --:--:--     0\n100    92  100    92    0     0     70      0  0:00:01  0:00:01 --:--:--    70\ncilium-linux-amd64.tar.gz: OK\ncilium\n✅ Cilium CLI installed.\n### STEP 5: Configuring Cilium BGP Peering ###\n--> Applying BGP configuration. 'unchanged' means it's already correct.\nciliumbgpadvertisement.cilium.io/bgp-advertisements unchanged\nciliumbgppeerconfig.cilium.io/cilium-peer unchanged\nciliumbgpclusterconfig.cilium.io/cilium-bgp-default configured\n✅ BGP configuration applied.\n### STEP 6: Installing Hubble UI... ###\n--> Creating hubble-ui-values.yaml...\n--> Installing Hubble UI with Helm...\nNAME: hubble-ui\nLAST DEPLOYED: Fri Aug  1 14:18:18 2025\nNAMESPACE: kube-system\nSTATUS: deployed\nREVISION: 1\nTEST SUITE: None\nNOTES:\nYou have successfully installed Hubble-Ui.\nYour release version is 1.3.6.\n\nFor any further help, visit https://docs.isovalent.com\n--> Exposing Hubble UI service via NodePort...\nservice/hubble-ui patched\n✅ Hubble UI installed.\n### STEP 7: Verifying the Setup... ###\n--> Waiting for all nodes to be ready...\nnode/kube-node-1 condition met\nnode/kube-node-2 condition met\nnode/kube-node-3 condition met\n--> Checking Cilium status...\n    /¯¯\\\n /¯¯\\__/¯¯\\    Cilium:             OK\n \\__/¯¯\\__/    Operator:           OK\n /¯¯\\__/¯¯\\    Envoy DaemonSet:    OK\n \\__/¯¯\\__/    Hubble Relay:       OK\n    \\__/       ClusterMesh:        disabled\n\nDaemonSet              cilium                   Desired: 3, Ready: 3/3, Available: 3/3\nDaemonSet              cilium-envoy             Desired: 3, Ready: 3/3, Available: 3/3\nDeployment             cilium-operator          Desired: 2, Ready: 2/2, Available: 2/2\nDeployment             hubble-relay             Desired: 1, Ready: 1/1, Available: 1/1\nDeployment             hubble-ui                Desired: 1, Ready: 1/1, Available: 1/1\nContainers:            cilium                   Running: 3\n                       cilium-envoy             Running: 3\n                       cilium-operator          Running: 2\n                       clustermesh-apiserver    \n                       hubble-relay             Running: 1\n                       hubble-ui                Running: 1\nCluster Pods:          8/8 managed by Cilium\nHelm chart version:    1.17.6\nImage versions         cilium             quay.io/isovalent/cilium:v1.17.6-cee.1@sha256:2d01daf4f25f7d644889b49ca856e1a4269981fc963e50bd3962665b41b6adb3: 3\n                       cilium-envoy       quay.io/isovalent/cilium-envoy:v1.17.6-cee.1@sha256:318eff387835ca2717baab42a84f35a83a5f9e7d519253df87269f80b9ff0171: 3\n                       cilium-operator    quay.io/isovalent/operator-generic:v1.17.6-cee.1@sha256:2e602710a7c4f101831df679e5d8251bae8bf0f9fe26c20bbef87f1966ea8265: 2\n                       hubble-relay       quay.io/isovalent/hubble-relay:v1.17.6-cee.1@sha256:d378e3607f7492374e65e2bd854cc0ec87480c63ba49a96dadcd75a6946b586e: 1\n                       hubble-ui          quay.io/isovalent/hubble-ui-enterprise-backend:v1.3.6: 1\n                       hubble-ui          quay.io/isovalent/hubble-ui-enterprise:v1.3.6: 1\n\n----------------------------------------------------------------\n🚀 Cluster setup is complete and verified!\nAccess Hubble UI at: http://10.75.59.71:30583\n----------------------------------------------------------------\nroot@kube-node-1:~# cilium bgp peers\nNode          Local AS   Peer AS   Peer Address   Session State   Uptime   Family         Received   Advertised\nkube-node-1   65000      65000     10.75.59.76    established     19m1s    ipv4/unicast   2          8    \nkube-node-2   65000      65000     10.75.59.76    established     19m2s    ipv4/unicast   2          8    \nkube-node-3   65000      65000     10.75.59.76    established     19m2s    ipv4/unicast   2          8    \nroot@kube-node-1:~# cilium bgp routes\n(Defaulting to `available ipv4 unicast` routes, please see help for more options)\n\nNode          VRouter   Prefix             NextHop   Age     Attrs\nkube-node-1   65000     172.16.0.0/24      0.0.0.0   19m8s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n              65000     172.16.32.1/32     0.0.0.0   19m8s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n              65000     172.16.32.10/32    0.0.0.0   19m8s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n              65000     172.16.36.130/32   0.0.0.0   19m8s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n              65000     172.16.40.165/32   0.0.0.0   19m8s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n              65000     172.16.43.51/32    0.0.0.0   19m8s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n              65000     172.16.47.30/32    0.0.0.0   19m8s   [{Origin: i} {Nexthop: 0.0.0.0}]   \nkube-node-2   65000     172.16.1.0/24      0.0.0.0   19m8s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n              65000     172.16.32.1/32     0.0.0.0   19m8s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n              65000     172.16.32.10/32    0.0.0.0   19m8s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n              65000     172.16.36.130/32   0.0.0.0   19m8s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n              65000     172.16.40.165/32   0.0.0.0   19m8s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n              65000     172.16.43.51/32    0.0.0.0   19m8s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n              65000     172.16.47.30/32    0.0.0.0   19m8s   [{Origin: i} {Nexthop: 0.0.0.0}]   \nkube-node-3   65000     172.16.2.0/24      0.0.0.0   19m8s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n              65000     172.16.32.1/32     0.0.0.0   19m8s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n              65000     172.16.32.10/32    0.0.0.0   19m8s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n              65000     172.16.36.130/32   0.0.0.0   19m8s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n              65000     172.16.40.165/32   0.0.0.0   19m8s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n              65000     172.16.43.51/32    0.0.0.0   19m8s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n              65000     172.16.47.30/32    0.0.0.0   19m8s   [{Origin: i} {Nexthop: 0.0.0.0}]   \nroot@kube-node-1:~# \n```\n# 7. Kubectl 常用命令\n```shell\nkubectl describe pod hubble-ui-5fdd8b4495-dv7nr -n kube-system\n\nkubectl get nodes -o wide\nkubectl get pods -n kube-system -o wide\nkubectl get pods --all-namespaces\nkubectl get service -n kube-system -o wide\nkubectl get daemonset -n kube-system cilium\nkubectl get deployment -o wide\n\nkubectl get endpoints -n kube-system kube-dns\nkubectl get cm cilium-config -n kube-system -o yaml\nkubectl get endpoints -n kube-system\nkubectl get pods -n kube-system -l k8s-app=cilium -o wide\n# kubectl describe pod hubble-relay-cfb755899-r42l8\n\n\n\nkubectl -n kube-system get pods -l k8s-app=cilium\nkubectl -n kube-system exec ds/cilium -- cilium-dbg bpf ipmasq list\nkubectl -n kube-system exec ds/cilium -- cilium-dbg status --verbose\nkubectl -n kube-system exec ds/cilium -- cilium status\nkubectl -n kube-system exec ds/cilium -- cilium service list\nkubectl -n kube-system exec ds/cilium -- cilium bpf nat list\nkubectl exec -n kube-system cilium-2vrgj -- cilium bpf nat list\n\nkubectl -n kube-system get configmap cilium-config -o yaml\n\nkubectl create namespace star-wars\nkubectl apply -n star-wars -f https://raw.githubusercontent.com/cilium/cilium/HEAD/examples/minikube/http-sw-app.yaml\nkubectl -n star-wars get pod -o wide --show-labels\nkubectl -n star-wars patch service deathstar -p '{\"spec\":{\"type\":\"NodePort\"}}'\nkubectl -n star-wars exec tiefighter --   curl -s -XPOST http://deathstar.star-wars.svc.cluster.local/v1/request-landing\nkubectl -n star-wars exec xwing --   curl -s -XPOST http://deathstar.star-wars.svc.cluster.local/v1/request-landing\n\n# kubectl delete -n star-wars -f https://raw.githubusercontent.com/cilium/cilium/1.18.0/examples/minikube/http-sw-app.yaml\n\n# Commands for reference only.\n\n\nkubectl delete pod,svc,daemonset -n kube-system -l k8s-app=cilium\nkubectl delete daemonset -n kube-system kube-proxy\n\n\nkubectl create deployment nginx --image=nginx\nkubectl expose deployment nginx --port=80 --type=ClusterIP\n\nkubectl run -it --rm busybox --image=busybox --restart=Never -- sh\n\nkubectl run -it --rm curl --image=curlimages/curl --restart=Never -- sh\n\nfor i in {1..10}; do   kubectl exec -n star-wars tiefighter --     curl -s http://deathstar.default.svc.cluster.local/v1 |     jq -r '.hostname'; done\n```","source":"_posts/K8S-Cilium-Replace-kube-proxy.md","raw":"---\ntitle: Kubernetes with CNI Cilium 安装学习\ndate: 2025-08-01 16:06:36\ntags:\ndescription: 本文从零开始部署Ubuntu虚拟机，然后在Ubuntu上安装K8S，使用Cilium作为CNI。\n---\n# Kubernetes with CNI Cilium 安装学习\n\n# 1. 使用自动化脚本安装Ubuntu 24.04虚拟机\n\n## 1.1 准备工作\n\n```bash\n密码加密字符串\nois@ois:~$ mkpasswd --method=SHA-512 --rounds=4096\nPassword: \n$6$rounds=4096$LDu9pXXXXXXXXXXXXXXOh/Iunw372/TVfst1\n\n生成ssh-key，以便实现无密码登录。\nssh-keygen -t rsa -b 4096\nGenerating public/private rsa key pair.\nEnter file in which to save the key (/root/.ssh/id_rsa): \nEnter passphrase (empty for no passphrase): \nEnter same passphrase again: \nYour identification has been saved in /root/.ssh/id_rsa\nYour public key has been saved in /root/.ssh/id_rsa.pub\nThe key fingerprint is:\nSHA256:1+BaD0K3fe6saxPFf41r0SyZEpqhq29AVeRwz+WEXiU \nThe key's randomart image is:\n+---[RSA 4096]----+\n|        .o+  .E..|\n|        .+ o.+.. |\n|       .. +.oo.  |\n|      .. o.=o o  |\n|     .  S.*+oo.B.|\n|      . .=oooo* *|\n|       ...  .o.+.|\n|        o   ooo  |\n|      .+.  .o=o  |\n+----[SHA256]-----+\n```\n\n## 1.2 自动化脚本创建虚拟机节点— 由Gemini生成\n\n### create-vms.sh\n\n```bash\n#!/bin/bash\n\n# --- Configuration ---\nBASE_IMAGE_PATH=\"/home/ois/data/vmimages/noble-server-cloudimg-amd64.img\"\nVM_IMAGE_DIR=\"/home/ois/data/k8s/nodevms\"\nVM_CONFIG_DIR=\"/home/ois/data/k8s/nodevm_cfg\"\nRAM_MB=8192\nVCPUS=4\nDISK_SIZE_GB=20 # <--- ADDED: Increased disk size to 20 GB\nBRIDGE_INTERFACE=\"br0\"\nBASE_IP=\"10.75.59\"\nNETWORK_PREFIX=\"/24\"\nGATEWAY=\"10.75.59.1\"\nNAMESERVER1=\"64.104.76.247\"\nNAMESERVER2=\"64.104.14.184\"\nSEARCH_DOMAIN=\"cisco.com\"\nVNC_PORT_START=5905 # VNC ports will be 5905, 5906, 5907\nPASSWORD_HASH='$6$rounds=4096$LDu9pXXXXXXXXXXXXXXOh/Iunw372/TVfst1'\nSSH_PUB_KEY=$(cat ~/.ssh/id_rsa.pub)\n\n# --- Loop to create 3 VMs ---\nfor i in {1..3}; do\n    VM_NAME=\"kube-node-$i\"\n    VM_IP=\"${BASE_IP}.$((70 + i))\" # IPs will be 10.75.59.71, 10.75.59.72, 10.75.59.73\n    VM_IMAGE_PATH=\"${VM_IMAGE_DIR}/${VM_NAME}.qcow2\"\n    VM_VNC_PORT=$((VNC_PORT_START + i - 1)) # VNC ports will be 5905, 5906, 5907\n\n    echo \"--- Preparing for $VM_NAME (IP: $VM_IP) ---\"\n\n    # Create directories if they don't exist\n    mkdir -p \"$VM_IMAGE_DIR\"\n    mkdir -p \"$VM_CONFIG_DIR\"\n\n    # Create a fresh image for each VM\n    if [ -f \"$VM_IMAGE_PATH\" ]; then\n        echo \"Removing existing image for $VM_NAME...\"\n        rm \"$VM_IMAGE_PATH\"\n    fi\n    echo \"Copying base image to $VM_IMAGE_PATH...\"\n    cp \"$BASE_IMAGE_PATH\" \"$VM_IMAGE_PATH\"\n\n    # --- NEW: Resize the copied image before virt-install ---\n    echo \"Resizing VM image to ${DISK_SIZE_GB}GB...\"\n    qemu-img resize \"$VM_IMAGE_PATH\" \"${DISK_SIZE_GB}G\"\n    # --- END NEW ---\n\n    # Generate user-data for the current VM\n    USER_DATA_FILE=\"${VM_CONFIG_DIR}/${VM_NAME}_user-data\"\n    cat <<EOF > \"$USER_DATA_FILE\"\n#cloud-config\n\nlocale: en_US\nkeyboard:\n  layout: us\ntimezone: Asia/Shanghai\nhostname: ${VM_NAME}\ncreate_hostname_file: true\n\nssh_pwauth: yes\n\ngroups:\n  - ubuntu\n\nusers:\n  - name: ubuntu\n    gecos: ubuntu\n    primary_group: ubuntu\n    groups: sudo, cdrom\n    sudo: ALL=(ALL:ALL) ALL\n    shell: /bin/bash\n    lock_passwd: false\n    passwd: ${PASSWORD_HASH}\n    ssh_authorized_keys:\n      - \"${SSH_PUB_KEY}\"\n\napt:\n  primary:\n    - arches: [default]\n      uri: http://us.archive.ubuntu.com/ubuntu/\n\npackages:\n  - openssh-server\n  - net-tools\n  - iftop\n  - htop\n  - iperf3\n  - vim\n  - curl\n  - wget\n  - cloud-guest-utils # Ensure growpart is available\n\nntp:\n  servers: ['ntp.esl.cisco.com']\n\nruncmd:\n  - echo \"Attempting to resize root partition and filesystem...\"\n  - growpart /dev/vda 1 # Expand the first partition on /dev/vda\n  - resize2fs /dev/vda1 # Expand the ext4 filesystem on /dev/vda1\n  - echo \"Disk resize commands executed. Verify with 'df -h' after boot.\"\nEOF\n\n    # Generate network-config for the current VM\n    NETWORK_CONFIG_FILE=\"${VM_CONFIG_DIR}/${VM_NAME}_network-config\"\n    cat <<EOF > \"$NETWORK_CONFIG_FILE\"\nnetwork:\n  version: 2\n  ethernets:\n    enp1s0:\n      addresses:\n      - \"${VM_IP}${NETWORK_PREFIX}\"\n      nameservers:\n        addresses:\n        - ${NAMESERVER1}\n        - ${NAMESERVER2}\n        search:\n        - ${SEARCH_DOMAIN}\n      routes:\n      - to: \"default\"\n        via: \"${GATEWAY}\"\nEOF\n\n    # Generate meta-data (can be static for now)\n    META_DATA_FILE=\"${VM_CONFIG_DIR}/${VM_NAME}_meta-data\"\n    cat <<EOF > \"$META_DATA_FILE\"\ninstance-id: ${VM_NAME}\nlocal-hostname: ${VM_NAME}\nEOF\n\n    echo \"--- Installing $VM_NAME ---\"\n    virt-install --name \"${VM_NAME}\" --ram \"${RAM_MB}\" --vcpus \"${VCPUS}\" --noreboot \\\n        --os-variant ubuntu24.04 \\\n        --network bridge=\"${BRIDGE_INTERFACE}\" \\\n        --graphics vnc,listen=0.0.0.0,port=\"${VM_VNC_PORT}\" \\\n        --disk path=\"${VM_IMAGE_PATH}\",format=qcow2 \\\n        --console pty,target_type=serial \\\n        --cloud-init user-data=\"${USER_DATA_FILE}\",meta-data=\"${META_DATA_FILE}\",network-config=\"${NETWORK_CONFIG_FILE}\" \\\n        --import \\\n        --wait 0\n\n    echo \"Successfully initiated creation of $VM_NAME.\"\n    echo \"You can connect to VNC on port ${VM_VNC_PORT} to monitor installation (optional).\"\n    echo \"Wait a few minutes for the VM to boot and cloud-init to run.\"\n    echo \"--------------------------------------------------------\"\ndone\n\necho \"All 3 VMs have been initiated. Please wait for them to fully provision.\"\necho \"You can SSH into them using 'ssh ubuntu@<IP_ADDRESS>' where IP addresses are 10.75.59.71, 10.75.59.72, 10.75.59.73.\"\n\n```\n\n上述脚本可自动生成三个虚拟机，并可以使用 ssh ubuntu@10.75.59.71 登录\n\n```bash\nchmod +x create-vms.sh\n\nois@ois:~/data/k8s$ ./create-vms.sh \n--- Preparing for kube-node-1 (IP: 10.75.59.71) ---\nRemoving existing image for kube-node-1...\nCopying base image to /home/ois/data/k8s/nodevms/kube-node-1.qcow2...\nResizing VM image to 20GB...\nImage resized.\n--- Installing kube-node-1 ---\nWARNING  Treating --wait 0 as --noautoconsole\n\nStarting install...\nAllocating 'virtinst-3jev55ba-cloudinit.iso'                                                                                                                                                                                             |    0 B  00:00:00 ... \nTransferring 'virtinst-3jev55ba-cloudinit.iso'                                                                                                                                                                                           |    0 B  00:00:00 ... \nCreating domain...                                                                                                                                                                                                                       |    0 B  00:00:00     \nDomain creation completed.\nSuccessfully initiated creation of kube-node-1.\nYou can connect to VNC on port 5905 to monitor installation (optional).\nWait a few minutes for the VM to boot and cloud-init to run.\n--------------------------------------------------------\n--- Preparing for kube-node-2 (IP: 10.75.59.72) ---\nRemoving existing image for kube-node-2...\nCopying base image to /home/ois/data/k8s/nodevms/kube-node-2.qcow2...\nResizing VM image to 20GB...\nImage resized.\n--- Installing kube-node-2 ---\nWARNING  Treating --wait 0 as --noautoconsole\n\nStarting install...\nAllocating 'virtinst-c4ruhql3-cloudinit.iso'                                                                                                                                                                                             |    0 B  00:00:00 ... \nTransferring 'virtinst-c4ruhql3-cloudinit.iso'                                                                                                                                                                                           |    0 B  00:00:00 ... \nCreating domain...                                                                                                                                                                                                                       |    0 B  00:00:00     \nDomain creation completed.\nSuccessfully initiated creation of kube-node-2.\nYou can connect to VNC on port 5906 to monitor installation (optional).\nWait a few minutes for the VM to boot and cloud-init to run.\n--------------------------------------------------------\n--- Preparing for kube-node-3 (IP: 10.75.59.73) ---\nRemoving existing image for kube-node-3...\nCopying base image to /home/ois/data/k8s/nodevms/kube-node-3.qcow2...\nResizing VM image to 20GB...\nImage resized.\n--- Installing kube-node-3 ---\nWARNING  Treating --wait 0 as --noautoconsole\n\nStarting install...\nAllocating 'virtinst-u5e8k9a9-cloudinit.iso'                                                                                                                                                                                             |    0 B  00:00:00 ... \nTransferring 'virtinst-u5e8k9a9-cloudinit.iso'                                                                                                                                                                                           |    0 B  00:00:00 ... \nCreating domain...                                                                                                                                                                                                                       |    0 B  00:00:00     \nDomain creation completed.\nSuccessfully initiated creation of kube-node-3.\nYou can connect to VNC on port 5907 to monitor installation (optional).\nWait a few minutes for the VM to boot and cloud-init to run.\n--------------------------------------------------------\nAll 3 VMs have been initiated. Please wait for them to fully provision.\nYou can SSH into them using 'ssh ubuntu@<IP_ADDRESS>' where IP addresses are 10.75.59.71, 10.75.59.72, 10.75.59.73.\n\nois@ois:~/data/k8s$ virsh list\n Id   Name                  State\n-------------------------------------\n 83   kube-node-1           running\n 84   kube-node-2           running\n 85   kube-node-3           running\n```\n\n### user-data 示例\n\n```bash\n#cloud-config\n\nlocale: en_US\nkeyboard:\n  layout: us\ntimezone: Asia/Shanghai\nhostname: kube-node-1\ncreate_hostname_file: true\n\nssh_pwauth: yes\n\ngroups:\n  - ubuntu\n\nusers:\n  - name: ubuntu\n    gecos: ubuntu\n    primary_group: ubuntu\n    groups: sudo, cdrom\n    sudo: ALL=(ALL:ALL) ALL\n    shell: /bin/bash\n    lock_passwd: false\n    passwd: $6$rounds=4096$LDu9pXXXXXXXXXXXXXXOh/Iunw372/TVfst1\n    ssh_authorized_keys:\n      - \"ssh-rsa AAAAB3NzaC1yXXXXXXXXXX==\"\n\napt:\n  primary:\n    - arches: [default]\n      uri: http://us.archive.ubuntu.com/ubuntu/\n\npackages:\n  - openssh-server\n  - net-tools\n  - iftop\n  - htop\n  - iperf3\n  - vim\n  - curl\n  - wget\n  - cloud-guest-utils # Ensure growpart is available\n\nntp:\n  servers: ['ntp.esl.cisco.com']\n\nruncmd:\n  - echo \"Attempting to resize root partition and filesystem...\"\n  - growpart /dev/vda 1 # Expand the first partition on /dev/vda\n  - resize2fs /dev/vda1 # Expand the ext4 filesystem on /dev/vda1\n  - echo \"Disk resize commands executed. Verify with 'df -h' after boot.\"\n\n```\n\n### network-config\n\n```bash\nnetwork:\n  version: 2\n  ethernets:\n    enp1s0:\n      addresses:\n      - \"10.75.59.71/24\"\n      nameservers:\n        addresses:\n        - 64.104.76.247\n        - 64.104.14.184\n        search:\n        - cisco.com\n      routes:\n      - to: \"default\"\n        via: \"10.75.59.1\"\n```\n\n### meta-data\n\n```bash\ninstance-id: kube-node-1\nlocal-hostname: kube-node-1\n```\n\n# 2. 使用Ansible安装Kubernetes\n\n## 2.1 脚本内容\n\n以下脚本可用于自动化安装Ansible，并生成Playbook，可直接执行安装任务。\n\n```bash\n#!/bin/bash\n\n# This script automates the setup of an Ansible environment for Kubernetes cluster deployment.\n# It installs Ansible, creates the project directory, inventory, configuration,\n# and defines common Kubernetes setup tasks.\n# This version stops after installing Kubernetes components, allowing manual kubeadm init/join.\n# Includes a robust fix for Containerd's SystemdCgroup configuration and CRI plugin enabling,\n# defines the necessary handler for restarting Containerd, dynamically adds host entries to /etc/hosts,\n# and updates the pause image version in the manual instructions.\n# This update also addresses the runc runtime root configuration in containerd and fixes\n# YAML escape character issues in the hosts file regex, and updates the sandbox image in containerd config.\n\n# --- Configuration ---\nPROJECT_DIR=\"k8s_cluster_setup\"\nMASTER_NODE_IP=\"10.75.59.71\" # Based on your previous script's IP assignment for kube-node-1\nWORKER_NODE_IP_1=\"10.75.59.72\" # Based on your previous script's IP assignment for kube-node-2\nWORKER_NODE_IP_2=\"10.75.59.73\" # Based on your previous script's IP address for kube-node-3\nANSIBLE_USER=\"ubuntu\" # The user created by cloud-init on your VMs\nSSH_PRIVATE_KEY_PATH=\"~/.ssh/id_rsa\" # Path to your SSH private key on the Ansible control machine\n\n# --- Functions ---\n\n# Function to install Ansible\ninstall_ansible() {\n    echo \"--- Installing Ansible ---\"\n    if ! command -v ansible &> /dev/null; then\n        sudo apt update -y\n        sudo apt install -y ansible\n        echo \"Ansible installed successfully.\"\n    else\n        echo \"Ansible is already installed.\"\n    fi\n}\n\n# Function to create project directory and navigate into it\ncreate_project_dir() {\n    echo \"--- Creating project directory: ${PROJECT_DIR} ---\"\n    mkdir -p \"${PROJECT_DIR}\"\n    cd \"${PROJECT_DIR}\" || { echo \"Failed to change directory to ${PROJECT_DIR}. Exiting.\"; exit 1; }\n    echo \"Changed to directory: $(pwd)\"\n}\n\n# Function to create ansible.cfg\ncreate_ansible_cfg() {\n    echo \"--- Creating ansible.cfg ---\"\n    cat <<EOF > ansible.cfg\n[defaults]\ninventory = inventory.ini\nroles_path = ./roles\nhost_key_checking = False # WARNING: Disable host key checking for convenience during initial setup. Re-enable for production!\nEOF\n    echo \"ansible.cfg created.\"\n}\n\n# Function to create inventory.ini (UPDATED with IP variables)\ncreate_inventory() {\n    echo \"--- Creating inventory.ini ---\"\n    cat <<EOF > inventory.ini\n[master]\nkube-node-1 ansible_host=${MASTER_NODE_IP}\n\n[workers]\nkube-node-2 ansible_host=${WORKER_NODE_IP_1}\nkube-node-3 ansible_host=${WORKER_NODE_IP_2}\n\n[all:vars]\nansible_user=${ANSIBLE_USER}\nansible_ssh_private_key_file=${SSH_PRIVATE_KEY_PATH}\nansible_python_interpreter=/usr/bin/python3\n# These variables are now primarily for documentation/script clarity,\n# as the hosts file task will dynamically read from inventory groups.\nmaster_node_ip=${MASTER_NODE_IP}\nworker_node_ip_1=${WORKER_NODE_IP_1}\nworker_node_ip_2=${WORKER_NODE_IP_2}\nEOF\n    echo \"inventory.ini created.\"\n}\n\n# Function to create main playbook.yml (Modified to only include common setup)\ncreate_playbook() {\n    echo \"--- Creating playbook.yml ---\"\n    cat <<EOF > playbook.yml\n---\n- name: Common Kubernetes Setup for all nodes\n  hosts: all\n  become: yes\n  roles:\n    - common_k8s_setup\nEOF\n    echo \"playbook.yml created (only common setup included).\"\n}\n\n# Function to create roles and their tasks\ncreate_roles() {\n    echo \"--- Creating Ansible roles and tasks ---\"\n\n    # common_k8s_setup role\n    mkdir -p roles/common_k8s_setup/tasks\n    # UPDATED: main.yml to include the new hosts entry task first\n    cat <<EOF > roles/common_k8s_setup/tasks/main.yml\n---\n- name: Include add hosts entries task\n  ansible.builtin.include_tasks: 00_add_hosts_entries.yml\n\n- name: Include disable swap task\n  ansible.builtin.include_tasks: 01_disable_swap.yml\n\n- name: Include containerd setup task\n  ansible.builtin.include_tasks: 02_containerd_setup.yml\n\n- name: Include kernel modules and sysctl task\n  ansible.builtin.include_tasks: 03_kernel_modules_sysctl.yml\n\n- name: Include kube repo, install, and hold task\n  ansible.builtin.include_tasks: 04_kube_repo_install_hold.yml\n\n- name: Include initial apt upgrade task\n  ansible.builtin.include_tasks: 05_initial_upgrade.yml\n\n- name: Include configure weekly updates task\n  ansible.builtin.include_tasks: 06_configure_weekly_updates.yml\nEOF\n\n    # NEW FILE: 00_add_hosts_entries.yml (Dynamically adds hosts from inventory, FIXED: Escaped backslashes in regex)\n    cat <<EOF > roles/common_k8s_setup/tasks/00_add_hosts_entries.yml\n---\n- name: Add all inventory hosts to /etc/hosts on each node\n  ansible.builtin.lineinfile:\n    path: /etc/hosts\n    regexp: \"^{{ hostvars[item]['ansible_host'] }}\\\\\\\\s+{{ item }}\" # Fixed: \\\\\\\\s for escaped backslash in regex\n    line: \"{{ hostvars[item]['ansible_host'] }} {{ item }}\"\n    state: present\n    create: yes\n    mode: '0644'\n    owner: root\n    group: root\n  loop: \"{{ groups['all'] }}\" # Loop over all hosts defined in the inventory\nEOF\n\n    # Create handlers directory and file\n    mkdir -p roles/common_k8s_setup/handlers\n    cat <<EOF > roles/common_k8s_setup/handlers/main.yml\n---\n- name: Restart containerd service\n  ansible.builtin.systemd:\n    name: containerd\n    state: restarted\n    daemon_reload: yes\nEOF\n\n    # 01_disable_swap.yml\n    cat <<EOF > roles/common_k8s_setup/tasks/01_disable_swap.yml\n---\n- name: Check if swap is active\n  ansible.builtin.command: swapon --show\n  register: swap_check_result\n  changed_when: false # This command itself doesn't change state\n  failed_when: false  # Don't fail if swapon --show returns non-zero (e.g., no swap enabled)\n\n- name: Disable swap\n  ansible.builtin.command: swapoff -a\n  when: swap_check_result.rc == 0 # Only run if swapon --show indicated swap is active\n\n- name: Persistently disable swap (comment out swapfile in fstab)\n  ansible.builtin.replace:\n    path: /etc/fstab\n    regexp: '^(/swapfile.*)$'\n    replace: '#\\1'\n  when: swap_check_result.rc == 0 # Only run if swap was found to be active\nEOF\n\n    # 02_containerd_setup.yml (UPDATED for sandbox_image)\n    cat <<EOF > roles/common_k8s_setup/tasks/02_containerd_setup.yml\n---\n- name: Install required packages for Containerd\n  ansible.builtin.apt:\n    name:\n      - ca-certificates\n      - curl\n      - gnupg\n      - lsb-release\n      - apt-transport-https\n      - software-properties-common\n    state: present\n    update_cache: yes\n\n- name: Add Docker GPG key\n  ansible.builtin.apt_key:\n    url: https://download.docker.com/linux/ubuntu/gpg\n    state: present\n    keyring: /etc/apt/keyrings/docker.gpg # Use keyring for modern apt\n\n- name: Add Docker APT repository\n  ansible.builtin.apt_repository:\n    repo: \"deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable\"\n    state: present\n    filename: docker\n\n- name: Install Containerd\n  ansible.builtin.apt:\n    name: containerd.io\n    state: present\n    update_cache: yes\n\n- name: Create containerd configuration directory\n  ansible.builtin.file:\n    path: /etc/containerd\n    state: directory\n    mode: '0755'\n\n- name: Generate default containerd configuration directly to final path\n  ansible.builtin.shell: containerd config default > /etc/containerd/config.toml\n  changed_when: true # Always report change as we're ensuring a default state\n\n- name: Ensure CRI plugin is enabled (remove any disabled_plugins line containing \"cri\")\n  ansible.builtin.lineinfile:\n    path: /etc/containerd/config.toml\n    regexp: '^\\s*disabled_plugins = \\[.*\"cri\".*\\]' # More general regexp\n    state: absent\n    backup: yes\n  notify: Restart containerd service\n\n- name: Remove top-level systemd_cgroup from CRI plugin section\n  ansible.builtin.lineinfile:\n    path: /etc/containerd/config.toml\n    regexp: '^\\s*systemd_cgroup = (true|false)' # Matches the 'systemd_cgroup' directly under [plugins.\"io.containerd.grpc.v1.cri\"]\n    state: absent # Remove this line\n    backup: yes\n  notify: Restart containerd service\n\n- name: Remove old runtime_root from runc runtime section\n  ansible.builtin.lineinfile:\n    path: /etc/containerd/config.toml\n    regexp: '^\\s*runtime_root = \".*\"' # Matches runtime_root line\n    state: absent\n    backup: yes\n  notify: Restart containerd service\n\n- name: Configure runc runtime to use SystemdCgroup = true\n  ansible.builtin.lineinfile:\n    path: /etc/containerd/config.toml\n    regexp: '^\\s*#?\\s*SystemdCgroup = (true|false)' # Matches the 'SystemdCgroup' under runc.options\n    line: '            SystemdCgroup = true' # Ensure correct indentation\n    insertafter: '^\\s*\\[plugins\\.\"io\\.containerd\\.grpc\\.v1\\.cri\"\\.containerd\\.runtimes\\.runc\\.options\\]'\n    backup: yes\n  notify: Restart containerd service\n\n- name: Add Root path to runc options\n  ansible.builtin.lineinfile:\n    path: /etc/containerd/config.toml\n    regexp: '^\\s*Root = \".*\"' # Matches existing Root line if any\n    line: '            Root = \"/run/containerd/runc\"' # New Root path\n    insertafter: '^\\s*\\[plugins\\.\"io\\.containerd\\.grpc\\.v1\\.cri\"\\.containerd\\.runtimes\\.runc\\.options\\]'\n    backup: yes\n  notify: Restart containerd service\n\n- name: Update sandbox_image to pause:3.10\n  ansible.builtin.lineinfile:\n    path: /etc/containerd/config.toml\n    regexp: '^\\s*sandbox_image = \"registry.k8s.io/pause:.*\"'\n    line: '    sandbox_image = \"registry.k8s.io/pause:3.10\"'\n    insertafter: '^\\s*\\[plugins\\.\"io\\.containerd\\.grpc\\.v1\\.cri\"\\]' # Insert after the CRI plugin section start\n    backup: yes\n  notify: Restart containerd service\nEOF\n\n    # 03_kernel_modules_sysctl.yml\n    cat <<EOF > roles/common_k8s_setup/tasks/03_kernel_modules_sysctl.yml\n---\n- name: Load overlay module\n  ansible.builtin.command: modprobe overlay\n  args:\n    creates: /sys/module/overlay # Check if module is loaded\n  changed_when: false\n\n- name: Load br_netfilter module\n  ansible.builtin.command: modprobe br_netfilter\n  args:\n    creates: /sys/module/br_netfilter # Check if module is loaded\n  changed_when: false\n\n- name: Add modules to /etc/modules-load.d/k8s.conf\n  ansible.builtin.copy:\n    dest: /etc/modules-load.d/k8s.conf\n    content: |\n      overlay\n      br_netfilter\n\n- name: Configure sysctl parameters for Kubernetes networking\n  ansible.builtin.copy:\n    dest: /etc/sysctl.d/k8s.conf\n    content: |\n      net.bridge.bridge-nf-call-iptables = 1\n      net.bridge.bridge-nf-call-ip6tables = 1\n      net.ipv4.ip_forward = 1\n\n- name: Apply sysctl parameters\n  ansible.builtin.command: sysctl --system\n  changed_when: false\nEOF\n\n    # 04_kube_repo_install_hold.yml\n    cat <<EOF > roles/common_k8s_setup/tasks/04_kube_repo_install_hold.yml\n---\n- name: Create Kubernetes apt keyring directory\n  ansible.builtin.file:\n    path: /etc/apt/keyrings\n    state: directory\n    mode: '0755'\n\n- name: Download Kubernetes GPG key and dearmor\n  ansible.builtin.shell: |\n    curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.33/deb/Release.key | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg\n  args:\n    creates: /etc/apt/keyrings/kubernetes-apt-keyring.gpg\n  changed_when: false # This command is idempotent enough for our purposes\n\n- name: Add Kubernetes APT repository source list\n  ansible.builtin.copy:\n    dest: /etc/apt/sources.list.d/kubernetes.list\n    content: \"deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.33/deb/ /\\n\"\n    mode: '0644'\n    backup: yes\n\n- name: Update apt cache after adding Kubernetes repo\n  ansible.builtin.apt:\n    update_cache: yes\n\n- name: Install kubelet, kubeadm, kubectl\n  ansible.builtin.apt:\n    name:\n      - kubelet\n      - kubeadm\n      - kubectl\n    state: present\n    update_cache: yes # Ensure apt cache is updated after adding repo.\n\n- name: Hold kubelet, kubeadm, kubectl packages\n  ansible.builtin.dpkg_selections:\n    name: \"{{ item }}\"\n    selection: hold\n  loop:\n    - kubelet\n    - kubeadm\n    - kubectl\n\n- name: Enable and start kubelet service\n  ansible.builtin.systemd:\n    name: kubelet\n    state: started\n    enabled: yes\nEOF\n\n    # NEW FILE: 05_initial_upgrade.yml\n    cat <<EOF > roles/common_k8s_setup/tasks/05_initial_upgrade.yml\n---\n- name: Perform initial apt update and upgrade\n  ansible.builtin.apt:\n    update_cache: yes\n    upgrade: yes\n    autoremove: yes\n    purge: yes\nEOF\n\n    # NEW FILE: 06_configure_weekly_updates.yml\n    cat <<EOF > roles/common_k8s_setup/tasks/06_configure_weekly_updates.yml\n---\n- name: Configure weekly apt update and upgrade cron job\n  ansible.builtin.cron:\n    name: \"weekly apt update and upgrade\"\n    weekday: \"0\" # Sunday\n    hour: \"3\"    # 3 AM\n    minute: \"0\"\n    job: \"/usr/bin/apt update && /usr/bin/apt upgrade -y && /usr/bin/apt autoremove -y && /usr/bin/apt clean\"\n    user: root\n    state: present\nEOF\n\n    # Master and Worker roles are still created for structure, but not called by playbook.yml\n    mkdir -p roles/k8s-master/tasks\n    cat <<EOF > roles/k8s-master/tasks/main.yml\n---\n- name: This role is intentionally skipped by the main playbook for manual setup.\n  ansible.builtin.debug:\n    msg: \"This master role is not executed by default. Run 'kubeadm init' manually on the master node.\"\nEOF\n\n    mkdir -p roles/k8s-worker/tasks\n    cat <<EOF > roles/k8s-worker/tasks/main.yml\n---\n- name: This role is intentionally skipped by the main playbook for manual setup.\n  ansible.builtin.debug:\n    msg: \"This worker role is not executed by default. Run 'kubeadm join' manually on worker nodes.\"\nEOF\n\n    echo \"Ansible roles and tasks created.\"\n}\n\n# --- Main execution ---\ninstall_ansible\ncreate_project_dir\ncreate_ansible_cfg\ncreate_inventory\ncreate_playbook\ncreate_roles\n\necho \"\"\necho \"--- Ansible setup for Kubernetes installation is complete! ---\"\necho \"Navigate to the project directory:\"\necho \"cd ${PROJECT_DIR}\"\necho \"\"\necho \"Then, run the Ansible playbook to install Kubernetes components on all nodes:\"\necho \"ansible-playbook playbook.yml -K\"\necho \"\"\necho \"After the playbook finishes, you will need to manually initialize the Kubernetes cluster:\"\necho \"1. SSH into the master node (kube-node-1):\"\necho \"   ssh ubuntu@${MASTER_NODE_IP}\"\necho \"\"\necho \"2. Initialize the Kubernetes control plane on the master node:\"\necho \"   sudo kubeadm init --control-plane-endpoint=kube-node-1 --pod-network-cidr=172.16.0.0/20 --service-cidr=172.16.32.0/20 --skip-phases=addon/kube-proxy --pod-infra-container-image=registry.k8s.io/pause:3.10\"\necho \"\"\necho \"3. After 'kubeadm init' completes, it will print instructions to set up kubectl and the 'kubeadm join' command.\"\necho \"   Follow the instructions to set up kubectl for the 'ubuntu' user:\"\necho \"   mkdir -p \\$HOME/.kube\"\necho \"   sudo cp -i /etc/kubernetes/admin.conf \\$HOME/.kube/config\"\necho \"   sudo chown \\$(id -u):\\$(id -g) \\$HOME/.kube/config\"\necho \"\"\necho \"4. Copy the 'kubeadm join' command (including the token and discovery-token-ca-cert-hash) printed by 'kubeadm init'.\"\necho \"   It will look something like: 'kubeadm join <master-ip>:6443 --token <token> --discovery-token-ca-cert-hash sha256:<hash>'\"\necho \"\"\necho \"5. SSH into each worker node (kube-node-2, kube-node-3) and run the join command:\"\necho \"   ssh ubuntu@${WORKER_NODE_IP_1} (for kube-node-2)\"\necho \"   sudo <PASTE_YOUR_KUBEADM_JOIN_COMMAND_HERE>\"\necho \"\"\necho \"   ssh ubuntu@${WORKER_NODE_IP_2} (for kube-node-3)\"\necho \"   sudo <PASTE_YOUR_KUBEADM_JOIN_COMMAND_HERE>\"\necho \"\"\necho \"6. Verify your cluster status from the master node:\"\necho \"   ssh ubuntu@${MASTER_NODE_IP}\"\necho \"   kubectl get nodes\"\necho \"   kubectl get pods --all-namespaces\"\n```\n\n上述脚本执行完后，创建以下文档\n\n```bash\nroot@ois:/home/ois/data/k8s/k8s_cluster_setup# ls -R1\n.:\nansible.cfg\ninventory.ini\nplaybook.yml\nroles\n\n./roles:\ncommon_k8s_setup\nk8s-master\nk8s-worker\n\n./roles/common_k8s_setup:\nhandlers\ntasks\n\n./roles/common_k8s_setup/handlers:\nmain.yml\n\n./roles/common_k8s_setup/tasks:\n00_add_hosts_entries.yml\n01_disable_swap.yml\n02_containerd_setup.yml\n03_kernel_modules_sysctl.yml\n04_kube_repo_install_hold.yml\n05_initial_upgrade.yml\n06_configure_weekly_updates.yml\nmain.yml\n\n./roles/k8s-master:\ntasks\n\n./roles/k8s-master/tasks:\nmain.yml\n\n./roles/k8s-worker:\ntasks\n\n./roles/k8s-worker/tasks:\nmain.yml\n```\n\n## 2.2 执行过程\n\n在执行前，需要让.ssh/known_hosts 文件保存这些主机的SSH Key。\n\n```bash\n#!/bin/bash\n\n# This script prepares the Ansible control node by adding the SSH host keys\n# of the target nodes to the ~/.ssh/known_hosts file.\n# It first removes any outdated keys for the specified hosts before scanning\n# for the new ones, preventing \"REMOTE HOST IDENTIFICATION HAS CHANGED\" errors.\n\n# --- Configuration ---\n# List of hosts (IPs or FQDNs) to scan.\n# These should be the same hosts you have in your Ansible inventory.\nHOSTS=(\n    \"10.75.59.71\"\n    \"10.75.59.72\"\n    \"10.75.59.73\"\n)\n\n# The location of your known_hosts file.\nKNOWN_HOSTS_FILE=~/.ssh/known_hosts\n\n# --- Main Logic ---\necho \"Starting SSH host key scan to update ${KNOWN_HOSTS_FILE}...\"\necho \"\"\n\n# Ensure the .ssh directory exists with the correct permissions.\nmkdir -p ~/.ssh\nchmod 700 ~/.ssh\n\n# Loop through each host defined in the HOSTS array.\nfor host in \"${HOSTS[@]}\"; do\n    echo \"--- Processing host: ${host} ---\"\n\n    # 1. Remove the old host key (if it exists).\n    # This is the key step to ensure we replace outdated entries.\n    # The command is silent if no key is found.\n    echo \"Step 1: Removing any old key for ${host}...\"\n    ssh-keygen -R \"${host}\"\n\n    # 2. Scan for the new host key and append it.\n    # The -H flag hashes the hostname, which is a security best practice.\n    echo \"Step 2: Scanning for new key and adding it to known_hosts...\"\n    ssh-keyscan -H \"${host}\" >> \"${KNOWN_HOSTS_FILE}\"\n\n    echo \"Successfully updated key for ${host}.\"\n    echo \"\"\ndone\n\n# Set the correct permissions for the known_hosts file, as SSH is strict about this.\nchmod 600 \"${KNOWN_HOSTS_FILE}\"\n\necho \"✅ All hosts have been scanned and keys have been updated.\"\necho \"You can now run your Ansible playbook without host key verification prompts.\"\n```\n\n```bash\nchmod +x ansible-k8s-v2.sh \nois@ois:~/data/k8s$ ./ansible-k8s-v2.sh \n--- Installing Ansible ---\nAnsible is already installed.\n--- Creating project directory: k8s_cluster_setup ---\nChanged to directory: /home/ois/data/k8s/k8s_cluster_setup\n--- Creating ansible.cfg ---\nansible.cfg created.\n--- Creating inventory.ini ---\ninventory.ini created.\n--- Creating playbook.yml ---\nplaybook.yml created (only common setup included).\n--- Creating Ansible roles and tasks ---\nAnsible roles and tasks created.\n\n--- Ansible setup for Kubernetes installation is complete! ---\nNavigate to the project directory:\ncd k8s_cluster_setup\n\nThen, run the Ansible playbook to install Kubernetes components on all nodes:\nansible-playbook playbook.yml -K\n\nAfter the playbook finishes, you will need to manually initialize the Kubernetes cluster:\n1. SSH into the master node (kube-node-1):\n   ssh ubuntu@10.75.59.71\n\n2. Initialize the Kubernetes control plane on the master node:\n   sudo kubeadm init --control-plane-endpoint=kube-node-1 --pod-network-cidr=172.16.0.0/20 --service-cidr=172.16.32.0/20 --skip-phases=addon/kube-proxy --pod-infra-container-image=registry.k8s.io/pause:3.10\n\n3. After 'kubeadm init' completes, it will print instructions to set up kubectl and the 'kubeadm join' command.\n   Follow the instructions to set up kubectl for the 'ubuntu' user:\n   mkdir -p $HOME/.kube\n   sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config\n   sudo chown $(id -u):$(id -g) $HOME/.kube/config\n\n4. Copy the 'kubeadm join' command (including the token and discovery-token-ca-cert-hash) printed by 'kubeadm init'.\n   It will look something like: 'kubeadm join <master-ip>:6443 --token <token> --discovery-token-ca-cert-hash sha256:<hash>'\n\n5. SSH into each worker node (kube-node-2, kube-node-3) and run the join command:\n   ssh ubuntu@10.75.59.72 (for kube-node-2)\n   sudo <PASTE_YOUR_KUBEADM_JOIN_COMMAND_HERE>\n\n   ssh ubuntu@10.75.59.73 (for kube-node-3)\n   sudo <PASTE_YOUR_KUBEADM_JOIN_COMMAND_HERE>\n\n6. Verify your cluster status from the master node:\n   ssh ubuntu@10.75.59.71\n   kubectl get nodes\n   kubectl get pods --all-namespaces\nois@ois:~/data/k8s$ cd k8s_cluster_setup/\n```\n\n```bash\nois@ois:~/data/k8s/k8s_cluster_setup$ ansible-playbook playbook.yml -K\nBECOME password: \n\nPLAY [Common Kubernetes Setup for all nodes] *******************************************************************************************************************************************************************************************************************\n\nTASK [Gathering Facts] *****************************************************************************************************************************************************************************************************************************************\nok: [kube-node-1]\nok: [kube-node-2]\nok: [kube-node-3]\n\nTASK [common_k8s_setup : Include add hosts entries task] *******************************************************************************************************************************************************************************************************\nincluded: /home/ois/data/k8s/k8s_cluster_setup/roles/common_k8s_setup/tasks/00_add_hosts_entries.yml for kube-node-1, kube-node-2, kube-node-3\n\nTASK [common_k8s_setup : Add all inventory hosts to /etc/hosts on each node] ***********************************************************************************************************************************************************************************\nchanged: [kube-node-2] => (item=kube-node-1)\nchanged: [kube-node-1] => (item=kube-node-1)\nchanged: [kube-node-3] => (item=kube-node-1)\nchanged: [kube-node-1] => (item=kube-node-2)\nchanged: [kube-node-2] => (item=kube-node-2)\nchanged: [kube-node-3] => (item=kube-node-2)\nchanged: [kube-node-2] => (item=kube-node-3)\nchanged: [kube-node-1] => (item=kube-node-3)\nchanged: [kube-node-3] => (item=kube-node-3)\n\nTASK [common_k8s_setup : Include disable swap task] ************************************************************************************************************************************************************************************************************\nincluded: /home/ois/data/k8s/k8s_cluster_setup/roles/common_k8s_setup/tasks/01_disable_swap.yml for kube-node-1, kube-node-2, kube-node-3\n\nTASK [common_k8s_setup : Check if swap is active] **************************************************************************************************************************************************************************************************************\nok: [kube-node-2]\nok: [kube-node-1]\nok: [kube-node-3]\n\nTASK [common_k8s_setup : Disable swap] *************************************************************************************************************************************************************************************************************************\nchanged: [kube-node-1]\nchanged: [kube-node-2]\nchanged: [kube-node-3]\n\nTASK [common_k8s_setup : Persistently disable swap (comment out swapfile in fstab)] ****************************************************************************************************************************************************************************\nok: [kube-node-2]\nok: [kube-node-3]\nok: [kube-node-1]\n\nTASK [common_k8s_setup : Include containerd setup task] ********************************************************************************************************************************************************************************************************\nincluded: /home/ois/data/k8s/k8s_cluster_setup/roles/common_k8s_setup/tasks/02_containerd_setup.yml for kube-node-1, kube-node-2, kube-node-3\n\nTASK [common_k8s_setup : Install required packages for Containerd] *********************************************************************************************************************************************************************************************\nchanged: [kube-node-2]\nchanged: [kube-node-1]\nchanged: [kube-node-3]\n\nTASK [common_k8s_setup : Add Docker GPG key] *******************************************************************************************************************************************************************************************************************\nchanged: [kube-node-1]\nchanged: [kube-node-2]\nchanged: [kube-node-3]\n\nTASK [common_k8s_setup : Add Docker APT repository] ************************************************************************************************************************************************************************************************************\nchanged: [kube-node-2]\nchanged: [kube-node-1]\nchanged: [kube-node-3]\n\nTASK [common_k8s_setup : Install Containerd] *******************************************************************************************************************************************************************************************************************\nchanged: [kube-node-3]\nchanged: [kube-node-1]\nchanged: [kube-node-2]\n\nTASK [common_k8s_setup : Create containerd configuration directory] ********************************************************************************************************************************************************************************************\nok: [kube-node-2]\nok: [kube-node-3]\nok: [kube-node-1]\n\nTASK [common_k8s_setup : Generate default containerd configuration directly to final path] *********************************************************************************************************************************************************************\nchanged: [kube-node-1]\nchanged: [kube-node-3]\nchanged: [kube-node-2]\n\nTASK [common_k8s_setup : Ensure CRI plugin is enabled (remove any disabled_plugins line containing \"cri\")] *****************************************************************************************************************************************************\nok: [kube-node-1]\nok: [kube-node-2]\nok: [kube-node-3]\n\nTASK [common_k8s_setup : Remove top-level systemd_cgroup from CRI plugin section] ******************************************************************************************************************************************************************************\nchanged: [kube-node-1]\nchanged: [kube-node-2]\nchanged: [kube-node-3]\n\nTASK [common_k8s_setup : Remove old runtime_root from runc runtime section] ************************************************************************************************************************************************************************************\nchanged: [kube-node-1]\nchanged: [kube-node-3]\nchanged: [kube-node-2]\n\nTASK [common_k8s_setup : Configure runc runtime to use SystemdCgroup = true] ***********************************************************************************************************************************************************************************\nchanged: [kube-node-1]\nchanged: [kube-node-2]\nchanged: [kube-node-3]\n\nTASK [common_k8s_setup : Add Root path to runc options] ********************************************************************************************************************************************************************************************************\nchanged: [kube-node-1]\nchanged: [kube-node-3]\nchanged: [kube-node-2]\n\nTASK [common_k8s_setup : Update sandbox_image to pause:3.10] ***************************************************************************************************************************************************************************************************\nchanged: [kube-node-1]\nchanged: [kube-node-2]\nchanged: [kube-node-3]\n\nTASK [common_k8s_setup : Include kernel modules and sysctl task] ***********************************************************************************************************************************************************************************************\nincluded: /home/ois/data/k8s/k8s_cluster_setup/roles/common_k8s_setup/tasks/03_kernel_modules_sysctl.yml for kube-node-1, kube-node-2, kube-node-3\n\nTASK [common_k8s_setup : Load overlay module] ******************************************************************************************************************************************************************************************************************\nok: [kube-node-1]\nok: [kube-node-2]\nok: [kube-node-3]\n\nTASK [common_k8s_setup : Load br_netfilter module] *************************************************************************************************************************************************************************************************************\nok: [kube-node-1]\nok: [kube-node-2]\nok: [kube-node-3]\n\nTASK [common_k8s_setup : Add modules to /etc/modules-load.d/k8s.conf] ******************************************************************************************************************************************************************************************\nchanged: [kube-node-1]\nchanged: [kube-node-2]\nchanged: [kube-node-3]\n\nTASK [common_k8s_setup : Configure sysctl parameters for Kubernetes networking] ********************************************************************************************************************************************************************************\nchanged: [kube-node-1]\nchanged: [kube-node-2]\nchanged: [kube-node-3]\n\nTASK [common_k8s_setup : Apply sysctl parameters] **************************************************************************************************************************************************************************************************************\nok: [kube-node-1]\nok: [kube-node-2]\nok: [kube-node-3]\n\nTASK [common_k8s_setup : Include kube repo, install, and hold task] ********************************************************************************************************************************************************************************************\nincluded: /home/ois/data/k8s/k8s_cluster_setup/roles/common_k8s_setup/tasks/04_kube_repo_install_hold.yml for kube-node-1, kube-node-2, kube-node-3\n\nTASK [common_k8s_setup : Create Kubernetes apt keyring directory] **********************************************************************************************************************************************************************************************\nok: [kube-node-1]\nok: [kube-node-2]\nok: [kube-node-3]\n\nTASK [common_k8s_setup : Download Kubernetes GPG key and dearmor] **********************************************************************************************************************************************************************************************\nok: [kube-node-2]\nok: [kube-node-1]\nok: [kube-node-3]\n\nTASK [common_k8s_setup : Add Kubernetes APT repository source list] ********************************************************************************************************************************************************************************************\nchanged: [kube-node-2]\nchanged: [kube-node-3]\nchanged: [kube-node-1]\n\nTASK [common_k8s_setup : Update apt cache after adding Kubernetes repo] ****************************************************************************************************************************************************************************************\nchanged: [kube-node-2]\nchanged: [kube-node-1]\nchanged: [kube-node-3]\n\nTASK [common_k8s_setup : Install kubelet, kubeadm, kubectl] ****************************************************************************************************************************************************************************************************\nchanged: [kube-node-3]\nchanged: [kube-node-2]\nchanged: [kube-node-1]\n\nTASK [common_k8s_setup : Hold kubelet, kubeadm, kubectl packages] **********************************************************************************************************************************************************************************************\nchanged: [kube-node-1] => (item=kubelet)\nchanged: [kube-node-3] => (item=kubelet)\nchanged: [kube-node-2] => (item=kubelet)\nchanged: [kube-node-3] => (item=kubeadm)\nchanged: [kube-node-1] => (item=kubeadm)\nchanged: [kube-node-2] => (item=kubeadm)\nchanged: [kube-node-3] => (item=kubectl)\nchanged: [kube-node-1] => (item=kubectl)\nchanged: [kube-node-2] => (item=kubectl)\n\nTASK [common_k8s_setup : Enable and start kubelet service] *****************************************************************************************************************************************************************************************************\nchanged: [kube-node-3]\nchanged: [kube-node-2]\nchanged: [kube-node-1]\n\nTASK [common_k8s_setup : Include initial apt upgrade task] *****************************************************************************************************************************************************************************************************\nincluded: /home/ois/data/k8s/k8s_cluster_setup/roles/common_k8s_setup/tasks/05_initial_upgrade.yml for kube-node-1, kube-node-2, kube-node-3\n\nTASK [common_k8s_setup : Perform initial apt update and upgrade] ***********************************************************************************************************************************************************************************************\nchanged: [kube-node-3]\nchanged: [kube-node-2]\nchanged: [kube-node-1]\n\nTASK [common_k8s_setup : Include configure weekly updates task] ************************************************************************************************************************************************************************************************\nincluded: /home/ois/data/k8s/k8s_cluster_setup/roles/common_k8s_setup/tasks/06_configure_weekly_updates.yml for kube-node-1, kube-node-2, kube-node-3\n\nTASK [common_k8s_setup : Configure weekly apt update and upgrade cron job] *************************************************************************************************************************************************************************************\nchanged: [kube-node-1]\nchanged: [kube-node-2]\nchanged: [kube-node-3]\n\nRUNNING HANDLER [common_k8s_setup : Restart containerd service] ************************************************************************************************************************************************************************************************\nchanged: [kube-node-2]\nchanged: [kube-node-1]\nchanged: [kube-node-3]\n\nPLAY RECAP *****************************************************************************************************************************************************************************************************************************************************\nkube-node-1                : ok=39   changed=22   unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   \nkube-node-2                : ok=39   changed=22   unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   \nkube-node-3                : ok=39   changed=22   unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   \n```\n\n# 3. 设置本地DNS和BGP\n\n设置一个本地DNS和BGP服务器用于测试。\n\n## 3.1 create-dns.sh\n\n```bash\n#!/bin/bash\n\n# --- Configuration ---\nBASE_IMAGE_PATH=\"/home/ois/data/vmimages/noble-server-cloudimg-amd64.img\"\nVM_IMAGE_DIR=\"/home/ois/data/k8s/nodevms\"\nVM_CONFIG_DIR=\"/home/ois/data/k8s/nodevm_cfg\"\nRAM_MB=8192\nVCPUS=4\nDISK_SIZE_GB=20\nBRIDGE_INTERFACE=\"br0\"\n# Specific IP for the single VM\nVM_IP=\"10.75.59.76\"\nNETWORK_PREFIX=\"/24\"\nGATEWAY=\"10.75.59.1\"\n# DNS servers for the VM's initial resolution (for internet access)\nVM_NAMESERVER1=\"64.104.76.247\"\nVM_NAMESERVER2=\"64.104.14.184\"\nSEARCH_DOMAIN=\"cisco.com\"\nVNC_PORT=5909 # Fixed VNC port for the single VM\nPASSWORD_HASH='$6$rounds=4096$LDu9pXXXXXXXXXXXXXXOh/Iunw372/TVfst1'\nSSH_PUB_KEY=$(cat ~/.ssh/id_rsa.pub)\n\n# --- VM Details ---\nVM_NAME=\"dns-server-vm\"\nVM_IMAGE_PATH=\"${VM_IMAGE_DIR}/${VM_NAME}.qcow2\"\n\necho \"--- Preparing for $VM_NAME (IP: $VM_IP) ---\"\n\n# Create directories if they don't exist\nmkdir -p \"$VM_IMAGE_DIR\"\nmkdir -p \"$VM_CONFIG_DIR\"\n\n# Create a fresh image for the VM\nif [ -f \"$VM_IMAGE_PATH\" ]; then\n    echo \"Removing existing image for $VM_NAME...\"\n    rm \"$VM_IMAGE_PATH\"\nfi\necho \"Copying base image to $VM_IMAGE_PATH...\"\ncp \"$BASE_IMAGE_PATH\" \"$VM_IMAGE_PATH\"\n\n# Resize the copied image before virt-install\necho \"Resizing VM image to ${DISK_SIZE_GB}GB...\"\nqemu-img resize \"$VM_IMAGE_PATH\" \"${DISK_SIZE_GB}G\"\n\n# Generate user-data for the VM (installing dnsmasq, no UFW, no dnsmasq config here)\nUSER_DATA_FILE=\"${VM_CONFIG_DIR}/${VM_NAME}_user-data\"\ncat <<EOF > \"$USER_DATA_FILE\"\n#cloud-config\n\nlocale: en_US\nkeyboard:\n  layout: us\ntimezone: Asia/Tokyo\nhostname: ${VM_NAME}\ncreate_hostname_file: true\n\nssh_pwauth: yes\n\ngroups:\n  - ubuntu\n\nusers:\n  - name: ubuntu\n    gecos: ubuntu\n    primary_group: ubuntu\n    groups: sudo, cdrom\n    sudo: ALL=(ALL:ALL) ALL\n    shell: /bin/bash\n    lock_passwd: false\n    passwd: ${PASSWORD_HASH}\n    ssh_authorized_keys:\n      - \"${SSH_PUB_KEY}\"\n\napt:\n  primary:\n    - arches: [default]\n      uri: http://us.archive.ubuntu.com/ubuntu/\n\npackages:\n  - openssh-server\n  - net-tools\n  - iftop\n  - htop\n  - iperf3\n  - vim\n  - curl\n  - wget\n  - cloud-guest-utils # Ensure growpart is available\n  - dnsmasq # Install dnsmasq for DNS server functionality\n\nntp:\n  servers: ['ntp.esl.cisco.com']\n\nruncmd:\n  - echo \"Attempting to resize root partition and filesystem...\"\n  - growpart /dev/vda 1 # Expand the first partition on /dev/vda\n  - resize2fs /dev/vda1 # Expand the ext4 filesystem on /dev/vda1\n  - echo \"Disk resize commands executed. Verify with 'df -h' after boot.\"\nEOF\n\n# Generate network-config for the VM (pointing to external DNS for initial connectivity)\nNETWORK_CONFIG_FILE=\"${VM_CONFIG_DIR}/${VM_NAME}_network-config\"\ncat <<EOF > \"$NETWORK_CONFIG_FILE\"\nnetwork:\n  version: 2\n  ethernets:\n    enp1s0:\n      addresses:\n      - \"${VM_IP}${NETWORK_PREFIX}\"\n      nameservers:\n        addresses:\n        - ${VM_NAMESERVER1} # Point VM to external DNS for initial internet access\n        - ${VM_NAMESERVER2}\n        search:\n        - ${SEARCH_DOMAIN}\n      routes:\n      - to: \"default\"\n        via: \"${GATEWAY}\"\nEOF\n\n# Generate meta-data\nMETA_DATA_FILE=\"${VM_CONFIG_DIR}/${VM_NAME}_meta-data\"\ncat <<EOF > \"$META_DATA_FILE\"\ninstance-id: ${VM_NAME}\nlocal-hostname: ${VM_NAME}\nEOF\n\necho \"--- Installing $VM_NAME ---\"\nvirt-install --name \"${VM_NAME}\" --ram \"${RAM_MB}\" --vcpus \"${VCPUS}\" --noreboot \\\n    --os-variant ubuntu24.04 \\\n    --network bridge=\"${BRIDGE_INTERFACE}\" \\\n    --graphics vnc,listen=0.0.0.0,port=\"${VNC_PORT}\" \\\n    --disk path=\"${VM_IMAGE_PATH}\",format=qcow2 \\\n    --console pty,target_type=serial \\\n    --cloud-init user-data=\"${USER_DATA_FILE}\",meta-data=\"${META_DATA_FILE}\",network-config=\"${NETWORK_CONFIG_FILE}\" \\\n    --import \\\n    --wait 0\n\necho \"Successfully initiated creation of $VM_NAME.\"\necho \"You can connect to VNC on port ${VNC_PORT} to monitor installation (optional).\"\necho \"Wait a few minutes for the VM to boot and cloud-init to run.\"\necho \"--------------------------------------------------------\"\n\necho \"The DNS server VM has been initiated. Please wait for it to fully provision.\"\necho \"You can SSH into it using 'ssh ubuntu@${VM_IP}'.\"\necho \"Once provisioned, proceed to use the 'setup-dnsmasq-ansible.sh' script to configure DNS using Ansible.\"\n\nois@ois:~/data/k8s$ ./create-dns.sh \n--- Preparing for dns-server-vm (IP: 10.75.59.76) ---\nCopying base image to /home/ois/data/k8s/nodevms/dns-server-vm.qcow2...\nResizing VM image to 20GB...\nImage resized.\n--- Installing dns-server-vm ---\nWARNING  Treating --wait 0 as --noautoconsole\n\nStarting install...\nAllocating 'virtinst-y1pxxrj5-cloudinit.iso'                                                                                                                                                                                             |    0 B  00:00:00 ... \nTransferring 'virtinst-y1pxxrj5-cloudinit.iso'                                                                                                                                                                                           |    0 B  00:00:00 ... \nCreating domain...                                                                                                                                                                                                                       |    0 B  00:00:00     \nDomain creation completed.\nSuccessfully initiated creation of dns-server-vm.\nYou can connect to VNC on port 5909 to monitor installation (optional).\nWait a few minutes for the VM to boot and cloud-init to run.\n--------------------------------------------------------\nThe DNS server VM has been initiated. Please wait for it to fully provision.\nYou can SSH into it using 'ssh ubuntu@10.75.59.76'.\nOnce provisioned, you can test the DNS forwarding by configuring another machine to use 10.75.59.76 as its DNS server and performing a DNS query.\n```\n\n## 3.2 使用Ansible设置dnsmasq\n\n```bash\n#!/bin/bash\n\n# --- Configuration for Ansible and DNSmasq ---\nVM_IP=\"10.75.59.76\"\nSSH_USER=\"ubuntu\"\nSSH_PRIVATE_KEY_PATH=\"~/.ssh/id_rsa\" # Ensure this path is correct for your setup\nFORWARD_NAMESERVER1=\"64.104.76.247\"\nFORWARD_NAMESERVER2=\"64.104.14.184\"\nSEARCH_DOMAIN=\"cisco.com\"\nANSIBLE_DIR=\"ansible_dnsmasq_setup\"\n\necho \"--- Setting up Ansible environment and configuring DNSmasq on ${VM_IP} ---\"\n\n# Create a directory for Ansible files\nmkdir -p \"$ANSIBLE_DIR\"\ncd \"$ANSIBLE_DIR\" || exit 1\n\n# --- Install Ansible if not already installed ---\nif ! command -v ansible &> /dev/null\nthen\n    echo \"Ansible not found. Installing Ansible...\"\n    # Check OS and install accordingly\n    if [ -f /etc/os-release ]; then\n        . /etc/os-release\n        if [[ \"$ID\" == \"ubuntu\" || \"$ID\" == \"debian\" ]]; then\n            sudo apt update\n            sudo apt install -y software-properties-common\n            sudo apt-add-repository --yes --update ppa:ansible/ansible\n            sudo apt install -y ansible\n        elif [[ \"$ID\" == \"centos\" || \"$ID\" == \"rhel\" || \"$ID\" == \"fedora\" ]]; then\n            sudo yum install -y epel-release\n            sudo yum install -y ansible\n        else\n            echo \"Unsupported OS for automatic Ansible installation. Please install Ansible manually.\"\n            exit 1\n        fi\n    else\n        echo \"Could not determine OS for automatic Ansible installation. Please install Ansible manually.\"\n        exit 1\n    fi\nelse\n    echo \"Ansible is already installed.\"\nfi\n\n# --- Create Ansible Inventory File ---\necho \"Creating Ansible inventory file: inventory.ini\"\ncat <<EOF > inventory.ini\n[dns_server]\n${VM_IP} ansible_user=${SSH_USER} ansible_ssh_private_key_file=${SSH_PRIVATE_KEY_PATH} ansible_python_interpreter=/usr/bin/python3\nEOF\n\n# --- Create Ansible Playbook (setup-dnsmasq.yml) ---\necho \"Creating Ansible playbook: setup-dnsmasq.yml\"\ncat <<EOF > setup-dnsmasq.yml\n---\n- name: Configure DNSmasq Server on Ubuntu VM\n  hosts: dns_server\n  become: yes # Run tasks with sudo privileges\n  vars:\n    dns_forwarder_1: \"${FORWARD_NAMESERVER1}\"\n    dns_forwarder_2: \"${FORWARD_NAMESERVER2}\"\n    vm_ip: \"${VM_IP}\"\n    search_domain: \"${SEARCH_DOMAIN}\"\n\n  tasks:\n    - name: Ensure apt cache is updated\n      ansible.builtin.apt:\n        update_cache: yes\n        cache_valid_time: 3600 # Cache for 1 hour\n\n    - name: Install dnsmasq package\n      ansible.builtin.apt:\n        name: dnsmasq\n        state: present\n\n    - name: Stop dnsmasq service before configuration\n      ansible.builtin.systemd:\n        name: dnsmasq\n        state: stopped\n      ignore_errors: yes # Ignore if it's not running initially\n\n    - name: Backup original dnsmasq.conf\n      ansible.builtin.command: mv /etc/dnsmasq.conf /etc/dnsmasq.conf.bak\n      args:\n        removes: /etc/dnsmasq.conf # Only run if dnsmasq.conf exists\n      ignore_errors: yes\n\n    - name: Configure dnsmasq for forwarding\n      ansible.builtin.template:\n        src: dnsmasq.conf.j2\n        dest: /etc/dnsmasq.conf\n        owner: root\n        group: root\n        mode: '0644'\n      notify: Restart dnsmasq\n\n    - name: Set VM's /etc/resolv.conf to point to itself (local DNS)\n      ansible.builtin.template:\n        src: resolv.conf.j2\n        dest: /etc/resolv.conf\n        owner: root\n        group: root\n        mode: '0644'\n      vars:\n        local_dns_ip: \"127.0.0.1\" # dnsmasq listens on 127.0.0.1\n        # Removed: search_domain: \"{{ search_domain }}\" - it's already available from play vars\n      notify: Restart systemd-resolved # Or NetworkManager, depending on Ubuntu version\n\n  handlers:\n    - name: Restart dnsmasq\n      ansible.builtin.systemd:\n        name: dnsmasq\n        state: restarted\n        enabled: yes # Ensure it's enabled to start on boot\n\n    - name: Restart systemd-resolved\n      ansible.builtin.systemd:\n        name: systemd-resolved\n        state: restarted\n      ignore_errors: yes # systemd-resolved might not be used on server installs\nEOF\n\n# --- Create dnsmasq.conf.j2 template ---\necho \"Creating dnsmasq.conf.j2 template\"\ncat <<EOF > dnsmasq.conf.j2\n# This file is managed by Ansible. Do not edit manually.\n\n# Do not read /etc/resolv.conf, use the servers below\nno-resolv\n\n# Specify upstream DNS servers for forwarding\nserver={{ dns_forwarder_1 }}\nserver={{ dns_forwarder_2 }}\n\n# Listen on localhost and the VM's primary IP\nlisten-address=127.0.0.1,{{ vm_ip }}\n\n# Allow queries from any interface\ninterface={{ ansible_default_ipv4.interface }} # Listen on the primary network interface\n\n# Bind to the interfaces to prevent dnsmasq from listening on all interfaces\nbind-interfaces\n\n# Cache DNS results\ncache-size=150\nEOF\n\n# --- Create resolv.conf.j2 template ---\necho \"Creating resolv.conf.j2 template\"\ncat <<EOF > resolv.conf.j2\n# This file is managed by Ansible. Do not edit manually.\nnameserver {{ local_dns_ip }}\nsearch {{ search_domain }}\nEOF\n\n# --- Run the Ansible Playbook ---\necho \"Running Ansible playbook to configure DNSmasq...\"\nansible-playbook -i inventory.ini setup-dnsmasq.yml -K\n\n# --- Final Instructions ---\necho \"--------------------------------------------------------\"\necho \"DNSmasq configuration complete on ${VM_IP}.\"\necho \"You can now test the DNS server from the VM or from another machine.\"\necho \"From the VM, run: dig @127.0.0.1 www.cisco.com\"\necho \"From another machine on the same network, configure its DNS to ${VM_IP} and run: dig www.cisco.com\"\necho \"Remember to exit the '${ANSIBLE_DIR}' directory when done (cd ..).\"\n```\n\n执行效果\n\n```bash\nois@ois:~/data/k8s$ ./ansible-dnsmasq.sh \n--- Setting up Ansible environment and configuring DNSmasq on 10.75.59.76 ---\nAnsible is already installed.\nCreating Ansible inventory file: inventory.ini\nCreating Ansible playbook: setup-dnsmasq.yml\nCreating dnsmasq.conf.j2 template\nCreating resolv.conf.j2 template\nRunning Ansible playbook to configure DNSmasq...\nBECOME password: \n\nPLAY [Configure DNSmasq Server on Ubuntu VM] *******************************************************************************************************************************************************************************************************************\n\nTASK [Gathering Facts] *****************************************************************************************************************************************************************************************************************************************\nok: [10.75.59.76]\n\nTASK [Ensure apt cache is updated] *****************************************************************************************************************************************************************************************************************************\nok: [10.75.59.76]\n\nTASK [Install dnsmasq package] *********************************************************************************************************************************************************************************************************************************\nok: [10.75.59.76]\n\nTASK [Stop dnsmasq service before configuration] ***************************************************************************************************************************************************************************************************************\nok: [10.75.59.76]\n\nTASK [Backup original dnsmasq.conf] ****************************************************************************************************************************************************************************************************************************\nchanged: [10.75.59.76]\n\nTASK [Configure dnsmasq for forwarding] ************************************************************************************************************************************************************************************************************************\nchanged: [10.75.59.76]\n\nTASK [Set VM's /etc/resolv.conf to point to itself (local DNS)] ************************************************************************************************************************************************************************************************\nchanged: [10.75.59.76]\n\nRUNNING HANDLER [Restart dnsmasq] ******************************************************************************************************************************************************************************************************************************\nchanged: [10.75.59.76]\n\nRUNNING HANDLER [Restart systemd-resolved] *********************************************************************************************************************************************************************************************************************\nchanged: [10.75.59.76]\n\nPLAY RECAP *****************************************************************************************************************************************************************************************************************************************************\n10.75.59.76                : ok=9    changed=5    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   \n\n--------------------------------------------------------\nDNSmasq configuration complete on 10.75.59.76.\nYou can now test the DNS server from the VM or from another machine.\nFrom the VM, run: dig @127.0.0.1 www.cisco.com\nFrom another machine on the same network, configure its DNS to 10.75.59.76 and run: dig www.cisco.com\nRemember to exit the 'ansible_dnsmasq_setup' directory when done (cd ..).\n```\n\n```bash\nroot@dns-server-vm:~# dig @127.0.0.1 www.cisco.com\n\n; <<>> DiG 9.18.30-0ubuntu0.24.04.2-Ubuntu <<>> @127.0.0.1 www.cisco.com\n; (1 server found)\n;; global options: +cmd\n;; Got answer:\n;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 10545\n;; flags: qr aa rd ra; QUERY: 1, ANSWER: 3, AUTHORITY: 0, ADDITIONAL: 1\n\n;; OPT PSEUDOSECTION:\n; EDNS: version: 0, flags:; udp: 1232\n; COOKIE: ba16202024b9dc8301000000688b40f90daaa0a500a50d2d (good)\n;; QUESTION SECTION:\n;www.cisco.com.                 IN      A\n\n;; ANSWER SECTION:\nwww.cisco.com.          3600    IN      CNAME   origin-www.cisco.com.\norigin-www.cisco.com.   1800    IN      CNAME   origin-www.xgslb-v3.cisco.com.\norigin-www.xgslb-v3.CISCO.com. 10 IN    A       72.163.4.161\n\n;; Query time: 71 msec\n;; SERVER: 127.0.0.1#53(127.0.0.1) (UDP)\n;; WHEN: Thu Jul 31 19:10:01 JST 2025\n;; MSG SIZE  rcvd: 183\n\n```\n\n## 3.3 使用Ansible更新Node 的DNS配置\n\n```bash\n#!/bin/bash\n\n# --- Configuration ---\nANSIBLE_DIR=\"ansible_dns_update\"\nINVENTORY_FILE=\"${ANSIBLE_DIR}/hosts.ini\"\nPLAYBOOK_FILE=\"${ANSIBLE_DIR}/update_dns.yml\"\n\n# Kubernetes Node IPs (ensure these match your actual VM IPs)\nKUBE_NODE_1_IP=\"10.75.59.71\"\nKUBE_NODE_2_IP=\"10.75.59.72\"\nKUBE_NODE_3_IP=\"10.75.59.73\"\n\n# Common Ansible user and Python interpreter\nANSIBLE_USER=\"ubuntu\"\nANSIBLE_PYTHON_INTERPRETER=\"/usr/bin/python3\"\n\n# --- Functions ---\n\n# Function to check and install Ansible\ninstall_ansible() {\n    if ! command -v ansible &> /dev/null\n    then\n        echo \"Ansible not found. Attempting to install Ansible...\"\n        if [ -f /etc/debian_version ]; then\n            # Debian/Ubuntu\n            sudo apt update\n            sudo apt install -y software-properties-common\n            sudo add-apt-repository --yes --update ppa:ansible/ansible\n            sudo apt install -y ansible\n        elif [ -f /etc/redhat-release ]; then\n            # CentOS/RHEL/Fedora\n            sudo yum install -y epel-release\n            sudo yum install -y ansible\n        else\n            echo \"Unsupported OS for automatic Ansible installation. Please install Ansible manually.\"\n            exit 1\n        fi\n        if ! command -v ansible &> /dev/null; then\n            echo \"Ansible installation failed. Please install it manually and re-run this script.\"\n            exit 1\n        fi\n        echo \"Ansible installed successfully.\"\n    else\n        echo \"Ansible is already installed.\"\n    fi\n}\n\n# Function to create Ansible inventory file\ncreate_inventory() {\n    echo \"Creating Ansible inventory file: ${INVENTORY_FILE}\"\n    mkdir -p \"$ANSIBLE_DIR\"\n    cat <<EOF > \"$INVENTORY_FILE\"\n[kubernetes_nodes]\nkube-node-1 ansible_host=${KUBE_NODE_1_IP}\nkube-node-2 ansible_host=${KUBE_NODE_2_IP}\nkube-node-3 ansible_host=${KUBE_NODE_3_IP}\n\n[all:vars]\nansible_user=${ANSIBLE_USER}\nansible_python_interpreter=${ANSIBLE_PYTHON_INTERPRETER}\nEOF\n    echo \"Inventory file created.\"\n}\n\n# Function to create Ansible playbook file\ncreate_playbook() {\n    echo \"Creating Ansible playbook file: ${PLAYBOOK_FILE}\"\n    mkdir -p \"$ANSIBLE_DIR\"\n    cat <<'EOF' > \"$PLAYBOOK_FILE\"\n---\n- name: Update DNS server on Kubernetes nodes to use local DNS only\n  hosts: kubernetes_nodes\n  become: yes # This allows Ansible to run commands with sudo privileges\n\n  tasks:\n    - name: Ensure netplan configuration directory exists\n      ansible.builtin.file:\n        path: /etc/netplan\n        state: directory\n        mode: '0755'\n\n    - name: Get current network configuration file (e.g., 00-installer-config.yaml)\n      ansible.builtin.find:\n        paths: /etc/netplan\n        patterns: '*.yaml'\n        # We assume there's only one primary netplan config file for simplicity.\n        # If there are multiple, you might need to specify which one.\n      register: netplan_files\n\n    - name: Set network config file variable\n      ansible.builtin.set_fact:\n        netplan_config_file: \"{{ netplan_files.files[0].path }}\"\n      when: netplan_files.files | length > 0\n\n    - name: Fail if no netplan config file found\n      ansible.builtin.fail:\n        msg: \"No Netplan configuration file found in /etc/netplan. Cannot proceed.\"\n      when: netplan_files.files | length == 0\n\n    - name: Read current netplan configuration\n      ansible.builtin.slurp:\n        src: \"{{ netplan_config_file }}\"\n      register: current_netplan_config\n\n    - name: Parse current netplan configuration\n      ansible.builtin.set_fact:\n        parsed_netplan: \"{{ current_netplan_config['content'] | b64decode | from_yaml }}\"\n\n    - name: Update nameservers in netplan configuration to local DNS only\n      ansible.builtin.set_fact:\n        updated_netplan: \"{{ parsed_netplan | combine(\n            {\n              'network': {\n                'ethernets': {\n                  'enp1s0': {\n                    'nameservers': {\n                      'addresses': ['10.75.59.76'],\n                      'search': ['cisco.com']\n                    }\n                  }\n                }\n              }\n            }, recursive=True) }}\"\n\n    - name: Write updated netplan configuration\n      ansible.builtin.copy:\n        content: \"{{ updated_netplan | to_yaml }}\"\n        dest: \"{{ netplan_config_file }}\"\n        mode: '0600'\n      notify: Apply Netplan Configuration\n\n  handlers:\n    - name: Apply Netplan Configuration\n      ansible.builtin.command: netplan apply\n      listen: \"Apply Netplan Configuration\"\nEOF\n    echo \"Playbook file created.\"\n}\n\n# --- Main Script Execution ---\n\necho \"Starting Ansible DNS update process...\"\n\n# 1. Install Ansible if not present\ninstall_ansible\n\n# 2. Create Ansible inventory file\ncreate_inventory\n\n# 3. Create Ansible playbook file\ncreate_playbook\n\n# 4. Run the Ansible playbook\necho \"Running Ansible playbook to update DNS on Kubernetes nodes...\"\necho \"You will be prompted for the 'sudo' password for the 'ubuntu' user on your VMs.\"\nansible-playbook -i \"$INVENTORY_FILE\" \"$PLAYBOOK_FILE\" --ask-become-pass\n\nif [ $? -eq 0 ]; then\n    echo \"Ansible playbook executed successfully.\"\n    echo \"Your Kubernetes nodes should now be configured to use 10.75.59.76 as their only DNS server.\"\nelse\n    echo \"Ansible playbook failed. Please check the output for errors.\"\nfi\n\necho \"Process complete.\"\n```\n\n```bash\nois@ois:~/data/k8s$ ./updatedns.sh \nStarting Ansible DNS update process...\nAnsible is already installed.\nCreating Ansible inventory file: ansible_dns_update/hosts.ini\nInventory file created.\nCreating Ansible playbook file: ansible_dns_update/update_dns.yml\nPlaybook file created.\nRunning Ansible playbook to update DNS on Kubernetes nodes...\nYou will be prompted for the 'sudo' password for the 'ubuntu' user on your VMs.\nBECOME password: \n\nPLAY [Update DNS server on Kubernetes nodes to use local DNS only] *********************************************************************************************************************************************************************************************\n\nTASK [Gathering Facts] *****************************************************************************************************************************************************************************************************************************************\nok: [kube-node-1]\nok: [kube-node-2]\nok: [kube-node-3]\n\nTASK [Ensure netplan configuration directory exists] ***********************************************************************************************************************************************************************************************************\nok: [kube-node-3]\nok: [kube-node-2]\nok: [kube-node-1]\n\nTASK [Get current network configuration file (e.g., 00-installer-config.yaml)] *********************************************************************************************************************************************************************************\nok: [kube-node-3]\nok: [kube-node-1]\nok: [kube-node-2]\n\nTASK [Set network config file variable] ************************************************************************************************************************************************************************************************************************\nok: [kube-node-1]\nok: [kube-node-2]\nok: [kube-node-3]\n\nTASK [Fail if no netplan config file found] ********************************************************************************************************************************************************************************************************************\nskipping: [kube-node-1]\nskipping: [kube-node-2]\nskipping: [kube-node-3]\n\nTASK [Read current netplan configuration] **********************************************************************************************************************************************************************************************************************\nok: [kube-node-3]\nok: [kube-node-1]\nok: [kube-node-2]\n\nTASK [Parse current netplan configuration] *********************************************************************************************************************************************************************************************************************\nok: [kube-node-1]\nok: [kube-node-2]\nok: [kube-node-3]\n\nTASK [Update nameservers in netplan configuration to local DNS only] *******************************************************************************************************************************************************************************************\nok: [kube-node-1]\nok: [kube-node-2]\nok: [kube-node-3]\n\nTASK [Write updated netplan configuration] *********************************************************************************************************************************************************************************************************************\nok: [kube-node-3]\nok: [kube-node-1]\nok: [kube-node-2]\n\nPLAY RECAP *****************************************************************************************************************************************************************************************************************************************************\nkube-node-1                : ok=8    changed=0    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   \nkube-node-2                : ok=8    changed=0    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   \nkube-node-3                : ok=8    changed=0    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   \n\nAnsible playbook executed successfully.\nYour Kubernetes nodes should now be configured to use 10.75.59.76 as their only DNS server.\nProcess complete.\n\nroot@kube-node-1:~# cat /etc/resolv.conf \n# This is /run/systemd/resolve/stub-resolv.conf managed by man:systemd-resolved(8).\n# Do not edit.\n#\n# This file might be symlinked as /etc/resolv.conf. If you're looking at\n# /etc/resolv.conf and seeing this text, you have followed the symlink.\n#\n# This is a dynamic resolv.conf file for connecting local clients to the\n# internal DNS stub resolver of systemd-resolved. This file lists all\n# configured search domains.\n#\n# Run \"resolvectl status\" to see details about the uplink DNS servers\n# currently in use.\n#\n# Third party programs should typically not access this file directly, but only\n# through the symlink at /etc/resolv.conf. To manage man:resolv.conf(5) in a\n# different way, replace this symlink by a static file or a different symlink.\n#\n# See man:systemd-resolved.service(8) for details about the supported modes of\n# operation for /etc/resolv.conf.\n\nnameserver 127.0.0.53\noptions edns0 trust-ad\nsearch cisco.com\nroot@kube-node-1:~# cat /etc/netplan/50-cloud-init.yaml \nnetwork:\n  ethernets:\n    enp1s0:\n      addresses: [10.75.59.71/24]\n      nameservers:\n        addresses: [10.75.59.76]\n        search: [cisco.com]\n      routes:\n      - {to: default, via: 10.75.59.1}\n  version: 2\n```\n\n## 3.4 使用Ansible配置FRR BGP\n\n```bash\n#!/bin/bash\n\n# This script automates the setup of an Ansible environment for installing and configuring FRRouting (FRR).\n# It creates the project directory, inventory, configuration, and the playbook\n# with an idempotent role to install and configure FRR.\n\n# --- Configuration ---\nPROJECT_DIR=\"ansible-frr-setup\" # Changed project directory name\nFRR_NODE_IP=\"10.75.59.76\" # IP address of your FRR VM (frr-server-vm)\nANSIBLE_USER=\"ubuntu\" # The user created by cloud-init on your VMs\nSSH_PRIVATE_KEY_PATH=\"~/.ssh/id_rsa\" # Path to your SSH private key on the Ansible control machine\n\n# FRR specific configuration\nFRR_AS=65000 # The Autonomous System number for this FRR node (example AS, choose your own)\nK8S_MASTER_IP=\"10.75.59.71\" # From your create-vms.sh script\nK8S_WORKER_1_IP=\"10.75.59.72\" # From your create-vms.sh script\nK8S_WORKER_2_IP=\"10.75.59.73\" # From your create-vms.sh script\nCILIUM_BGP_AS=65000 # AS for Cilium as per your CiliumBGPClusterConfig\n\n# --- Functions ---\n\n# Function to install Ansible (if not already installed)\ninstall_ansible() {\n    echo \"--- Installing Ansible ---\"\n    if ! command -v ansible &> /dev/null; then\n        sudo apt update -y\n        sudo apt install -y ansible\n        echo \"Ansible installed successfully.\"\n    else\n        echo \"Ansible is already installed.\"\n    fi\n}\n\n# Function to create project directory and navigate into it\ncreate_project_dir() {\n    echo \"--- Creating project directory: ${PROJECT_DIR} ---\"\n    # Check if directory exists, if so, just navigate, otherwise create and navigate\n    if [ ! -d \"${PROJECT_DIR}\" ]; then\n        mkdir -p \"${PROJECT_DIR}\"\n        echo \"Created new directory: ${PROJECT_DIR}\"\n    else\n        echo \"Directory ${PROJECT_DIR} already exists.\"\n    fi\n    cd \"${PROJECT_DIR}\" || { echo \"Failed to change directory to ${PROJECT_DIR}. Exiting.\"; exit 1; }\n    echo \"Changed to directory: $(pwd)\"\n}\n\n# Function to create ansible.cfg\ncreate_ansible_cfg() {\n    echo \"--- Creating ansible.cfg ---\"\n    cat <<EOF > ansible.cfg\n[defaults]\ninventory = inventory.ini\nroles_path = ./roles\nhost_key_checking = False # WARNING: Disable host key checking for convenience. Re-enable for production!\nEOF\n    echo \"ansible.cfg created.\"\n}\n\n# Function to create inventory.ini\ncreate_inventory() {\n    echo \"--- Creating inventory.ini ---\"\n    cat <<EOF > inventory.ini\n[frr_nodes]\nfrr-node-1 ansible_host=${FRR_NODE_IP}\n\n[all:vars]\nansible_user=${ANSIBLE_USER}\nansible_ssh_private_key_file=${SSH_PRIVATE_KEY_PATH}\nansible_python_interpreter=/usr/bin/python3\nFRR_AS=${FRR_AS}\nK8S_MASTER_IP=${K8S_MASTER_IP}\nK8S_WORKER_1_IP=${K8S_WORKER_1_IP}\nK8S_WORKER_2_IP=${K8S_WORKER_2_IP}\nCILIUM_BGP_AS=${CILIUM_BGP_AS}\nEOF\n    echo \"inventory.ini created.\"\n}\n\n# Function to create the main playbook.yml\ncreate_playbook() {\n    echo \"--- Creating playbook.yml ---\"\n    cat <<EOF > playbook.yml\n---\n- name: Install and Configure FRRouting (FRR)\n  hosts: frr_nodes\n  become: yes\n  roles:\n    - frr_setup # Changed role name to frr_setup\nEOF\n    echo \"playbook.yml created.\"\n}\n\n# Function to create the FRR installation and configuration role\ncreate_frr_role() { # Changed function name from create_gobgp_role\n    echo \"--- Creating Ansible role for FRR setup ---\"\n    mkdir -p roles/frr_setup/tasks\n    cat <<EOF > roles/frr_setup/tasks/main.yml\n---\n- name: Install FRRouting (FRR)\n  ansible.builtin.apt:\n    name: frr\n    state: present\n    update_cache: yes\n\n- name: Configure FRR daemons (enable zebra and bgpd)\n  ansible.builtin.lineinfile:\n    path: /etc/frr/daemons\n    regexp: '^(zebra|bgpd)='\n    line: '\\1=yes'\n    state: present\n    backrefs: yes # Required to make regexp work for replacement\n  notify: Restart FRR service\n\n- name: Configure frr.conf\n  ansible.builtin.copy:\n    dest: /etc/frr/frr.conf\n    content: |\n      !\n      hostname {{ ansible_hostname }}\n      password zebra\n      enable password zebra\n      !\n      log syslog informational\n      !\n      router bgp {{ FRR_AS }}\n       bgp router-id {{ ansible_host }}\n       !\n       neighbor {{ K8S_MASTER_IP }} remote-as {{ CILIUM_BGP_AS }}\n       neighbor {{ K8S_WORKER_1_IP }} remote-as {{ CILIUM_BGP_AS }}\n       neighbor {{ K8S_WORKER_2_IP }} remote-as {{ CILIUM_BGP_AS }}\n       !\n       address-family ipv4 unicast\n        # Crucial: Redistribute BGP learned routes into the kernel\n        redistribute connected\n        redistribute static\n        redistribute kernel\n       exit-address-family\n      !\n      line vty\n      !\n    mode: '0644'\n  notify: Restart FRR service # Handler only runs if file content changes\n\n- name: Set permissions for frr.conf\n  ansible.builtin.file:\n    path: /etc/frr/frr.conf\n    owner: frr\n    group: frr\n    mode: '0640'\n\n- name: Enable and start FRR service\n  ansible.builtin.systemd:\n    name: frr\n    state: started\n    enabled: yes\n    daemon_reload: yes # Ensure systemd reloads unit files if service file changed\n\nEOF\n\n    mkdir -p roles/frr_setup/handlers\n    cat <<EOF > roles/frr_setup/handlers/main.yml\n---\n- name: Restart FRR service\n  ansible.builtin.systemd:\n    name: frr\n    state: restarted\nEOF\n    echo \"FRR Ansible role created.\"\n}\n\n# --- Main execution ---\ninstall_ansible\ncreate_project_dir\ncreate_ansible_cfg\ncreate_inventory\ncreate_playbook\ncreate_frr_role # Changed function call\n\necho \"\"\necho \"--- Ansible setup for FRR installation is complete! ---\"\necho \"Navigate to the new project directory:\"\necho \"cd ${PROJECT_DIR}\"\necho \"\"\necho \"Then, run the Ansible playbook to install and configure FRR on your VM:\"\necho \"ansible-playbook playbook.yml -K\"\necho \"\"\necho \"After the playbook finishes, FRR should be running and configured on ${FRR_NODE_IP}.\"\necho \"You can SSH into the VM and verify with 'sudo vtysh -c \\\"show ip bgp summary\\\"' and 'sudo ip route show'.\"\n\nois@ois:~/data/k8s$ ./ansible-frr.sh \n--- Installing Ansible ---\nAnsible is already installed.\n--- Creating project directory: ansible-frr-setup ---\nCreated new directory: ansible-frr-setup\nChanged to directory: /home/ois/data/k8s/ansible-frr-setup\n--- Creating ansible.cfg ---\nansible.cfg created.\n--- Creating inventory.ini ---\ninventory.ini created.\n--- Creating playbook.yml ---\nplaybook.yml created.\n--- Creating Ansible role for FRR setup ---\nFRR Ansible role created.\n\n--- Ansible setup for FRR installation is complete! ---\nNavigate to the new project directory:\ncd ansible-frr-setup\n\nThen, run the Ansible playbook to install and configure FRR on your VM:\nansible-playbook playbook.yml -K\n\nAfter the playbook finishes, FRR should be running and configured on 10.75.59.76.\nYou can SSH into the VM and verify with 'sudo vtysh -c \"show ip bgp summary\"' and 'sudo ip route show'.\nois@ois:~/data/k8s$ cd ansible-frr-setup/\nois@ois:~/data/k8s/ansible-frr-setup$ ansible-playbook playbook.yml -K\nBECOME password: \n\nPLAY [Install and Configure FRRouting (FRR)] *******************************************************************************************************************************************************************************************************************\n\nTASK [Gathering Facts] *****************************************************************************************************************************************************************************************************************************************\nok: [frr-node-1]\n\nTASK [frr_setup : Install FRRouting (FRR)] *********************************************************************************************************************************************************************************************************************\nchanged: [frr-node-1]\n\nTASK [frr_setup : Configure FRR daemons (enable zebra and bgpd)] ***********************************************************************************************************************************************************************************************\nchanged: [frr-node-1]\n\nTASK [frr_setup : Configure frr.conf] **************************************************************************************************************************************************************************************************************************\nchanged: [frr-node-1]\n\nTASK [frr_setup : Set permissions for frr.conf] ****************************************************************************************************************************************************************************************************************\nchanged: [frr-node-1]\n\nTASK [frr_setup : Enable and start FRR service] ****************************************************************************************************************************************************************************************************************\nok: [frr-node-1]\n\nRUNNING HANDLER [frr_setup : Restart FRR service] **************************************************************************************************************************************************************************************************************\nchanged: [frr-node-1]\n\nPLAY RECAP *****************************************************************************************************************************************************************************************************************************************************\nfrr-node-1                 : ok=7    changed=5    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   \n\n```\n\n```bash\nroot@dns-server-vm:~# cat /etc/frr/frr.conf \n!\nhostname dns-server-vm\npassword zebra\nenable password zebra\n!\nlog syslog informational\n!\nrouter bgp 65000\n bgp router-id 10.75.59.76\n !\n neighbor 10.75.59.71 remote-as 65000\n neighbor 10.75.59.72 remote-as 65000\n neighbor 10.75.59.73 remote-as 65000\n !\n address-family ipv4 unicast\n  # Crucial: Redistribute BGP learned routes into the kernel\n  redistribute connected\n  redistribute static\n  redistribute kernel\n exit-address-family\n!\nline vty\n!\nroot@dns-server-vm:~# systemctl status frr\n* frr.service - FRRouting\n     Loaded: loaded (/usr/lib/systemd/system/frr.service; enabled; preset: enabled)\n     Active: active (running) since Wed 2025-07-23 12:16:58 JST; 1 week 1 day ago\n       Docs: https://frrouting.readthedocs.io/en/latest/setup.html\n    Process: 15611 ExecStart=/usr/lib/frr/frrinit.sh start (code=exited, status=0/SUCCESS)\n   Main PID: 15623 (watchfrr)\n     Status: \"FRR Operational\"\n      Tasks: 13 (limit: 9486)\n     Memory: 21.1M (peak: 28.3M)\n        CPU: 5min 23.845s\n     CGroup: /system.slice/frr.service\n             |-15623 /usr/lib/frr/watchfrr -d -F traditional zebra bgpd staticd\n             |-15636 /usr/lib/frr/zebra -d -F traditional -A 127.0.0.1 -s 90000000\n             |-15641 /usr/lib/frr/bgpd -d -F traditional -A 127.0.0.1\n             `-15648 /usr/lib/frr/staticd -d -F traditional -A 127.0.0.1\n\nJul 31 16:26:25 dns-server-vm bgpd[15641]: [M59KS-A3ZXZ] bgp_update_receive: rcvd End-of-RIB for IPv4 Unicast from 10.75.59.71 in vrf default\nJul 31 16:27:24 dns-server-vm bgpd[15641]: [M59KS-A3ZXZ] bgp_update_receive: rcvd End-of-RIB for IPv4 Unicast from 10.75.59.73 in vrf default\nJul 31 16:27:24 dns-server-vm bgpd[15641]: [M59KS-A3ZXZ] bgp_update_receive: rcvd End-of-RIB for IPv4 Unicast from 10.75.59.72 in vrf default\nJul 31 16:27:24 dns-server-vm bgpd[15641]: [M59KS-A3ZXZ] bgp_update_receive: rcvd End-of-RIB for IPv4 Unicast from 10.75.59.71 in vrf default\nJul 31 16:46:48 dns-server-vm bgpd[15641]: [M59KS-A3ZXZ] bgp_update_receive: rcvd End-of-RIB for IPv4 Unicast from 10.75.59.72 in vrf default\nJul 31 16:46:48 dns-server-vm bgpd[15641]: [M59KS-A3ZXZ] bgp_update_receive: rcvd End-of-RIB for IPv4 Unicast from 10.75.59.73 in vrf default\nJul 31 16:46:48 dns-server-vm bgpd[15641]: [M59KS-A3ZXZ] bgp_update_receive: rcvd End-of-RIB for IPv4 Unicast from 10.75.59.71 in vrf default\nJul 31 16:47:54 dns-server-vm bgpd[15641]: [M59KS-A3ZXZ] bgp_update_receive: rcvd End-of-RIB for IPv4 Unicast from 10.75.59.73 in vrf default\nJul 31 16:47:54 dns-server-vm bgpd[15641]: [M59KS-A3ZXZ] bgp_update_receive: rcvd End-of-RIB for IPv4 Unicast from 10.75.59.72 in vrf default\nJul 31 16:47:54 dns-server-vm bgpd[15641]: [M59KS-A3ZXZ] bgp_update_receive: rcvd End-of-RIB for IPv4 Unicast from 10.75.59.71 in vrf default\nroot@dns-server-vm:~# ip route show\ndefault via 10.75.59.1 dev enp1s0 proto static \n10.75.59.0/24 dev enp1s0 proto kernel scope link src 10.75.59.76 \n172.16.0.0/24 nhid 95 via 10.75.59.71 dev enp1s0 proto bgp metric 20 \n172.16.1.0/24 nhid 90 via 10.75.59.72 dev enp1s0 proto bgp metric 20 \n172.16.2.0/24 nhid 100 via 10.75.59.73 dev enp1s0 proto bgp metric 20 \n172.16.16.1 nhid 202 proto bgp metric 20 \n        nexthop via 10.75.59.72 dev enp1s0 weight 1 \n        nexthop via 10.75.59.71 dev enp1s0 weight 1 \n        nexthop via 10.75.59.73 dev enp1s0 weight 1 \n172.16.16.10 nhid 202 proto bgp metric 20 \n        nexthop via 10.75.59.72 dev enp1s0 weight 1 \n        nexthop via 10.75.59.71 dev enp1s0 weight 1 \n        nexthop via 10.75.59.73 dev enp1s0 weight 1 \n172.16.20.119 nhid 202 proto bgp metric 20 \n        nexthop via 10.75.59.72 dev enp1s0 weight 1 \n        nexthop via 10.75.59.71 dev enp1s0 weight 1 \n        nexthop via 10.75.59.73 dev enp1s0 weight 1 \n172.16.22.26 nhid 202 proto bgp metric 20 \n        nexthop via 10.75.59.72 dev enp1s0 weight 1 \n        nexthop via 10.75.59.71 dev enp1s0 weight 1 \n        nexthop via 10.75.59.73 dev enp1s0 weight 1 \n172.16.23.18 nhid 202 proto bgp metric 20 \n        nexthop via 10.75.59.72 dev enp1s0 weight 1 \n        nexthop via 10.75.59.71 dev enp1s0 weight 1 \n        nexthop via 10.75.59.73 dev enp1s0 weight 1 \n172.16.30.170 nhid 202 proto bgp metric 20 \n        nexthop via 10.75.59.72 dev enp1s0 weight 1 \n        nexthop via 10.75.59.71 dev enp1s0 weight 1 \n        nexthop via 10.75.59.73 dev enp1s0 weight 1 \nroot@dns-server-vm:~# vtysh -c 'show ip bgp summary'\n\nIPv4 Unicast Summary (VRF default):\nBGP router identifier 10.75.59.76, local AS number 65000 vrf-id 0\nBGP table version 222\nRIB entries 19, using 3648 bytes of memory\nPeers 3, using 2172 KiB of memory\n\nNeighbor        V         AS   MsgRcvd   MsgSent   TblVer  InQ OutQ  Up/Down State/PfxRcd   PfxSnt Desc\n10.75.59.71     4      65000     71265     71182        0    0    0 03:21:08            7        2 N/A\n10.75.59.72     4      65000     71344     71264        0    0    0 03:21:09            7        2 N/A\n10.75.59.73     4      65000     71240     71162        0    0    0 03:21:09            7        2 N/A\n\nTotal number of neighbors 3\n```\n\n# 4. 设置Kubernetes集群并安装CNI Cilium\n\n## 4.1 使用kubeadm设置Kubernetes\n\n使用以下命令进行集群初始化\n\n```bash\nkubeadm config images pull\n\nkubeadm init --control-plane-endpoint=kube-node-1 --pod-network-cidr=172.16.0.0/20 --service-cidr=172.16.32.0/20 --skip-phases=addon/kube-proxy\n\n--skip-phases=addon/kube-proxy 表示不安装kube-proxy，会用Cilium进行替代\n```\n\n```bash\nubuntu@kube-node-1:~$ sudo kubeadm init --control-plane-endpoint=kube-node-1 --pod-network-cidr=172.16.0.0/20 --service-cidr=172.16.32.0/20 --skip-phases=addon/kube-proxy[sudo] password for ubuntu: \n[init] Using Kubernetes version: v1.33.3\n[preflight] Running pre-flight checks\n[preflight] Pulling images required for setting up a Kubernetes cluster\n[preflight] This might take a minute or two, depending on the speed of your internet connection\n[preflight] You can also perform this action beforehand using 'kubeadm config images pull'\n[certs] Using certificateDir folder \"/etc/kubernetes/pki\"\n[certs] Generating \"ca\" certificate and key\n[certs] Generating \"apiserver\" certificate and key\n[certs] apiserver serving cert is signed for DNS names [kube-node-1 kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local] and IPs [10.248.0.1 10.75.59.71]\n[certs] Generating \"apiserver-kubelet-client\" certificate and key\n[certs] Generating \"front-proxy-ca\" certificate and key\n[certs] Generating \"front-proxy-client\" certificate and key\n[certs] Generating \"etcd/ca\" certificate and key\n[certs] Generating \"etcd/server\" certificate and key\n[certs] etcd/server serving cert is signed for DNS names [kube-node-1 localhost] and IPs [10.75.59.71 127.0.0.1 ::1]\n[certs] Generating \"etcd/peer\" certificate and key\n[certs] etcd/peer serving cert is signed for DNS names [kube-node-1 localhost] and IPs [10.75.59.71 127.0.0.1 ::1]\n[certs] Generating \"etcd/healthcheck-client\" certificate and key\n[certs] Generating \"apiserver-etcd-client\" certificate and key\n[certs] Generating \"sa\" key and public key\n[kubeconfig] Using kubeconfig folder \"/etc/kubernetes\"\n[kubeconfig] Writing \"admin.conf\" kubeconfig file\n[kubeconfig] Writing \"super-admin.conf\" kubeconfig file\n[kubeconfig] Writing \"kubelet.conf\" kubeconfig file\n[kubeconfig] Writing \"controller-manager.conf\" kubeconfig file\n[kubeconfig] Writing \"scheduler.conf\" kubeconfig file\n[etcd] Creating static Pod manifest for local etcd in \"/etc/kubernetes/manifests\"\n[control-plane] Using manifest folder \"/etc/kubernetes/manifests\"\n[control-plane] Creating static Pod manifest for \"kube-apiserver\"\n[control-plane] Creating static Pod manifest for \"kube-controller-manager\"\n[control-plane] Creating static Pod manifest for \"kube-scheduler\"\n[kubelet-start] Writing kubelet environment file with flags to file \"/var/lib/kubelet/kubeadm-flags.env\"\n[kubelet-start] Writing kubelet configuration to file \"/var/lib/kubelet/config.yaml\"\n[kubelet-start] Starting the kubelet\n[wait-control-plane] Waiting for the kubelet to boot up the control plane as static Pods from directory \"/etc/kubernetes/manifests\"\n[kubelet-check] Waiting for a healthy kubelet at http://127.0.0.1:10248/healthz. This can take up to 4m0s\n[kubelet-check] The kubelet is healthy after 1.002649961s\n[control-plane-check] Waiting for healthy control plane components. This can take up to 4m0s\n[control-plane-check] Checking kube-apiserver at https://10.75.59.71:6443/livez\n[control-plane-check] Checking kube-controller-manager at https://127.0.0.1:10257/healthz\n[control-plane-check] Checking kube-scheduler at https://127.0.0.1:10259/livez\n[control-plane-check] kube-controller-manager is healthy after 1.813351787s\n[control-plane-check] kube-scheduler is healthy after 3.309147352s\n[control-plane-check] kube-apiserver is healthy after 5.505049123s\n[upload-config] Storing the configuration used in ConfigMap \"kubeadm-config\" in the \"kube-system\" Namespace\n[kubelet] Creating a ConfigMap \"kubelet-config\" in namespace kube-system with the configuration for the kubelets in the cluster\n[upload-certs] Skipping phase. Please see --upload-certs\n[mark-control-plane] Marking the node kube-node-1 as control-plane by adding the labels: [node-role.kubernetes.io/control-plane node.kubernetes.io/exclude-from-external-load-balancers]\n[mark-control-plane] Marking the node kube-node-1 as control-plane by adding the taints [node-role.kubernetes.io/control-plane:NoSchedule]\n[bootstrap-token] Using token: 1r5ugd.o2pjzipcq69z71l8\n[bootstrap-token] Configuring bootstrap tokens, cluster-info ConfigMap, RBAC Roles\n[bootstrap-token] Configured RBAC rules to allow Node Bootstrap tokens to get nodes\n[bootstrap-token] Configured RBAC rules to allow Node Bootstrap tokens to post CSRs in order for nodes to get long term certificate credentials\n[bootstrap-token] Configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token\n[bootstrap-token] Configured RBAC rules to allow certificate rotation for all node client certificates in the cluster\n[bootstrap-token] Creating the \"cluster-info\" ConfigMap in the \"kube-public\" namespace\n[kubelet-finalize] Updating \"/etc/kubernetes/kubelet.conf\" to point to a rotatable kubelet client certificate and key\n[addons] Applied essential addon: CoreDNS\n\nYour Kubernetes control-plane has initialized successfully!\n\nTo start using your cluster, you need to run the following as a regular user:\n\n  mkdir -p $HOME/.kube\n  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config\n  sudo chown $(id -u):$(id -g) $HOME/.kube/config\n\nAlternatively, if you are the root user, you can run:\n\n  export KUBECONFIG=/etc/kubernetes/admin.conf\n\nYou should now deploy a pod network to the cluster.\nRun \"kubectl apply -f [podnetwork].yaml\" with one of the options listed at:\n  https://kubernetes.io/docs/concepts/cluster-administration/addons/\n\nYou can now join any number of control-plane nodes by copying certificate authorities\nand service account keys on each node and then running the following as root:\n\n  kubeadm join kube-node-1:6443 --token 1r5ugd.o2pjzipcq69z71l8 \\\n        --discovery-token-ca-cert-hash sha256:e29fb62581a4d21268585c3b345f9e060827c52a8325b1d28b8437c792ba7923 \\\n        --control-plane \n\nThen you can join any number of worker nodes by running the following on each as root:\n\nkubeadm join kube-node-1:6443 --token 1r5ugd.o2pjzipcq69z71l8 \\\n        --discovery-token-ca-cert-hash sha256:e29fb62581a4d21268585c3b345f9e060827c52a8325b1d28b8437c792ba7923 \nubuntu@kube-node-1:~$ \nubuntu@kube-node-1:~$   mkdir -p $HOME/.kube\n  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config\n  sudo chown $(id -u):$(id -g) $HOME/.kube/config\nubuntu@kube-node-1:~$ sudo su\nroot@kube-node-1:/home/ubuntu# cd\n\n在.bashrc 中增加以下内容\nroot@kube-node-1:~# cat .bashrc | grep export\nexport KUBECONFIG=/etc/kubernetes/admin.conf\n\n这样root才能执行 kubectl 命令与 api-server通信.\n\nroot@kube-node-1:~# kubectl cluster-info\nKubernetes control plane is running at https://kube-node-1:6443\nCoreDNS is running at https://kube-node-1:6443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy\n\nTo further debug and diagnose cluster problems, use 'kubectl cluster-info dump'.\nroot@kube-node-1:~# kubectl get node -o wide\nNAME          STATUS     ROLES           AGE   VERSION   INTERNAL-IP   EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION     CONTAINER-RUNTIME\nkube-node-1   NotReady   control-plane   68s   v1.33.3   10.75.59.71   <none>        Ubuntu 24.04.2 LTS   6.8.0-63-generic   containerd://1.7.27\n\n还没有安装CNI，Node NotReady\n\n```\n\n## 4.2 使用Ansible安装Helm\n\n设置Helm的目的是为了安装Cilium，并非一定要使用Ansible来进行设置，供参考。\n\n```bash\n#!/bin/bash\n\n# This script automates the setup of an Ansible environment for installing Helm.\n# It creates the project directory, inventory, configuration, and the playbook\n# with an idempotent role to install Helm.\n\n# --- Configuration ---\nPROJECT_DIR=\"ansible-helm\"\nMASTER_NODE_IP=\"10.75.59.71\" # IP address of your Kubernetes master node (kube-node-1)\nANSIBLE_USER=\"ubuntu\" # The user created by cloud-init on your VMs\nSSH_PRIVATE_KEY_PATH=\"~/.ssh/id_rsa\" # Path to your SSH private key on the Ansible control machine\n\n# Helm version to install\nHELM_VERSION=\"v3.18.4\" # You can change this to a desired stable version\n\n# --- Functions ---\n\n# Function to create project directory and navigate into it\ncreate_project_dir() {\n    echo \"--- Creating project directory: ${PROJECT_DIR} ---\"\n    # Check if directory exists, if so, just navigate, otherwise create and navigate\n    if [ ! -d \"${PROJECT_DIR}\" ]; then\n        mkdir -p \"${PROJECT_DIR}\"\n        echo \"Created new directory: ${PROJECT_DIR}\"\n    else\n        echo \"Directory ${PROJECT_DIR} already exists.\"\n    fi\n    cd \"${PROJECT_DIR}\" || { echo \"Failed to change directory to ${PROJECT_DIR}. Exiting.\"; exit 1; }\n    echo \"Changed to directory: $(pwd)\"\n}\n\n# Function to create ansible.cfg\ncreate_ansible_cfg() {\n    echo \"--- Creating ansible.cfg ---\"\n    cat <<EOF > ansible.cfg\n[defaults]\ninventory = inventory.ini\nroles_path = ./roles\nhost_key_checking = False # WARNING: Disable host key checking for convenience. Re-enable for production!\nEOF\n    echo \"ansible.cfg created.\"\n}\n\n# Function to create inventory.ini\ncreate_inventory() {\n    echo \"--- Creating inventory.ini ---\"\n    cat <<EOF > inventory.ini\n[kubernetes_master]\nkube-node-1 ansible_host=${MASTER_NODE_IP}\n\n[all:vars]\nansible_user=${ANSIBLE_USER}\nansible_ssh_private_key_file=${SSH_PRIVATE_KEY_PATH}\nansible_python_interpreter=/usr/bin/python3\nHELM_VERSION=${HELM_VERSION}\nEOF\n    echo \"inventory.ini created.\"\n}\n\n# Function to create the main playbook.yml\ncreate_playbook() {\n    echo \"--- Creating playbook.yml ---\"\n    cat <<EOF > playbook.yml\n---\n- name: Install Helm on Kubernetes Master Node\n  hosts: kubernetes_master\n  become: yes\n  environment: # Ensure KUBECONFIG is set for helm commands run with become\n    KUBECONFIG: /etc/kubernetes/admin.conf # Use the admin kubeconfig on the master\n  roles:\n    - helm_install\nEOF\n    echo \"playbook.yml created.\"\n}\n\n# Function to create the Helm installation role (with idempotent check)\ncreate_helm_role() {\n    echo \"--- Creating Ansible role for Helm installation ---\"\n    mkdir -p roles/helm_install/tasks\n    cat <<EOF > roles/helm_install/tasks/main.yml\n---\n- name: Check if Helm is installed and get version\n  ansible.builtin.command: helm version --short\n  register: helm_version_raw\n  ignore_errors: yes\n  changed_when: false\n\n- name: Set installed Helm version fact\n  ansible.builtin.set_fact:\n    installed_helm_version: \"{{ (helm_version_raw.stdout | default('') | regex_findall('^(v[0-9]+\\\\\\\\.[0-9]+\\\\\\\\.[0-9]+)') | first | default('') | trim) }}\"\n  changed_when: false\n\n- name: Debug installed Helm version\n  ansible.builtin.debug:\n    msg: \"Current installed Helm version: {{ installed_helm_version | default('Not installed') }}\"\n\n- name: Debug raw Helm version output\n  ansible.builtin.debug:\n    msg: \"Raw Helm version output: {{ helm_version_raw.stdout | default('No output') }}\"\n  when: helm_version_raw.stdout is defined and helm_version_raw.stdout | length > 0\n\n- name: Check if Helm binary exists\n  ansible.builtin.stat:\n    path: /usr/local/bin/helm\n  register: helm_binary_stat\n  when: installed_helm_version == HELM_VERSION\n\n- name: Download Helm tarball\n  ansible.builtin.get_url:\n    url: \"https://get.helm.sh/helm-{{ HELM_VERSION }}-linux-amd64.tar.gz\"\n    dest: \"/tmp/helm-{{ HELM_VERSION }}-linux-amd64.tar.gz\"\n    mode: '0644'\n    checksum: \"sha256:{{ lookup('url', 'https://get.helm.sh/helm-{{ HELM_VERSION }}-linux-amd64.tar.gz.sha256sum', wantlist=True)[0].split(' ')[0] }}\"\n  register: download_helm_result\n  until: download_helm_result is success\n  retries: 5\n  delay: 5\n  when: installed_helm_version != HELM_VERSION or not helm_binary_stat.stat.exists\n\n- name: Create Helm installation directory\n  ansible.builtin.file:\n    path: /usr/local/bin\n    state: directory\n    mode: '0755'\n  when: installed_helm_version != HELM_VERSION or not helm_binary_stat.stat.exists\n\n- name: Extract Helm binary\n  ansible.builtin.unarchive:\n    src: \"/tmp/helm-{{ HELM_VERSION }}-linux-amd64.tar.gz\"\n    dest: \"/tmp\"\n    remote_src: yes\n    creates: \"/tmp/linux-amd64/helm\"\n  when: installed_helm_version != HELM_VERSION or not helm_binary_stat.stat.exists\n\n- name: Move Helm binary to /usr/local/bin\n  ansible.builtin.copy:\n    src: \"/tmp/linux-amd64/helm\"\n    dest: \"/usr/local/bin/helm\"\n    mode: '0755'\n    remote_src: yes\n    owner: root\n    group: root\n  when: installed_helm_version != HELM_VERSION or not helm_binary_stat.stat.exists\n\n- name: Clean up Helm tarball and extracted directory\n  ansible.builtin.file:\n    path: \"{{ item }}\"\n    state: absent\n  loop:\n    - \"/tmp/helm-{{ HELM_VERSION }}-linux-amd64.tar.gz\"\n    - \"/tmp/linux-amd64\"\n  when: installed_helm_version != HELM_VERSION or not helm_binary_stat.stat.exists\n\n- name: Verify Helm installation\n  ansible.builtin.command: helm version --client\n  register: helm_version_output\n  changed_when: false\n\n- name: Display Helm version\n  ansible.builtin.debug:\n    msg: \"{{ helm_version_output.stdout }}\"\nEOF\n    echo \"Helm installation role created.\"\n}\n\n# --- Main execution ---\ncreate_project_dir\ncreate_ansible_cfg\ncreate_inventory\ncreate_playbook\ncreate_helm_role\n\necho \"\"\necho \"--- Ansible setup for Helm installation is complete! ---\"\necho \"Navigate to the new project directory:\"\necho \"cd ${PROJECT_DIR}\"\necho \"\"\necho \"Then, run the Ansible playbook to install only Helm on your master node:\"\necho \"ansible-playbook playbook.yml -K\"\necho \"\"\necho \"After Helm is installed, you can SSH into your master node (kube-node-1) and manage Cilium Enterprise installation directly using Helm.\"\necho \"Remember to use the correct Cilium chart version and your custom values file.\"\necho \"Example steps for manual Cilium installation via Helm:\"\necho \"ssh ubuntu@${MASTER_NODE_IP}\"\necho \"sudo helm repo add cilium https://helm.cilium.io/\"\necho \"sudo helm repo add isovalent https://helm.isovalent.com\"\necho \"sudo helm repo update\"\necho \"sudo helm install cilium isovalent/cilium --version 1.17.6 --namespace kube-system -f <path_to_your_cilium_values_file.yaml> --wait\"\necho \"Example content for /tmp/cilium-enterprise-values.yaml:\"\necho \"hubble:\"\necho \"  enabled: true\"\necho \"  relay:\"\necho \"    enabled: true\"\necho \"  ui:\"\necho \"    enabled: false\"\necho \"kubeProxyReplacement: strict\"\necho \"ipam:\"\necho \"  mode: kubernetes\"\necho \"ipv4NativeRoutingCIDR: 10.244.0.0/16\"\necho \"k8s:\"\necho \"  requireIPv4PodCIDR: true\"\necho \"routingMode: native\"\necho \"autoDirectNodeRoutes: false\"\necho \"bgpControlPlane:\"\necho \"  enabled: true\"\n```\n\n执行效果如下：\n\n```bash\nois@ois:~/data/k8s$ ./ansible-helm.sh \n--- Creating project directory: ansible-helm ---\nCreated new directory: ansible-helm\nChanged to directory: /home/ois/data/k8s/ansible-helm\n--- Creating ansible.cfg ---\nansible.cfg created.\n--- Creating inventory.ini ---\ninventory.ini created.\n--- Creating playbook.yml ---\nplaybook.yml created.\n--- Creating Ansible role for Helm installation ---\nHelm installation role created.\n\n--- Ansible setup for Helm installation is complete! ---\nNavigate to the new project directory:\ncd ansible-helm\n\nThen, run the Ansible playbook to install only Helm on your master node:\nansible-playbook playbook.yml -K\n\nAfter Helm is installed, you can SSH into your master node (kube-node-1) and manage Cilium Enterprise installation directly using Helm.\nRemember to use the correct Cilium chart version and your custom values file.\nExample steps for manual Cilium installation via Helm:\nssh ubuntu@10.75.59.71\nsudo helm repo add cilium https://helm.cilium.io/\nsudo helm repo add isovalent https://helm.isovalent.com\nsudo helm repo update\nsudo helm install cilium isovalent/cilium --version 1.17.6 --namespace kube-system -f <path_to_your_cilium_values_file.yaml> --wait\nExample content for /tmp/cilium-enterprise-values.yaml:\nhubble:\n  enabled: true\n  relay:\n    enabled: true\n  ui:\n    enabled: false\nkubeProxyReplacement: strict\nipam:\n  mode: kubernetes\nipv4NativeRoutingCIDR: 172.16.0.0/20\nk8s:\n  requireIPv4PodCIDR: true\nroutingMode: native\nautoDirectNodeRoutes: false\nbgpControlPlane:\n  enabled: true\nois@ois:~/data/k8s$ cd ansible-helm\nois@ois:~/data/k8s/ansible-helm$ ansible-playbook playbook.yml -K\nBECOME password: \n\nPLAY [Install Helm on Kubernetes Master Node] ******************************************************************************************************************************************************************************************************************\n\nTASK [Gathering Facts] *****************************************************************************************************************************************************************************************************************************************\nok: [kube-node-1]\n\nTASK [helm_install : Check if Helm is installed and get version] ***********************************************************************************************************************************************************************************************\nfatal: [kube-node-1]: FAILED! => {\"changed\": false, \"cmd\": \"helm version --short\", \"msg\": \"[Errno 2] No such file or directory: b'helm'\", \"rc\": 2, \"stderr\": \"\", \"stderr_lines\": [], \"stdout\": \"\", \"stdout_lines\": []}\n...ignoring\n\nTASK [helm_install : Set installed Helm version fact] **********************************************************************************************************************************************************************************************************\nok: [kube-node-1]\n\nTASK [helm_install : Debug installed Helm version] *************************************************************************************************************************************************************************************************************\nok: [kube-node-1] => {\n    \"msg\": \"Current installed Helm version: \"\n}\n\nTASK [helm_install : Debug raw Helm version output] ************************************************************************************************************************************************************************************************************\nskipping: [kube-node-1]\n\nTASK [helm_install : Check if Helm binary exists] **************************************************************************************************************************************************************************************************************\nskipping: [kube-node-1]\n\nTASK [helm_install : Download Helm tarball] ********************************************************************************************************************************************************************************************************************\nchanged: [kube-node-1]\n\nTASK [helm_install : Create Helm installation directory] *******************************************************************************************************************************************************************************************************\nok: [kube-node-1]\n\nTASK [helm_install : Extract Helm binary] **********************************************************************************************************************************************************************************************************************\nchanged: [kube-node-1]\n\nTASK [helm_install : Move Helm binary to /usr/local/bin] *******************************************************************************************************************************************************************************************************\nchanged: [kube-node-1]\n\nTASK [helm_install : Clean up Helm tarball and extracted directory] ********************************************************************************************************************************************************************************************\nchanged: [kube-node-1] => (item=/tmp/helm-v3.18.4-linux-amd64.tar.gz)\nchanged: [kube-node-1] => (item=/tmp/linux-amd64)\n\nTASK [helm_install : Verify Helm installation] *****************************************************************************************************************************************************************************************************************\nok: [kube-node-1]\n\nTASK [helm_install : Display Helm version] *********************************************************************************************************************************************************************************************************************\nok: [kube-node-1] => {\n    \"msg\": \"version.BuildInfo{Version:\\\"v3.18.4\\\", GitCommit:\\\"d80839cf37d860c8aa9a0503fe463278f26cd5e2\\\", GitTreeState:\\\"clean\\\", GoVersion:\\\"go1.24.4\\\"}\"\n}\n\nPLAY RECAP *****************************************************************************************************************************************************************************************************************************************************\nkube-node-1                : ok=11   changed=4    unreachable=0    failed=0    skipped=2    rescued=0    ignored=1   \n```\n\n## 4.3 使用Helm安装Cilium\n\n```bash\n\nroot@kube-node-1:~# helm repo add cilium https://helm.cilium.io/\n\"cilium\" has been added to your repositories\nroot@kube-node-1:~# helm repo add isovalent https://helm.isovalent.com\n\"isovalent\" has been added to your repositories\nroot@kube-node-1:~# \n\n准备配置文件如下：\n\nroot@kube-node-1:~# cat > cilium-enterprise-values.yaml <<EOF\nhubble:\n  enabled: true\n  relay:\n    enabled: true\n  ui:\n    enabled: false\n\n# Enable Gateway API\n#gatewayAPI:\n#  enabled: true\n\n# Explicitly disable Egress Gateway\n#egressGateway:\n#  enabled: false\n\n# BGP native-routing configuration\nipam:\n  mode: kubernetes\nipv4NativeRoutingCIDR: 172.16.0.0/20 # Advertises all pod CIDRs; ensure BGP router supports this\nk8s:\n  requireIPv4PodCIDR: true\nroutingMode: native\nautoDirectNodeRoutes: true\nbgpControlPlane:\n  enabled: true\n  # Configure BGP peers (replace with your BGP router details)\n  announce:\n    podCIDR: true # Advertise pod CIDRs to BGP peers\nenableIPv4Masquerade: true\n\n# Enable kube-proxy replacement\nkubeProxyReplacement: true\n\nbpf:\n  masquerade: true\n  lb:\n    externalClusterIP: true\n    sock: true\nEOF\n\nroot@kube-node-1:~# helm install cilium isovalent/cilium --version 1.17.6 \\\n    --namespace kube-system \\\n    --set kubeProxyReplacement=true \\\n    --set k8sServiceHost=10.75.59.71 \\\n    --set k8sServicePort=6443 \\\n    -f cilium-enterprise-values.yaml\nNAME: cilium\nLAST DEPLOYED: Fri Aug  1 09:54:27 2025\nNAMESPACE: kube-system\nSTATUS: deployed\nREVISION: 1\nTEST SUITE: None\nNOTES:\nYou have successfully installed Cilium with Hubble Relay.\n\nYour release version is 1.17.6.\n\nFor any further help, visit https://docs.isovalent.com/v1.17\n\n上述命令中的参数k8sServiceHost=10.75.59.71 和 k8sServicePort=6443 是不能少的。\n```\n\n```bash\n在其他Node上执行kubeadm join\n\nubuntu@kube-node-2:~$ sudo su\n[sudo] password for ubuntu: \nroot@kube-node-2:/home/ubuntu# cd\nroot@kube-node-2:~# kubeadm join kube-node-1:6443 --token wnc2sl.st6g6c4o0cd42bi4 \\\n        --discovery-token-ca-cert-hash sha256:381868d3e0faab6dbd3e240d8f40e0e81ab46cb54b2f15ffbfe0f587fac5d982 \n[preflight] Running pre-flight checks\n[preflight] Reading configuration from the \"kubeadm-config\" ConfigMap in namespace \"kube-system\"...\n[preflight] Use 'kubeadm init phase upload-config --config your-config-file' to re-upload it.\nW0801 09:56:27.830756   47851 configset.go:78] Warning: No kubeproxy.config.k8s.io/v1alpha1 config is loaded. Continuing without it: configmaps \"kube-proxy\" is forbidden: User \"system:bootstrap:wnc2sl\" cannot get resource \"configmaps\" in API group \"\" in the namespace \"kube-system\"\n[kubelet-start] Writing kubelet configuration to file \"/var/lib/kubelet/config.yaml\"\n[kubelet-start] Writing kubelet environment file with flags to file \"/var/lib/kubelet/kubeadm-flags.env\"\n[kubelet-start] Starting the kubelet\n[kubelet-check] Waiting for a healthy kubelet at http://127.0.0.1:10248/healthz. This can take up to 4m0s\n[kubelet-check] The kubelet is healthy after 1.503396779s\n[kubelet-start] Waiting for the kubelet to perform the TLS Bootstrap\n\nThis node has joined the cluster:\n* Certificate signing request was sent to apiserver and a response was received.\n* The Kubelet was informed of the new secure connection details.\n\nRun 'kubectl get nodes' on the control-plane to see this node join the cluster.\n\n```\n\n等待一段时间，Cilium、Hubble Relay即可Ready\n\n```bash\nroot@kube-node-1:~# kubectl get pods -n kube-system -o wide\nNAME                                  READY   STATUS    RESTARTS   AGE     IP            NODE          NOMINATED NODE   READINESS GATES\ncilium-2vrgj                          1/1     Running   0          3m58s   10.75.59.73   kube-node-3   <none>           <none>\ncilium-65kvc                          1/1     Running   0          4m14s   10.75.59.72   kube-node-2   <none>           <none>\ncilium-envoy-24sd7                    1/1     Running   0          4m14s   10.75.59.72   kube-node-2   <none>           <none>\ncilium-envoy-7pr4g                    1/1     Running   0          6m12s   10.75.59.71   kube-node-1   <none>           <none>\ncilium-envoy-k86tp                    1/1     Running   0          3m58s   10.75.59.73   kube-node-3   <none>           <none>\ncilium-operator-867fb7f659-2vnld      1/1     Running   0          6m12s   10.75.59.72   kube-node-2   <none>           <none>\ncilium-operator-867fb7f659-5998x      1/1     Running   0          6m12s   10.75.59.71   kube-node-1   <none>           <none>\ncilium-x4pr7                          1/1     Running   0          6m12s   10.75.59.71   kube-node-1   <none>           <none>\ncoredns-674b8bbfcf-6t8np              1/1     Running   0          13m     172.16.1.40   kube-node-2   <none>           <none>\ncoredns-674b8bbfcf-bx8xd              1/1     Running   0          13m     172.16.1.64   kube-node-2   <none>           <none>\netcd-kube-node-1                      1/1     Running   1          13m     10.75.59.71   kube-node-1   <none>           <none>\nhubble-relay-cfb755899-gch8w          1/1     Running   0          6m12s   172.16.1.81   kube-node-2   <none>           <none>\nkube-apiserver-kube-node-1            1/1     Running   1          13m     10.75.59.71   kube-node-1   <none>           <none>\nkube-controller-manager-kube-node-1   1/1     Running   1          13m     10.75.59.71   kube-node-1   <none>           <none>\nkube-scheduler-kube-node-1            1/1     Running   1          13m     10.75.59.71   kube-node-1   <none>           <none>\n```\n\n## 4.4 安装企业版Cilium-cli\n\n```bash\ncurl -L --remote-name-all https://github.com/isovalent/cilium-cli-releases/releases/latest/download/cilium-linux-amd64.tar.gz{,.sha256sum}\n\nsha256sum --check cilium-linux-amd64.tar.gz.sha256sum\n\ntar xzvfC cilium-linux-amd64.tar.gz /usr/local/bin\n\nroot@kube-node-1:~# cilium status\n    /¯¯\\\n /¯¯\\__/¯¯\\    Cilium:             OK\n \\__/¯¯\\__/    Operator:           OK\n /¯¯\\__/¯¯\\    Envoy DaemonSet:    OK\n \\__/¯¯\\__/    Hubble Relay:       OK\n    \\__/       ClusterMesh:        disabled\n\nDaemonSet              cilium                   Desired: 3, Ready: 3/3, Available: 3/3\nDaemonSet              cilium-envoy             Desired: 3, Ready: 3/3, Available: 3/3\nDeployment             cilium-operator          Desired: 2, Ready: 2/2, Available: 2/2\nDeployment             hubble-relay             Desired: 1, Ready: 1/1, Available: 1/1\nContainers:            cilium                   Running: 3\n                       cilium-envoy             Running: 3\n                       cilium-operator          Running: 2\n                       clustermesh-apiserver    \n                       hubble-relay             Running: 1\nCluster Pods:          3/3 managed by Cilium\nHelm chart version:    1.17.6\nImage versions         cilium             quay.io/isovalent/cilium:v1.17.6-cee.1@sha256:2d01daf4f25f7d644889b49ca856e1a4269981fc963e50bd3962665b41b6adb3: 3\n                       cilium-envoy       quay.io/isovalent/cilium-envoy:v1.17.6-cee.1@sha256:318eff387835ca2717baab42a84f35a83a5f9e7d519253df87269f80b9ff0171: 3\n                       cilium-operator    quay.io/isovalent/operator-generic:v1.17.6-cee.1@sha256:2e602710a7c4f101831df679e5d8251bae8bf0f9fe26c20bbef87f1966ea8265: 2\n                       hubble-relay       quay.io/isovalent/hubble-relay:v1.17.6-cee.1@sha256:d378e3607f7492374e65e2bd854cc0ec87480c63ba49a96dadcd75a6946b586e: 1\nroot@kube-node-1:~# \n```\n\n## 4.5 设置Cilium BGP\n\n```bash\nroot@kube-node-1:~#cat > cilium-bgp.yaml << EOF\n--- #bgp的对外宣告策略，宣告POD和serviceip\napiVersion: cilium.io/v2alpha1\nkind: CiliumBGPAdvertisement\nmetadata:\n  name: bgp-advertisements\n  labels:\n    advertise: bgp\nspec:\n  advertisements:\n    - advertisementType: \"PodCIDR\"              # Only for Kubernetes or ClusterPool IPAM cluster-pool\n    - advertisementType: \"Service\"\n      service:\n        addresses:\n          - ClusterIP\n          - ExternalIP\n          #- LoadBalancerIP\n      selector:\n        matchExpressions:\n        - {key: somekey, operator: NotIn, values: ['never-used-value']}                  # 等同于宣告所有\n\n--- #bgp邻居组的配置，类似template peer ,里面调用相关的advertisement策略\napiVersion: cilium.io/v2alpha1\nkind: CiliumBGPPeerConfig\nmetadata:\n  name: cilium-peer\nspec:\n  timers:\n    holdTimeSeconds: 30             #default 90s\n    keepAliveTimeSeconds: 10  #default 30s\n    connectRetryTimeSeconds: 40  #default 120s\n  gracefulRestart:\n    enabled: true\n    restartTimeSeconds: 120        #default 120s\n  #transport:\n  #  peerPort: 179\n  families:\n    - afi: ipv4\n      safi: unicast\n      advertisements:\n        matchLabels:\n          advertise: \"bgp\"\n\n--- #bgp的邻居配置\napiVersion: cilium.io/v2alpha1\nkind: CiliumBGPClusterConfig\nmetadata:\n  name: cilium-bgp-default\nspec:\n  bgpInstances:\n  - name: \"instance-65000\"\n    localASN: 65000\n    peers:\n    - name: \"GoBGP\"\n      peerASN: 65000\n      peerAddress: 10.75.59.76\n      peerConfigRef:\n        name: \"cilium-peer\"\nEOF\nroot@kube-node-1:~# \nroot@kube-node-1:~# \nroot@kube-node-1:~# kubectl apply -f cilium-bgp.yaml \nciliumbgpadvertisement.cilium.io/bgp-advertisements created\nciliumbgppeerconfig.cilium.io/cilium-peer created\nciliumbgpclusterconfig.cilium.io/cilium-bgp-default created\nroot@kube-node-1:~# cilium bgp peers\nNode          Local AS   Peer AS   Peer Address   Session State   Uptime   Family         Received   Advertised\nkube-node-1   65000      65000     10.75.59.76    established     7s       ipv4/unicast   2          6    \nkube-node-2   65000      65000     10.75.59.76    established     6s       ipv4/unicast   2          6    \nkube-node-3   65000      65000     10.75.59.76    established     6s       ipv4/unicast   2          6    \nroot@kube-node-1:~# cilium bgp routes\n(Defaulting to `available ipv4 unicast` routes, please see help for more options)\n\nNode          VRouter   Prefix             NextHop   Age   Attrs\nkube-node-1   65000     172.16.0.0/24      0.0.0.0   12s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n              65000     172.16.32.1/32     0.0.0.0   12s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n              65000     172.16.32.10/32    0.0.0.0   12s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n              65000     172.16.37.239/32   0.0.0.0   12s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n              65000     172.16.43.10/32    0.0.0.0   12s   [{Origin: i} {Nexthop: 0.0.0.0}]   \nkube-node-2   65000     172.16.1.0/24      0.0.0.0   12s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n              65000     172.16.32.1/32     0.0.0.0   12s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n              65000     172.16.32.10/32    0.0.0.0   12s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n              65000     172.16.37.239/32   0.0.0.0   12s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n              65000     172.16.43.10/32    0.0.0.0   12s   [{Origin: i} {Nexthop: 0.0.0.0}]   \nkube-node-3   65000     172.16.3.0/24      0.0.0.0   12s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n              65000     172.16.32.1/32     0.0.0.0   12s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n              65000     172.16.32.10/32    0.0.0.0   12s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n              65000     172.16.37.239/32   0.0.0.0   12s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n              65000     172.16.43.10/32    0.0.0.0   12s   [{Origin: i} {Nexthop: 0.0.0.0}]   \nroot@kube-node-1:~# \n```\n\n## 4.6 安装Hubble UI\n\n```bash\nroot@kube-node-1:~# helm search repo isovalent/hubble-ui -l\nNAME                    CHART VERSION   APP VERSION     DESCRIPTION         \nisovalent/hubble-ui     1.3.6           1.3.6           Hubble UI Enterprise\nisovalent/hubble-ui     1.3.5           1.3.5           Hubble UI Enterprise\n\nroot@kube-node-1:~# cat > hubble-ui-values.yaml << EOF\nrelay:\n  address: \"hubble-relay.kube-system.svc.cluster.local\"\nEOF\nroot@kube-node-1:~#  \nroot@kube-node-1:~# helm install hubble-ui isovalent/hubble-ui --version 1.3.6 --namespace kube-system --values hubble-ui-values.yaml --wait\nNAME: hubble-ui\nLAST DEPLOYED: Fri Aug  1 10:47:58 2025\nNAMESPACE: kube-system\nSTATUS: deployed\nREVISION: 1\nTEST SUITE: None\nNOTES:\nYou have successfully installed Hubble-Ui.\nYour release version is 1.3.6.\n\nFor any further help, visit https://docs.isovalent.com\nroot@kube-node-1:~# kubectl patch service hubble-ui -n kube-system -p '{\"spec\": {\"type\": \"NodePort\"}}'\nservice/hubble-ui patched\nroot@kube-node-1:~# kubectl get svc -n kube-system -o wide                                                                  \nNAME           TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                  AGE   SELECTOR\ncilium-envoy   ClusterIP   None            <none>        9964/TCP                 54m   k8s-app=cilium-envoy\nhubble-peer    ClusterIP   172.16.43.10    <none>        443/TCP                  54m   k8s-app=cilium\nhubble-relay   NodePort    172.16.37.239   <none>        80:31234/TCP             54m   k8s-app=hubble-relay\nhubble-ui      NodePort    172.16.35.177   <none>        80:31225/TCP             64s   k8s-app=hubble-ui\nkube-dns       ClusterIP   172.16.32.10    <none>        53/UDP,53/TCP,9153/TCP   61m   k8s-app=kube-dns\nroot@kube-node-1:~# kubectl -n kube-system exec ds/cilium -- cilium service list\nDefaulted container \"cilium-agent\" out of: cilium-agent, config (init), mount-cgroup (init), apply-sysctl-overwrites (init), mount-bpf-fs (init), clean-cilium-state (init), install-cni-binaries (init)\nID   Frontend                Service Type   Backend                               \n1    172.16.32.1:443/TCP     ClusterIP      1 => 10.75.59.71:6443/TCP (active)    \n2    172.16.43.10:443/TCP    ClusterIP      1 => 10.75.59.71:4244/TCP (active)    \n3    172.16.37.239:80/TCP    ClusterIP      1 => 172.16.1.81:4245/TCP (active)    \n4    10.75.59.71:31234/TCP   NodePort       1 => 172.16.1.81:4245/TCP (active)    \n5    0.0.0.0:31234/TCP       NodePort       1 => 172.16.1.81:4245/TCP (active)    \n6    172.16.32.10:53/TCP     ClusterIP      1 => 172.16.1.64:53/TCP (active)      \n                                            2 => 172.16.1.40:53/TCP (active)      \n7    172.16.32.10:9153/TCP   ClusterIP      1 => 172.16.1.64:9153/TCP (active)    \n                                            2 => 172.16.1.40:9153/TCP (active)    \n8    172.16.32.10:53/UDP     ClusterIP      1 => 172.16.1.64:53/UDP (active)      \n                                            2 => 172.16.1.40:53/UDP (active)      \n9    172.16.35.177:80/TCP    ClusterIP      1 => 172.16.3.127:8081/TCP (active)   \n10   10.75.59.71:31225/TCP   NodePort       1 => 172.16.3.127:8081/TCP (active)   \n11   0.0.0.0:31225/TCP       NodePort       1 => 172.16.3.127:8081/TCP (active)  \n\n浏览器可以通过http://10.75.59.71:31225/ 访问Hubble-ui\n\nroot@dns-server-vm:~# curl http://10.75.59.71:31225/\n<!doctype html><html><head><meta charset=\"utf-8\"/><title>Hubble UI Enterprise</title><meta http-equiv=\"X-UA-Compatible\" content=\"IE=edge\"/><meta name=\"viewport\" content=\"width=device-width,user-scalable=0,initial-scale=1,minimum-scale=1,maximum-scale=1\"/><link rel=\"icon\" type=\"image/png\" sizes=\"32x32\" href=\"/favicon-32x32.png\"/><link rel=\"icon\" type=\"image/png\" sizes=\"16x16\" href=\"/favicon-16x16.png\"/><link rel=\"shortcut icon\" href=\"/favicon.ico\"/><link rel=\"stylesheet\" href=\"/fonts/inter/stylesheet.css\"/><link rel=\"stylesheet\" href=\"/fonts/roboto-mono/stylesheet.css\"/><script defer=\"defer\" src=\"/bundle.app.77bec96f333a96efe6ea.js\"></script><link href=\"/bundle.app.f1e6c0c33f1535bc8508.css\" rel=\"stylesheet\"><script type=\"text/template\" id=\"hubble-ui/feature-flags\">[10, 0, 18, 0, 26, 0, 34, 0, 42, 0, 50, 0]</script><script type=\"text/template\" id=\"hubble-ui/authorization\">[8, 1, 26, 4, 24, 1, 32, 1]</script></head><body><div id=\"test-process-tree-char\" style=\"font-family: 'Roboto Mono', monospace;\n        font-size: 16px;\n        position: absolute;\n        visibility: hidden;\n        height: auto;\n        width: auto;\n        white-space: nowrap;\">a</div><div id=\"app\"></div></body></html>root@dns-server-vm:~# \nroot@dns-server-vm:~# \n```\n\n# 5. 部署Star Wars App\n\n## 5.1 部署APP\n\nIsovalent 提供了一个Demo APP，以下是部署脚本。\n\n```bash\nroot@kube-node-1:~# kubectl create namespace star-wars\nnamespace/star-wars created\nroot@kube-node-1:~# kubectl apply -n star-wars -f https://raw.githubusercontent.com/cilium/cilium/HEAD/examples/minikube/http-sw-app.yaml\nservice/deathstar created\ndeployment.apps/deathstar created\npod/tiefighter created\npod/xwing created\nroot@kube-node-1:~# kubectl -n star-wars get pod -o wide --show-labels\nNAME                         READY   STATUS    RESTARTS   AGE   IP             NODE          NOMINATED NODE   READINESS GATES   LABELS\ndeathstar-86f85ffb4d-4ldsj   1/1     Running   0          39s   172.16.1.231   kube-node-2   <none>           <none>            app.kubernetes.io/name=deathstar,class=deathstar,org=empire,pod-template-hash=86f85ffb4d\ndeathstar-86f85ffb4d-dbzft   1/1     Running   0          39s   172.16.3.161   kube-node-3   <none>           <none>            app.kubernetes.io/name=deathstar,class=deathstar,org=empire,pod-template-hash=86f85ffb4d\ntiefighter                   1/1     Running   0          39s   172.16.3.247   kube-node-3   <none>           <none>            app.kubernetes.io/name=tiefighter,class=tiefighter,org=empire\nxwing                        1/1     Running   0          39s   172.16.3.155   kube-node-3   <none>           <none>            app.kubernetes.io/name=xwing,class=xwing,org=alliance\nroot@kube-node-1:~# kubectl -n star-wars get service -o wide\nNAME        TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE   SELECTOR\ndeathstar   ClusterIP   172.16.39.138   <none>        80/TCP    82s   class=deathstar,org=empire\nroot@kube-node-1:~# kubectl -n star-wars patch service deathstar -p '{\"spec\":{\"type\":\"NodePort\"}}'\nservice/deathstar patched\nroot@kube-node-1:~# kubectl -n star-wars get service -o wide\nNAME        TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE    SELECTOR\ndeathstar   NodePort   172.16.39.138   <none>        80:32271/TCP   112s   class=deathstar,org=empire\nroot@kube-node-1:~# kubectl -n kube-system exec ds/cilium -- cilium service list\nDefaulted container \"cilium-agent\" out of: cilium-agent, config (init), mount-cgroup (init), apply-sysctl-overwrites (init), mount-bpf-fs (init), clean-cilium-state (init), install-cni-binaries (init)\nID   Frontend                Service Type   Backend                               \n1    172.16.32.1:443/TCP     ClusterIP      1 => 10.75.59.71:6443/TCP (active)    \n2    172.16.43.10:443/TCP    ClusterIP      1 => 10.75.59.71:4244/TCP (active)    \n3    172.16.37.239:80/TCP    ClusterIP      1 => 172.16.1.81:4245/TCP (active)    \n4    10.75.59.71:31234/TCP   NodePort       1 => 172.16.1.81:4245/TCP (active)    \n5    0.0.0.0:31234/TCP       NodePort       1 => 172.16.1.81:4245/TCP (active)    \n6    172.16.32.10:53/TCP     ClusterIP      1 => 172.16.1.64:53/TCP (active)      \n                                            2 => 172.16.1.40:53/TCP (active)      \n7    172.16.32.10:9153/TCP   ClusterIP      1 => 172.16.1.64:9153/TCP (active)    \n                                            2 => 172.16.1.40:9153/TCP (active)    \n8    172.16.32.10:53/UDP     ClusterIP      1 => 172.16.1.64:53/UDP (active)      \n                                            2 => 172.16.1.40:53/UDP (active)      \n9    172.16.35.177:80/TCP    ClusterIP      1 => 172.16.3.127:8081/TCP (active)   \n10   10.75.59.71:31225/TCP   NodePort       1 => 172.16.3.127:8081/TCP (active)   \n11   0.0.0.0:31225/TCP       NodePort       1 => 172.16.3.127:8081/TCP (active)   \n12   172.16.39.138:80/TCP    ClusterIP      1 => 172.16.3.161:80/TCP (active)     \n                                            2 => 172.16.1.231:80/TCP (active)     \n13   10.75.59.71:32271/TCP   NodePort       1 => 172.16.3.161:80/TCP (active)     \n                                            2 => 172.16.1.231:80/TCP (active)     \n14   0.0.0.0:32271/TCP       NodePort       1 => 172.16.3.161:80/TCP (active)     \n                                            2 => 172.16.1.231:80/TCP (active)     \n到这里就算部署成功了。\n\nroot@kube-node-1:~# kubectl -n star-wars exec tiefighter --   curl -s -XPOST http://deathstar.star-wars.svc.cluster.local/v1/request-landing\nShip landed\nroot@kube-node-1:~# kubectl -n star-wars exec xwing --   curl -s -XPOST http://deathstar.star-wars.svc.cluster.local/v1/request-landing\nShip landed\nroot@kube-node-1:~# \n\n在外部的设备也可以通过节点IP访问。\n\nroot@dns-server-vm:~# curl -s -XPOST http://10.75.59.72:32271/v1/request-landing\nShip landed\nroot@dns-server-vm:~# curl -s -XPOST http://10.75.59.71:32271/v1/request-landing\nShip landed\nroot@dns-server-vm:~# curl -s -XPOST http://10.75.59.73:32271/v1/request-landing\nShip landed\n```\n\n## 5.2 在Node外部抓包 ( Pod to Pod )\n\n```bash\n查找虚拟机连接在网桥上的网卡\n\nroot@ois:/home/ois/data/k8s# virsh list\n Id    Name                  State\n--------------------------------------\n 4     win1                  running\n 17    r1                    running\n 69    ubuntu-2404-desktop   running\n 96    dns-server-vm         running\n 97    u1                    running\n 98    ubuntu24042           running\n 99    kube-node-1           running\n 100   kube-node-2           running\n 101   kube-node-3           running\n\nroot@ois:/home/ois/data/k8s# virsh domiflist 99\n Interface   Type     Source   Model    MAC\n-----------------------------------------------------------\n vnet90      bridge   br0      virtio   52:54:00:90:8c:cf\n\nroot@ois:/home/ois/data/k8s# virsh domiflist 100\n Interface   Type     Source   Model    MAC\n-----------------------------------------------------------\n vnet91      bridge   br0      virtio   52:54:00:ba:d4:1f\n\nroot@ois:/home/ois/data/k8s# virsh domiflist 101\n Interface   Type     Source   Model    MAC\n-----------------------------------------------------------\n vnet92      bridge   br0      virtio   52:54:00:37:e0:96\n \n \n```\n\n```bash\n在Pod中发起访问\n\nroot@kube-node-1:~# kubectl -n star-wars get pods -o wide\nNAME                         READY   STATUS    RESTARTS   AGE    IP             NODE          NOMINATED NODE   READINESS GATES\ndeathstar-86f85ffb4d-4ldsj   1/1     Running   0          4m1s   172.16.1.231   kube-node-2   <none>           <none>\ndeathstar-86f85ffb4d-dbzft   1/1     Running   0          4m1s   172.16.3.161   kube-node-3   <none>           <none>\ntiefighter                   1/1     Running   0          4m1s   172.16.3.247   kube-node-3   <none>           <none>\nxwing                        1/1     Running   0          4m1s   172.16.3.155   kube-node-3   <none>           <none>\nroot@kube-node-1:~# kubectl -n star-wars exec xwing -- ip a                                                                            \n1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000\n    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00\n    inet 127.0.0.1/8 scope host lo\n       valid_lft forever preferred_lft forever\n    inet6 ::1/128 scope host \n       valid_lft forever preferred_lft forever\n11: eth0@if12: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP group default qlen 1000\n    link/ether f2:2a:b8:da:e7:d2 brd ff:ff:ff:ff:ff:ff link-netnsid 0\n    inet 172.16.3.155/32 scope global eth0\n       valid_lft forever preferred_lft forever\n    inet6 fe80::f02a:b8ff:feda:e7d2/64 scope link \n       valid_lft forever preferred_lft forever\nroot@kube-node-1:~# kubectl -n star-wars exec xwing -- ping 172.16.1.231\nerror: Internal error occurred: Internal error occurred: error executing command in container: failed to exec in container: failed to start exec \"1b1120795a5b60f35bac5a4056a1714a5c0df32762e2a79f272cf2c82089e970\": OCI runtime exec failed: exec failed: unable to start container process: exec: \"ping\": executable file not found in $PATH: unknown\nroot@kube-node-1:~# kubectl -n star-wars exec xwing -- curl -s http://172.16.1.231/v1\n{\n        \"name\": \"Death Star\",\n        \"hostname\": \"deathstar-86f85ffb4d-4ldsj\",\n        \"model\": \"DS-1 Orbital Battle Station\",\n        \"manufacturer\": \"Imperial Department of Military Research, Sienar Fleet Systems\",\n        \"cost_in_credits\": \"1000000000000\",\n        \"length\": \"120000\",\n        \"crew\": \"342953\",\n        \"passengers\": \"843342\",\n        \"cargo_capacity\": \"1000000000000\",\n        \"hyperdrive_rating\": \"4.0\",\n        \"starship_class\": \"Deep Space Mobile Battlestation\",\n        \"api\": [\n                \"GET   /v1\",\n                \"GET   /v1/healthz\",\n                \"POST  /v1/request-landing\",\n                \"PUT   /v1/cargobay\",\n                \"GET   /v1/hyper-matter-reactor/status\",\n                \"PUT   /v1/exhaust-port\"\n        ]\n}\n\n在宿主机上进行抓包，可以看到两者之间是直接路由的。\n\nroot@ois:/home/ois/data/k8s# tcpdump -i vnet92 -vn 'tcp port 80'\ntcpdump: listening on vnet92, link-type EN10MB (Ethernet), snapshot length 262144 bytes\n11:11:11.478887 IP (tos 0x0, ttl 63, id 25688, offset 0, flags [DF], proto TCP (6), length 60)\n    172.16.3.155.37162 > 172.16.1.231.80: Flags [S], cksum 0x5dd1 (incorrect -> 0xdb07), seq 542023762, win 64240, options [mss 1460,sackOK,TS val 1624400247 ecr 0,nop,wscale 7], length 0\n11:11:11.479178 IP (tos 0x0, ttl 63, id 0, offset 0, flags [DF], proto TCP (6), length 60)\n    172.16.1.231.80 > 172.16.3.155.37162: Flags [S.], cksum 0x5dd1 (incorrect -> 0x7b14), seq 3892089835, ack 542023763, win 65160, options [mss 1460,sackOK,TS val 727758081 ecr 1624400247,nop,wscale 7], length 0\n11:11:11.479479 IP (tos 0x0, ttl 63, id 25689, offset 0, flags [DF], proto TCP (6), length 52)\n    172.16.3.155.37162 > 172.16.1.231.80: Flags [.], cksum 0x5dc9 (incorrect -> 0xa673), ack 1, win 502, options [nop,nop,TS val 1624400247 ecr 727758081], length 0\n11:11:11.479552 IP (tos 0x0, ttl 63, id 25690, offset 0, flags [DF], proto TCP (6), length 130)\n    172.16.3.155.37162 > 172.16.1.231.80: Flags [P.], cksum 0x5e17 (incorrect -> 0x366d), seq 1:79, ack 1, win 502, options [nop,nop,TS val 1624400247 ecr 727758081], length 78: HTTP, length: 78\n        GET /v1 HTTP/1.1\n        Host: 172.16.1.231\n        User-Agent: curl/7.88.1\n        Accept: */*\n\n11:11:11.479684 IP (tos 0x0, ttl 63, id 13836, offset 0, flags [DF], proto TCP (6), length 52)\n    172.16.1.231.80 > 172.16.3.155.37162: Flags [.], cksum 0x5dc9 (incorrect -> 0xa61e), ack 79, win 509, options [nop,nop,TS val 727758081 ecr 1624400247], length 0\n11:11:11.480420 IP (tos 0x0, ttl 63, id 13837, offset 0, flags [DF], proto TCP (6), length 746)\n    172.16.1.231.80 > 172.16.3.155.37162: Flags [P.], cksum 0x607f (incorrect -> 0xc657), seq 1:695, ack 79, win 509, options [nop,nop,TS val 727758082 ecr 1624400247], length 694: HTTP, length: 694\n        HTTP/1.1 200 OK\n        Content-Type: text/plain\n        Date: Fri, 01 Aug 2025 03:11:11 GMT\n        Content-Length: 591\n\n        {\n                \"name\": \"Death Star\",\n                \"hostname\": \"deathstar-86f85ffb4d-4ldsj\",\n                \"model\": \"DS-1 Orbital Battle Station\",\n                \"manufacturer\": \"Imperial Department of Military Research, Sienar Fleet Systems\",\n                \"cost_in_credits\": \"1000000000000\",\n                \"length\": \"120000\",\n                \"crew\": \"342953\",\n                \"passengers\": \"843342\",\n                \"cargo_capacity\": \"1000000000000\",\n                \"hyperdrive_rating\": \"4.0\",\n                \"starship_class\": \"Deep Space Mobile Battlestation\",\n                \"api\": [\n                        \"GET   /v1\",\n                        \"GET   /v1/healthz\",\n                        \"POST  /v1/request-landing\",\n                        \"PUT   /v1/cargobay\",\n                        \"GET   /v1/hyper-matter-reactor/status\",\n                        \"PUT   /v1/exhaust-port\"\n                ]\n        }       \n```\n\nCilium将各个Node对应的Pod路由自动安装了\n\n```bash\nroot@kube-node-3:~# ip route show\ndefault via 10.75.59.1 dev enp1s0 proto static \n10.75.59.0/24 dev enp1s0 proto kernel scope link src 10.75.59.73 \n172.16.0.0/24 via 10.75.59.71 dev enp1s0 proto kernel \n172.16.1.0/24 via 10.75.59.72 dev enp1s0 proto kernel \n172.16.3.0/24 via 172.16.3.22 dev cilium_host proto kernel src 172.16.3.22 \n172.16.3.22 dev cilium_host proto kernel scope link \nroot@kube-node-3:~# route -n\nKernel IP routing table\nDestination     Gateway         Genmask         Flags Metric Ref    Use Iface\n0.0.0.0         10.75.59.1      0.0.0.0         UG    0      0        0 enp1s0\n10.75.59.0      0.0.0.0         255.255.255.0   U     0      0        0 enp1s0\n172.16.0.0      10.75.59.71     255.255.255.0   UG    0      0        0 enp1s0\n172.16.1.0      10.75.59.72     255.255.255.0   UG    0      0        0 enp1s0\n172.16.3.0      172.16.3.22     255.255.255.0   UG    0      0        0 cilium_host\n172.16.3.22     0.0.0.0         255.255.255.255 UH    0      0        0 cilium_host\n\nroot@kube-node-2:~# ip route show\ndefault via 10.75.59.1 dev enp1s0 proto static \n10.75.59.0/24 dev enp1s0 proto kernel scope link src 10.75.59.72 \n172.16.0.0/24 via 10.75.59.71 dev enp1s0 proto kernel \n172.16.1.0/24 via 172.16.1.128 dev cilium_host proto kernel src 172.16.1.128 \n172.16.1.128 dev cilium_host proto kernel scope link \n172.16.3.0/24 via 10.75.59.73 dev enp1s0 proto kernel \nroot@kube-node-2:~# route -n\nKernel IP routing table\nDestination     Gateway         Genmask         Flags Metric Ref    Use Iface\n0.0.0.0         10.75.59.1      0.0.0.0         UG    0      0        0 enp1s0\n10.75.59.0      0.0.0.0         255.255.255.0   U     0      0        0 enp1s0\n172.16.0.0      10.75.59.71     255.255.255.0   UG    0      0        0 enp1s0\n172.16.1.0      172.16.1.128    255.255.255.0   UG    0      0        0 cilium_host\n172.16.1.128    0.0.0.0         255.255.255.255 UH    0      0        0 cilium_host\n172.16.3.0      10.75.59.73     255.255.255.0   UG    0      0        0 enp1s0\n```\n\n在Hubble UI中，可以看到详细的Flow\n\n```json\n{\n  \"uuid\": \"2af76725-f6f9-49b4-b9f1-8d01b3f14930\",\n  \"verdict\": 1,\n  \"drop_reason\": 0,\n  \"auth_type\": 0,\n  \"Type\": 1,\n  \"node_name\": \"kube-node-2\",\n  \"node_labels\": [\n    \"beta.kubernetes.io/arch=amd64\",\n    \"beta.kubernetes.io/os=linux\",\n    \"kubernetes.io/arch=amd64\",\n    \"kubernetes.io/hostname=kube-node-2\",\n    \"kubernetes.io/os=linux\"\n  ],\n  \"source_names\": [],\n  \"destination_names\": [],\n  \"reply\": false,\n  \"traffic_direction\": 2,\n  \"policy_match_type\": 0,\n  \"trace_observation_point\": 101,\n  \"trace_reason\": 1,\n  \"drop_reason_desc\": 0,\n  \"debug_capture_point\": 0,\n  \"proxy_port\": 0,\n  \"sock_xlate_point\": 0,\n  \"socket_cookie\": 0,\n  \"cgroup_id\": 0,\n  \"Summary\": \"TCP Flags: SYN\",\n  \"egress_allowed_by\": [],\n  \"ingress_allowed_by\": [],\n  \"egress_denied_by\": [],\n  \"ingress_denied_by\": [],\n  \"time\": {\n    \"seconds\": 1754022736,\n    \"nanos\": 962926009\n  },\n  \"ethernet\": {\n    \"source\": \"f2:64:9f:b5:8e:81\",\n    \"destination\": \"82:31:36:d1:5a:00\"\n  },\n  \"IP\": {\n    \"source\": \"172.16.3.155\",\n    \"source_xlated\": \"\",\n    \"destination\": \"172.16.1.231\",\n    \"ipVersion\": 1,\n    \"encrypted\": false\n  },\n  \"l4\": {\n    \"protocol\": {\n      \"oneofKind\": \"TCP\",\n      \"TCP\": {\n        \"source_port\": 38680,\n        \"destination_port\": 80,\n        \"flags\": {\n          \"FIN\": false,\n          \"SYN\": true,\n          \"RST\": false,\n          \"PSH\": false,\n          \"ACK\": false,\n          \"URG\": false,\n          \"ECE\": false,\n          \"CWR\": false,\n          \"NS\": false\n        }\n      }\n    }\n  },\n  \"source\": {\n    \"ID\": 0,\n    \"identity\": 36770,\n    \"cluster_name\": \"default\",\n    \"namespace\": \"star-wars\",\n    \"labels\": [\n      \"k8s:app.kubernetes.io/name=xwing\",\n      \"k8s:class=xwing\",\n      \"k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=star-wars\",\n      \"k8s:io.cilium.k8s.policy.cluster=default\",\n      \"k8s:io.cilium.k8s.policy.serviceaccount=default\",\n      \"k8s:io.kubernetes.pod.namespace=star-wars\",\n      \"k8s:org=alliance\"\n    ],\n    \"pod_name\": \"xwing\",\n    \"workloads\": []\n  },\n  \"destination\": {\n    \"ID\": 284,\n    \"identity\": 15153,\n    \"cluster_name\": \"default\",\n    \"namespace\": \"star-wars\",\n    \"labels\": [\n      \"k8s:app.kubernetes.io/name=deathstar\",\n      \"k8s:class=deathstar\",\n      \"k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=star-wars\",\n      \"k8s:io.cilium.k8s.policy.cluster=default\",\n      \"k8s:io.cilium.k8s.policy.serviceaccount=default\",\n      \"k8s:io.kubernetes.pod.namespace=star-wars\",\n      \"k8s:org=empire\"\n    ],\n    \"pod_name\": \"deathstar-86f85ffb4d-4ldsj\",\n    \"workloads\": [\n      {\n        \"name\": \"deathstar\",\n        \"kind\": \"Deployment\"\n      }\n    ]\n  },\n  \"event_type\": {\n    \"type\": 4,\n    \"sub_type\": 0\n  },\n  \"is_reply\": {\n    \"value\": false\n  },\n  \"interface\": {\n    \"index\": 14,\n    \"name\": \"lxcf734e435e18a\"\n  }\n}\n```\n\n## 5.3 在Node外部抓包 ( Pod to External )\n\n接下来，在Pod内部访问Internet进行测试。\n\n```bash\nroot@kube-node-1:~# kubectl get configmap cilium-config -n kube-system -o yaml | grep -E 'enable-ipv4-masquerade|enable-bpf-masquerade'\n  enable-bpf-masquerade: \"true\"\n  enable-ipv4-masquerade: \"true\"\n  \nPod xwing 位于Kube-node3，在Node3查看\n\nroot@kube-node-1:~# kubectl get pods -n kube-system -l k8s-app=cilium -o wide | grep kube-node-3\ncilium-2vrgj   1/1     Running   0          106m   10.75.59.73   kube-node-3   <none>           <none>\n\nroot@kube-node-1:~# kubectl -n star-wars exec xwing -- curl -s https://echo.free.beeceptor.com\n{\n  \"method\": \"GET\",\n  \"protocol\": \"https\",\n  \"host\": \"echo.free.beeceptor.com\",\n  \"path\": \"/\",\n  \"ip\": \"64.104.44.105:35834\",\n  \"headers\": {\n    \"Host\": \"echo.free.beeceptor.com\",\n    \"User-Agent\": \"curl/7.88.1\",\n    \"Accept\": \"*/*\",\n    \"Via\": \"2.0 Caddy\",\n    \"Accept-Encoding\": \"gzip\"\n  },\n  \"parsedQueryParams\": {}\n}root@kube-node-1:~# \nroot@kube-node-1:~# \n\n使用 cilium bpf nat list 查看NAT表\n\nroot@kube-node-1:~# kubectl exec -n kube-system cilium-2vrgj -- cilium bpf nat list | grep 172.16.3.155\nDefaulted container \"cilium-agent\" out of: cilium-agent, config (init), mount-cgroup (init), apply-sysctl-overwrites (init), mount-bpf-fs (init), clean-cilium-state (init), install-cni-binaries (init)\nTCP OUT 172.16.3.155:35834 -> 147.182.252.2:443 XLATE_SRC 10.75.59.73:35834 Created=4sec ago NeedsCT=0\nTCP IN 147.182.252.2:443 -> 10.75.59.73:35834 XLATE_DST 172.16.3.155:35834 Created=4sec ago NeedsCT=0\nroot@kube-node-1:~# \nroot@kube-node-1:~# \n\n在外部的抓包：\nroot@ois:/home/ois/data/k8s# tcpdump -i vnet92 -vn 'tcp port 443'\ntcpdump: listening on vnet92, link-type EN10MB (Ethernet), snapshot length 262144 bytes\n12:28:22.307306 IP (tos 0x0, ttl 63, id 45759, offset 0, flags [DF], proto TCP (6), length 60)\n    10.75.59.73.49208 > 147.182.252.2.443: Flags [S], cksum 0xd57b (incorrect -> 0x363a), seq 3275650602, win 64240, options [mss 1460,sackOK,TS val 493037768 ecr 0,nop,wscale 7], length 0\n12:28:22.477754 IP (tos 0x0, ttl 42, id 0, offset 0, flags [DF], proto TCP (6), length 60)\n    147.182.252.2.443 > 10.75.59.73.49208: Flags [S.], cksum 0xed16 (correct), seq 450982431, ack 3275650603, win 65160, options [mss 1254,sackOK,TS val 1573215106 ecr 493037768,nop,wscale 7], length 0\n12:28:22.478053 IP (tos 0x0, ttl 63, id 45760, offset 0, flags [DF], proto TCP (6), length 52)\n    10.75.59.73.49208 > 147.182.252.2.443: Flags [.], cksum 0xd573 (incorrect -> 0x16fd), ack 1, win 502, options [nop,nop,TS val 493037939 ecr 1573215106], length 0\n12:28:22.490922 IP (tos 0x0, ttl 63, id 45761, offset 0, flags [DF], proto TCP (6), length 569)\n    10.75.59.73.49208 > 147.182.252.2.443: Flags [P.], cksum 0xd778 (incorrect -> 0x1d27), seq 1:518, ack 1, win 502, options [nop,nop,TS val 493037952 ecr 1573215106], length 517\n```\n\n# 6. 安装K8S和Cilium脚本自动化\n\n接下来打算把K8S和Cilium的安装脚本自动化。\n\n首先需要解决在kube-node-1 能 无密码登录到kube-node-2 和 kube-node-3。\n\n## 6.1 无密码登录设置\n\n```bash\n#!/bin/bash\n\n# --- Configuration ---\nANSIBLE_DIR=\"ansible_ssh_setup\"\nINVENTORY_FILE=\"${ANSIBLE_DIR}/hosts.ini\"\nPLAYBOOK_FILE=\"${ANSIBLE_DIR}/setup_ssh.yml\"\n\n# Kubernetes Node IPs\nKUBE_NODE_1_IP=\"10.75.59.71\"\nKUBE_NODE_2_IP=\"10.75.59.72\"\nKUBE_NODE_3_IP=\"10.75.59.73\"\n\n# Common Ansible user and Python interpreter\nANSIBLE_USER=\"ubuntu\"\nANSIBLE_PYTHON_INTERPRETER=\"/usr/bin/python3\"\n\n# --- Functions ---\n\n# Function to check and install Ansible\ninstall_ansible() {\n    if ! command -v ansible &> /dev/null\n    then\n        echo \"Ansible not found. Attempting to install Ansible...\"\n        if [ -f /etc/debian_version ]; then\n            # Debian/Ubuntu\n            sudo apt update\n            sudo apt install -y software-properties-common\n            sudo add-apt-repository --yes --update ppa:ansible/ansible\n            sudo apt install -y ansible\n        elif [ -f /etc/redhat-release ]; then\n            # CentOS/RHEL/Fedora\n            sudo yum install -y epel-release\n            sudo yum install -y ansible\n        else\n            echo \"Unsupported OS for automatic Ansible installation. Please install Ansible manually.\"\n            exit 1\n        fi\n        if ! command -v ansible &> /dev/null; then\n            echo \"Ansible installation failed. Please install it manually and re-run this script.\"\n            exit 1\n        fi\n        echo \"Ansible installed successfully.\"\n    else\n        echo \"Ansible is already installed.\"\n    fi\n}\n\n# Function to create Ansible inventory file\ncreate_inventory() {\n    echo \"Creating Ansible inventory file: ${INVENTORY_FILE}\"\n    mkdir -p \"$ANSIBLE_DIR\"\n    cat <<EOF > \"$INVENTORY_FILE\"\n[kubernetes_nodes]\nkube-node-1 ansible_host=${KUBE_NODE_1_IP}\nkube-node-2 ansible_host=${KUBE_NODE_2_IP}\nkube-node-3 ansible_host=${KUBE_NODE_3_IP}\n\n[all:vars]\nansible_user=${ANSIBLE_USER}\nansible_python_interpreter=${ANSIBLE_PYTHON_INTERPRETER}\nEOF\n    echo \"Inventory file created.\"\n}\n\n# Function to create Ansible playbook file\ncreate_playbook() {\n    echo \"Creating Ansible playbook file: ${PLAYBOOK_FILE}\"\n    mkdir -p \"$ANSIBLE_DIR\"\n    cat <<'EOF' > \"$PLAYBOOK_FILE\"\n---\n- name: Generate SSH key on kube-node-1 and distribute to other nodes\n  hosts: kubernetes_nodes\n  become: yes\n\n  tasks:\n    - name: Generate SSH key on kube-node-1\n      ansible.builtin.command:\n        cmd: ssh-keygen -t rsa -b 4096 -N \"\" -f /root/.ssh/id_rsa\n        creates: /root/.ssh/id_rsa\n      when: inventory_hostname == 'kube-node-1'\n\n    - name: Ensure .ssh directory exists on all nodes\n      ansible.builtin.file:\n        path: /root/.ssh\n        state: directory\n        mode: '0700'\n\n    - name: Ensure authorized_keys file exists\n      ansible.builtin.file:\n        path: /root/.ssh/authorized_keys\n        state: touch\n        mode: '0600'\n\n    - name: Fetch public key from kube-node-1\n      ansible.builtin.slurp:\n        src: /root/.ssh/id_rsa.pub\n      register: ssh_public_key\n      when: inventory_hostname == 'kube-node-1'\n\n    - name: Distribute public key to kube-node-2 and kube-node-3\n      ansible.builtin.lineinfile:\n        path: /root/.ssh/authorized_keys\n        line: \"{{ hostvars['kube-node-1']['ssh_public_key']['content'] | b64decode }}\"\n        state: present\n      when: inventory_hostname in ['kube-node-2', 'kube-node-3']\nEOF\n    echo \"Playbook file created.\"\n}\n\n# --- Main Script Execution ---\n\necho \"Starting Ansible SSH key setup process...\"\n\n# 1. Install Ansible if not present\ninstall_ansible\n\n# 2. Create Ansible inventory file\ncreate_inventory\n\n# 3. Create Ansible playbook file\ncreate_playbook\n\necho \"Setup complete. You can now run the Ansible playbook manually using:\"\necho \"ansible-playbook -i \\\"$INVENTORY_FILE\\\" \\\"$PLAYBOOK_FILE\\\" --ask-become-pass\"\necho \"You will be prompted for the 'sudo' password for the 'ubuntu' user on your VMs.\"\necho \"Process complete.\"\n```\n\n```bash\nchmod +x ansible_ssh.sh\n./ansible_ssh.sh\n\nois@ois:~/data/k8s$ ./ansible_ssh.sh\nStarting Ansible SSH key setup process...\nAnsible is already installed.\nCreating Ansible inventory file: ansible_ssh_setup/hosts.ini\nInventory file created.\nCreating Ansible playbook file: ansible_ssh_setup/setup_ssh.yml\nPlaybook file created.\nSetup complete. You can now run the Ansible playbook manually using:\nansible-playbook -i \"ansible_ssh_setup/hosts.ini\" \"ansible_ssh_setup/setup_ssh.yml\" --ask-become-pass\nYou will be prompted for the 'sudo' password for the 'ubuntu' user on your VMs.\nProcess complete.\nois@ois:~/data/k8s$ cd ansible_ssh_setup/\nois@ois:~/data/k8s/ansible_ssh_setup$ ansible-playbook setup_ssh.yml -i hosts.ini -K\nBECOME password: \n\nPLAY [Generate SSH key on kube-node-1 and distribute to other nodes] ********************************************************************************************************\n\nTASK [Gathering Facts] ******************************************************************************************************************************************************\nok: [kube-node-1]\nok: [kube-node-3]\nok: [kube-node-2]\n\nTASK [Generate SSH key on kube-node-1] **************************************************************************************************************************************\nskipping: [kube-node-2]\nskipping: [kube-node-3]\nchanged: [kube-node-1]\n\nTASK [Ensure .ssh directory exists on all nodes] ****************************************************************************************************************************\nok: [kube-node-2]\nok: [kube-node-1]\nok: [kube-node-3]\n\nTASK [Ensure authorized_keys file exists] ***********************************************************************************************************************************\nchanged: [kube-node-1]\nchanged: [kube-node-2]\nchanged: [kube-node-3]\n\nTASK [Fetch public key from kube-node-1] ************************************************************************************************************************************\nskipping: [kube-node-2]\nskipping: [kube-node-3]\nok: [kube-node-1]\n\nTASK [Distribute public key to kube-node-2 and kube-node-3] *****************************************************************************************************************\nskipping: [kube-node-1]\nchanged: [kube-node-3]\nchanged: [kube-node-2]\n\nPLAY RECAP ******************************************************************************************************************************************************************\nkube-node-1                : ok=5    changed=2    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   \nkube-node-2                : ok=4    changed=2    unreachable=0    failed=0    skipped=2    rescued=0    ignored=0   \nkube-node-3                : ok=4    changed=2    unreachable=0    failed=0    skipped=2    rescued=0    ignored=0   \n```\n\n效果：\n\n```bash\nroot@kube-node-1:~# ssh root@10.75.59.72\nWelcome to Ubuntu 24.04.2 LTS (GNU/Linux 6.8.0-63-generic x86_64)\n\n * Documentation:  https://help.ubuntu.com\n * Management:     https://landscape.canonical.com\n * Support:        https://ubuntu.com/pro\n\n System information as of Fri Aug  1 02:28:23 PM CST 2025\n\n  System load:  0.13               Processes:               188\n  Usage of /:   30.2% of 18.33GB   Users logged in:         1\n  Memory usage: 10%                IPv4 address for enp1s0: 10.75.59.72\n  Swap usage:   0%\n\n * Strictly confined Kubernetes makes edge and IoT secure. Learn how MicroK8s\n   just raised the bar for easy, resilient and secure K8s cluster deployment.\n\n   https://ubuntu.com/engage/secure-kubernetes-at-the-edge\n\nExpanded Security Maintenance for Applications is not enabled.\n\n0 updates can be applied immediately.\n\nEnable ESM Apps to receive additional future security updates.\nSee https://ubuntu.com/esm or run: sudo pro status\n\n*** System restart required ***\n```\n\n## 6.2 自动化安装设置脚本\n\n```bash\n#!/bin/bash\n\n# ==============================================================================\n# Idempotent Kubernetes and Cilium Setup Script\n#\n# This script can be run multiple times. It checks the current state\n# at each step and only performs actions if necessary.\n# It must be run as root on the primary control-plane node.\n# ==============================================================================\n\n# --- Configuration ---\nCONTROL_PLANE_ENDPOINT=\"kube-node-1\"\nCONTROL_PLANE_IP=\"10.75.59.71\"\nWORKER_NODES=(\"10.75.59.72\" \"10.75.59.73\")\nPOD_CIDR=\"172.16.0.0/20\"\nSERVICE_CIDR=\"172.16.32.0/20\"\nBGP_PEER_IP=\"10.75.59.76\"\nLOCAL_ASN=65000\nPEER_ASN=65000\nCILIUM_VERSION=\"1.17.6\"\nHUBBLE_UI_VERSION=\"1.3.6\"\n\n# ==============================================================================\n# Helper Function\n# ==============================================================================\nprint_header() { echo -e \"\\n### $1 ###\"; }\n\n# ==============================================================================\n# STEP 1: Initialize Kubernetes Control-Plane\n# ==============================================================================\nprint_header \"STEP 1: Initializing Kubernetes Control-Plane\"\n\nif kubectl get nodes &> /dev/null; then\n  echo \"✅ Kubernetes cluster is already running. Skipping kubeadm init.\"\nelse\n  echo \"--> Kubernetes cluster not found. Initializing...\"\n  kubeadm config images pull\n  kubeadm init \\\n    --control-plane-endpoint=${CONTROL_PLANE_ENDPOINT} \\\n    --pod-network-cidr=${POD_CIDR} \\\n    --service-cidr=${SERVICE_CIDR} \\\n    --skip-phases=addon/kube-proxy\n  mkdir -p /root/.kube\n  cp -i /etc/kubernetes/admin.conf /root/.kube/config\n  echo \"✅ Control-Plane initialization complete.\"\nfi\n\n# ==============================================================================\n# STEP 2: Install or Upgrade Cilium CNI\n# ==============================================================================\nprint_header \"STEP 2: Installing or Upgrading Cilium CNI\"\n\nhelm repo add cilium https://helm.cilium.io/ &> /dev/null\nhelm repo add isovalent https://helm.isovalent.com/ &> /dev/null\nhelm repo update > /dev/null\n\ncat > cilium-values.yaml <<EOF\nhubble:\n  enabled: true\n  relay:\n    enabled: true\n  ui:\n    enabled: false\nipam:\n  mode: kubernetes\nipv4NativeRoutingCIDR: ${POD_CIDR}\nk8s:\n  requireIPv4PodCIDR: true\nroutingMode: native\nautoDirectNodeRoutes: true\nenableIPv4Masquerade: true\nbgpControlPlane:\n  enabled: true\n  announce:\n    podCIDR: true\nkubeProxyReplacement: true\nbpf:\n  masquerade: true\n  lb:\n    externalClusterIP: true\n    sock: true\nEOF\n\nif helm status cilium -n kube-system &> /dev/null; then\n  echo \"--> Cilium is already installed. Upgrading to apply latest configuration...\"\n  helm upgrade cilium isovalent/cilium --version ${CILIUM_VERSION} --namespace kube-system --set k8sServiceHost=${CONTROL_PLANE_IP},k8sServicePort=6443 -f cilium-values.yaml\nelse\n  echo \"--> Cilium not found. Installing...\"\n  helm install cilium isovalent/cilium --version ${CILIUM_VERSION} --namespace kube-system --set k8sServiceHost=${CONTROL_PLANE_IP},k8sServicePort=6443 -f cilium-values.yaml\nfi\necho \"--> Waiting for Cilium pods to become ready...\"\nkubectl -n kube-system wait --for=condition=Ready pod -l k8s-app=cilium --timeout=5m\necho \"✅ Cilium is configured.\"\n\n# ==============================================================================\n# STEP 3: Join Worker Nodes to the Cluster\n# ==============================================================================\nprint_header \"STEP 3: Joining Worker Nodes\"\n\nfor NODE_IP in \"${WORKER_NODES[@]}\"; do\n  if kubectl get nodes -o wide | grep -q \"$NODE_IP\"; then\n    echo \"✅ Node ${NODE_IP} is already in the cluster. Skipping join.\"\n  else\n    echo \"--> Node ${NODE_IP} not found in cluster. Attempting to join...\"\n    JOIN_COMMAND=$(kubeadm token create --print-join-command)\n    ssh -o StrictHostKeyChecking=no root@${NODE_IP} \"${JOIN_COMMAND}\"\n    if [ $? -ne 0 ]; then\n      echo \"❌ Failed to join node ${NODE_IP}. Please check SSH connectivity and logs.\" >&2\n      exit 1\n    fi\n    echo \"✅ Node ${NODE_IP} joined successfully.\"\n  fi\ndone\n\n# ==============================================================================\n# STEP 4: Install Cilium CLI\n# ==============================================================================\nprint_header \"STEP 4: Installing Cilium CLI\"\n\nif command -v cilium &> /dev/null; then\n  echo \"✅ Cilium CLI is already installed. Skipping.\"\nelse\n  echo \"--> Installing Cilium CLI...\"\n  curl -L --silent --remote-name-all https://github.com/isovalent/cilium-cli-releases/releases/latest/download/cilium-linux-amd64.tar.gz{,.sha256sum}\n  sha256sum --check cilium-linux-amd64.tar.gz.sha256sum > /dev/null\n  tar xzvfC cilium-linux-amd64.tar.gz /usr/local/bin > /dev/null\n  rm cilium-linux-amd64.tar.gz cilium-linux-amd64.tar.gz.sha256sum\n  echo \"✅ Cilium CLI installed.\"\nfi\n\n# ==============================================================================\n# STEP 5: Configure Cilium BGP Peering\n# ==============================================================================\nprint_header \"STEP 5: Configuring Cilium BGP Peering\"\n\necho \"--> Applying BGP configuration. 'unchanged' means it's already correct.\"\n# CORRECTION: Using the correct schema with matchLabels.\ncat > cilium-bgp.yaml << EOF\n---\napiVersion: cilium.io/v2alpha1\nkind: CiliumBGPAdvertisement\nmetadata:\n  name: bgp-advertisements\n  labels:\n    advertise: bgp\nspec:\n  advertisements:\n    - advertisementType: \"PodCIDR\"              # Only for Kubernetes or ClusterPool IPAM cluster-pool\n    - advertisementType: \"Service\"\n      service:\n        addresses:\n          - ClusterIP\n          - ExternalIP\n          #- LoadBalancerIP\n      selector:\n        matchExpressions:\n        - {key: somekey, operator: NotIn, values: ['never-used-value']} \n\n---\napiVersion: cilium.io/v2alpha1\nkind: CiliumBGPPeerConfig\nmetadata:\n  name: cilium-peer\nspec:\n  timers:\n    holdTimeSeconds: 30             #default 90s\n    keepAliveTimeSeconds: 10  #default 30s\n    connectRetryTimeSeconds: 40  #default 120s\n  gracefulRestart:\n    enabled: true\n    restartTimeSeconds: 120        #default 120s\n  #transport:\n  #  peerPort: 179\n  families:\n    - afi: ipv4\n      safi: unicast\n      advertisements:\n        matchLabels:\n          advertise: \"bgp\"\n\n---\napiVersion: cilium.io/v2alpha1\nkind: CiliumBGPClusterConfig\nmetadata:\n  name: cilium-bgp-default\nspec:\n  bgpInstances:\n  - name: \"instance-65000\"\n    localASN: ${LOCAL_ASN}\n    peers:\n    - name: \"FRR_BGP\"\n      peerASN: ${PEER_ASN}\n      peerAddress: ${BGP_PEER_IP}\n      peerConfigRef:\n        name: \"cilium-peer\"\nEOF\n\n# Apply the configuration and check for errors\nkubectl apply -f cilium-bgp.yaml\nif [ $? -ne 0 ]; then\n  echo \"❌ Failed to apply BGP configuration. Please check the errors above.\" >&2\n  exit 1\nfi\necho \"✅ BGP configuration applied.\"\n\n# ==============================================================================\n# STEP 6: Install or Upgrade Hubble UI\n# ==============================================================================\nprint_header \"STEP 6: Installing or Upgrading Hubble UI\"\n\ncat > hubble-ui-values.yaml << EOF\nrelay:\n  address: \"hubble-relay.kube-system.svc.cluster.local\"\nEOF\n\nif helm status hubble-ui -n kube-system &> /dev/null; then\n  echo \"--> Hubble UI is already installed. Upgrading...\"\n  helm upgrade hubble-ui isovalent/hubble-ui --version ${HUBBLE_UI_VERSION} --namespace kube-system --values hubble-ui-values.yaml --wait\nelse\n  echo \"--> Hubble UI not found. Installing...\"\n  helm install hubble-ui isovalent/hubble-ui --version ${HUBBLE_UI_VERSION} --namespace kube-system --values hubble-ui-values.yaml --wait\nfi\n\nSERVICE_TYPE=$(kubectl get service hubble-ui -n kube-system -o jsonpath='{.spec.type}')\nif [ \"$SERVICE_TYPE\" != \"NodePort\" ]; then\n  echo \"--> Patching Hubble UI service to NodePort...\"\n  kubectl patch service hubble-ui -n kube-system -p '{\"spec\": {\"type\": \"NodePort\"}}'\nelse\n  echo \"--> Hubble UI service is already of type NodePort.\"\nfi\necho \"✅ Hubble UI is configured.\"\n\n# ==============================================================================\n# STEP 7: Final Verification\n# ==============================================================================\nprint_header \"STEP 7: Final Verification\"\necho \"--> Waiting for all nodes to be ready...\"\nkubectl wait --for=condition=Ready node --all --timeout=5m\necho \"--> Checking Cilium status...\"\ncilium status --wait\n\nHUBBLE_UI_PORT=$(kubectl get service hubble-ui -n kube-system -o jsonpath='{.spec.ports[0].nodePort}')\necho -e \"\\n----------------------------------------------------------------\"\necho \"🚀 Cluster setup is complete and verified!\"\necho \"Access Hubble UI at: http://${CONTROL_PLANE_IP}:${HUBBLE_UI_PORT}\"\necho \"----------------------------------------------------------------\"\n```\n\n```bash\nroot@kube-node-1:~# ./k8s-cilium-setup.sh \n### STEP 1: Initializing Kubernetes Control-Plane on kube-node-1... ###\n--> Pulling Kubernetes container images...\n[config/images] Pulled registry.k8s.io/kube-apiserver:v1.33.3\n[config/images] Pulled registry.k8s.io/kube-controller-manager:v1.33.3\n[config/images] Pulled registry.k8s.io/kube-scheduler:v1.33.3\n[config/images] Pulled registry.k8s.io/kube-proxy:v1.33.3\n[config/images] Pulled registry.k8s.io/coredns/coredns:v1.12.0\n[config/images] Pulled registry.k8s.io/pause:3.10\n[config/images] Pulled registry.k8s.io/etcd:3.5.21-0\n--> Running kubeadm init...\n[init] Using Kubernetes version: v1.33.3\n[preflight] Running pre-flight checks\n[preflight] Pulling images required for setting up a Kubernetes cluster\n[preflight] This might take a minute or two, depending on the speed of your internet connection\n[preflight] You can also perform this action beforehand using 'kubeadm config images pull'\n[certs] Using certificateDir folder \"/etc/kubernetes/pki\"\n[certs] Generating \"ca\" certificate and key\n[certs] Generating \"apiserver\" certificate and key\n[certs] apiserver serving cert is signed for DNS names [kube-node-1 kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local] and IPs [172.16.32.1 10.75.59.71]\n[certs] Generating \"apiserver-kubelet-client\" certificate and key\n[certs] Generating \"front-proxy-ca\" certificate and key\n[certs] Generating \"front-proxy-client\" certificate and key\n[certs] Generating \"etcd/ca\" certificate and key\n[certs] Generating \"etcd/server\" certificate and key\n[certs] etcd/server serving cert is signed for DNS names [kube-node-1 localhost] and IPs [10.75.59.71 127.0.0.1 ::1]\n[certs] Generating \"etcd/peer\" certificate and key\n[certs] etcd/peer serving cert is signed for DNS names [kube-node-1 localhost] and IPs [10.75.59.71 127.0.0.1 ::1]\n[certs] Generating \"etcd/healthcheck-client\" certificate and key\n[certs] Generating \"apiserver-etcd-client\" certificate and key\n[certs] Generating \"sa\" key and public key\n[kubeconfig] Using kubeconfig folder \"/etc/kubernetes\"\n[kubeconfig] Writing \"admin.conf\" kubeconfig file\n[kubeconfig] Writing \"super-admin.conf\" kubeconfig file\n[kubeconfig] Writing \"kubelet.conf\" kubeconfig file\n[kubeconfig] Writing \"controller-manager.conf\" kubeconfig file\n[kubeconfig] Writing \"scheduler.conf\" kubeconfig file\n[etcd] Creating static Pod manifest for local etcd in \"/etc/kubernetes/manifests\"\n[control-plane] Using manifest folder \"/etc/kubernetes/manifests\"\n[control-plane] Creating static Pod manifest for \"kube-apiserver\"\n[control-plane] Creating static Pod manifest for \"kube-controller-manager\"\n[control-plane] Creating static Pod manifest for \"kube-scheduler\"\n[kubelet-start] Writing kubelet environment file with flags to file \"/var/lib/kubelet/kubeadm-flags.env\"\n[kubelet-start] Writing kubelet configuration to file \"/var/lib/kubelet/config.yaml\"\n[kubelet-start] Starting the kubelet\n[wait-control-plane] Waiting for the kubelet to boot up the control plane as static Pods from directory \"/etc/kubernetes/manifests\"\n[kubelet-check] Waiting for a healthy kubelet at http://127.0.0.1:10248/healthz. This can take up to 4m0s\n[kubelet-check] The kubelet is healthy after 1.001873284s\n[control-plane-check] Waiting for healthy control plane components. This can take up to 4m0s\n[control-plane-check] Checking kube-apiserver at https://10.75.59.71:6443/livez\n[control-plane-check] Checking kube-controller-manager at https://127.0.0.1:10257/healthz\n[control-plane-check] Checking kube-scheduler at https://127.0.0.1:10259/livez\n[control-plane-check] kube-controller-manager is healthy after 2.272937689s\n[control-plane-check] kube-scheduler is healthy after 3.04977489s\n[control-plane-check] kube-apiserver is healthy after 5.003048769s\n[upload-config] Storing the configuration used in ConfigMap \"kubeadm-config\" in the \"kube-system\" Namespace\n[kubelet] Creating a ConfigMap \"kubelet-config\" in namespace kube-system with the configuration for the kubelets in the cluster\n[upload-certs] Skipping phase. Please see --upload-certs\n[mark-control-plane] Marking the node kube-node-1 as control-plane by adding the labels: [node-role.kubernetes.io/control-plane node.kubernetes.io/exclude-from-external-load-balancers]\n[mark-control-plane] Marking the node kube-node-1 as control-plane by adding the taints [node-role.kubernetes.io/control-plane:NoSchedule]\n[bootstrap-token] Using token: 0q5m6l.5pc7hz15orcc0b6b\n[bootstrap-token] Configuring bootstrap tokens, cluster-info ConfigMap, RBAC Roles\n[bootstrap-token] Configured RBAC rules to allow Node Bootstrap tokens to get nodes\n[bootstrap-token] Configured RBAC rules to allow Node Bootstrap tokens to post CSRs in order for nodes to get long term certificate credentials\n[bootstrap-token] Configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token\n[bootstrap-token] Configured RBAC rules to allow certificate rotation for all node client certificates in the cluster\n[bootstrap-token] Creating the \"cluster-info\" ConfigMap in the \"kube-public\" namespace\n[kubelet-finalize] Updating \"/etc/kubernetes/kubelet.conf\" to point to a rotatable kubelet client certificate and key\n[addons] Applied essential addon: CoreDNS\n\nYour Kubernetes control-plane has initialized successfully!\n\nTo start using your cluster, you need to run the following as a regular user:\n\n  mkdir -p $HOME/.kube\n  sudo cp -i /etc/kubernetes/admin.conf $HOME/.kube/config\n  sudo chown $(id -u):$(id -g) $HOME/.kube/config\n\nAlternatively, if you are the root user, you can run:\n\n  export KUBECONFIG=/etc/kubernetes/admin.conf\n\nYou should now deploy a pod network to the cluster.\nRun \"kubectl apply -f [podnetwork].yaml\" with one of the options listed at:\n  https://kubernetes.io/docs/concepts/cluster-administration/addons/\n\nYou can now join any number of control-plane nodes by copying certificate authorities\nand service account keys on each node and then running the following as root:\n\n  kubeadm join kube-node-1:6443 --token 0q5m6l.5pc7hz15orcc0b6b \\\n        --discovery-token-ca-cert-hash sha256:4795595e8237c54f1bf20c7fb56feea9a1960af5802c08c410733d54b5e317a6 \\\n        --control-plane \n\nThen you can join any number of worker nodes by running the following on each as root:\n\nkubeadm join kube-node-1:6443 --token 0q5m6l.5pc7hz15orcc0b6b \\\n        --discovery-token-ca-cert-hash sha256:4795595e8237c54f1bf20c7fb56feea9a1960af5802c08c410733d54b5e317a6 \n--> Configuring kubectl...\n✅ Control-Plane initialization complete.\n### STEP 2: Installing Cilium... ###\n--> Adding Helm repositories...\n\"cilium\" has been added to your repositories\n\"isovalent\" has been added to your repositories\nHang tight while we grab the latest from your chart repositories...\n...Successfully got an update from the \"cilium\" chart repository\n...Successfully got an update from the \"isovalent\" chart repository\nUpdate Complete. ⎈Happy Helming!⎈\n--> Creating cilium-enterprise-values.yaml...\n--> Installing Cilium with Helm...\nNAME: cilium\nLAST DEPLOYED: Fri Aug  1 14:16:16 2025\nNAMESPACE: kube-system\nSTATUS: deployed\nREVISION: 1\nTEST SUITE: None\nNOTES:\nYou have successfully installed Cilium with Hubble Relay.\n\nYour release version is 1.17.6.\n\nFor any further help, visit https://docs.isovalent.com/v1.17\n--> Waiting for Cilium pods to become ready...\npod/cilium-5ngcm condition met\n✅ Cilium installation complete.\n### STEP 3: Joining Worker Nodes... ###\n--> Generated join command: kubeadm join kube-node-1:6443 --token whltm8.4zs5af6hiht167da --discovery-token-ca-cert-hash sha256:4795595e8237c54f1bf20c7fb56feea9a1960af5802c08c410733d54b5e317a6 \n--> Joining node 10.75.59.72 to the cluster...\n[preflight] Running pre-flight checks\n[preflight] Reading configuration from the \"kubeadm-config\" ConfigMap in namespace \"kube-system\"...\n[preflight] Use 'kubeadm init phase upload-config --config your-config-file' to re-upload it.\nW0801 14:18:01.674767   20870 configset.go:78] Warning: No kubeproxy.config.k8s.io/v1alpha1 config is loaded. Continuing without it: configmaps \"kube-proxy\" is forbidden: User \"system:bootstrap:whltm8\" cannot get resource \"configmaps\" in API group \"\" in the namespace \"kube-system\"\n[kubelet-start] Writing kubelet configuration to file \"/var/lib/kubelet/config.yaml\"\n[kubelet-start] Writing kubelet environment file with flags to file \"/var/lib/kubelet/kubeadm-flags.env\"\n[kubelet-start] Starting the kubelet\n[kubelet-check] Waiting for a healthy kubelet at http://127.0.0.1:10248/healthz. This can take up to 4m0s\n[kubelet-check] The kubelet is healthy after 1.501212696s\n[kubelet-start] Waiting for the kubelet to perform the TLS Bootstrap\n\nThis node has joined the cluster:\n* Certificate signing request was sent to apiserver and a response was received.\n* The Kubelet was informed of the new secure connection details.\n\nRun 'kubectl get nodes' on the control-plane to see this node join the cluster.\n\n✅ Node 10.75.59.72 joined successfully.\n--> Joining node 10.75.59.73 to the cluster...\n[preflight] Running pre-flight checks\n[preflight] Reading configuration from the \"kubeadm-config\" ConfigMap in namespace \"kube-system\"...\n[preflight] Use 'kubeadm init phase upload-config --config your-config-file' to re-upload it.\nW0801 14:18:07.347008   20684 configset.go:78] Warning: No kubeproxy.config.k8s.io/v1alpha1 config is loaded. Continuing without it: configmaps \"kube-proxy\" is forbidden: User \"system:bootstrap:whltm8\" cannot get resource \"configmaps\" in API group \"\" in the namespace \"kube-system\"\n[kubelet-start] Writing kubelet configuration to file \"/var/lib/kubelet/config.yaml\"\n[kubelet-start] Writing kubelet environment file with flags to file \"/var/lib/kubelet/kubeadm-flags.env\"\n[kubelet-start] Starting the kubelet\n[kubelet-check] Waiting for a healthy kubelet at http://127.0.0.1:10248/healthz. This can take up to 4m0s\n[kubelet-check] The kubelet is healthy after 1.002187345s\n[kubelet-start] Waiting for the kubelet to perform the TLS Bootstrap\n\nThis node has joined the cluster:\n* Certificate signing request was sent to apiserver and a response was received.\n* The Kubelet was informed of the new secure connection details.\n\nRun 'kubectl get nodes' on the control-plane to see this node join the cluster.\n\n✅ Node 10.75.59.73 joined successfully.\n### STEP 4: Installing the Cilium CLI... ###\n  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current\n                                 Dload  Upload   Total   Spent    Left  Speed\n  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0\n  0     0    0     0    0     0      0      0 --:--:--  0:00:01 --:--:--     0\n100 59.2M  100 59.2M    0     0  13.1M      0  0:00:04  0:00:04 --:--:-- 23.8M\n  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current\n                                 Dload  Upload   Total   Spent    Left  Speed\n  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0\n  0     0    0     0    0     0      0      0 --:--:--  0:00:01 --:--:--     0\n100    92  100    92    0     0     70      0  0:00:01  0:00:01 --:--:--    70\ncilium-linux-amd64.tar.gz: OK\ncilium\n✅ Cilium CLI installed.\n### STEP 5: Configuring Cilium BGP Peering ###\n--> Applying BGP configuration. 'unchanged' means it's already correct.\nciliumbgpadvertisement.cilium.io/bgp-advertisements unchanged\nciliumbgppeerconfig.cilium.io/cilium-peer unchanged\nciliumbgpclusterconfig.cilium.io/cilium-bgp-default configured\n✅ BGP configuration applied.\n### STEP 6: Installing Hubble UI... ###\n--> Creating hubble-ui-values.yaml...\n--> Installing Hubble UI with Helm...\nNAME: hubble-ui\nLAST DEPLOYED: Fri Aug  1 14:18:18 2025\nNAMESPACE: kube-system\nSTATUS: deployed\nREVISION: 1\nTEST SUITE: None\nNOTES:\nYou have successfully installed Hubble-Ui.\nYour release version is 1.3.6.\n\nFor any further help, visit https://docs.isovalent.com\n--> Exposing Hubble UI service via NodePort...\nservice/hubble-ui patched\n✅ Hubble UI installed.\n### STEP 7: Verifying the Setup... ###\n--> Waiting for all nodes to be ready...\nnode/kube-node-1 condition met\nnode/kube-node-2 condition met\nnode/kube-node-3 condition met\n--> Checking Cilium status...\n    /¯¯\\\n /¯¯\\__/¯¯\\    Cilium:             OK\n \\__/¯¯\\__/    Operator:           OK\n /¯¯\\__/¯¯\\    Envoy DaemonSet:    OK\n \\__/¯¯\\__/    Hubble Relay:       OK\n    \\__/       ClusterMesh:        disabled\n\nDaemonSet              cilium                   Desired: 3, Ready: 3/3, Available: 3/3\nDaemonSet              cilium-envoy             Desired: 3, Ready: 3/3, Available: 3/3\nDeployment             cilium-operator          Desired: 2, Ready: 2/2, Available: 2/2\nDeployment             hubble-relay             Desired: 1, Ready: 1/1, Available: 1/1\nDeployment             hubble-ui                Desired: 1, Ready: 1/1, Available: 1/1\nContainers:            cilium                   Running: 3\n                       cilium-envoy             Running: 3\n                       cilium-operator          Running: 2\n                       clustermesh-apiserver    \n                       hubble-relay             Running: 1\n                       hubble-ui                Running: 1\nCluster Pods:          8/8 managed by Cilium\nHelm chart version:    1.17.6\nImage versions         cilium             quay.io/isovalent/cilium:v1.17.6-cee.1@sha256:2d01daf4f25f7d644889b49ca856e1a4269981fc963e50bd3962665b41b6adb3: 3\n                       cilium-envoy       quay.io/isovalent/cilium-envoy:v1.17.6-cee.1@sha256:318eff387835ca2717baab42a84f35a83a5f9e7d519253df87269f80b9ff0171: 3\n                       cilium-operator    quay.io/isovalent/operator-generic:v1.17.6-cee.1@sha256:2e602710a7c4f101831df679e5d8251bae8bf0f9fe26c20bbef87f1966ea8265: 2\n                       hubble-relay       quay.io/isovalent/hubble-relay:v1.17.6-cee.1@sha256:d378e3607f7492374e65e2bd854cc0ec87480c63ba49a96dadcd75a6946b586e: 1\n                       hubble-ui          quay.io/isovalent/hubble-ui-enterprise-backend:v1.3.6: 1\n                       hubble-ui          quay.io/isovalent/hubble-ui-enterprise:v1.3.6: 1\n\n----------------------------------------------------------------\n🚀 Cluster setup is complete and verified!\nAccess Hubble UI at: http://10.75.59.71:30583\n----------------------------------------------------------------\nroot@kube-node-1:~# cilium bgp peers\nNode          Local AS   Peer AS   Peer Address   Session State   Uptime   Family         Received   Advertised\nkube-node-1   65000      65000     10.75.59.76    established     19m1s    ipv4/unicast   2          8    \nkube-node-2   65000      65000     10.75.59.76    established     19m2s    ipv4/unicast   2          8    \nkube-node-3   65000      65000     10.75.59.76    established     19m2s    ipv4/unicast   2          8    \nroot@kube-node-1:~# cilium bgp routes\n(Defaulting to `available ipv4 unicast` routes, please see help for more options)\n\nNode          VRouter   Prefix             NextHop   Age     Attrs\nkube-node-1   65000     172.16.0.0/24      0.0.0.0   19m8s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n              65000     172.16.32.1/32     0.0.0.0   19m8s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n              65000     172.16.32.10/32    0.0.0.0   19m8s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n              65000     172.16.36.130/32   0.0.0.0   19m8s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n              65000     172.16.40.165/32   0.0.0.0   19m8s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n              65000     172.16.43.51/32    0.0.0.0   19m8s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n              65000     172.16.47.30/32    0.0.0.0   19m8s   [{Origin: i} {Nexthop: 0.0.0.0}]   \nkube-node-2   65000     172.16.1.0/24      0.0.0.0   19m8s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n              65000     172.16.32.1/32     0.0.0.0   19m8s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n              65000     172.16.32.10/32    0.0.0.0   19m8s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n              65000     172.16.36.130/32   0.0.0.0   19m8s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n              65000     172.16.40.165/32   0.0.0.0   19m8s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n              65000     172.16.43.51/32    0.0.0.0   19m8s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n              65000     172.16.47.30/32    0.0.0.0   19m8s   [{Origin: i} {Nexthop: 0.0.0.0}]   \nkube-node-3   65000     172.16.2.0/24      0.0.0.0   19m8s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n              65000     172.16.32.1/32     0.0.0.0   19m8s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n              65000     172.16.32.10/32    0.0.0.0   19m8s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n              65000     172.16.36.130/32   0.0.0.0   19m8s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n              65000     172.16.40.165/32   0.0.0.0   19m8s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n              65000     172.16.43.51/32    0.0.0.0   19m8s   [{Origin: i} {Nexthop: 0.0.0.0}]   \n              65000     172.16.47.30/32    0.0.0.0   19m8s   [{Origin: i} {Nexthop: 0.0.0.0}]   \nroot@kube-node-1:~# \n```\n# 7. Kubectl 常用命令\n```shell\nkubectl describe pod hubble-ui-5fdd8b4495-dv7nr -n kube-system\n\nkubectl get nodes -o wide\nkubectl get pods -n kube-system -o wide\nkubectl get pods --all-namespaces\nkubectl get service -n kube-system -o wide\nkubectl get daemonset -n kube-system cilium\nkubectl get deployment -o wide\n\nkubectl get endpoints -n kube-system kube-dns\nkubectl get cm cilium-config -n kube-system -o yaml\nkubectl get endpoints -n kube-system\nkubectl get pods -n kube-system -l k8s-app=cilium -o wide\n# kubectl describe pod hubble-relay-cfb755899-r42l8\n\n\n\nkubectl -n kube-system get pods -l k8s-app=cilium\nkubectl -n kube-system exec ds/cilium -- cilium-dbg bpf ipmasq list\nkubectl -n kube-system exec ds/cilium -- cilium-dbg status --verbose\nkubectl -n kube-system exec ds/cilium -- cilium status\nkubectl -n kube-system exec ds/cilium -- cilium service list\nkubectl -n kube-system exec ds/cilium -- cilium bpf nat list\nkubectl exec -n kube-system cilium-2vrgj -- cilium bpf nat list\n\nkubectl -n kube-system get configmap cilium-config -o yaml\n\nkubectl create namespace star-wars\nkubectl apply -n star-wars -f https://raw.githubusercontent.com/cilium/cilium/HEAD/examples/minikube/http-sw-app.yaml\nkubectl -n star-wars get pod -o wide --show-labels\nkubectl -n star-wars patch service deathstar -p '{\"spec\":{\"type\":\"NodePort\"}}'\nkubectl -n star-wars exec tiefighter --   curl -s -XPOST http://deathstar.star-wars.svc.cluster.local/v1/request-landing\nkubectl -n star-wars exec xwing --   curl -s -XPOST http://deathstar.star-wars.svc.cluster.local/v1/request-landing\n\n# kubectl delete -n star-wars -f https://raw.githubusercontent.com/cilium/cilium/1.18.0/examples/minikube/http-sw-app.yaml\n\n# Commands for reference only.\n\n\nkubectl delete pod,svc,daemonset -n kube-system -l k8s-app=cilium\nkubectl delete daemonset -n kube-system kube-proxy\n\n\nkubectl create deployment nginx --image=nginx\nkubectl expose deployment nginx --port=80 --type=ClusterIP\n\nkubectl run -it --rm busybox --image=busybox --restart=Never -- sh\n\nkubectl run -it --rm curl --image=curlimages/curl --restart=Never -- sh\n\nfor i in {1..10}; do   kubectl exec -n star-wars tiefighter --     curl -s http://deathstar.default.svc.cluster.local/v1 |     jq -r '.hostname'; done\n```","slug":"K8S-Cilium-Replace-kube-proxy","published":1,"updated":"2025-12-14T14:23:25.254Z","comments":1,"layout":"post","photos":[],"_id":"cuidOx2hziMmsFUtH5YSKy_hQ","content":"<h1 id=\"Kubernetes-with-CNI-Cilium-安装学习\"><a href=\"#Kubernetes-with-CNI-Cilium-安装学习\" class=\"headerlink\" title=\"Kubernetes with CNI Cilium 安装学习\"></a>Kubernetes with CNI Cilium 安装学习</h1><h1 id=\"1-使用自动化脚本安装Ubuntu-24-04虚拟机\"><a href=\"#1-使用自动化脚本安装Ubuntu-24-04虚拟机\" class=\"headerlink\" title=\"1. 使用自动化脚本安装Ubuntu 24.04虚拟机\"></a>1. 使用自动化脚本安装Ubuntu 24.04虚拟机</h1><h2 id=\"1-1-准备工作\"><a href=\"#1-1-准备工作\" class=\"headerlink\" title=\"1.1 准备工作\"></a>1.1 准备工作</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">密码加密字符串</span><br><span class=\"line\">ois@ois:~$ mkpasswd --method=SHA-512 --rounds=4096</span><br><span class=\"line\">Password: </span><br><span class=\"line\">$6<span class=\"variable\">$rounds</span>=4096<span class=\"variable\">$LDu9pXXXXXXXXXXXXXXOh</span>/Iunw372/TVfst1</span><br><span class=\"line\"></span><br><span class=\"line\">生成ssh-key，以便实现无密码登录。</span><br><span class=\"line\">ssh-keygen -t rsa -b 4096</span><br><span class=\"line\">Generating public/private rsa key pair.</span><br><span class=\"line\">Enter file <span class=\"keyword\">in</span> <span class=\"built_in\">which</span> to save the key (/root/.ssh/id_rsa): </span><br><span class=\"line\">Enter passphrase (empty <span class=\"keyword\">for</span> no passphrase): </span><br><span class=\"line\">Enter same passphrase again: </span><br><span class=\"line\">Your identification has been saved <span class=\"keyword\">in</span> /root/.ssh/id_rsa</span><br><span class=\"line\">Your public key has been saved <span class=\"keyword\">in</span> /root/.ssh/id_rsa.pub</span><br><span class=\"line\">The key fingerprint is:</span><br><span class=\"line\">SHA256:1+BaD0K3fe6saxPFf41r0SyZEpqhq29AVeRwz+WEXiU </span><br><span class=\"line\">The key<span class=\"string\">&#x27;s randomart image is:</span></span><br><span class=\"line\"><span class=\"string\">+---[RSA 4096]----+</span></span><br><span class=\"line\"><span class=\"string\">|        .o+  .E..|</span></span><br><span class=\"line\"><span class=\"string\">|        .+ o.+.. |</span></span><br><span class=\"line\"><span class=\"string\">|       .. +.oo.  |</span></span><br><span class=\"line\"><span class=\"string\">|      .. o.=o o  |</span></span><br><span class=\"line\"><span class=\"string\">|     .  S.*+oo.B.|</span></span><br><span class=\"line\"><span class=\"string\">|      . .=oooo* *|</span></span><br><span class=\"line\"><span class=\"string\">|       ...  .o.+.|</span></span><br><span class=\"line\"><span class=\"string\">|        o   ooo  |</span></span><br><span class=\"line\"><span class=\"string\">|      .+.  .o=o  |</span></span><br><span class=\"line\"><span class=\"string\">+----[SHA256]-----+</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"1-2-自动化脚本创建虚拟机节点—-由Gemini生成\"><a href=\"#1-2-自动化脚本创建虚拟机节点—-由Gemini生成\" class=\"headerlink\" title=\"1.2 自动化脚本创建虚拟机节点— 由Gemini生成\"></a>1.2 自动化脚本创建虚拟机节点— 由Gemini生成</h2><h3 id=\"create-vms-sh\"><a href=\"#create-vms-sh\" class=\"headerlink\" title=\"create-vms.sh\"></a>create-vms.sh</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#!/bin/bash</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># --- Configuration ---</span></span><br><span class=\"line\">BASE_IMAGE_PATH=<span class=\"string\">&quot;/home/ois/data/vmimages/noble-server-cloudimg-amd64.img&quot;</span></span><br><span class=\"line\">VM_IMAGE_DIR=<span class=\"string\">&quot;/home/ois/data/k8s/nodevms&quot;</span></span><br><span class=\"line\">VM_CONFIG_DIR=<span class=\"string\">&quot;/home/ois/data/k8s/nodevm_cfg&quot;</span></span><br><span class=\"line\">RAM_MB=8192</span><br><span class=\"line\">VCPUS=4</span><br><span class=\"line\">DISK_SIZE_GB=20 <span class=\"comment\"># &lt;--- ADDED: Increased disk size to 20 GB</span></span><br><span class=\"line\">BRIDGE_INTERFACE=<span class=\"string\">&quot;br0&quot;</span></span><br><span class=\"line\">BASE_IP=<span class=\"string\">&quot;10.75.59&quot;</span></span><br><span class=\"line\">NETWORK_PREFIX=<span class=\"string\">&quot;/24&quot;</span></span><br><span class=\"line\">GATEWAY=<span class=\"string\">&quot;10.75.59.1&quot;</span></span><br><span class=\"line\">NAMESERVER1=<span class=\"string\">&quot;64.104.76.247&quot;</span></span><br><span class=\"line\">NAMESERVER2=<span class=\"string\">&quot;64.104.14.184&quot;</span></span><br><span class=\"line\">SEARCH_DOMAIN=<span class=\"string\">&quot;cisco.com&quot;</span></span><br><span class=\"line\">VNC_PORT_START=5905 <span class=\"comment\"># VNC ports will be 5905, 5906, 5907</span></span><br><span class=\"line\">PASSWORD_HASH=<span class=\"string\">&#x27;$6$rounds=4096$LDu9pXXXXXXXXXXXXXXOh/Iunw372/TVfst1&#x27;</span></span><br><span class=\"line\">SSH_PUB_KEY=$(<span class=\"built_in\">cat</span> ~/.ssh/id_rsa.pub)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># --- Loop to create 3 VMs ---</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> &#123;1..3&#125;; <span class=\"keyword\">do</span></span><br><span class=\"line\">    VM_NAME=<span class=\"string\">&quot;kube-node-<span class=\"variable\">$i</span>&quot;</span></span><br><span class=\"line\">    VM_IP=<span class=\"string\">&quot;<span class=\"variable\">$&#123;BASE_IP&#125;</span>.<span class=\"subst\">$((70 + i)</span>)&quot;</span> <span class=\"comment\"># IPs will be 10.75.59.71, 10.75.59.72, 10.75.59.73</span></span><br><span class=\"line\">    VM_IMAGE_PATH=<span class=\"string\">&quot;<span class=\"variable\">$&#123;VM_IMAGE_DIR&#125;</span>/<span class=\"variable\">$&#123;VM_NAME&#125;</span>.qcow2&quot;</span></span><br><span class=\"line\">    VM_VNC_PORT=$((VNC_PORT_START + i - <span class=\"number\">1</span>)) <span class=\"comment\"># VNC ports will be 5905, 5906, 5907</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;--- Preparing for <span class=\"variable\">$VM_NAME</span> (IP: <span class=\"variable\">$VM_IP</span>) ---&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># Create directories if they don&#x27;t exist</span></span><br><span class=\"line\">    <span class=\"built_in\">mkdir</span> -p <span class=\"string\">&quot;<span class=\"variable\">$VM_IMAGE_DIR</span>&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">mkdir</span> -p <span class=\"string\">&quot;<span class=\"variable\">$VM_CONFIG_DIR</span>&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># Create a fresh image for each VM</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> [ -f <span class=\"string\">&quot;<span class=\"variable\">$VM_IMAGE_PATH</span>&quot;</span> ]; <span class=\"keyword\">then</span></span><br><span class=\"line\">        <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Removing existing image for <span class=\"variable\">$VM_NAME</span>...&quot;</span></span><br><span class=\"line\">        <span class=\"built_in\">rm</span> <span class=\"string\">&quot;<span class=\"variable\">$VM_IMAGE_PATH</span>&quot;</span></span><br><span class=\"line\">    <span class=\"keyword\">fi</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Copying base image to <span class=\"variable\">$VM_IMAGE_PATH</span>...&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">cp</span> <span class=\"string\">&quot;<span class=\"variable\">$BASE_IMAGE_PATH</span>&quot;</span> <span class=\"string\">&quot;<span class=\"variable\">$VM_IMAGE_PATH</span>&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># --- NEW: Resize the copied image before virt-install ---</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Resizing VM image to <span class=\"variable\">$&#123;DISK_SIZE_GB&#125;</span>GB...&quot;</span></span><br><span class=\"line\">    qemu-img resize <span class=\"string\">&quot;<span class=\"variable\">$VM_IMAGE_PATH</span>&quot;</span> <span class=\"string\">&quot;<span class=\"variable\">$&#123;DISK_SIZE_GB&#125;</span>G&quot;</span></span><br><span class=\"line\">    <span class=\"comment\"># --- END NEW ---</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># Generate user-data for the current VM</span></span><br><span class=\"line\">    USER_DATA_FILE=<span class=\"string\">&quot;<span class=\"variable\">$&#123;VM_CONFIG_DIR&#125;</span>/<span class=\"variable\">$&#123;VM_NAME&#125;</span>_user-data&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOF &gt; &quot;$USER_DATA_FILE&quot;</span></span><br><span class=\"line\"><span class=\"string\">#cloud-config</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">locale: en_US</span></span><br><span class=\"line\"><span class=\"string\">keyboard:</span></span><br><span class=\"line\"><span class=\"string\">  layout: us</span></span><br><span class=\"line\"><span class=\"string\">timezone: Asia/Shanghai</span></span><br><span class=\"line\"><span class=\"string\">hostname: $&#123;VM_NAME&#125;</span></span><br><span class=\"line\"><span class=\"string\">create_hostname_file: true</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">ssh_pwauth: yes</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">groups:</span></span><br><span class=\"line\"><span class=\"string\">  - ubuntu</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">users:</span></span><br><span class=\"line\"><span class=\"string\">  - name: ubuntu</span></span><br><span class=\"line\"><span class=\"string\">    gecos: ubuntu</span></span><br><span class=\"line\"><span class=\"string\">    primary_group: ubuntu</span></span><br><span class=\"line\"><span class=\"string\">    groups: sudo, cdrom</span></span><br><span class=\"line\"><span class=\"string\">    sudo: ALL=(ALL:ALL) ALL</span></span><br><span class=\"line\"><span class=\"string\">    shell: /bin/bash</span></span><br><span class=\"line\"><span class=\"string\">    lock_passwd: false</span></span><br><span class=\"line\"><span class=\"string\">    passwd: $&#123;PASSWORD_HASH&#125;</span></span><br><span class=\"line\"><span class=\"string\">    ssh_authorized_keys:</span></span><br><span class=\"line\"><span class=\"string\">      - &quot;$&#123;SSH_PUB_KEY&#125;&quot;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">apt:</span></span><br><span class=\"line\"><span class=\"string\">  primary:</span></span><br><span class=\"line\"><span class=\"string\">    - arches: [default]</span></span><br><span class=\"line\"><span class=\"string\">      uri: http://us.archive.ubuntu.com/ubuntu/</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">packages:</span></span><br><span class=\"line\"><span class=\"string\">  - openssh-server</span></span><br><span class=\"line\"><span class=\"string\">  - net-tools</span></span><br><span class=\"line\"><span class=\"string\">  - iftop</span></span><br><span class=\"line\"><span class=\"string\">  - htop</span></span><br><span class=\"line\"><span class=\"string\">  - iperf3</span></span><br><span class=\"line\"><span class=\"string\">  - vim</span></span><br><span class=\"line\"><span class=\"string\">  - curl</span></span><br><span class=\"line\"><span class=\"string\">  - wget</span></span><br><span class=\"line\"><span class=\"string\">  - cloud-guest-utils # Ensure growpart is available</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">ntp:</span></span><br><span class=\"line\"><span class=\"string\">  servers: [&#x27;ntp.esl.cisco.com&#x27;]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">runcmd:</span></span><br><span class=\"line\"><span class=\"string\">  - echo &quot;Attempting to resize root partition and filesystem...&quot;</span></span><br><span class=\"line\"><span class=\"string\">  - growpart /dev/vda 1 # Expand the first partition on /dev/vda</span></span><br><span class=\"line\"><span class=\"string\">  - resize2fs /dev/vda1 # Expand the ext4 filesystem on /dev/vda1</span></span><br><span class=\"line\"><span class=\"string\">  - echo &quot;Disk resize commands executed. Verify with &#x27;df -h&#x27; after boot.&quot;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># Generate network-config for the current VM</span></span><br><span class=\"line\">    NETWORK_CONFIG_FILE=<span class=\"string\">&quot;<span class=\"variable\">$&#123;VM_CONFIG_DIR&#125;</span>/<span class=\"variable\">$&#123;VM_NAME&#125;</span>_network-config&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOF &gt; &quot;$NETWORK_CONFIG_FILE&quot;</span></span><br><span class=\"line\"><span class=\"string\">network:</span></span><br><span class=\"line\"><span class=\"string\">  version: 2</span></span><br><span class=\"line\"><span class=\"string\">  ethernets:</span></span><br><span class=\"line\"><span class=\"string\">    enp1s0:</span></span><br><span class=\"line\"><span class=\"string\">      addresses:</span></span><br><span class=\"line\"><span class=\"string\">      - &quot;$&#123;VM_IP&#125;$&#123;NETWORK_PREFIX&#125;&quot;</span></span><br><span class=\"line\"><span class=\"string\">      nameservers:</span></span><br><span class=\"line\"><span class=\"string\">        addresses:</span></span><br><span class=\"line\"><span class=\"string\">        - $&#123;NAMESERVER1&#125;</span></span><br><span class=\"line\"><span class=\"string\">        - $&#123;NAMESERVER2&#125;</span></span><br><span class=\"line\"><span class=\"string\">        search:</span></span><br><span class=\"line\"><span class=\"string\">        - $&#123;SEARCH_DOMAIN&#125;</span></span><br><span class=\"line\"><span class=\"string\">      routes:</span></span><br><span class=\"line\"><span class=\"string\">      - to: &quot;default&quot;</span></span><br><span class=\"line\"><span class=\"string\">        via: &quot;$&#123;GATEWAY&#125;&quot;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># Generate meta-data (can be static for now)</span></span><br><span class=\"line\">    META_DATA_FILE=<span class=\"string\">&quot;<span class=\"variable\">$&#123;VM_CONFIG_DIR&#125;</span>/<span class=\"variable\">$&#123;VM_NAME&#125;</span>_meta-data&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOF &gt; &quot;$META_DATA_FILE&quot;</span></span><br><span class=\"line\"><span class=\"string\">instance-id: $&#123;VM_NAME&#125;</span></span><br><span class=\"line\"><span class=\"string\">local-hostname: $&#123;VM_NAME&#125;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;--- Installing <span class=\"variable\">$VM_NAME</span> ---&quot;</span></span><br><span class=\"line\">    virt-install --name <span class=\"string\">&quot;<span class=\"variable\">$&#123;VM_NAME&#125;</span>&quot;</span> --ram <span class=\"string\">&quot;<span class=\"variable\">$&#123;RAM_MB&#125;</span>&quot;</span> --vcpus <span class=\"string\">&quot;<span class=\"variable\">$&#123;VCPUS&#125;</span>&quot;</span> --noreboot \\</span><br><span class=\"line\">        --os-variant ubuntu24.04 \\</span><br><span class=\"line\">        --network bridge=<span class=\"string\">&quot;<span class=\"variable\">$&#123;BRIDGE_INTERFACE&#125;</span>&quot;</span> \\</span><br><span class=\"line\">        --graphics vnc,listen=0.0.0.0,port=<span class=\"string\">&quot;<span class=\"variable\">$&#123;VM_VNC_PORT&#125;</span>&quot;</span> \\</span><br><span class=\"line\">        --disk path=<span class=\"string\">&quot;<span class=\"variable\">$&#123;VM_IMAGE_PATH&#125;</span>&quot;</span>,format=qcow2 \\</span><br><span class=\"line\">        --console pty,target_type=serial \\</span><br><span class=\"line\">        --cloud-init user-data=<span class=\"string\">&quot;<span class=\"variable\">$&#123;USER_DATA_FILE&#125;</span>&quot;</span>,meta-data=<span class=\"string\">&quot;<span class=\"variable\">$&#123;META_DATA_FILE&#125;</span>&quot;</span>,network-config=<span class=\"string\">&quot;<span class=\"variable\">$&#123;NETWORK_CONFIG_FILE&#125;</span>&quot;</span> \\</span><br><span class=\"line\">        --import \\</span><br><span class=\"line\">        --<span class=\"built_in\">wait</span> 0</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Successfully initiated creation of <span class=\"variable\">$VM_NAME</span>.&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;You can connect to VNC on port <span class=\"variable\">$&#123;VM_VNC_PORT&#125;</span> to monitor installation (optional).&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Wait a few minutes for the VM to boot and cloud-init to run.&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;--------------------------------------------------------&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">done</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;All 3 VMs have been initiated. Please wait for them to fully provision.&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;You can SSH into them using &#x27;ssh ubuntu@&lt;IP_ADDRESS&gt;&#x27; where IP addresses are 10.75.59.71, 10.75.59.72, 10.75.59.73.&quot;</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>上述脚本可自动生成三个虚拟机，并可以使用 ssh <a href=\"mailto:&#x75;&#98;&#x75;&#x6e;&#116;&#x75;&#64;&#x31;&#x30;&#x2e;&#x37;&#x35;&#x2e;&#53;&#57;&#x2e;&#55;&#x31;\">&#x75;&#98;&#x75;&#x6e;&#116;&#x75;&#64;&#x31;&#x30;&#x2e;&#x37;&#x35;&#x2e;&#53;&#57;&#x2e;&#55;&#x31;</a> 登录</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">chmod</span> +x create-vms.sh</span><br><span class=\"line\"></span><br><span class=\"line\">ois@ois:~/data/k8s$ ./create-vms.sh </span><br><span class=\"line\">--- Preparing <span class=\"keyword\">for</span> kube-node-1 (IP: 10.75.59.71) ---</span><br><span class=\"line\">Removing existing image <span class=\"keyword\">for</span> kube-node-1...</span><br><span class=\"line\">Copying base image to /home/ois/data/k8s/nodevms/kube-node-1.qcow2...</span><br><span class=\"line\">Resizing VM image to 20GB...</span><br><span class=\"line\">Image resized.</span><br><span class=\"line\">--- Installing kube-node-1 ---</span><br><span class=\"line\">WARNING  Treating --<span class=\"built_in\">wait</span> 0 as --noautoconsole</span><br><span class=\"line\"></span><br><span class=\"line\">Starting install...</span><br><span class=\"line\">Allocating <span class=\"string\">&#x27;virtinst-3jev55ba-cloudinit.iso&#x27;</span>                                                                                                                                                                                             |    0 B  00:00:00 ... </span><br><span class=\"line\">Transferring <span class=\"string\">&#x27;virtinst-3jev55ba-cloudinit.iso&#x27;</span>                                                                                                                                                                                           |    0 B  00:00:00 ... </span><br><span class=\"line\">Creating domain...                                                                                                                                                                                                                       |    0 B  00:00:00     </span><br><span class=\"line\">Domain creation completed.</span><br><span class=\"line\">Successfully initiated creation of kube-node-1.</span><br><span class=\"line\">You can connect to VNC on port 5905 to monitor installation (optional).</span><br><span class=\"line\">Wait a few minutes <span class=\"keyword\">for</span> the VM to boot and cloud-init to run.</span><br><span class=\"line\">--------------------------------------------------------</span><br><span class=\"line\">--- Preparing <span class=\"keyword\">for</span> kube-node-2 (IP: 10.75.59.72) ---</span><br><span class=\"line\">Removing existing image <span class=\"keyword\">for</span> kube-node-2...</span><br><span class=\"line\">Copying base image to /home/ois/data/k8s/nodevms/kube-node-2.qcow2...</span><br><span class=\"line\">Resizing VM image to 20GB...</span><br><span class=\"line\">Image resized.</span><br><span class=\"line\">--- Installing kube-node-2 ---</span><br><span class=\"line\">WARNING  Treating --<span class=\"built_in\">wait</span> 0 as --noautoconsole</span><br><span class=\"line\"></span><br><span class=\"line\">Starting install...</span><br><span class=\"line\">Allocating <span class=\"string\">&#x27;virtinst-c4ruhql3-cloudinit.iso&#x27;</span>                                                                                                                                                                                             |    0 B  00:00:00 ... </span><br><span class=\"line\">Transferring <span class=\"string\">&#x27;virtinst-c4ruhql3-cloudinit.iso&#x27;</span>                                                                                                                                                                                           |    0 B  00:00:00 ... </span><br><span class=\"line\">Creating domain...                                                                                                                                                                                                                       |    0 B  00:00:00     </span><br><span class=\"line\">Domain creation completed.</span><br><span class=\"line\">Successfully initiated creation of kube-node-2.</span><br><span class=\"line\">You can connect to VNC on port 5906 to monitor installation (optional).</span><br><span class=\"line\">Wait a few minutes <span class=\"keyword\">for</span> the VM to boot and cloud-init to run.</span><br><span class=\"line\">--------------------------------------------------------</span><br><span class=\"line\">--- Preparing <span class=\"keyword\">for</span> kube-node-3 (IP: 10.75.59.73) ---</span><br><span class=\"line\">Removing existing image <span class=\"keyword\">for</span> kube-node-3...</span><br><span class=\"line\">Copying base image to /home/ois/data/k8s/nodevms/kube-node-3.qcow2...</span><br><span class=\"line\">Resizing VM image to 20GB...</span><br><span class=\"line\">Image resized.</span><br><span class=\"line\">--- Installing kube-node-3 ---</span><br><span class=\"line\">WARNING  Treating --<span class=\"built_in\">wait</span> 0 as --noautoconsole</span><br><span class=\"line\"></span><br><span class=\"line\">Starting install...</span><br><span class=\"line\">Allocating <span class=\"string\">&#x27;virtinst-u5e8k9a9-cloudinit.iso&#x27;</span>                                                                                                                                                                                             |    0 B  00:00:00 ... </span><br><span class=\"line\">Transferring <span class=\"string\">&#x27;virtinst-u5e8k9a9-cloudinit.iso&#x27;</span>                                                                                                                                                                                           |    0 B  00:00:00 ... </span><br><span class=\"line\">Creating domain...                                                                                                                                                                                                                       |    0 B  00:00:00     </span><br><span class=\"line\">Domain creation completed.</span><br><span class=\"line\">Successfully initiated creation of kube-node-3.</span><br><span class=\"line\">You can connect to VNC on port 5907 to monitor installation (optional).</span><br><span class=\"line\">Wait a few minutes <span class=\"keyword\">for</span> the VM to boot and cloud-init to run.</span><br><span class=\"line\">--------------------------------------------------------</span><br><span class=\"line\">All 3 VMs have been initiated. Please <span class=\"built_in\">wait</span> <span class=\"keyword\">for</span> them to fully provision.</span><br><span class=\"line\">You can SSH into them using <span class=\"string\">&#x27;ssh ubuntu@&lt;IP_ADDRESS&gt;&#x27;</span> <span class=\"built_in\">where</span> IP addresses are 10.75.59.71, 10.75.59.72, 10.75.59.73.</span><br><span class=\"line\"></span><br><span class=\"line\">ois@ois:~/data/k8s$ virsh list</span><br><span class=\"line\"> Id   Name                  State</span><br><span class=\"line\">-------------------------------------</span><br><span class=\"line\"> 83   kube-node-1           running</span><br><span class=\"line\"> 84   kube-node-2           running</span><br><span class=\"line\"> 85   kube-node-3           running</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"user-data-示例\"><a href=\"#user-data-示例\" class=\"headerlink\" title=\"user-data 示例\"></a>user-data 示例</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#cloud-config</span></span><br><span class=\"line\"></span><br><span class=\"line\">locale: en_US</span><br><span class=\"line\">keyboard:</span><br><span class=\"line\">  layout: us</span><br><span class=\"line\">timezone: Asia/Shanghai</span><br><span class=\"line\">hostname: kube-node-1</span><br><span class=\"line\">create_hostname_file: <span class=\"literal\">true</span></span><br><span class=\"line\"></span><br><span class=\"line\">ssh_pwauth: <span class=\"built_in\">yes</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">groups</span>:</span><br><span class=\"line\">  - ubuntu</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">users</span>:</span><br><span class=\"line\">  - name: ubuntu</span><br><span class=\"line\">    gecos: ubuntu</span><br><span class=\"line\">    primary_group: ubuntu</span><br><span class=\"line\">    <span class=\"built_in\">groups</span>: <span class=\"built_in\">sudo</span>, cdrom</span><br><span class=\"line\">    <span class=\"built_in\">sudo</span>: ALL=(ALL:ALL) ALL</span><br><span class=\"line\">    shell: /bin/bash</span><br><span class=\"line\">    lock_passwd: <span class=\"literal\">false</span></span><br><span class=\"line\">    passwd: $6<span class=\"variable\">$rounds</span>=4096<span class=\"variable\">$LDu9pXXXXXXXXXXXXXXOh</span>/Iunw372/TVfst1</span><br><span class=\"line\">    ssh_authorized_keys:</span><br><span class=\"line\">      - <span class=\"string\">&quot;ssh-rsa AAAAB3NzaC1yXXXXXXXXXX==&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">apt:</span><br><span class=\"line\">  primary:</span><br><span class=\"line\">    - arches: [default]</span><br><span class=\"line\">      uri: http://us.archive.ubuntu.com/ubuntu/</span><br><span class=\"line\"></span><br><span class=\"line\">packages:</span><br><span class=\"line\">  - openssh-server</span><br><span class=\"line\">  - net-tools</span><br><span class=\"line\">  - iftop</span><br><span class=\"line\">  - htop</span><br><span class=\"line\">  - iperf3</span><br><span class=\"line\">  - vim</span><br><span class=\"line\">  - curl</span><br><span class=\"line\">  - wget</span><br><span class=\"line\">  - cloud-guest-utils <span class=\"comment\"># Ensure growpart is available</span></span><br><span class=\"line\"></span><br><span class=\"line\">ntp:</span><br><span class=\"line\">  servers: [<span class=\"string\">&#x27;ntp.esl.cisco.com&#x27;</span>]</span><br><span class=\"line\"></span><br><span class=\"line\">runcmd:</span><br><span class=\"line\">  - <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Attempting to resize root partition and filesystem...&quot;</span></span><br><span class=\"line\">  - growpart /dev/vda 1 <span class=\"comment\"># Expand the first partition on /dev/vda</span></span><br><span class=\"line\">  - resize2fs /dev/vda1 <span class=\"comment\"># Expand the ext4 filesystem on /dev/vda1</span></span><br><span class=\"line\">  - <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Disk resize commands executed. Verify with &#x27;df -h&#x27; after boot.&quot;</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"network-config\"><a href=\"#network-config\" class=\"headerlink\" title=\"network-config\"></a>network-config</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">network:</span><br><span class=\"line\">  version: 2</span><br><span class=\"line\">  ethernets:</span><br><span class=\"line\">    enp1s0:</span><br><span class=\"line\">      addresses:</span><br><span class=\"line\">      - <span class=\"string\">&quot;10.75.59.71/24&quot;</span></span><br><span class=\"line\">      nameservers:</span><br><span class=\"line\">        addresses:</span><br><span class=\"line\">        - 64.104.76.247</span><br><span class=\"line\">        - 64.104.14.184</span><br><span class=\"line\">        search:</span><br><span class=\"line\">        - cisco.com</span><br><span class=\"line\">      routes:</span><br><span class=\"line\">      - to: <span class=\"string\">&quot;default&quot;</span></span><br><span class=\"line\">        via: <span class=\"string\">&quot;10.75.59.1&quot;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"meta-data\"><a href=\"#meta-data\" class=\"headerlink\" title=\"meta-data\"></a>meta-data</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">instance-id: kube-node-1</span><br><span class=\"line\">local-hostname: kube-node-1</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"2-使用Ansible安装Kubernetes\"><a href=\"#2-使用Ansible安装Kubernetes\" class=\"headerlink\" title=\"2. 使用Ansible安装Kubernetes\"></a>2. 使用Ansible安装Kubernetes</h1><h2 id=\"2-1-脚本内容\"><a href=\"#2-1-脚本内容\" class=\"headerlink\" title=\"2.1 脚本内容\"></a>2.1 脚本内容</h2><p>以下脚本可用于自动化安装Ansible，并生成Playbook，可直接执行安装任务。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br><span class=\"line\">252</span><br><span class=\"line\">253</span><br><span class=\"line\">254</span><br><span class=\"line\">255</span><br><span class=\"line\">256</span><br><span class=\"line\">257</span><br><span class=\"line\">258</span><br><span class=\"line\">259</span><br><span class=\"line\">260</span><br><span class=\"line\">261</span><br><span class=\"line\">262</span><br><span class=\"line\">263</span><br><span class=\"line\">264</span><br><span class=\"line\">265</span><br><span class=\"line\">266</span><br><span class=\"line\">267</span><br><span class=\"line\">268</span><br><span class=\"line\">269</span><br><span class=\"line\">270</span><br><span class=\"line\">271</span><br><span class=\"line\">272</span><br><span class=\"line\">273</span><br><span class=\"line\">274</span><br><span class=\"line\">275</span><br><span class=\"line\">276</span><br><span class=\"line\">277</span><br><span class=\"line\">278</span><br><span class=\"line\">279</span><br><span class=\"line\">280</span><br><span class=\"line\">281</span><br><span class=\"line\">282</span><br><span class=\"line\">283</span><br><span class=\"line\">284</span><br><span class=\"line\">285</span><br><span class=\"line\">286</span><br><span class=\"line\">287</span><br><span class=\"line\">288</span><br><span class=\"line\">289</span><br><span class=\"line\">290</span><br><span class=\"line\">291</span><br><span class=\"line\">292</span><br><span class=\"line\">293</span><br><span class=\"line\">294</span><br><span class=\"line\">295</span><br><span class=\"line\">296</span><br><span class=\"line\">297</span><br><span class=\"line\">298</span><br><span class=\"line\">299</span><br><span class=\"line\">300</span><br><span class=\"line\">301</span><br><span class=\"line\">302</span><br><span class=\"line\">303</span><br><span class=\"line\">304</span><br><span class=\"line\">305</span><br><span class=\"line\">306</span><br><span class=\"line\">307</span><br><span class=\"line\">308</span><br><span class=\"line\">309</span><br><span class=\"line\">310</span><br><span class=\"line\">311</span><br><span class=\"line\">312</span><br><span class=\"line\">313</span><br><span class=\"line\">314</span><br><span class=\"line\">315</span><br><span class=\"line\">316</span><br><span class=\"line\">317</span><br><span class=\"line\">318</span><br><span class=\"line\">319</span><br><span class=\"line\">320</span><br><span class=\"line\">321</span><br><span class=\"line\">322</span><br><span class=\"line\">323</span><br><span class=\"line\">324</span><br><span class=\"line\">325</span><br><span class=\"line\">326</span><br><span class=\"line\">327</span><br><span class=\"line\">328</span><br><span class=\"line\">329</span><br><span class=\"line\">330</span><br><span class=\"line\">331</span><br><span class=\"line\">332</span><br><span class=\"line\">333</span><br><span class=\"line\">334</span><br><span class=\"line\">335</span><br><span class=\"line\">336</span><br><span class=\"line\">337</span><br><span class=\"line\">338</span><br><span class=\"line\">339</span><br><span class=\"line\">340</span><br><span class=\"line\">341</span><br><span class=\"line\">342</span><br><span class=\"line\">343</span><br><span class=\"line\">344</span><br><span class=\"line\">345</span><br><span class=\"line\">346</span><br><span class=\"line\">347</span><br><span class=\"line\">348</span><br><span class=\"line\">349</span><br><span class=\"line\">350</span><br><span class=\"line\">351</span><br><span class=\"line\">352</span><br><span class=\"line\">353</span><br><span class=\"line\">354</span><br><span class=\"line\">355</span><br><span class=\"line\">356</span><br><span class=\"line\">357</span><br><span class=\"line\">358</span><br><span class=\"line\">359</span><br><span class=\"line\">360</span><br><span class=\"line\">361</span><br><span class=\"line\">362</span><br><span class=\"line\">363</span><br><span class=\"line\">364</span><br><span class=\"line\">365</span><br><span class=\"line\">366</span><br><span class=\"line\">367</span><br><span class=\"line\">368</span><br><span class=\"line\">369</span><br><span class=\"line\">370</span><br><span class=\"line\">371</span><br><span class=\"line\">372</span><br><span class=\"line\">373</span><br><span class=\"line\">374</span><br><span class=\"line\">375</span><br><span class=\"line\">376</span><br><span class=\"line\">377</span><br><span class=\"line\">378</span><br><span class=\"line\">379</span><br><span class=\"line\">380</span><br><span class=\"line\">381</span><br><span class=\"line\">382</span><br><span class=\"line\">383</span><br><span class=\"line\">384</span><br><span class=\"line\">385</span><br><span class=\"line\">386</span><br><span class=\"line\">387</span><br><span class=\"line\">388</span><br><span class=\"line\">389</span><br><span class=\"line\">390</span><br><span class=\"line\">391</span><br><span class=\"line\">392</span><br><span class=\"line\">393</span><br><span class=\"line\">394</span><br><span class=\"line\">395</span><br><span class=\"line\">396</span><br><span class=\"line\">397</span><br><span class=\"line\">398</span><br><span class=\"line\">399</span><br><span class=\"line\">400</span><br><span class=\"line\">401</span><br><span class=\"line\">402</span><br><span class=\"line\">403</span><br><span class=\"line\">404</span><br><span class=\"line\">405</span><br><span class=\"line\">406</span><br><span class=\"line\">407</span><br><span class=\"line\">408</span><br><span class=\"line\">409</span><br><span class=\"line\">410</span><br><span class=\"line\">411</span><br><span class=\"line\">412</span><br><span class=\"line\">413</span><br><span class=\"line\">414</span><br><span class=\"line\">415</span><br><span class=\"line\">416</span><br><span class=\"line\">417</span><br><span class=\"line\">418</span><br><span class=\"line\">419</span><br><span class=\"line\">420</span><br><span class=\"line\">421</span><br><span class=\"line\">422</span><br><span class=\"line\">423</span><br><span class=\"line\">424</span><br><span class=\"line\">425</span><br><span class=\"line\">426</span><br><span class=\"line\">427</span><br><span class=\"line\">428</span><br><span class=\"line\">429</span><br><span class=\"line\">430</span><br><span class=\"line\">431</span><br><span class=\"line\">432</span><br><span class=\"line\">433</span><br><span class=\"line\">434</span><br><span class=\"line\">435</span><br><span class=\"line\">436</span><br><span class=\"line\">437</span><br><span class=\"line\">438</span><br><span class=\"line\">439</span><br><span class=\"line\">440</span><br><span class=\"line\">441</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#!/bin/bash</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># This script automates the setup of an Ansible environment for Kubernetes cluster deployment.</span></span><br><span class=\"line\"><span class=\"comment\"># It installs Ansible, creates the project directory, inventory, configuration,</span></span><br><span class=\"line\"><span class=\"comment\"># and defines common Kubernetes setup tasks.</span></span><br><span class=\"line\"><span class=\"comment\"># This version stops after installing Kubernetes components, allowing manual kubeadm init/join.</span></span><br><span class=\"line\"><span class=\"comment\"># Includes a robust fix for Containerd&#x27;s SystemdCgroup configuration and CRI plugin enabling,</span></span><br><span class=\"line\"><span class=\"comment\"># defines the necessary handler for restarting Containerd, dynamically adds host entries to /etc/hosts,</span></span><br><span class=\"line\"><span class=\"comment\"># and updates the pause image version in the manual instructions.</span></span><br><span class=\"line\"><span class=\"comment\"># This update also addresses the runc runtime root configuration in containerd and fixes</span></span><br><span class=\"line\"><span class=\"comment\"># YAML escape character issues in the hosts file regex, and updates the sandbox image in containerd config.</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># --- Configuration ---</span></span><br><span class=\"line\">PROJECT_DIR=<span class=\"string\">&quot;k8s_cluster_setup&quot;</span></span><br><span class=\"line\">MASTER_NODE_IP=<span class=\"string\">&quot;10.75.59.71&quot;</span> <span class=\"comment\"># Based on your previous script&#x27;s IP assignment for kube-node-1</span></span><br><span class=\"line\">WORKER_NODE_IP_1=<span class=\"string\">&quot;10.75.59.72&quot;</span> <span class=\"comment\"># Based on your previous script&#x27;s IP assignment for kube-node-2</span></span><br><span class=\"line\">WORKER_NODE_IP_2=<span class=\"string\">&quot;10.75.59.73&quot;</span> <span class=\"comment\"># Based on your previous script&#x27;s IP address for kube-node-3</span></span><br><span class=\"line\">ANSIBLE_USER=<span class=\"string\">&quot;ubuntu&quot;</span> <span class=\"comment\"># The user created by cloud-init on your VMs</span></span><br><span class=\"line\">SSH_PRIVATE_KEY_PATH=<span class=\"string\">&quot;~/.ssh/id_rsa&quot;</span> <span class=\"comment\"># Path to your SSH private key on the Ansible control machine</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># --- Functions ---</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Function to install Ansible</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">install_ansible</span></span>() &#123;</span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;--- Installing Ansible ---&quot;</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> ! <span class=\"built_in\">command</span> -v ansible &amp;&gt; /dev/null; <span class=\"keyword\">then</span></span><br><span class=\"line\">        <span class=\"built_in\">sudo</span> apt update -y</span><br><span class=\"line\">        <span class=\"built_in\">sudo</span> apt install -y ansible</span><br><span class=\"line\">        <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Ansible installed successfully.&quot;</span></span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">        <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Ansible is already installed.&quot;</span></span><br><span class=\"line\">    <span class=\"keyword\">fi</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Function to create project directory and navigate into it</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">create_project_dir</span></span>() &#123;</span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;--- Creating project directory: <span class=\"variable\">$&#123;PROJECT_DIR&#125;</span> ---&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">mkdir</span> -p <span class=\"string\">&quot;<span class=\"variable\">$&#123;PROJECT_DIR&#125;</span>&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">cd</span> <span class=\"string\">&quot;<span class=\"variable\">$&#123;PROJECT_DIR&#125;</span>&quot;</span> || &#123; <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Failed to change directory to <span class=\"variable\">$&#123;PROJECT_DIR&#125;</span>. Exiting.&quot;</span>; <span class=\"built_in\">exit</span> 1; &#125;</span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Changed to directory: <span class=\"subst\">$(pwd)</span>&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Function to create ansible.cfg</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">create_ansible_cfg</span></span>() &#123;</span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;--- Creating ansible.cfg ---&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOF &gt; ansible.cfg</span></span><br><span class=\"line\"><span class=\"string\">[defaults]</span></span><br><span class=\"line\"><span class=\"string\">inventory = inventory.ini</span></span><br><span class=\"line\"><span class=\"string\">roles_path = ./roles</span></span><br><span class=\"line\"><span class=\"string\">host_key_checking = False # WARNING: Disable host key checking for convenience during initial setup. Re-enable for production!</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;ansible.cfg created.&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Function to create inventory.ini (UPDATED with IP variables)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">create_inventory</span></span>() &#123;</span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;--- Creating inventory.ini ---&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOF &gt; inventory.ini</span></span><br><span class=\"line\"><span class=\"string\">[master]</span></span><br><span class=\"line\"><span class=\"string\">kube-node-1 ansible_host=$&#123;MASTER_NODE_IP&#125;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">[workers]</span></span><br><span class=\"line\"><span class=\"string\">kube-node-2 ansible_host=$&#123;WORKER_NODE_IP_1&#125;</span></span><br><span class=\"line\"><span class=\"string\">kube-node-3 ansible_host=$&#123;WORKER_NODE_IP_2&#125;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">[all:vars]</span></span><br><span class=\"line\"><span class=\"string\">ansible_user=$&#123;ANSIBLE_USER&#125;</span></span><br><span class=\"line\"><span class=\"string\">ansible_ssh_private_key_file=$&#123;SSH_PRIVATE_KEY_PATH&#125;</span></span><br><span class=\"line\"><span class=\"string\">ansible_python_interpreter=/usr/bin/python3</span></span><br><span class=\"line\"><span class=\"string\"># These variables are now primarily for documentation/script clarity,</span></span><br><span class=\"line\"><span class=\"string\"># as the hosts file task will dynamically read from inventory groups.</span></span><br><span class=\"line\"><span class=\"string\">master_node_ip=$&#123;MASTER_NODE_IP&#125;</span></span><br><span class=\"line\"><span class=\"string\">worker_node_ip_1=$&#123;WORKER_NODE_IP_1&#125;</span></span><br><span class=\"line\"><span class=\"string\">worker_node_ip_2=$&#123;WORKER_NODE_IP_2&#125;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;inventory.ini created.&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Function to create main playbook.yml (Modified to only include common setup)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">create_playbook</span></span>() &#123;</span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;--- Creating playbook.yml ---&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOF &gt; playbook.yml</span></span><br><span class=\"line\"><span class=\"string\">---</span></span><br><span class=\"line\"><span class=\"string\">- name: Common Kubernetes Setup for all nodes</span></span><br><span class=\"line\"><span class=\"string\">  hosts: all</span></span><br><span class=\"line\"><span class=\"string\">  become: yes</span></span><br><span class=\"line\"><span class=\"string\">  roles:</span></span><br><span class=\"line\"><span class=\"string\">    - common_k8s_setup</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;playbook.yml created (only common setup included).&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Function to create roles and their tasks</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">create_roles</span></span>() &#123;</span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;--- Creating Ansible roles and tasks ---&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># common_k8s_setup role</span></span><br><span class=\"line\">    <span class=\"built_in\">mkdir</span> -p roles/common_k8s_setup/tasks</span><br><span class=\"line\">    <span class=\"comment\"># UPDATED: main.yml to include the new hosts entry task first</span></span><br><span class=\"line\">    <span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOF &gt; roles/common_k8s_setup/tasks/main.yml</span></span><br><span class=\"line\"><span class=\"string\">---</span></span><br><span class=\"line\"><span class=\"string\">- name: Include add hosts entries task</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.include_tasks: 00_add_hosts_entries.yml</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Include disable swap task</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.include_tasks: 01_disable_swap.yml</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Include containerd setup task</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.include_tasks: 02_containerd_setup.yml</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Include kernel modules and sysctl task</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.include_tasks: 03_kernel_modules_sysctl.yml</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Include kube repo, install, and hold task</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.include_tasks: 04_kube_repo_install_hold.yml</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Include initial apt upgrade task</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.include_tasks: 05_initial_upgrade.yml</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Include configure weekly updates task</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.include_tasks: 06_configure_weekly_updates.yml</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># NEW FILE: 00_add_hosts_entries.yml (Dynamically adds hosts from inventory, FIXED: Escaped backslashes in regex)</span></span><br><span class=\"line\">    <span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOF &gt; roles/common_k8s_setup/tasks/00_add_hosts_entries.yml</span></span><br><span class=\"line\"><span class=\"string\">---</span></span><br><span class=\"line\"><span class=\"string\">- name: Add all inventory hosts to /etc/hosts on each node</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.lineinfile:</span></span><br><span class=\"line\"><span class=\"string\">    path: /etc/hosts</span></span><br><span class=\"line\"><span class=\"string\">    regexp: &quot;^&#123;&#123; hostvars[item][&#x27;ansible_host&#x27;] &#125;&#125;\\\\\\\\s+&#123;&#123; item &#125;&#125;&quot; # Fixed: \\\\\\\\s for escaped backslash in regex</span></span><br><span class=\"line\"><span class=\"string\">    line: &quot;&#123;&#123; hostvars[item][&#x27;ansible_host&#x27;] &#125;&#125; &#123;&#123; item &#125;&#125;&quot;</span></span><br><span class=\"line\"><span class=\"string\">    state: present</span></span><br><span class=\"line\"><span class=\"string\">    create: yes</span></span><br><span class=\"line\"><span class=\"string\">    mode: &#x27;0644&#x27;</span></span><br><span class=\"line\"><span class=\"string\">    owner: root</span></span><br><span class=\"line\"><span class=\"string\">    group: root</span></span><br><span class=\"line\"><span class=\"string\">  loop: &quot;&#123;&#123; groups[&#x27;all&#x27;] &#125;&#125;&quot; # Loop over all hosts defined in the inventory</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># Create handlers directory and file</span></span><br><span class=\"line\">    <span class=\"built_in\">mkdir</span> -p roles/common_k8s_setup/handlers</span><br><span class=\"line\">    <span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOF &gt; roles/common_k8s_setup/handlers/main.yml</span></span><br><span class=\"line\"><span class=\"string\">---</span></span><br><span class=\"line\"><span class=\"string\">- name: Restart containerd service</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.systemd:</span></span><br><span class=\"line\"><span class=\"string\">    name: containerd</span></span><br><span class=\"line\"><span class=\"string\">    state: restarted</span></span><br><span class=\"line\"><span class=\"string\">    daemon_reload: yes</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># 01_disable_swap.yml</span></span><br><span class=\"line\">    <span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOF &gt; roles/common_k8s_setup/tasks/01_disable_swap.yml</span></span><br><span class=\"line\"><span class=\"string\">---</span></span><br><span class=\"line\"><span class=\"string\">- name: Check if swap is active</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.command: swapon --show</span></span><br><span class=\"line\"><span class=\"string\">  register: swap_check_result</span></span><br><span class=\"line\"><span class=\"string\">  changed_when: false # This command itself doesn&#x27;t change state</span></span><br><span class=\"line\"><span class=\"string\">  failed_when: false  # Don&#x27;t fail if swapon --show returns non-zero (e.g., no swap enabled)</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Disable swap</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.command: swapoff -a</span></span><br><span class=\"line\"><span class=\"string\">  when: swap_check_result.rc == 0 # Only run if swapon --show indicated swap is active</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Persistently disable swap (comment out swapfile in fstab)</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.replace:</span></span><br><span class=\"line\"><span class=\"string\">    path: /etc/fstab</span></span><br><span class=\"line\"><span class=\"string\">    regexp: &#x27;^(/swapfile.*)$&#x27;</span></span><br><span class=\"line\"><span class=\"string\">    replace: &#x27;#\\1&#x27;</span></span><br><span class=\"line\"><span class=\"string\">  when: swap_check_result.rc == 0 # Only run if swap was found to be active</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># 02_containerd_setup.yml (UPDATED for sandbox_image)</span></span><br><span class=\"line\">    <span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOF &gt; roles/common_k8s_setup/tasks/02_containerd_setup.yml</span></span><br><span class=\"line\"><span class=\"string\">---</span></span><br><span class=\"line\"><span class=\"string\">- name: Install required packages for Containerd</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.apt:</span></span><br><span class=\"line\"><span class=\"string\">    name:</span></span><br><span class=\"line\"><span class=\"string\">      - ca-certificates</span></span><br><span class=\"line\"><span class=\"string\">      - curl</span></span><br><span class=\"line\"><span class=\"string\">      - gnupg</span></span><br><span class=\"line\"><span class=\"string\">      - lsb-release</span></span><br><span class=\"line\"><span class=\"string\">      - apt-transport-https</span></span><br><span class=\"line\"><span class=\"string\">      - software-properties-common</span></span><br><span class=\"line\"><span class=\"string\">    state: present</span></span><br><span class=\"line\"><span class=\"string\">    update_cache: yes</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Add Docker GPG key</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.apt_key:</span></span><br><span class=\"line\"><span class=\"string\">    url: https://download.docker.com/linux/ubuntu/gpg</span></span><br><span class=\"line\"><span class=\"string\">    state: present</span></span><br><span class=\"line\"><span class=\"string\">    keyring: /etc/apt/keyrings/docker.gpg # Use keyring for modern apt</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Add Docker APT repository</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.apt_repository:</span></span><br><span class=\"line\"><span class=\"string\">    repo: &quot;deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu &#123;&#123; ansible_distribution_release &#125;&#125; stable&quot;</span></span><br><span class=\"line\"><span class=\"string\">    state: present</span></span><br><span class=\"line\"><span class=\"string\">    filename: docker</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Install Containerd</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.apt:</span></span><br><span class=\"line\"><span class=\"string\">    name: containerd.io</span></span><br><span class=\"line\"><span class=\"string\">    state: present</span></span><br><span class=\"line\"><span class=\"string\">    update_cache: yes</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Create containerd configuration directory</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.file:</span></span><br><span class=\"line\"><span class=\"string\">    path: /etc/containerd</span></span><br><span class=\"line\"><span class=\"string\">    state: directory</span></span><br><span class=\"line\"><span class=\"string\">    mode: &#x27;0755&#x27;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Generate default containerd configuration directly to final path</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.shell: containerd config default &gt; /etc/containerd/config.toml</span></span><br><span class=\"line\"><span class=\"string\">  changed_when: true # Always report change as we&#x27;re ensuring a default state</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Ensure CRI plugin is enabled (remove any disabled_plugins line containing &quot;cri&quot;)</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.lineinfile:</span></span><br><span class=\"line\"><span class=\"string\">    path: /etc/containerd/config.toml</span></span><br><span class=\"line\"><span class=\"string\">    regexp: &#x27;^\\s*disabled_plugins = \\[.*&quot;cri&quot;.*\\]&#x27; # More general regexp</span></span><br><span class=\"line\"><span class=\"string\">    state: absent</span></span><br><span class=\"line\"><span class=\"string\">    backup: yes</span></span><br><span class=\"line\"><span class=\"string\">  notify: Restart containerd service</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Remove top-level systemd_cgroup from CRI plugin section</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.lineinfile:</span></span><br><span class=\"line\"><span class=\"string\">    path: /etc/containerd/config.toml</span></span><br><span class=\"line\"><span class=\"string\">    regexp: &#x27;^\\s*systemd_cgroup = (true|false)&#x27; # Matches the &#x27;systemd_cgroup&#x27; directly under [plugins.&quot;io.containerd.grpc.v1.cri&quot;]</span></span><br><span class=\"line\"><span class=\"string\">    state: absent # Remove this line</span></span><br><span class=\"line\"><span class=\"string\">    backup: yes</span></span><br><span class=\"line\"><span class=\"string\">  notify: Restart containerd service</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Remove old runtime_root from runc runtime section</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.lineinfile:</span></span><br><span class=\"line\"><span class=\"string\">    path: /etc/containerd/config.toml</span></span><br><span class=\"line\"><span class=\"string\">    regexp: &#x27;^\\s*runtime_root = &quot;.*&quot;&#x27; # Matches runtime_root line</span></span><br><span class=\"line\"><span class=\"string\">    state: absent</span></span><br><span class=\"line\"><span class=\"string\">    backup: yes</span></span><br><span class=\"line\"><span class=\"string\">  notify: Restart containerd service</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Configure runc runtime to use SystemdCgroup = true</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.lineinfile:</span></span><br><span class=\"line\"><span class=\"string\">    path: /etc/containerd/config.toml</span></span><br><span class=\"line\"><span class=\"string\">    regexp: &#x27;^\\s*#?\\s*SystemdCgroup = (true|false)&#x27; # Matches the &#x27;SystemdCgroup&#x27; under runc.options</span></span><br><span class=\"line\"><span class=\"string\">    line: &#x27;            SystemdCgroup = true&#x27; # Ensure correct indentation</span></span><br><span class=\"line\"><span class=\"string\">    insertafter: &#x27;^\\s*\\[plugins\\.&quot;io\\.containerd\\.grpc\\.v1\\.cri&quot;\\.containerd\\.runtimes\\.runc\\.options\\]&#x27;</span></span><br><span class=\"line\"><span class=\"string\">    backup: yes</span></span><br><span class=\"line\"><span class=\"string\">  notify: Restart containerd service</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Add Root path to runc options</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.lineinfile:</span></span><br><span class=\"line\"><span class=\"string\">    path: /etc/containerd/config.toml</span></span><br><span class=\"line\"><span class=\"string\">    regexp: &#x27;^\\s*Root = &quot;.*&quot;&#x27; # Matches existing Root line if any</span></span><br><span class=\"line\"><span class=\"string\">    line: &#x27;            Root = &quot;/run/containerd/runc&quot;&#x27; # New Root path</span></span><br><span class=\"line\"><span class=\"string\">    insertafter: &#x27;^\\s*\\[plugins\\.&quot;io\\.containerd\\.grpc\\.v1\\.cri&quot;\\.containerd\\.runtimes\\.runc\\.options\\]&#x27;</span></span><br><span class=\"line\"><span class=\"string\">    backup: yes</span></span><br><span class=\"line\"><span class=\"string\">  notify: Restart containerd service</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Update sandbox_image to pause:3.10</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.lineinfile:</span></span><br><span class=\"line\"><span class=\"string\">    path: /etc/containerd/config.toml</span></span><br><span class=\"line\"><span class=\"string\">    regexp: &#x27;^\\s*sandbox_image = &quot;registry.k8s.io/pause:.*&quot;&#x27;</span></span><br><span class=\"line\"><span class=\"string\">    line: &#x27;    sandbox_image = &quot;registry.k8s.io/pause:3.10&quot;&#x27;</span></span><br><span class=\"line\"><span class=\"string\">    insertafter: &#x27;^\\s*\\[plugins\\.&quot;io\\.containerd\\.grpc\\.v1\\.cri&quot;\\]&#x27; # Insert after the CRI plugin section start</span></span><br><span class=\"line\"><span class=\"string\">    backup: yes</span></span><br><span class=\"line\"><span class=\"string\">  notify: Restart containerd service</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># 03_kernel_modules_sysctl.yml</span></span><br><span class=\"line\">    <span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOF &gt; roles/common_k8s_setup/tasks/03_kernel_modules_sysctl.yml</span></span><br><span class=\"line\"><span class=\"string\">---</span></span><br><span class=\"line\"><span class=\"string\">- name: Load overlay module</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.command: modprobe overlay</span></span><br><span class=\"line\"><span class=\"string\">  args:</span></span><br><span class=\"line\"><span class=\"string\">    creates: /sys/module/overlay # Check if module is loaded</span></span><br><span class=\"line\"><span class=\"string\">  changed_when: false</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Load br_netfilter module</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.command: modprobe br_netfilter</span></span><br><span class=\"line\"><span class=\"string\">  args:</span></span><br><span class=\"line\"><span class=\"string\">    creates: /sys/module/br_netfilter # Check if module is loaded</span></span><br><span class=\"line\"><span class=\"string\">  changed_when: false</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Add modules to /etc/modules-load.d/k8s.conf</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.copy:</span></span><br><span class=\"line\"><span class=\"string\">    dest: /etc/modules-load.d/k8s.conf</span></span><br><span class=\"line\"><span class=\"string\">    content: |</span></span><br><span class=\"line\"><span class=\"string\">      overlay</span></span><br><span class=\"line\"><span class=\"string\">      br_netfilter</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Configure sysctl parameters for Kubernetes networking</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.copy:</span></span><br><span class=\"line\"><span class=\"string\">    dest: /etc/sysctl.d/k8s.conf</span></span><br><span class=\"line\"><span class=\"string\">    content: |</span></span><br><span class=\"line\"><span class=\"string\">      net.bridge.bridge-nf-call-iptables = 1</span></span><br><span class=\"line\"><span class=\"string\">      net.bridge.bridge-nf-call-ip6tables = 1</span></span><br><span class=\"line\"><span class=\"string\">      net.ipv4.ip_forward = 1</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Apply sysctl parameters</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.command: sysctl --system</span></span><br><span class=\"line\"><span class=\"string\">  changed_when: false</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># 04_kube_repo_install_hold.yml</span></span><br><span class=\"line\">    <span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOF &gt; roles/common_k8s_setup/tasks/04_kube_repo_install_hold.yml</span></span><br><span class=\"line\"><span class=\"string\">---</span></span><br><span class=\"line\"><span class=\"string\">- name: Create Kubernetes apt keyring directory</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.file:</span></span><br><span class=\"line\"><span class=\"string\">    path: /etc/apt/keyrings</span></span><br><span class=\"line\"><span class=\"string\">    state: directory</span></span><br><span class=\"line\"><span class=\"string\">    mode: &#x27;0755&#x27;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Download Kubernetes GPG key and dearmor</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.shell: |</span></span><br><span class=\"line\"><span class=\"string\">    curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.33/deb/Release.key | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg</span></span><br><span class=\"line\"><span class=\"string\">  args:</span></span><br><span class=\"line\"><span class=\"string\">    creates: /etc/apt/keyrings/kubernetes-apt-keyring.gpg</span></span><br><span class=\"line\"><span class=\"string\">  changed_when: false # This command is idempotent enough for our purposes</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Add Kubernetes APT repository source list</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.copy:</span></span><br><span class=\"line\"><span class=\"string\">    dest: /etc/apt/sources.list.d/kubernetes.list</span></span><br><span class=\"line\"><span class=\"string\">    content: &quot;deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.33/deb/ /\\n&quot;</span></span><br><span class=\"line\"><span class=\"string\">    mode: &#x27;0644&#x27;</span></span><br><span class=\"line\"><span class=\"string\">    backup: yes</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Update apt cache after adding Kubernetes repo</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.apt:</span></span><br><span class=\"line\"><span class=\"string\">    update_cache: yes</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Install kubelet, kubeadm, kubectl</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.apt:</span></span><br><span class=\"line\"><span class=\"string\">    name:</span></span><br><span class=\"line\"><span class=\"string\">      - kubelet</span></span><br><span class=\"line\"><span class=\"string\">      - kubeadm</span></span><br><span class=\"line\"><span class=\"string\">      - kubectl</span></span><br><span class=\"line\"><span class=\"string\">    state: present</span></span><br><span class=\"line\"><span class=\"string\">    update_cache: yes # Ensure apt cache is updated after adding repo.</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Hold kubelet, kubeadm, kubectl packages</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.dpkg_selections:</span></span><br><span class=\"line\"><span class=\"string\">    name: &quot;&#123;&#123; item &#125;&#125;&quot;</span></span><br><span class=\"line\"><span class=\"string\">    selection: hold</span></span><br><span class=\"line\"><span class=\"string\">  loop:</span></span><br><span class=\"line\"><span class=\"string\">    - kubelet</span></span><br><span class=\"line\"><span class=\"string\">    - kubeadm</span></span><br><span class=\"line\"><span class=\"string\">    - kubectl</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Enable and start kubelet service</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.systemd:</span></span><br><span class=\"line\"><span class=\"string\">    name: kubelet</span></span><br><span class=\"line\"><span class=\"string\">    state: started</span></span><br><span class=\"line\"><span class=\"string\">    enabled: yes</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># NEW FILE: 05_initial_upgrade.yml</span></span><br><span class=\"line\">    <span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOF &gt; roles/common_k8s_setup/tasks/05_initial_upgrade.yml</span></span><br><span class=\"line\"><span class=\"string\">---</span></span><br><span class=\"line\"><span class=\"string\">- name: Perform initial apt update and upgrade</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.apt:</span></span><br><span class=\"line\"><span class=\"string\">    update_cache: yes</span></span><br><span class=\"line\"><span class=\"string\">    upgrade: yes</span></span><br><span class=\"line\"><span class=\"string\">    autoremove: yes</span></span><br><span class=\"line\"><span class=\"string\">    purge: yes</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># NEW FILE: 06_configure_weekly_updates.yml</span></span><br><span class=\"line\">    <span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOF &gt; roles/common_k8s_setup/tasks/06_configure_weekly_updates.yml</span></span><br><span class=\"line\"><span class=\"string\">---</span></span><br><span class=\"line\"><span class=\"string\">- name: Configure weekly apt update and upgrade cron job</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.cron:</span></span><br><span class=\"line\"><span class=\"string\">    name: &quot;weekly apt update and upgrade&quot;</span></span><br><span class=\"line\"><span class=\"string\">    weekday: &quot;0&quot; # Sunday</span></span><br><span class=\"line\"><span class=\"string\">    hour: &quot;3&quot;    # 3 AM</span></span><br><span class=\"line\"><span class=\"string\">    minute: &quot;0&quot;</span></span><br><span class=\"line\"><span class=\"string\">    job: &quot;/usr/bin/apt update &amp;&amp; /usr/bin/apt upgrade -y &amp;&amp; /usr/bin/apt autoremove -y &amp;&amp; /usr/bin/apt clean&quot;</span></span><br><span class=\"line\"><span class=\"string\">    user: root</span></span><br><span class=\"line\"><span class=\"string\">    state: present</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># Master and Worker roles are still created for structure, but not called by playbook.yml</span></span><br><span class=\"line\">    <span class=\"built_in\">mkdir</span> -p roles/k8s-master/tasks</span><br><span class=\"line\">    <span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOF &gt; roles/k8s-master/tasks/main.yml</span></span><br><span class=\"line\"><span class=\"string\">---</span></span><br><span class=\"line\"><span class=\"string\">- name: This role is intentionally skipped by the main playbook for manual setup.</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.debug:</span></span><br><span class=\"line\"><span class=\"string\">    msg: &quot;This master role is not executed by default. Run &#x27;kubeadm init&#x27; manually on the master node.&quot;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">mkdir</span> -p roles/k8s-worker/tasks</span><br><span class=\"line\">    <span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOF &gt; roles/k8s-worker/tasks/main.yml</span></span><br><span class=\"line\"><span class=\"string\">---</span></span><br><span class=\"line\"><span class=\"string\">- name: This role is intentionally skipped by the main playbook for manual setup.</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.debug:</span></span><br><span class=\"line\"><span class=\"string\">    msg: &quot;This worker role is not executed by default. Run &#x27;kubeadm join&#x27; manually on worker nodes.&quot;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Ansible roles and tasks created.&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># --- Main execution ---</span></span><br><span class=\"line\">install_ansible</span><br><span class=\"line\">create_project_dir</span><br><span class=\"line\">create_ansible_cfg</span><br><span class=\"line\">create_inventory</span><br><span class=\"line\">create_playbook</span><br><span class=\"line\">create_roles</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;--- Ansible setup for Kubernetes installation is complete! ---&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;Navigate to the project directory:&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;cd <span class=\"variable\">$&#123;PROJECT_DIR&#125;</span>&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;Then, run the Ansible playbook to install Kubernetes components on all nodes:&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;ansible-playbook playbook.yml -K&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;After the playbook finishes, you will need to manually initialize the Kubernetes cluster:&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;1. SSH into the master node (kube-node-1):&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;   ssh ubuntu@<span class=\"variable\">$&#123;MASTER_NODE_IP&#125;</span>&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;2. Initialize the Kubernetes control plane on the master node:&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;   sudo kubeadm init --control-plane-endpoint=kube-node-1 --pod-network-cidr=172.16.0.0/20 --service-cidr=172.16.32.0/20 --skip-phases=addon/kube-proxy --pod-infra-container-image=registry.k8s.io/pause:3.10&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;3. After &#x27;kubeadm init&#x27; completes, it will print instructions to set up kubectl and the &#x27;kubeadm join&#x27; command.&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;   Follow the instructions to set up kubectl for the &#x27;ubuntu&#x27; user:&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;   mkdir -p \\$HOME/.kube&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;   sudo cp -i /etc/kubernetes/admin.conf \\$HOME/.kube/config&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;   sudo chown \\$(id -u):\\$(id -g) \\$HOME/.kube/config&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;4. Copy the &#x27;kubeadm join&#x27; command (including the token and discovery-token-ca-cert-hash) printed by &#x27;kubeadm init&#x27;.&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;   It will look something like: &#x27;kubeadm join &lt;master-ip&gt;:6443 --token &lt;token&gt; --discovery-token-ca-cert-hash sha256:&lt;hash&gt;&#x27;&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;5. SSH into each worker node (kube-node-2, kube-node-3) and run the join command:&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;   ssh ubuntu@<span class=\"variable\">$&#123;WORKER_NODE_IP_1&#125;</span> (for kube-node-2)&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;   sudo &lt;PASTE_YOUR_KUBEADM_JOIN_COMMAND_HERE&gt;&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;   ssh ubuntu@<span class=\"variable\">$&#123;WORKER_NODE_IP_2&#125;</span> (for kube-node-3)&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;   sudo &lt;PASTE_YOUR_KUBEADM_JOIN_COMMAND_HERE&gt;&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;6. Verify your cluster status from the master node:&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;   ssh ubuntu@<span class=\"variable\">$&#123;MASTER_NODE_IP&#125;</span>&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;   kubectl get nodes&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;   kubectl get pods --all-namespaces&quot;</span></span><br></pre></td></tr></table></figure>\n\n<p>上述脚本执行完后，创建以下文档</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@ois:/home/ois/data/k8s/k8s_cluster_setup# <span class=\"built_in\">ls</span> -R1</span><br><span class=\"line\">.:</span><br><span class=\"line\">ansible.cfg</span><br><span class=\"line\">inventory.ini</span><br><span class=\"line\">playbook.yml</span><br><span class=\"line\">roles</span><br><span class=\"line\"></span><br><span class=\"line\">./roles:</span><br><span class=\"line\">common_k8s_setup</span><br><span class=\"line\">k8s-master</span><br><span class=\"line\">k8s-worker</span><br><span class=\"line\"></span><br><span class=\"line\">./roles/common_k8s_setup:</span><br><span class=\"line\">handlers</span><br><span class=\"line\">tasks</span><br><span class=\"line\"></span><br><span class=\"line\">./roles/common_k8s_setup/handlers:</span><br><span class=\"line\">main.yml</span><br><span class=\"line\"></span><br><span class=\"line\">./roles/common_k8s_setup/tasks:</span><br><span class=\"line\">00_add_hosts_entries.yml</span><br><span class=\"line\">01_disable_swap.yml</span><br><span class=\"line\">02_containerd_setup.yml</span><br><span class=\"line\">03_kernel_modules_sysctl.yml</span><br><span class=\"line\">04_kube_repo_install_hold.yml</span><br><span class=\"line\">05_initial_upgrade.yml</span><br><span class=\"line\">06_configure_weekly_updates.yml</span><br><span class=\"line\">main.yml</span><br><span class=\"line\"></span><br><span class=\"line\">./roles/k8s-master:</span><br><span class=\"line\">tasks</span><br><span class=\"line\"></span><br><span class=\"line\">./roles/k8s-master/tasks:</span><br><span class=\"line\">main.yml</span><br><span class=\"line\"></span><br><span class=\"line\">./roles/k8s-worker:</span><br><span class=\"line\">tasks</span><br><span class=\"line\"></span><br><span class=\"line\">./roles/k8s-worker/tasks:</span><br><span class=\"line\">main.yml</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"2-2-执行过程\"><a href=\"#2-2-执行过程\" class=\"headerlink\" title=\"2.2 执行过程\"></a>2.2 执行过程</h2><p>在执行前，需要让.ssh&#x2F;known_hosts 文件保存这些主机的SSH Key。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#!/bin/bash</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># This script prepares the Ansible control node by adding the SSH host keys</span></span><br><span class=\"line\"><span class=\"comment\"># of the target nodes to the ~/.ssh/known_hosts file.</span></span><br><span class=\"line\"><span class=\"comment\"># It first removes any outdated keys for the specified hosts before scanning</span></span><br><span class=\"line\"><span class=\"comment\"># for the new ones, preventing &quot;REMOTE HOST IDENTIFICATION HAS CHANGED&quot; errors.</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># --- Configuration ---</span></span><br><span class=\"line\"><span class=\"comment\"># List of hosts (IPs or FQDNs) to scan.</span></span><br><span class=\"line\"><span class=\"comment\"># These should be the same hosts you have in your Ansible inventory.</span></span><br><span class=\"line\">HOSTS=(</span><br><span class=\"line\">    <span class=\"string\">&quot;10.75.59.71&quot;</span></span><br><span class=\"line\">    <span class=\"string\">&quot;10.75.59.72&quot;</span></span><br><span class=\"line\">    <span class=\"string\">&quot;10.75.59.73&quot;</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># The location of your known_hosts file.</span></span><br><span class=\"line\">KNOWN_HOSTS_FILE=~/.ssh/known_hosts</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># --- Main Logic ---</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;Starting SSH host key scan to update <span class=\"variable\">$&#123;KNOWN_HOSTS_FILE&#125;</span>...&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Ensure the .ssh directory exists with the correct permissions.</span></span><br><span class=\"line\"><span class=\"built_in\">mkdir</span> -p ~/.ssh</span><br><span class=\"line\"><span class=\"built_in\">chmod</span> 700 ~/.ssh</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Loop through each host defined in the HOSTS array.</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> host <span class=\"keyword\">in</span> <span class=\"string\">&quot;<span class=\"variable\">$&#123;HOSTS[@]&#125;</span>&quot;</span>; <span class=\"keyword\">do</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;--- Processing host: <span class=\"variable\">$&#123;host&#125;</span> ---&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># 1. Remove the old host key (if it exists).</span></span><br><span class=\"line\">    <span class=\"comment\"># This is the key step to ensure we replace outdated entries.</span></span><br><span class=\"line\">    <span class=\"comment\"># The command is silent if no key is found.</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Step 1: Removing any old key for <span class=\"variable\">$&#123;host&#125;</span>...&quot;</span></span><br><span class=\"line\">    ssh-keygen -R <span class=\"string\">&quot;<span class=\"variable\">$&#123;host&#125;</span>&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># 2. Scan for the new host key and append it.</span></span><br><span class=\"line\">    <span class=\"comment\"># The -H flag hashes the hostname, which is a security best practice.</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Step 2: Scanning for new key and adding it to known_hosts...&quot;</span></span><br><span class=\"line\">    ssh-keyscan -H <span class=\"string\">&quot;<span class=\"variable\">$&#123;host&#125;</span>&quot;</span> &gt;&gt; <span class=\"string\">&quot;<span class=\"variable\">$&#123;KNOWN_HOSTS_FILE&#125;</span>&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Successfully updated key for <span class=\"variable\">$&#123;host&#125;</span>.&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">done</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Set the correct permissions for the known_hosts file, as SSH is strict about this.</span></span><br><span class=\"line\"><span class=\"built_in\">chmod</span> 600 <span class=\"string\">&quot;<span class=\"variable\">$&#123;KNOWN_HOSTS_FILE&#125;</span>&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;✅ All hosts have been scanned and keys have been updated.&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;You can now run your Ansible playbook without host key verification prompts.&quot;</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">chmod</span> +x ansible-k8s-v2.sh </span><br><span class=\"line\">ois@ois:~/data/k8s$ ./ansible-k8s-v2.sh </span><br><span class=\"line\">--- Installing Ansible ---</span><br><span class=\"line\">Ansible is already installed.</span><br><span class=\"line\">--- Creating project directory: k8s_cluster_setup ---</span><br><span class=\"line\">Changed to directory: /home/ois/data/k8s/k8s_cluster_setup</span><br><span class=\"line\">--- Creating ansible.cfg ---</span><br><span class=\"line\">ansible.cfg created.</span><br><span class=\"line\">--- Creating inventory.ini ---</span><br><span class=\"line\">inventory.ini created.</span><br><span class=\"line\">--- Creating playbook.yml ---</span><br><span class=\"line\">playbook.yml created (only common setup included).</span><br><span class=\"line\">--- Creating Ansible roles and tasks ---</span><br><span class=\"line\">Ansible roles and tasks created.</span><br><span class=\"line\"></span><br><span class=\"line\">--- Ansible setup <span class=\"keyword\">for</span> Kubernetes installation is complete! ---</span><br><span class=\"line\">Navigate to the project directory:</span><br><span class=\"line\"><span class=\"built_in\">cd</span> k8s_cluster_setup</span><br><span class=\"line\"></span><br><span class=\"line\">Then, run the Ansible playbook to install Kubernetes components on all nodes:</span><br><span class=\"line\">ansible-playbook playbook.yml -K</span><br><span class=\"line\"></span><br><span class=\"line\">After the playbook finishes, you will need to manually initialize the Kubernetes cluster:</span><br><span class=\"line\">1. SSH into the master node (kube-node-1):</span><br><span class=\"line\">   ssh ubuntu@10.75.59.71</span><br><span class=\"line\"></span><br><span class=\"line\">2. Initialize the Kubernetes control plane on the master node:</span><br><span class=\"line\">   <span class=\"built_in\">sudo</span> kubeadm init --control-plane-endpoint=kube-node-1 --pod-network-cidr=172.16.0.0/20 --service-cidr=172.16.32.0/20 --skip-phases=addon/kube-proxy --pod-infra-container-image=registry.k8s.io/pause:3.10</span><br><span class=\"line\"></span><br><span class=\"line\">3. After <span class=\"string\">&#x27;kubeadm init&#x27;</span> completes, it will <span class=\"built_in\">print</span> instructions to <span class=\"built_in\">set</span> up kubectl and the <span class=\"string\">&#x27;kubeadm join&#x27;</span> <span class=\"built_in\">command</span>.</span><br><span class=\"line\">   Follow the instructions to <span class=\"built_in\">set</span> up kubectl <span class=\"keyword\">for</span> the <span class=\"string\">&#x27;ubuntu&#x27;</span> user:</span><br><span class=\"line\">   <span class=\"built_in\">mkdir</span> -p <span class=\"variable\">$HOME</span>/.kube</span><br><span class=\"line\">   <span class=\"built_in\">sudo</span> <span class=\"built_in\">cp</span> -i /etc/kubernetes/admin.conf <span class=\"variable\">$HOME</span>/.kube/config</span><br><span class=\"line\">   <span class=\"built_in\">sudo</span> <span class=\"built_in\">chown</span> $(<span class=\"built_in\">id</span> -u):$(<span class=\"built_in\">id</span> -g) <span class=\"variable\">$HOME</span>/.kube/config</span><br><span class=\"line\"></span><br><span class=\"line\">4. Copy the <span class=\"string\">&#x27;kubeadm join&#x27;</span> <span class=\"built_in\">command</span> (including the token and discovery-token-ca-cert-hash) printed by <span class=\"string\">&#x27;kubeadm init&#x27;</span>.</span><br><span class=\"line\">   It will look something like: <span class=\"string\">&#x27;kubeadm join &lt;master-ip&gt;:6443 --token &lt;token&gt; --discovery-token-ca-cert-hash sha256:&lt;hash&gt;&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">5. SSH into each worker node (kube-node-2, kube-node-3) and run the <span class=\"built_in\">join</span> <span class=\"built_in\">command</span>:</span><br><span class=\"line\">   ssh ubuntu@10.75.59.72 (<span class=\"keyword\">for</span> kube-node-2)</span><br><span class=\"line\">   <span class=\"built_in\">sudo</span> &lt;PASTE_YOUR_KUBEADM_JOIN_COMMAND_HERE&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">   ssh ubuntu@10.75.59.73 (<span class=\"keyword\">for</span> kube-node-3)</span><br><span class=\"line\">   <span class=\"built_in\">sudo</span> &lt;PASTE_YOUR_KUBEADM_JOIN_COMMAND_HERE&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">6. Verify your cluster status from the master node:</span><br><span class=\"line\">   ssh ubuntu@10.75.59.71</span><br><span class=\"line\">   kubectl get nodes</span><br><span class=\"line\">   kubectl get pods --all-namespaces</span><br><span class=\"line\">ois@ois:~/data/k8s$ <span class=\"built_in\">cd</span> k8s_cluster_setup/</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ois@ois:~/data/k8s/k8s_cluster_setup$ ansible-playbook playbook.yml -K</span><br><span class=\"line\">BECOME password: </span><br><span class=\"line\"></span><br><span class=\"line\">PLAY [Common Kubernetes Setup <span class=\"keyword\">for</span> all nodes] *******************************************************************************************************************************************************************************************************************</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Gathering Facts] *****************************************************************************************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [kube-node-1]</span><br><span class=\"line\">ok: [kube-node-2]</span><br><span class=\"line\">ok: [kube-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common_k8s_setup : Include add hosts entries task] *******************************************************************************************************************************************************************************************************</span><br><span class=\"line\">included: /home/ois/data/k8s/k8s_cluster_setup/roles/common_k8s_setup/tasks/00_add_hosts_entries.yml <span class=\"keyword\">for</span> kube-node-1, kube-node-2, kube-node-3</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common_k8s_setup : Add all inventory hosts to /etc/hosts on each node] ***********************************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [kube-node-2] =&gt; (item=kube-node-1)</span><br><span class=\"line\">changed: [kube-node-1] =&gt; (item=kube-node-1)</span><br><span class=\"line\">changed: [kube-node-3] =&gt; (item=kube-node-1)</span><br><span class=\"line\">changed: [kube-node-1] =&gt; (item=kube-node-2)</span><br><span class=\"line\">changed: [kube-node-2] =&gt; (item=kube-node-2)</span><br><span class=\"line\">changed: [kube-node-3] =&gt; (item=kube-node-2)</span><br><span class=\"line\">changed: [kube-node-2] =&gt; (item=kube-node-3)</span><br><span class=\"line\">changed: [kube-node-1] =&gt; (item=kube-node-3)</span><br><span class=\"line\">changed: [kube-node-3] =&gt; (item=kube-node-3)</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common_k8s_setup : Include <span class=\"built_in\">disable</span> swap task] ************************************************************************************************************************************************************************************************************</span><br><span class=\"line\">included: /home/ois/data/k8s/k8s_cluster_setup/roles/common_k8s_setup/tasks/01_disable_swap.yml <span class=\"keyword\">for</span> kube-node-1, kube-node-2, kube-node-3</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common_k8s_setup : Check <span class=\"keyword\">if</span> swap is active] **************************************************************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [kube-node-2]</span><br><span class=\"line\">ok: [kube-node-1]</span><br><span class=\"line\">ok: [kube-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common_k8s_setup : Disable swap] *************************************************************************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [kube-node-1]</span><br><span class=\"line\">changed: [kube-node-2]</span><br><span class=\"line\">changed: [kube-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common_k8s_setup : Persistently <span class=\"built_in\">disable</span> swap (comment out swapfile <span class=\"keyword\">in</span> fstab)] ****************************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [kube-node-2]</span><br><span class=\"line\">ok: [kube-node-3]</span><br><span class=\"line\">ok: [kube-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common_k8s_setup : Include containerd setup task] ********************************************************************************************************************************************************************************************************</span><br><span class=\"line\">included: /home/ois/data/k8s/k8s_cluster_setup/roles/common_k8s_setup/tasks/02_containerd_setup.yml <span class=\"keyword\">for</span> kube-node-1, kube-node-2, kube-node-3</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common_k8s_setup : Install required packages <span class=\"keyword\">for</span> Containerd] *********************************************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [kube-node-2]</span><br><span class=\"line\">changed: [kube-node-1]</span><br><span class=\"line\">changed: [kube-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common_k8s_setup : Add Docker GPG key] *******************************************************************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [kube-node-1]</span><br><span class=\"line\">changed: [kube-node-2]</span><br><span class=\"line\">changed: [kube-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common_k8s_setup : Add Docker APT repository] ************************************************************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [kube-node-2]</span><br><span class=\"line\">changed: [kube-node-1]</span><br><span class=\"line\">changed: [kube-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common_k8s_setup : Install Containerd] *******************************************************************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [kube-node-3]</span><br><span class=\"line\">changed: [kube-node-1]</span><br><span class=\"line\">changed: [kube-node-2]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common_k8s_setup : Create containerd configuration directory] ********************************************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [kube-node-2]</span><br><span class=\"line\">ok: [kube-node-3]</span><br><span class=\"line\">ok: [kube-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common_k8s_setup : Generate default containerd configuration directly to final path] *********************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [kube-node-1]</span><br><span class=\"line\">changed: [kube-node-3]</span><br><span class=\"line\">changed: [kube-node-2]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common_k8s_setup : Ensure CRI plugin is enabled (remove any disabled_plugins line containing <span class=\"string\">&quot;cri&quot;</span>)] *****************************************************************************************************************************************************</span><br><span class=\"line\">ok: [kube-node-1]</span><br><span class=\"line\">ok: [kube-node-2]</span><br><span class=\"line\">ok: [kube-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common_k8s_setup : Remove top-level systemd_cgroup from CRI plugin section] ******************************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [kube-node-1]</span><br><span class=\"line\">changed: [kube-node-2]</span><br><span class=\"line\">changed: [kube-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common_k8s_setup : Remove old runtime_root from runc runtime section] ************************************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [kube-node-1]</span><br><span class=\"line\">changed: [kube-node-3]</span><br><span class=\"line\">changed: [kube-node-2]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common_k8s_setup : Configure runc runtime to use SystemdCgroup = <span class=\"literal\">true</span>] ***********************************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [kube-node-1]</span><br><span class=\"line\">changed: [kube-node-2]</span><br><span class=\"line\">changed: [kube-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common_k8s_setup : Add Root path to runc options] ********************************************************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [kube-node-1]</span><br><span class=\"line\">changed: [kube-node-3]</span><br><span class=\"line\">changed: [kube-node-2]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common_k8s_setup : Update sandbox_image to pause:3.10] ***************************************************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [kube-node-1]</span><br><span class=\"line\">changed: [kube-node-2]</span><br><span class=\"line\">changed: [kube-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common_k8s_setup : Include kernel modules and sysctl task] ***********************************************************************************************************************************************************************************************</span><br><span class=\"line\">included: /home/ois/data/k8s/k8s_cluster_setup/roles/common_k8s_setup/tasks/03_kernel_modules_sysctl.yml <span class=\"keyword\">for</span> kube-node-1, kube-node-2, kube-node-3</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common_k8s_setup : Load overlay module] ******************************************************************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [kube-node-1]</span><br><span class=\"line\">ok: [kube-node-2]</span><br><span class=\"line\">ok: [kube-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common_k8s_setup : Load br_netfilter module] *************************************************************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [kube-node-1]</span><br><span class=\"line\">ok: [kube-node-2]</span><br><span class=\"line\">ok: [kube-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common_k8s_setup : Add modules to /etc/modules-load.d/k8s.conf] ******************************************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [kube-node-1]</span><br><span class=\"line\">changed: [kube-node-2]</span><br><span class=\"line\">changed: [kube-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common_k8s_setup : Configure sysctl parameters <span class=\"keyword\">for</span> Kubernetes networking] ********************************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [kube-node-1]</span><br><span class=\"line\">changed: [kube-node-2]</span><br><span class=\"line\">changed: [kube-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common_k8s_setup : Apply sysctl parameters] **************************************************************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [kube-node-1]</span><br><span class=\"line\">ok: [kube-node-2]</span><br><span class=\"line\">ok: [kube-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common_k8s_setup : Include kube repo, install, and hold task] ********************************************************************************************************************************************************************************************</span><br><span class=\"line\">included: /home/ois/data/k8s/k8s_cluster_setup/roles/common_k8s_setup/tasks/04_kube_repo_install_hold.yml <span class=\"keyword\">for</span> kube-node-1, kube-node-2, kube-node-3</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common_k8s_setup : Create Kubernetes apt keyring directory] **********************************************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [kube-node-1]</span><br><span class=\"line\">ok: [kube-node-2]</span><br><span class=\"line\">ok: [kube-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common_k8s_setup : Download Kubernetes GPG key and dearmor] **********************************************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [kube-node-2]</span><br><span class=\"line\">ok: [kube-node-1]</span><br><span class=\"line\">ok: [kube-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common_k8s_setup : Add Kubernetes APT repository <span class=\"built_in\">source</span> list] ********************************************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [kube-node-2]</span><br><span class=\"line\">changed: [kube-node-3]</span><br><span class=\"line\">changed: [kube-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common_k8s_setup : Update apt cache after adding Kubernetes repo] ****************************************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [kube-node-2]</span><br><span class=\"line\">changed: [kube-node-1]</span><br><span class=\"line\">changed: [kube-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common_k8s_setup : Install kubelet, kubeadm, kubectl] ****************************************************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [kube-node-3]</span><br><span class=\"line\">changed: [kube-node-2]</span><br><span class=\"line\">changed: [kube-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common_k8s_setup : Hold kubelet, kubeadm, kubectl packages] **********************************************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [kube-node-1] =&gt; (item=kubelet)</span><br><span class=\"line\">changed: [kube-node-3] =&gt; (item=kubelet)</span><br><span class=\"line\">changed: [kube-node-2] =&gt; (item=kubelet)</span><br><span class=\"line\">changed: [kube-node-3] =&gt; (item=kubeadm)</span><br><span class=\"line\">changed: [kube-node-1] =&gt; (item=kubeadm)</span><br><span class=\"line\">changed: [kube-node-2] =&gt; (item=kubeadm)</span><br><span class=\"line\">changed: [kube-node-3] =&gt; (item=kubectl)</span><br><span class=\"line\">changed: [kube-node-1] =&gt; (item=kubectl)</span><br><span class=\"line\">changed: [kube-node-2] =&gt; (item=kubectl)</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common_k8s_setup : Enable and start kubelet service] *****************************************************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [kube-node-3]</span><br><span class=\"line\">changed: [kube-node-2]</span><br><span class=\"line\">changed: [kube-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common_k8s_setup : Include initial apt upgrade task] *****************************************************************************************************************************************************************************************************</span><br><span class=\"line\">included: /home/ois/data/k8s/k8s_cluster_setup/roles/common_k8s_setup/tasks/05_initial_upgrade.yml <span class=\"keyword\">for</span> kube-node-1, kube-node-2, kube-node-3</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common_k8s_setup : Perform initial apt update and upgrade] ***********************************************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [kube-node-3]</span><br><span class=\"line\">changed: [kube-node-2]</span><br><span class=\"line\">changed: [kube-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common_k8s_setup : Include configure weekly updates task] ************************************************************************************************************************************************************************************************</span><br><span class=\"line\">included: /home/ois/data/k8s/k8s_cluster_setup/roles/common_k8s_setup/tasks/06_configure_weekly_updates.yml <span class=\"keyword\">for</span> kube-node-1, kube-node-2, kube-node-3</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common_k8s_setup : Configure weekly apt update and upgrade cron job] *************************************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [kube-node-1]</span><br><span class=\"line\">changed: [kube-node-2]</span><br><span class=\"line\">changed: [kube-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">RUNNING HANDLER [common_k8s_setup : Restart containerd service] ************************************************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [kube-node-2]</span><br><span class=\"line\">changed: [kube-node-1]</span><br><span class=\"line\">changed: [kube-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY RECAP *****************************************************************************************************************************************************************************************************************************************************</span><br><span class=\"line\">kube-node-1                : ok=39   changed=22   unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class=\"line\">kube-node-2                : ok=39   changed=22   unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class=\"line\">kube-node-3                : ok=39   changed=22   unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br></pre></td></tr></table></figure>\n\n<h1 id=\"3-设置本地DNS和BGP\"><a href=\"#3-设置本地DNS和BGP\" class=\"headerlink\" title=\"3. 设置本地DNS和BGP\"></a>3. 设置本地DNS和BGP</h1><p>设置一个本地DNS和BGP服务器用于测试。</p>\n<h2 id=\"3-1-create-dns-sh\"><a href=\"#3-1-create-dns-sh\" class=\"headerlink\" title=\"3.1 create-dns.sh\"></a>3.1 create-dns.sh</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#!/bin/bash</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># --- Configuration ---</span></span><br><span class=\"line\">BASE_IMAGE_PATH=<span class=\"string\">&quot;/home/ois/data/vmimages/noble-server-cloudimg-amd64.img&quot;</span></span><br><span class=\"line\">VM_IMAGE_DIR=<span class=\"string\">&quot;/home/ois/data/k8s/nodevms&quot;</span></span><br><span class=\"line\">VM_CONFIG_DIR=<span class=\"string\">&quot;/home/ois/data/k8s/nodevm_cfg&quot;</span></span><br><span class=\"line\">RAM_MB=8192</span><br><span class=\"line\">VCPUS=4</span><br><span class=\"line\">DISK_SIZE_GB=20</span><br><span class=\"line\">BRIDGE_INTERFACE=<span class=\"string\">&quot;br0&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># Specific IP for the single VM</span></span><br><span class=\"line\">VM_IP=<span class=\"string\">&quot;10.75.59.76&quot;</span></span><br><span class=\"line\">NETWORK_PREFIX=<span class=\"string\">&quot;/24&quot;</span></span><br><span class=\"line\">GATEWAY=<span class=\"string\">&quot;10.75.59.1&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># DNS servers for the VM&#x27;s initial resolution (for internet access)</span></span><br><span class=\"line\">VM_NAMESERVER1=<span class=\"string\">&quot;64.104.76.247&quot;</span></span><br><span class=\"line\">VM_NAMESERVER2=<span class=\"string\">&quot;64.104.14.184&quot;</span></span><br><span class=\"line\">SEARCH_DOMAIN=<span class=\"string\">&quot;cisco.com&quot;</span></span><br><span class=\"line\">VNC_PORT=5909 <span class=\"comment\"># Fixed VNC port for the single VM</span></span><br><span class=\"line\">PASSWORD_HASH=<span class=\"string\">&#x27;$6$rounds=4096$LDu9pXXXXXXXXXXXXXXOh/Iunw372/TVfst1&#x27;</span></span><br><span class=\"line\">SSH_PUB_KEY=$(<span class=\"built_in\">cat</span> ~/.ssh/id_rsa.pub)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># --- VM Details ---</span></span><br><span class=\"line\">VM_NAME=<span class=\"string\">&quot;dns-server-vm&quot;</span></span><br><span class=\"line\">VM_IMAGE_PATH=<span class=\"string\">&quot;<span class=\"variable\">$&#123;VM_IMAGE_DIR&#125;</span>/<span class=\"variable\">$&#123;VM_NAME&#125;</span>.qcow2&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;--- Preparing for <span class=\"variable\">$VM_NAME</span> (IP: <span class=\"variable\">$VM_IP</span>) ---&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Create directories if they don&#x27;t exist</span></span><br><span class=\"line\"><span class=\"built_in\">mkdir</span> -p <span class=\"string\">&quot;<span class=\"variable\">$VM_IMAGE_DIR</span>&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">mkdir</span> -p <span class=\"string\">&quot;<span class=\"variable\">$VM_CONFIG_DIR</span>&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Create a fresh image for the VM</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> [ -f <span class=\"string\">&quot;<span class=\"variable\">$VM_IMAGE_PATH</span>&quot;</span> ]; <span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Removing existing image for <span class=\"variable\">$VM_NAME</span>...&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">rm</span> <span class=\"string\">&quot;<span class=\"variable\">$VM_IMAGE_PATH</span>&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;Copying base image to <span class=\"variable\">$VM_IMAGE_PATH</span>...&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">cp</span> <span class=\"string\">&quot;<span class=\"variable\">$BASE_IMAGE_PATH</span>&quot;</span> <span class=\"string\">&quot;<span class=\"variable\">$VM_IMAGE_PATH</span>&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Resize the copied image before virt-install</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;Resizing VM image to <span class=\"variable\">$&#123;DISK_SIZE_GB&#125;</span>GB...&quot;</span></span><br><span class=\"line\">qemu-img resize <span class=\"string\">&quot;<span class=\"variable\">$VM_IMAGE_PATH</span>&quot;</span> <span class=\"string\">&quot;<span class=\"variable\">$&#123;DISK_SIZE_GB&#125;</span>G&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Generate user-data for the VM (installing dnsmasq, no UFW, no dnsmasq config here)</span></span><br><span class=\"line\">USER_DATA_FILE=<span class=\"string\">&quot;<span class=\"variable\">$&#123;VM_CONFIG_DIR&#125;</span>/<span class=\"variable\">$&#123;VM_NAME&#125;</span>_user-data&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOF &gt; &quot;$USER_DATA_FILE&quot;</span></span><br><span class=\"line\"><span class=\"string\">#cloud-config</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">locale: en_US</span></span><br><span class=\"line\"><span class=\"string\">keyboard:</span></span><br><span class=\"line\"><span class=\"string\">  layout: us</span></span><br><span class=\"line\"><span class=\"string\">timezone: Asia/Tokyo</span></span><br><span class=\"line\"><span class=\"string\">hostname: $&#123;VM_NAME&#125;</span></span><br><span class=\"line\"><span class=\"string\">create_hostname_file: true</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">ssh_pwauth: yes</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">groups:</span></span><br><span class=\"line\"><span class=\"string\">  - ubuntu</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">users:</span></span><br><span class=\"line\"><span class=\"string\">  - name: ubuntu</span></span><br><span class=\"line\"><span class=\"string\">    gecos: ubuntu</span></span><br><span class=\"line\"><span class=\"string\">    primary_group: ubuntu</span></span><br><span class=\"line\"><span class=\"string\">    groups: sudo, cdrom</span></span><br><span class=\"line\"><span class=\"string\">    sudo: ALL=(ALL:ALL) ALL</span></span><br><span class=\"line\"><span class=\"string\">    shell: /bin/bash</span></span><br><span class=\"line\"><span class=\"string\">    lock_passwd: false</span></span><br><span class=\"line\"><span class=\"string\">    passwd: $&#123;PASSWORD_HASH&#125;</span></span><br><span class=\"line\"><span class=\"string\">    ssh_authorized_keys:</span></span><br><span class=\"line\"><span class=\"string\">      - &quot;$&#123;SSH_PUB_KEY&#125;&quot;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">apt:</span></span><br><span class=\"line\"><span class=\"string\">  primary:</span></span><br><span class=\"line\"><span class=\"string\">    - arches: [default]</span></span><br><span class=\"line\"><span class=\"string\">      uri: http://us.archive.ubuntu.com/ubuntu/</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">packages:</span></span><br><span class=\"line\"><span class=\"string\">  - openssh-server</span></span><br><span class=\"line\"><span class=\"string\">  - net-tools</span></span><br><span class=\"line\"><span class=\"string\">  - iftop</span></span><br><span class=\"line\"><span class=\"string\">  - htop</span></span><br><span class=\"line\"><span class=\"string\">  - iperf3</span></span><br><span class=\"line\"><span class=\"string\">  - vim</span></span><br><span class=\"line\"><span class=\"string\">  - curl</span></span><br><span class=\"line\"><span class=\"string\">  - wget</span></span><br><span class=\"line\"><span class=\"string\">  - cloud-guest-utils # Ensure growpart is available</span></span><br><span class=\"line\"><span class=\"string\">  - dnsmasq # Install dnsmasq for DNS server functionality</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">ntp:</span></span><br><span class=\"line\"><span class=\"string\">  servers: [&#x27;ntp.esl.cisco.com&#x27;]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">runcmd:</span></span><br><span class=\"line\"><span class=\"string\">  - echo &quot;Attempting to resize root partition and filesystem...&quot;</span></span><br><span class=\"line\"><span class=\"string\">  - growpart /dev/vda 1 # Expand the first partition on /dev/vda</span></span><br><span class=\"line\"><span class=\"string\">  - resize2fs /dev/vda1 # Expand the ext4 filesystem on /dev/vda1</span></span><br><span class=\"line\"><span class=\"string\">  - echo &quot;Disk resize commands executed. Verify with &#x27;df -h&#x27; after boot.&quot;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Generate network-config for the VM (pointing to external DNS for initial connectivity)</span></span><br><span class=\"line\">NETWORK_CONFIG_FILE=<span class=\"string\">&quot;<span class=\"variable\">$&#123;VM_CONFIG_DIR&#125;</span>/<span class=\"variable\">$&#123;VM_NAME&#125;</span>_network-config&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOF &gt; &quot;$NETWORK_CONFIG_FILE&quot;</span></span><br><span class=\"line\"><span class=\"string\">network:</span></span><br><span class=\"line\"><span class=\"string\">  version: 2</span></span><br><span class=\"line\"><span class=\"string\">  ethernets:</span></span><br><span class=\"line\"><span class=\"string\">    enp1s0:</span></span><br><span class=\"line\"><span class=\"string\">      addresses:</span></span><br><span class=\"line\"><span class=\"string\">      - &quot;$&#123;VM_IP&#125;$&#123;NETWORK_PREFIX&#125;&quot;</span></span><br><span class=\"line\"><span class=\"string\">      nameservers:</span></span><br><span class=\"line\"><span class=\"string\">        addresses:</span></span><br><span class=\"line\"><span class=\"string\">        - $&#123;VM_NAMESERVER1&#125; # Point VM to external DNS for initial internet access</span></span><br><span class=\"line\"><span class=\"string\">        - $&#123;VM_NAMESERVER2&#125;</span></span><br><span class=\"line\"><span class=\"string\">        search:</span></span><br><span class=\"line\"><span class=\"string\">        - $&#123;SEARCH_DOMAIN&#125;</span></span><br><span class=\"line\"><span class=\"string\">      routes:</span></span><br><span class=\"line\"><span class=\"string\">      - to: &quot;default&quot;</span></span><br><span class=\"line\"><span class=\"string\">        via: &quot;$&#123;GATEWAY&#125;&quot;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Generate meta-data</span></span><br><span class=\"line\">META_DATA_FILE=<span class=\"string\">&quot;<span class=\"variable\">$&#123;VM_CONFIG_DIR&#125;</span>/<span class=\"variable\">$&#123;VM_NAME&#125;</span>_meta-data&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOF &gt; &quot;$META_DATA_FILE&quot;</span></span><br><span class=\"line\"><span class=\"string\">instance-id: $&#123;VM_NAME&#125;</span></span><br><span class=\"line\"><span class=\"string\">local-hostname: $&#123;VM_NAME&#125;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;--- Installing <span class=\"variable\">$VM_NAME</span> ---&quot;</span></span><br><span class=\"line\">virt-install --name <span class=\"string\">&quot;<span class=\"variable\">$&#123;VM_NAME&#125;</span>&quot;</span> --ram <span class=\"string\">&quot;<span class=\"variable\">$&#123;RAM_MB&#125;</span>&quot;</span> --vcpus <span class=\"string\">&quot;<span class=\"variable\">$&#123;VCPUS&#125;</span>&quot;</span> --noreboot \\</span><br><span class=\"line\">    --os-variant ubuntu24.04 \\</span><br><span class=\"line\">    --network bridge=<span class=\"string\">&quot;<span class=\"variable\">$&#123;BRIDGE_INTERFACE&#125;</span>&quot;</span> \\</span><br><span class=\"line\">    --graphics vnc,listen=0.0.0.0,port=<span class=\"string\">&quot;<span class=\"variable\">$&#123;VNC_PORT&#125;</span>&quot;</span> \\</span><br><span class=\"line\">    --disk path=<span class=\"string\">&quot;<span class=\"variable\">$&#123;VM_IMAGE_PATH&#125;</span>&quot;</span>,format=qcow2 \\</span><br><span class=\"line\">    --console pty,target_type=serial \\</span><br><span class=\"line\">    --cloud-init user-data=<span class=\"string\">&quot;<span class=\"variable\">$&#123;USER_DATA_FILE&#125;</span>&quot;</span>,meta-data=<span class=\"string\">&quot;<span class=\"variable\">$&#123;META_DATA_FILE&#125;</span>&quot;</span>,network-config=<span class=\"string\">&quot;<span class=\"variable\">$&#123;NETWORK_CONFIG_FILE&#125;</span>&quot;</span> \\</span><br><span class=\"line\">    --import \\</span><br><span class=\"line\">    --<span class=\"built_in\">wait</span> 0</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;Successfully initiated creation of <span class=\"variable\">$VM_NAME</span>.&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;You can connect to VNC on port <span class=\"variable\">$&#123;VNC_PORT&#125;</span> to monitor installation (optional).&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;Wait a few minutes for the VM to boot and cloud-init to run.&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;--------------------------------------------------------&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;The DNS server VM has been initiated. Please wait for it to fully provision.&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;You can SSH into it using &#x27;ssh ubuntu@<span class=\"variable\">$&#123;VM_IP&#125;</span>&#x27;.&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;Once provisioned, proceed to use the &#x27;setup-dnsmasq-ansible.sh&#x27; script to configure DNS using Ansible.&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">ois@ois:~/data/k8s$ ./create-dns.sh </span><br><span class=\"line\">--- Preparing <span class=\"keyword\">for</span> dns-server-vm (IP: 10.75.59.76) ---</span><br><span class=\"line\">Copying base image to /home/ois/data/k8s/nodevms/dns-server-vm.qcow2...</span><br><span class=\"line\">Resizing VM image to 20GB...</span><br><span class=\"line\">Image resized.</span><br><span class=\"line\">--- Installing dns-server-vm ---</span><br><span class=\"line\">WARNING  Treating --<span class=\"built_in\">wait</span> 0 as --noautoconsole</span><br><span class=\"line\"></span><br><span class=\"line\">Starting install...</span><br><span class=\"line\">Allocating <span class=\"string\">&#x27;virtinst-y1pxxrj5-cloudinit.iso&#x27;</span>                                                                                                                                                                                             |    0 B  00:00:00 ... </span><br><span class=\"line\">Transferring <span class=\"string\">&#x27;virtinst-y1pxxrj5-cloudinit.iso&#x27;</span>                                                                                                                                                                                           |    0 B  00:00:00 ... </span><br><span class=\"line\">Creating domain...                                                                                                                                                                                                                       |    0 B  00:00:00     </span><br><span class=\"line\">Domain creation completed.</span><br><span class=\"line\">Successfully initiated creation of dns-server-vm.</span><br><span class=\"line\">You can connect to VNC on port 5909 to monitor installation (optional).</span><br><span class=\"line\">Wait a few minutes <span class=\"keyword\">for</span> the VM to boot and cloud-init to run.</span><br><span class=\"line\">--------------------------------------------------------</span><br><span class=\"line\">The DNS server VM has been initiated. Please <span class=\"built_in\">wait</span> <span class=\"keyword\">for</span> it to fully provision.</span><br><span class=\"line\">You can SSH into it using <span class=\"string\">&#x27;ssh ubuntu@10.75.59.76&#x27;</span>.</span><br><span class=\"line\">Once provisioned, you can <span class=\"built_in\">test</span> the DNS forwarding by configuring another machine to use 10.75.59.76 as its DNS server and performing a DNS query.</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"3-2-使用Ansible设置dnsmasq\"><a href=\"#3-2-使用Ansible设置dnsmasq\" class=\"headerlink\" title=\"3.2 使用Ansible设置dnsmasq\"></a>3.2 使用Ansible设置dnsmasq</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#!/bin/bash</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># --- Configuration for Ansible and DNSmasq ---</span></span><br><span class=\"line\">VM_IP=<span class=\"string\">&quot;10.75.59.76&quot;</span></span><br><span class=\"line\">SSH_USER=<span class=\"string\">&quot;ubuntu&quot;</span></span><br><span class=\"line\">SSH_PRIVATE_KEY_PATH=<span class=\"string\">&quot;~/.ssh/id_rsa&quot;</span> <span class=\"comment\"># Ensure this path is correct for your setup</span></span><br><span class=\"line\">FORWARD_NAMESERVER1=<span class=\"string\">&quot;64.104.76.247&quot;</span></span><br><span class=\"line\">FORWARD_NAMESERVER2=<span class=\"string\">&quot;64.104.14.184&quot;</span></span><br><span class=\"line\">SEARCH_DOMAIN=<span class=\"string\">&quot;cisco.com&quot;</span></span><br><span class=\"line\">ANSIBLE_DIR=<span class=\"string\">&quot;ansible_dnsmasq_setup&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;--- Setting up Ansible environment and configuring DNSmasq on <span class=\"variable\">$&#123;VM_IP&#125;</span> ---&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Create a directory for Ansible files</span></span><br><span class=\"line\"><span class=\"built_in\">mkdir</span> -p <span class=\"string\">&quot;<span class=\"variable\">$ANSIBLE_DIR</span>&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">cd</span> <span class=\"string\">&quot;<span class=\"variable\">$ANSIBLE_DIR</span>&quot;</span> || <span class=\"built_in\">exit</span> 1</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># --- Install Ansible if not already installed ---</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> ! <span class=\"built_in\">command</span> -v ansible &amp;&gt; /dev/null</span><br><span class=\"line\"><span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Ansible not found. Installing Ansible...&quot;</span></span><br><span class=\"line\">    <span class=\"comment\"># Check OS and install accordingly</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> [ -f /etc/os-release ]; <span class=\"keyword\">then</span></span><br><span class=\"line\">        . /etc/os-release</span><br><span class=\"line\">        <span class=\"keyword\">if</span> [[ <span class=\"string\">&quot;<span class=\"variable\">$ID</span>&quot;</span> == <span class=\"string\">&quot;ubuntu&quot;</span> || <span class=\"string\">&quot;<span class=\"variable\">$ID</span>&quot;</span> == <span class=\"string\">&quot;debian&quot;</span> ]]; <span class=\"keyword\">then</span></span><br><span class=\"line\">            <span class=\"built_in\">sudo</span> apt update</span><br><span class=\"line\">            <span class=\"built_in\">sudo</span> apt install -y software-properties-common</span><br><span class=\"line\">            <span class=\"built_in\">sudo</span> apt-add-repository --<span class=\"built_in\">yes</span> --update ppa:ansible/ansible</span><br><span class=\"line\">            <span class=\"built_in\">sudo</span> apt install -y ansible</span><br><span class=\"line\">        <span class=\"keyword\">elif</span> [[ <span class=\"string\">&quot;<span class=\"variable\">$ID</span>&quot;</span> == <span class=\"string\">&quot;centos&quot;</span> || <span class=\"string\">&quot;<span class=\"variable\">$ID</span>&quot;</span> == <span class=\"string\">&quot;rhel&quot;</span> || <span class=\"string\">&quot;<span class=\"variable\">$ID</span>&quot;</span> == <span class=\"string\">&quot;fedora&quot;</span> ]]; <span class=\"keyword\">then</span></span><br><span class=\"line\">            <span class=\"built_in\">sudo</span> yum install -y epel-release</span><br><span class=\"line\">            <span class=\"built_in\">sudo</span> yum install -y ansible</span><br><span class=\"line\">        <span class=\"keyword\">else</span></span><br><span class=\"line\">            <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Unsupported OS for automatic Ansible installation. Please install Ansible manually.&quot;</span></span><br><span class=\"line\">            <span class=\"built_in\">exit</span> 1</span><br><span class=\"line\">        <span class=\"keyword\">fi</span></span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">        <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Could not determine OS for automatic Ansible installation. Please install Ansible manually.&quot;</span></span><br><span class=\"line\">        <span class=\"built_in\">exit</span> 1</span><br><span class=\"line\">    <span class=\"keyword\">fi</span></span><br><span class=\"line\"><span class=\"keyword\">else</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Ansible is already installed.&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># --- Create Ansible Inventory File ---</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;Creating Ansible inventory file: inventory.ini&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOF &gt; inventory.ini</span></span><br><span class=\"line\"><span class=\"string\">[dns_server]</span></span><br><span class=\"line\"><span class=\"string\">$&#123;VM_IP&#125; ansible_user=$&#123;SSH_USER&#125; ansible_ssh_private_key_file=$&#123;SSH_PRIVATE_KEY_PATH&#125; ansible_python_interpreter=/usr/bin/python3</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># --- Create Ansible Playbook (setup-dnsmasq.yml) ---</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;Creating Ansible playbook: setup-dnsmasq.yml&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOF &gt; setup-dnsmasq.yml</span></span><br><span class=\"line\"><span class=\"string\">---</span></span><br><span class=\"line\"><span class=\"string\">- name: Configure DNSmasq Server on Ubuntu VM</span></span><br><span class=\"line\"><span class=\"string\">  hosts: dns_server</span></span><br><span class=\"line\"><span class=\"string\">  become: yes # Run tasks with sudo privileges</span></span><br><span class=\"line\"><span class=\"string\">  vars:</span></span><br><span class=\"line\"><span class=\"string\">    dns_forwarder_1: &quot;$&#123;FORWARD_NAMESERVER1&#125;&quot;</span></span><br><span class=\"line\"><span class=\"string\">    dns_forwarder_2: &quot;$&#123;FORWARD_NAMESERVER2&#125;&quot;</span></span><br><span class=\"line\"><span class=\"string\">    vm_ip: &quot;$&#123;VM_IP&#125;&quot;</span></span><br><span class=\"line\"><span class=\"string\">    search_domain: &quot;$&#123;SEARCH_DOMAIN&#125;&quot;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">  tasks:</span></span><br><span class=\"line\"><span class=\"string\">    - name: Ensure apt cache is updated</span></span><br><span class=\"line\"><span class=\"string\">      ansible.builtin.apt:</span></span><br><span class=\"line\"><span class=\"string\">        update_cache: yes</span></span><br><span class=\"line\"><span class=\"string\">        cache_valid_time: 3600 # Cache for 1 hour</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">    - name: Install dnsmasq package</span></span><br><span class=\"line\"><span class=\"string\">      ansible.builtin.apt:</span></span><br><span class=\"line\"><span class=\"string\">        name: dnsmasq</span></span><br><span class=\"line\"><span class=\"string\">        state: present</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">    - name: Stop dnsmasq service before configuration</span></span><br><span class=\"line\"><span class=\"string\">      ansible.builtin.systemd:</span></span><br><span class=\"line\"><span class=\"string\">        name: dnsmasq</span></span><br><span class=\"line\"><span class=\"string\">        state: stopped</span></span><br><span class=\"line\"><span class=\"string\">      ignore_errors: yes # Ignore if it&#x27;s not running initially</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">    - name: Backup original dnsmasq.conf</span></span><br><span class=\"line\"><span class=\"string\">      ansible.builtin.command: mv /etc/dnsmasq.conf /etc/dnsmasq.conf.bak</span></span><br><span class=\"line\"><span class=\"string\">      args:</span></span><br><span class=\"line\"><span class=\"string\">        removes: /etc/dnsmasq.conf # Only run if dnsmasq.conf exists</span></span><br><span class=\"line\"><span class=\"string\">      ignore_errors: yes</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">    - name: Configure dnsmasq for forwarding</span></span><br><span class=\"line\"><span class=\"string\">      ansible.builtin.template:</span></span><br><span class=\"line\"><span class=\"string\">        src: dnsmasq.conf.j2</span></span><br><span class=\"line\"><span class=\"string\">        dest: /etc/dnsmasq.conf</span></span><br><span class=\"line\"><span class=\"string\">        owner: root</span></span><br><span class=\"line\"><span class=\"string\">        group: root</span></span><br><span class=\"line\"><span class=\"string\">        mode: &#x27;0644&#x27;</span></span><br><span class=\"line\"><span class=\"string\">      notify: Restart dnsmasq</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">    - name: Set VM&#x27;s /etc/resolv.conf to point to itself (local DNS)</span></span><br><span class=\"line\"><span class=\"string\">      ansible.builtin.template:</span></span><br><span class=\"line\"><span class=\"string\">        src: resolv.conf.j2</span></span><br><span class=\"line\"><span class=\"string\">        dest: /etc/resolv.conf</span></span><br><span class=\"line\"><span class=\"string\">        owner: root</span></span><br><span class=\"line\"><span class=\"string\">        group: root</span></span><br><span class=\"line\"><span class=\"string\">        mode: &#x27;0644&#x27;</span></span><br><span class=\"line\"><span class=\"string\">      vars:</span></span><br><span class=\"line\"><span class=\"string\">        local_dns_ip: &quot;127.0.0.1&quot; # dnsmasq listens on 127.0.0.1</span></span><br><span class=\"line\"><span class=\"string\">        # Removed: search_domain: &quot;&#123;&#123; search_domain &#125;&#125;&quot; - it&#x27;s already available from play vars</span></span><br><span class=\"line\"><span class=\"string\">      notify: Restart systemd-resolved # Or NetworkManager, depending on Ubuntu version</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">  handlers:</span></span><br><span class=\"line\"><span class=\"string\">    - name: Restart dnsmasq</span></span><br><span class=\"line\"><span class=\"string\">      ansible.builtin.systemd:</span></span><br><span class=\"line\"><span class=\"string\">        name: dnsmasq</span></span><br><span class=\"line\"><span class=\"string\">        state: restarted</span></span><br><span class=\"line\"><span class=\"string\">        enabled: yes # Ensure it&#x27;s enabled to start on boot</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">    - name: Restart systemd-resolved</span></span><br><span class=\"line\"><span class=\"string\">      ansible.builtin.systemd:</span></span><br><span class=\"line\"><span class=\"string\">        name: systemd-resolved</span></span><br><span class=\"line\"><span class=\"string\">        state: restarted</span></span><br><span class=\"line\"><span class=\"string\">      ignore_errors: yes # systemd-resolved might not be used on server installs</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># --- Create dnsmasq.conf.j2 template ---</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;Creating dnsmasq.conf.j2 template&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOF &gt; dnsmasq.conf.j2</span></span><br><span class=\"line\"><span class=\"string\"># This file is managed by Ansible. Do not edit manually.</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\"># Do not read /etc/resolv.conf, use the servers below</span></span><br><span class=\"line\"><span class=\"string\">no-resolv</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\"># Specify upstream DNS servers for forwarding</span></span><br><span class=\"line\"><span class=\"string\">server=&#123;&#123; dns_forwarder_1 &#125;&#125;</span></span><br><span class=\"line\"><span class=\"string\">server=&#123;&#123; dns_forwarder_2 &#125;&#125;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\"># Listen on localhost and the VM&#x27;s primary IP</span></span><br><span class=\"line\"><span class=\"string\">listen-address=127.0.0.1,&#123;&#123; vm_ip &#125;&#125;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\"># Allow queries from any interface</span></span><br><span class=\"line\"><span class=\"string\">interface=&#123;&#123; ansible_default_ipv4.interface &#125;&#125; # Listen on the primary network interface</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\"># Bind to the interfaces to prevent dnsmasq from listening on all interfaces</span></span><br><span class=\"line\"><span class=\"string\">bind-interfaces</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\"># Cache DNS results</span></span><br><span class=\"line\"><span class=\"string\">cache-size=150</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># --- Create resolv.conf.j2 template ---</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;Creating resolv.conf.j2 template&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOF &gt; resolv.conf.j2</span></span><br><span class=\"line\"><span class=\"string\"># This file is managed by Ansible. Do not edit manually.</span></span><br><span class=\"line\"><span class=\"string\">nameserver &#123;&#123; local_dns_ip &#125;&#125;</span></span><br><span class=\"line\"><span class=\"string\">search &#123;&#123; search_domain &#125;&#125;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># --- Run the Ansible Playbook ---</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;Running Ansible playbook to configure DNSmasq...&quot;</span></span><br><span class=\"line\">ansible-playbook -i inventory.ini setup-dnsmasq.yml -K</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># --- Final Instructions ---</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;--------------------------------------------------------&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;DNSmasq configuration complete on <span class=\"variable\">$&#123;VM_IP&#125;</span>.&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;You can now test the DNS server from the VM or from another machine.&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;From the VM, run: dig @127.0.0.1 www.cisco.com&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;From another machine on the same network, configure its DNS to <span class=\"variable\">$&#123;VM_IP&#125;</span> and run: dig www.cisco.com&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;Remember to exit the &#x27;<span class=\"variable\">$&#123;ANSIBLE_DIR&#125;</span>&#x27; directory when done (cd ..).&quot;</span></span><br></pre></td></tr></table></figure>\n\n<p>执行效果</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ois@ois:~/data/k8s$ ./ansible-dnsmasq.sh </span><br><span class=\"line\">--- Setting up Ansible environment and configuring DNSmasq on 10.75.59.76 ---</span><br><span class=\"line\">Ansible is already installed.</span><br><span class=\"line\">Creating Ansible inventory file: inventory.ini</span><br><span class=\"line\">Creating Ansible playbook: setup-dnsmasq.yml</span><br><span class=\"line\">Creating dnsmasq.conf.j2 template</span><br><span class=\"line\">Creating resolv.conf.j2 template</span><br><span class=\"line\">Running Ansible playbook to configure DNSmasq...</span><br><span class=\"line\">BECOME password: </span><br><span class=\"line\"></span><br><span class=\"line\">PLAY [Configure DNSmasq Server on Ubuntu VM] *******************************************************************************************************************************************************************************************************************</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Gathering Facts] *****************************************************************************************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [10.75.59.76]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Ensure apt cache is updated] *****************************************************************************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [10.75.59.76]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Install dnsmasq package] *********************************************************************************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [10.75.59.76]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Stop dnsmasq service before configuration] ***************************************************************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [10.75.59.76]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Backup original dnsmasq.conf] ****************************************************************************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [10.75.59.76]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Configure dnsmasq <span class=\"keyword\">for</span> forwarding] ************************************************************************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [10.75.59.76]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Set VM<span class=\"string\">&#x27;s /etc/resolv.conf to point to itself (local DNS)] ************************************************************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">changed: [10.75.59.76]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">RUNNING HANDLER [Restart dnsmasq] ******************************************************************************************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">changed: [10.75.59.76]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">RUNNING HANDLER [Restart systemd-resolved] *********************************************************************************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">changed: [10.75.59.76]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">PLAY RECAP *****************************************************************************************************************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">10.75.59.76                : ok=9    changed=5    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">--------------------------------------------------------</span></span><br><span class=\"line\"><span class=\"string\">DNSmasq configuration complete on 10.75.59.76.</span></span><br><span class=\"line\"><span class=\"string\">You can now test the DNS server from the VM or from another machine.</span></span><br><span class=\"line\"><span class=\"string\">From the VM, run: dig @127.0.0.1 www.cisco.com</span></span><br><span class=\"line\"><span class=\"string\">From another machine on the same network, configure its DNS to 10.75.59.76 and run: dig www.cisco.com</span></span><br><span class=\"line\"><span class=\"string\">Remember to exit the &#x27;</span>ansible_dnsmasq_setup<span class=\"string\">&#x27; directory when done (cd ..).</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@dns-server-vm:~# dig @127.0.0.1 www.cisco.com</span><br><span class=\"line\"></span><br><span class=\"line\">; &lt;&lt;&gt;&gt; DiG 9.18.30-0ubuntu0.24.04.2-Ubuntu &lt;&lt;&gt;&gt; @127.0.0.1 www.cisco.com</span><br><span class=\"line\">; (1 server found)</span><br><span class=\"line\">;; global options: +cmd</span><br><span class=\"line\">;; Got answer:</span><br><span class=\"line\">;; -&gt;&gt;HEADER&lt;&lt;- <span class=\"string\">opcode: QUERY, status: NOERROR, id: 10545</span></span><br><span class=\"line\"><span class=\"string\">;; flags: qr aa rd ra; QUERY: 1, ANSWER: 3, AUTHORITY: 0, ADDITIONAL: 1</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">;; OPT PSEUDOSECTION:</span></span><br><span class=\"line\"><span class=\"string\">; EDNS: version: 0, flags:; udp: 1232</span></span><br><span class=\"line\"><span class=\"string\">; COOKIE: ba16202024b9dc8301000000688b40f90daaa0a500a50d2d (good)</span></span><br><span class=\"line\"><span class=\"string\">;; QUESTION SECTION:</span></span><br><span class=\"line\"><span class=\"string\">;www.cisco.com.                 IN      A</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">;; ANSWER SECTION:</span></span><br><span class=\"line\"><span class=\"string\">www.cisco.com.          3600    IN      CNAME   origin-www.cisco.com.</span></span><br><span class=\"line\"><span class=\"string\">origin-www.cisco.com.   1800    IN      CNAME   origin-www.xgslb-v3.cisco.com.</span></span><br><span class=\"line\"><span class=\"string\">origin-www.xgslb-v3.CISCO.com. 10 IN    A       72.163.4.161</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">;; Query time: 71 msec</span></span><br><span class=\"line\"><span class=\"string\">;; SERVER: 127.0.0.1#53(127.0.0.1) (UDP)</span></span><br><span class=\"line\"><span class=\"string\">;; WHEN: Thu Jul 31 19:10:01 JST 2025</span></span><br><span class=\"line\"><span class=\"string\">;; MSG SIZE  rcvd: 183</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"3-3-使用Ansible更新Node-的DNS配置\"><a href=\"#3-3-使用Ansible更新Node-的DNS配置\" class=\"headerlink\" title=\"3.3 使用Ansible更新Node 的DNS配置\"></a>3.3 使用Ansible更新Node 的DNS配置</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#!/bin/bash</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># --- Configuration ---</span></span><br><span class=\"line\">ANSIBLE_DIR=<span class=\"string\">&quot;ansible_dns_update&quot;</span></span><br><span class=\"line\">INVENTORY_FILE=<span class=\"string\">&quot;<span class=\"variable\">$&#123;ANSIBLE_DIR&#125;</span>/hosts.ini&quot;</span></span><br><span class=\"line\">PLAYBOOK_FILE=<span class=\"string\">&quot;<span class=\"variable\">$&#123;ANSIBLE_DIR&#125;</span>/update_dns.yml&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Kubernetes Node IPs (ensure these match your actual VM IPs)</span></span><br><span class=\"line\">KUBE_NODE_1_IP=<span class=\"string\">&quot;10.75.59.71&quot;</span></span><br><span class=\"line\">KUBE_NODE_2_IP=<span class=\"string\">&quot;10.75.59.72&quot;</span></span><br><span class=\"line\">KUBE_NODE_3_IP=<span class=\"string\">&quot;10.75.59.73&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Common Ansible user and Python interpreter</span></span><br><span class=\"line\">ANSIBLE_USER=<span class=\"string\">&quot;ubuntu&quot;</span></span><br><span class=\"line\">ANSIBLE_PYTHON_INTERPRETER=<span class=\"string\">&quot;/usr/bin/python3&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># --- Functions ---</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Function to check and install Ansible</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">install_ansible</span></span>() &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ! <span class=\"built_in\">command</span> -v ansible &amp;&gt; /dev/null</span><br><span class=\"line\">    <span class=\"keyword\">then</span></span><br><span class=\"line\">        <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Ansible not found. Attempting to install Ansible...&quot;</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> [ -f /etc/debian_version ]; <span class=\"keyword\">then</span></span><br><span class=\"line\">            <span class=\"comment\"># Debian/Ubuntu</span></span><br><span class=\"line\">            <span class=\"built_in\">sudo</span> apt update</span><br><span class=\"line\">            <span class=\"built_in\">sudo</span> apt install -y software-properties-common</span><br><span class=\"line\">            <span class=\"built_in\">sudo</span> add-apt-repository --<span class=\"built_in\">yes</span> --update ppa:ansible/ansible</span><br><span class=\"line\">            <span class=\"built_in\">sudo</span> apt install -y ansible</span><br><span class=\"line\">        <span class=\"keyword\">elif</span> [ -f /etc/redhat-release ]; <span class=\"keyword\">then</span></span><br><span class=\"line\">            <span class=\"comment\"># CentOS/RHEL/Fedora</span></span><br><span class=\"line\">            <span class=\"built_in\">sudo</span> yum install -y epel-release</span><br><span class=\"line\">            <span class=\"built_in\">sudo</span> yum install -y ansible</span><br><span class=\"line\">        <span class=\"keyword\">else</span></span><br><span class=\"line\">            <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Unsupported OS for automatic Ansible installation. Please install Ansible manually.&quot;</span></span><br><span class=\"line\">            <span class=\"built_in\">exit</span> 1</span><br><span class=\"line\">        <span class=\"keyword\">fi</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> ! <span class=\"built_in\">command</span> -v ansible &amp;&gt; /dev/null; <span class=\"keyword\">then</span></span><br><span class=\"line\">            <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Ansible installation failed. Please install it manually and re-run this script.&quot;</span></span><br><span class=\"line\">            <span class=\"built_in\">exit</span> 1</span><br><span class=\"line\">        <span class=\"keyword\">fi</span></span><br><span class=\"line\">        <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Ansible installed successfully.&quot;</span></span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">        <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Ansible is already installed.&quot;</span></span><br><span class=\"line\">    <span class=\"keyword\">fi</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Function to create Ansible inventory file</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">create_inventory</span></span>() &#123;</span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Creating Ansible inventory file: <span class=\"variable\">$&#123;INVENTORY_FILE&#125;</span>&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">mkdir</span> -p <span class=\"string\">&quot;<span class=\"variable\">$ANSIBLE_DIR</span>&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOF &gt; &quot;$INVENTORY_FILE&quot;</span></span><br><span class=\"line\"><span class=\"string\">[kubernetes_nodes]</span></span><br><span class=\"line\"><span class=\"string\">kube-node-1 ansible_host=$&#123;KUBE_NODE_1_IP&#125;</span></span><br><span class=\"line\"><span class=\"string\">kube-node-2 ansible_host=$&#123;KUBE_NODE_2_IP&#125;</span></span><br><span class=\"line\"><span class=\"string\">kube-node-3 ansible_host=$&#123;KUBE_NODE_3_IP&#125;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">[all:vars]</span></span><br><span class=\"line\"><span class=\"string\">ansible_user=$&#123;ANSIBLE_USER&#125;</span></span><br><span class=\"line\"><span class=\"string\">ansible_python_interpreter=$&#123;ANSIBLE_PYTHON_INTERPRETER&#125;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Inventory file created.&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Function to create Ansible playbook file</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">create_playbook</span></span>() &#123;</span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Creating Ansible playbook file: <span class=\"variable\">$&#123;PLAYBOOK_FILE&#125;</span>&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">mkdir</span> -p <span class=\"string\">&quot;<span class=\"variable\">$ANSIBLE_DIR</span>&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">&#x27;EOF&#x27;</span> &gt; <span class=\"string\">&quot;<span class=\"variable\">$PLAYBOOK_FILE</span>&quot;</span></span><br><span class=\"line\">---</span><br><span class=\"line\">- name: Update DNS server on Kubernetes nodes to use <span class=\"built_in\">local</span> DNS only</span><br><span class=\"line\">  hosts: kubernetes_nodes</span><br><span class=\"line\">  become: <span class=\"built_in\">yes</span> <span class=\"comment\"># This allows Ansible to run commands with sudo privileges</span></span><br><span class=\"line\"></span><br><span class=\"line\">  tasks:</span><br><span class=\"line\">    - name: Ensure netplan configuration directory exists</span><br><span class=\"line\">      ansible.builtin.file:</span><br><span class=\"line\">        path: /etc/netplan</span><br><span class=\"line\">        state: directory</span><br><span class=\"line\">        mode: <span class=\"string\">&#x27;0755&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    - name: Get current network configuration file (e.g., 00-installer-config.yaml)</span><br><span class=\"line\">      ansible.builtin.find:</span><br><span class=\"line\">        paths: /etc/netplan</span><br><span class=\"line\">        patterns: <span class=\"string\">&#x27;*.yaml&#x27;</span></span><br><span class=\"line\">        <span class=\"comment\"># We assume there&#x27;s only one primary netplan config file for simplicity.</span></span><br><span class=\"line\">        <span class=\"comment\"># If there are multiple, you might need to specify which one.</span></span><br><span class=\"line\">      register: netplan_files</span><br><span class=\"line\"></span><br><span class=\"line\">    - name: Set network config file variable</span><br><span class=\"line\">      ansible.builtin.set_fact:</span><br><span class=\"line\">        netplan_config_file: <span class=\"string\">&quot;&#123;&#123; netplan_files.files[0].path &#125;&#125;&quot;</span></span><br><span class=\"line\">      when: netplan_files.files | length &gt; 0</span><br><span class=\"line\"></span><br><span class=\"line\">    - name: Fail <span class=\"keyword\">if</span> no netplan config file found</span><br><span class=\"line\">      ansible.builtin.fail:</span><br><span class=\"line\">        msg: <span class=\"string\">&quot;No Netplan configuration file found in /etc/netplan. Cannot proceed.&quot;</span></span><br><span class=\"line\">      when: netplan_files.files | length == 0</span><br><span class=\"line\"></span><br><span class=\"line\">    - name: Read current netplan configuration</span><br><span class=\"line\">      ansible.builtin.slurp:</span><br><span class=\"line\">        src: <span class=\"string\">&quot;&#123;&#123; netplan_config_file &#125;&#125;&quot;</span></span><br><span class=\"line\">      register: current_netplan_config</span><br><span class=\"line\"></span><br><span class=\"line\">    - name: Parse current netplan configuration</span><br><span class=\"line\">      ansible.builtin.set_fact:</span><br><span class=\"line\">        parsed_netplan: <span class=\"string\">&quot;&#123;&#123; current_netplan_config[&#x27;content&#x27;] | b64decode | from_yaml &#125;&#125;&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    - name: Update nameservers <span class=\"keyword\">in</span> netplan configuration to <span class=\"built_in\">local</span> DNS only</span><br><span class=\"line\">      ansible.builtin.set_fact:</span><br><span class=\"line\">        updated_netplan: <span class=\"string\">&quot;&#123;&#123; parsed_netplan | combine(</span></span><br><span class=\"line\"><span class=\"string\">            &#123;</span></span><br><span class=\"line\"><span class=\"string\">              &#x27;network&#x27;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">                &#x27;ethernets&#x27;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">                  &#x27;enp1s0&#x27;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">                    &#x27;nameservers&#x27;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">                      &#x27;addresses&#x27;: [&#x27;10.75.59.76&#x27;],</span></span><br><span class=\"line\"><span class=\"string\">                      &#x27;search&#x27;: [&#x27;cisco.com&#x27;]</span></span><br><span class=\"line\"><span class=\"string\">                    &#125;</span></span><br><span class=\"line\"><span class=\"string\">                  &#125;</span></span><br><span class=\"line\"><span class=\"string\">                &#125;</span></span><br><span class=\"line\"><span class=\"string\">              &#125;</span></span><br><span class=\"line\"><span class=\"string\">            &#125;, recursive=True) &#125;&#125;&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    - name: Write updated netplan configuration</span><br><span class=\"line\">      ansible.builtin.copy:</span><br><span class=\"line\">        content: <span class=\"string\">&quot;&#123;&#123; updated_netplan | to_yaml &#125;&#125;&quot;</span></span><br><span class=\"line\">        dest: <span class=\"string\">&quot;&#123;&#123; netplan_config_file &#125;&#125;&quot;</span></span><br><span class=\"line\">        mode: <span class=\"string\">&#x27;0600&#x27;</span></span><br><span class=\"line\">      notify: Apply Netplan Configuration</span><br><span class=\"line\"></span><br><span class=\"line\">  handlers:</span><br><span class=\"line\">    - name: Apply Netplan Configuration</span><br><span class=\"line\">      ansible.builtin.command: netplan apply</span><br><span class=\"line\">      listen: <span class=\"string\">&quot;Apply Netplan Configuration&quot;</span></span><br><span class=\"line\">EOF</span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Playbook file created.&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># --- Main Script Execution ---</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;Starting Ansible DNS update process...&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 1. Install Ansible if not present</span></span><br><span class=\"line\">install_ansible</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2. Create Ansible inventory file</span></span><br><span class=\"line\">create_inventory</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 3. Create Ansible playbook file</span></span><br><span class=\"line\">create_playbook</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 4. Run the Ansible playbook</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;Running Ansible playbook to update DNS on Kubernetes nodes...&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;You will be prompted for the &#x27;sudo&#x27; password for the &#x27;ubuntu&#x27; user on your VMs.&quot;</span></span><br><span class=\"line\">ansible-playbook -i <span class=\"string\">&quot;<span class=\"variable\">$INVENTORY_FILE</span>&quot;</span> <span class=\"string\">&quot;<span class=\"variable\">$PLAYBOOK_FILE</span>&quot;</span> --ask-become-pass</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> [ $? -eq 0 ]; <span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Ansible playbook executed successfully.&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Your Kubernetes nodes should now be configured to use 10.75.59.76 as their only DNS server.&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">else</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Ansible playbook failed. Please check the output for errors.&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;Process complete.&quot;</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ois@ois:~/data/k8s$ ./updatedns.sh </span><br><span class=\"line\">Starting Ansible DNS update process...</span><br><span class=\"line\">Ansible is already installed.</span><br><span class=\"line\">Creating Ansible inventory file: ansible_dns_update/hosts.ini</span><br><span class=\"line\">Inventory file created.</span><br><span class=\"line\">Creating Ansible playbook file: ansible_dns_update/update_dns.yml</span><br><span class=\"line\">Playbook file created.</span><br><span class=\"line\">Running Ansible playbook to update DNS on Kubernetes nodes...</span><br><span class=\"line\">You will be prompted <span class=\"keyword\">for</span> the <span class=\"string\">&#x27;sudo&#x27;</span> password <span class=\"keyword\">for</span> the <span class=\"string\">&#x27;ubuntu&#x27;</span> user on your VMs.</span><br><span class=\"line\">BECOME password: </span><br><span class=\"line\"></span><br><span class=\"line\">PLAY [Update DNS server on Kubernetes nodes to use <span class=\"built_in\">local</span> DNS only] *********************************************************************************************************************************************************************************************</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Gathering Facts] *****************************************************************************************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [kube-node-1]</span><br><span class=\"line\">ok: [kube-node-2]</span><br><span class=\"line\">ok: [kube-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Ensure netplan configuration directory exists] ***********************************************************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [kube-node-3]</span><br><span class=\"line\">ok: [kube-node-2]</span><br><span class=\"line\">ok: [kube-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Get current network configuration file (e.g., 00-installer-config.yaml)] *********************************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [kube-node-3]</span><br><span class=\"line\">ok: [kube-node-1]</span><br><span class=\"line\">ok: [kube-node-2]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Set network config file variable] ************************************************************************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [kube-node-1]</span><br><span class=\"line\">ok: [kube-node-2]</span><br><span class=\"line\">ok: [kube-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Fail <span class=\"keyword\">if</span> no netplan config file found] ********************************************************************************************************************************************************************************************************************</span><br><span class=\"line\">skipping: [kube-node-1]</span><br><span class=\"line\">skipping: [kube-node-2]</span><br><span class=\"line\">skipping: [kube-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Read current netplan configuration] **********************************************************************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [kube-node-3]</span><br><span class=\"line\">ok: [kube-node-1]</span><br><span class=\"line\">ok: [kube-node-2]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Parse current netplan configuration] *********************************************************************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [kube-node-1]</span><br><span class=\"line\">ok: [kube-node-2]</span><br><span class=\"line\">ok: [kube-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Update nameservers <span class=\"keyword\">in</span> netplan configuration to <span class=\"built_in\">local</span> DNS only] *******************************************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [kube-node-1]</span><br><span class=\"line\">ok: [kube-node-2]</span><br><span class=\"line\">ok: [kube-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Write updated netplan configuration] *********************************************************************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [kube-node-3]</span><br><span class=\"line\">ok: [kube-node-1]</span><br><span class=\"line\">ok: [kube-node-2]</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY RECAP *****************************************************************************************************************************************************************************************************************************************************</span><br><span class=\"line\">kube-node-1                : ok=8    changed=0    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   </span><br><span class=\"line\">kube-node-2                : ok=8    changed=0    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   </span><br><span class=\"line\">kube-node-3                : ok=8    changed=0    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   </span><br><span class=\"line\"></span><br><span class=\"line\">Ansible playbook executed successfully.</span><br><span class=\"line\">Your Kubernetes nodes should now be configured to use 10.75.59.76 as their only DNS server.</span><br><span class=\"line\">Process complete.</span><br><span class=\"line\"></span><br><span class=\"line\">root@kube-node-1:~# <span class=\"built_in\">cat</span> /etc/resolv.conf </span><br><span class=\"line\"><span class=\"comment\"># This is /run/systemd/resolve/stub-resolv.conf managed by man:systemd-resolved(8).</span></span><br><span class=\"line\"><span class=\"comment\"># Do not edit.</span></span><br><span class=\"line\"><span class=\"comment\">#</span></span><br><span class=\"line\"><span class=\"comment\"># This file might be symlinked as /etc/resolv.conf. If you&#x27;re looking at</span></span><br><span class=\"line\"><span class=\"comment\"># /etc/resolv.conf and seeing this text, you have followed the symlink.</span></span><br><span class=\"line\"><span class=\"comment\">#</span></span><br><span class=\"line\"><span class=\"comment\"># This is a dynamic resolv.conf file for connecting local clients to the</span></span><br><span class=\"line\"><span class=\"comment\"># internal DNS stub resolver of systemd-resolved. This file lists all</span></span><br><span class=\"line\"><span class=\"comment\"># configured search domains.</span></span><br><span class=\"line\"><span class=\"comment\">#</span></span><br><span class=\"line\"><span class=\"comment\"># Run &quot;resolvectl status&quot; to see details about the uplink DNS servers</span></span><br><span class=\"line\"><span class=\"comment\"># currently in use.</span></span><br><span class=\"line\"><span class=\"comment\">#</span></span><br><span class=\"line\"><span class=\"comment\"># Third party programs should typically not access this file directly, but only</span></span><br><span class=\"line\"><span class=\"comment\"># through the symlink at /etc/resolv.conf. To manage man:resolv.conf(5) in a</span></span><br><span class=\"line\"><span class=\"comment\"># different way, replace this symlink by a static file or a different symlink.</span></span><br><span class=\"line\"><span class=\"comment\">#</span></span><br><span class=\"line\"><span class=\"comment\"># See man:systemd-resolved.service(8) for details about the supported modes of</span></span><br><span class=\"line\"><span class=\"comment\"># operation for /etc/resolv.conf.</span></span><br><span class=\"line\"></span><br><span class=\"line\">nameserver 127.0.0.53</span><br><span class=\"line\">options edns0 trust-ad</span><br><span class=\"line\">search cisco.com</span><br><span class=\"line\">root@kube-node-1:~# <span class=\"built_in\">cat</span> /etc/netplan/50-cloud-init.yaml </span><br><span class=\"line\">network:</span><br><span class=\"line\">  ethernets:</span><br><span class=\"line\">    enp1s0:</span><br><span class=\"line\">      addresses: [10.75.59.71/24]</span><br><span class=\"line\">      nameservers:</span><br><span class=\"line\">        addresses: [10.75.59.76]</span><br><span class=\"line\">        search: [cisco.com]</span><br><span class=\"line\">      routes:</span><br><span class=\"line\">      - &#123;to: default, via: 10.75.59.1&#125;</span><br><span class=\"line\">  version: 2</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"3-4-使用Ansible配置FRR-BGP\"><a href=\"#3-4-使用Ansible配置FRR-BGP\" class=\"headerlink\" title=\"3.4 使用Ansible配置FRR BGP\"></a>3.4 使用Ansible配置FRR BGP</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#!/bin/bash</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># This script automates the setup of an Ansible environment for installing and configuring FRRouting (FRR).</span></span><br><span class=\"line\"><span class=\"comment\"># It creates the project directory, inventory, configuration, and the playbook</span></span><br><span class=\"line\"><span class=\"comment\"># with an idempotent role to install and configure FRR.</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># --- Configuration ---</span></span><br><span class=\"line\">PROJECT_DIR=<span class=\"string\">&quot;ansible-frr-setup&quot;</span> <span class=\"comment\"># Changed project directory name</span></span><br><span class=\"line\">FRR_NODE_IP=<span class=\"string\">&quot;10.75.59.76&quot;</span> <span class=\"comment\"># IP address of your FRR VM (frr-server-vm)</span></span><br><span class=\"line\">ANSIBLE_USER=<span class=\"string\">&quot;ubuntu&quot;</span> <span class=\"comment\"># The user created by cloud-init on your VMs</span></span><br><span class=\"line\">SSH_PRIVATE_KEY_PATH=<span class=\"string\">&quot;~/.ssh/id_rsa&quot;</span> <span class=\"comment\"># Path to your SSH private key on the Ansible control machine</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># FRR specific configuration</span></span><br><span class=\"line\">FRR_AS=65000 <span class=\"comment\"># The Autonomous System number for this FRR node (example AS, choose your own)</span></span><br><span class=\"line\">K8S_MASTER_IP=<span class=\"string\">&quot;10.75.59.71&quot;</span> <span class=\"comment\"># From your create-vms.sh script</span></span><br><span class=\"line\">K8S_WORKER_1_IP=<span class=\"string\">&quot;10.75.59.72&quot;</span> <span class=\"comment\"># From your create-vms.sh script</span></span><br><span class=\"line\">K8S_WORKER_2_IP=<span class=\"string\">&quot;10.75.59.73&quot;</span> <span class=\"comment\"># From your create-vms.sh script</span></span><br><span class=\"line\">CILIUM_BGP_AS=65000 <span class=\"comment\"># AS for Cilium as per your CiliumBGPClusterConfig</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># --- Functions ---</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Function to install Ansible (if not already installed)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">install_ansible</span></span>() &#123;</span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;--- Installing Ansible ---&quot;</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> ! <span class=\"built_in\">command</span> -v ansible &amp;&gt; /dev/null; <span class=\"keyword\">then</span></span><br><span class=\"line\">        <span class=\"built_in\">sudo</span> apt update -y</span><br><span class=\"line\">        <span class=\"built_in\">sudo</span> apt install -y ansible</span><br><span class=\"line\">        <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Ansible installed successfully.&quot;</span></span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">        <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Ansible is already installed.&quot;</span></span><br><span class=\"line\">    <span class=\"keyword\">fi</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Function to create project directory and navigate into it</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">create_project_dir</span></span>() &#123;</span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;--- Creating project directory: <span class=\"variable\">$&#123;PROJECT_DIR&#125;</span> ---&quot;</span></span><br><span class=\"line\">    <span class=\"comment\"># Check if directory exists, if so, just navigate, otherwise create and navigate</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> [ ! -d <span class=\"string\">&quot;<span class=\"variable\">$&#123;PROJECT_DIR&#125;</span>&quot;</span> ]; <span class=\"keyword\">then</span></span><br><span class=\"line\">        <span class=\"built_in\">mkdir</span> -p <span class=\"string\">&quot;<span class=\"variable\">$&#123;PROJECT_DIR&#125;</span>&quot;</span></span><br><span class=\"line\">        <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Created new directory: <span class=\"variable\">$&#123;PROJECT_DIR&#125;</span>&quot;</span></span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">        <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Directory <span class=\"variable\">$&#123;PROJECT_DIR&#125;</span> already exists.&quot;</span></span><br><span class=\"line\">    <span class=\"keyword\">fi</span></span><br><span class=\"line\">    <span class=\"built_in\">cd</span> <span class=\"string\">&quot;<span class=\"variable\">$&#123;PROJECT_DIR&#125;</span>&quot;</span> || &#123; <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Failed to change directory to <span class=\"variable\">$&#123;PROJECT_DIR&#125;</span>. Exiting.&quot;</span>; <span class=\"built_in\">exit</span> 1; &#125;</span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Changed to directory: <span class=\"subst\">$(pwd)</span>&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Function to create ansible.cfg</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">create_ansible_cfg</span></span>() &#123;</span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;--- Creating ansible.cfg ---&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOF &gt; ansible.cfg</span></span><br><span class=\"line\"><span class=\"string\">[defaults]</span></span><br><span class=\"line\"><span class=\"string\">inventory = inventory.ini</span></span><br><span class=\"line\"><span class=\"string\">roles_path = ./roles</span></span><br><span class=\"line\"><span class=\"string\">host_key_checking = False # WARNING: Disable host key checking for convenience. Re-enable for production!</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;ansible.cfg created.&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Function to create inventory.ini</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">create_inventory</span></span>() &#123;</span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;--- Creating inventory.ini ---&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOF &gt; inventory.ini</span></span><br><span class=\"line\"><span class=\"string\">[frr_nodes]</span></span><br><span class=\"line\"><span class=\"string\">frr-node-1 ansible_host=$&#123;FRR_NODE_IP&#125;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">[all:vars]</span></span><br><span class=\"line\"><span class=\"string\">ansible_user=$&#123;ANSIBLE_USER&#125;</span></span><br><span class=\"line\"><span class=\"string\">ansible_ssh_private_key_file=$&#123;SSH_PRIVATE_KEY_PATH&#125;</span></span><br><span class=\"line\"><span class=\"string\">ansible_python_interpreter=/usr/bin/python3</span></span><br><span class=\"line\"><span class=\"string\">FRR_AS=$&#123;FRR_AS&#125;</span></span><br><span class=\"line\"><span class=\"string\">K8S_MASTER_IP=$&#123;K8S_MASTER_IP&#125;</span></span><br><span class=\"line\"><span class=\"string\">K8S_WORKER_1_IP=$&#123;K8S_WORKER_1_IP&#125;</span></span><br><span class=\"line\"><span class=\"string\">K8S_WORKER_2_IP=$&#123;K8S_WORKER_2_IP&#125;</span></span><br><span class=\"line\"><span class=\"string\">CILIUM_BGP_AS=$&#123;CILIUM_BGP_AS&#125;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;inventory.ini created.&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Function to create the main playbook.yml</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">create_playbook</span></span>() &#123;</span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;--- Creating playbook.yml ---&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOF &gt; playbook.yml</span></span><br><span class=\"line\"><span class=\"string\">---</span></span><br><span class=\"line\"><span class=\"string\">- name: Install and Configure FRRouting (FRR)</span></span><br><span class=\"line\"><span class=\"string\">  hosts: frr_nodes</span></span><br><span class=\"line\"><span class=\"string\">  become: yes</span></span><br><span class=\"line\"><span class=\"string\">  roles:</span></span><br><span class=\"line\"><span class=\"string\">    - frr_setup # Changed role name to frr_setup</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;playbook.yml created.&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Function to create the FRR installation and configuration role</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">create_frr_role</span></span>() &#123; <span class=\"comment\"># Changed function name from create_gobgp_role</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;--- Creating Ansible role for FRR setup ---&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">mkdir</span> -p roles/frr_setup/tasks</span><br><span class=\"line\">    <span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOF &gt; roles/frr_setup/tasks/main.yml</span></span><br><span class=\"line\"><span class=\"string\">---</span></span><br><span class=\"line\"><span class=\"string\">- name: Install FRRouting (FRR)</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.apt:</span></span><br><span class=\"line\"><span class=\"string\">    name: frr</span></span><br><span class=\"line\"><span class=\"string\">    state: present</span></span><br><span class=\"line\"><span class=\"string\">    update_cache: yes</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Configure FRR daemons (enable zebra and bgpd)</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.lineinfile:</span></span><br><span class=\"line\"><span class=\"string\">    path: /etc/frr/daemons</span></span><br><span class=\"line\"><span class=\"string\">    regexp: &#x27;^(zebra|bgpd)=&#x27;</span></span><br><span class=\"line\"><span class=\"string\">    line: &#x27;\\1=yes&#x27;</span></span><br><span class=\"line\"><span class=\"string\">    state: present</span></span><br><span class=\"line\"><span class=\"string\">    backrefs: yes # Required to make regexp work for replacement</span></span><br><span class=\"line\"><span class=\"string\">  notify: Restart FRR service</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Configure frr.conf</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.copy:</span></span><br><span class=\"line\"><span class=\"string\">    dest: /etc/frr/frr.conf</span></span><br><span class=\"line\"><span class=\"string\">    content: |</span></span><br><span class=\"line\"><span class=\"string\">      !</span></span><br><span class=\"line\"><span class=\"string\">      hostname &#123;&#123; ansible_hostname &#125;&#125;</span></span><br><span class=\"line\"><span class=\"string\">      password zebra</span></span><br><span class=\"line\"><span class=\"string\">      enable password zebra</span></span><br><span class=\"line\"><span class=\"string\">      !</span></span><br><span class=\"line\"><span class=\"string\">      log syslog informational</span></span><br><span class=\"line\"><span class=\"string\">      !</span></span><br><span class=\"line\"><span class=\"string\">      router bgp &#123;&#123; FRR_AS &#125;&#125;</span></span><br><span class=\"line\"><span class=\"string\">       bgp router-id &#123;&#123; ansible_host &#125;&#125;</span></span><br><span class=\"line\"><span class=\"string\">       !</span></span><br><span class=\"line\"><span class=\"string\">       neighbor &#123;&#123; K8S_MASTER_IP &#125;&#125; remote-as &#123;&#123; CILIUM_BGP_AS &#125;&#125;</span></span><br><span class=\"line\"><span class=\"string\">       neighbor &#123;&#123; K8S_WORKER_1_IP &#125;&#125; remote-as &#123;&#123; CILIUM_BGP_AS &#125;&#125;</span></span><br><span class=\"line\"><span class=\"string\">       neighbor &#123;&#123; K8S_WORKER_2_IP &#125;&#125; remote-as &#123;&#123; CILIUM_BGP_AS &#125;&#125;</span></span><br><span class=\"line\"><span class=\"string\">       !</span></span><br><span class=\"line\"><span class=\"string\">       address-family ipv4 unicast</span></span><br><span class=\"line\"><span class=\"string\">        # Crucial: Redistribute BGP learned routes into the kernel</span></span><br><span class=\"line\"><span class=\"string\">        redistribute connected</span></span><br><span class=\"line\"><span class=\"string\">        redistribute static</span></span><br><span class=\"line\"><span class=\"string\">        redistribute kernel</span></span><br><span class=\"line\"><span class=\"string\">       exit-address-family</span></span><br><span class=\"line\"><span class=\"string\">      !</span></span><br><span class=\"line\"><span class=\"string\">      line vty</span></span><br><span class=\"line\"><span class=\"string\">      !</span></span><br><span class=\"line\"><span class=\"string\">    mode: &#x27;0644&#x27;</span></span><br><span class=\"line\"><span class=\"string\">  notify: Restart FRR service # Handler only runs if file content changes</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Set permissions for frr.conf</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.file:</span></span><br><span class=\"line\"><span class=\"string\">    path: /etc/frr/frr.conf</span></span><br><span class=\"line\"><span class=\"string\">    owner: frr</span></span><br><span class=\"line\"><span class=\"string\">    group: frr</span></span><br><span class=\"line\"><span class=\"string\">    mode: &#x27;0640&#x27;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Enable and start FRR service</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.systemd:</span></span><br><span class=\"line\"><span class=\"string\">    name: frr</span></span><br><span class=\"line\"><span class=\"string\">    state: started</span></span><br><span class=\"line\"><span class=\"string\">    enabled: yes</span></span><br><span class=\"line\"><span class=\"string\">    daemon_reload: yes # Ensure systemd reloads unit files if service file changed</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">mkdir</span> -p roles/frr_setup/handlers</span><br><span class=\"line\">    <span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOF &gt; roles/frr_setup/handlers/main.yml</span></span><br><span class=\"line\"><span class=\"string\">---</span></span><br><span class=\"line\"><span class=\"string\">- name: Restart FRR service</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.systemd:</span></span><br><span class=\"line\"><span class=\"string\">    name: frr</span></span><br><span class=\"line\"><span class=\"string\">    state: restarted</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;FRR Ansible role created.&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># --- Main execution ---</span></span><br><span class=\"line\">install_ansible</span><br><span class=\"line\">create_project_dir</span><br><span class=\"line\">create_ansible_cfg</span><br><span class=\"line\">create_inventory</span><br><span class=\"line\">create_playbook</span><br><span class=\"line\">create_frr_role <span class=\"comment\"># Changed function call</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;--- Ansible setup for FRR installation is complete! ---&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;Navigate to the new project directory:&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;cd <span class=\"variable\">$&#123;PROJECT_DIR&#125;</span>&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;Then, run the Ansible playbook to install and configure FRR on your VM:&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;ansible-playbook playbook.yml -K&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;After the playbook finishes, FRR should be running and configured on <span class=\"variable\">$&#123;FRR_NODE_IP&#125;</span>.&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;You can SSH into the VM and verify with &#x27;sudo vtysh -c \\&quot;show ip bgp summary\\&quot;&#x27; and &#x27;sudo ip route show&#x27;.&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">ois@ois:~/data/k8s$ ./ansible-frr.sh </span><br><span class=\"line\">--- Installing Ansible ---</span><br><span class=\"line\">Ansible is already installed.</span><br><span class=\"line\">--- Creating project directory: ansible-frr-setup ---</span><br><span class=\"line\">Created new directory: ansible-frr-setup</span><br><span class=\"line\">Changed to directory: /home/ois/data/k8s/ansible-frr-setup</span><br><span class=\"line\">--- Creating ansible.cfg ---</span><br><span class=\"line\">ansible.cfg created.</span><br><span class=\"line\">--- Creating inventory.ini ---</span><br><span class=\"line\">inventory.ini created.</span><br><span class=\"line\">--- Creating playbook.yml ---</span><br><span class=\"line\">playbook.yml created.</span><br><span class=\"line\">--- Creating Ansible role <span class=\"keyword\">for</span> FRR setup ---</span><br><span class=\"line\">FRR Ansible role created.</span><br><span class=\"line\"></span><br><span class=\"line\">--- Ansible setup <span class=\"keyword\">for</span> FRR installation is complete! ---</span><br><span class=\"line\">Navigate to the new project directory:</span><br><span class=\"line\"><span class=\"built_in\">cd</span> ansible-frr-setup</span><br><span class=\"line\"></span><br><span class=\"line\">Then, run the Ansible playbook to install and configure FRR on your VM:</span><br><span class=\"line\">ansible-playbook playbook.yml -K</span><br><span class=\"line\"></span><br><span class=\"line\">After the playbook finishes, FRR should be running and configured on 10.75.59.76.</span><br><span class=\"line\">You can SSH into the VM and verify with <span class=\"string\">&#x27;sudo vtysh -c &quot;show ip bgp summary&quot;&#x27;</span> and <span class=\"string\">&#x27;sudo ip route show&#x27;</span>.</span><br><span class=\"line\">ois@ois:~/data/k8s$ <span class=\"built_in\">cd</span> ansible-frr-setup/</span><br><span class=\"line\">ois@ois:~/data/k8s/ansible-frr-setup$ ansible-playbook playbook.yml -K</span><br><span class=\"line\">BECOME password: </span><br><span class=\"line\"></span><br><span class=\"line\">PLAY [Install and Configure FRRouting (FRR)] *******************************************************************************************************************************************************************************************************************</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Gathering Facts] *****************************************************************************************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [frr-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [frr_setup : Install FRRouting (FRR)] *********************************************************************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [frr-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [frr_setup : Configure FRR daemons (<span class=\"built_in\">enable</span> zebra and bgpd)] ***********************************************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [frr-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [frr_setup : Configure frr.conf] **************************************************************************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [frr-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [frr_setup : Set permissions <span class=\"keyword\">for</span> frr.conf] ****************************************************************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [frr-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [frr_setup : Enable and start FRR service] ****************************************************************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [frr-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">RUNNING HANDLER [frr_setup : Restart FRR service] **************************************************************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [frr-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY RECAP *****************************************************************************************************************************************************************************************************************************************************</span><br><span class=\"line\">frr-node-1                 : ok=7    changed=5    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@dns-server-vm:~# <span class=\"built_in\">cat</span> /etc/frr/frr.conf </span><br><span class=\"line\">!</span><br><span class=\"line\">hostname dns-server-vm</span><br><span class=\"line\">password zebra</span><br><span class=\"line\"><span class=\"built_in\">enable</span> password zebra</span><br><span class=\"line\">!</span><br><span class=\"line\"><span class=\"built_in\">log</span> syslog informational</span><br><span class=\"line\">!</span><br><span class=\"line\">router bgp 65000</span><br><span class=\"line\"> bgp router-id 10.75.59.76</span><br><span class=\"line\"> !</span><br><span class=\"line\"> neighbor 10.75.59.71 remote-as 65000</span><br><span class=\"line\"> neighbor 10.75.59.72 remote-as 65000</span><br><span class=\"line\"> neighbor 10.75.59.73 remote-as 65000</span><br><span class=\"line\"> !</span><br><span class=\"line\"> address-family ipv4 unicast</span><br><span class=\"line\">  <span class=\"comment\"># Crucial: Redistribute BGP learned routes into the kernel</span></span><br><span class=\"line\">  redistribute connected</span><br><span class=\"line\">  redistribute static</span><br><span class=\"line\">  redistribute kernel</span><br><span class=\"line\"> exit-address-family</span><br><span class=\"line\">!</span><br><span class=\"line\">line vty</span><br><span class=\"line\">!</span><br><span class=\"line\">root@dns-server-vm:~# systemctl status frr</span><br><span class=\"line\">* frr.service - FRRouting</span><br><span class=\"line\">     Loaded: loaded (/usr/lib/systemd/system/frr.service; enabled; preset: enabled)</span><br><span class=\"line\">     Active: active (running) since Wed 2025-07-23 12:16:58 JST; 1 week 1 day ago</span><br><span class=\"line\">       Docs: https://frrouting.readthedocs.io/en/latest/setup.html</span><br><span class=\"line\">    Process: 15611 ExecStart=/usr/lib/frr/frrinit.sh start (code=exited, status=0/SUCCESS)</span><br><span class=\"line\">   Main PID: 15623 (watchfrr)</span><br><span class=\"line\">     Status: <span class=\"string\">&quot;FRR Operational&quot;</span></span><br><span class=\"line\">      Tasks: 13 (<span class=\"built_in\">limit</span>: 9486)</span><br><span class=\"line\">     Memory: 21.1M (peak: 28.3M)</span><br><span class=\"line\">        CPU: 5min 23.845s</span><br><span class=\"line\">     CGroup: /system.slice/frr.service</span><br><span class=\"line\">             |-15623 /usr/lib/frr/watchfrr -d -F traditional zebra bgpd staticd</span><br><span class=\"line\">             |-15636 /usr/lib/frr/zebra -d -F traditional -A 127.0.0.1 -s 90000000</span><br><span class=\"line\">             |-15641 /usr/lib/frr/bgpd -d -F traditional -A 127.0.0.1</span><br><span class=\"line\">             `-15648 /usr/lib/frr/staticd -d -F traditional -A 127.0.0.1</span><br><span class=\"line\"></span><br><span class=\"line\">Jul 31 16:26:25 dns-server-vm bgpd[15641]: [M59KS-A3ZXZ] bgp_update_receive: rcvd End-of-RIB <span class=\"keyword\">for</span> IPv4 Unicast from 10.75.59.71 <span class=\"keyword\">in</span> vrf default</span><br><span class=\"line\">Jul 31 16:27:24 dns-server-vm bgpd[15641]: [M59KS-A3ZXZ] bgp_update_receive: rcvd End-of-RIB <span class=\"keyword\">for</span> IPv4 Unicast from 10.75.59.73 <span class=\"keyword\">in</span> vrf default</span><br><span class=\"line\">Jul 31 16:27:24 dns-server-vm bgpd[15641]: [M59KS-A3ZXZ] bgp_update_receive: rcvd End-of-RIB <span class=\"keyword\">for</span> IPv4 Unicast from 10.75.59.72 <span class=\"keyword\">in</span> vrf default</span><br><span class=\"line\">Jul 31 16:27:24 dns-server-vm bgpd[15641]: [M59KS-A3ZXZ] bgp_update_receive: rcvd End-of-RIB <span class=\"keyword\">for</span> IPv4 Unicast from 10.75.59.71 <span class=\"keyword\">in</span> vrf default</span><br><span class=\"line\">Jul 31 16:46:48 dns-server-vm bgpd[15641]: [M59KS-A3ZXZ] bgp_update_receive: rcvd End-of-RIB <span class=\"keyword\">for</span> IPv4 Unicast from 10.75.59.72 <span class=\"keyword\">in</span> vrf default</span><br><span class=\"line\">Jul 31 16:46:48 dns-server-vm bgpd[15641]: [M59KS-A3ZXZ] bgp_update_receive: rcvd End-of-RIB <span class=\"keyword\">for</span> IPv4 Unicast from 10.75.59.73 <span class=\"keyword\">in</span> vrf default</span><br><span class=\"line\">Jul 31 16:46:48 dns-server-vm bgpd[15641]: [M59KS-A3ZXZ] bgp_update_receive: rcvd End-of-RIB <span class=\"keyword\">for</span> IPv4 Unicast from 10.75.59.71 <span class=\"keyword\">in</span> vrf default</span><br><span class=\"line\">Jul 31 16:47:54 dns-server-vm bgpd[15641]: [M59KS-A3ZXZ] bgp_update_receive: rcvd End-of-RIB <span class=\"keyword\">for</span> IPv4 Unicast from 10.75.59.73 <span class=\"keyword\">in</span> vrf default</span><br><span class=\"line\">Jul 31 16:47:54 dns-server-vm bgpd[15641]: [M59KS-A3ZXZ] bgp_update_receive: rcvd End-of-RIB <span class=\"keyword\">for</span> IPv4 Unicast from 10.75.59.72 <span class=\"keyword\">in</span> vrf default</span><br><span class=\"line\">Jul 31 16:47:54 dns-server-vm bgpd[15641]: [M59KS-A3ZXZ] bgp_update_receive: rcvd End-of-RIB <span class=\"keyword\">for</span> IPv4 Unicast from 10.75.59.71 <span class=\"keyword\">in</span> vrf default</span><br><span class=\"line\">root@dns-server-vm:~# ip route show</span><br><span class=\"line\">default via 10.75.59.1 dev enp1s0 proto static </span><br><span class=\"line\">10.75.59.0/24 dev enp1s0 proto kernel scope <span class=\"built_in\">link</span> src 10.75.59.76 </span><br><span class=\"line\">172.16.0.0/24 nhid 95 via 10.75.59.71 dev enp1s0 proto bgp metric 20 </span><br><span class=\"line\">172.16.1.0/24 nhid 90 via 10.75.59.72 dev enp1s0 proto bgp metric 20 </span><br><span class=\"line\">172.16.2.0/24 nhid 100 via 10.75.59.73 dev enp1s0 proto bgp metric 20 </span><br><span class=\"line\">172.16.16.1 nhid 202 proto bgp metric 20 </span><br><span class=\"line\">        nexthop via 10.75.59.72 dev enp1s0 weight 1 </span><br><span class=\"line\">        nexthop via 10.75.59.71 dev enp1s0 weight 1 </span><br><span class=\"line\">        nexthop via 10.75.59.73 dev enp1s0 weight 1 </span><br><span class=\"line\">172.16.16.10 nhid 202 proto bgp metric 20 </span><br><span class=\"line\">        nexthop via 10.75.59.72 dev enp1s0 weight 1 </span><br><span class=\"line\">        nexthop via 10.75.59.71 dev enp1s0 weight 1 </span><br><span class=\"line\">        nexthop via 10.75.59.73 dev enp1s0 weight 1 </span><br><span class=\"line\">172.16.20.119 nhid 202 proto bgp metric 20 </span><br><span class=\"line\">        nexthop via 10.75.59.72 dev enp1s0 weight 1 </span><br><span class=\"line\">        nexthop via 10.75.59.71 dev enp1s0 weight 1 </span><br><span class=\"line\">        nexthop via 10.75.59.73 dev enp1s0 weight 1 </span><br><span class=\"line\">172.16.22.26 nhid 202 proto bgp metric 20 </span><br><span class=\"line\">        nexthop via 10.75.59.72 dev enp1s0 weight 1 </span><br><span class=\"line\">        nexthop via 10.75.59.71 dev enp1s0 weight 1 </span><br><span class=\"line\">        nexthop via 10.75.59.73 dev enp1s0 weight 1 </span><br><span class=\"line\">172.16.23.18 nhid 202 proto bgp metric 20 </span><br><span class=\"line\">        nexthop via 10.75.59.72 dev enp1s0 weight 1 </span><br><span class=\"line\">        nexthop via 10.75.59.71 dev enp1s0 weight 1 </span><br><span class=\"line\">        nexthop via 10.75.59.73 dev enp1s0 weight 1 </span><br><span class=\"line\">172.16.30.170 nhid 202 proto bgp metric 20 </span><br><span class=\"line\">        nexthop via 10.75.59.72 dev enp1s0 weight 1 </span><br><span class=\"line\">        nexthop via 10.75.59.71 dev enp1s0 weight 1 </span><br><span class=\"line\">        nexthop via 10.75.59.73 dev enp1s0 weight 1 </span><br><span class=\"line\">root@dns-server-vm:~# vtysh -c <span class=\"string\">&#x27;show ip bgp summary&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">IPv4 Unicast Summary (VRF default):</span><br><span class=\"line\">BGP router identifier 10.75.59.76, <span class=\"built_in\">local</span> AS number 65000 vrf-id 0</span><br><span class=\"line\">BGP table version 222</span><br><span class=\"line\">RIB entries 19, using 3648 bytes of memory</span><br><span class=\"line\">Peers 3, using 2172 KiB of memory</span><br><span class=\"line\"></span><br><span class=\"line\">Neighbor        V         AS   MsgRcvd   MsgSent   TblVer  InQ OutQ  Up/Down State/PfxRcd   PfxSnt Desc</span><br><span class=\"line\">10.75.59.71     4      65000     71265     71182        0    0    0 03:21:08            7        2 N/A</span><br><span class=\"line\">10.75.59.72     4      65000     71344     71264        0    0    0 03:21:09            7        2 N/A</span><br><span class=\"line\">10.75.59.73     4      65000     71240     71162        0    0    0 03:21:09            7        2 N/A</span><br><span class=\"line\"></span><br><span class=\"line\">Total number of neighbors 3</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"4-设置Kubernetes集群并安装CNI-Cilium\"><a href=\"#4-设置Kubernetes集群并安装CNI-Cilium\" class=\"headerlink\" title=\"4. 设置Kubernetes集群并安装CNI Cilium\"></a>4. 设置Kubernetes集群并安装CNI Cilium</h1><h2 id=\"4-1-使用kubeadm设置Kubernetes\"><a href=\"#4-1-使用kubeadm设置Kubernetes\" class=\"headerlink\" title=\"4.1 使用kubeadm设置Kubernetes\"></a>4.1 使用kubeadm设置Kubernetes</h2><p>使用以下命令进行集群初始化</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubeadm config images pull</span><br><span class=\"line\"></span><br><span class=\"line\">kubeadm init --control-plane-endpoint=kube-node-1 --pod-network-cidr=172.16.0.0/20 --service-cidr=172.16.32.0/20 --skip-phases=addon/kube-proxy</span><br><span class=\"line\"></span><br><span class=\"line\">--skip-phases=addon/kube-proxy 表示不安装kube-proxy，会用Cilium进行替代</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ubuntu@kube-node-1:~$ <span class=\"built_in\">sudo</span> kubeadm init --control-plane-endpoint=kube-node-1 --pod-network-cidr=172.16.0.0/20 --service-cidr=172.16.32.0/20 --skip-phases=addon/kube-proxy[<span class=\"built_in\">sudo</span>] password <span class=\"keyword\">for</span> ubuntu: </span><br><span class=\"line\">[init] Using Kubernetes version: v1.33.3</span><br><span class=\"line\">[preflight] Running pre-flight checks</span><br><span class=\"line\">[preflight] Pulling images required <span class=\"keyword\">for</span> setting up a Kubernetes cluster</span><br><span class=\"line\">[preflight] This might take a minute or two, depending on the speed of your internet connection</span><br><span class=\"line\">[preflight] You can also perform this action beforehand using <span class=\"string\">&#x27;kubeadm config images pull&#x27;</span></span><br><span class=\"line\">[certs] Using certificateDir folder <span class=\"string\">&quot;/etc/kubernetes/pki&quot;</span></span><br><span class=\"line\">[certs] Generating <span class=\"string\">&quot;ca&quot;</span> certificate and key</span><br><span class=\"line\">[certs] Generating <span class=\"string\">&quot;apiserver&quot;</span> certificate and key</span><br><span class=\"line\">[certs] apiserver serving cert is signed <span class=\"keyword\">for</span> DNS names [kube-node-1 kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local] and IPs [10.248.0.1 10.75.59.71]</span><br><span class=\"line\">[certs] Generating <span class=\"string\">&quot;apiserver-kubelet-client&quot;</span> certificate and key</span><br><span class=\"line\">[certs] Generating <span class=\"string\">&quot;front-proxy-ca&quot;</span> certificate and key</span><br><span class=\"line\">[certs] Generating <span class=\"string\">&quot;front-proxy-client&quot;</span> certificate and key</span><br><span class=\"line\">[certs] Generating <span class=\"string\">&quot;etcd/ca&quot;</span> certificate and key</span><br><span class=\"line\">[certs] Generating <span class=\"string\">&quot;etcd/server&quot;</span> certificate and key</span><br><span class=\"line\">[certs] etcd/server serving cert is signed <span class=\"keyword\">for</span> DNS names [kube-node-1 localhost] and IPs [10.75.59.71 127.0.0.1 ::1]</span><br><span class=\"line\">[certs] Generating <span class=\"string\">&quot;etcd/peer&quot;</span> certificate and key</span><br><span class=\"line\">[certs] etcd/peer serving cert is signed <span class=\"keyword\">for</span> DNS names [kube-node-1 localhost] and IPs [10.75.59.71 127.0.0.1 ::1]</span><br><span class=\"line\">[certs] Generating <span class=\"string\">&quot;etcd/healthcheck-client&quot;</span> certificate and key</span><br><span class=\"line\">[certs] Generating <span class=\"string\">&quot;apiserver-etcd-client&quot;</span> certificate and key</span><br><span class=\"line\">[certs] Generating <span class=\"string\">&quot;sa&quot;</span> key and public key</span><br><span class=\"line\">[kubeconfig] Using kubeconfig folder <span class=\"string\">&quot;/etc/kubernetes&quot;</span></span><br><span class=\"line\">[kubeconfig] Writing <span class=\"string\">&quot;admin.conf&quot;</span> kubeconfig file</span><br><span class=\"line\">[kubeconfig] Writing <span class=\"string\">&quot;super-admin.conf&quot;</span> kubeconfig file</span><br><span class=\"line\">[kubeconfig] Writing <span class=\"string\">&quot;kubelet.conf&quot;</span> kubeconfig file</span><br><span class=\"line\">[kubeconfig] Writing <span class=\"string\">&quot;controller-manager.conf&quot;</span> kubeconfig file</span><br><span class=\"line\">[kubeconfig] Writing <span class=\"string\">&quot;scheduler.conf&quot;</span> kubeconfig file</span><br><span class=\"line\">[etcd] Creating static Pod manifest <span class=\"keyword\">for</span> <span class=\"built_in\">local</span> etcd <span class=\"keyword\">in</span> <span class=\"string\">&quot;/etc/kubernetes/manifests&quot;</span></span><br><span class=\"line\">[control-plane] Using manifest folder <span class=\"string\">&quot;/etc/kubernetes/manifests&quot;</span></span><br><span class=\"line\">[control-plane] Creating static Pod manifest <span class=\"keyword\">for</span> <span class=\"string\">&quot;kube-apiserver&quot;</span></span><br><span class=\"line\">[control-plane] Creating static Pod manifest <span class=\"keyword\">for</span> <span class=\"string\">&quot;kube-controller-manager&quot;</span></span><br><span class=\"line\">[control-plane] Creating static Pod manifest <span class=\"keyword\">for</span> <span class=\"string\">&quot;kube-scheduler&quot;</span></span><br><span class=\"line\">[kubelet-start] Writing kubelet environment file with flags to file <span class=\"string\">&quot;/var/lib/kubelet/kubeadm-flags.env&quot;</span></span><br><span class=\"line\">[kubelet-start] Writing kubelet configuration to file <span class=\"string\">&quot;/var/lib/kubelet/config.yaml&quot;</span></span><br><span class=\"line\">[kubelet-start] Starting the kubelet</span><br><span class=\"line\">[wait-control-plane] Waiting <span class=\"keyword\">for</span> the kubelet to boot up the control plane as static Pods from directory <span class=\"string\">&quot;/etc/kubernetes/manifests&quot;</span></span><br><span class=\"line\">[kubelet-check] Waiting <span class=\"keyword\">for</span> a healthy kubelet at http://127.0.0.1:10248/healthz. This can take up to 4m0s</span><br><span class=\"line\">[kubelet-check] The kubelet is healthy after 1.002649961s</span><br><span class=\"line\">[control-plane-check] Waiting <span class=\"keyword\">for</span> healthy control plane components. This can take up to 4m0s</span><br><span class=\"line\">[control-plane-check] Checking kube-apiserver at https://10.75.59.71:6443/livez</span><br><span class=\"line\">[control-plane-check] Checking kube-controller-manager at https://127.0.0.1:10257/healthz</span><br><span class=\"line\">[control-plane-check] Checking kube-scheduler at https://127.0.0.1:10259/livez</span><br><span class=\"line\">[control-plane-check] kube-controller-manager is healthy after 1.813351787s</span><br><span class=\"line\">[control-plane-check] kube-scheduler is healthy after 3.309147352s</span><br><span class=\"line\">[control-plane-check] kube-apiserver is healthy after 5.505049123s</span><br><span class=\"line\">[upload-config] Storing the configuration used <span class=\"keyword\">in</span> ConfigMap <span class=\"string\">&quot;kubeadm-config&quot;</span> <span class=\"keyword\">in</span> the <span class=\"string\">&quot;kube-system&quot;</span> Namespace</span><br><span class=\"line\">[kubelet] Creating a ConfigMap <span class=\"string\">&quot;kubelet-config&quot;</span> <span class=\"keyword\">in</span> namespace kube-system with the configuration <span class=\"keyword\">for</span> the kubelets <span class=\"keyword\">in</span> the cluster</span><br><span class=\"line\">[upload-certs] Skipping phase. Please see --upload-certs</span><br><span class=\"line\">[mark-control-plane] Marking the node kube-node-1 as control-plane by adding the labels: [node-role.kubernetes.io/control-plane node.kubernetes.io/exclude-from-external-load-balancers]</span><br><span class=\"line\">[mark-control-plane] Marking the node kube-node-1 as control-plane by adding the taints [node-role.kubernetes.io/control-plane:NoSchedule]</span><br><span class=\"line\">[bootstrap-token] Using token: 1r5ugd.o2pjzipcq69z71l8</span><br><span class=\"line\">[bootstrap-token] Configuring bootstrap tokens, cluster-info ConfigMap, RBAC Roles</span><br><span class=\"line\">[bootstrap-token] Configured RBAC rules to allow Node Bootstrap tokens to get nodes</span><br><span class=\"line\">[bootstrap-token] Configured RBAC rules to allow Node Bootstrap tokens to post CSRs <span class=\"keyword\">in</span> order <span class=\"keyword\">for</span> nodes to get long term certificate credentials</span><br><span class=\"line\">[bootstrap-token] Configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token</span><br><span class=\"line\">[bootstrap-token] Configured RBAC rules to allow certificate rotation <span class=\"keyword\">for</span> all node client certificates <span class=\"keyword\">in</span> the cluster</span><br><span class=\"line\">[bootstrap-token] Creating the <span class=\"string\">&quot;cluster-info&quot;</span> ConfigMap <span class=\"keyword\">in</span> the <span class=\"string\">&quot;kube-public&quot;</span> namespace</span><br><span class=\"line\">[kubelet-finalize] Updating <span class=\"string\">&quot;/etc/kubernetes/kubelet.conf&quot;</span> to point to a rotatable kubelet client certificate and key</span><br><span class=\"line\">[addons] Applied essential addon: CoreDNS</span><br><span class=\"line\"></span><br><span class=\"line\">Your Kubernetes control-plane has initialized successfully!</span><br><span class=\"line\"></span><br><span class=\"line\">To start using your cluster, you need to run the following as a regular user:</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"built_in\">mkdir</span> -p <span class=\"variable\">$HOME</span>/.kube</span><br><span class=\"line\">  <span class=\"built_in\">sudo</span> <span class=\"built_in\">cp</span> -i /etc/kubernetes/admin.conf <span class=\"variable\">$HOME</span>/.kube/config</span><br><span class=\"line\">  <span class=\"built_in\">sudo</span> <span class=\"built_in\">chown</span> $(<span class=\"built_in\">id</span> -u):$(<span class=\"built_in\">id</span> -g) <span class=\"variable\">$HOME</span>/.kube/config</span><br><span class=\"line\"></span><br><span class=\"line\">Alternatively, <span class=\"keyword\">if</span> you are the root user, you can run:</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"built_in\">export</span> KUBECONFIG=/etc/kubernetes/admin.conf</span><br><span class=\"line\"></span><br><span class=\"line\">You should now deploy a pod network to the cluster.</span><br><span class=\"line\">Run <span class=\"string\">&quot;kubectl apply -f [podnetwork].yaml&quot;</span> with one of the options listed at:</span><br><span class=\"line\">  https://kubernetes.io/docs/concepts/cluster-administration/addons/</span><br><span class=\"line\"></span><br><span class=\"line\">You can now <span class=\"built_in\">join</span> any number of control-plane nodes by copying certificate authorities</span><br><span class=\"line\">and service account keys on each node and <span class=\"keyword\">then</span> running the following as root:</span><br><span class=\"line\"></span><br><span class=\"line\">  kubeadm <span class=\"built_in\">join</span> kube-node-1:6443 --token 1r5ugd.o2pjzipcq69z71l8 \\</span><br><span class=\"line\">        --discovery-token-ca-cert-hash sha256:e29fb62581a4d21268585c3b345f9e060827c52a8325b1d28b8437c792ba7923 \\</span><br><span class=\"line\">        --control-plane </span><br><span class=\"line\"></span><br><span class=\"line\">Then you can <span class=\"built_in\">join</span> any number of worker nodes by running the following on each as root:</span><br><span class=\"line\"></span><br><span class=\"line\">kubeadm <span class=\"built_in\">join</span> kube-node-1:6443 --token 1r5ugd.o2pjzipcq69z71l8 \\</span><br><span class=\"line\">        --discovery-token-ca-cert-hash sha256:e29fb62581a4d21268585c3b345f9e060827c52a8325b1d28b8437c792ba7923 </span><br><span class=\"line\">ubuntu@kube-node-1:~$ </span><br><span class=\"line\">ubuntu@kube-node-1:~$   <span class=\"built_in\">mkdir</span> -p <span class=\"variable\">$HOME</span>/.kube</span><br><span class=\"line\">  <span class=\"built_in\">sudo</span> <span class=\"built_in\">cp</span> -i /etc/kubernetes/admin.conf <span class=\"variable\">$HOME</span>/.kube/config</span><br><span class=\"line\">  <span class=\"built_in\">sudo</span> <span class=\"built_in\">chown</span> $(<span class=\"built_in\">id</span> -u):$(<span class=\"built_in\">id</span> -g) <span class=\"variable\">$HOME</span>/.kube/config</span><br><span class=\"line\">ubuntu@kube-node-1:~$ <span class=\"built_in\">sudo</span> su</span><br><span class=\"line\">root@kube-node-1:/home/ubuntu# <span class=\"built_in\">cd</span></span><br><span class=\"line\"></span><br><span class=\"line\">在.bashrc 中增加以下内容</span><br><span class=\"line\">root@kube-node-1:~# <span class=\"built_in\">cat</span> .bashrc | grep <span class=\"built_in\">export</span></span><br><span class=\"line\"><span class=\"built_in\">export</span> KUBECONFIG=/etc/kubernetes/admin.conf</span><br><span class=\"line\"></span><br><span class=\"line\">这样root才能执行 kubectl 命令与 api-server通信.</span><br><span class=\"line\"></span><br><span class=\"line\">root@kube-node-1:~# kubectl cluster-info</span><br><span class=\"line\">Kubernetes control plane is running at https://kube-node-1:6443</span><br><span class=\"line\">CoreDNS is running at https://kube-node-1:6443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy</span><br><span class=\"line\"></span><br><span class=\"line\">To further debug and diagnose cluster problems, use <span class=\"string\">&#x27;kubectl cluster-info dump&#x27;</span>.</span><br><span class=\"line\">root@kube-node-1:~# kubectl get node -o wide</span><br><span class=\"line\">NAME          STATUS     ROLES           AGE   VERSION   INTERNAL-IP   EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION     CONTAINER-RUNTIME</span><br><span class=\"line\">kube-node-1   NotReady   control-plane   68s   v1.33.3   10.75.59.71   &lt;none&gt;        Ubuntu 24.04.2 LTS   6.8.0-63-generic   containerd://1.7.27</span><br><span class=\"line\"></span><br><span class=\"line\">还没有安装CNI，Node NotReady</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"4-2-使用Ansible安装Helm\"><a href=\"#4-2-使用Ansible安装Helm\" class=\"headerlink\" title=\"4.2 使用Ansible安装Helm\"></a>4.2 使用Ansible安装Helm</h2><p>设置Helm的目的是为了安装Cilium，并非一定要使用Ansible来进行设置，供参考。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#!/bin/bash</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># This script automates the setup of an Ansible environment for installing Helm.</span></span><br><span class=\"line\"><span class=\"comment\"># It creates the project directory, inventory, configuration, and the playbook</span></span><br><span class=\"line\"><span class=\"comment\"># with an idempotent role to install Helm.</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># --- Configuration ---</span></span><br><span class=\"line\">PROJECT_DIR=<span class=\"string\">&quot;ansible-helm&quot;</span></span><br><span class=\"line\">MASTER_NODE_IP=<span class=\"string\">&quot;10.75.59.71&quot;</span> <span class=\"comment\"># IP address of your Kubernetes master node (kube-node-1)</span></span><br><span class=\"line\">ANSIBLE_USER=<span class=\"string\">&quot;ubuntu&quot;</span> <span class=\"comment\"># The user created by cloud-init on your VMs</span></span><br><span class=\"line\">SSH_PRIVATE_KEY_PATH=<span class=\"string\">&quot;~/.ssh/id_rsa&quot;</span> <span class=\"comment\"># Path to your SSH private key on the Ansible control machine</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Helm version to install</span></span><br><span class=\"line\">HELM_VERSION=<span class=\"string\">&quot;v3.18.4&quot;</span> <span class=\"comment\"># You can change this to a desired stable version</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># --- Functions ---</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Function to create project directory and navigate into it</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">create_project_dir</span></span>() &#123;</span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;--- Creating project directory: <span class=\"variable\">$&#123;PROJECT_DIR&#125;</span> ---&quot;</span></span><br><span class=\"line\">    <span class=\"comment\"># Check if directory exists, if so, just navigate, otherwise create and navigate</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> [ ! -d <span class=\"string\">&quot;<span class=\"variable\">$&#123;PROJECT_DIR&#125;</span>&quot;</span> ]; <span class=\"keyword\">then</span></span><br><span class=\"line\">        <span class=\"built_in\">mkdir</span> -p <span class=\"string\">&quot;<span class=\"variable\">$&#123;PROJECT_DIR&#125;</span>&quot;</span></span><br><span class=\"line\">        <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Created new directory: <span class=\"variable\">$&#123;PROJECT_DIR&#125;</span>&quot;</span></span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">        <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Directory <span class=\"variable\">$&#123;PROJECT_DIR&#125;</span> already exists.&quot;</span></span><br><span class=\"line\">    <span class=\"keyword\">fi</span></span><br><span class=\"line\">    <span class=\"built_in\">cd</span> <span class=\"string\">&quot;<span class=\"variable\">$&#123;PROJECT_DIR&#125;</span>&quot;</span> || &#123; <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Failed to change directory to <span class=\"variable\">$&#123;PROJECT_DIR&#125;</span>. Exiting.&quot;</span>; <span class=\"built_in\">exit</span> 1; &#125;</span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Changed to directory: <span class=\"subst\">$(pwd)</span>&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Function to create ansible.cfg</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">create_ansible_cfg</span></span>() &#123;</span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;--- Creating ansible.cfg ---&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOF &gt; ansible.cfg</span></span><br><span class=\"line\"><span class=\"string\">[defaults]</span></span><br><span class=\"line\"><span class=\"string\">inventory = inventory.ini</span></span><br><span class=\"line\"><span class=\"string\">roles_path = ./roles</span></span><br><span class=\"line\"><span class=\"string\">host_key_checking = False # WARNING: Disable host key checking for convenience. Re-enable for production!</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;ansible.cfg created.&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Function to create inventory.ini</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">create_inventory</span></span>() &#123;</span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;--- Creating inventory.ini ---&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOF &gt; inventory.ini</span></span><br><span class=\"line\"><span class=\"string\">[kubernetes_master]</span></span><br><span class=\"line\"><span class=\"string\">kube-node-1 ansible_host=$&#123;MASTER_NODE_IP&#125;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">[all:vars]</span></span><br><span class=\"line\"><span class=\"string\">ansible_user=$&#123;ANSIBLE_USER&#125;</span></span><br><span class=\"line\"><span class=\"string\">ansible_ssh_private_key_file=$&#123;SSH_PRIVATE_KEY_PATH&#125;</span></span><br><span class=\"line\"><span class=\"string\">ansible_python_interpreter=/usr/bin/python3</span></span><br><span class=\"line\"><span class=\"string\">HELM_VERSION=$&#123;HELM_VERSION&#125;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;inventory.ini created.&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Function to create the main playbook.yml</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">create_playbook</span></span>() &#123;</span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;--- Creating playbook.yml ---&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOF &gt; playbook.yml</span></span><br><span class=\"line\"><span class=\"string\">---</span></span><br><span class=\"line\"><span class=\"string\">- name: Install Helm on Kubernetes Master Node</span></span><br><span class=\"line\"><span class=\"string\">  hosts: kubernetes_master</span></span><br><span class=\"line\"><span class=\"string\">  become: yes</span></span><br><span class=\"line\"><span class=\"string\">  environment: # Ensure KUBECONFIG is set for helm commands run with become</span></span><br><span class=\"line\"><span class=\"string\">    KUBECONFIG: /etc/kubernetes/admin.conf # Use the admin kubeconfig on the master</span></span><br><span class=\"line\"><span class=\"string\">  roles:</span></span><br><span class=\"line\"><span class=\"string\">    - helm_install</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;playbook.yml created.&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Function to create the Helm installation role (with idempotent check)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">create_helm_role</span></span>() &#123;</span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;--- Creating Ansible role for Helm installation ---&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">mkdir</span> -p roles/helm_install/tasks</span><br><span class=\"line\">    <span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOF &gt; roles/helm_install/tasks/main.yml</span></span><br><span class=\"line\"><span class=\"string\">---</span></span><br><span class=\"line\"><span class=\"string\">- name: Check if Helm is installed and get version</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.command: helm version --short</span></span><br><span class=\"line\"><span class=\"string\">  register: helm_version_raw</span></span><br><span class=\"line\"><span class=\"string\">  ignore_errors: yes</span></span><br><span class=\"line\"><span class=\"string\">  changed_when: false</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Set installed Helm version fact</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.set_fact:</span></span><br><span class=\"line\"><span class=\"string\">    installed_helm_version: &quot;&#123;&#123; (helm_version_raw.stdout | default(&#x27;&#x27;) | regex_findall(&#x27;^(v[0-9]+\\\\\\\\.[0-9]+\\\\\\\\.[0-9]+)&#x27;) | first | default(&#x27;&#x27;) | trim) &#125;&#125;&quot;</span></span><br><span class=\"line\"><span class=\"string\">  changed_when: false</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Debug installed Helm version</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.debug:</span></span><br><span class=\"line\"><span class=\"string\">    msg: &quot;Current installed Helm version: &#123;&#123; installed_helm_version | default(&#x27;Not installed&#x27;) &#125;&#125;&quot;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Debug raw Helm version output</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.debug:</span></span><br><span class=\"line\"><span class=\"string\">    msg: &quot;Raw Helm version output: &#123;&#123; helm_version_raw.stdout | default(&#x27;No output&#x27;) &#125;&#125;&quot;</span></span><br><span class=\"line\"><span class=\"string\">  when: helm_version_raw.stdout is defined and helm_version_raw.stdout | length &gt; 0</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Check if Helm binary exists</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.stat:</span></span><br><span class=\"line\"><span class=\"string\">    path: /usr/local/bin/helm</span></span><br><span class=\"line\"><span class=\"string\">  register: helm_binary_stat</span></span><br><span class=\"line\"><span class=\"string\">  when: installed_helm_version == HELM_VERSION</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Download Helm tarball</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.get_url:</span></span><br><span class=\"line\"><span class=\"string\">    url: &quot;https://get.helm.sh/helm-&#123;&#123; HELM_VERSION &#125;&#125;-linux-amd64.tar.gz&quot;</span></span><br><span class=\"line\"><span class=\"string\">    dest: &quot;/tmp/helm-&#123;&#123; HELM_VERSION &#125;&#125;-linux-amd64.tar.gz&quot;</span></span><br><span class=\"line\"><span class=\"string\">    mode: &#x27;0644&#x27;</span></span><br><span class=\"line\"><span class=\"string\">    checksum: &quot;sha256:&#123;&#123; lookup(&#x27;url&#x27;, &#x27;https://get.helm.sh/helm-&#123;&#123; HELM_VERSION &#125;&#125;-linux-amd64.tar.gz.sha256sum&#x27;, wantlist=True)[0].split(&#x27; &#x27;)[0] &#125;&#125;&quot;</span></span><br><span class=\"line\"><span class=\"string\">  register: download_helm_result</span></span><br><span class=\"line\"><span class=\"string\">  until: download_helm_result is success</span></span><br><span class=\"line\"><span class=\"string\">  retries: 5</span></span><br><span class=\"line\"><span class=\"string\">  delay: 5</span></span><br><span class=\"line\"><span class=\"string\">  when: installed_helm_version != HELM_VERSION or not helm_binary_stat.stat.exists</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Create Helm installation directory</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.file:</span></span><br><span class=\"line\"><span class=\"string\">    path: /usr/local/bin</span></span><br><span class=\"line\"><span class=\"string\">    state: directory</span></span><br><span class=\"line\"><span class=\"string\">    mode: &#x27;0755&#x27;</span></span><br><span class=\"line\"><span class=\"string\">  when: installed_helm_version != HELM_VERSION or not helm_binary_stat.stat.exists</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Extract Helm binary</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.unarchive:</span></span><br><span class=\"line\"><span class=\"string\">    src: &quot;/tmp/helm-&#123;&#123; HELM_VERSION &#125;&#125;-linux-amd64.tar.gz&quot;</span></span><br><span class=\"line\"><span class=\"string\">    dest: &quot;/tmp&quot;</span></span><br><span class=\"line\"><span class=\"string\">    remote_src: yes</span></span><br><span class=\"line\"><span class=\"string\">    creates: &quot;/tmp/linux-amd64/helm&quot;</span></span><br><span class=\"line\"><span class=\"string\">  when: installed_helm_version != HELM_VERSION or not helm_binary_stat.stat.exists</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Move Helm binary to /usr/local/bin</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.copy:</span></span><br><span class=\"line\"><span class=\"string\">    src: &quot;/tmp/linux-amd64/helm&quot;</span></span><br><span class=\"line\"><span class=\"string\">    dest: &quot;/usr/local/bin/helm&quot;</span></span><br><span class=\"line\"><span class=\"string\">    mode: &#x27;0755&#x27;</span></span><br><span class=\"line\"><span class=\"string\">    remote_src: yes</span></span><br><span class=\"line\"><span class=\"string\">    owner: root</span></span><br><span class=\"line\"><span class=\"string\">    group: root</span></span><br><span class=\"line\"><span class=\"string\">  when: installed_helm_version != HELM_VERSION or not helm_binary_stat.stat.exists</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Clean up Helm tarball and extracted directory</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.file:</span></span><br><span class=\"line\"><span class=\"string\">    path: &quot;&#123;&#123; item &#125;&#125;&quot;</span></span><br><span class=\"line\"><span class=\"string\">    state: absent</span></span><br><span class=\"line\"><span class=\"string\">  loop:</span></span><br><span class=\"line\"><span class=\"string\">    - &quot;/tmp/helm-&#123;&#123; HELM_VERSION &#125;&#125;-linux-amd64.tar.gz&quot;</span></span><br><span class=\"line\"><span class=\"string\">    - &quot;/tmp/linux-amd64&quot;</span></span><br><span class=\"line\"><span class=\"string\">  when: installed_helm_version != HELM_VERSION or not helm_binary_stat.stat.exists</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Verify Helm installation</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.command: helm version --client</span></span><br><span class=\"line\"><span class=\"string\">  register: helm_version_output</span></span><br><span class=\"line\"><span class=\"string\">  changed_when: false</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Display Helm version</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.debug:</span></span><br><span class=\"line\"><span class=\"string\">    msg: &quot;&#123;&#123; helm_version_output.stdout &#125;&#125;&quot;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Helm installation role created.&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># --- Main execution ---</span></span><br><span class=\"line\">create_project_dir</span><br><span class=\"line\">create_ansible_cfg</span><br><span class=\"line\">create_inventory</span><br><span class=\"line\">create_playbook</span><br><span class=\"line\">create_helm_role</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;--- Ansible setup for Helm installation is complete! ---&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;Navigate to the new project directory:&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;cd <span class=\"variable\">$&#123;PROJECT_DIR&#125;</span>&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;Then, run the Ansible playbook to install only Helm on your master node:&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;ansible-playbook playbook.yml -K&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;After Helm is installed, you can SSH into your master node (kube-node-1) and manage Cilium Enterprise installation directly using Helm.&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;Remember to use the correct Cilium chart version and your custom values file.&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;Example steps for manual Cilium installation via Helm:&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;ssh ubuntu@<span class=\"variable\">$&#123;MASTER_NODE_IP&#125;</span>&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;sudo helm repo add cilium https://helm.cilium.io/&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;sudo helm repo add isovalent https://helm.isovalent.com&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;sudo helm repo update&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;sudo helm install cilium isovalent/cilium --version 1.17.6 --namespace kube-system -f &lt;path_to_your_cilium_values_file.yaml&gt; --wait&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;Example content for /tmp/cilium-enterprise-values.yaml:&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;hubble:&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;  enabled: true&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;  relay:&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;    enabled: true&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;  ui:&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;    enabled: false&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;kubeProxyReplacement: strict&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;ipam:&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;  mode: kubernetes&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;ipv4NativeRoutingCIDR: 10.244.0.0/16&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;k8s:&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;  requireIPv4PodCIDR: true&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;routingMode: native&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;autoDirectNodeRoutes: false&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;bgpControlPlane:&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;  enabled: true&quot;</span></span><br></pre></td></tr></table></figure>\n\n<p>执行效果如下：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ois@ois:~/data/k8s$ ./ansible-helm.sh </span><br><span class=\"line\">--- Creating project directory: ansible-helm ---</span><br><span class=\"line\">Created new directory: ansible-helm</span><br><span class=\"line\">Changed to directory: /home/ois/data/k8s/ansible-helm</span><br><span class=\"line\">--- Creating ansible.cfg ---</span><br><span class=\"line\">ansible.cfg created.</span><br><span class=\"line\">--- Creating inventory.ini ---</span><br><span class=\"line\">inventory.ini created.</span><br><span class=\"line\">--- Creating playbook.yml ---</span><br><span class=\"line\">playbook.yml created.</span><br><span class=\"line\">--- Creating Ansible role <span class=\"keyword\">for</span> Helm installation ---</span><br><span class=\"line\">Helm installation role created.</span><br><span class=\"line\"></span><br><span class=\"line\">--- Ansible setup <span class=\"keyword\">for</span> Helm installation is complete! ---</span><br><span class=\"line\">Navigate to the new project directory:</span><br><span class=\"line\"><span class=\"built_in\">cd</span> ansible-helm</span><br><span class=\"line\"></span><br><span class=\"line\">Then, run the Ansible playbook to install only Helm on your master node:</span><br><span class=\"line\">ansible-playbook playbook.yml -K</span><br><span class=\"line\"></span><br><span class=\"line\">After Helm is installed, you can SSH into your master node (kube-node-1) and manage Cilium Enterprise installation directly using Helm.</span><br><span class=\"line\">Remember to use the correct Cilium chart version and your custom values file.</span><br><span class=\"line\">Example steps <span class=\"keyword\">for</span> manual Cilium installation via Helm:</span><br><span class=\"line\">ssh ubuntu@10.75.59.71</span><br><span class=\"line\"><span class=\"built_in\">sudo</span> helm repo add cilium https://helm.cilium.io/</span><br><span class=\"line\"><span class=\"built_in\">sudo</span> helm repo add isovalent https://helm.isovalent.com</span><br><span class=\"line\"><span class=\"built_in\">sudo</span> helm repo update</span><br><span class=\"line\"><span class=\"built_in\">sudo</span> helm install cilium isovalent/cilium --version 1.17.6 --namespace kube-system -f &lt;path_to_your_cilium_values_file.yaml&gt; --<span class=\"built_in\">wait</span></span><br><span class=\"line\">Example content <span class=\"keyword\">for</span> /tmp/cilium-enterprise-values.yaml:</span><br><span class=\"line\">hubble:</span><br><span class=\"line\">  enabled: <span class=\"literal\">true</span></span><br><span class=\"line\">  relay:</span><br><span class=\"line\">    enabled: <span class=\"literal\">true</span></span><br><span class=\"line\">  ui:</span><br><span class=\"line\">    enabled: <span class=\"literal\">false</span></span><br><span class=\"line\">kubeProxyReplacement: strict</span><br><span class=\"line\">ipam:</span><br><span class=\"line\">  mode: kubernetes</span><br><span class=\"line\">ipv4NativeRoutingCIDR: 172.16.0.0/20</span><br><span class=\"line\">k8s:</span><br><span class=\"line\">  requireIPv4PodCIDR: <span class=\"literal\">true</span></span><br><span class=\"line\">routingMode: native</span><br><span class=\"line\">autoDirectNodeRoutes: <span class=\"literal\">false</span></span><br><span class=\"line\">bgpControlPlane:</span><br><span class=\"line\">  enabled: <span class=\"literal\">true</span></span><br><span class=\"line\">ois@ois:~/data/k8s$ <span class=\"built_in\">cd</span> ansible-helm</span><br><span class=\"line\">ois@ois:~/data/k8s/ansible-helm$ ansible-playbook playbook.yml -K</span><br><span class=\"line\">BECOME password: </span><br><span class=\"line\"></span><br><span class=\"line\">PLAY [Install Helm on Kubernetes Master Node] ******************************************************************************************************************************************************************************************************************</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Gathering Facts] *****************************************************************************************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [kube-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [helm_install : Check <span class=\"keyword\">if</span> Helm is installed and get version] ***********************************************************************************************************************************************************************************************</span><br><span class=\"line\">fatal: [kube-node-1]: FAILED! =&gt; &#123;<span class=\"string\">&quot;changed&quot;</span>: <span class=\"literal\">false</span>, <span class=\"string\">&quot;cmd&quot;</span>: <span class=\"string\">&quot;helm version --short&quot;</span>, <span class=\"string\">&quot;msg&quot;</span>: <span class=\"string\">&quot;[Errno 2] No such file or directory: b&#x27;helm&#x27;&quot;</span>, <span class=\"string\">&quot;rc&quot;</span>: 2, <span class=\"string\">&quot;stderr&quot;</span>: <span class=\"string\">&quot;&quot;</span>, <span class=\"string\">&quot;stderr_lines&quot;</span>: [], <span class=\"string\">&quot;stdout&quot;</span>: <span class=\"string\">&quot;&quot;</span>, <span class=\"string\">&quot;stdout_lines&quot;</span>: []&#125;</span><br><span class=\"line\">...ignoring</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [helm_install : Set installed Helm version fact] **********************************************************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [kube-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [helm_install : Debug installed Helm version] *************************************************************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [kube-node-1] =&gt; &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;msg&quot;</span>: <span class=\"string\">&quot;Current installed Helm version: &quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [helm_install : Debug raw Helm version output] ************************************************************************************************************************************************************************************************************</span><br><span class=\"line\">skipping: [kube-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [helm_install : Check <span class=\"keyword\">if</span> Helm binary exists] **************************************************************************************************************************************************************************************************************</span><br><span class=\"line\">skipping: [kube-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [helm_install : Download Helm tarball] ********************************************************************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [kube-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [helm_install : Create Helm installation directory] *******************************************************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [kube-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [helm_install : Extract Helm binary] **********************************************************************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [kube-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [helm_install : Move Helm binary to /usr/local/bin] *******************************************************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [kube-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [helm_install : Clean up Helm tarball and extracted directory] ********************************************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [kube-node-1] =&gt; (item=/tmp/helm-v3.18.4-linux-amd64.tar.gz)</span><br><span class=\"line\">changed: [kube-node-1] =&gt; (item=/tmp/linux-amd64)</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [helm_install : Verify Helm installation] *****************************************************************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [kube-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [helm_install : Display Helm version] *********************************************************************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [kube-node-1] =&gt; &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;msg&quot;</span>: <span class=\"string\">&quot;version.BuildInfo&#123;Version:\\&quot;v3.18.4\\&quot;, GitCommit:\\&quot;d80839cf37d860c8aa9a0503fe463278f26cd5e2\\&quot;, GitTreeState:\\&quot;clean\\&quot;, GoVersion:\\&quot;go1.24.4\\&quot;&#125;&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY RECAP *****************************************************************************************************************************************************************************************************************************************************</span><br><span class=\"line\">kube-node-1                : ok=11   changed=4    unreachable=0    failed=0    skipped=2    rescued=0    ignored=1   </span><br></pre></td></tr></table></figure>\n\n<h2 id=\"4-3-使用Helm安装Cilium\"><a href=\"#4-3-使用Helm安装Cilium\" class=\"headerlink\" title=\"4.3 使用Helm安装Cilium\"></a>4.3 使用Helm安装Cilium</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">root@kube-node-1:~# helm repo add cilium https://helm.cilium.io/</span><br><span class=\"line\"><span class=\"string\">&quot;cilium&quot;</span> has been added to your repositories</span><br><span class=\"line\">root@kube-node-1:~# helm repo add isovalent https://helm.isovalent.com</span><br><span class=\"line\"><span class=\"string\">&quot;isovalent&quot;</span> has been added to your repositories</span><br><span class=\"line\">root@kube-node-1:~# </span><br><span class=\"line\"></span><br><span class=\"line\">准备配置文件如下：</span><br><span class=\"line\"></span><br><span class=\"line\">root@kube-node-1:~# <span class=\"built_in\">cat</span> &gt; cilium-enterprise-values.yaml &lt;&lt;<span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">hubble:</span></span><br><span class=\"line\"><span class=\"string\">  enabled: true</span></span><br><span class=\"line\"><span class=\"string\">  relay:</span></span><br><span class=\"line\"><span class=\"string\">    enabled: true</span></span><br><span class=\"line\"><span class=\"string\">  ui:</span></span><br><span class=\"line\"><span class=\"string\">    enabled: false</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\"># Enable Gateway API</span></span><br><span class=\"line\"><span class=\"string\">#gatewayAPI:</span></span><br><span class=\"line\"><span class=\"string\">#  enabled: true</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\"># Explicitly disable Egress Gateway</span></span><br><span class=\"line\"><span class=\"string\">#egressGateway:</span></span><br><span class=\"line\"><span class=\"string\">#  enabled: false</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\"># BGP native-routing configuration</span></span><br><span class=\"line\"><span class=\"string\">ipam:</span></span><br><span class=\"line\"><span class=\"string\">  mode: kubernetes</span></span><br><span class=\"line\"><span class=\"string\">ipv4NativeRoutingCIDR: 172.16.0.0/20 # Advertises all pod CIDRs; ensure BGP router supports this</span></span><br><span class=\"line\"><span class=\"string\">k8s:</span></span><br><span class=\"line\"><span class=\"string\">  requireIPv4PodCIDR: true</span></span><br><span class=\"line\"><span class=\"string\">routingMode: native</span></span><br><span class=\"line\"><span class=\"string\">autoDirectNodeRoutes: true</span></span><br><span class=\"line\"><span class=\"string\">bgpControlPlane:</span></span><br><span class=\"line\"><span class=\"string\">  enabled: true</span></span><br><span class=\"line\"><span class=\"string\">  # Configure BGP peers (replace with your BGP router details)</span></span><br><span class=\"line\"><span class=\"string\">  announce:</span></span><br><span class=\"line\"><span class=\"string\">    podCIDR: true # Advertise pod CIDRs to BGP peers</span></span><br><span class=\"line\"><span class=\"string\">enableIPv4Masquerade: true</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\"># Enable kube-proxy replacement</span></span><br><span class=\"line\"><span class=\"string\">kubeProxyReplacement: true</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">bpf:</span></span><br><span class=\"line\"><span class=\"string\">  masquerade: true</span></span><br><span class=\"line\"><span class=\"string\">  lb:</span></span><br><span class=\"line\"><span class=\"string\">    externalClusterIP: true</span></span><br><span class=\"line\"><span class=\"string\">    sock: true</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\">root@kube-node-1:~# helm install cilium isovalent/cilium --version 1.17.6 \\</span><br><span class=\"line\">    --namespace kube-system \\</span><br><span class=\"line\">    --<span class=\"built_in\">set</span> kubeProxyReplacement=<span class=\"literal\">true</span> \\</span><br><span class=\"line\">    --<span class=\"built_in\">set</span> k8sServiceHost=10.75.59.71 \\</span><br><span class=\"line\">    --<span class=\"built_in\">set</span> k8sServicePort=6443 \\</span><br><span class=\"line\">    -f cilium-enterprise-values.yaml</span><br><span class=\"line\">NAME: cilium</span><br><span class=\"line\">LAST DEPLOYED: Fri Aug  1 09:54:27 2025</span><br><span class=\"line\">NAMESPACE: kube-system</span><br><span class=\"line\">STATUS: deployed</span><br><span class=\"line\">REVISION: 1</span><br><span class=\"line\">TEST SUITE: None</span><br><span class=\"line\">NOTES:</span><br><span class=\"line\">You have successfully installed Cilium with Hubble Relay.</span><br><span class=\"line\"></span><br><span class=\"line\">Your release version is 1.17.6.</span><br><span class=\"line\"></span><br><span class=\"line\">For any further <span class=\"built_in\">help</span>, visit https://docs.isovalent.com/v1.17</span><br><span class=\"line\"></span><br><span class=\"line\">上述命令中的参数k8sServiceHost=10.75.59.71 和 k8sServicePort=6443 是不能少的。</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">在其他Node上执行kubeadm <span class=\"built_in\">join</span></span><br><span class=\"line\"></span><br><span class=\"line\">ubuntu@kube-node-2:~$ <span class=\"built_in\">sudo</span> su</span><br><span class=\"line\">[<span class=\"built_in\">sudo</span>] password <span class=\"keyword\">for</span> ubuntu: </span><br><span class=\"line\">root@kube-node-2:/home/ubuntu# <span class=\"built_in\">cd</span></span><br><span class=\"line\">root@kube-node-2:~# kubeadm <span class=\"built_in\">join</span> kube-node-1:6443 --token wnc2sl.st6g6c4o0cd42bi4 \\</span><br><span class=\"line\">        --discovery-token-ca-cert-hash sha256:381868d3e0faab6dbd3e240d8f40e0e81ab46cb54b2f15ffbfe0f587fac5d982 </span><br><span class=\"line\">[preflight] Running pre-flight checks</span><br><span class=\"line\">[preflight] Reading configuration from the <span class=\"string\">&quot;kubeadm-config&quot;</span> ConfigMap <span class=\"keyword\">in</span> namespace <span class=\"string\">&quot;kube-system&quot;</span>...</span><br><span class=\"line\">[preflight] Use <span class=\"string\">&#x27;kubeadm init phase upload-config --config your-config-file&#x27;</span> to re-upload it.</span><br><span class=\"line\">W0801 09:56:27.830756   47851 configset.go:78] Warning: No kubeproxy.config.k8s.io/v1alpha1 config is loaded. Continuing without it: configmaps <span class=\"string\">&quot;kube-proxy&quot;</span> is forbidden: User <span class=\"string\">&quot;system:bootstrap:wnc2sl&quot;</span> cannot get resource <span class=\"string\">&quot;configmaps&quot;</span> <span class=\"keyword\">in</span> API group <span class=\"string\">&quot;&quot;</span> <span class=\"keyword\">in</span> the namespace <span class=\"string\">&quot;kube-system&quot;</span></span><br><span class=\"line\">[kubelet-start] Writing kubelet configuration to file <span class=\"string\">&quot;/var/lib/kubelet/config.yaml&quot;</span></span><br><span class=\"line\">[kubelet-start] Writing kubelet environment file with flags to file <span class=\"string\">&quot;/var/lib/kubelet/kubeadm-flags.env&quot;</span></span><br><span class=\"line\">[kubelet-start] Starting the kubelet</span><br><span class=\"line\">[kubelet-check] Waiting <span class=\"keyword\">for</span> a healthy kubelet at http://127.0.0.1:10248/healthz. This can take up to 4m0s</span><br><span class=\"line\">[kubelet-check] The kubelet is healthy after 1.503396779s</span><br><span class=\"line\">[kubelet-start] Waiting <span class=\"keyword\">for</span> the kubelet to perform the TLS Bootstrap</span><br><span class=\"line\"></span><br><span class=\"line\">This node has joined the cluster:</span><br><span class=\"line\">* Certificate signing request was sent to apiserver and a response was received.</span><br><span class=\"line\">* The Kubelet was informed of the new secure connection details.</span><br><span class=\"line\"></span><br><span class=\"line\">Run <span class=\"string\">&#x27;kubectl get nodes&#x27;</span> on the control-plane to see this node <span class=\"built_in\">join</span> the cluster.</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>等待一段时间，Cilium、Hubble Relay即可Ready</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@kube-node-1:~# kubectl get pods -n kube-system -o wide</span><br><span class=\"line\">NAME                                  READY   STATUS    RESTARTS   AGE     IP            NODE          NOMINATED NODE   READINESS GATES</span><br><span class=\"line\">cilium-2vrgj                          1/1     Running   0          3m58s   10.75.59.73   kube-node-3   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">cilium-65kvc                          1/1     Running   0          4m14s   10.75.59.72   kube-node-2   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">cilium-envoy-24sd7                    1/1     Running   0          4m14s   10.75.59.72   kube-node-2   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">cilium-envoy-7pr4g                    1/1     Running   0          6m12s   10.75.59.71   kube-node-1   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">cilium-envoy-k86tp                    1/1     Running   0          3m58s   10.75.59.73   kube-node-3   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">cilium-operator-867fb7f659-2vnld      1/1     Running   0          6m12s   10.75.59.72   kube-node-2   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">cilium-operator-867fb7f659-5998x      1/1     Running   0          6m12s   10.75.59.71   kube-node-1   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">cilium-x4pr7                          1/1     Running   0          6m12s   10.75.59.71   kube-node-1   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">coredns-674b8bbfcf-6t8np              1/1     Running   0          13m     172.16.1.40   kube-node-2   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">coredns-674b8bbfcf-bx8xd              1/1     Running   0          13m     172.16.1.64   kube-node-2   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">etcd-kube-node-1                      1/1     Running   1          13m     10.75.59.71   kube-node-1   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">hubble-relay-cfb755899-gch8w          1/1     Running   0          6m12s   172.16.1.81   kube-node-2   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">kube-apiserver-kube-node-1            1/1     Running   1          13m     10.75.59.71   kube-node-1   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">kube-controller-manager-kube-node-1   1/1     Running   1          13m     10.75.59.71   kube-node-1   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">kube-scheduler-kube-node-1            1/1     Running   1          13m     10.75.59.71   kube-node-1   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"4-4-安装企业版Cilium-cli\"><a href=\"#4-4-安装企业版Cilium-cli\" class=\"headerlink\" title=\"4.4 安装企业版Cilium-cli\"></a>4.4 安装企业版Cilium-cli</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -L --remote-name-all https://github.com/isovalent/cilium-cli-releases/releases/latest/download/cilium-linux-amd64.tar.gz&#123;,.<span class=\"built_in\">sha256sum</span>&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">sha256sum</span> --check cilium-linux-amd64.tar.gz.sha256sum</span><br><span class=\"line\"></span><br><span class=\"line\">tar xzvfC cilium-linux-amd64.tar.gz /usr/local/bin</span><br><span class=\"line\"></span><br><span class=\"line\">root@kube-node-1:~# cilium status</span><br><span class=\"line\">    /¯¯\\</span><br><span class=\"line\"> /¯¯\\__/¯¯\\    Cilium:             OK</span><br><span class=\"line\"> \\__/¯¯\\__/    Operator:           OK</span><br><span class=\"line\"> /¯¯\\__/¯¯\\    Envoy DaemonSet:    OK</span><br><span class=\"line\"> \\__/¯¯\\__/    Hubble Relay:       OK</span><br><span class=\"line\">    \\__/       ClusterMesh:        disabled</span><br><span class=\"line\"></span><br><span class=\"line\">DaemonSet              cilium                   Desired: 3, Ready: 3/3, Available: 3/3</span><br><span class=\"line\">DaemonSet              cilium-envoy             Desired: 3, Ready: 3/3, Available: 3/3</span><br><span class=\"line\">Deployment             cilium-operator          Desired: 2, Ready: 2/2, Available: 2/2</span><br><span class=\"line\">Deployment             hubble-relay             Desired: 1, Ready: 1/1, Available: 1/1</span><br><span class=\"line\">Containers:            cilium                   Running: 3</span><br><span class=\"line\">                       cilium-envoy             Running: 3</span><br><span class=\"line\">                       cilium-operator          Running: 2</span><br><span class=\"line\">                       clustermesh-apiserver    </span><br><span class=\"line\">                       hubble-relay             Running: 1</span><br><span class=\"line\">Cluster Pods:          3/3 managed by Cilium</span><br><span class=\"line\">Helm chart version:    1.17.6</span><br><span class=\"line\">Image versions         cilium             quay.io/isovalent/cilium:v1.17.6-cee.1@sha256:2d01daf4f25f7d644889b49ca856e1a4269981fc963e50bd3962665b41b6adb3: 3</span><br><span class=\"line\">                       cilium-envoy       quay.io/isovalent/cilium-envoy:v1.17.6-cee.1@sha256:318eff387835ca2717baab42a84f35a83a5f9e7d519253df87269f80b9ff0171: 3</span><br><span class=\"line\">                       cilium-operator    quay.io/isovalent/operator-generic:v1.17.6-cee.1@sha256:2e602710a7c4f101831df679e5d8251bae8bf0f9fe26c20bbef87f1966ea8265: 2</span><br><span class=\"line\">                       hubble-relay       quay.io/isovalent/hubble-relay:v1.17.6-cee.1@sha256:d378e3607f7492374e65e2bd854cc0ec87480c63ba49a96dadcd75a6946b586e: 1</span><br><span class=\"line\">root@kube-node-1:~# </span><br></pre></td></tr></table></figure>\n\n<h2 id=\"4-5-设置Cilium-BGP\"><a href=\"#4-5-设置Cilium-BGP\" class=\"headerlink\" title=\"4.5 设置Cilium BGP\"></a>4.5 设置Cilium BGP</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@kube-node-1:~#<span class=\"built_in\">cat</span> &gt; cilium-bgp.yaml &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">--- #bgp的对外宣告策略，宣告POD和serviceip</span></span><br><span class=\"line\"><span class=\"string\">apiVersion: cilium.io/v2alpha1</span></span><br><span class=\"line\"><span class=\"string\">kind: CiliumBGPAdvertisement</span></span><br><span class=\"line\"><span class=\"string\">metadata:</span></span><br><span class=\"line\"><span class=\"string\">  name: bgp-advertisements</span></span><br><span class=\"line\"><span class=\"string\">  labels:</span></span><br><span class=\"line\"><span class=\"string\">    advertise: bgp</span></span><br><span class=\"line\"><span class=\"string\">spec:</span></span><br><span class=\"line\"><span class=\"string\">  advertisements:</span></span><br><span class=\"line\"><span class=\"string\">    - advertisementType: &quot;PodCIDR&quot;              # Only for Kubernetes or ClusterPool IPAM cluster-pool</span></span><br><span class=\"line\"><span class=\"string\">    - advertisementType: &quot;Service&quot;</span></span><br><span class=\"line\"><span class=\"string\">      service:</span></span><br><span class=\"line\"><span class=\"string\">        addresses:</span></span><br><span class=\"line\"><span class=\"string\">          - ClusterIP</span></span><br><span class=\"line\"><span class=\"string\">          - ExternalIP</span></span><br><span class=\"line\"><span class=\"string\">          #- LoadBalancerIP</span></span><br><span class=\"line\"><span class=\"string\">      selector:</span></span><br><span class=\"line\"><span class=\"string\">        matchExpressions:</span></span><br><span class=\"line\"><span class=\"string\">        - &#123;key: somekey, operator: NotIn, values: [&#x27;never-used-value&#x27;]&#125;                  # 等同于宣告所有</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">--- #bgp邻居组的配置，类似template peer ,里面调用相关的advertisement策略</span></span><br><span class=\"line\"><span class=\"string\">apiVersion: cilium.io/v2alpha1</span></span><br><span class=\"line\"><span class=\"string\">kind: CiliumBGPPeerConfig</span></span><br><span class=\"line\"><span class=\"string\">metadata:</span></span><br><span class=\"line\"><span class=\"string\">  name: cilium-peer</span></span><br><span class=\"line\"><span class=\"string\">spec:</span></span><br><span class=\"line\"><span class=\"string\">  timers:</span></span><br><span class=\"line\"><span class=\"string\">    holdTimeSeconds: 30             #default 90s</span></span><br><span class=\"line\"><span class=\"string\">    keepAliveTimeSeconds: 10  #default 30s</span></span><br><span class=\"line\"><span class=\"string\">    connectRetryTimeSeconds: 40  #default 120s</span></span><br><span class=\"line\"><span class=\"string\">  gracefulRestart:</span></span><br><span class=\"line\"><span class=\"string\">    enabled: true</span></span><br><span class=\"line\"><span class=\"string\">    restartTimeSeconds: 120        #default 120s</span></span><br><span class=\"line\"><span class=\"string\">  #transport:</span></span><br><span class=\"line\"><span class=\"string\">  #  peerPort: 179</span></span><br><span class=\"line\"><span class=\"string\">  families:</span></span><br><span class=\"line\"><span class=\"string\">    - afi: ipv4</span></span><br><span class=\"line\"><span class=\"string\">      safi: unicast</span></span><br><span class=\"line\"><span class=\"string\">      advertisements:</span></span><br><span class=\"line\"><span class=\"string\">        matchLabels:</span></span><br><span class=\"line\"><span class=\"string\">          advertise: &quot;bgp&quot;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">--- #bgp的邻居配置</span></span><br><span class=\"line\"><span class=\"string\">apiVersion: cilium.io/v2alpha1</span></span><br><span class=\"line\"><span class=\"string\">kind: CiliumBGPClusterConfig</span></span><br><span class=\"line\"><span class=\"string\">metadata:</span></span><br><span class=\"line\"><span class=\"string\">  name: cilium-bgp-default</span></span><br><span class=\"line\"><span class=\"string\">spec:</span></span><br><span class=\"line\"><span class=\"string\">  bgpInstances:</span></span><br><span class=\"line\"><span class=\"string\">  - name: &quot;instance-65000&quot;</span></span><br><span class=\"line\"><span class=\"string\">    localASN: 65000</span></span><br><span class=\"line\"><span class=\"string\">    peers:</span></span><br><span class=\"line\"><span class=\"string\">    - name: &quot;GoBGP&quot;</span></span><br><span class=\"line\"><span class=\"string\">      peerASN: 65000</span></span><br><span class=\"line\"><span class=\"string\">      peerAddress: 10.75.59.76</span></span><br><span class=\"line\"><span class=\"string\">      peerConfigRef:</span></span><br><span class=\"line\"><span class=\"string\">        name: &quot;cilium-peer&quot;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\">root@kube-node-1:~# </span><br><span class=\"line\">root@kube-node-1:~# </span><br><span class=\"line\">root@kube-node-1:~# kubectl apply -f cilium-bgp.yaml </span><br><span class=\"line\">ciliumbgpadvertisement.cilium.io/bgp-advertisements created</span><br><span class=\"line\">ciliumbgppeerconfig.cilium.io/cilium-peer created</span><br><span class=\"line\">ciliumbgpclusterconfig.cilium.io/cilium-bgp-default created</span><br><span class=\"line\">root@kube-node-1:~# cilium bgp peers</span><br><span class=\"line\">Node          Local AS   Peer AS   Peer Address   Session State   Uptime   Family         Received   Advertised</span><br><span class=\"line\">kube-node-1   65000      65000     10.75.59.76    established     7s       ipv4/unicast   2          6    </span><br><span class=\"line\">kube-node-2   65000      65000     10.75.59.76    established     6s       ipv4/unicast   2          6    </span><br><span class=\"line\">kube-node-3   65000      65000     10.75.59.76    established     6s       ipv4/unicast   2          6    </span><br><span class=\"line\">root@kube-node-1:~# cilium bgp routes</span><br><span class=\"line\">(Defaulting to `available ipv4 unicast` routes, please see <span class=\"built_in\">help</span> <span class=\"keyword\">for</span> more options)</span><br><span class=\"line\"></span><br><span class=\"line\">Node          VRouter   Prefix             NextHop   Age   Attrs</span><br><span class=\"line\">kube-node-1   65000     172.16.0.0/24      0.0.0.0   12s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class=\"line\">              65000     172.16.32.1/32     0.0.0.0   12s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class=\"line\">              65000     172.16.32.10/32    0.0.0.0   12s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class=\"line\">              65000     172.16.37.239/32   0.0.0.0   12s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class=\"line\">              65000     172.16.43.10/32    0.0.0.0   12s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class=\"line\">kube-node-2   65000     172.16.1.0/24      0.0.0.0   12s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class=\"line\">              65000     172.16.32.1/32     0.0.0.0   12s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class=\"line\">              65000     172.16.32.10/32    0.0.0.0   12s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class=\"line\">              65000     172.16.37.239/32   0.0.0.0   12s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class=\"line\">              65000     172.16.43.10/32    0.0.0.0   12s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class=\"line\">kube-node-3   65000     172.16.3.0/24      0.0.0.0   12s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class=\"line\">              65000     172.16.32.1/32     0.0.0.0   12s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class=\"line\">              65000     172.16.32.10/32    0.0.0.0   12s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class=\"line\">              65000     172.16.37.239/32   0.0.0.0   12s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class=\"line\">              65000     172.16.43.10/32    0.0.0.0   12s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class=\"line\">root@kube-node-1:~# </span><br></pre></td></tr></table></figure>\n\n<h2 id=\"4-6-安装Hubble-UI\"><a href=\"#4-6-安装Hubble-UI\" class=\"headerlink\" title=\"4.6 安装Hubble UI\"></a>4.6 安装Hubble UI</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@kube-node-1:~# helm search repo isovalent/hubble-ui -l</span><br><span class=\"line\">NAME                    CHART VERSION   APP VERSION     DESCRIPTION         </span><br><span class=\"line\">isovalent/hubble-ui     1.3.6           1.3.6           Hubble UI Enterprise</span><br><span class=\"line\">isovalent/hubble-ui     1.3.5           1.3.5           Hubble UI Enterprise</span><br><span class=\"line\"></span><br><span class=\"line\">root@kube-node-1:~# <span class=\"built_in\">cat</span> &gt; hubble-ui-values.yaml &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">relay:</span></span><br><span class=\"line\"><span class=\"string\">  address: &quot;hubble-relay.kube-system.svc.cluster.local&quot;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\">root@kube-node-1:~#  </span><br><span class=\"line\">root@kube-node-1:~# helm install hubble-ui isovalent/hubble-ui --version 1.3.6 --namespace kube-system --values hubble-ui-values.yaml --<span class=\"built_in\">wait</span></span><br><span class=\"line\">NAME: hubble-ui</span><br><span class=\"line\">LAST DEPLOYED: Fri Aug  1 10:47:58 2025</span><br><span class=\"line\">NAMESPACE: kube-system</span><br><span class=\"line\">STATUS: deployed</span><br><span class=\"line\">REVISION: 1</span><br><span class=\"line\">TEST SUITE: None</span><br><span class=\"line\">NOTES:</span><br><span class=\"line\">You have successfully installed Hubble-Ui.</span><br><span class=\"line\">Your release version is 1.3.6.</span><br><span class=\"line\"></span><br><span class=\"line\">For any further <span class=\"built_in\">help</span>, visit https://docs.isovalent.com</span><br><span class=\"line\">root@kube-node-1:~# kubectl patch service hubble-ui -n kube-system -p <span class=\"string\">&#x27;&#123;&quot;spec&quot;: &#123;&quot;type&quot;: &quot;NodePort&quot;&#125;&#125;&#x27;</span></span><br><span class=\"line\">service/hubble-ui patched</span><br><span class=\"line\">root@kube-node-1:~# kubectl get svc -n kube-system -o wide                                                                  </span><br><span class=\"line\">NAME           TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                  AGE   SELECTOR</span><br><span class=\"line\">cilium-envoy   ClusterIP   None            &lt;none&gt;        9964/TCP                 54m   k8s-app=cilium-envoy</span><br><span class=\"line\">hubble-peer    ClusterIP   172.16.43.10    &lt;none&gt;        443/TCP                  54m   k8s-app=cilium</span><br><span class=\"line\">hubble-relay   NodePort    172.16.37.239   &lt;none&gt;        80:31234/TCP             54m   k8s-app=hubble-relay</span><br><span class=\"line\">hubble-ui      NodePort    172.16.35.177   &lt;none&gt;        80:31225/TCP             64s   k8s-app=hubble-ui</span><br><span class=\"line\">kube-dns       ClusterIP   172.16.32.10    &lt;none&gt;        53/UDP,53/TCP,9153/TCP   61m   k8s-app=kube-dns</span><br><span class=\"line\">root@kube-node-1:~# kubectl -n kube-system <span class=\"built_in\">exec</span> ds/cilium -- cilium service list</span><br><span class=\"line\">Defaulted container <span class=\"string\">&quot;cilium-agent&quot;</span> out of: cilium-agent, config (init), mount-cgroup (init), apply-sysctl-overwrites (init), mount-bpf-fs (init), clean-cilium-state (init), install-cni-binaries (init)</span><br><span class=\"line\">ID   Frontend                Service Type   Backend                               </span><br><span class=\"line\">1    172.16.32.1:443/TCP     ClusterIP      1 =&gt; 10.75.59.71:6443/TCP (active)    </span><br><span class=\"line\">2    172.16.43.10:443/TCP    ClusterIP      1 =&gt; 10.75.59.71:4244/TCP (active)    </span><br><span class=\"line\">3    172.16.37.239:80/TCP    ClusterIP      1 =&gt; 172.16.1.81:4245/TCP (active)    </span><br><span class=\"line\">4    10.75.59.71:31234/TCP   NodePort       1 =&gt; 172.16.1.81:4245/TCP (active)    </span><br><span class=\"line\">5    0.0.0.0:31234/TCP       NodePort       1 =&gt; 172.16.1.81:4245/TCP (active)    </span><br><span class=\"line\">6    172.16.32.10:53/TCP     ClusterIP      1 =&gt; 172.16.1.64:53/TCP (active)      </span><br><span class=\"line\">                                            2 =&gt; 172.16.1.40:53/TCP (active)      </span><br><span class=\"line\">7    172.16.32.10:9153/TCP   ClusterIP      1 =&gt; 172.16.1.64:9153/TCP (active)    </span><br><span class=\"line\">                                            2 =&gt; 172.16.1.40:9153/TCP (active)    </span><br><span class=\"line\">8    172.16.32.10:53/UDP     ClusterIP      1 =&gt; 172.16.1.64:53/UDP (active)      </span><br><span class=\"line\">                                            2 =&gt; 172.16.1.40:53/UDP (active)      </span><br><span class=\"line\">9    172.16.35.177:80/TCP    ClusterIP      1 =&gt; 172.16.3.127:8081/TCP (active)   </span><br><span class=\"line\">10   10.75.59.71:31225/TCP   NodePort       1 =&gt; 172.16.3.127:8081/TCP (active)   </span><br><span class=\"line\">11   0.0.0.0:31225/TCP       NodePort       1 =&gt; 172.16.3.127:8081/TCP (active)  </span><br><span class=\"line\"></span><br><span class=\"line\">浏览器可以通过http://10.75.59.71:31225/ 访问Hubble-ui</span><br><span class=\"line\"></span><br><span class=\"line\">root@dns-server-vm:~# curl http://10.75.59.71:31225/</span><br><span class=\"line\">&lt;!doctype html&gt;&lt;html&gt;&lt;<span class=\"built_in\">head</span>&gt;&lt;meta charset=<span class=\"string\">&quot;utf-8&quot;</span>/&gt;&lt;title&gt;Hubble UI Enterprise&lt;/title&gt;&lt;meta http-equiv=<span class=\"string\">&quot;X-UA-Compatible&quot;</span> content=<span class=\"string\">&quot;IE=edge&quot;</span>/&gt;&lt;meta name=<span class=\"string\">&quot;viewport&quot;</span> content=<span class=\"string\">&quot;width=device-width,user-scalable=0,initial-scale=1,minimum-scale=1,maximum-scale=1&quot;</span>/&gt;&lt;<span class=\"built_in\">link</span> rel=<span class=\"string\">&quot;icon&quot;</span> <span class=\"built_in\">type</span>=<span class=\"string\">&quot;image/png&quot;</span> sizes=<span class=\"string\">&quot;32x32&quot;</span> href=<span class=\"string\">&quot;/favicon-32x32.png&quot;</span>/&gt;&lt;<span class=\"built_in\">link</span> rel=<span class=\"string\">&quot;icon&quot;</span> <span class=\"built_in\">type</span>=<span class=\"string\">&quot;image/png&quot;</span> sizes=<span class=\"string\">&quot;16x16&quot;</span> href=<span class=\"string\">&quot;/favicon-16x16.png&quot;</span>/&gt;&lt;<span class=\"built_in\">link</span> rel=<span class=\"string\">&quot;shortcut icon&quot;</span> href=<span class=\"string\">&quot;/favicon.ico&quot;</span>/&gt;&lt;<span class=\"built_in\">link</span> rel=<span class=\"string\">&quot;stylesheet&quot;</span> href=<span class=\"string\">&quot;/fonts/inter/stylesheet.css&quot;</span>/&gt;&lt;<span class=\"built_in\">link</span> rel=<span class=\"string\">&quot;stylesheet&quot;</span> href=<span class=\"string\">&quot;/fonts/roboto-mono/stylesheet.css&quot;</span>/&gt;&lt;script defer=<span class=\"string\">&quot;defer&quot;</span> src=<span class=\"string\">&quot;/bundle.app.77bec96f333a96efe6ea.js&quot;</span>&gt;&lt;/script&gt;&lt;<span class=\"built_in\">link</span> href=<span class=\"string\">&quot;/bundle.app.f1e6c0c33f1535bc8508.css&quot;</span> rel=<span class=\"string\">&quot;stylesheet&quot;</span>&gt;&lt;script <span class=\"built_in\">type</span>=<span class=\"string\">&quot;text/template&quot;</span> <span class=\"built_in\">id</span>=<span class=\"string\">&quot;hubble-ui/feature-flags&quot;</span>&gt;[10, 0, 18, 0, 26, 0, 34, 0, 42, 0, 50, 0]&lt;/script&gt;&lt;script <span class=\"built_in\">type</span>=<span class=\"string\">&quot;text/template&quot;</span> <span class=\"built_in\">id</span>=<span class=\"string\">&quot;hubble-ui/authorization&quot;</span>&gt;[8, 1, 26, 4, 24, 1, 32, 1]&lt;/script&gt;&lt;/head&gt;&lt;body&gt;&lt;div <span class=\"built_in\">id</span>=<span class=\"string\">&quot;test-process-tree-char&quot;</span> style=<span class=\"string\">&quot;font-family: &#x27;Roboto Mono&#x27;, monospace;</span></span><br><span class=\"line\"><span class=\"string\">        font-size: 16px;</span></span><br><span class=\"line\"><span class=\"string\">        position: absolute;</span></span><br><span class=\"line\"><span class=\"string\">        visibility: hidden;</span></span><br><span class=\"line\"><span class=\"string\">        height: auto;</span></span><br><span class=\"line\"><span class=\"string\">        width: auto;</span></span><br><span class=\"line\"><span class=\"string\">        white-space: nowrap;&quot;</span>&gt;a&lt;/div&gt;&lt;div <span class=\"built_in\">id</span>=<span class=\"string\">&quot;app&quot;</span>&gt;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;root@dns-server-vm:~# </span><br><span class=\"line\">root@dns-server-vm:~# </span><br></pre></td></tr></table></figure>\n\n<h1 id=\"5-部署Star-Wars-App\"><a href=\"#5-部署Star-Wars-App\" class=\"headerlink\" title=\"5. 部署Star Wars App\"></a>5. 部署Star Wars App</h1><h2 id=\"5-1-部署APP\"><a href=\"#5-1-部署APP\" class=\"headerlink\" title=\"5.1 部署APP\"></a>5.1 部署APP</h2><p>Isovalent 提供了一个Demo APP，以下是部署脚本。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@kube-node-1:~# kubectl create namespace star-wars</span><br><span class=\"line\">namespace/star-wars created</span><br><span class=\"line\">root@kube-node-1:~# kubectl apply -n star-wars -f https://raw.githubusercontent.com/cilium/cilium/HEAD/examples/minikube/http-sw-app.yaml</span><br><span class=\"line\">service/deathstar created</span><br><span class=\"line\">deployment.apps/deathstar created</span><br><span class=\"line\">pod/tiefighter created</span><br><span class=\"line\">pod/xwing created</span><br><span class=\"line\">root@kube-node-1:~# kubectl -n star-wars get pod -o wide --show-labels</span><br><span class=\"line\">NAME                         READY   STATUS    RESTARTS   AGE   IP             NODE          NOMINATED NODE   READINESS GATES   LABELS</span><br><span class=\"line\">deathstar-86f85ffb4d-4ldsj   1/1     Running   0          39s   172.16.1.231   kube-node-2   &lt;none&gt;           &lt;none&gt;            app.kubernetes.io/name=deathstar,class=deathstar,org=empire,pod-template-hash=86f85ffb4d</span><br><span class=\"line\">deathstar-86f85ffb4d-dbzft   1/1     Running   0          39s   172.16.3.161   kube-node-3   &lt;none&gt;           &lt;none&gt;            app.kubernetes.io/name=deathstar,class=deathstar,org=empire,pod-template-hash=86f85ffb4d</span><br><span class=\"line\">tiefighter                   1/1     Running   0          39s   172.16.3.247   kube-node-3   &lt;none&gt;           &lt;none&gt;            app.kubernetes.io/name=tiefighter,class=tiefighter,org=empire</span><br><span class=\"line\">xwing                        1/1     Running   0          39s   172.16.3.155   kube-node-3   &lt;none&gt;           &lt;none&gt;            app.kubernetes.io/name=xwing,class=xwing,org=alliance</span><br><span class=\"line\">root@kube-node-1:~# kubectl -n star-wars get service -o wide</span><br><span class=\"line\">NAME        TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE   SELECTOR</span><br><span class=\"line\">deathstar   ClusterIP   172.16.39.138   &lt;none&gt;        80/TCP    82s   class=deathstar,org=empire</span><br><span class=\"line\">root@kube-node-1:~# kubectl -n star-wars patch service deathstar -p <span class=\"string\">&#x27;&#123;&quot;spec&quot;:&#123;&quot;type&quot;:&quot;NodePort&quot;&#125;&#125;&#x27;</span></span><br><span class=\"line\">service/deathstar patched</span><br><span class=\"line\">root@kube-node-1:~# kubectl -n star-wars get service -o wide</span><br><span class=\"line\">NAME        TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE    SELECTOR</span><br><span class=\"line\">deathstar   NodePort   172.16.39.138   &lt;none&gt;        80:32271/TCP   112s   class=deathstar,org=empire</span><br><span class=\"line\">root@kube-node-1:~# kubectl -n kube-system <span class=\"built_in\">exec</span> ds/cilium -- cilium service list</span><br><span class=\"line\">Defaulted container <span class=\"string\">&quot;cilium-agent&quot;</span> out of: cilium-agent, config (init), mount-cgroup (init), apply-sysctl-overwrites (init), mount-bpf-fs (init), clean-cilium-state (init), install-cni-binaries (init)</span><br><span class=\"line\">ID   Frontend                Service Type   Backend                               </span><br><span class=\"line\">1    172.16.32.1:443/TCP     ClusterIP      1 =&gt; 10.75.59.71:6443/TCP (active)    </span><br><span class=\"line\">2    172.16.43.10:443/TCP    ClusterIP      1 =&gt; 10.75.59.71:4244/TCP (active)    </span><br><span class=\"line\">3    172.16.37.239:80/TCP    ClusterIP      1 =&gt; 172.16.1.81:4245/TCP (active)    </span><br><span class=\"line\">4    10.75.59.71:31234/TCP   NodePort       1 =&gt; 172.16.1.81:4245/TCP (active)    </span><br><span class=\"line\">5    0.0.0.0:31234/TCP       NodePort       1 =&gt; 172.16.1.81:4245/TCP (active)    </span><br><span class=\"line\">6    172.16.32.10:53/TCP     ClusterIP      1 =&gt; 172.16.1.64:53/TCP (active)      </span><br><span class=\"line\">                                            2 =&gt; 172.16.1.40:53/TCP (active)      </span><br><span class=\"line\">7    172.16.32.10:9153/TCP   ClusterIP      1 =&gt; 172.16.1.64:9153/TCP (active)    </span><br><span class=\"line\">                                            2 =&gt; 172.16.1.40:9153/TCP (active)    </span><br><span class=\"line\">8    172.16.32.10:53/UDP     ClusterIP      1 =&gt; 172.16.1.64:53/UDP (active)      </span><br><span class=\"line\">                                            2 =&gt; 172.16.1.40:53/UDP (active)      </span><br><span class=\"line\">9    172.16.35.177:80/TCP    ClusterIP      1 =&gt; 172.16.3.127:8081/TCP (active)   </span><br><span class=\"line\">10   10.75.59.71:31225/TCP   NodePort       1 =&gt; 172.16.3.127:8081/TCP (active)   </span><br><span class=\"line\">11   0.0.0.0:31225/TCP       NodePort       1 =&gt; 172.16.3.127:8081/TCP (active)   </span><br><span class=\"line\">12   172.16.39.138:80/TCP    ClusterIP      1 =&gt; 172.16.3.161:80/TCP (active)     </span><br><span class=\"line\">                                            2 =&gt; 172.16.1.231:80/TCP (active)     </span><br><span class=\"line\">13   10.75.59.71:32271/TCP   NodePort       1 =&gt; 172.16.3.161:80/TCP (active)     </span><br><span class=\"line\">                                            2 =&gt; 172.16.1.231:80/TCP (active)     </span><br><span class=\"line\">14   0.0.0.0:32271/TCP       NodePort       1 =&gt; 172.16.3.161:80/TCP (active)     </span><br><span class=\"line\">                                            2 =&gt; 172.16.1.231:80/TCP (active)     </span><br><span class=\"line\">到这里就算部署成功了。</span><br><span class=\"line\"></span><br><span class=\"line\">root@kube-node-1:~# kubectl -n star-wars <span class=\"built_in\">exec</span> tiefighter --   curl -s -XPOST http://deathstar.star-wars.svc.cluster.local/v1/request-landing</span><br><span class=\"line\">Ship landed</span><br><span class=\"line\">root@kube-node-1:~# kubectl -n star-wars <span class=\"built_in\">exec</span> xwing --   curl -s -XPOST http://deathstar.star-wars.svc.cluster.local/v1/request-landing</span><br><span class=\"line\">Ship landed</span><br><span class=\"line\">root@kube-node-1:~# </span><br><span class=\"line\"></span><br><span class=\"line\">在外部的设备也可以通过节点IP访问。</span><br><span class=\"line\"></span><br><span class=\"line\">root@dns-server-vm:~# curl -s -XPOST http://10.75.59.72:32271/v1/request-landing</span><br><span class=\"line\">Ship landed</span><br><span class=\"line\">root@dns-server-vm:~# curl -s -XPOST http://10.75.59.71:32271/v1/request-landing</span><br><span class=\"line\">Ship landed</span><br><span class=\"line\">root@dns-server-vm:~# curl -s -XPOST http://10.75.59.73:32271/v1/request-landing</span><br><span class=\"line\">Ship landed</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"5-2-在Node外部抓包-Pod-to-Pod\"><a href=\"#5-2-在Node外部抓包-Pod-to-Pod\" class=\"headerlink\" title=\"5.2 在Node外部抓包 ( Pod to Pod )\"></a>5.2 在Node外部抓包 ( Pod to Pod )</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">查找虚拟机连接在网桥上的网卡</span><br><span class=\"line\"></span><br><span class=\"line\">root@ois:/home/ois/data/k8s# virsh list</span><br><span class=\"line\"> Id    Name                  State</span><br><span class=\"line\">--------------------------------------</span><br><span class=\"line\"> 4     win1                  running</span><br><span class=\"line\"> 17    r1                    running</span><br><span class=\"line\"> 69    ubuntu-2404-desktop   running</span><br><span class=\"line\"> 96    dns-server-vm         running</span><br><span class=\"line\"> 97    u1                    running</span><br><span class=\"line\"> 98    ubuntu24042           running</span><br><span class=\"line\"> 99    kube-node-1           running</span><br><span class=\"line\"> 100   kube-node-2           running</span><br><span class=\"line\"> 101   kube-node-3           running</span><br><span class=\"line\"></span><br><span class=\"line\">root@ois:/home/ois/data/k8s# virsh domiflist 99</span><br><span class=\"line\"> Interface   Type     Source   Model    MAC</span><br><span class=\"line\">-----------------------------------------------------------</span><br><span class=\"line\"> vnet90      bridge   br0      virtio   52:54:00:90:8c:cf</span><br><span class=\"line\"></span><br><span class=\"line\">root@ois:/home/ois/data/k8s# virsh domiflist 100</span><br><span class=\"line\"> Interface   Type     Source   Model    MAC</span><br><span class=\"line\">-----------------------------------------------------------</span><br><span class=\"line\"> vnet91      bridge   br0      virtio   52:54:00:ba:d4:1f</span><br><span class=\"line\"></span><br><span class=\"line\">root@ois:/home/ois/data/k8s# virsh domiflist 101</span><br><span class=\"line\"> Interface   Type     Source   Model    MAC</span><br><span class=\"line\">-----------------------------------------------------------</span><br><span class=\"line\"> vnet92      bridge   br0      virtio   52:54:00:37:e0:96</span><br><span class=\"line\"> </span><br><span class=\"line\"> </span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">在Pod中发起访问</span><br><span class=\"line\"></span><br><span class=\"line\">root@kube-node-1:~# kubectl -n star-wars get pods -o wide</span><br><span class=\"line\">NAME                         READY   STATUS    RESTARTS   AGE    IP             NODE          NOMINATED NODE   READINESS GATES</span><br><span class=\"line\">deathstar-86f85ffb4d-4ldsj   1/1     Running   0          4m1s   172.16.1.231   kube-node-2   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">deathstar-86f85ffb4d-dbzft   1/1     Running   0          4m1s   172.16.3.161   kube-node-3   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">tiefighter                   1/1     Running   0          4m1s   172.16.3.247   kube-node-3   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">xwing                        1/1     Running   0          4m1s   172.16.3.155   kube-node-3   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">root@kube-node-1:~# kubectl -n star-wars <span class=\"built_in\">exec</span> xwing -- ip a                                                                            </span><br><span class=\"line\">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class=\"line\">    <span class=\"built_in\">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class=\"line\">    inet 127.0.0.1/8 scope host lo</span><br><span class=\"line\">       valid_lft forever preferred_lft forever</span><br><span class=\"line\">    inet6 ::1/128 scope host </span><br><span class=\"line\">       valid_lft forever preferred_lft forever</span><br><span class=\"line\">11: eth0@if12: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default qlen 1000</span><br><span class=\"line\">    <span class=\"built_in\">link</span>/ether f2:2a:b8:da:e7:d2 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span><br><span class=\"line\">    inet 172.16.3.155/32 scope global eth0</span><br><span class=\"line\">       valid_lft forever preferred_lft forever</span><br><span class=\"line\">    inet6 fe80::f02a:b8ff:feda:e7d2/64 scope <span class=\"built_in\">link</span> </span><br><span class=\"line\">       valid_lft forever preferred_lft forever</span><br><span class=\"line\">root@kube-node-1:~# kubectl -n star-wars <span class=\"built_in\">exec</span> xwing -- ping 172.16.1.231</span><br><span class=\"line\">error: Internal error occurred: Internal error occurred: error executing <span class=\"built_in\">command</span> <span class=\"keyword\">in</span> container: failed to <span class=\"built_in\">exec</span> <span class=\"keyword\">in</span> container: failed to start <span class=\"built_in\">exec</span> <span class=\"string\">&quot;1b1120795a5b60f35bac5a4056a1714a5c0df32762e2a79f272cf2c82089e970&quot;</span>: OCI runtime <span class=\"built_in\">exec</span> failed: <span class=\"built_in\">exec</span> failed: unable to start container process: <span class=\"built_in\">exec</span>: <span class=\"string\">&quot;ping&quot;</span>: executable file not found <span class=\"keyword\">in</span> <span class=\"variable\">$PATH</span>: unknown</span><br><span class=\"line\">root@kube-node-1:~# kubectl -n star-wars <span class=\"built_in\">exec</span> xwing -- curl -s http://172.16.1.231/v1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;name&quot;</span>: <span class=\"string\">&quot;Death Star&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;hostname&quot;</span>: <span class=\"string\">&quot;deathstar-86f85ffb4d-4ldsj&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;model&quot;</span>: <span class=\"string\">&quot;DS-1 Orbital Battle Station&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;manufacturer&quot;</span>: <span class=\"string\">&quot;Imperial Department of Military Research, Sienar Fleet Systems&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;cost_in_credits&quot;</span>: <span class=\"string\">&quot;1000000000000&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;length&quot;</span>: <span class=\"string\">&quot;120000&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;crew&quot;</span>: <span class=\"string\">&quot;342953&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;passengers&quot;</span>: <span class=\"string\">&quot;843342&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;cargo_capacity&quot;</span>: <span class=\"string\">&quot;1000000000000&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;hyperdrive_rating&quot;</span>: <span class=\"string\">&quot;4.0&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;starship_class&quot;</span>: <span class=\"string\">&quot;Deep Space Mobile Battlestation&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;api&quot;</span>: [</span><br><span class=\"line\">                <span class=\"string\">&quot;GET   /v1&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;GET   /v1/healthz&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;POST  /v1/request-landing&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;PUT   /v1/cargobay&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;GET   /v1/hyper-matter-reactor/status&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;PUT   /v1/exhaust-port&quot;</span></span><br><span class=\"line\">        ]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">在宿主机上进行抓包，可以看到两者之间是直接路由的。</span><br><span class=\"line\"></span><br><span class=\"line\">root@ois:/home/ois/data/k8s# tcpdump -i vnet92 -vn <span class=\"string\">&#x27;tcp port 80&#x27;</span></span><br><span class=\"line\">tcpdump: listening on vnet92, link-type EN10MB (Ethernet), snapshot length 262144 bytes</span><br><span class=\"line\">11:11:11.478887 IP (tos 0x0, ttl 63, <span class=\"built_in\">id</span> 25688, offset 0, flags [DF], proto TCP (6), length 60)</span><br><span class=\"line\">    172.16.3.155.37162 &gt; 172.16.1.231.80: Flags [S], <span class=\"built_in\">cksum</span> 0x5dd1 (incorrect -&gt; 0xdb07), <span class=\"built_in\">seq</span> 542023762, win 64240, options [mss 1460,sackOK,TS val 1624400247 ecr 0,nop,wscale 7], length 0</span><br><span class=\"line\">11:11:11.479178 IP (tos 0x0, ttl 63, <span class=\"built_in\">id</span> 0, offset 0, flags [DF], proto TCP (6), length 60)</span><br><span class=\"line\">    172.16.1.231.80 &gt; 172.16.3.155.37162: Flags [S.], <span class=\"built_in\">cksum</span> 0x5dd1 (incorrect -&gt; 0x7b14), <span class=\"built_in\">seq</span> 3892089835, ack 542023763, win 65160, options [mss 1460,sackOK,TS val 727758081 ecr 1624400247,nop,wscale 7], length 0</span><br><span class=\"line\">11:11:11.479479 IP (tos 0x0, ttl 63, <span class=\"built_in\">id</span> 25689, offset 0, flags [DF], proto TCP (6), length 52)</span><br><span class=\"line\">    172.16.3.155.37162 &gt; 172.16.1.231.80: Flags [.], <span class=\"built_in\">cksum</span> 0x5dc9 (incorrect -&gt; 0xa673), ack 1, win 502, options [nop,nop,TS val 1624400247 ecr 727758081], length 0</span><br><span class=\"line\">11:11:11.479552 IP (tos 0x0, ttl 63, <span class=\"built_in\">id</span> 25690, offset 0, flags [DF], proto TCP (6), length 130)</span><br><span class=\"line\">    172.16.3.155.37162 &gt; 172.16.1.231.80: Flags [P.], <span class=\"built_in\">cksum</span> 0x5e17 (incorrect -&gt; 0x366d), <span class=\"built_in\">seq</span> 1:79, ack 1, win 502, options [nop,nop,TS val 1624400247 ecr 727758081], length 78: HTTP, length: 78</span><br><span class=\"line\">        GET /v1 HTTP/1.1</span><br><span class=\"line\">        Host: 172.16.1.231</span><br><span class=\"line\">        User-Agent: curl/7.88.1</span><br><span class=\"line\">        Accept: */*</span><br><span class=\"line\"></span><br><span class=\"line\">11:11:11.479684 IP (tos 0x0, ttl 63, <span class=\"built_in\">id</span> 13836, offset 0, flags [DF], proto TCP (6), length 52)</span><br><span class=\"line\">    172.16.1.231.80 &gt; 172.16.3.155.37162: Flags [.], <span class=\"built_in\">cksum</span> 0x5dc9 (incorrect -&gt; 0xa61e), ack 79, win 509, options [nop,nop,TS val 727758081 ecr 1624400247], length 0</span><br><span class=\"line\">11:11:11.480420 IP (tos 0x0, ttl 63, <span class=\"built_in\">id</span> 13837, offset 0, flags [DF], proto TCP (6), length 746)</span><br><span class=\"line\">    172.16.1.231.80 &gt; 172.16.3.155.37162: Flags [P.], <span class=\"built_in\">cksum</span> 0x607f (incorrect -&gt; 0xc657), <span class=\"built_in\">seq</span> 1:695, ack 79, win 509, options [nop,nop,TS val 727758082 ecr 1624400247], length 694: HTTP, length: 694</span><br><span class=\"line\">        HTTP/1.1 200 OK</span><br><span class=\"line\">        Content-Type: text/plain</span><br><span class=\"line\">        Date: Fri, 01 Aug 2025 03:11:11 GMT</span><br><span class=\"line\">        Content-Length: 591</span><br><span class=\"line\"></span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">                <span class=\"string\">&quot;name&quot;</span>: <span class=\"string\">&quot;Death Star&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;hostname&quot;</span>: <span class=\"string\">&quot;deathstar-86f85ffb4d-4ldsj&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;model&quot;</span>: <span class=\"string\">&quot;DS-1 Orbital Battle Station&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;manufacturer&quot;</span>: <span class=\"string\">&quot;Imperial Department of Military Research, Sienar Fleet Systems&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;cost_in_credits&quot;</span>: <span class=\"string\">&quot;1000000000000&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;length&quot;</span>: <span class=\"string\">&quot;120000&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;crew&quot;</span>: <span class=\"string\">&quot;342953&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;passengers&quot;</span>: <span class=\"string\">&quot;843342&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;cargo_capacity&quot;</span>: <span class=\"string\">&quot;1000000000000&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;hyperdrive_rating&quot;</span>: <span class=\"string\">&quot;4.0&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;starship_class&quot;</span>: <span class=\"string\">&quot;Deep Space Mobile Battlestation&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;api&quot;</span>: [</span><br><span class=\"line\">                        <span class=\"string\">&quot;GET   /v1&quot;</span>,</span><br><span class=\"line\">                        <span class=\"string\">&quot;GET   /v1/healthz&quot;</span>,</span><br><span class=\"line\">                        <span class=\"string\">&quot;POST  /v1/request-landing&quot;</span>,</span><br><span class=\"line\">                        <span class=\"string\">&quot;PUT   /v1/cargobay&quot;</span>,</span><br><span class=\"line\">                        <span class=\"string\">&quot;GET   /v1/hyper-matter-reactor/status&quot;</span>,</span><br><span class=\"line\">                        <span class=\"string\">&quot;PUT   /v1/exhaust-port&quot;</span></span><br><span class=\"line\">                ]</span><br><span class=\"line\">        &#125;       </span><br></pre></td></tr></table></figure>\n\n<p>Cilium将各个Node对应的Pod路由自动安装了</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@kube-node-3:~# ip route show</span><br><span class=\"line\">default via 10.75.59.1 dev enp1s0 proto static </span><br><span class=\"line\">10.75.59.0/24 dev enp1s0 proto kernel scope <span class=\"built_in\">link</span> src 10.75.59.73 </span><br><span class=\"line\">172.16.0.0/24 via 10.75.59.71 dev enp1s0 proto kernel </span><br><span class=\"line\">172.16.1.0/24 via 10.75.59.72 dev enp1s0 proto kernel </span><br><span class=\"line\">172.16.3.0/24 via 172.16.3.22 dev cilium_host proto kernel src 172.16.3.22 </span><br><span class=\"line\">172.16.3.22 dev cilium_host proto kernel scope <span class=\"built_in\">link</span> </span><br><span class=\"line\">root@kube-node-3:~# route -n</span><br><span class=\"line\">Kernel IP routing table</span><br><span class=\"line\">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class=\"line\">0.0.0.0         10.75.59.1      0.0.0.0         UG    0      0        0 enp1s0</span><br><span class=\"line\">10.75.59.0      0.0.0.0         255.255.255.0   U     0      0        0 enp1s0</span><br><span class=\"line\">172.16.0.0      10.75.59.71     255.255.255.0   UG    0      0        0 enp1s0</span><br><span class=\"line\">172.16.1.0      10.75.59.72     255.255.255.0   UG    0      0        0 enp1s0</span><br><span class=\"line\">172.16.3.0      172.16.3.22     255.255.255.0   UG    0      0        0 cilium_host</span><br><span class=\"line\">172.16.3.22     0.0.0.0         255.255.255.255 UH    0      0        0 cilium_host</span><br><span class=\"line\"></span><br><span class=\"line\">root@kube-node-2:~# ip route show</span><br><span class=\"line\">default via 10.75.59.1 dev enp1s0 proto static </span><br><span class=\"line\">10.75.59.0/24 dev enp1s0 proto kernel scope <span class=\"built_in\">link</span> src 10.75.59.72 </span><br><span class=\"line\">172.16.0.0/24 via 10.75.59.71 dev enp1s0 proto kernel </span><br><span class=\"line\">172.16.1.0/24 via 172.16.1.128 dev cilium_host proto kernel src 172.16.1.128 </span><br><span class=\"line\">172.16.1.128 dev cilium_host proto kernel scope <span class=\"built_in\">link</span> </span><br><span class=\"line\">172.16.3.0/24 via 10.75.59.73 dev enp1s0 proto kernel </span><br><span class=\"line\">root@kube-node-2:~# route -n</span><br><span class=\"line\">Kernel IP routing table</span><br><span class=\"line\">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class=\"line\">0.0.0.0         10.75.59.1      0.0.0.0         UG    0      0        0 enp1s0</span><br><span class=\"line\">10.75.59.0      0.0.0.0         255.255.255.0   U     0      0        0 enp1s0</span><br><span class=\"line\">172.16.0.0      10.75.59.71     255.255.255.0   UG    0      0        0 enp1s0</span><br><span class=\"line\">172.16.1.0      172.16.1.128    255.255.255.0   UG    0      0        0 cilium_host</span><br><span class=\"line\">172.16.1.128    0.0.0.0         255.255.255.255 UH    0      0        0 cilium_host</span><br><span class=\"line\">172.16.3.0      10.75.59.73     255.255.255.0   UG    0      0        0 enp1s0</span><br></pre></td></tr></table></figure>\n\n<p>在Hubble UI中，可以看到详细的Flow</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;uuid&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;2af76725-f6f9-49b4-b9f1-8d01b3f14930&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;verdict&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">1</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;drop_reason&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">0</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;auth_type&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">0</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;Type&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">1</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;node_name&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;kube-node-2&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;node_labels&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span></span><br><span class=\"line\">    <span class=\"string\">&quot;beta.kubernetes.io/arch=amd64&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"string\">&quot;beta.kubernetes.io/os=linux&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"string\">&quot;kubernetes.io/arch=amd64&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"string\">&quot;kubernetes.io/hostname=kube-node-2&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"string\">&quot;kubernetes.io/os=linux&quot;</span></span><br><span class=\"line\">  <span class=\"punctuation\">]</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;source_names&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span><span class=\"punctuation\">]</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;destination_names&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span><span class=\"punctuation\">]</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;reply&quot;</span><span class=\"punctuation\">:</span> <span class=\"literal\"><span class=\"keyword\">false</span></span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;traffic_direction&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">2</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;policy_match_type&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">0</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;trace_observation_point&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">101</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;trace_reason&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">1</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;drop_reason_desc&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">0</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;debug_capture_point&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">0</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;proxy_port&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">0</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;sock_xlate_point&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">0</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;socket_cookie&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">0</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;cgroup_id&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">0</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;Summary&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;TCP Flags: SYN&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;egress_allowed_by&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span><span class=\"punctuation\">]</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;ingress_allowed_by&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span><span class=\"punctuation\">]</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;egress_denied_by&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span><span class=\"punctuation\">]</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;ingress_denied_by&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span><span class=\"punctuation\">]</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;time&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;seconds&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">1754022736</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;nanos&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">962926009</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;ethernet&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;source&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;f2:64:9f:b5:8e:81&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;destination&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;82:31:36:d1:5a:00&quot;</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;IP&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;source&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;172.16.3.155&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;source_xlated&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;destination&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;172.16.1.231&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;ipVersion&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">1</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;encrypted&quot;</span><span class=\"punctuation\">:</span> <span class=\"literal\"><span class=\"keyword\">false</span></span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;l4&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;protocol&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;oneofKind&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;TCP&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;TCP&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">        <span class=\"attr\">&quot;source_port&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">38680</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">        <span class=\"attr\">&quot;destination_port&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">80</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">        <span class=\"attr\">&quot;flags&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">          <span class=\"attr\">&quot;FIN&quot;</span><span class=\"punctuation\">:</span> <span class=\"literal\"><span class=\"keyword\">false</span></span><span class=\"punctuation\">,</span></span><br><span class=\"line\">          <span class=\"attr\">&quot;SYN&quot;</span><span class=\"punctuation\">:</span> <span class=\"literal\"><span class=\"keyword\">true</span></span><span class=\"punctuation\">,</span></span><br><span class=\"line\">          <span class=\"attr\">&quot;RST&quot;</span><span class=\"punctuation\">:</span> <span class=\"literal\"><span class=\"keyword\">false</span></span><span class=\"punctuation\">,</span></span><br><span class=\"line\">          <span class=\"attr\">&quot;PSH&quot;</span><span class=\"punctuation\">:</span> <span class=\"literal\"><span class=\"keyword\">false</span></span><span class=\"punctuation\">,</span></span><br><span class=\"line\">          <span class=\"attr\">&quot;ACK&quot;</span><span class=\"punctuation\">:</span> <span class=\"literal\"><span class=\"keyword\">false</span></span><span class=\"punctuation\">,</span></span><br><span class=\"line\">          <span class=\"attr\">&quot;URG&quot;</span><span class=\"punctuation\">:</span> <span class=\"literal\"><span class=\"keyword\">false</span></span><span class=\"punctuation\">,</span></span><br><span class=\"line\">          <span class=\"attr\">&quot;ECE&quot;</span><span class=\"punctuation\">:</span> <span class=\"literal\"><span class=\"keyword\">false</span></span><span class=\"punctuation\">,</span></span><br><span class=\"line\">          <span class=\"attr\">&quot;CWR&quot;</span><span class=\"punctuation\">:</span> <span class=\"literal\"><span class=\"keyword\">false</span></span><span class=\"punctuation\">,</span></span><br><span class=\"line\">          <span class=\"attr\">&quot;NS&quot;</span><span class=\"punctuation\">:</span> <span class=\"literal\"><span class=\"keyword\">false</span></span></span><br><span class=\"line\">        <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">      <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;source&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;ID&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">0</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;identity&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">36770</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;cluster_name&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;default&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;namespace&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;star-wars&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;labels&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span></span><br><span class=\"line\">      <span class=\"string\">&quot;k8s:app.kubernetes.io/name=xwing&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"string\">&quot;k8s:class=xwing&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"string\">&quot;k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=star-wars&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"string\">&quot;k8s:io.cilium.k8s.policy.cluster=default&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"string\">&quot;k8s:io.cilium.k8s.policy.serviceaccount=default&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"string\">&quot;k8s:io.kubernetes.pod.namespace=star-wars&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"string\">&quot;k8s:org=alliance&quot;</span></span><br><span class=\"line\">    <span class=\"punctuation\">]</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;pod_name&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;xwing&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;workloads&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span><span class=\"punctuation\">]</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;destination&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;ID&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">284</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;identity&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">15153</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;cluster_name&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;default&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;namespace&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;star-wars&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;labels&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span></span><br><span class=\"line\">      <span class=\"string\">&quot;k8s:app.kubernetes.io/name=deathstar&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"string\">&quot;k8s:class=deathstar&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"string\">&quot;k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=star-wars&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"string\">&quot;k8s:io.cilium.k8s.policy.cluster=default&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"string\">&quot;k8s:io.cilium.k8s.policy.serviceaccount=default&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"string\">&quot;k8s:io.kubernetes.pod.namespace=star-wars&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"string\">&quot;k8s:org=empire&quot;</span></span><br><span class=\"line\">    <span class=\"punctuation\">]</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;pod_name&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;deathstar-86f85ffb4d-4ldsj&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;workloads&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span></span><br><span class=\"line\">      <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">        <span class=\"attr\">&quot;name&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;deathstar&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">        <span class=\"attr\">&quot;kind&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;Deployment&quot;</span></span><br><span class=\"line\">      <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">    <span class=\"punctuation\">]</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;event_type&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;type&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">4</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;sub_type&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">0</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;is_reply&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;value&quot;</span><span class=\"punctuation\">:</span> <span class=\"literal\"><span class=\"keyword\">false</span></span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;interface&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;index&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">14</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;name&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;lxcf734e435e18a&quot;</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"5-3-在Node外部抓包-Pod-to-External\"><a href=\"#5-3-在Node外部抓包-Pod-to-External\" class=\"headerlink\" title=\"5.3 在Node外部抓包 ( Pod to External )\"></a>5.3 在Node外部抓包 ( Pod to External )</h2><p>接下来，在Pod内部访问Internet进行测试。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@kube-node-1:~# kubectl get configmap cilium-config -n kube-system -o yaml | grep -E <span class=\"string\">&#x27;enable-ipv4-masquerade|enable-bpf-masquerade&#x27;</span></span><br><span class=\"line\">  enable-bpf-masquerade: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  enable-ipv4-masquerade: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  </span><br><span class=\"line\">Pod xwing 位于Kube-node3，在Node3查看</span><br><span class=\"line\"></span><br><span class=\"line\">root@kube-node-1:~# kubectl get pods -n kube-system -l k8s-app=cilium -o wide | grep kube-node-3</span><br><span class=\"line\">cilium-2vrgj   1/1     Running   0          106m   10.75.59.73   kube-node-3   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">root@kube-node-1:~# kubectl -n star-wars <span class=\"built_in\">exec</span> xwing -- curl -s https://echo.free.beeceptor.com</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;method&quot;</span>: <span class=\"string\">&quot;GET&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;protocol&quot;</span>: <span class=\"string\">&quot;https&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;host&quot;</span>: <span class=\"string\">&quot;echo.free.beeceptor.com&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;path&quot;</span>: <span class=\"string\">&quot;/&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;ip&quot;</span>: <span class=\"string\">&quot;64.104.44.105:35834&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;headers&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;Host&quot;</span>: <span class=\"string\">&quot;echo.free.beeceptor.com&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;User-Agent&quot;</span>: <span class=\"string\">&quot;curl/7.88.1&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;Accept&quot;</span>: <span class=\"string\">&quot;*/*&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;Via&quot;</span>: <span class=\"string\">&quot;2.0 Caddy&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;Accept-Encoding&quot;</span>: <span class=\"string\">&quot;gzip&quot;</span></span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">&quot;parsedQueryParams&quot;</span>: &#123;&#125;</span><br><span class=\"line\">&#125;root@kube-node-1:~# </span><br><span class=\"line\">root@kube-node-1:~# </span><br><span class=\"line\"></span><br><span class=\"line\">使用 cilium bpf nat list 查看NAT表</span><br><span class=\"line\"></span><br><span class=\"line\">root@kube-node-1:~# kubectl <span class=\"built_in\">exec</span> -n kube-system cilium-2vrgj -- cilium bpf nat list | grep 172.16.3.155</span><br><span class=\"line\">Defaulted container <span class=\"string\">&quot;cilium-agent&quot;</span> out of: cilium-agent, config (init), mount-cgroup (init), apply-sysctl-overwrites (init), mount-bpf-fs (init), clean-cilium-state (init), install-cni-binaries (init)</span><br><span class=\"line\">TCP OUT 172.16.3.155:35834 -&gt; 147.182.252.2:443 XLATE_SRC 10.75.59.73:35834 Created=4sec ago NeedsCT=0</span><br><span class=\"line\">TCP IN 147.182.252.2:443 -&gt; 10.75.59.73:35834 XLATE_DST 172.16.3.155:35834 Created=4sec ago NeedsCT=0</span><br><span class=\"line\">root@kube-node-1:~# </span><br><span class=\"line\">root@kube-node-1:~# </span><br><span class=\"line\"></span><br><span class=\"line\">在外部的抓包：</span><br><span class=\"line\">root@ois:/home/ois/data/k8s# tcpdump -i vnet92 -vn <span class=\"string\">&#x27;tcp port 443&#x27;</span></span><br><span class=\"line\">tcpdump: listening on vnet92, link-type EN10MB (Ethernet), snapshot length 262144 bytes</span><br><span class=\"line\">12:28:22.307306 IP (tos 0x0, ttl 63, <span class=\"built_in\">id</span> 45759, offset 0, flags [DF], proto TCP (6), length 60)</span><br><span class=\"line\">    10.75.59.73.49208 &gt; 147.182.252.2.443: Flags [S], <span class=\"built_in\">cksum</span> 0xd57b (incorrect -&gt; 0x363a), <span class=\"built_in\">seq</span> 3275650602, win 64240, options [mss 1460,sackOK,TS val 493037768 ecr 0,nop,wscale 7], length 0</span><br><span class=\"line\">12:28:22.477754 IP (tos 0x0, ttl 42, <span class=\"built_in\">id</span> 0, offset 0, flags [DF], proto TCP (6), length 60)</span><br><span class=\"line\">    147.182.252.2.443 &gt; 10.75.59.73.49208: Flags [S.], <span class=\"built_in\">cksum</span> 0xed16 (correct), <span class=\"built_in\">seq</span> 450982431, ack 3275650603, win 65160, options [mss 1254,sackOK,TS val 1573215106 ecr 493037768,nop,wscale 7], length 0</span><br><span class=\"line\">12:28:22.478053 IP (tos 0x0, ttl 63, <span class=\"built_in\">id</span> 45760, offset 0, flags [DF], proto TCP (6), length 52)</span><br><span class=\"line\">    10.75.59.73.49208 &gt; 147.182.252.2.443: Flags [.], <span class=\"built_in\">cksum</span> 0xd573 (incorrect -&gt; 0x16fd), ack 1, win 502, options [nop,nop,TS val 493037939 ecr 1573215106], length 0</span><br><span class=\"line\">12:28:22.490922 IP (tos 0x0, ttl 63, <span class=\"built_in\">id</span> 45761, offset 0, flags [DF], proto TCP (6), length 569)</span><br><span class=\"line\">    10.75.59.73.49208 &gt; 147.182.252.2.443: Flags [P.], <span class=\"built_in\">cksum</span> 0xd778 (incorrect -&gt; 0x1d27), <span class=\"built_in\">seq</span> 1:518, ack 1, win 502, options [nop,nop,TS val 493037952 ecr 1573215106], length 517</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"6-安装K8S和Cilium脚本自动化\"><a href=\"#6-安装K8S和Cilium脚本自动化\" class=\"headerlink\" title=\"6. 安装K8S和Cilium脚本自动化\"></a>6. 安装K8S和Cilium脚本自动化</h1><p>接下来打算把K8S和Cilium的安装脚本自动化。</p>\n<p>首先需要解决在kube-node-1 能 无密码登录到kube-node-2 和 kube-node-3。</p>\n<h2 id=\"6-1-无密码登录设置\"><a href=\"#6-1-无密码登录设置\" class=\"headerlink\" title=\"6.1 无密码登录设置\"></a>6.1 无密码登录设置</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#!/bin/bash</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># --- Configuration ---</span></span><br><span class=\"line\">ANSIBLE_DIR=<span class=\"string\">&quot;ansible_ssh_setup&quot;</span></span><br><span class=\"line\">INVENTORY_FILE=<span class=\"string\">&quot;<span class=\"variable\">$&#123;ANSIBLE_DIR&#125;</span>/hosts.ini&quot;</span></span><br><span class=\"line\">PLAYBOOK_FILE=<span class=\"string\">&quot;<span class=\"variable\">$&#123;ANSIBLE_DIR&#125;</span>/setup_ssh.yml&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Kubernetes Node IPs</span></span><br><span class=\"line\">KUBE_NODE_1_IP=<span class=\"string\">&quot;10.75.59.71&quot;</span></span><br><span class=\"line\">KUBE_NODE_2_IP=<span class=\"string\">&quot;10.75.59.72&quot;</span></span><br><span class=\"line\">KUBE_NODE_3_IP=<span class=\"string\">&quot;10.75.59.73&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Common Ansible user and Python interpreter</span></span><br><span class=\"line\">ANSIBLE_USER=<span class=\"string\">&quot;ubuntu&quot;</span></span><br><span class=\"line\">ANSIBLE_PYTHON_INTERPRETER=<span class=\"string\">&quot;/usr/bin/python3&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># --- Functions ---</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Function to check and install Ansible</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">install_ansible</span></span>() &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ! <span class=\"built_in\">command</span> -v ansible &amp;&gt; /dev/null</span><br><span class=\"line\">    <span class=\"keyword\">then</span></span><br><span class=\"line\">        <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Ansible not found. Attempting to install Ansible...&quot;</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> [ -f /etc/debian_version ]; <span class=\"keyword\">then</span></span><br><span class=\"line\">            <span class=\"comment\"># Debian/Ubuntu</span></span><br><span class=\"line\">            <span class=\"built_in\">sudo</span> apt update</span><br><span class=\"line\">            <span class=\"built_in\">sudo</span> apt install -y software-properties-common</span><br><span class=\"line\">            <span class=\"built_in\">sudo</span> add-apt-repository --<span class=\"built_in\">yes</span> --update ppa:ansible/ansible</span><br><span class=\"line\">            <span class=\"built_in\">sudo</span> apt install -y ansible</span><br><span class=\"line\">        <span class=\"keyword\">elif</span> [ -f /etc/redhat-release ]; <span class=\"keyword\">then</span></span><br><span class=\"line\">            <span class=\"comment\"># CentOS/RHEL/Fedora</span></span><br><span class=\"line\">            <span class=\"built_in\">sudo</span> yum install -y epel-release</span><br><span class=\"line\">            <span class=\"built_in\">sudo</span> yum install -y ansible</span><br><span class=\"line\">        <span class=\"keyword\">else</span></span><br><span class=\"line\">            <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Unsupported OS for automatic Ansible installation. Please install Ansible manually.&quot;</span></span><br><span class=\"line\">            <span class=\"built_in\">exit</span> 1</span><br><span class=\"line\">        <span class=\"keyword\">fi</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> ! <span class=\"built_in\">command</span> -v ansible &amp;&gt; /dev/null; <span class=\"keyword\">then</span></span><br><span class=\"line\">            <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Ansible installation failed. Please install it manually and re-run this script.&quot;</span></span><br><span class=\"line\">            <span class=\"built_in\">exit</span> 1</span><br><span class=\"line\">        <span class=\"keyword\">fi</span></span><br><span class=\"line\">        <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Ansible installed successfully.&quot;</span></span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">        <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Ansible is already installed.&quot;</span></span><br><span class=\"line\">    <span class=\"keyword\">fi</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Function to create Ansible inventory file</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">create_inventory</span></span>() &#123;</span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Creating Ansible inventory file: <span class=\"variable\">$&#123;INVENTORY_FILE&#125;</span>&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">mkdir</span> -p <span class=\"string\">&quot;<span class=\"variable\">$ANSIBLE_DIR</span>&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOF &gt; &quot;$INVENTORY_FILE&quot;</span></span><br><span class=\"line\"><span class=\"string\">[kubernetes_nodes]</span></span><br><span class=\"line\"><span class=\"string\">kube-node-1 ansible_host=$&#123;KUBE_NODE_1_IP&#125;</span></span><br><span class=\"line\"><span class=\"string\">kube-node-2 ansible_host=$&#123;KUBE_NODE_2_IP&#125;</span></span><br><span class=\"line\"><span class=\"string\">kube-node-3 ansible_host=$&#123;KUBE_NODE_3_IP&#125;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">[all:vars]</span></span><br><span class=\"line\"><span class=\"string\">ansible_user=$&#123;ANSIBLE_USER&#125;</span></span><br><span class=\"line\"><span class=\"string\">ansible_python_interpreter=$&#123;ANSIBLE_PYTHON_INTERPRETER&#125;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Inventory file created.&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Function to create Ansible playbook file</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">create_playbook</span></span>() &#123;</span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Creating Ansible playbook file: <span class=\"variable\">$&#123;PLAYBOOK_FILE&#125;</span>&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">mkdir</span> -p <span class=\"string\">&quot;<span class=\"variable\">$ANSIBLE_DIR</span>&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">&#x27;EOF&#x27;</span> &gt; <span class=\"string\">&quot;<span class=\"variable\">$PLAYBOOK_FILE</span>&quot;</span></span><br><span class=\"line\">---</span><br><span class=\"line\">- name: Generate SSH key on kube-node-1 and distribute to other nodes</span><br><span class=\"line\">  hosts: kubernetes_nodes</span><br><span class=\"line\">  become: <span class=\"built_in\">yes</span></span><br><span class=\"line\"></span><br><span class=\"line\">  tasks:</span><br><span class=\"line\">    - name: Generate SSH key on kube-node-1</span><br><span class=\"line\">      ansible.builtin.command:</span><br><span class=\"line\">        cmd: ssh-keygen -t rsa -b 4096 -N <span class=\"string\">&quot;&quot;</span> -f /root/.ssh/id_rsa</span><br><span class=\"line\">        creates: /root/.ssh/id_rsa</span><br><span class=\"line\">      when: inventory_hostname == <span class=\"string\">&#x27;kube-node-1&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    - name: Ensure .ssh directory exists on all nodes</span><br><span class=\"line\">      ansible.builtin.file:</span><br><span class=\"line\">        path: /root/.ssh</span><br><span class=\"line\">        state: directory</span><br><span class=\"line\">        mode: <span class=\"string\">&#x27;0700&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    - name: Ensure authorized_keys file exists</span><br><span class=\"line\">      ansible.builtin.file:</span><br><span class=\"line\">        path: /root/.ssh/authorized_keys</span><br><span class=\"line\">        state: <span class=\"built_in\">touch</span></span><br><span class=\"line\">        mode: <span class=\"string\">&#x27;0600&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    - name: Fetch public key from kube-node-1</span><br><span class=\"line\">      ansible.builtin.slurp:</span><br><span class=\"line\">        src: /root/.ssh/id_rsa.pub</span><br><span class=\"line\">      register: ssh_public_key</span><br><span class=\"line\">      when: inventory_hostname == <span class=\"string\">&#x27;kube-node-1&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    - name: Distribute public key to kube-node-2 and kube-node-3</span><br><span class=\"line\">      ansible.builtin.lineinfile:</span><br><span class=\"line\">        path: /root/.ssh/authorized_keys</span><br><span class=\"line\">        line: <span class=\"string\">&quot;&#123;&#123; hostvars[&#x27;kube-node-1&#x27;][&#x27;ssh_public_key&#x27;][&#x27;content&#x27;] | b64decode &#125;&#125;&quot;</span></span><br><span class=\"line\">        state: present</span><br><span class=\"line\">      when: inventory_hostname <span class=\"keyword\">in</span> [<span class=\"string\">&#x27;kube-node-2&#x27;</span>, <span class=\"string\">&#x27;kube-node-3&#x27;</span>]</span><br><span class=\"line\">EOF</span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Playbook file created.&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># --- Main Script Execution ---</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;Starting Ansible SSH key setup process...&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 1. Install Ansible if not present</span></span><br><span class=\"line\">install_ansible</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2. Create Ansible inventory file</span></span><br><span class=\"line\">create_inventory</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 3. Create Ansible playbook file</span></span><br><span class=\"line\">create_playbook</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;Setup complete. You can now run the Ansible playbook manually using:&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;ansible-playbook -i \\&quot;<span class=\"variable\">$INVENTORY_FILE</span>\\&quot; \\&quot;<span class=\"variable\">$PLAYBOOK_FILE</span>\\&quot; --ask-become-pass&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;You will be prompted for the &#x27;sudo&#x27; password for the &#x27;ubuntu&#x27; user on your VMs.&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;Process complete.&quot;</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">chmod</span> +x ansible_ssh.sh</span><br><span class=\"line\">./ansible_ssh.sh</span><br><span class=\"line\"></span><br><span class=\"line\">ois@ois:~/data/k8s$ ./ansible_ssh.sh</span><br><span class=\"line\">Starting Ansible SSH key setup process...</span><br><span class=\"line\">Ansible is already installed.</span><br><span class=\"line\">Creating Ansible inventory file: ansible_ssh_setup/hosts.ini</span><br><span class=\"line\">Inventory file created.</span><br><span class=\"line\">Creating Ansible playbook file: ansible_ssh_setup/setup_ssh.yml</span><br><span class=\"line\">Playbook file created.</span><br><span class=\"line\">Setup complete. You can now run the Ansible playbook manually using:</span><br><span class=\"line\">ansible-playbook -i <span class=\"string\">&quot;ansible_ssh_setup/hosts.ini&quot;</span> <span class=\"string\">&quot;ansible_ssh_setup/setup_ssh.yml&quot;</span> --ask-become-pass</span><br><span class=\"line\">You will be prompted <span class=\"keyword\">for</span> the <span class=\"string\">&#x27;sudo&#x27;</span> password <span class=\"keyword\">for</span> the <span class=\"string\">&#x27;ubuntu&#x27;</span> user on your VMs.</span><br><span class=\"line\">Process complete.</span><br><span class=\"line\">ois@ois:~/data/k8s$ <span class=\"built_in\">cd</span> ansible_ssh_setup/</span><br><span class=\"line\">ois@ois:~/data/k8s/ansible_ssh_setup$ ansible-playbook setup_ssh.yml -i hosts.ini -K</span><br><span class=\"line\">BECOME password: </span><br><span class=\"line\"></span><br><span class=\"line\">PLAY [Generate SSH key on kube-node-1 and distribute to other nodes] ********************************************************************************************************</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Gathering Facts] ******************************************************************************************************************************************************</span><br><span class=\"line\">ok: [kube-node-1]</span><br><span class=\"line\">ok: [kube-node-3]</span><br><span class=\"line\">ok: [kube-node-2]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Generate SSH key on kube-node-1] **************************************************************************************************************************************</span><br><span class=\"line\">skipping: [kube-node-2]</span><br><span class=\"line\">skipping: [kube-node-3]</span><br><span class=\"line\">changed: [kube-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Ensure .ssh directory exists on all nodes] ****************************************************************************************************************************</span><br><span class=\"line\">ok: [kube-node-2]</span><br><span class=\"line\">ok: [kube-node-1]</span><br><span class=\"line\">ok: [kube-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Ensure authorized_keys file exists] ***********************************************************************************************************************************</span><br><span class=\"line\">changed: [kube-node-1]</span><br><span class=\"line\">changed: [kube-node-2]</span><br><span class=\"line\">changed: [kube-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Fetch public key from kube-node-1] ************************************************************************************************************************************</span><br><span class=\"line\">skipping: [kube-node-2]</span><br><span class=\"line\">skipping: [kube-node-3]</span><br><span class=\"line\">ok: [kube-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Distribute public key to kube-node-2 and kube-node-3] *****************************************************************************************************************</span><br><span class=\"line\">skipping: [kube-node-1]</span><br><span class=\"line\">changed: [kube-node-3]</span><br><span class=\"line\">changed: [kube-node-2]</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY RECAP ******************************************************************************************************************************************************************</span><br><span class=\"line\">kube-node-1                : ok=5    changed=2    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   </span><br><span class=\"line\">kube-node-2                : ok=4    changed=2    unreachable=0    failed=0    skipped=2    rescued=0    ignored=0   </span><br><span class=\"line\">kube-node-3                : ok=4    changed=2    unreachable=0    failed=0    skipped=2    rescued=0    ignored=0   </span><br></pre></td></tr></table></figure>\n\n<p>效果：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@kube-node-1:~# ssh root@10.75.59.72</span><br><span class=\"line\">Welcome to Ubuntu 24.04.2 LTS (GNU/Linux 6.8.0-63-generic x86_64)</span><br><span class=\"line\"></span><br><span class=\"line\"> * Documentation:  https://help.ubuntu.com</span><br><span class=\"line\"> * Management:     https://landscape.canonical.com</span><br><span class=\"line\"> * Support:        https://ubuntu.com/pro</span><br><span class=\"line\"></span><br><span class=\"line\"> System information as of Fri Aug  1 02:28:23 PM CST 2025</span><br><span class=\"line\"></span><br><span class=\"line\">  System load:  0.13               Processes:               188</span><br><span class=\"line\">  Usage of /:   30.2% of 18.33GB   Users logged <span class=\"keyword\">in</span>:         1</span><br><span class=\"line\">  Memory usage: 10%                IPv4 address <span class=\"keyword\">for</span> enp1s0: 10.75.59.72</span><br><span class=\"line\">  Swap usage:   0%</span><br><span class=\"line\"></span><br><span class=\"line\"> * Strictly confined Kubernetes makes edge and IoT secure. Learn how MicroK8s</span><br><span class=\"line\">   just raised the bar <span class=\"keyword\">for</span> easy, resilient and secure K8s cluster deployment.</span><br><span class=\"line\"></span><br><span class=\"line\">   https://ubuntu.com/engage/secure-kubernetes-at-the-edge</span><br><span class=\"line\"></span><br><span class=\"line\">Expanded Security Maintenance <span class=\"keyword\">for</span> Applications is not enabled.</span><br><span class=\"line\"></span><br><span class=\"line\">0 updates can be applied immediately.</span><br><span class=\"line\"></span><br><span class=\"line\">Enable ESM Apps to receive additional future security updates.</span><br><span class=\"line\">See https://ubuntu.com/esm or run: <span class=\"built_in\">sudo</span> pro status</span><br><span class=\"line\"></span><br><span class=\"line\">*** System restart required ***</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"6-2-自动化安装设置脚本\"><a href=\"#6-2-自动化安装设置脚本\" class=\"headerlink\" title=\"6.2 自动化安装设置脚本\"></a>6.2 自动化安装设置脚本</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#!/bin/bash</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ==============================================================================</span></span><br><span class=\"line\"><span class=\"comment\"># Idempotent Kubernetes and Cilium Setup Script</span></span><br><span class=\"line\"><span class=\"comment\">#</span></span><br><span class=\"line\"><span class=\"comment\"># This script can be run multiple times. It checks the current state</span></span><br><span class=\"line\"><span class=\"comment\"># at each step and only performs actions if necessary.</span></span><br><span class=\"line\"><span class=\"comment\"># It must be run as root on the primary control-plane node.</span></span><br><span class=\"line\"><span class=\"comment\"># ==============================================================================</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># --- Configuration ---</span></span><br><span class=\"line\">CONTROL_PLANE_ENDPOINT=<span class=\"string\">&quot;kube-node-1&quot;</span></span><br><span class=\"line\">CONTROL_PLANE_IP=<span class=\"string\">&quot;10.75.59.71&quot;</span></span><br><span class=\"line\">WORKER_NODES=(<span class=\"string\">&quot;10.75.59.72&quot;</span> <span class=\"string\">&quot;10.75.59.73&quot;</span>)</span><br><span class=\"line\">POD_CIDR=<span class=\"string\">&quot;172.16.0.0/20&quot;</span></span><br><span class=\"line\">SERVICE_CIDR=<span class=\"string\">&quot;172.16.32.0/20&quot;</span></span><br><span class=\"line\">BGP_PEER_IP=<span class=\"string\">&quot;10.75.59.76&quot;</span></span><br><span class=\"line\">LOCAL_ASN=65000</span><br><span class=\"line\">PEER_ASN=65000</span><br><span class=\"line\">CILIUM_VERSION=<span class=\"string\">&quot;1.17.6&quot;</span></span><br><span class=\"line\">HUBBLE_UI_VERSION=<span class=\"string\">&quot;1.3.6&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ==============================================================================</span></span><br><span class=\"line\"><span class=\"comment\"># Helper Function</span></span><br><span class=\"line\"><span class=\"comment\"># ==============================================================================</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">print_header</span></span>() &#123; <span class=\"built_in\">echo</span> -e <span class=\"string\">&quot;\\n### <span class=\"variable\">$1</span> ###&quot;</span>; &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ==============================================================================</span></span><br><span class=\"line\"><span class=\"comment\"># STEP 1: Initialize Kubernetes Control-Plane</span></span><br><span class=\"line\"><span class=\"comment\"># ==============================================================================</span></span><br><span class=\"line\">print_header <span class=\"string\">&quot;STEP 1: Initializing Kubernetes Control-Plane&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> kubectl get nodes &amp;&gt; /dev/null; <span class=\"keyword\">then</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">&quot;✅ Kubernetes cluster is already running. Skipping kubeadm init.&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">else</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">&quot;--&gt; Kubernetes cluster not found. Initializing...&quot;</span></span><br><span class=\"line\">  kubeadm config images pull</span><br><span class=\"line\">  kubeadm init \\</span><br><span class=\"line\">    --control-plane-endpoint=<span class=\"variable\">$&#123;CONTROL_PLANE_ENDPOINT&#125;</span> \\</span><br><span class=\"line\">    --pod-network-cidr=<span class=\"variable\">$&#123;POD_CIDR&#125;</span> \\</span><br><span class=\"line\">    --service-cidr=<span class=\"variable\">$&#123;SERVICE_CIDR&#125;</span> \\</span><br><span class=\"line\">    --skip-phases=addon/kube-proxy</span><br><span class=\"line\">  <span class=\"built_in\">mkdir</span> -p /root/.kube</span><br><span class=\"line\">  <span class=\"built_in\">cp</span> -i /etc/kubernetes/admin.conf /root/.kube/config</span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">&quot;✅ Control-Plane initialization complete.&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ==============================================================================</span></span><br><span class=\"line\"><span class=\"comment\"># STEP 2: Install or Upgrade Cilium CNI</span></span><br><span class=\"line\"><span class=\"comment\"># ==============================================================================</span></span><br><span class=\"line\">print_header <span class=\"string\">&quot;STEP 2: Installing or Upgrading Cilium CNI&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">helm repo add cilium https://helm.cilium.io/ &amp;&gt; /dev/null</span><br><span class=\"line\">helm repo add isovalent https://helm.isovalent.com/ &amp;&gt; /dev/null</span><br><span class=\"line\">helm repo update &gt; /dev/null</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">cat</span> &gt; cilium-values.yaml &lt;&lt;<span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">hubble:</span></span><br><span class=\"line\"><span class=\"string\">  enabled: true</span></span><br><span class=\"line\"><span class=\"string\">  relay:</span></span><br><span class=\"line\"><span class=\"string\">    enabled: true</span></span><br><span class=\"line\"><span class=\"string\">  ui:</span></span><br><span class=\"line\"><span class=\"string\">    enabled: false</span></span><br><span class=\"line\"><span class=\"string\">ipam:</span></span><br><span class=\"line\"><span class=\"string\">  mode: kubernetes</span></span><br><span class=\"line\"><span class=\"string\">ipv4NativeRoutingCIDR: $&#123;POD_CIDR&#125;</span></span><br><span class=\"line\"><span class=\"string\">k8s:</span></span><br><span class=\"line\"><span class=\"string\">  requireIPv4PodCIDR: true</span></span><br><span class=\"line\"><span class=\"string\">routingMode: native</span></span><br><span class=\"line\"><span class=\"string\">autoDirectNodeRoutes: true</span></span><br><span class=\"line\"><span class=\"string\">enableIPv4Masquerade: true</span></span><br><span class=\"line\"><span class=\"string\">bgpControlPlane:</span></span><br><span class=\"line\"><span class=\"string\">  enabled: true</span></span><br><span class=\"line\"><span class=\"string\">  announce:</span></span><br><span class=\"line\"><span class=\"string\">    podCIDR: true</span></span><br><span class=\"line\"><span class=\"string\">kubeProxyReplacement: true</span></span><br><span class=\"line\"><span class=\"string\">bpf:</span></span><br><span class=\"line\"><span class=\"string\">  masquerade: true</span></span><br><span class=\"line\"><span class=\"string\">  lb:</span></span><br><span class=\"line\"><span class=\"string\">    externalClusterIP: true</span></span><br><span class=\"line\"><span class=\"string\">    sock: true</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> helm status cilium -n kube-system &amp;&gt; /dev/null; <span class=\"keyword\">then</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">&quot;--&gt; Cilium is already installed. Upgrading to apply latest configuration...&quot;</span></span><br><span class=\"line\">  helm upgrade cilium isovalent/cilium --version <span class=\"variable\">$&#123;CILIUM_VERSION&#125;</span> --namespace kube-system --<span class=\"built_in\">set</span> k8sServiceHost=<span class=\"variable\">$&#123;CONTROL_PLANE_IP&#125;</span>,k8sServicePort=6443 -f cilium-values.yaml</span><br><span class=\"line\"><span class=\"keyword\">else</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">&quot;--&gt; Cilium not found. Installing...&quot;</span></span><br><span class=\"line\">  helm install cilium isovalent/cilium --version <span class=\"variable\">$&#123;CILIUM_VERSION&#125;</span> --namespace kube-system --<span class=\"built_in\">set</span> k8sServiceHost=<span class=\"variable\">$&#123;CONTROL_PLANE_IP&#125;</span>,k8sServicePort=6443 -f cilium-values.yaml</span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;--&gt; Waiting for Cilium pods to become ready...&quot;</span></span><br><span class=\"line\">kubectl -n kube-system <span class=\"built_in\">wait</span> --<span class=\"keyword\">for</span>=condition=Ready pod -l k8s-app=cilium --<span class=\"built_in\">timeout</span>=5m</span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;✅ Cilium is configured.&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ==============================================================================</span></span><br><span class=\"line\"><span class=\"comment\"># STEP 3: Join Worker Nodes to the Cluster</span></span><br><span class=\"line\"><span class=\"comment\"># ==============================================================================</span></span><br><span class=\"line\">print_header <span class=\"string\">&quot;STEP 3: Joining Worker Nodes&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">for</span> NODE_IP <span class=\"keyword\">in</span> <span class=\"string\">&quot;<span class=\"variable\">$&#123;WORKER_NODES[@]&#125;</span>&quot;</span>; <span class=\"keyword\">do</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> kubectl get nodes -o wide | grep -q <span class=\"string\">&quot;<span class=\"variable\">$NODE_IP</span>&quot;</span>; <span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;✅ Node <span class=\"variable\">$&#123;NODE_IP&#125;</span> is already in the cluster. Skipping join.&quot;</span></span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;--&gt; Node <span class=\"variable\">$&#123;NODE_IP&#125;</span> not found in cluster. Attempting to join...&quot;</span></span><br><span class=\"line\">    JOIN_COMMAND=$(kubeadm token create --print-join-command)</span><br><span class=\"line\">    ssh -o StrictHostKeyChecking=no root@<span class=\"variable\">$&#123;NODE_IP&#125;</span> <span class=\"string\">&quot;<span class=\"variable\">$&#123;JOIN_COMMAND&#125;</span>&quot;</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> [ $? -ne 0 ]; <span class=\"keyword\">then</span></span><br><span class=\"line\">      <span class=\"built_in\">echo</span> <span class=\"string\">&quot;❌ Failed to join node <span class=\"variable\">$&#123;NODE_IP&#125;</span>. Please check SSH connectivity and logs.&quot;</span> &gt;&amp;2</span><br><span class=\"line\">      <span class=\"built_in\">exit</span> 1</span><br><span class=\"line\">    <span class=\"keyword\">fi</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;✅ Node <span class=\"variable\">$&#123;NODE_IP&#125;</span> joined successfully.&quot;</span></span><br><span class=\"line\">  <span class=\"keyword\">fi</span></span><br><span class=\"line\"><span class=\"keyword\">done</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ==============================================================================</span></span><br><span class=\"line\"><span class=\"comment\"># STEP 4: Install Cilium CLI</span></span><br><span class=\"line\"><span class=\"comment\"># ==============================================================================</span></span><br><span class=\"line\">print_header <span class=\"string\">&quot;STEP 4: Installing Cilium CLI&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> <span class=\"built_in\">command</span> -v cilium &amp;&gt; /dev/null; <span class=\"keyword\">then</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">&quot;✅ Cilium CLI is already installed. Skipping.&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">else</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">&quot;--&gt; Installing Cilium CLI...&quot;</span></span><br><span class=\"line\">  curl -L --silent --remote-name-all https://github.com/isovalent/cilium-cli-releases/releases/latest/download/cilium-linux-amd64.tar.gz&#123;,.<span class=\"built_in\">sha256sum</span>&#125;</span><br><span class=\"line\">  <span class=\"built_in\">sha256sum</span> --check cilium-linux-amd64.tar.gz.sha256sum &gt; /dev/null</span><br><span class=\"line\">  tar xzvfC cilium-linux-amd64.tar.gz /usr/local/bin &gt; /dev/null</span><br><span class=\"line\">  <span class=\"built_in\">rm</span> cilium-linux-amd64.tar.gz cilium-linux-amd64.tar.gz.sha256sum</span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">&quot;✅ Cilium CLI installed.&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ==============================================================================</span></span><br><span class=\"line\"><span class=\"comment\"># STEP 5: Configure Cilium BGP Peering</span></span><br><span class=\"line\"><span class=\"comment\"># ==============================================================================</span></span><br><span class=\"line\">print_header <span class=\"string\">&quot;STEP 5: Configuring Cilium BGP Peering&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;--&gt; Applying BGP configuration. &#x27;unchanged&#x27; means it&#x27;s already correct.&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># CORRECTION: Using the correct schema with matchLabels.</span></span><br><span class=\"line\"><span class=\"built_in\">cat</span> &gt; cilium-bgp.yaml &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">---</span></span><br><span class=\"line\"><span class=\"string\">apiVersion: cilium.io/v2alpha1</span></span><br><span class=\"line\"><span class=\"string\">kind: CiliumBGPAdvertisement</span></span><br><span class=\"line\"><span class=\"string\">metadata:</span></span><br><span class=\"line\"><span class=\"string\">  name: bgp-advertisements</span></span><br><span class=\"line\"><span class=\"string\">  labels:</span></span><br><span class=\"line\"><span class=\"string\">    advertise: bgp</span></span><br><span class=\"line\"><span class=\"string\">spec:</span></span><br><span class=\"line\"><span class=\"string\">  advertisements:</span></span><br><span class=\"line\"><span class=\"string\">    - advertisementType: &quot;PodCIDR&quot;              # Only for Kubernetes or ClusterPool IPAM cluster-pool</span></span><br><span class=\"line\"><span class=\"string\">    - advertisementType: &quot;Service&quot;</span></span><br><span class=\"line\"><span class=\"string\">      service:</span></span><br><span class=\"line\"><span class=\"string\">        addresses:</span></span><br><span class=\"line\"><span class=\"string\">          - ClusterIP</span></span><br><span class=\"line\"><span class=\"string\">          - ExternalIP</span></span><br><span class=\"line\"><span class=\"string\">          #- LoadBalancerIP</span></span><br><span class=\"line\"><span class=\"string\">      selector:</span></span><br><span class=\"line\"><span class=\"string\">        matchExpressions:</span></span><br><span class=\"line\"><span class=\"string\">        - &#123;key: somekey, operator: NotIn, values: [&#x27;never-used-value&#x27;]&#125; </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">---</span></span><br><span class=\"line\"><span class=\"string\">apiVersion: cilium.io/v2alpha1</span></span><br><span class=\"line\"><span class=\"string\">kind: CiliumBGPPeerConfig</span></span><br><span class=\"line\"><span class=\"string\">metadata:</span></span><br><span class=\"line\"><span class=\"string\">  name: cilium-peer</span></span><br><span class=\"line\"><span class=\"string\">spec:</span></span><br><span class=\"line\"><span class=\"string\">  timers:</span></span><br><span class=\"line\"><span class=\"string\">    holdTimeSeconds: 30             #default 90s</span></span><br><span class=\"line\"><span class=\"string\">    keepAliveTimeSeconds: 10  #default 30s</span></span><br><span class=\"line\"><span class=\"string\">    connectRetryTimeSeconds: 40  #default 120s</span></span><br><span class=\"line\"><span class=\"string\">  gracefulRestart:</span></span><br><span class=\"line\"><span class=\"string\">    enabled: true</span></span><br><span class=\"line\"><span class=\"string\">    restartTimeSeconds: 120        #default 120s</span></span><br><span class=\"line\"><span class=\"string\">  #transport:</span></span><br><span class=\"line\"><span class=\"string\">  #  peerPort: 179</span></span><br><span class=\"line\"><span class=\"string\">  families:</span></span><br><span class=\"line\"><span class=\"string\">    - afi: ipv4</span></span><br><span class=\"line\"><span class=\"string\">      safi: unicast</span></span><br><span class=\"line\"><span class=\"string\">      advertisements:</span></span><br><span class=\"line\"><span class=\"string\">        matchLabels:</span></span><br><span class=\"line\"><span class=\"string\">          advertise: &quot;bgp&quot;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">---</span></span><br><span class=\"line\"><span class=\"string\">apiVersion: cilium.io/v2alpha1</span></span><br><span class=\"line\"><span class=\"string\">kind: CiliumBGPClusterConfig</span></span><br><span class=\"line\"><span class=\"string\">metadata:</span></span><br><span class=\"line\"><span class=\"string\">  name: cilium-bgp-default</span></span><br><span class=\"line\"><span class=\"string\">spec:</span></span><br><span class=\"line\"><span class=\"string\">  bgpInstances:</span></span><br><span class=\"line\"><span class=\"string\">  - name: &quot;instance-65000&quot;</span></span><br><span class=\"line\"><span class=\"string\">    localASN: $&#123;LOCAL_ASN&#125;</span></span><br><span class=\"line\"><span class=\"string\">    peers:</span></span><br><span class=\"line\"><span class=\"string\">    - name: &quot;FRR_BGP&quot;</span></span><br><span class=\"line\"><span class=\"string\">      peerASN: $&#123;PEER_ASN&#125;</span></span><br><span class=\"line\"><span class=\"string\">      peerAddress: $&#123;BGP_PEER_IP&#125;</span></span><br><span class=\"line\"><span class=\"string\">      peerConfigRef:</span></span><br><span class=\"line\"><span class=\"string\">        name: &quot;cilium-peer&quot;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Apply the configuration and check for errors</span></span><br><span class=\"line\">kubectl apply -f cilium-bgp.yaml</span><br><span class=\"line\"><span class=\"keyword\">if</span> [ $? -ne 0 ]; <span class=\"keyword\">then</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">&quot;❌ Failed to apply BGP configuration. Please check the errors above.&quot;</span> &gt;&amp;2</span><br><span class=\"line\">  <span class=\"built_in\">exit</span> 1</span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;✅ BGP configuration applied.&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ==============================================================================</span></span><br><span class=\"line\"><span class=\"comment\"># STEP 6: Install or Upgrade Hubble UI</span></span><br><span class=\"line\"><span class=\"comment\"># ==============================================================================</span></span><br><span class=\"line\">print_header <span class=\"string\">&quot;STEP 6: Installing or Upgrading Hubble UI&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">cat</span> &gt; hubble-ui-values.yaml &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">relay:</span></span><br><span class=\"line\"><span class=\"string\">  address: &quot;hubble-relay.kube-system.svc.cluster.local&quot;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> helm status hubble-ui -n kube-system &amp;&gt; /dev/null; <span class=\"keyword\">then</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">&quot;--&gt; Hubble UI is already installed. Upgrading...&quot;</span></span><br><span class=\"line\">  helm upgrade hubble-ui isovalent/hubble-ui --version <span class=\"variable\">$&#123;HUBBLE_UI_VERSION&#125;</span> --namespace kube-system --values hubble-ui-values.yaml --<span class=\"built_in\">wait</span></span><br><span class=\"line\"><span class=\"keyword\">else</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">&quot;--&gt; Hubble UI not found. Installing...&quot;</span></span><br><span class=\"line\">  helm install hubble-ui isovalent/hubble-ui --version <span class=\"variable\">$&#123;HUBBLE_UI_VERSION&#125;</span> --namespace kube-system --values hubble-ui-values.yaml --<span class=\"built_in\">wait</span></span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\"></span><br><span class=\"line\">SERVICE_TYPE=$(kubectl get service hubble-ui -n kube-system -o jsonpath=<span class=\"string\">&#x27;&#123;.spec.type&#125;&#x27;</span>)</span><br><span class=\"line\"><span class=\"keyword\">if</span> [ <span class=\"string\">&quot;<span class=\"variable\">$SERVICE_TYPE</span>&quot;</span> != <span class=\"string\">&quot;NodePort&quot;</span> ]; <span class=\"keyword\">then</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">&quot;--&gt; Patching Hubble UI service to NodePort...&quot;</span></span><br><span class=\"line\">  kubectl patch service hubble-ui -n kube-system -p <span class=\"string\">&#x27;&#123;&quot;spec&quot;: &#123;&quot;type&quot;: &quot;NodePort&quot;&#125;&#125;&#x27;</span></span><br><span class=\"line\"><span class=\"keyword\">else</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">&quot;--&gt; Hubble UI service is already of type NodePort.&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;✅ Hubble UI is configured.&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ==============================================================================</span></span><br><span class=\"line\"><span class=\"comment\"># STEP 7: Final Verification</span></span><br><span class=\"line\"><span class=\"comment\"># ==============================================================================</span></span><br><span class=\"line\">print_header <span class=\"string\">&quot;STEP 7: Final Verification&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;--&gt; Waiting for all nodes to be ready...&quot;</span></span><br><span class=\"line\">kubectl <span class=\"built_in\">wait</span> --<span class=\"keyword\">for</span>=condition=Ready node --all --<span class=\"built_in\">timeout</span>=5m</span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;--&gt; Checking Cilium status...&quot;</span></span><br><span class=\"line\">cilium status --<span class=\"built_in\">wait</span></span><br><span class=\"line\"></span><br><span class=\"line\">HUBBLE_UI_PORT=$(kubectl get service hubble-ui -n kube-system -o jsonpath=<span class=\"string\">&#x27;&#123;.spec.ports[0].nodePort&#125;&#x27;</span>)</span><br><span class=\"line\"><span class=\"built_in\">echo</span> -e <span class=\"string\">&quot;\\n----------------------------------------------------------------&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;🚀 Cluster setup is complete and verified!&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;Access Hubble UI at: http://<span class=\"variable\">$&#123;CONTROL_PLANE_IP&#125;</span>:<span class=\"variable\">$&#123;HUBBLE_UI_PORT&#125;</span>&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;----------------------------------------------------------------&quot;</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br><span class=\"line\">252</span><br><span class=\"line\">253</span><br><span class=\"line\">254</span><br><span class=\"line\">255</span><br><span class=\"line\">256</span><br><span class=\"line\">257</span><br><span class=\"line\">258</span><br><span class=\"line\">259</span><br><span class=\"line\">260</span><br><span class=\"line\">261</span><br><span class=\"line\">262</span><br><span class=\"line\">263</span><br><span class=\"line\">264</span><br><span class=\"line\">265</span><br><span class=\"line\">266</span><br><span class=\"line\">267</span><br><span class=\"line\">268</span><br><span class=\"line\">269</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@kube-node-1:~# ./k8s-cilium-setup.sh </span><br><span class=\"line\"><span class=\"comment\">### STEP 1: Initializing Kubernetes Control-Plane on kube-node-1... ###</span></span><br><span class=\"line\">--&gt; Pulling Kubernetes container images...</span><br><span class=\"line\">[config/images] Pulled registry.k8s.io/kube-apiserver:v1.33.3</span><br><span class=\"line\">[config/images] Pulled registry.k8s.io/kube-controller-manager:v1.33.3</span><br><span class=\"line\">[config/images] Pulled registry.k8s.io/kube-scheduler:v1.33.3</span><br><span class=\"line\">[config/images] Pulled registry.k8s.io/kube-proxy:v1.33.3</span><br><span class=\"line\">[config/images] Pulled registry.k8s.io/coredns/coredns:v1.12.0</span><br><span class=\"line\">[config/images] Pulled registry.k8s.io/pause:3.10</span><br><span class=\"line\">[config/images] Pulled registry.k8s.io/etcd:3.5.21-0</span><br><span class=\"line\">--&gt; Running kubeadm init...</span><br><span class=\"line\">[init] Using Kubernetes version: v1.33.3</span><br><span class=\"line\">[preflight] Running pre-flight checks</span><br><span class=\"line\">[preflight] Pulling images required <span class=\"keyword\">for</span> setting up a Kubernetes cluster</span><br><span class=\"line\">[preflight] This might take a minute or two, depending on the speed of your internet connection</span><br><span class=\"line\">[preflight] You can also perform this action beforehand using <span class=\"string\">&#x27;kubeadm config images pull&#x27;</span></span><br><span class=\"line\">[certs] Using certificateDir folder <span class=\"string\">&quot;/etc/kubernetes/pki&quot;</span></span><br><span class=\"line\">[certs] Generating <span class=\"string\">&quot;ca&quot;</span> certificate and key</span><br><span class=\"line\">[certs] Generating <span class=\"string\">&quot;apiserver&quot;</span> certificate and key</span><br><span class=\"line\">[certs] apiserver serving cert is signed <span class=\"keyword\">for</span> DNS names [kube-node-1 kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local] and IPs [172.16.32.1 10.75.59.71]</span><br><span class=\"line\">[certs] Generating <span class=\"string\">&quot;apiserver-kubelet-client&quot;</span> certificate and key</span><br><span class=\"line\">[certs] Generating <span class=\"string\">&quot;front-proxy-ca&quot;</span> certificate and key</span><br><span class=\"line\">[certs] Generating <span class=\"string\">&quot;front-proxy-client&quot;</span> certificate and key</span><br><span class=\"line\">[certs] Generating <span class=\"string\">&quot;etcd/ca&quot;</span> certificate and key</span><br><span class=\"line\">[certs] Generating <span class=\"string\">&quot;etcd/server&quot;</span> certificate and key</span><br><span class=\"line\">[certs] etcd/server serving cert is signed <span class=\"keyword\">for</span> DNS names [kube-node-1 localhost] and IPs [10.75.59.71 127.0.0.1 ::1]</span><br><span class=\"line\">[certs] Generating <span class=\"string\">&quot;etcd/peer&quot;</span> certificate and key</span><br><span class=\"line\">[certs] etcd/peer serving cert is signed <span class=\"keyword\">for</span> DNS names [kube-node-1 localhost] and IPs [10.75.59.71 127.0.0.1 ::1]</span><br><span class=\"line\">[certs] Generating <span class=\"string\">&quot;etcd/healthcheck-client&quot;</span> certificate and key</span><br><span class=\"line\">[certs] Generating <span class=\"string\">&quot;apiserver-etcd-client&quot;</span> certificate and key</span><br><span class=\"line\">[certs] Generating <span class=\"string\">&quot;sa&quot;</span> key and public key</span><br><span class=\"line\">[kubeconfig] Using kubeconfig folder <span class=\"string\">&quot;/etc/kubernetes&quot;</span></span><br><span class=\"line\">[kubeconfig] Writing <span class=\"string\">&quot;admin.conf&quot;</span> kubeconfig file</span><br><span class=\"line\">[kubeconfig] Writing <span class=\"string\">&quot;super-admin.conf&quot;</span> kubeconfig file</span><br><span class=\"line\">[kubeconfig] Writing <span class=\"string\">&quot;kubelet.conf&quot;</span> kubeconfig file</span><br><span class=\"line\">[kubeconfig] Writing <span class=\"string\">&quot;controller-manager.conf&quot;</span> kubeconfig file</span><br><span class=\"line\">[kubeconfig] Writing <span class=\"string\">&quot;scheduler.conf&quot;</span> kubeconfig file</span><br><span class=\"line\">[etcd] Creating static Pod manifest <span class=\"keyword\">for</span> <span class=\"built_in\">local</span> etcd <span class=\"keyword\">in</span> <span class=\"string\">&quot;/etc/kubernetes/manifests&quot;</span></span><br><span class=\"line\">[control-plane] Using manifest folder <span class=\"string\">&quot;/etc/kubernetes/manifests&quot;</span></span><br><span class=\"line\">[control-plane] Creating static Pod manifest <span class=\"keyword\">for</span> <span class=\"string\">&quot;kube-apiserver&quot;</span></span><br><span class=\"line\">[control-plane] Creating static Pod manifest <span class=\"keyword\">for</span> <span class=\"string\">&quot;kube-controller-manager&quot;</span></span><br><span class=\"line\">[control-plane] Creating static Pod manifest <span class=\"keyword\">for</span> <span class=\"string\">&quot;kube-scheduler&quot;</span></span><br><span class=\"line\">[kubelet-start] Writing kubelet environment file with flags to file <span class=\"string\">&quot;/var/lib/kubelet/kubeadm-flags.env&quot;</span></span><br><span class=\"line\">[kubelet-start] Writing kubelet configuration to file <span class=\"string\">&quot;/var/lib/kubelet/config.yaml&quot;</span></span><br><span class=\"line\">[kubelet-start] Starting the kubelet</span><br><span class=\"line\">[wait-control-plane] Waiting <span class=\"keyword\">for</span> the kubelet to boot up the control plane as static Pods from directory <span class=\"string\">&quot;/etc/kubernetes/manifests&quot;</span></span><br><span class=\"line\">[kubelet-check] Waiting <span class=\"keyword\">for</span> a healthy kubelet at http://127.0.0.1:10248/healthz. This can take up to 4m0s</span><br><span class=\"line\">[kubelet-check] The kubelet is healthy after 1.001873284s</span><br><span class=\"line\">[control-plane-check] Waiting <span class=\"keyword\">for</span> healthy control plane components. This can take up to 4m0s</span><br><span class=\"line\">[control-plane-check] Checking kube-apiserver at https://10.75.59.71:6443/livez</span><br><span class=\"line\">[control-plane-check] Checking kube-controller-manager at https://127.0.0.1:10257/healthz</span><br><span class=\"line\">[control-plane-check] Checking kube-scheduler at https://127.0.0.1:10259/livez</span><br><span class=\"line\">[control-plane-check] kube-controller-manager is healthy after 2.272937689s</span><br><span class=\"line\">[control-plane-check] kube-scheduler is healthy after 3.04977489s</span><br><span class=\"line\">[control-plane-check] kube-apiserver is healthy after 5.003048769s</span><br><span class=\"line\">[upload-config] Storing the configuration used <span class=\"keyword\">in</span> ConfigMap <span class=\"string\">&quot;kubeadm-config&quot;</span> <span class=\"keyword\">in</span> the <span class=\"string\">&quot;kube-system&quot;</span> Namespace</span><br><span class=\"line\">[kubelet] Creating a ConfigMap <span class=\"string\">&quot;kubelet-config&quot;</span> <span class=\"keyword\">in</span> namespace kube-system with the configuration <span class=\"keyword\">for</span> the kubelets <span class=\"keyword\">in</span> the cluster</span><br><span class=\"line\">[upload-certs] Skipping phase. Please see --upload-certs</span><br><span class=\"line\">[mark-control-plane] Marking the node kube-node-1 as control-plane by adding the labels: [node-role.kubernetes.io/control-plane node.kubernetes.io/exclude-from-external-load-balancers]</span><br><span class=\"line\">[mark-control-plane] Marking the node kube-node-1 as control-plane by adding the taints [node-role.kubernetes.io/control-plane:NoSchedule]</span><br><span class=\"line\">[bootstrap-token] Using token: 0q5m6l.5pc7hz15orcc0b6b</span><br><span class=\"line\">[bootstrap-token] Configuring bootstrap tokens, cluster-info ConfigMap, RBAC Roles</span><br><span class=\"line\">[bootstrap-token] Configured RBAC rules to allow Node Bootstrap tokens to get nodes</span><br><span class=\"line\">[bootstrap-token] Configured RBAC rules to allow Node Bootstrap tokens to post CSRs <span class=\"keyword\">in</span> order <span class=\"keyword\">for</span> nodes to get long term certificate credentials</span><br><span class=\"line\">[bootstrap-token] Configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token</span><br><span class=\"line\">[bootstrap-token] Configured RBAC rules to allow certificate rotation <span class=\"keyword\">for</span> all node client certificates <span class=\"keyword\">in</span> the cluster</span><br><span class=\"line\">[bootstrap-token] Creating the <span class=\"string\">&quot;cluster-info&quot;</span> ConfigMap <span class=\"keyword\">in</span> the <span class=\"string\">&quot;kube-public&quot;</span> namespace</span><br><span class=\"line\">[kubelet-finalize] Updating <span class=\"string\">&quot;/etc/kubernetes/kubelet.conf&quot;</span> to point to a rotatable kubelet client certificate and key</span><br><span class=\"line\">[addons] Applied essential addon: CoreDNS</span><br><span class=\"line\"></span><br><span class=\"line\">Your Kubernetes control-plane has initialized successfully!</span><br><span class=\"line\"></span><br><span class=\"line\">To start using your cluster, you need to run the following as a regular user:</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"built_in\">mkdir</span> -p <span class=\"variable\">$HOME</span>/.kube</span><br><span class=\"line\">  <span class=\"built_in\">sudo</span> <span class=\"built_in\">cp</span> -i /etc/kubernetes/admin.conf <span class=\"variable\">$HOME</span>/.kube/config</span><br><span class=\"line\">  <span class=\"built_in\">sudo</span> <span class=\"built_in\">chown</span> $(<span class=\"built_in\">id</span> -u):$(<span class=\"built_in\">id</span> -g) <span class=\"variable\">$HOME</span>/.kube/config</span><br><span class=\"line\"></span><br><span class=\"line\">Alternatively, <span class=\"keyword\">if</span> you are the root user, you can run:</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"built_in\">export</span> KUBECONFIG=/etc/kubernetes/admin.conf</span><br><span class=\"line\"></span><br><span class=\"line\">You should now deploy a pod network to the cluster.</span><br><span class=\"line\">Run <span class=\"string\">&quot;kubectl apply -f [podnetwork].yaml&quot;</span> with one of the options listed at:</span><br><span class=\"line\">  https://kubernetes.io/docs/concepts/cluster-administration/addons/</span><br><span class=\"line\"></span><br><span class=\"line\">You can now <span class=\"built_in\">join</span> any number of control-plane nodes by copying certificate authorities</span><br><span class=\"line\">and service account keys on each node and <span class=\"keyword\">then</span> running the following as root:</span><br><span class=\"line\"></span><br><span class=\"line\">  kubeadm <span class=\"built_in\">join</span> kube-node-1:6443 --token 0q5m6l.5pc7hz15orcc0b6b \\</span><br><span class=\"line\">        --discovery-token-ca-cert-hash sha256:4795595e8237c54f1bf20c7fb56feea9a1960af5802c08c410733d54b5e317a6 \\</span><br><span class=\"line\">        --control-plane </span><br><span class=\"line\"></span><br><span class=\"line\">Then you can <span class=\"built_in\">join</span> any number of worker nodes by running the following on each as root:</span><br><span class=\"line\"></span><br><span class=\"line\">kubeadm <span class=\"built_in\">join</span> kube-node-1:6443 --token 0q5m6l.5pc7hz15orcc0b6b \\</span><br><span class=\"line\">        --discovery-token-ca-cert-hash sha256:4795595e8237c54f1bf20c7fb56feea9a1960af5802c08c410733d54b5e317a6 </span><br><span class=\"line\">--&gt; Configuring kubectl...</span><br><span class=\"line\">✅ Control-Plane initialization complete.</span><br><span class=\"line\"><span class=\"comment\">### STEP 2: Installing Cilium... ###</span></span><br><span class=\"line\">--&gt; Adding Helm repositories...</span><br><span class=\"line\"><span class=\"string\">&quot;cilium&quot;</span> has been added to your repositories</span><br><span class=\"line\"><span class=\"string\">&quot;isovalent&quot;</span> has been added to your repositories</span><br><span class=\"line\">Hang tight <span class=\"keyword\">while</span> we grab the latest from your chart repositories...</span><br><span class=\"line\">...Successfully got an update from the <span class=\"string\">&quot;cilium&quot;</span> chart repository</span><br><span class=\"line\">...Successfully got an update from the <span class=\"string\">&quot;isovalent&quot;</span> chart repository</span><br><span class=\"line\">Update Complete. ⎈Happy Helming!⎈</span><br><span class=\"line\">--&gt; Creating cilium-enterprise-values.yaml...</span><br><span class=\"line\">--&gt; Installing Cilium with Helm...</span><br><span class=\"line\">NAME: cilium</span><br><span class=\"line\">LAST DEPLOYED: Fri Aug  1 14:16:16 2025</span><br><span class=\"line\">NAMESPACE: kube-system</span><br><span class=\"line\">STATUS: deployed</span><br><span class=\"line\">REVISION: 1</span><br><span class=\"line\">TEST SUITE: None</span><br><span class=\"line\">NOTES:</span><br><span class=\"line\">You have successfully installed Cilium with Hubble Relay.</span><br><span class=\"line\"></span><br><span class=\"line\">Your release version is 1.17.6.</span><br><span class=\"line\"></span><br><span class=\"line\">For any further <span class=\"built_in\">help</span>, visit https://docs.isovalent.com/v1.17</span><br><span class=\"line\">--&gt; Waiting <span class=\"keyword\">for</span> Cilium pods to become ready...</span><br><span class=\"line\">pod/cilium-5ngcm condition met</span><br><span class=\"line\">✅ Cilium installation complete.</span><br><span class=\"line\"><span class=\"comment\">### STEP 3: Joining Worker Nodes... ###</span></span><br><span class=\"line\">--&gt; Generated <span class=\"built_in\">join</span> <span class=\"built_in\">command</span>: kubeadm <span class=\"built_in\">join</span> kube-node-1:6443 --token whltm8.4zs5af6hiht167da --discovery-token-ca-cert-hash sha256:4795595e8237c54f1bf20c7fb56feea9a1960af5802c08c410733d54b5e317a6 </span><br><span class=\"line\">--&gt; Joining node 10.75.59.72 to the cluster...</span><br><span class=\"line\">[preflight] Running pre-flight checks</span><br><span class=\"line\">[preflight] Reading configuration from the <span class=\"string\">&quot;kubeadm-config&quot;</span> ConfigMap <span class=\"keyword\">in</span> namespace <span class=\"string\">&quot;kube-system&quot;</span>...</span><br><span class=\"line\">[preflight] Use <span class=\"string\">&#x27;kubeadm init phase upload-config --config your-config-file&#x27;</span> to re-upload it.</span><br><span class=\"line\">W0801 14:18:01.674767   20870 configset.go:78] Warning: No kubeproxy.config.k8s.io/v1alpha1 config is loaded. Continuing without it: configmaps <span class=\"string\">&quot;kube-proxy&quot;</span> is forbidden: User <span class=\"string\">&quot;system:bootstrap:whltm8&quot;</span> cannot get resource <span class=\"string\">&quot;configmaps&quot;</span> <span class=\"keyword\">in</span> API group <span class=\"string\">&quot;&quot;</span> <span class=\"keyword\">in</span> the namespace <span class=\"string\">&quot;kube-system&quot;</span></span><br><span class=\"line\">[kubelet-start] Writing kubelet configuration to file <span class=\"string\">&quot;/var/lib/kubelet/config.yaml&quot;</span></span><br><span class=\"line\">[kubelet-start] Writing kubelet environment file with flags to file <span class=\"string\">&quot;/var/lib/kubelet/kubeadm-flags.env&quot;</span></span><br><span class=\"line\">[kubelet-start] Starting the kubelet</span><br><span class=\"line\">[kubelet-check] Waiting <span class=\"keyword\">for</span> a healthy kubelet at http://127.0.0.1:10248/healthz. This can take up to 4m0s</span><br><span class=\"line\">[kubelet-check] The kubelet is healthy after 1.501212696s</span><br><span class=\"line\">[kubelet-start] Waiting <span class=\"keyword\">for</span> the kubelet to perform the TLS Bootstrap</span><br><span class=\"line\"></span><br><span class=\"line\">This node has joined the cluster:</span><br><span class=\"line\">* Certificate signing request was sent to apiserver and a response was received.</span><br><span class=\"line\">* The Kubelet was informed of the new secure connection details.</span><br><span class=\"line\"></span><br><span class=\"line\">Run <span class=\"string\">&#x27;kubectl get nodes&#x27;</span> on the control-plane to see this node <span class=\"built_in\">join</span> the cluster.</span><br><span class=\"line\"></span><br><span class=\"line\">✅ Node 10.75.59.72 joined successfully.</span><br><span class=\"line\">--&gt; Joining node 10.75.59.73 to the cluster...</span><br><span class=\"line\">[preflight] Running pre-flight checks</span><br><span class=\"line\">[preflight] Reading configuration from the <span class=\"string\">&quot;kubeadm-config&quot;</span> ConfigMap <span class=\"keyword\">in</span> namespace <span class=\"string\">&quot;kube-system&quot;</span>...</span><br><span class=\"line\">[preflight] Use <span class=\"string\">&#x27;kubeadm init phase upload-config --config your-config-file&#x27;</span> to re-upload it.</span><br><span class=\"line\">W0801 14:18:07.347008   20684 configset.go:78] Warning: No kubeproxy.config.k8s.io/v1alpha1 config is loaded. Continuing without it: configmaps <span class=\"string\">&quot;kube-proxy&quot;</span> is forbidden: User <span class=\"string\">&quot;system:bootstrap:whltm8&quot;</span> cannot get resource <span class=\"string\">&quot;configmaps&quot;</span> <span class=\"keyword\">in</span> API group <span class=\"string\">&quot;&quot;</span> <span class=\"keyword\">in</span> the namespace <span class=\"string\">&quot;kube-system&quot;</span></span><br><span class=\"line\">[kubelet-start] Writing kubelet configuration to file <span class=\"string\">&quot;/var/lib/kubelet/config.yaml&quot;</span></span><br><span class=\"line\">[kubelet-start] Writing kubelet environment file with flags to file <span class=\"string\">&quot;/var/lib/kubelet/kubeadm-flags.env&quot;</span></span><br><span class=\"line\">[kubelet-start] Starting the kubelet</span><br><span class=\"line\">[kubelet-check] Waiting <span class=\"keyword\">for</span> a healthy kubelet at http://127.0.0.1:10248/healthz. This can take up to 4m0s</span><br><span class=\"line\">[kubelet-check] The kubelet is healthy after 1.002187345s</span><br><span class=\"line\">[kubelet-start] Waiting <span class=\"keyword\">for</span> the kubelet to perform the TLS Bootstrap</span><br><span class=\"line\"></span><br><span class=\"line\">This node has joined the cluster:</span><br><span class=\"line\">* Certificate signing request was sent to apiserver and a response was received.</span><br><span class=\"line\">* The Kubelet was informed of the new secure connection details.</span><br><span class=\"line\"></span><br><span class=\"line\">Run <span class=\"string\">&#x27;kubectl get nodes&#x27;</span> on the control-plane to see this node <span class=\"built_in\">join</span> the cluster.</span><br><span class=\"line\"></span><br><span class=\"line\">✅ Node 10.75.59.73 joined successfully.</span><br><span class=\"line\"><span class=\"comment\">### STEP 4: Installing the Cilium CLI... ###</span></span><br><span class=\"line\">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span><br><span class=\"line\">                                 Dload  Upload   Total   Spent    Left  Speed</span><br><span class=\"line\">  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0</span><br><span class=\"line\">  0     0    0     0    0     0      0      0 --:--:--  0:00:01 --:--:--     0</span><br><span class=\"line\">100 59.2M  100 59.2M    0     0  13.1M      0  0:00:04  0:00:04 --:--:-- 23.8M</span><br><span class=\"line\">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span><br><span class=\"line\">                                 Dload  Upload   Total   Spent    Left  Speed</span><br><span class=\"line\">  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0</span><br><span class=\"line\">  0     0    0     0    0     0      0      0 --:--:--  0:00:01 --:--:--     0</span><br><span class=\"line\">100    92  100    92    0     0     70      0  0:00:01  0:00:01 --:--:--    70</span><br><span class=\"line\">cilium-linux-amd64.tar.gz: OK</span><br><span class=\"line\">cilium</span><br><span class=\"line\">✅ Cilium CLI installed.</span><br><span class=\"line\"><span class=\"comment\">### STEP 5: Configuring Cilium BGP Peering ###</span></span><br><span class=\"line\">--&gt; Applying BGP configuration. <span class=\"string\">&#x27;unchanged&#x27;</span> means it<span class=\"string\">&#x27;s already correct.</span></span><br><span class=\"line\"><span class=\"string\">ciliumbgpadvertisement.cilium.io/bgp-advertisements unchanged</span></span><br><span class=\"line\"><span class=\"string\">ciliumbgppeerconfig.cilium.io/cilium-peer unchanged</span></span><br><span class=\"line\"><span class=\"string\">ciliumbgpclusterconfig.cilium.io/cilium-bgp-default configured</span></span><br><span class=\"line\"><span class=\"string\">✅ BGP configuration applied.</span></span><br><span class=\"line\"><span class=\"string\">### STEP 6: Installing Hubble UI... ###</span></span><br><span class=\"line\"><span class=\"string\">--&gt; Creating hubble-ui-values.yaml...</span></span><br><span class=\"line\"><span class=\"string\">--&gt; Installing Hubble UI with Helm...</span></span><br><span class=\"line\"><span class=\"string\">NAME: hubble-ui</span></span><br><span class=\"line\"><span class=\"string\">LAST DEPLOYED: Fri Aug  1 14:18:18 2025</span></span><br><span class=\"line\"><span class=\"string\">NAMESPACE: kube-system</span></span><br><span class=\"line\"><span class=\"string\">STATUS: deployed</span></span><br><span class=\"line\"><span class=\"string\">REVISION: 1</span></span><br><span class=\"line\"><span class=\"string\">TEST SUITE: None</span></span><br><span class=\"line\"><span class=\"string\">NOTES:</span></span><br><span class=\"line\"><span class=\"string\">You have successfully installed Hubble-Ui.</span></span><br><span class=\"line\"><span class=\"string\">Your release version is 1.3.6.</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">For any further help, visit https://docs.isovalent.com</span></span><br><span class=\"line\"><span class=\"string\">--&gt; Exposing Hubble UI service via NodePort...</span></span><br><span class=\"line\"><span class=\"string\">service/hubble-ui patched</span></span><br><span class=\"line\"><span class=\"string\">✅ Hubble UI installed.</span></span><br><span class=\"line\"><span class=\"string\">### STEP 7: Verifying the Setup... ###</span></span><br><span class=\"line\"><span class=\"string\">--&gt; Waiting for all nodes to be ready...</span></span><br><span class=\"line\"><span class=\"string\">node/kube-node-1 condition met</span></span><br><span class=\"line\"><span class=\"string\">node/kube-node-2 condition met</span></span><br><span class=\"line\"><span class=\"string\">node/kube-node-3 condition met</span></span><br><span class=\"line\"><span class=\"string\">--&gt; Checking Cilium status...</span></span><br><span class=\"line\"><span class=\"string\">    /¯¯\\</span></span><br><span class=\"line\"><span class=\"string\"> /¯¯\\__/¯¯\\    Cilium:             OK</span></span><br><span class=\"line\"><span class=\"string\"> \\__/¯¯\\__/    Operator:           OK</span></span><br><span class=\"line\"><span class=\"string\"> /¯¯\\__/¯¯\\    Envoy DaemonSet:    OK</span></span><br><span class=\"line\"><span class=\"string\"> \\__/¯¯\\__/    Hubble Relay:       OK</span></span><br><span class=\"line\"><span class=\"string\">    \\__/       ClusterMesh:        disabled</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">DaemonSet              cilium                   Desired: 3, Ready: 3/3, Available: 3/3</span></span><br><span class=\"line\"><span class=\"string\">DaemonSet              cilium-envoy             Desired: 3, Ready: 3/3, Available: 3/3</span></span><br><span class=\"line\"><span class=\"string\">Deployment             cilium-operator          Desired: 2, Ready: 2/2, Available: 2/2</span></span><br><span class=\"line\"><span class=\"string\">Deployment             hubble-relay             Desired: 1, Ready: 1/1, Available: 1/1</span></span><br><span class=\"line\"><span class=\"string\">Deployment             hubble-ui                Desired: 1, Ready: 1/1, Available: 1/1</span></span><br><span class=\"line\"><span class=\"string\">Containers:            cilium                   Running: 3</span></span><br><span class=\"line\"><span class=\"string\">                       cilium-envoy             Running: 3</span></span><br><span class=\"line\"><span class=\"string\">                       cilium-operator          Running: 2</span></span><br><span class=\"line\"><span class=\"string\">                       clustermesh-apiserver    </span></span><br><span class=\"line\"><span class=\"string\">                       hubble-relay             Running: 1</span></span><br><span class=\"line\"><span class=\"string\">                       hubble-ui                Running: 1</span></span><br><span class=\"line\"><span class=\"string\">Cluster Pods:          8/8 managed by Cilium</span></span><br><span class=\"line\"><span class=\"string\">Helm chart version:    1.17.6</span></span><br><span class=\"line\"><span class=\"string\">Image versions         cilium             quay.io/isovalent/cilium:v1.17.6-cee.1@sha256:2d01daf4f25f7d644889b49ca856e1a4269981fc963e50bd3962665b41b6adb3: 3</span></span><br><span class=\"line\"><span class=\"string\">                       cilium-envoy       quay.io/isovalent/cilium-envoy:v1.17.6-cee.1@sha256:318eff387835ca2717baab42a84f35a83a5f9e7d519253df87269f80b9ff0171: 3</span></span><br><span class=\"line\"><span class=\"string\">                       cilium-operator    quay.io/isovalent/operator-generic:v1.17.6-cee.1@sha256:2e602710a7c4f101831df679e5d8251bae8bf0f9fe26c20bbef87f1966ea8265: 2</span></span><br><span class=\"line\"><span class=\"string\">                       hubble-relay       quay.io/isovalent/hubble-relay:v1.17.6-cee.1@sha256:d378e3607f7492374e65e2bd854cc0ec87480c63ba49a96dadcd75a6946b586e: 1</span></span><br><span class=\"line\"><span class=\"string\">                       hubble-ui          quay.io/isovalent/hubble-ui-enterprise-backend:v1.3.6: 1</span></span><br><span class=\"line\"><span class=\"string\">                       hubble-ui          quay.io/isovalent/hubble-ui-enterprise:v1.3.6: 1</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">----------------------------------------------------------------</span></span><br><span class=\"line\"><span class=\"string\">🚀 Cluster setup is complete and verified!</span></span><br><span class=\"line\"><span class=\"string\">Access Hubble UI at: http://10.75.59.71:30583</span></span><br><span class=\"line\"><span class=\"string\">----------------------------------------------------------------</span></span><br><span class=\"line\"><span class=\"string\">root@kube-node-1:~# cilium bgp peers</span></span><br><span class=\"line\"><span class=\"string\">Node          Local AS   Peer AS   Peer Address   Session State   Uptime   Family         Received   Advertised</span></span><br><span class=\"line\"><span class=\"string\">kube-node-1   65000      65000     10.75.59.76    established     19m1s    ipv4/unicast   2          8    </span></span><br><span class=\"line\"><span class=\"string\">kube-node-2   65000      65000     10.75.59.76    established     19m2s    ipv4/unicast   2          8    </span></span><br><span class=\"line\"><span class=\"string\">kube-node-3   65000      65000     10.75.59.76    established     19m2s    ipv4/unicast   2          8    </span></span><br><span class=\"line\"><span class=\"string\">root@kube-node-1:~# cilium bgp routes</span></span><br><span class=\"line\"><span class=\"string\">(Defaulting to `available ipv4 unicast` routes, please see help for more options)</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">Node          VRouter   Prefix             NextHop   Age     Attrs</span></span><br><span class=\"line\"><span class=\"string\">kube-node-1   65000     172.16.0.0/24      0.0.0.0   19m8s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span></span><br><span class=\"line\"><span class=\"string\">              65000     172.16.32.1/32     0.0.0.0   19m8s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span></span><br><span class=\"line\"><span class=\"string\">              65000     172.16.32.10/32    0.0.0.0   19m8s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span></span><br><span class=\"line\"><span class=\"string\">              65000     172.16.36.130/32   0.0.0.0   19m8s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span></span><br><span class=\"line\"><span class=\"string\">              65000     172.16.40.165/32   0.0.0.0   19m8s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span></span><br><span class=\"line\"><span class=\"string\">              65000     172.16.43.51/32    0.0.0.0   19m8s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span></span><br><span class=\"line\"><span class=\"string\">              65000     172.16.47.30/32    0.0.0.0   19m8s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span></span><br><span class=\"line\"><span class=\"string\">kube-node-2   65000     172.16.1.0/24      0.0.0.0   19m8s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span></span><br><span class=\"line\"><span class=\"string\">              65000     172.16.32.1/32     0.0.0.0   19m8s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span></span><br><span class=\"line\"><span class=\"string\">              65000     172.16.32.10/32    0.0.0.0   19m8s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span></span><br><span class=\"line\"><span class=\"string\">              65000     172.16.36.130/32   0.0.0.0   19m8s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span></span><br><span class=\"line\"><span class=\"string\">              65000     172.16.40.165/32   0.0.0.0   19m8s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span></span><br><span class=\"line\"><span class=\"string\">              65000     172.16.43.51/32    0.0.0.0   19m8s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span></span><br><span class=\"line\"><span class=\"string\">              65000     172.16.47.30/32    0.0.0.0   19m8s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span></span><br><span class=\"line\"><span class=\"string\">kube-node-3   65000     172.16.2.0/24      0.0.0.0   19m8s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span></span><br><span class=\"line\"><span class=\"string\">              65000     172.16.32.1/32     0.0.0.0   19m8s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span></span><br><span class=\"line\"><span class=\"string\">              65000     172.16.32.10/32    0.0.0.0   19m8s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span></span><br><span class=\"line\"><span class=\"string\">              65000     172.16.36.130/32   0.0.0.0   19m8s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span></span><br><span class=\"line\"><span class=\"string\">              65000     172.16.40.165/32   0.0.0.0   19m8s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span></span><br><span class=\"line\"><span class=\"string\">              65000     172.16.43.51/32    0.0.0.0   19m8s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span></span><br><span class=\"line\"><span class=\"string\">              65000     172.16.47.30/32    0.0.0.0   19m8s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span></span><br><span class=\"line\"><span class=\"string\">root@kube-node-1:~# </span></span><br></pre></td></tr></table></figure>\n<h1 id=\"7-Kubectl-常用命令\"><a href=\"#7-Kubectl-常用命令\" class=\"headerlink\" title=\"7. Kubectl 常用命令\"></a>7. Kubectl 常用命令</h1><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl describe pod hubble-ui-5fdd8b4495-dv7nr -n kube-system</span><br><span class=\"line\"></span><br><span class=\"line\">kubectl get nodes -o wide</span><br><span class=\"line\">kubectl get pods -n kube-system -o wide</span><br><span class=\"line\">kubectl get pods --all-namespaces</span><br><span class=\"line\">kubectl get service -n kube-system -o wide</span><br><span class=\"line\">kubectl get daemonset -n kube-system cilium</span><br><span class=\"line\">kubectl get deployment -o wide</span><br><span class=\"line\"></span><br><span class=\"line\">kubectl get endpoints -n kube-system kube-dns</span><br><span class=\"line\">kubectl get cm cilium-config -n kube-system -o yaml</span><br><span class=\"line\">kubectl get endpoints -n kube-system</span><br><span class=\"line\">kubectl get pods -n kube-system -l k8s-app=cilium -o wide</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">kubectl describe pod hubble-relay-cfb755899-r42l8</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">kubectl -n kube-system get pods -l k8s-app=cilium</span><br><span class=\"line\">kubectl -n kube-system exec ds/cilium -- cilium-dbg bpf ipmasq list</span><br><span class=\"line\">kubectl -n kube-system exec ds/cilium -- cilium-dbg status --verbose</span><br><span class=\"line\">kubectl -n kube-system exec ds/cilium -- cilium status</span><br><span class=\"line\">kubectl -n kube-system exec ds/cilium -- cilium service list</span><br><span class=\"line\">kubectl -n kube-system exec ds/cilium -- cilium bpf nat list</span><br><span class=\"line\">kubectl exec -n kube-system cilium-2vrgj -- cilium bpf nat list</span><br><span class=\"line\"></span><br><span class=\"line\">kubectl -n kube-system get configmap cilium-config -o yaml</span><br><span class=\"line\"></span><br><span class=\"line\">kubectl create namespace star-wars</span><br><span class=\"line\">kubectl apply -n star-wars -f https://raw.githubusercontent.com/cilium/cilium/HEAD/examples/minikube/http-sw-app.yaml</span><br><span class=\"line\">kubectl -n star-wars get pod -o wide --show-labels</span><br><span class=\"line\">kubectl -n star-wars patch service deathstar -p &#x27;&#123;&quot;spec&quot;:&#123;&quot;type&quot;:&quot;NodePort&quot;&#125;&#125;&#x27;</span><br><span class=\"line\">kubectl -n star-wars exec tiefighter --   curl -s -XPOST http://deathstar.star-wars.svc.cluster.local/v1/request-landing</span><br><span class=\"line\">kubectl -n star-wars exec xwing --   curl -s -XPOST http://deathstar.star-wars.svc.cluster.local/v1/request-landing</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">kubectl delete -n star-wars -f https://raw.githubusercontent.com/cilium/cilium/1.18.0/examples/minikube/http-sw-app.yaml</span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">Commands <span class=\"keyword\">for</span> reference only.</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">kubectl delete pod,svc,daemonset -n kube-system -l k8s-app=cilium</span><br><span class=\"line\">kubectl delete daemonset -n kube-system kube-proxy</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">kubectl create deployment nginx --image=nginx</span><br><span class=\"line\">kubectl expose deployment nginx --port=80 --type=ClusterIP</span><br><span class=\"line\"></span><br><span class=\"line\">kubectl run -it --rm busybox --image=busybox --restart=Never -- sh</span><br><span class=\"line\"></span><br><span class=\"line\">kubectl run -it --rm curl --image=curlimages/curl --restart=Never -- sh</span><br><span class=\"line\"></span><br><span class=\"line\">for i in &#123;1..10&#125;; do   kubectl exec -n star-wars tiefighter --     curl -s http://deathstar.default.svc.cluster.local/v1 |     jq -r &#x27;.hostname&#x27;; done</span><br></pre></td></tr></table></figure>","length":19853,"excerpt":"","more":"<h1 id=\"Kubernetes-with-CNI-Cilium-安装学习\"><a href=\"#Kubernetes-with-CNI-Cilium-安装学习\" class=\"headerlink\" title=\"Kubernetes with CNI Cilium 安装学习\"></a>Kubernetes with CNI Cilium 安装学习</h1><h1 id=\"1-使用自动化脚本安装Ubuntu-24-04虚拟机\"><a href=\"#1-使用自动化脚本安装Ubuntu-24-04虚拟机\" class=\"headerlink\" title=\"1. 使用自动化脚本安装Ubuntu 24.04虚拟机\"></a>1. 使用自动化脚本安装Ubuntu 24.04虚拟机</h1><h2 id=\"1-1-准备工作\"><a href=\"#1-1-准备工作\" class=\"headerlink\" title=\"1.1 准备工作\"></a>1.1 准备工作</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">密码加密字符串</span><br><span class=\"line\">ois@ois:~$ mkpasswd --method=SHA-512 --rounds=4096</span><br><span class=\"line\">Password: </span><br><span class=\"line\">$6<span class=\"variable\">$rounds</span>=4096<span class=\"variable\">$LDu9pXXXXXXXXXXXXXXOh</span>/Iunw372/TVfst1</span><br><span class=\"line\"></span><br><span class=\"line\">生成ssh-key，以便实现无密码登录。</span><br><span class=\"line\">ssh-keygen -t rsa -b 4096</span><br><span class=\"line\">Generating public/private rsa key pair.</span><br><span class=\"line\">Enter file <span class=\"keyword\">in</span> <span class=\"built_in\">which</span> to save the key (/root/.ssh/id_rsa): </span><br><span class=\"line\">Enter passphrase (empty <span class=\"keyword\">for</span> no passphrase): </span><br><span class=\"line\">Enter same passphrase again: </span><br><span class=\"line\">Your identification has been saved <span class=\"keyword\">in</span> /root/.ssh/id_rsa</span><br><span class=\"line\">Your public key has been saved <span class=\"keyword\">in</span> /root/.ssh/id_rsa.pub</span><br><span class=\"line\">The key fingerprint is:</span><br><span class=\"line\">SHA256:1+BaD0K3fe6saxPFf41r0SyZEpqhq29AVeRwz+WEXiU </span><br><span class=\"line\">The key<span class=\"string\">&#x27;s randomart image is:</span></span><br><span class=\"line\"><span class=\"string\">+---[RSA 4096]----+</span></span><br><span class=\"line\"><span class=\"string\">|        .o+  .E..|</span></span><br><span class=\"line\"><span class=\"string\">|        .+ o.+.. |</span></span><br><span class=\"line\"><span class=\"string\">|       .. +.oo.  |</span></span><br><span class=\"line\"><span class=\"string\">|      .. o.=o o  |</span></span><br><span class=\"line\"><span class=\"string\">|     .  S.*+oo.B.|</span></span><br><span class=\"line\"><span class=\"string\">|      . .=oooo* *|</span></span><br><span class=\"line\"><span class=\"string\">|       ...  .o.+.|</span></span><br><span class=\"line\"><span class=\"string\">|        o   ooo  |</span></span><br><span class=\"line\"><span class=\"string\">|      .+.  .o=o  |</span></span><br><span class=\"line\"><span class=\"string\">+----[SHA256]-----+</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"1-2-自动化脚本创建虚拟机节点—-由Gemini生成\"><a href=\"#1-2-自动化脚本创建虚拟机节点—-由Gemini生成\" class=\"headerlink\" title=\"1.2 自动化脚本创建虚拟机节点— 由Gemini生成\"></a>1.2 自动化脚本创建虚拟机节点— 由Gemini生成</h2><h3 id=\"create-vms-sh\"><a href=\"#create-vms-sh\" class=\"headerlink\" title=\"create-vms.sh\"></a>create-vms.sh</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#!/bin/bash</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># --- Configuration ---</span></span><br><span class=\"line\">BASE_IMAGE_PATH=<span class=\"string\">&quot;/home/ois/data/vmimages/noble-server-cloudimg-amd64.img&quot;</span></span><br><span class=\"line\">VM_IMAGE_DIR=<span class=\"string\">&quot;/home/ois/data/k8s/nodevms&quot;</span></span><br><span class=\"line\">VM_CONFIG_DIR=<span class=\"string\">&quot;/home/ois/data/k8s/nodevm_cfg&quot;</span></span><br><span class=\"line\">RAM_MB=8192</span><br><span class=\"line\">VCPUS=4</span><br><span class=\"line\">DISK_SIZE_GB=20 <span class=\"comment\"># &lt;--- ADDED: Increased disk size to 20 GB</span></span><br><span class=\"line\">BRIDGE_INTERFACE=<span class=\"string\">&quot;br0&quot;</span></span><br><span class=\"line\">BASE_IP=<span class=\"string\">&quot;10.75.59&quot;</span></span><br><span class=\"line\">NETWORK_PREFIX=<span class=\"string\">&quot;/24&quot;</span></span><br><span class=\"line\">GATEWAY=<span class=\"string\">&quot;10.75.59.1&quot;</span></span><br><span class=\"line\">NAMESERVER1=<span class=\"string\">&quot;64.104.76.247&quot;</span></span><br><span class=\"line\">NAMESERVER2=<span class=\"string\">&quot;64.104.14.184&quot;</span></span><br><span class=\"line\">SEARCH_DOMAIN=<span class=\"string\">&quot;cisco.com&quot;</span></span><br><span class=\"line\">VNC_PORT_START=5905 <span class=\"comment\"># VNC ports will be 5905, 5906, 5907</span></span><br><span class=\"line\">PASSWORD_HASH=<span class=\"string\">&#x27;$6$rounds=4096$LDu9pXXXXXXXXXXXXXXOh/Iunw372/TVfst1&#x27;</span></span><br><span class=\"line\">SSH_PUB_KEY=$(<span class=\"built_in\">cat</span> ~/.ssh/id_rsa.pub)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># --- Loop to create 3 VMs ---</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> &#123;1..3&#125;; <span class=\"keyword\">do</span></span><br><span class=\"line\">    VM_NAME=<span class=\"string\">&quot;kube-node-<span class=\"variable\">$i</span>&quot;</span></span><br><span class=\"line\">    VM_IP=<span class=\"string\">&quot;<span class=\"variable\">$&#123;BASE_IP&#125;</span>.<span class=\"subst\">$((70 + i)</span>)&quot;</span> <span class=\"comment\"># IPs will be 10.75.59.71, 10.75.59.72, 10.75.59.73</span></span><br><span class=\"line\">    VM_IMAGE_PATH=<span class=\"string\">&quot;<span class=\"variable\">$&#123;VM_IMAGE_DIR&#125;</span>/<span class=\"variable\">$&#123;VM_NAME&#125;</span>.qcow2&quot;</span></span><br><span class=\"line\">    VM_VNC_PORT=$((VNC_PORT_START + i - <span class=\"number\">1</span>)) <span class=\"comment\"># VNC ports will be 5905, 5906, 5907</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;--- Preparing for <span class=\"variable\">$VM_NAME</span> (IP: <span class=\"variable\">$VM_IP</span>) ---&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># Create directories if they don&#x27;t exist</span></span><br><span class=\"line\">    <span class=\"built_in\">mkdir</span> -p <span class=\"string\">&quot;<span class=\"variable\">$VM_IMAGE_DIR</span>&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">mkdir</span> -p <span class=\"string\">&quot;<span class=\"variable\">$VM_CONFIG_DIR</span>&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># Create a fresh image for each VM</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> [ -f <span class=\"string\">&quot;<span class=\"variable\">$VM_IMAGE_PATH</span>&quot;</span> ]; <span class=\"keyword\">then</span></span><br><span class=\"line\">        <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Removing existing image for <span class=\"variable\">$VM_NAME</span>...&quot;</span></span><br><span class=\"line\">        <span class=\"built_in\">rm</span> <span class=\"string\">&quot;<span class=\"variable\">$VM_IMAGE_PATH</span>&quot;</span></span><br><span class=\"line\">    <span class=\"keyword\">fi</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Copying base image to <span class=\"variable\">$VM_IMAGE_PATH</span>...&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">cp</span> <span class=\"string\">&quot;<span class=\"variable\">$BASE_IMAGE_PATH</span>&quot;</span> <span class=\"string\">&quot;<span class=\"variable\">$VM_IMAGE_PATH</span>&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># --- NEW: Resize the copied image before virt-install ---</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Resizing VM image to <span class=\"variable\">$&#123;DISK_SIZE_GB&#125;</span>GB...&quot;</span></span><br><span class=\"line\">    qemu-img resize <span class=\"string\">&quot;<span class=\"variable\">$VM_IMAGE_PATH</span>&quot;</span> <span class=\"string\">&quot;<span class=\"variable\">$&#123;DISK_SIZE_GB&#125;</span>G&quot;</span></span><br><span class=\"line\">    <span class=\"comment\"># --- END NEW ---</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># Generate user-data for the current VM</span></span><br><span class=\"line\">    USER_DATA_FILE=<span class=\"string\">&quot;<span class=\"variable\">$&#123;VM_CONFIG_DIR&#125;</span>/<span class=\"variable\">$&#123;VM_NAME&#125;</span>_user-data&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOF &gt; &quot;$USER_DATA_FILE&quot;</span></span><br><span class=\"line\"><span class=\"string\">#cloud-config</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">locale: en_US</span></span><br><span class=\"line\"><span class=\"string\">keyboard:</span></span><br><span class=\"line\"><span class=\"string\">  layout: us</span></span><br><span class=\"line\"><span class=\"string\">timezone: Asia/Shanghai</span></span><br><span class=\"line\"><span class=\"string\">hostname: $&#123;VM_NAME&#125;</span></span><br><span class=\"line\"><span class=\"string\">create_hostname_file: true</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">ssh_pwauth: yes</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">groups:</span></span><br><span class=\"line\"><span class=\"string\">  - ubuntu</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">users:</span></span><br><span class=\"line\"><span class=\"string\">  - name: ubuntu</span></span><br><span class=\"line\"><span class=\"string\">    gecos: ubuntu</span></span><br><span class=\"line\"><span class=\"string\">    primary_group: ubuntu</span></span><br><span class=\"line\"><span class=\"string\">    groups: sudo, cdrom</span></span><br><span class=\"line\"><span class=\"string\">    sudo: ALL=(ALL:ALL) ALL</span></span><br><span class=\"line\"><span class=\"string\">    shell: /bin/bash</span></span><br><span class=\"line\"><span class=\"string\">    lock_passwd: false</span></span><br><span class=\"line\"><span class=\"string\">    passwd: $&#123;PASSWORD_HASH&#125;</span></span><br><span class=\"line\"><span class=\"string\">    ssh_authorized_keys:</span></span><br><span class=\"line\"><span class=\"string\">      - &quot;$&#123;SSH_PUB_KEY&#125;&quot;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">apt:</span></span><br><span class=\"line\"><span class=\"string\">  primary:</span></span><br><span class=\"line\"><span class=\"string\">    - arches: [default]</span></span><br><span class=\"line\"><span class=\"string\">      uri: http://us.archive.ubuntu.com/ubuntu/</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">packages:</span></span><br><span class=\"line\"><span class=\"string\">  - openssh-server</span></span><br><span class=\"line\"><span class=\"string\">  - net-tools</span></span><br><span class=\"line\"><span class=\"string\">  - iftop</span></span><br><span class=\"line\"><span class=\"string\">  - htop</span></span><br><span class=\"line\"><span class=\"string\">  - iperf3</span></span><br><span class=\"line\"><span class=\"string\">  - vim</span></span><br><span class=\"line\"><span class=\"string\">  - curl</span></span><br><span class=\"line\"><span class=\"string\">  - wget</span></span><br><span class=\"line\"><span class=\"string\">  - cloud-guest-utils # Ensure growpart is available</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">ntp:</span></span><br><span class=\"line\"><span class=\"string\">  servers: [&#x27;ntp.esl.cisco.com&#x27;]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">runcmd:</span></span><br><span class=\"line\"><span class=\"string\">  - echo &quot;Attempting to resize root partition and filesystem...&quot;</span></span><br><span class=\"line\"><span class=\"string\">  - growpart /dev/vda 1 # Expand the first partition on /dev/vda</span></span><br><span class=\"line\"><span class=\"string\">  - resize2fs /dev/vda1 # Expand the ext4 filesystem on /dev/vda1</span></span><br><span class=\"line\"><span class=\"string\">  - echo &quot;Disk resize commands executed. Verify with &#x27;df -h&#x27; after boot.&quot;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># Generate network-config for the current VM</span></span><br><span class=\"line\">    NETWORK_CONFIG_FILE=<span class=\"string\">&quot;<span class=\"variable\">$&#123;VM_CONFIG_DIR&#125;</span>/<span class=\"variable\">$&#123;VM_NAME&#125;</span>_network-config&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOF &gt; &quot;$NETWORK_CONFIG_FILE&quot;</span></span><br><span class=\"line\"><span class=\"string\">network:</span></span><br><span class=\"line\"><span class=\"string\">  version: 2</span></span><br><span class=\"line\"><span class=\"string\">  ethernets:</span></span><br><span class=\"line\"><span class=\"string\">    enp1s0:</span></span><br><span class=\"line\"><span class=\"string\">      addresses:</span></span><br><span class=\"line\"><span class=\"string\">      - &quot;$&#123;VM_IP&#125;$&#123;NETWORK_PREFIX&#125;&quot;</span></span><br><span class=\"line\"><span class=\"string\">      nameservers:</span></span><br><span class=\"line\"><span class=\"string\">        addresses:</span></span><br><span class=\"line\"><span class=\"string\">        - $&#123;NAMESERVER1&#125;</span></span><br><span class=\"line\"><span class=\"string\">        - $&#123;NAMESERVER2&#125;</span></span><br><span class=\"line\"><span class=\"string\">        search:</span></span><br><span class=\"line\"><span class=\"string\">        - $&#123;SEARCH_DOMAIN&#125;</span></span><br><span class=\"line\"><span class=\"string\">      routes:</span></span><br><span class=\"line\"><span class=\"string\">      - to: &quot;default&quot;</span></span><br><span class=\"line\"><span class=\"string\">        via: &quot;$&#123;GATEWAY&#125;&quot;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># Generate meta-data (can be static for now)</span></span><br><span class=\"line\">    META_DATA_FILE=<span class=\"string\">&quot;<span class=\"variable\">$&#123;VM_CONFIG_DIR&#125;</span>/<span class=\"variable\">$&#123;VM_NAME&#125;</span>_meta-data&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOF &gt; &quot;$META_DATA_FILE&quot;</span></span><br><span class=\"line\"><span class=\"string\">instance-id: $&#123;VM_NAME&#125;</span></span><br><span class=\"line\"><span class=\"string\">local-hostname: $&#123;VM_NAME&#125;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;--- Installing <span class=\"variable\">$VM_NAME</span> ---&quot;</span></span><br><span class=\"line\">    virt-install --name <span class=\"string\">&quot;<span class=\"variable\">$&#123;VM_NAME&#125;</span>&quot;</span> --ram <span class=\"string\">&quot;<span class=\"variable\">$&#123;RAM_MB&#125;</span>&quot;</span> --vcpus <span class=\"string\">&quot;<span class=\"variable\">$&#123;VCPUS&#125;</span>&quot;</span> --noreboot \\</span><br><span class=\"line\">        --os-variant ubuntu24.04 \\</span><br><span class=\"line\">        --network bridge=<span class=\"string\">&quot;<span class=\"variable\">$&#123;BRIDGE_INTERFACE&#125;</span>&quot;</span> \\</span><br><span class=\"line\">        --graphics vnc,listen=0.0.0.0,port=<span class=\"string\">&quot;<span class=\"variable\">$&#123;VM_VNC_PORT&#125;</span>&quot;</span> \\</span><br><span class=\"line\">        --disk path=<span class=\"string\">&quot;<span class=\"variable\">$&#123;VM_IMAGE_PATH&#125;</span>&quot;</span>,format=qcow2 \\</span><br><span class=\"line\">        --console pty,target_type=serial \\</span><br><span class=\"line\">        --cloud-init user-data=<span class=\"string\">&quot;<span class=\"variable\">$&#123;USER_DATA_FILE&#125;</span>&quot;</span>,meta-data=<span class=\"string\">&quot;<span class=\"variable\">$&#123;META_DATA_FILE&#125;</span>&quot;</span>,network-config=<span class=\"string\">&quot;<span class=\"variable\">$&#123;NETWORK_CONFIG_FILE&#125;</span>&quot;</span> \\</span><br><span class=\"line\">        --import \\</span><br><span class=\"line\">        --<span class=\"built_in\">wait</span> 0</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Successfully initiated creation of <span class=\"variable\">$VM_NAME</span>.&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;You can connect to VNC on port <span class=\"variable\">$&#123;VM_VNC_PORT&#125;</span> to monitor installation (optional).&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Wait a few minutes for the VM to boot and cloud-init to run.&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;--------------------------------------------------------&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">done</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;All 3 VMs have been initiated. Please wait for them to fully provision.&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;You can SSH into them using &#x27;ssh ubuntu@&lt;IP_ADDRESS&gt;&#x27; where IP addresses are 10.75.59.71, 10.75.59.72, 10.75.59.73.&quot;</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>上述脚本可自动生成三个虚拟机，并可以使用 ssh <a href=\"mailto:&#x75;&#98;&#x75;&#x6e;&#116;&#x75;&#64;&#x31;&#x30;&#x2e;&#x37;&#x35;&#x2e;&#53;&#57;&#x2e;&#55;&#x31;\">&#x75;&#98;&#x75;&#x6e;&#116;&#x75;&#64;&#x31;&#x30;&#x2e;&#x37;&#x35;&#x2e;&#53;&#57;&#x2e;&#55;&#x31;</a> 登录</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">chmod</span> +x create-vms.sh</span><br><span class=\"line\"></span><br><span class=\"line\">ois@ois:~/data/k8s$ ./create-vms.sh </span><br><span class=\"line\">--- Preparing <span class=\"keyword\">for</span> kube-node-1 (IP: 10.75.59.71) ---</span><br><span class=\"line\">Removing existing image <span class=\"keyword\">for</span> kube-node-1...</span><br><span class=\"line\">Copying base image to /home/ois/data/k8s/nodevms/kube-node-1.qcow2...</span><br><span class=\"line\">Resizing VM image to 20GB...</span><br><span class=\"line\">Image resized.</span><br><span class=\"line\">--- Installing kube-node-1 ---</span><br><span class=\"line\">WARNING  Treating --<span class=\"built_in\">wait</span> 0 as --noautoconsole</span><br><span class=\"line\"></span><br><span class=\"line\">Starting install...</span><br><span class=\"line\">Allocating <span class=\"string\">&#x27;virtinst-3jev55ba-cloudinit.iso&#x27;</span>                                                                                                                                                                                             |    0 B  00:00:00 ... </span><br><span class=\"line\">Transferring <span class=\"string\">&#x27;virtinst-3jev55ba-cloudinit.iso&#x27;</span>                                                                                                                                                                                           |    0 B  00:00:00 ... </span><br><span class=\"line\">Creating domain...                                                                                                                                                                                                                       |    0 B  00:00:00     </span><br><span class=\"line\">Domain creation completed.</span><br><span class=\"line\">Successfully initiated creation of kube-node-1.</span><br><span class=\"line\">You can connect to VNC on port 5905 to monitor installation (optional).</span><br><span class=\"line\">Wait a few minutes <span class=\"keyword\">for</span> the VM to boot and cloud-init to run.</span><br><span class=\"line\">--------------------------------------------------------</span><br><span class=\"line\">--- Preparing <span class=\"keyword\">for</span> kube-node-2 (IP: 10.75.59.72) ---</span><br><span class=\"line\">Removing existing image <span class=\"keyword\">for</span> kube-node-2...</span><br><span class=\"line\">Copying base image to /home/ois/data/k8s/nodevms/kube-node-2.qcow2...</span><br><span class=\"line\">Resizing VM image to 20GB...</span><br><span class=\"line\">Image resized.</span><br><span class=\"line\">--- Installing kube-node-2 ---</span><br><span class=\"line\">WARNING  Treating --<span class=\"built_in\">wait</span> 0 as --noautoconsole</span><br><span class=\"line\"></span><br><span class=\"line\">Starting install...</span><br><span class=\"line\">Allocating <span class=\"string\">&#x27;virtinst-c4ruhql3-cloudinit.iso&#x27;</span>                                                                                                                                                                                             |    0 B  00:00:00 ... </span><br><span class=\"line\">Transferring <span class=\"string\">&#x27;virtinst-c4ruhql3-cloudinit.iso&#x27;</span>                                                                                                                                                                                           |    0 B  00:00:00 ... </span><br><span class=\"line\">Creating domain...                                                                                                                                                                                                                       |    0 B  00:00:00     </span><br><span class=\"line\">Domain creation completed.</span><br><span class=\"line\">Successfully initiated creation of kube-node-2.</span><br><span class=\"line\">You can connect to VNC on port 5906 to monitor installation (optional).</span><br><span class=\"line\">Wait a few minutes <span class=\"keyword\">for</span> the VM to boot and cloud-init to run.</span><br><span class=\"line\">--------------------------------------------------------</span><br><span class=\"line\">--- Preparing <span class=\"keyword\">for</span> kube-node-3 (IP: 10.75.59.73) ---</span><br><span class=\"line\">Removing existing image <span class=\"keyword\">for</span> kube-node-3...</span><br><span class=\"line\">Copying base image to /home/ois/data/k8s/nodevms/kube-node-3.qcow2...</span><br><span class=\"line\">Resizing VM image to 20GB...</span><br><span class=\"line\">Image resized.</span><br><span class=\"line\">--- Installing kube-node-3 ---</span><br><span class=\"line\">WARNING  Treating --<span class=\"built_in\">wait</span> 0 as --noautoconsole</span><br><span class=\"line\"></span><br><span class=\"line\">Starting install...</span><br><span class=\"line\">Allocating <span class=\"string\">&#x27;virtinst-u5e8k9a9-cloudinit.iso&#x27;</span>                                                                                                                                                                                             |    0 B  00:00:00 ... </span><br><span class=\"line\">Transferring <span class=\"string\">&#x27;virtinst-u5e8k9a9-cloudinit.iso&#x27;</span>                                                                                                                                                                                           |    0 B  00:00:00 ... </span><br><span class=\"line\">Creating domain...                                                                                                                                                                                                                       |    0 B  00:00:00     </span><br><span class=\"line\">Domain creation completed.</span><br><span class=\"line\">Successfully initiated creation of kube-node-3.</span><br><span class=\"line\">You can connect to VNC on port 5907 to monitor installation (optional).</span><br><span class=\"line\">Wait a few minutes <span class=\"keyword\">for</span> the VM to boot and cloud-init to run.</span><br><span class=\"line\">--------------------------------------------------------</span><br><span class=\"line\">All 3 VMs have been initiated. Please <span class=\"built_in\">wait</span> <span class=\"keyword\">for</span> them to fully provision.</span><br><span class=\"line\">You can SSH into them using <span class=\"string\">&#x27;ssh ubuntu@&lt;IP_ADDRESS&gt;&#x27;</span> <span class=\"built_in\">where</span> IP addresses are 10.75.59.71, 10.75.59.72, 10.75.59.73.</span><br><span class=\"line\"></span><br><span class=\"line\">ois@ois:~/data/k8s$ virsh list</span><br><span class=\"line\"> Id   Name                  State</span><br><span class=\"line\">-------------------------------------</span><br><span class=\"line\"> 83   kube-node-1           running</span><br><span class=\"line\"> 84   kube-node-2           running</span><br><span class=\"line\"> 85   kube-node-3           running</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"user-data-示例\"><a href=\"#user-data-示例\" class=\"headerlink\" title=\"user-data 示例\"></a>user-data 示例</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#cloud-config</span></span><br><span class=\"line\"></span><br><span class=\"line\">locale: en_US</span><br><span class=\"line\">keyboard:</span><br><span class=\"line\">  layout: us</span><br><span class=\"line\">timezone: Asia/Shanghai</span><br><span class=\"line\">hostname: kube-node-1</span><br><span class=\"line\">create_hostname_file: <span class=\"literal\">true</span></span><br><span class=\"line\"></span><br><span class=\"line\">ssh_pwauth: <span class=\"built_in\">yes</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">groups</span>:</span><br><span class=\"line\">  - ubuntu</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">users</span>:</span><br><span class=\"line\">  - name: ubuntu</span><br><span class=\"line\">    gecos: ubuntu</span><br><span class=\"line\">    primary_group: ubuntu</span><br><span class=\"line\">    <span class=\"built_in\">groups</span>: <span class=\"built_in\">sudo</span>, cdrom</span><br><span class=\"line\">    <span class=\"built_in\">sudo</span>: ALL=(ALL:ALL) ALL</span><br><span class=\"line\">    shell: /bin/bash</span><br><span class=\"line\">    lock_passwd: <span class=\"literal\">false</span></span><br><span class=\"line\">    passwd: $6<span class=\"variable\">$rounds</span>=4096<span class=\"variable\">$LDu9pXXXXXXXXXXXXXXOh</span>/Iunw372/TVfst1</span><br><span class=\"line\">    ssh_authorized_keys:</span><br><span class=\"line\">      - <span class=\"string\">&quot;ssh-rsa AAAAB3NzaC1yXXXXXXXXXX==&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">apt:</span><br><span class=\"line\">  primary:</span><br><span class=\"line\">    - arches: [default]</span><br><span class=\"line\">      uri: http://us.archive.ubuntu.com/ubuntu/</span><br><span class=\"line\"></span><br><span class=\"line\">packages:</span><br><span class=\"line\">  - openssh-server</span><br><span class=\"line\">  - net-tools</span><br><span class=\"line\">  - iftop</span><br><span class=\"line\">  - htop</span><br><span class=\"line\">  - iperf3</span><br><span class=\"line\">  - vim</span><br><span class=\"line\">  - curl</span><br><span class=\"line\">  - wget</span><br><span class=\"line\">  - cloud-guest-utils <span class=\"comment\"># Ensure growpart is available</span></span><br><span class=\"line\"></span><br><span class=\"line\">ntp:</span><br><span class=\"line\">  servers: [<span class=\"string\">&#x27;ntp.esl.cisco.com&#x27;</span>]</span><br><span class=\"line\"></span><br><span class=\"line\">runcmd:</span><br><span class=\"line\">  - <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Attempting to resize root partition and filesystem...&quot;</span></span><br><span class=\"line\">  - growpart /dev/vda 1 <span class=\"comment\"># Expand the first partition on /dev/vda</span></span><br><span class=\"line\">  - resize2fs /dev/vda1 <span class=\"comment\"># Expand the ext4 filesystem on /dev/vda1</span></span><br><span class=\"line\">  - <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Disk resize commands executed. Verify with &#x27;df -h&#x27; after boot.&quot;</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"network-config\"><a href=\"#network-config\" class=\"headerlink\" title=\"network-config\"></a>network-config</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">network:</span><br><span class=\"line\">  version: 2</span><br><span class=\"line\">  ethernets:</span><br><span class=\"line\">    enp1s0:</span><br><span class=\"line\">      addresses:</span><br><span class=\"line\">      - <span class=\"string\">&quot;10.75.59.71/24&quot;</span></span><br><span class=\"line\">      nameservers:</span><br><span class=\"line\">        addresses:</span><br><span class=\"line\">        - 64.104.76.247</span><br><span class=\"line\">        - 64.104.14.184</span><br><span class=\"line\">        search:</span><br><span class=\"line\">        - cisco.com</span><br><span class=\"line\">      routes:</span><br><span class=\"line\">      - to: <span class=\"string\">&quot;default&quot;</span></span><br><span class=\"line\">        via: <span class=\"string\">&quot;10.75.59.1&quot;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"meta-data\"><a href=\"#meta-data\" class=\"headerlink\" title=\"meta-data\"></a>meta-data</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">instance-id: kube-node-1</span><br><span class=\"line\">local-hostname: kube-node-1</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"2-使用Ansible安装Kubernetes\"><a href=\"#2-使用Ansible安装Kubernetes\" class=\"headerlink\" title=\"2. 使用Ansible安装Kubernetes\"></a>2. 使用Ansible安装Kubernetes</h1><h2 id=\"2-1-脚本内容\"><a href=\"#2-1-脚本内容\" class=\"headerlink\" title=\"2.1 脚本内容\"></a>2.1 脚本内容</h2><p>以下脚本可用于自动化安装Ansible，并生成Playbook，可直接执行安装任务。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br><span class=\"line\">252</span><br><span class=\"line\">253</span><br><span class=\"line\">254</span><br><span class=\"line\">255</span><br><span class=\"line\">256</span><br><span class=\"line\">257</span><br><span class=\"line\">258</span><br><span class=\"line\">259</span><br><span class=\"line\">260</span><br><span class=\"line\">261</span><br><span class=\"line\">262</span><br><span class=\"line\">263</span><br><span class=\"line\">264</span><br><span class=\"line\">265</span><br><span class=\"line\">266</span><br><span class=\"line\">267</span><br><span class=\"line\">268</span><br><span class=\"line\">269</span><br><span class=\"line\">270</span><br><span class=\"line\">271</span><br><span class=\"line\">272</span><br><span class=\"line\">273</span><br><span class=\"line\">274</span><br><span class=\"line\">275</span><br><span class=\"line\">276</span><br><span class=\"line\">277</span><br><span class=\"line\">278</span><br><span class=\"line\">279</span><br><span class=\"line\">280</span><br><span class=\"line\">281</span><br><span class=\"line\">282</span><br><span class=\"line\">283</span><br><span class=\"line\">284</span><br><span class=\"line\">285</span><br><span class=\"line\">286</span><br><span class=\"line\">287</span><br><span class=\"line\">288</span><br><span class=\"line\">289</span><br><span class=\"line\">290</span><br><span class=\"line\">291</span><br><span class=\"line\">292</span><br><span class=\"line\">293</span><br><span class=\"line\">294</span><br><span class=\"line\">295</span><br><span class=\"line\">296</span><br><span class=\"line\">297</span><br><span class=\"line\">298</span><br><span class=\"line\">299</span><br><span class=\"line\">300</span><br><span class=\"line\">301</span><br><span class=\"line\">302</span><br><span class=\"line\">303</span><br><span class=\"line\">304</span><br><span class=\"line\">305</span><br><span class=\"line\">306</span><br><span class=\"line\">307</span><br><span class=\"line\">308</span><br><span class=\"line\">309</span><br><span class=\"line\">310</span><br><span class=\"line\">311</span><br><span class=\"line\">312</span><br><span class=\"line\">313</span><br><span class=\"line\">314</span><br><span class=\"line\">315</span><br><span class=\"line\">316</span><br><span class=\"line\">317</span><br><span class=\"line\">318</span><br><span class=\"line\">319</span><br><span class=\"line\">320</span><br><span class=\"line\">321</span><br><span class=\"line\">322</span><br><span class=\"line\">323</span><br><span class=\"line\">324</span><br><span class=\"line\">325</span><br><span class=\"line\">326</span><br><span class=\"line\">327</span><br><span class=\"line\">328</span><br><span class=\"line\">329</span><br><span class=\"line\">330</span><br><span class=\"line\">331</span><br><span class=\"line\">332</span><br><span class=\"line\">333</span><br><span class=\"line\">334</span><br><span class=\"line\">335</span><br><span class=\"line\">336</span><br><span class=\"line\">337</span><br><span class=\"line\">338</span><br><span class=\"line\">339</span><br><span class=\"line\">340</span><br><span class=\"line\">341</span><br><span class=\"line\">342</span><br><span class=\"line\">343</span><br><span class=\"line\">344</span><br><span class=\"line\">345</span><br><span class=\"line\">346</span><br><span class=\"line\">347</span><br><span class=\"line\">348</span><br><span class=\"line\">349</span><br><span class=\"line\">350</span><br><span class=\"line\">351</span><br><span class=\"line\">352</span><br><span class=\"line\">353</span><br><span class=\"line\">354</span><br><span class=\"line\">355</span><br><span class=\"line\">356</span><br><span class=\"line\">357</span><br><span class=\"line\">358</span><br><span class=\"line\">359</span><br><span class=\"line\">360</span><br><span class=\"line\">361</span><br><span class=\"line\">362</span><br><span class=\"line\">363</span><br><span class=\"line\">364</span><br><span class=\"line\">365</span><br><span class=\"line\">366</span><br><span class=\"line\">367</span><br><span class=\"line\">368</span><br><span class=\"line\">369</span><br><span class=\"line\">370</span><br><span class=\"line\">371</span><br><span class=\"line\">372</span><br><span class=\"line\">373</span><br><span class=\"line\">374</span><br><span class=\"line\">375</span><br><span class=\"line\">376</span><br><span class=\"line\">377</span><br><span class=\"line\">378</span><br><span class=\"line\">379</span><br><span class=\"line\">380</span><br><span class=\"line\">381</span><br><span class=\"line\">382</span><br><span class=\"line\">383</span><br><span class=\"line\">384</span><br><span class=\"line\">385</span><br><span class=\"line\">386</span><br><span class=\"line\">387</span><br><span class=\"line\">388</span><br><span class=\"line\">389</span><br><span class=\"line\">390</span><br><span class=\"line\">391</span><br><span class=\"line\">392</span><br><span class=\"line\">393</span><br><span class=\"line\">394</span><br><span class=\"line\">395</span><br><span class=\"line\">396</span><br><span class=\"line\">397</span><br><span class=\"line\">398</span><br><span class=\"line\">399</span><br><span class=\"line\">400</span><br><span class=\"line\">401</span><br><span class=\"line\">402</span><br><span class=\"line\">403</span><br><span class=\"line\">404</span><br><span class=\"line\">405</span><br><span class=\"line\">406</span><br><span class=\"line\">407</span><br><span class=\"line\">408</span><br><span class=\"line\">409</span><br><span class=\"line\">410</span><br><span class=\"line\">411</span><br><span class=\"line\">412</span><br><span class=\"line\">413</span><br><span class=\"line\">414</span><br><span class=\"line\">415</span><br><span class=\"line\">416</span><br><span class=\"line\">417</span><br><span class=\"line\">418</span><br><span class=\"line\">419</span><br><span class=\"line\">420</span><br><span class=\"line\">421</span><br><span class=\"line\">422</span><br><span class=\"line\">423</span><br><span class=\"line\">424</span><br><span class=\"line\">425</span><br><span class=\"line\">426</span><br><span class=\"line\">427</span><br><span class=\"line\">428</span><br><span class=\"line\">429</span><br><span class=\"line\">430</span><br><span class=\"line\">431</span><br><span class=\"line\">432</span><br><span class=\"line\">433</span><br><span class=\"line\">434</span><br><span class=\"line\">435</span><br><span class=\"line\">436</span><br><span class=\"line\">437</span><br><span class=\"line\">438</span><br><span class=\"line\">439</span><br><span class=\"line\">440</span><br><span class=\"line\">441</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#!/bin/bash</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># This script automates the setup of an Ansible environment for Kubernetes cluster deployment.</span></span><br><span class=\"line\"><span class=\"comment\"># It installs Ansible, creates the project directory, inventory, configuration,</span></span><br><span class=\"line\"><span class=\"comment\"># and defines common Kubernetes setup tasks.</span></span><br><span class=\"line\"><span class=\"comment\"># This version stops after installing Kubernetes components, allowing manual kubeadm init/join.</span></span><br><span class=\"line\"><span class=\"comment\"># Includes a robust fix for Containerd&#x27;s SystemdCgroup configuration and CRI plugin enabling,</span></span><br><span class=\"line\"><span class=\"comment\"># defines the necessary handler for restarting Containerd, dynamically adds host entries to /etc/hosts,</span></span><br><span class=\"line\"><span class=\"comment\"># and updates the pause image version in the manual instructions.</span></span><br><span class=\"line\"><span class=\"comment\"># This update also addresses the runc runtime root configuration in containerd and fixes</span></span><br><span class=\"line\"><span class=\"comment\"># YAML escape character issues in the hosts file regex, and updates the sandbox image in containerd config.</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># --- Configuration ---</span></span><br><span class=\"line\">PROJECT_DIR=<span class=\"string\">&quot;k8s_cluster_setup&quot;</span></span><br><span class=\"line\">MASTER_NODE_IP=<span class=\"string\">&quot;10.75.59.71&quot;</span> <span class=\"comment\"># Based on your previous script&#x27;s IP assignment for kube-node-1</span></span><br><span class=\"line\">WORKER_NODE_IP_1=<span class=\"string\">&quot;10.75.59.72&quot;</span> <span class=\"comment\"># Based on your previous script&#x27;s IP assignment for kube-node-2</span></span><br><span class=\"line\">WORKER_NODE_IP_2=<span class=\"string\">&quot;10.75.59.73&quot;</span> <span class=\"comment\"># Based on your previous script&#x27;s IP address for kube-node-3</span></span><br><span class=\"line\">ANSIBLE_USER=<span class=\"string\">&quot;ubuntu&quot;</span> <span class=\"comment\"># The user created by cloud-init on your VMs</span></span><br><span class=\"line\">SSH_PRIVATE_KEY_PATH=<span class=\"string\">&quot;~/.ssh/id_rsa&quot;</span> <span class=\"comment\"># Path to your SSH private key on the Ansible control machine</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># --- Functions ---</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Function to install Ansible</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">install_ansible</span></span>() &#123;</span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;--- Installing Ansible ---&quot;</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> ! <span class=\"built_in\">command</span> -v ansible &amp;&gt; /dev/null; <span class=\"keyword\">then</span></span><br><span class=\"line\">        <span class=\"built_in\">sudo</span> apt update -y</span><br><span class=\"line\">        <span class=\"built_in\">sudo</span> apt install -y ansible</span><br><span class=\"line\">        <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Ansible installed successfully.&quot;</span></span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">        <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Ansible is already installed.&quot;</span></span><br><span class=\"line\">    <span class=\"keyword\">fi</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Function to create project directory and navigate into it</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">create_project_dir</span></span>() &#123;</span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;--- Creating project directory: <span class=\"variable\">$&#123;PROJECT_DIR&#125;</span> ---&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">mkdir</span> -p <span class=\"string\">&quot;<span class=\"variable\">$&#123;PROJECT_DIR&#125;</span>&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">cd</span> <span class=\"string\">&quot;<span class=\"variable\">$&#123;PROJECT_DIR&#125;</span>&quot;</span> || &#123; <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Failed to change directory to <span class=\"variable\">$&#123;PROJECT_DIR&#125;</span>. Exiting.&quot;</span>; <span class=\"built_in\">exit</span> 1; &#125;</span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Changed to directory: <span class=\"subst\">$(pwd)</span>&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Function to create ansible.cfg</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">create_ansible_cfg</span></span>() &#123;</span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;--- Creating ansible.cfg ---&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOF &gt; ansible.cfg</span></span><br><span class=\"line\"><span class=\"string\">[defaults]</span></span><br><span class=\"line\"><span class=\"string\">inventory = inventory.ini</span></span><br><span class=\"line\"><span class=\"string\">roles_path = ./roles</span></span><br><span class=\"line\"><span class=\"string\">host_key_checking = False # WARNING: Disable host key checking for convenience during initial setup. Re-enable for production!</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;ansible.cfg created.&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Function to create inventory.ini (UPDATED with IP variables)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">create_inventory</span></span>() &#123;</span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;--- Creating inventory.ini ---&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOF &gt; inventory.ini</span></span><br><span class=\"line\"><span class=\"string\">[master]</span></span><br><span class=\"line\"><span class=\"string\">kube-node-1 ansible_host=$&#123;MASTER_NODE_IP&#125;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">[workers]</span></span><br><span class=\"line\"><span class=\"string\">kube-node-2 ansible_host=$&#123;WORKER_NODE_IP_1&#125;</span></span><br><span class=\"line\"><span class=\"string\">kube-node-3 ansible_host=$&#123;WORKER_NODE_IP_2&#125;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">[all:vars]</span></span><br><span class=\"line\"><span class=\"string\">ansible_user=$&#123;ANSIBLE_USER&#125;</span></span><br><span class=\"line\"><span class=\"string\">ansible_ssh_private_key_file=$&#123;SSH_PRIVATE_KEY_PATH&#125;</span></span><br><span class=\"line\"><span class=\"string\">ansible_python_interpreter=/usr/bin/python3</span></span><br><span class=\"line\"><span class=\"string\"># These variables are now primarily for documentation/script clarity,</span></span><br><span class=\"line\"><span class=\"string\"># as the hosts file task will dynamically read from inventory groups.</span></span><br><span class=\"line\"><span class=\"string\">master_node_ip=$&#123;MASTER_NODE_IP&#125;</span></span><br><span class=\"line\"><span class=\"string\">worker_node_ip_1=$&#123;WORKER_NODE_IP_1&#125;</span></span><br><span class=\"line\"><span class=\"string\">worker_node_ip_2=$&#123;WORKER_NODE_IP_2&#125;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;inventory.ini created.&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Function to create main playbook.yml (Modified to only include common setup)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">create_playbook</span></span>() &#123;</span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;--- Creating playbook.yml ---&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOF &gt; playbook.yml</span></span><br><span class=\"line\"><span class=\"string\">---</span></span><br><span class=\"line\"><span class=\"string\">- name: Common Kubernetes Setup for all nodes</span></span><br><span class=\"line\"><span class=\"string\">  hosts: all</span></span><br><span class=\"line\"><span class=\"string\">  become: yes</span></span><br><span class=\"line\"><span class=\"string\">  roles:</span></span><br><span class=\"line\"><span class=\"string\">    - common_k8s_setup</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;playbook.yml created (only common setup included).&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Function to create roles and their tasks</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">create_roles</span></span>() &#123;</span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;--- Creating Ansible roles and tasks ---&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># common_k8s_setup role</span></span><br><span class=\"line\">    <span class=\"built_in\">mkdir</span> -p roles/common_k8s_setup/tasks</span><br><span class=\"line\">    <span class=\"comment\"># UPDATED: main.yml to include the new hosts entry task first</span></span><br><span class=\"line\">    <span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOF &gt; roles/common_k8s_setup/tasks/main.yml</span></span><br><span class=\"line\"><span class=\"string\">---</span></span><br><span class=\"line\"><span class=\"string\">- name: Include add hosts entries task</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.include_tasks: 00_add_hosts_entries.yml</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Include disable swap task</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.include_tasks: 01_disable_swap.yml</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Include containerd setup task</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.include_tasks: 02_containerd_setup.yml</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Include kernel modules and sysctl task</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.include_tasks: 03_kernel_modules_sysctl.yml</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Include kube repo, install, and hold task</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.include_tasks: 04_kube_repo_install_hold.yml</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Include initial apt upgrade task</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.include_tasks: 05_initial_upgrade.yml</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Include configure weekly updates task</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.include_tasks: 06_configure_weekly_updates.yml</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># NEW FILE: 00_add_hosts_entries.yml (Dynamically adds hosts from inventory, FIXED: Escaped backslashes in regex)</span></span><br><span class=\"line\">    <span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOF &gt; roles/common_k8s_setup/tasks/00_add_hosts_entries.yml</span></span><br><span class=\"line\"><span class=\"string\">---</span></span><br><span class=\"line\"><span class=\"string\">- name: Add all inventory hosts to /etc/hosts on each node</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.lineinfile:</span></span><br><span class=\"line\"><span class=\"string\">    path: /etc/hosts</span></span><br><span class=\"line\"><span class=\"string\">    regexp: &quot;^&#123;&#123; hostvars[item][&#x27;ansible_host&#x27;] &#125;&#125;\\\\\\\\s+&#123;&#123; item &#125;&#125;&quot; # Fixed: \\\\\\\\s for escaped backslash in regex</span></span><br><span class=\"line\"><span class=\"string\">    line: &quot;&#123;&#123; hostvars[item][&#x27;ansible_host&#x27;] &#125;&#125; &#123;&#123; item &#125;&#125;&quot;</span></span><br><span class=\"line\"><span class=\"string\">    state: present</span></span><br><span class=\"line\"><span class=\"string\">    create: yes</span></span><br><span class=\"line\"><span class=\"string\">    mode: &#x27;0644&#x27;</span></span><br><span class=\"line\"><span class=\"string\">    owner: root</span></span><br><span class=\"line\"><span class=\"string\">    group: root</span></span><br><span class=\"line\"><span class=\"string\">  loop: &quot;&#123;&#123; groups[&#x27;all&#x27;] &#125;&#125;&quot; # Loop over all hosts defined in the inventory</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># Create handlers directory and file</span></span><br><span class=\"line\">    <span class=\"built_in\">mkdir</span> -p roles/common_k8s_setup/handlers</span><br><span class=\"line\">    <span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOF &gt; roles/common_k8s_setup/handlers/main.yml</span></span><br><span class=\"line\"><span class=\"string\">---</span></span><br><span class=\"line\"><span class=\"string\">- name: Restart containerd service</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.systemd:</span></span><br><span class=\"line\"><span class=\"string\">    name: containerd</span></span><br><span class=\"line\"><span class=\"string\">    state: restarted</span></span><br><span class=\"line\"><span class=\"string\">    daemon_reload: yes</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># 01_disable_swap.yml</span></span><br><span class=\"line\">    <span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOF &gt; roles/common_k8s_setup/tasks/01_disable_swap.yml</span></span><br><span class=\"line\"><span class=\"string\">---</span></span><br><span class=\"line\"><span class=\"string\">- name: Check if swap is active</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.command: swapon --show</span></span><br><span class=\"line\"><span class=\"string\">  register: swap_check_result</span></span><br><span class=\"line\"><span class=\"string\">  changed_when: false # This command itself doesn&#x27;t change state</span></span><br><span class=\"line\"><span class=\"string\">  failed_when: false  # Don&#x27;t fail if swapon --show returns non-zero (e.g., no swap enabled)</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Disable swap</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.command: swapoff -a</span></span><br><span class=\"line\"><span class=\"string\">  when: swap_check_result.rc == 0 # Only run if swapon --show indicated swap is active</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Persistently disable swap (comment out swapfile in fstab)</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.replace:</span></span><br><span class=\"line\"><span class=\"string\">    path: /etc/fstab</span></span><br><span class=\"line\"><span class=\"string\">    regexp: &#x27;^(/swapfile.*)$&#x27;</span></span><br><span class=\"line\"><span class=\"string\">    replace: &#x27;#\\1&#x27;</span></span><br><span class=\"line\"><span class=\"string\">  when: swap_check_result.rc == 0 # Only run if swap was found to be active</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># 02_containerd_setup.yml (UPDATED for sandbox_image)</span></span><br><span class=\"line\">    <span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOF &gt; roles/common_k8s_setup/tasks/02_containerd_setup.yml</span></span><br><span class=\"line\"><span class=\"string\">---</span></span><br><span class=\"line\"><span class=\"string\">- name: Install required packages for Containerd</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.apt:</span></span><br><span class=\"line\"><span class=\"string\">    name:</span></span><br><span class=\"line\"><span class=\"string\">      - ca-certificates</span></span><br><span class=\"line\"><span class=\"string\">      - curl</span></span><br><span class=\"line\"><span class=\"string\">      - gnupg</span></span><br><span class=\"line\"><span class=\"string\">      - lsb-release</span></span><br><span class=\"line\"><span class=\"string\">      - apt-transport-https</span></span><br><span class=\"line\"><span class=\"string\">      - software-properties-common</span></span><br><span class=\"line\"><span class=\"string\">    state: present</span></span><br><span class=\"line\"><span class=\"string\">    update_cache: yes</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Add Docker GPG key</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.apt_key:</span></span><br><span class=\"line\"><span class=\"string\">    url: https://download.docker.com/linux/ubuntu/gpg</span></span><br><span class=\"line\"><span class=\"string\">    state: present</span></span><br><span class=\"line\"><span class=\"string\">    keyring: /etc/apt/keyrings/docker.gpg # Use keyring for modern apt</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Add Docker APT repository</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.apt_repository:</span></span><br><span class=\"line\"><span class=\"string\">    repo: &quot;deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu &#123;&#123; ansible_distribution_release &#125;&#125; stable&quot;</span></span><br><span class=\"line\"><span class=\"string\">    state: present</span></span><br><span class=\"line\"><span class=\"string\">    filename: docker</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Install Containerd</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.apt:</span></span><br><span class=\"line\"><span class=\"string\">    name: containerd.io</span></span><br><span class=\"line\"><span class=\"string\">    state: present</span></span><br><span class=\"line\"><span class=\"string\">    update_cache: yes</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Create containerd configuration directory</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.file:</span></span><br><span class=\"line\"><span class=\"string\">    path: /etc/containerd</span></span><br><span class=\"line\"><span class=\"string\">    state: directory</span></span><br><span class=\"line\"><span class=\"string\">    mode: &#x27;0755&#x27;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Generate default containerd configuration directly to final path</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.shell: containerd config default &gt; /etc/containerd/config.toml</span></span><br><span class=\"line\"><span class=\"string\">  changed_when: true # Always report change as we&#x27;re ensuring a default state</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Ensure CRI plugin is enabled (remove any disabled_plugins line containing &quot;cri&quot;)</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.lineinfile:</span></span><br><span class=\"line\"><span class=\"string\">    path: /etc/containerd/config.toml</span></span><br><span class=\"line\"><span class=\"string\">    regexp: &#x27;^\\s*disabled_plugins = \\[.*&quot;cri&quot;.*\\]&#x27; # More general regexp</span></span><br><span class=\"line\"><span class=\"string\">    state: absent</span></span><br><span class=\"line\"><span class=\"string\">    backup: yes</span></span><br><span class=\"line\"><span class=\"string\">  notify: Restart containerd service</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Remove top-level systemd_cgroup from CRI plugin section</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.lineinfile:</span></span><br><span class=\"line\"><span class=\"string\">    path: /etc/containerd/config.toml</span></span><br><span class=\"line\"><span class=\"string\">    regexp: &#x27;^\\s*systemd_cgroup = (true|false)&#x27; # Matches the &#x27;systemd_cgroup&#x27; directly under [plugins.&quot;io.containerd.grpc.v1.cri&quot;]</span></span><br><span class=\"line\"><span class=\"string\">    state: absent # Remove this line</span></span><br><span class=\"line\"><span class=\"string\">    backup: yes</span></span><br><span class=\"line\"><span class=\"string\">  notify: Restart containerd service</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Remove old runtime_root from runc runtime section</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.lineinfile:</span></span><br><span class=\"line\"><span class=\"string\">    path: /etc/containerd/config.toml</span></span><br><span class=\"line\"><span class=\"string\">    regexp: &#x27;^\\s*runtime_root = &quot;.*&quot;&#x27; # Matches runtime_root line</span></span><br><span class=\"line\"><span class=\"string\">    state: absent</span></span><br><span class=\"line\"><span class=\"string\">    backup: yes</span></span><br><span class=\"line\"><span class=\"string\">  notify: Restart containerd service</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Configure runc runtime to use SystemdCgroup = true</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.lineinfile:</span></span><br><span class=\"line\"><span class=\"string\">    path: /etc/containerd/config.toml</span></span><br><span class=\"line\"><span class=\"string\">    regexp: &#x27;^\\s*#?\\s*SystemdCgroup = (true|false)&#x27; # Matches the &#x27;SystemdCgroup&#x27; under runc.options</span></span><br><span class=\"line\"><span class=\"string\">    line: &#x27;            SystemdCgroup = true&#x27; # Ensure correct indentation</span></span><br><span class=\"line\"><span class=\"string\">    insertafter: &#x27;^\\s*\\[plugins\\.&quot;io\\.containerd\\.grpc\\.v1\\.cri&quot;\\.containerd\\.runtimes\\.runc\\.options\\]&#x27;</span></span><br><span class=\"line\"><span class=\"string\">    backup: yes</span></span><br><span class=\"line\"><span class=\"string\">  notify: Restart containerd service</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Add Root path to runc options</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.lineinfile:</span></span><br><span class=\"line\"><span class=\"string\">    path: /etc/containerd/config.toml</span></span><br><span class=\"line\"><span class=\"string\">    regexp: &#x27;^\\s*Root = &quot;.*&quot;&#x27; # Matches existing Root line if any</span></span><br><span class=\"line\"><span class=\"string\">    line: &#x27;            Root = &quot;/run/containerd/runc&quot;&#x27; # New Root path</span></span><br><span class=\"line\"><span class=\"string\">    insertafter: &#x27;^\\s*\\[plugins\\.&quot;io\\.containerd\\.grpc\\.v1\\.cri&quot;\\.containerd\\.runtimes\\.runc\\.options\\]&#x27;</span></span><br><span class=\"line\"><span class=\"string\">    backup: yes</span></span><br><span class=\"line\"><span class=\"string\">  notify: Restart containerd service</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Update sandbox_image to pause:3.10</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.lineinfile:</span></span><br><span class=\"line\"><span class=\"string\">    path: /etc/containerd/config.toml</span></span><br><span class=\"line\"><span class=\"string\">    regexp: &#x27;^\\s*sandbox_image = &quot;registry.k8s.io/pause:.*&quot;&#x27;</span></span><br><span class=\"line\"><span class=\"string\">    line: &#x27;    sandbox_image = &quot;registry.k8s.io/pause:3.10&quot;&#x27;</span></span><br><span class=\"line\"><span class=\"string\">    insertafter: &#x27;^\\s*\\[plugins\\.&quot;io\\.containerd\\.grpc\\.v1\\.cri&quot;\\]&#x27; # Insert after the CRI plugin section start</span></span><br><span class=\"line\"><span class=\"string\">    backup: yes</span></span><br><span class=\"line\"><span class=\"string\">  notify: Restart containerd service</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># 03_kernel_modules_sysctl.yml</span></span><br><span class=\"line\">    <span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOF &gt; roles/common_k8s_setup/tasks/03_kernel_modules_sysctl.yml</span></span><br><span class=\"line\"><span class=\"string\">---</span></span><br><span class=\"line\"><span class=\"string\">- name: Load overlay module</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.command: modprobe overlay</span></span><br><span class=\"line\"><span class=\"string\">  args:</span></span><br><span class=\"line\"><span class=\"string\">    creates: /sys/module/overlay # Check if module is loaded</span></span><br><span class=\"line\"><span class=\"string\">  changed_when: false</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Load br_netfilter module</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.command: modprobe br_netfilter</span></span><br><span class=\"line\"><span class=\"string\">  args:</span></span><br><span class=\"line\"><span class=\"string\">    creates: /sys/module/br_netfilter # Check if module is loaded</span></span><br><span class=\"line\"><span class=\"string\">  changed_when: false</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Add modules to /etc/modules-load.d/k8s.conf</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.copy:</span></span><br><span class=\"line\"><span class=\"string\">    dest: /etc/modules-load.d/k8s.conf</span></span><br><span class=\"line\"><span class=\"string\">    content: |</span></span><br><span class=\"line\"><span class=\"string\">      overlay</span></span><br><span class=\"line\"><span class=\"string\">      br_netfilter</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Configure sysctl parameters for Kubernetes networking</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.copy:</span></span><br><span class=\"line\"><span class=\"string\">    dest: /etc/sysctl.d/k8s.conf</span></span><br><span class=\"line\"><span class=\"string\">    content: |</span></span><br><span class=\"line\"><span class=\"string\">      net.bridge.bridge-nf-call-iptables = 1</span></span><br><span class=\"line\"><span class=\"string\">      net.bridge.bridge-nf-call-ip6tables = 1</span></span><br><span class=\"line\"><span class=\"string\">      net.ipv4.ip_forward = 1</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Apply sysctl parameters</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.command: sysctl --system</span></span><br><span class=\"line\"><span class=\"string\">  changed_when: false</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># 04_kube_repo_install_hold.yml</span></span><br><span class=\"line\">    <span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOF &gt; roles/common_k8s_setup/tasks/04_kube_repo_install_hold.yml</span></span><br><span class=\"line\"><span class=\"string\">---</span></span><br><span class=\"line\"><span class=\"string\">- name: Create Kubernetes apt keyring directory</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.file:</span></span><br><span class=\"line\"><span class=\"string\">    path: /etc/apt/keyrings</span></span><br><span class=\"line\"><span class=\"string\">    state: directory</span></span><br><span class=\"line\"><span class=\"string\">    mode: &#x27;0755&#x27;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Download Kubernetes GPG key and dearmor</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.shell: |</span></span><br><span class=\"line\"><span class=\"string\">    curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.33/deb/Release.key | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg</span></span><br><span class=\"line\"><span class=\"string\">  args:</span></span><br><span class=\"line\"><span class=\"string\">    creates: /etc/apt/keyrings/kubernetes-apt-keyring.gpg</span></span><br><span class=\"line\"><span class=\"string\">  changed_when: false # This command is idempotent enough for our purposes</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Add Kubernetes APT repository source list</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.copy:</span></span><br><span class=\"line\"><span class=\"string\">    dest: /etc/apt/sources.list.d/kubernetes.list</span></span><br><span class=\"line\"><span class=\"string\">    content: &quot;deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.33/deb/ /\\n&quot;</span></span><br><span class=\"line\"><span class=\"string\">    mode: &#x27;0644&#x27;</span></span><br><span class=\"line\"><span class=\"string\">    backup: yes</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Update apt cache after adding Kubernetes repo</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.apt:</span></span><br><span class=\"line\"><span class=\"string\">    update_cache: yes</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Install kubelet, kubeadm, kubectl</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.apt:</span></span><br><span class=\"line\"><span class=\"string\">    name:</span></span><br><span class=\"line\"><span class=\"string\">      - kubelet</span></span><br><span class=\"line\"><span class=\"string\">      - kubeadm</span></span><br><span class=\"line\"><span class=\"string\">      - kubectl</span></span><br><span class=\"line\"><span class=\"string\">    state: present</span></span><br><span class=\"line\"><span class=\"string\">    update_cache: yes # Ensure apt cache is updated after adding repo.</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Hold kubelet, kubeadm, kubectl packages</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.dpkg_selections:</span></span><br><span class=\"line\"><span class=\"string\">    name: &quot;&#123;&#123; item &#125;&#125;&quot;</span></span><br><span class=\"line\"><span class=\"string\">    selection: hold</span></span><br><span class=\"line\"><span class=\"string\">  loop:</span></span><br><span class=\"line\"><span class=\"string\">    - kubelet</span></span><br><span class=\"line\"><span class=\"string\">    - kubeadm</span></span><br><span class=\"line\"><span class=\"string\">    - kubectl</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Enable and start kubelet service</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.systemd:</span></span><br><span class=\"line\"><span class=\"string\">    name: kubelet</span></span><br><span class=\"line\"><span class=\"string\">    state: started</span></span><br><span class=\"line\"><span class=\"string\">    enabled: yes</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># NEW FILE: 05_initial_upgrade.yml</span></span><br><span class=\"line\">    <span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOF &gt; roles/common_k8s_setup/tasks/05_initial_upgrade.yml</span></span><br><span class=\"line\"><span class=\"string\">---</span></span><br><span class=\"line\"><span class=\"string\">- name: Perform initial apt update and upgrade</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.apt:</span></span><br><span class=\"line\"><span class=\"string\">    update_cache: yes</span></span><br><span class=\"line\"><span class=\"string\">    upgrade: yes</span></span><br><span class=\"line\"><span class=\"string\">    autoremove: yes</span></span><br><span class=\"line\"><span class=\"string\">    purge: yes</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># NEW FILE: 06_configure_weekly_updates.yml</span></span><br><span class=\"line\">    <span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOF &gt; roles/common_k8s_setup/tasks/06_configure_weekly_updates.yml</span></span><br><span class=\"line\"><span class=\"string\">---</span></span><br><span class=\"line\"><span class=\"string\">- name: Configure weekly apt update and upgrade cron job</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.cron:</span></span><br><span class=\"line\"><span class=\"string\">    name: &quot;weekly apt update and upgrade&quot;</span></span><br><span class=\"line\"><span class=\"string\">    weekday: &quot;0&quot; # Sunday</span></span><br><span class=\"line\"><span class=\"string\">    hour: &quot;3&quot;    # 3 AM</span></span><br><span class=\"line\"><span class=\"string\">    minute: &quot;0&quot;</span></span><br><span class=\"line\"><span class=\"string\">    job: &quot;/usr/bin/apt update &amp;&amp; /usr/bin/apt upgrade -y &amp;&amp; /usr/bin/apt autoremove -y &amp;&amp; /usr/bin/apt clean&quot;</span></span><br><span class=\"line\"><span class=\"string\">    user: root</span></span><br><span class=\"line\"><span class=\"string\">    state: present</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># Master and Worker roles are still created for structure, but not called by playbook.yml</span></span><br><span class=\"line\">    <span class=\"built_in\">mkdir</span> -p roles/k8s-master/tasks</span><br><span class=\"line\">    <span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOF &gt; roles/k8s-master/tasks/main.yml</span></span><br><span class=\"line\"><span class=\"string\">---</span></span><br><span class=\"line\"><span class=\"string\">- name: This role is intentionally skipped by the main playbook for manual setup.</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.debug:</span></span><br><span class=\"line\"><span class=\"string\">    msg: &quot;This master role is not executed by default. Run &#x27;kubeadm init&#x27; manually on the master node.&quot;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">mkdir</span> -p roles/k8s-worker/tasks</span><br><span class=\"line\">    <span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOF &gt; roles/k8s-worker/tasks/main.yml</span></span><br><span class=\"line\"><span class=\"string\">---</span></span><br><span class=\"line\"><span class=\"string\">- name: This role is intentionally skipped by the main playbook for manual setup.</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.debug:</span></span><br><span class=\"line\"><span class=\"string\">    msg: &quot;This worker role is not executed by default. Run &#x27;kubeadm join&#x27; manually on worker nodes.&quot;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Ansible roles and tasks created.&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># --- Main execution ---</span></span><br><span class=\"line\">install_ansible</span><br><span class=\"line\">create_project_dir</span><br><span class=\"line\">create_ansible_cfg</span><br><span class=\"line\">create_inventory</span><br><span class=\"line\">create_playbook</span><br><span class=\"line\">create_roles</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;--- Ansible setup for Kubernetes installation is complete! ---&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;Navigate to the project directory:&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;cd <span class=\"variable\">$&#123;PROJECT_DIR&#125;</span>&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;Then, run the Ansible playbook to install Kubernetes components on all nodes:&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;ansible-playbook playbook.yml -K&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;After the playbook finishes, you will need to manually initialize the Kubernetes cluster:&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;1. SSH into the master node (kube-node-1):&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;   ssh ubuntu@<span class=\"variable\">$&#123;MASTER_NODE_IP&#125;</span>&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;2. Initialize the Kubernetes control plane on the master node:&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;   sudo kubeadm init --control-plane-endpoint=kube-node-1 --pod-network-cidr=172.16.0.0/20 --service-cidr=172.16.32.0/20 --skip-phases=addon/kube-proxy --pod-infra-container-image=registry.k8s.io/pause:3.10&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;3. After &#x27;kubeadm init&#x27; completes, it will print instructions to set up kubectl and the &#x27;kubeadm join&#x27; command.&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;   Follow the instructions to set up kubectl for the &#x27;ubuntu&#x27; user:&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;   mkdir -p \\$HOME/.kube&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;   sudo cp -i /etc/kubernetes/admin.conf \\$HOME/.kube/config&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;   sudo chown \\$(id -u):\\$(id -g) \\$HOME/.kube/config&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;4. Copy the &#x27;kubeadm join&#x27; command (including the token and discovery-token-ca-cert-hash) printed by &#x27;kubeadm init&#x27;.&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;   It will look something like: &#x27;kubeadm join &lt;master-ip&gt;:6443 --token &lt;token&gt; --discovery-token-ca-cert-hash sha256:&lt;hash&gt;&#x27;&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;5. SSH into each worker node (kube-node-2, kube-node-3) and run the join command:&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;   ssh ubuntu@<span class=\"variable\">$&#123;WORKER_NODE_IP_1&#125;</span> (for kube-node-2)&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;   sudo &lt;PASTE_YOUR_KUBEADM_JOIN_COMMAND_HERE&gt;&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;   ssh ubuntu@<span class=\"variable\">$&#123;WORKER_NODE_IP_2&#125;</span> (for kube-node-3)&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;   sudo &lt;PASTE_YOUR_KUBEADM_JOIN_COMMAND_HERE&gt;&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;6. Verify your cluster status from the master node:&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;   ssh ubuntu@<span class=\"variable\">$&#123;MASTER_NODE_IP&#125;</span>&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;   kubectl get nodes&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;   kubectl get pods --all-namespaces&quot;</span></span><br></pre></td></tr></table></figure>\n\n<p>上述脚本执行完后，创建以下文档</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@ois:/home/ois/data/k8s/k8s_cluster_setup# <span class=\"built_in\">ls</span> -R1</span><br><span class=\"line\">.:</span><br><span class=\"line\">ansible.cfg</span><br><span class=\"line\">inventory.ini</span><br><span class=\"line\">playbook.yml</span><br><span class=\"line\">roles</span><br><span class=\"line\"></span><br><span class=\"line\">./roles:</span><br><span class=\"line\">common_k8s_setup</span><br><span class=\"line\">k8s-master</span><br><span class=\"line\">k8s-worker</span><br><span class=\"line\"></span><br><span class=\"line\">./roles/common_k8s_setup:</span><br><span class=\"line\">handlers</span><br><span class=\"line\">tasks</span><br><span class=\"line\"></span><br><span class=\"line\">./roles/common_k8s_setup/handlers:</span><br><span class=\"line\">main.yml</span><br><span class=\"line\"></span><br><span class=\"line\">./roles/common_k8s_setup/tasks:</span><br><span class=\"line\">00_add_hosts_entries.yml</span><br><span class=\"line\">01_disable_swap.yml</span><br><span class=\"line\">02_containerd_setup.yml</span><br><span class=\"line\">03_kernel_modules_sysctl.yml</span><br><span class=\"line\">04_kube_repo_install_hold.yml</span><br><span class=\"line\">05_initial_upgrade.yml</span><br><span class=\"line\">06_configure_weekly_updates.yml</span><br><span class=\"line\">main.yml</span><br><span class=\"line\"></span><br><span class=\"line\">./roles/k8s-master:</span><br><span class=\"line\">tasks</span><br><span class=\"line\"></span><br><span class=\"line\">./roles/k8s-master/tasks:</span><br><span class=\"line\">main.yml</span><br><span class=\"line\"></span><br><span class=\"line\">./roles/k8s-worker:</span><br><span class=\"line\">tasks</span><br><span class=\"line\"></span><br><span class=\"line\">./roles/k8s-worker/tasks:</span><br><span class=\"line\">main.yml</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"2-2-执行过程\"><a href=\"#2-2-执行过程\" class=\"headerlink\" title=\"2.2 执行过程\"></a>2.2 执行过程</h2><p>在执行前，需要让.ssh&#x2F;known_hosts 文件保存这些主机的SSH Key。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#!/bin/bash</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># This script prepares the Ansible control node by adding the SSH host keys</span></span><br><span class=\"line\"><span class=\"comment\"># of the target nodes to the ~/.ssh/known_hosts file.</span></span><br><span class=\"line\"><span class=\"comment\"># It first removes any outdated keys for the specified hosts before scanning</span></span><br><span class=\"line\"><span class=\"comment\"># for the new ones, preventing &quot;REMOTE HOST IDENTIFICATION HAS CHANGED&quot; errors.</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># --- Configuration ---</span></span><br><span class=\"line\"><span class=\"comment\"># List of hosts (IPs or FQDNs) to scan.</span></span><br><span class=\"line\"><span class=\"comment\"># These should be the same hosts you have in your Ansible inventory.</span></span><br><span class=\"line\">HOSTS=(</span><br><span class=\"line\">    <span class=\"string\">&quot;10.75.59.71&quot;</span></span><br><span class=\"line\">    <span class=\"string\">&quot;10.75.59.72&quot;</span></span><br><span class=\"line\">    <span class=\"string\">&quot;10.75.59.73&quot;</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># The location of your known_hosts file.</span></span><br><span class=\"line\">KNOWN_HOSTS_FILE=~/.ssh/known_hosts</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># --- Main Logic ---</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;Starting SSH host key scan to update <span class=\"variable\">$&#123;KNOWN_HOSTS_FILE&#125;</span>...&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Ensure the .ssh directory exists with the correct permissions.</span></span><br><span class=\"line\"><span class=\"built_in\">mkdir</span> -p ~/.ssh</span><br><span class=\"line\"><span class=\"built_in\">chmod</span> 700 ~/.ssh</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Loop through each host defined in the HOSTS array.</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> host <span class=\"keyword\">in</span> <span class=\"string\">&quot;<span class=\"variable\">$&#123;HOSTS[@]&#125;</span>&quot;</span>; <span class=\"keyword\">do</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;--- Processing host: <span class=\"variable\">$&#123;host&#125;</span> ---&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># 1. Remove the old host key (if it exists).</span></span><br><span class=\"line\">    <span class=\"comment\"># This is the key step to ensure we replace outdated entries.</span></span><br><span class=\"line\">    <span class=\"comment\"># The command is silent if no key is found.</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Step 1: Removing any old key for <span class=\"variable\">$&#123;host&#125;</span>...&quot;</span></span><br><span class=\"line\">    ssh-keygen -R <span class=\"string\">&quot;<span class=\"variable\">$&#123;host&#125;</span>&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># 2. Scan for the new host key and append it.</span></span><br><span class=\"line\">    <span class=\"comment\"># The -H flag hashes the hostname, which is a security best practice.</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Step 2: Scanning for new key and adding it to known_hosts...&quot;</span></span><br><span class=\"line\">    ssh-keyscan -H <span class=\"string\">&quot;<span class=\"variable\">$&#123;host&#125;</span>&quot;</span> &gt;&gt; <span class=\"string\">&quot;<span class=\"variable\">$&#123;KNOWN_HOSTS_FILE&#125;</span>&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Successfully updated key for <span class=\"variable\">$&#123;host&#125;</span>.&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">done</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Set the correct permissions for the known_hosts file, as SSH is strict about this.</span></span><br><span class=\"line\"><span class=\"built_in\">chmod</span> 600 <span class=\"string\">&quot;<span class=\"variable\">$&#123;KNOWN_HOSTS_FILE&#125;</span>&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;✅ All hosts have been scanned and keys have been updated.&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;You can now run your Ansible playbook without host key verification prompts.&quot;</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">chmod</span> +x ansible-k8s-v2.sh </span><br><span class=\"line\">ois@ois:~/data/k8s$ ./ansible-k8s-v2.sh </span><br><span class=\"line\">--- Installing Ansible ---</span><br><span class=\"line\">Ansible is already installed.</span><br><span class=\"line\">--- Creating project directory: k8s_cluster_setup ---</span><br><span class=\"line\">Changed to directory: /home/ois/data/k8s/k8s_cluster_setup</span><br><span class=\"line\">--- Creating ansible.cfg ---</span><br><span class=\"line\">ansible.cfg created.</span><br><span class=\"line\">--- Creating inventory.ini ---</span><br><span class=\"line\">inventory.ini created.</span><br><span class=\"line\">--- Creating playbook.yml ---</span><br><span class=\"line\">playbook.yml created (only common setup included).</span><br><span class=\"line\">--- Creating Ansible roles and tasks ---</span><br><span class=\"line\">Ansible roles and tasks created.</span><br><span class=\"line\"></span><br><span class=\"line\">--- Ansible setup <span class=\"keyword\">for</span> Kubernetes installation is complete! ---</span><br><span class=\"line\">Navigate to the project directory:</span><br><span class=\"line\"><span class=\"built_in\">cd</span> k8s_cluster_setup</span><br><span class=\"line\"></span><br><span class=\"line\">Then, run the Ansible playbook to install Kubernetes components on all nodes:</span><br><span class=\"line\">ansible-playbook playbook.yml -K</span><br><span class=\"line\"></span><br><span class=\"line\">After the playbook finishes, you will need to manually initialize the Kubernetes cluster:</span><br><span class=\"line\">1. SSH into the master node (kube-node-1):</span><br><span class=\"line\">   ssh ubuntu@10.75.59.71</span><br><span class=\"line\"></span><br><span class=\"line\">2. Initialize the Kubernetes control plane on the master node:</span><br><span class=\"line\">   <span class=\"built_in\">sudo</span> kubeadm init --control-plane-endpoint=kube-node-1 --pod-network-cidr=172.16.0.0/20 --service-cidr=172.16.32.0/20 --skip-phases=addon/kube-proxy --pod-infra-container-image=registry.k8s.io/pause:3.10</span><br><span class=\"line\"></span><br><span class=\"line\">3. After <span class=\"string\">&#x27;kubeadm init&#x27;</span> completes, it will <span class=\"built_in\">print</span> instructions to <span class=\"built_in\">set</span> up kubectl and the <span class=\"string\">&#x27;kubeadm join&#x27;</span> <span class=\"built_in\">command</span>.</span><br><span class=\"line\">   Follow the instructions to <span class=\"built_in\">set</span> up kubectl <span class=\"keyword\">for</span> the <span class=\"string\">&#x27;ubuntu&#x27;</span> user:</span><br><span class=\"line\">   <span class=\"built_in\">mkdir</span> -p <span class=\"variable\">$HOME</span>/.kube</span><br><span class=\"line\">   <span class=\"built_in\">sudo</span> <span class=\"built_in\">cp</span> -i /etc/kubernetes/admin.conf <span class=\"variable\">$HOME</span>/.kube/config</span><br><span class=\"line\">   <span class=\"built_in\">sudo</span> <span class=\"built_in\">chown</span> $(<span class=\"built_in\">id</span> -u):$(<span class=\"built_in\">id</span> -g) <span class=\"variable\">$HOME</span>/.kube/config</span><br><span class=\"line\"></span><br><span class=\"line\">4. Copy the <span class=\"string\">&#x27;kubeadm join&#x27;</span> <span class=\"built_in\">command</span> (including the token and discovery-token-ca-cert-hash) printed by <span class=\"string\">&#x27;kubeadm init&#x27;</span>.</span><br><span class=\"line\">   It will look something like: <span class=\"string\">&#x27;kubeadm join &lt;master-ip&gt;:6443 --token &lt;token&gt; --discovery-token-ca-cert-hash sha256:&lt;hash&gt;&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">5. SSH into each worker node (kube-node-2, kube-node-3) and run the <span class=\"built_in\">join</span> <span class=\"built_in\">command</span>:</span><br><span class=\"line\">   ssh ubuntu@10.75.59.72 (<span class=\"keyword\">for</span> kube-node-2)</span><br><span class=\"line\">   <span class=\"built_in\">sudo</span> &lt;PASTE_YOUR_KUBEADM_JOIN_COMMAND_HERE&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">   ssh ubuntu@10.75.59.73 (<span class=\"keyword\">for</span> kube-node-3)</span><br><span class=\"line\">   <span class=\"built_in\">sudo</span> &lt;PASTE_YOUR_KUBEADM_JOIN_COMMAND_HERE&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">6. Verify your cluster status from the master node:</span><br><span class=\"line\">   ssh ubuntu@10.75.59.71</span><br><span class=\"line\">   kubectl get nodes</span><br><span class=\"line\">   kubectl get pods --all-namespaces</span><br><span class=\"line\">ois@ois:~/data/k8s$ <span class=\"built_in\">cd</span> k8s_cluster_setup/</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ois@ois:~/data/k8s/k8s_cluster_setup$ ansible-playbook playbook.yml -K</span><br><span class=\"line\">BECOME password: </span><br><span class=\"line\"></span><br><span class=\"line\">PLAY [Common Kubernetes Setup <span class=\"keyword\">for</span> all nodes] *******************************************************************************************************************************************************************************************************************</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Gathering Facts] *****************************************************************************************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [kube-node-1]</span><br><span class=\"line\">ok: [kube-node-2]</span><br><span class=\"line\">ok: [kube-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common_k8s_setup : Include add hosts entries task] *******************************************************************************************************************************************************************************************************</span><br><span class=\"line\">included: /home/ois/data/k8s/k8s_cluster_setup/roles/common_k8s_setup/tasks/00_add_hosts_entries.yml <span class=\"keyword\">for</span> kube-node-1, kube-node-2, kube-node-3</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common_k8s_setup : Add all inventory hosts to /etc/hosts on each node] ***********************************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [kube-node-2] =&gt; (item=kube-node-1)</span><br><span class=\"line\">changed: [kube-node-1] =&gt; (item=kube-node-1)</span><br><span class=\"line\">changed: [kube-node-3] =&gt; (item=kube-node-1)</span><br><span class=\"line\">changed: [kube-node-1] =&gt; (item=kube-node-2)</span><br><span class=\"line\">changed: [kube-node-2] =&gt; (item=kube-node-2)</span><br><span class=\"line\">changed: [kube-node-3] =&gt; (item=kube-node-2)</span><br><span class=\"line\">changed: [kube-node-2] =&gt; (item=kube-node-3)</span><br><span class=\"line\">changed: [kube-node-1] =&gt; (item=kube-node-3)</span><br><span class=\"line\">changed: [kube-node-3] =&gt; (item=kube-node-3)</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common_k8s_setup : Include <span class=\"built_in\">disable</span> swap task] ************************************************************************************************************************************************************************************************************</span><br><span class=\"line\">included: /home/ois/data/k8s/k8s_cluster_setup/roles/common_k8s_setup/tasks/01_disable_swap.yml <span class=\"keyword\">for</span> kube-node-1, kube-node-2, kube-node-3</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common_k8s_setup : Check <span class=\"keyword\">if</span> swap is active] **************************************************************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [kube-node-2]</span><br><span class=\"line\">ok: [kube-node-1]</span><br><span class=\"line\">ok: [kube-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common_k8s_setup : Disable swap] *************************************************************************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [kube-node-1]</span><br><span class=\"line\">changed: [kube-node-2]</span><br><span class=\"line\">changed: [kube-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common_k8s_setup : Persistently <span class=\"built_in\">disable</span> swap (comment out swapfile <span class=\"keyword\">in</span> fstab)] ****************************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [kube-node-2]</span><br><span class=\"line\">ok: [kube-node-3]</span><br><span class=\"line\">ok: [kube-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common_k8s_setup : Include containerd setup task] ********************************************************************************************************************************************************************************************************</span><br><span class=\"line\">included: /home/ois/data/k8s/k8s_cluster_setup/roles/common_k8s_setup/tasks/02_containerd_setup.yml <span class=\"keyword\">for</span> kube-node-1, kube-node-2, kube-node-3</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common_k8s_setup : Install required packages <span class=\"keyword\">for</span> Containerd] *********************************************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [kube-node-2]</span><br><span class=\"line\">changed: [kube-node-1]</span><br><span class=\"line\">changed: [kube-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common_k8s_setup : Add Docker GPG key] *******************************************************************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [kube-node-1]</span><br><span class=\"line\">changed: [kube-node-2]</span><br><span class=\"line\">changed: [kube-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common_k8s_setup : Add Docker APT repository] ************************************************************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [kube-node-2]</span><br><span class=\"line\">changed: [kube-node-1]</span><br><span class=\"line\">changed: [kube-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common_k8s_setup : Install Containerd] *******************************************************************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [kube-node-3]</span><br><span class=\"line\">changed: [kube-node-1]</span><br><span class=\"line\">changed: [kube-node-2]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common_k8s_setup : Create containerd configuration directory] ********************************************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [kube-node-2]</span><br><span class=\"line\">ok: [kube-node-3]</span><br><span class=\"line\">ok: [kube-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common_k8s_setup : Generate default containerd configuration directly to final path] *********************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [kube-node-1]</span><br><span class=\"line\">changed: [kube-node-3]</span><br><span class=\"line\">changed: [kube-node-2]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common_k8s_setup : Ensure CRI plugin is enabled (remove any disabled_plugins line containing <span class=\"string\">&quot;cri&quot;</span>)] *****************************************************************************************************************************************************</span><br><span class=\"line\">ok: [kube-node-1]</span><br><span class=\"line\">ok: [kube-node-2]</span><br><span class=\"line\">ok: [kube-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common_k8s_setup : Remove top-level systemd_cgroup from CRI plugin section] ******************************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [kube-node-1]</span><br><span class=\"line\">changed: [kube-node-2]</span><br><span class=\"line\">changed: [kube-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common_k8s_setup : Remove old runtime_root from runc runtime section] ************************************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [kube-node-1]</span><br><span class=\"line\">changed: [kube-node-3]</span><br><span class=\"line\">changed: [kube-node-2]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common_k8s_setup : Configure runc runtime to use SystemdCgroup = <span class=\"literal\">true</span>] ***********************************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [kube-node-1]</span><br><span class=\"line\">changed: [kube-node-2]</span><br><span class=\"line\">changed: [kube-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common_k8s_setup : Add Root path to runc options] ********************************************************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [kube-node-1]</span><br><span class=\"line\">changed: [kube-node-3]</span><br><span class=\"line\">changed: [kube-node-2]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common_k8s_setup : Update sandbox_image to pause:3.10] ***************************************************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [kube-node-1]</span><br><span class=\"line\">changed: [kube-node-2]</span><br><span class=\"line\">changed: [kube-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common_k8s_setup : Include kernel modules and sysctl task] ***********************************************************************************************************************************************************************************************</span><br><span class=\"line\">included: /home/ois/data/k8s/k8s_cluster_setup/roles/common_k8s_setup/tasks/03_kernel_modules_sysctl.yml <span class=\"keyword\">for</span> kube-node-1, kube-node-2, kube-node-3</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common_k8s_setup : Load overlay module] ******************************************************************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [kube-node-1]</span><br><span class=\"line\">ok: [kube-node-2]</span><br><span class=\"line\">ok: [kube-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common_k8s_setup : Load br_netfilter module] *************************************************************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [kube-node-1]</span><br><span class=\"line\">ok: [kube-node-2]</span><br><span class=\"line\">ok: [kube-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common_k8s_setup : Add modules to /etc/modules-load.d/k8s.conf] ******************************************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [kube-node-1]</span><br><span class=\"line\">changed: [kube-node-2]</span><br><span class=\"line\">changed: [kube-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common_k8s_setup : Configure sysctl parameters <span class=\"keyword\">for</span> Kubernetes networking] ********************************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [kube-node-1]</span><br><span class=\"line\">changed: [kube-node-2]</span><br><span class=\"line\">changed: [kube-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common_k8s_setup : Apply sysctl parameters] **************************************************************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [kube-node-1]</span><br><span class=\"line\">ok: [kube-node-2]</span><br><span class=\"line\">ok: [kube-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common_k8s_setup : Include kube repo, install, and hold task] ********************************************************************************************************************************************************************************************</span><br><span class=\"line\">included: /home/ois/data/k8s/k8s_cluster_setup/roles/common_k8s_setup/tasks/04_kube_repo_install_hold.yml <span class=\"keyword\">for</span> kube-node-1, kube-node-2, kube-node-3</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common_k8s_setup : Create Kubernetes apt keyring directory] **********************************************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [kube-node-1]</span><br><span class=\"line\">ok: [kube-node-2]</span><br><span class=\"line\">ok: [kube-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common_k8s_setup : Download Kubernetes GPG key and dearmor] **********************************************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [kube-node-2]</span><br><span class=\"line\">ok: [kube-node-1]</span><br><span class=\"line\">ok: [kube-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common_k8s_setup : Add Kubernetes APT repository <span class=\"built_in\">source</span> list] ********************************************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [kube-node-2]</span><br><span class=\"line\">changed: [kube-node-3]</span><br><span class=\"line\">changed: [kube-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common_k8s_setup : Update apt cache after adding Kubernetes repo] ****************************************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [kube-node-2]</span><br><span class=\"line\">changed: [kube-node-1]</span><br><span class=\"line\">changed: [kube-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common_k8s_setup : Install kubelet, kubeadm, kubectl] ****************************************************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [kube-node-3]</span><br><span class=\"line\">changed: [kube-node-2]</span><br><span class=\"line\">changed: [kube-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common_k8s_setup : Hold kubelet, kubeadm, kubectl packages] **********************************************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [kube-node-1] =&gt; (item=kubelet)</span><br><span class=\"line\">changed: [kube-node-3] =&gt; (item=kubelet)</span><br><span class=\"line\">changed: [kube-node-2] =&gt; (item=kubelet)</span><br><span class=\"line\">changed: [kube-node-3] =&gt; (item=kubeadm)</span><br><span class=\"line\">changed: [kube-node-1] =&gt; (item=kubeadm)</span><br><span class=\"line\">changed: [kube-node-2] =&gt; (item=kubeadm)</span><br><span class=\"line\">changed: [kube-node-3] =&gt; (item=kubectl)</span><br><span class=\"line\">changed: [kube-node-1] =&gt; (item=kubectl)</span><br><span class=\"line\">changed: [kube-node-2] =&gt; (item=kubectl)</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common_k8s_setup : Enable and start kubelet service] *****************************************************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [kube-node-3]</span><br><span class=\"line\">changed: [kube-node-2]</span><br><span class=\"line\">changed: [kube-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common_k8s_setup : Include initial apt upgrade task] *****************************************************************************************************************************************************************************************************</span><br><span class=\"line\">included: /home/ois/data/k8s/k8s_cluster_setup/roles/common_k8s_setup/tasks/05_initial_upgrade.yml <span class=\"keyword\">for</span> kube-node-1, kube-node-2, kube-node-3</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common_k8s_setup : Perform initial apt update and upgrade] ***********************************************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [kube-node-3]</span><br><span class=\"line\">changed: [kube-node-2]</span><br><span class=\"line\">changed: [kube-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common_k8s_setup : Include configure weekly updates task] ************************************************************************************************************************************************************************************************</span><br><span class=\"line\">included: /home/ois/data/k8s/k8s_cluster_setup/roles/common_k8s_setup/tasks/06_configure_weekly_updates.yml <span class=\"keyword\">for</span> kube-node-1, kube-node-2, kube-node-3</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [common_k8s_setup : Configure weekly apt update and upgrade cron job] *************************************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [kube-node-1]</span><br><span class=\"line\">changed: [kube-node-2]</span><br><span class=\"line\">changed: [kube-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">RUNNING HANDLER [common_k8s_setup : Restart containerd service] ************************************************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [kube-node-2]</span><br><span class=\"line\">changed: [kube-node-1]</span><br><span class=\"line\">changed: [kube-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY RECAP *****************************************************************************************************************************************************************************************************************************************************</span><br><span class=\"line\">kube-node-1                : ok=39   changed=22   unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class=\"line\">kube-node-2                : ok=39   changed=22   unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class=\"line\">kube-node-3                : ok=39   changed=22   unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br></pre></td></tr></table></figure>\n\n<h1 id=\"3-设置本地DNS和BGP\"><a href=\"#3-设置本地DNS和BGP\" class=\"headerlink\" title=\"3. 设置本地DNS和BGP\"></a>3. 设置本地DNS和BGP</h1><p>设置一个本地DNS和BGP服务器用于测试。</p>\n<h2 id=\"3-1-create-dns-sh\"><a href=\"#3-1-create-dns-sh\" class=\"headerlink\" title=\"3.1 create-dns.sh\"></a>3.1 create-dns.sh</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#!/bin/bash</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># --- Configuration ---</span></span><br><span class=\"line\">BASE_IMAGE_PATH=<span class=\"string\">&quot;/home/ois/data/vmimages/noble-server-cloudimg-amd64.img&quot;</span></span><br><span class=\"line\">VM_IMAGE_DIR=<span class=\"string\">&quot;/home/ois/data/k8s/nodevms&quot;</span></span><br><span class=\"line\">VM_CONFIG_DIR=<span class=\"string\">&quot;/home/ois/data/k8s/nodevm_cfg&quot;</span></span><br><span class=\"line\">RAM_MB=8192</span><br><span class=\"line\">VCPUS=4</span><br><span class=\"line\">DISK_SIZE_GB=20</span><br><span class=\"line\">BRIDGE_INTERFACE=<span class=\"string\">&quot;br0&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># Specific IP for the single VM</span></span><br><span class=\"line\">VM_IP=<span class=\"string\">&quot;10.75.59.76&quot;</span></span><br><span class=\"line\">NETWORK_PREFIX=<span class=\"string\">&quot;/24&quot;</span></span><br><span class=\"line\">GATEWAY=<span class=\"string\">&quot;10.75.59.1&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># DNS servers for the VM&#x27;s initial resolution (for internet access)</span></span><br><span class=\"line\">VM_NAMESERVER1=<span class=\"string\">&quot;64.104.76.247&quot;</span></span><br><span class=\"line\">VM_NAMESERVER2=<span class=\"string\">&quot;64.104.14.184&quot;</span></span><br><span class=\"line\">SEARCH_DOMAIN=<span class=\"string\">&quot;cisco.com&quot;</span></span><br><span class=\"line\">VNC_PORT=5909 <span class=\"comment\"># Fixed VNC port for the single VM</span></span><br><span class=\"line\">PASSWORD_HASH=<span class=\"string\">&#x27;$6$rounds=4096$LDu9pXXXXXXXXXXXXXXOh/Iunw372/TVfst1&#x27;</span></span><br><span class=\"line\">SSH_PUB_KEY=$(<span class=\"built_in\">cat</span> ~/.ssh/id_rsa.pub)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># --- VM Details ---</span></span><br><span class=\"line\">VM_NAME=<span class=\"string\">&quot;dns-server-vm&quot;</span></span><br><span class=\"line\">VM_IMAGE_PATH=<span class=\"string\">&quot;<span class=\"variable\">$&#123;VM_IMAGE_DIR&#125;</span>/<span class=\"variable\">$&#123;VM_NAME&#125;</span>.qcow2&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;--- Preparing for <span class=\"variable\">$VM_NAME</span> (IP: <span class=\"variable\">$VM_IP</span>) ---&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Create directories if they don&#x27;t exist</span></span><br><span class=\"line\"><span class=\"built_in\">mkdir</span> -p <span class=\"string\">&quot;<span class=\"variable\">$VM_IMAGE_DIR</span>&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">mkdir</span> -p <span class=\"string\">&quot;<span class=\"variable\">$VM_CONFIG_DIR</span>&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Create a fresh image for the VM</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> [ -f <span class=\"string\">&quot;<span class=\"variable\">$VM_IMAGE_PATH</span>&quot;</span> ]; <span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Removing existing image for <span class=\"variable\">$VM_NAME</span>...&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">rm</span> <span class=\"string\">&quot;<span class=\"variable\">$VM_IMAGE_PATH</span>&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;Copying base image to <span class=\"variable\">$VM_IMAGE_PATH</span>...&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">cp</span> <span class=\"string\">&quot;<span class=\"variable\">$BASE_IMAGE_PATH</span>&quot;</span> <span class=\"string\">&quot;<span class=\"variable\">$VM_IMAGE_PATH</span>&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Resize the copied image before virt-install</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;Resizing VM image to <span class=\"variable\">$&#123;DISK_SIZE_GB&#125;</span>GB...&quot;</span></span><br><span class=\"line\">qemu-img resize <span class=\"string\">&quot;<span class=\"variable\">$VM_IMAGE_PATH</span>&quot;</span> <span class=\"string\">&quot;<span class=\"variable\">$&#123;DISK_SIZE_GB&#125;</span>G&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Generate user-data for the VM (installing dnsmasq, no UFW, no dnsmasq config here)</span></span><br><span class=\"line\">USER_DATA_FILE=<span class=\"string\">&quot;<span class=\"variable\">$&#123;VM_CONFIG_DIR&#125;</span>/<span class=\"variable\">$&#123;VM_NAME&#125;</span>_user-data&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOF &gt; &quot;$USER_DATA_FILE&quot;</span></span><br><span class=\"line\"><span class=\"string\">#cloud-config</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">locale: en_US</span></span><br><span class=\"line\"><span class=\"string\">keyboard:</span></span><br><span class=\"line\"><span class=\"string\">  layout: us</span></span><br><span class=\"line\"><span class=\"string\">timezone: Asia/Tokyo</span></span><br><span class=\"line\"><span class=\"string\">hostname: $&#123;VM_NAME&#125;</span></span><br><span class=\"line\"><span class=\"string\">create_hostname_file: true</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">ssh_pwauth: yes</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">groups:</span></span><br><span class=\"line\"><span class=\"string\">  - ubuntu</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">users:</span></span><br><span class=\"line\"><span class=\"string\">  - name: ubuntu</span></span><br><span class=\"line\"><span class=\"string\">    gecos: ubuntu</span></span><br><span class=\"line\"><span class=\"string\">    primary_group: ubuntu</span></span><br><span class=\"line\"><span class=\"string\">    groups: sudo, cdrom</span></span><br><span class=\"line\"><span class=\"string\">    sudo: ALL=(ALL:ALL) ALL</span></span><br><span class=\"line\"><span class=\"string\">    shell: /bin/bash</span></span><br><span class=\"line\"><span class=\"string\">    lock_passwd: false</span></span><br><span class=\"line\"><span class=\"string\">    passwd: $&#123;PASSWORD_HASH&#125;</span></span><br><span class=\"line\"><span class=\"string\">    ssh_authorized_keys:</span></span><br><span class=\"line\"><span class=\"string\">      - &quot;$&#123;SSH_PUB_KEY&#125;&quot;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">apt:</span></span><br><span class=\"line\"><span class=\"string\">  primary:</span></span><br><span class=\"line\"><span class=\"string\">    - arches: [default]</span></span><br><span class=\"line\"><span class=\"string\">      uri: http://us.archive.ubuntu.com/ubuntu/</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">packages:</span></span><br><span class=\"line\"><span class=\"string\">  - openssh-server</span></span><br><span class=\"line\"><span class=\"string\">  - net-tools</span></span><br><span class=\"line\"><span class=\"string\">  - iftop</span></span><br><span class=\"line\"><span class=\"string\">  - htop</span></span><br><span class=\"line\"><span class=\"string\">  - iperf3</span></span><br><span class=\"line\"><span class=\"string\">  - vim</span></span><br><span class=\"line\"><span class=\"string\">  - curl</span></span><br><span class=\"line\"><span class=\"string\">  - wget</span></span><br><span class=\"line\"><span class=\"string\">  - cloud-guest-utils # Ensure growpart is available</span></span><br><span class=\"line\"><span class=\"string\">  - dnsmasq # Install dnsmasq for DNS server functionality</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">ntp:</span></span><br><span class=\"line\"><span class=\"string\">  servers: [&#x27;ntp.esl.cisco.com&#x27;]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">runcmd:</span></span><br><span class=\"line\"><span class=\"string\">  - echo &quot;Attempting to resize root partition and filesystem...&quot;</span></span><br><span class=\"line\"><span class=\"string\">  - growpart /dev/vda 1 # Expand the first partition on /dev/vda</span></span><br><span class=\"line\"><span class=\"string\">  - resize2fs /dev/vda1 # Expand the ext4 filesystem on /dev/vda1</span></span><br><span class=\"line\"><span class=\"string\">  - echo &quot;Disk resize commands executed. Verify with &#x27;df -h&#x27; after boot.&quot;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Generate network-config for the VM (pointing to external DNS for initial connectivity)</span></span><br><span class=\"line\">NETWORK_CONFIG_FILE=<span class=\"string\">&quot;<span class=\"variable\">$&#123;VM_CONFIG_DIR&#125;</span>/<span class=\"variable\">$&#123;VM_NAME&#125;</span>_network-config&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOF &gt; &quot;$NETWORK_CONFIG_FILE&quot;</span></span><br><span class=\"line\"><span class=\"string\">network:</span></span><br><span class=\"line\"><span class=\"string\">  version: 2</span></span><br><span class=\"line\"><span class=\"string\">  ethernets:</span></span><br><span class=\"line\"><span class=\"string\">    enp1s0:</span></span><br><span class=\"line\"><span class=\"string\">      addresses:</span></span><br><span class=\"line\"><span class=\"string\">      - &quot;$&#123;VM_IP&#125;$&#123;NETWORK_PREFIX&#125;&quot;</span></span><br><span class=\"line\"><span class=\"string\">      nameservers:</span></span><br><span class=\"line\"><span class=\"string\">        addresses:</span></span><br><span class=\"line\"><span class=\"string\">        - $&#123;VM_NAMESERVER1&#125; # Point VM to external DNS for initial internet access</span></span><br><span class=\"line\"><span class=\"string\">        - $&#123;VM_NAMESERVER2&#125;</span></span><br><span class=\"line\"><span class=\"string\">        search:</span></span><br><span class=\"line\"><span class=\"string\">        - $&#123;SEARCH_DOMAIN&#125;</span></span><br><span class=\"line\"><span class=\"string\">      routes:</span></span><br><span class=\"line\"><span class=\"string\">      - to: &quot;default&quot;</span></span><br><span class=\"line\"><span class=\"string\">        via: &quot;$&#123;GATEWAY&#125;&quot;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Generate meta-data</span></span><br><span class=\"line\">META_DATA_FILE=<span class=\"string\">&quot;<span class=\"variable\">$&#123;VM_CONFIG_DIR&#125;</span>/<span class=\"variable\">$&#123;VM_NAME&#125;</span>_meta-data&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOF &gt; &quot;$META_DATA_FILE&quot;</span></span><br><span class=\"line\"><span class=\"string\">instance-id: $&#123;VM_NAME&#125;</span></span><br><span class=\"line\"><span class=\"string\">local-hostname: $&#123;VM_NAME&#125;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;--- Installing <span class=\"variable\">$VM_NAME</span> ---&quot;</span></span><br><span class=\"line\">virt-install --name <span class=\"string\">&quot;<span class=\"variable\">$&#123;VM_NAME&#125;</span>&quot;</span> --ram <span class=\"string\">&quot;<span class=\"variable\">$&#123;RAM_MB&#125;</span>&quot;</span> --vcpus <span class=\"string\">&quot;<span class=\"variable\">$&#123;VCPUS&#125;</span>&quot;</span> --noreboot \\</span><br><span class=\"line\">    --os-variant ubuntu24.04 \\</span><br><span class=\"line\">    --network bridge=<span class=\"string\">&quot;<span class=\"variable\">$&#123;BRIDGE_INTERFACE&#125;</span>&quot;</span> \\</span><br><span class=\"line\">    --graphics vnc,listen=0.0.0.0,port=<span class=\"string\">&quot;<span class=\"variable\">$&#123;VNC_PORT&#125;</span>&quot;</span> \\</span><br><span class=\"line\">    --disk path=<span class=\"string\">&quot;<span class=\"variable\">$&#123;VM_IMAGE_PATH&#125;</span>&quot;</span>,format=qcow2 \\</span><br><span class=\"line\">    --console pty,target_type=serial \\</span><br><span class=\"line\">    --cloud-init user-data=<span class=\"string\">&quot;<span class=\"variable\">$&#123;USER_DATA_FILE&#125;</span>&quot;</span>,meta-data=<span class=\"string\">&quot;<span class=\"variable\">$&#123;META_DATA_FILE&#125;</span>&quot;</span>,network-config=<span class=\"string\">&quot;<span class=\"variable\">$&#123;NETWORK_CONFIG_FILE&#125;</span>&quot;</span> \\</span><br><span class=\"line\">    --import \\</span><br><span class=\"line\">    --<span class=\"built_in\">wait</span> 0</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;Successfully initiated creation of <span class=\"variable\">$VM_NAME</span>.&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;You can connect to VNC on port <span class=\"variable\">$&#123;VNC_PORT&#125;</span> to monitor installation (optional).&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;Wait a few minutes for the VM to boot and cloud-init to run.&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;--------------------------------------------------------&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;The DNS server VM has been initiated. Please wait for it to fully provision.&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;You can SSH into it using &#x27;ssh ubuntu@<span class=\"variable\">$&#123;VM_IP&#125;</span>&#x27;.&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;Once provisioned, proceed to use the &#x27;setup-dnsmasq-ansible.sh&#x27; script to configure DNS using Ansible.&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">ois@ois:~/data/k8s$ ./create-dns.sh </span><br><span class=\"line\">--- Preparing <span class=\"keyword\">for</span> dns-server-vm (IP: 10.75.59.76) ---</span><br><span class=\"line\">Copying base image to /home/ois/data/k8s/nodevms/dns-server-vm.qcow2...</span><br><span class=\"line\">Resizing VM image to 20GB...</span><br><span class=\"line\">Image resized.</span><br><span class=\"line\">--- Installing dns-server-vm ---</span><br><span class=\"line\">WARNING  Treating --<span class=\"built_in\">wait</span> 0 as --noautoconsole</span><br><span class=\"line\"></span><br><span class=\"line\">Starting install...</span><br><span class=\"line\">Allocating <span class=\"string\">&#x27;virtinst-y1pxxrj5-cloudinit.iso&#x27;</span>                                                                                                                                                                                             |    0 B  00:00:00 ... </span><br><span class=\"line\">Transferring <span class=\"string\">&#x27;virtinst-y1pxxrj5-cloudinit.iso&#x27;</span>                                                                                                                                                                                           |    0 B  00:00:00 ... </span><br><span class=\"line\">Creating domain...                                                                                                                                                                                                                       |    0 B  00:00:00     </span><br><span class=\"line\">Domain creation completed.</span><br><span class=\"line\">Successfully initiated creation of dns-server-vm.</span><br><span class=\"line\">You can connect to VNC on port 5909 to monitor installation (optional).</span><br><span class=\"line\">Wait a few minutes <span class=\"keyword\">for</span> the VM to boot and cloud-init to run.</span><br><span class=\"line\">--------------------------------------------------------</span><br><span class=\"line\">The DNS server VM has been initiated. Please <span class=\"built_in\">wait</span> <span class=\"keyword\">for</span> it to fully provision.</span><br><span class=\"line\">You can SSH into it using <span class=\"string\">&#x27;ssh ubuntu@10.75.59.76&#x27;</span>.</span><br><span class=\"line\">Once provisioned, you can <span class=\"built_in\">test</span> the DNS forwarding by configuring another machine to use 10.75.59.76 as its DNS server and performing a DNS query.</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"3-2-使用Ansible设置dnsmasq\"><a href=\"#3-2-使用Ansible设置dnsmasq\" class=\"headerlink\" title=\"3.2 使用Ansible设置dnsmasq\"></a>3.2 使用Ansible设置dnsmasq</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#!/bin/bash</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># --- Configuration for Ansible and DNSmasq ---</span></span><br><span class=\"line\">VM_IP=<span class=\"string\">&quot;10.75.59.76&quot;</span></span><br><span class=\"line\">SSH_USER=<span class=\"string\">&quot;ubuntu&quot;</span></span><br><span class=\"line\">SSH_PRIVATE_KEY_PATH=<span class=\"string\">&quot;~/.ssh/id_rsa&quot;</span> <span class=\"comment\"># Ensure this path is correct for your setup</span></span><br><span class=\"line\">FORWARD_NAMESERVER1=<span class=\"string\">&quot;64.104.76.247&quot;</span></span><br><span class=\"line\">FORWARD_NAMESERVER2=<span class=\"string\">&quot;64.104.14.184&quot;</span></span><br><span class=\"line\">SEARCH_DOMAIN=<span class=\"string\">&quot;cisco.com&quot;</span></span><br><span class=\"line\">ANSIBLE_DIR=<span class=\"string\">&quot;ansible_dnsmasq_setup&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;--- Setting up Ansible environment and configuring DNSmasq on <span class=\"variable\">$&#123;VM_IP&#125;</span> ---&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Create a directory for Ansible files</span></span><br><span class=\"line\"><span class=\"built_in\">mkdir</span> -p <span class=\"string\">&quot;<span class=\"variable\">$ANSIBLE_DIR</span>&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">cd</span> <span class=\"string\">&quot;<span class=\"variable\">$ANSIBLE_DIR</span>&quot;</span> || <span class=\"built_in\">exit</span> 1</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># --- Install Ansible if not already installed ---</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> ! <span class=\"built_in\">command</span> -v ansible &amp;&gt; /dev/null</span><br><span class=\"line\"><span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Ansible not found. Installing Ansible...&quot;</span></span><br><span class=\"line\">    <span class=\"comment\"># Check OS and install accordingly</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> [ -f /etc/os-release ]; <span class=\"keyword\">then</span></span><br><span class=\"line\">        . /etc/os-release</span><br><span class=\"line\">        <span class=\"keyword\">if</span> [[ <span class=\"string\">&quot;<span class=\"variable\">$ID</span>&quot;</span> == <span class=\"string\">&quot;ubuntu&quot;</span> || <span class=\"string\">&quot;<span class=\"variable\">$ID</span>&quot;</span> == <span class=\"string\">&quot;debian&quot;</span> ]]; <span class=\"keyword\">then</span></span><br><span class=\"line\">            <span class=\"built_in\">sudo</span> apt update</span><br><span class=\"line\">            <span class=\"built_in\">sudo</span> apt install -y software-properties-common</span><br><span class=\"line\">            <span class=\"built_in\">sudo</span> apt-add-repository --<span class=\"built_in\">yes</span> --update ppa:ansible/ansible</span><br><span class=\"line\">            <span class=\"built_in\">sudo</span> apt install -y ansible</span><br><span class=\"line\">        <span class=\"keyword\">elif</span> [[ <span class=\"string\">&quot;<span class=\"variable\">$ID</span>&quot;</span> == <span class=\"string\">&quot;centos&quot;</span> || <span class=\"string\">&quot;<span class=\"variable\">$ID</span>&quot;</span> == <span class=\"string\">&quot;rhel&quot;</span> || <span class=\"string\">&quot;<span class=\"variable\">$ID</span>&quot;</span> == <span class=\"string\">&quot;fedora&quot;</span> ]]; <span class=\"keyword\">then</span></span><br><span class=\"line\">            <span class=\"built_in\">sudo</span> yum install -y epel-release</span><br><span class=\"line\">            <span class=\"built_in\">sudo</span> yum install -y ansible</span><br><span class=\"line\">        <span class=\"keyword\">else</span></span><br><span class=\"line\">            <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Unsupported OS for automatic Ansible installation. Please install Ansible manually.&quot;</span></span><br><span class=\"line\">            <span class=\"built_in\">exit</span> 1</span><br><span class=\"line\">        <span class=\"keyword\">fi</span></span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">        <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Could not determine OS for automatic Ansible installation. Please install Ansible manually.&quot;</span></span><br><span class=\"line\">        <span class=\"built_in\">exit</span> 1</span><br><span class=\"line\">    <span class=\"keyword\">fi</span></span><br><span class=\"line\"><span class=\"keyword\">else</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Ansible is already installed.&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># --- Create Ansible Inventory File ---</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;Creating Ansible inventory file: inventory.ini&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOF &gt; inventory.ini</span></span><br><span class=\"line\"><span class=\"string\">[dns_server]</span></span><br><span class=\"line\"><span class=\"string\">$&#123;VM_IP&#125; ansible_user=$&#123;SSH_USER&#125; ansible_ssh_private_key_file=$&#123;SSH_PRIVATE_KEY_PATH&#125; ansible_python_interpreter=/usr/bin/python3</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># --- Create Ansible Playbook (setup-dnsmasq.yml) ---</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;Creating Ansible playbook: setup-dnsmasq.yml&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOF &gt; setup-dnsmasq.yml</span></span><br><span class=\"line\"><span class=\"string\">---</span></span><br><span class=\"line\"><span class=\"string\">- name: Configure DNSmasq Server on Ubuntu VM</span></span><br><span class=\"line\"><span class=\"string\">  hosts: dns_server</span></span><br><span class=\"line\"><span class=\"string\">  become: yes # Run tasks with sudo privileges</span></span><br><span class=\"line\"><span class=\"string\">  vars:</span></span><br><span class=\"line\"><span class=\"string\">    dns_forwarder_1: &quot;$&#123;FORWARD_NAMESERVER1&#125;&quot;</span></span><br><span class=\"line\"><span class=\"string\">    dns_forwarder_2: &quot;$&#123;FORWARD_NAMESERVER2&#125;&quot;</span></span><br><span class=\"line\"><span class=\"string\">    vm_ip: &quot;$&#123;VM_IP&#125;&quot;</span></span><br><span class=\"line\"><span class=\"string\">    search_domain: &quot;$&#123;SEARCH_DOMAIN&#125;&quot;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">  tasks:</span></span><br><span class=\"line\"><span class=\"string\">    - name: Ensure apt cache is updated</span></span><br><span class=\"line\"><span class=\"string\">      ansible.builtin.apt:</span></span><br><span class=\"line\"><span class=\"string\">        update_cache: yes</span></span><br><span class=\"line\"><span class=\"string\">        cache_valid_time: 3600 # Cache for 1 hour</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">    - name: Install dnsmasq package</span></span><br><span class=\"line\"><span class=\"string\">      ansible.builtin.apt:</span></span><br><span class=\"line\"><span class=\"string\">        name: dnsmasq</span></span><br><span class=\"line\"><span class=\"string\">        state: present</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">    - name: Stop dnsmasq service before configuration</span></span><br><span class=\"line\"><span class=\"string\">      ansible.builtin.systemd:</span></span><br><span class=\"line\"><span class=\"string\">        name: dnsmasq</span></span><br><span class=\"line\"><span class=\"string\">        state: stopped</span></span><br><span class=\"line\"><span class=\"string\">      ignore_errors: yes # Ignore if it&#x27;s not running initially</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">    - name: Backup original dnsmasq.conf</span></span><br><span class=\"line\"><span class=\"string\">      ansible.builtin.command: mv /etc/dnsmasq.conf /etc/dnsmasq.conf.bak</span></span><br><span class=\"line\"><span class=\"string\">      args:</span></span><br><span class=\"line\"><span class=\"string\">        removes: /etc/dnsmasq.conf # Only run if dnsmasq.conf exists</span></span><br><span class=\"line\"><span class=\"string\">      ignore_errors: yes</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">    - name: Configure dnsmasq for forwarding</span></span><br><span class=\"line\"><span class=\"string\">      ansible.builtin.template:</span></span><br><span class=\"line\"><span class=\"string\">        src: dnsmasq.conf.j2</span></span><br><span class=\"line\"><span class=\"string\">        dest: /etc/dnsmasq.conf</span></span><br><span class=\"line\"><span class=\"string\">        owner: root</span></span><br><span class=\"line\"><span class=\"string\">        group: root</span></span><br><span class=\"line\"><span class=\"string\">        mode: &#x27;0644&#x27;</span></span><br><span class=\"line\"><span class=\"string\">      notify: Restart dnsmasq</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">    - name: Set VM&#x27;s /etc/resolv.conf to point to itself (local DNS)</span></span><br><span class=\"line\"><span class=\"string\">      ansible.builtin.template:</span></span><br><span class=\"line\"><span class=\"string\">        src: resolv.conf.j2</span></span><br><span class=\"line\"><span class=\"string\">        dest: /etc/resolv.conf</span></span><br><span class=\"line\"><span class=\"string\">        owner: root</span></span><br><span class=\"line\"><span class=\"string\">        group: root</span></span><br><span class=\"line\"><span class=\"string\">        mode: &#x27;0644&#x27;</span></span><br><span class=\"line\"><span class=\"string\">      vars:</span></span><br><span class=\"line\"><span class=\"string\">        local_dns_ip: &quot;127.0.0.1&quot; # dnsmasq listens on 127.0.0.1</span></span><br><span class=\"line\"><span class=\"string\">        # Removed: search_domain: &quot;&#123;&#123; search_domain &#125;&#125;&quot; - it&#x27;s already available from play vars</span></span><br><span class=\"line\"><span class=\"string\">      notify: Restart systemd-resolved # Or NetworkManager, depending on Ubuntu version</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">  handlers:</span></span><br><span class=\"line\"><span class=\"string\">    - name: Restart dnsmasq</span></span><br><span class=\"line\"><span class=\"string\">      ansible.builtin.systemd:</span></span><br><span class=\"line\"><span class=\"string\">        name: dnsmasq</span></span><br><span class=\"line\"><span class=\"string\">        state: restarted</span></span><br><span class=\"line\"><span class=\"string\">        enabled: yes # Ensure it&#x27;s enabled to start on boot</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">    - name: Restart systemd-resolved</span></span><br><span class=\"line\"><span class=\"string\">      ansible.builtin.systemd:</span></span><br><span class=\"line\"><span class=\"string\">        name: systemd-resolved</span></span><br><span class=\"line\"><span class=\"string\">        state: restarted</span></span><br><span class=\"line\"><span class=\"string\">      ignore_errors: yes # systemd-resolved might not be used on server installs</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># --- Create dnsmasq.conf.j2 template ---</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;Creating dnsmasq.conf.j2 template&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOF &gt; dnsmasq.conf.j2</span></span><br><span class=\"line\"><span class=\"string\"># This file is managed by Ansible. Do not edit manually.</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\"># Do not read /etc/resolv.conf, use the servers below</span></span><br><span class=\"line\"><span class=\"string\">no-resolv</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\"># Specify upstream DNS servers for forwarding</span></span><br><span class=\"line\"><span class=\"string\">server=&#123;&#123; dns_forwarder_1 &#125;&#125;</span></span><br><span class=\"line\"><span class=\"string\">server=&#123;&#123; dns_forwarder_2 &#125;&#125;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\"># Listen on localhost and the VM&#x27;s primary IP</span></span><br><span class=\"line\"><span class=\"string\">listen-address=127.0.0.1,&#123;&#123; vm_ip &#125;&#125;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\"># Allow queries from any interface</span></span><br><span class=\"line\"><span class=\"string\">interface=&#123;&#123; ansible_default_ipv4.interface &#125;&#125; # Listen on the primary network interface</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\"># Bind to the interfaces to prevent dnsmasq from listening on all interfaces</span></span><br><span class=\"line\"><span class=\"string\">bind-interfaces</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\"># Cache DNS results</span></span><br><span class=\"line\"><span class=\"string\">cache-size=150</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># --- Create resolv.conf.j2 template ---</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;Creating resolv.conf.j2 template&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOF &gt; resolv.conf.j2</span></span><br><span class=\"line\"><span class=\"string\"># This file is managed by Ansible. Do not edit manually.</span></span><br><span class=\"line\"><span class=\"string\">nameserver &#123;&#123; local_dns_ip &#125;&#125;</span></span><br><span class=\"line\"><span class=\"string\">search &#123;&#123; search_domain &#125;&#125;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># --- Run the Ansible Playbook ---</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;Running Ansible playbook to configure DNSmasq...&quot;</span></span><br><span class=\"line\">ansible-playbook -i inventory.ini setup-dnsmasq.yml -K</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># --- Final Instructions ---</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;--------------------------------------------------------&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;DNSmasq configuration complete on <span class=\"variable\">$&#123;VM_IP&#125;</span>.&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;You can now test the DNS server from the VM or from another machine.&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;From the VM, run: dig @127.0.0.1 www.cisco.com&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;From another machine on the same network, configure its DNS to <span class=\"variable\">$&#123;VM_IP&#125;</span> and run: dig www.cisco.com&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;Remember to exit the &#x27;<span class=\"variable\">$&#123;ANSIBLE_DIR&#125;</span>&#x27; directory when done (cd ..).&quot;</span></span><br></pre></td></tr></table></figure>\n\n<p>执行效果</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ois@ois:~/data/k8s$ ./ansible-dnsmasq.sh </span><br><span class=\"line\">--- Setting up Ansible environment and configuring DNSmasq on 10.75.59.76 ---</span><br><span class=\"line\">Ansible is already installed.</span><br><span class=\"line\">Creating Ansible inventory file: inventory.ini</span><br><span class=\"line\">Creating Ansible playbook: setup-dnsmasq.yml</span><br><span class=\"line\">Creating dnsmasq.conf.j2 template</span><br><span class=\"line\">Creating resolv.conf.j2 template</span><br><span class=\"line\">Running Ansible playbook to configure DNSmasq...</span><br><span class=\"line\">BECOME password: </span><br><span class=\"line\"></span><br><span class=\"line\">PLAY [Configure DNSmasq Server on Ubuntu VM] *******************************************************************************************************************************************************************************************************************</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Gathering Facts] *****************************************************************************************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [10.75.59.76]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Ensure apt cache is updated] *****************************************************************************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [10.75.59.76]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Install dnsmasq package] *********************************************************************************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [10.75.59.76]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Stop dnsmasq service before configuration] ***************************************************************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [10.75.59.76]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Backup original dnsmasq.conf] ****************************************************************************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [10.75.59.76]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Configure dnsmasq <span class=\"keyword\">for</span> forwarding] ************************************************************************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [10.75.59.76]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Set VM<span class=\"string\">&#x27;s /etc/resolv.conf to point to itself (local DNS)] ************************************************************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">changed: [10.75.59.76]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">RUNNING HANDLER [Restart dnsmasq] ******************************************************************************************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">changed: [10.75.59.76]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">RUNNING HANDLER [Restart systemd-resolved] *********************************************************************************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">changed: [10.75.59.76]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">PLAY RECAP *****************************************************************************************************************************************************************************************************************************************************</span></span><br><span class=\"line\"><span class=\"string\">10.75.59.76                : ok=9    changed=5    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">--------------------------------------------------------</span></span><br><span class=\"line\"><span class=\"string\">DNSmasq configuration complete on 10.75.59.76.</span></span><br><span class=\"line\"><span class=\"string\">You can now test the DNS server from the VM or from another machine.</span></span><br><span class=\"line\"><span class=\"string\">From the VM, run: dig @127.0.0.1 www.cisco.com</span></span><br><span class=\"line\"><span class=\"string\">From another machine on the same network, configure its DNS to 10.75.59.76 and run: dig www.cisco.com</span></span><br><span class=\"line\"><span class=\"string\">Remember to exit the &#x27;</span>ansible_dnsmasq_setup<span class=\"string\">&#x27; directory when done (cd ..).</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@dns-server-vm:~# dig @127.0.0.1 www.cisco.com</span><br><span class=\"line\"></span><br><span class=\"line\">; &lt;&lt;&gt;&gt; DiG 9.18.30-0ubuntu0.24.04.2-Ubuntu &lt;&lt;&gt;&gt; @127.0.0.1 www.cisco.com</span><br><span class=\"line\">; (1 server found)</span><br><span class=\"line\">;; global options: +cmd</span><br><span class=\"line\">;; Got answer:</span><br><span class=\"line\">;; -&gt;&gt;HEADER&lt;&lt;- <span class=\"string\">opcode: QUERY, status: NOERROR, id: 10545</span></span><br><span class=\"line\"><span class=\"string\">;; flags: qr aa rd ra; QUERY: 1, ANSWER: 3, AUTHORITY: 0, ADDITIONAL: 1</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">;; OPT PSEUDOSECTION:</span></span><br><span class=\"line\"><span class=\"string\">; EDNS: version: 0, flags:; udp: 1232</span></span><br><span class=\"line\"><span class=\"string\">; COOKIE: ba16202024b9dc8301000000688b40f90daaa0a500a50d2d (good)</span></span><br><span class=\"line\"><span class=\"string\">;; QUESTION SECTION:</span></span><br><span class=\"line\"><span class=\"string\">;www.cisco.com.                 IN      A</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">;; ANSWER SECTION:</span></span><br><span class=\"line\"><span class=\"string\">www.cisco.com.          3600    IN      CNAME   origin-www.cisco.com.</span></span><br><span class=\"line\"><span class=\"string\">origin-www.cisco.com.   1800    IN      CNAME   origin-www.xgslb-v3.cisco.com.</span></span><br><span class=\"line\"><span class=\"string\">origin-www.xgslb-v3.CISCO.com. 10 IN    A       72.163.4.161</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">;; Query time: 71 msec</span></span><br><span class=\"line\"><span class=\"string\">;; SERVER: 127.0.0.1#53(127.0.0.1) (UDP)</span></span><br><span class=\"line\"><span class=\"string\">;; WHEN: Thu Jul 31 19:10:01 JST 2025</span></span><br><span class=\"line\"><span class=\"string\">;; MSG SIZE  rcvd: 183</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"3-3-使用Ansible更新Node-的DNS配置\"><a href=\"#3-3-使用Ansible更新Node-的DNS配置\" class=\"headerlink\" title=\"3.3 使用Ansible更新Node 的DNS配置\"></a>3.3 使用Ansible更新Node 的DNS配置</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#!/bin/bash</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># --- Configuration ---</span></span><br><span class=\"line\">ANSIBLE_DIR=<span class=\"string\">&quot;ansible_dns_update&quot;</span></span><br><span class=\"line\">INVENTORY_FILE=<span class=\"string\">&quot;<span class=\"variable\">$&#123;ANSIBLE_DIR&#125;</span>/hosts.ini&quot;</span></span><br><span class=\"line\">PLAYBOOK_FILE=<span class=\"string\">&quot;<span class=\"variable\">$&#123;ANSIBLE_DIR&#125;</span>/update_dns.yml&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Kubernetes Node IPs (ensure these match your actual VM IPs)</span></span><br><span class=\"line\">KUBE_NODE_1_IP=<span class=\"string\">&quot;10.75.59.71&quot;</span></span><br><span class=\"line\">KUBE_NODE_2_IP=<span class=\"string\">&quot;10.75.59.72&quot;</span></span><br><span class=\"line\">KUBE_NODE_3_IP=<span class=\"string\">&quot;10.75.59.73&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Common Ansible user and Python interpreter</span></span><br><span class=\"line\">ANSIBLE_USER=<span class=\"string\">&quot;ubuntu&quot;</span></span><br><span class=\"line\">ANSIBLE_PYTHON_INTERPRETER=<span class=\"string\">&quot;/usr/bin/python3&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># --- Functions ---</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Function to check and install Ansible</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">install_ansible</span></span>() &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ! <span class=\"built_in\">command</span> -v ansible &amp;&gt; /dev/null</span><br><span class=\"line\">    <span class=\"keyword\">then</span></span><br><span class=\"line\">        <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Ansible not found. Attempting to install Ansible...&quot;</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> [ -f /etc/debian_version ]; <span class=\"keyword\">then</span></span><br><span class=\"line\">            <span class=\"comment\"># Debian/Ubuntu</span></span><br><span class=\"line\">            <span class=\"built_in\">sudo</span> apt update</span><br><span class=\"line\">            <span class=\"built_in\">sudo</span> apt install -y software-properties-common</span><br><span class=\"line\">            <span class=\"built_in\">sudo</span> add-apt-repository --<span class=\"built_in\">yes</span> --update ppa:ansible/ansible</span><br><span class=\"line\">            <span class=\"built_in\">sudo</span> apt install -y ansible</span><br><span class=\"line\">        <span class=\"keyword\">elif</span> [ -f /etc/redhat-release ]; <span class=\"keyword\">then</span></span><br><span class=\"line\">            <span class=\"comment\"># CentOS/RHEL/Fedora</span></span><br><span class=\"line\">            <span class=\"built_in\">sudo</span> yum install -y epel-release</span><br><span class=\"line\">            <span class=\"built_in\">sudo</span> yum install -y ansible</span><br><span class=\"line\">        <span class=\"keyword\">else</span></span><br><span class=\"line\">            <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Unsupported OS for automatic Ansible installation. Please install Ansible manually.&quot;</span></span><br><span class=\"line\">            <span class=\"built_in\">exit</span> 1</span><br><span class=\"line\">        <span class=\"keyword\">fi</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> ! <span class=\"built_in\">command</span> -v ansible &amp;&gt; /dev/null; <span class=\"keyword\">then</span></span><br><span class=\"line\">            <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Ansible installation failed. Please install it manually and re-run this script.&quot;</span></span><br><span class=\"line\">            <span class=\"built_in\">exit</span> 1</span><br><span class=\"line\">        <span class=\"keyword\">fi</span></span><br><span class=\"line\">        <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Ansible installed successfully.&quot;</span></span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">        <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Ansible is already installed.&quot;</span></span><br><span class=\"line\">    <span class=\"keyword\">fi</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Function to create Ansible inventory file</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">create_inventory</span></span>() &#123;</span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Creating Ansible inventory file: <span class=\"variable\">$&#123;INVENTORY_FILE&#125;</span>&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">mkdir</span> -p <span class=\"string\">&quot;<span class=\"variable\">$ANSIBLE_DIR</span>&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOF &gt; &quot;$INVENTORY_FILE&quot;</span></span><br><span class=\"line\"><span class=\"string\">[kubernetes_nodes]</span></span><br><span class=\"line\"><span class=\"string\">kube-node-1 ansible_host=$&#123;KUBE_NODE_1_IP&#125;</span></span><br><span class=\"line\"><span class=\"string\">kube-node-2 ansible_host=$&#123;KUBE_NODE_2_IP&#125;</span></span><br><span class=\"line\"><span class=\"string\">kube-node-3 ansible_host=$&#123;KUBE_NODE_3_IP&#125;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">[all:vars]</span></span><br><span class=\"line\"><span class=\"string\">ansible_user=$&#123;ANSIBLE_USER&#125;</span></span><br><span class=\"line\"><span class=\"string\">ansible_python_interpreter=$&#123;ANSIBLE_PYTHON_INTERPRETER&#125;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Inventory file created.&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Function to create Ansible playbook file</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">create_playbook</span></span>() &#123;</span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Creating Ansible playbook file: <span class=\"variable\">$&#123;PLAYBOOK_FILE&#125;</span>&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">mkdir</span> -p <span class=\"string\">&quot;<span class=\"variable\">$ANSIBLE_DIR</span>&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">&#x27;EOF&#x27;</span> &gt; <span class=\"string\">&quot;<span class=\"variable\">$PLAYBOOK_FILE</span>&quot;</span></span><br><span class=\"line\">---</span><br><span class=\"line\">- name: Update DNS server on Kubernetes nodes to use <span class=\"built_in\">local</span> DNS only</span><br><span class=\"line\">  hosts: kubernetes_nodes</span><br><span class=\"line\">  become: <span class=\"built_in\">yes</span> <span class=\"comment\"># This allows Ansible to run commands with sudo privileges</span></span><br><span class=\"line\"></span><br><span class=\"line\">  tasks:</span><br><span class=\"line\">    - name: Ensure netplan configuration directory exists</span><br><span class=\"line\">      ansible.builtin.file:</span><br><span class=\"line\">        path: /etc/netplan</span><br><span class=\"line\">        state: directory</span><br><span class=\"line\">        mode: <span class=\"string\">&#x27;0755&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    - name: Get current network configuration file (e.g., 00-installer-config.yaml)</span><br><span class=\"line\">      ansible.builtin.find:</span><br><span class=\"line\">        paths: /etc/netplan</span><br><span class=\"line\">        patterns: <span class=\"string\">&#x27;*.yaml&#x27;</span></span><br><span class=\"line\">        <span class=\"comment\"># We assume there&#x27;s only one primary netplan config file for simplicity.</span></span><br><span class=\"line\">        <span class=\"comment\"># If there are multiple, you might need to specify which one.</span></span><br><span class=\"line\">      register: netplan_files</span><br><span class=\"line\"></span><br><span class=\"line\">    - name: Set network config file variable</span><br><span class=\"line\">      ansible.builtin.set_fact:</span><br><span class=\"line\">        netplan_config_file: <span class=\"string\">&quot;&#123;&#123; netplan_files.files[0].path &#125;&#125;&quot;</span></span><br><span class=\"line\">      when: netplan_files.files | length &gt; 0</span><br><span class=\"line\"></span><br><span class=\"line\">    - name: Fail <span class=\"keyword\">if</span> no netplan config file found</span><br><span class=\"line\">      ansible.builtin.fail:</span><br><span class=\"line\">        msg: <span class=\"string\">&quot;No Netplan configuration file found in /etc/netplan. Cannot proceed.&quot;</span></span><br><span class=\"line\">      when: netplan_files.files | length == 0</span><br><span class=\"line\"></span><br><span class=\"line\">    - name: Read current netplan configuration</span><br><span class=\"line\">      ansible.builtin.slurp:</span><br><span class=\"line\">        src: <span class=\"string\">&quot;&#123;&#123; netplan_config_file &#125;&#125;&quot;</span></span><br><span class=\"line\">      register: current_netplan_config</span><br><span class=\"line\"></span><br><span class=\"line\">    - name: Parse current netplan configuration</span><br><span class=\"line\">      ansible.builtin.set_fact:</span><br><span class=\"line\">        parsed_netplan: <span class=\"string\">&quot;&#123;&#123; current_netplan_config[&#x27;content&#x27;] | b64decode | from_yaml &#125;&#125;&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    - name: Update nameservers <span class=\"keyword\">in</span> netplan configuration to <span class=\"built_in\">local</span> DNS only</span><br><span class=\"line\">      ansible.builtin.set_fact:</span><br><span class=\"line\">        updated_netplan: <span class=\"string\">&quot;&#123;&#123; parsed_netplan | combine(</span></span><br><span class=\"line\"><span class=\"string\">            &#123;</span></span><br><span class=\"line\"><span class=\"string\">              &#x27;network&#x27;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">                &#x27;ethernets&#x27;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">                  &#x27;enp1s0&#x27;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">                    &#x27;nameservers&#x27;: &#123;</span></span><br><span class=\"line\"><span class=\"string\">                      &#x27;addresses&#x27;: [&#x27;10.75.59.76&#x27;],</span></span><br><span class=\"line\"><span class=\"string\">                      &#x27;search&#x27;: [&#x27;cisco.com&#x27;]</span></span><br><span class=\"line\"><span class=\"string\">                    &#125;</span></span><br><span class=\"line\"><span class=\"string\">                  &#125;</span></span><br><span class=\"line\"><span class=\"string\">                &#125;</span></span><br><span class=\"line\"><span class=\"string\">              &#125;</span></span><br><span class=\"line\"><span class=\"string\">            &#125;, recursive=True) &#125;&#125;&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    - name: Write updated netplan configuration</span><br><span class=\"line\">      ansible.builtin.copy:</span><br><span class=\"line\">        content: <span class=\"string\">&quot;&#123;&#123; updated_netplan | to_yaml &#125;&#125;&quot;</span></span><br><span class=\"line\">        dest: <span class=\"string\">&quot;&#123;&#123; netplan_config_file &#125;&#125;&quot;</span></span><br><span class=\"line\">        mode: <span class=\"string\">&#x27;0600&#x27;</span></span><br><span class=\"line\">      notify: Apply Netplan Configuration</span><br><span class=\"line\"></span><br><span class=\"line\">  handlers:</span><br><span class=\"line\">    - name: Apply Netplan Configuration</span><br><span class=\"line\">      ansible.builtin.command: netplan apply</span><br><span class=\"line\">      listen: <span class=\"string\">&quot;Apply Netplan Configuration&quot;</span></span><br><span class=\"line\">EOF</span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Playbook file created.&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># --- Main Script Execution ---</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;Starting Ansible DNS update process...&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 1. Install Ansible if not present</span></span><br><span class=\"line\">install_ansible</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2. Create Ansible inventory file</span></span><br><span class=\"line\">create_inventory</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 3. Create Ansible playbook file</span></span><br><span class=\"line\">create_playbook</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 4. Run the Ansible playbook</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;Running Ansible playbook to update DNS on Kubernetes nodes...&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;You will be prompted for the &#x27;sudo&#x27; password for the &#x27;ubuntu&#x27; user on your VMs.&quot;</span></span><br><span class=\"line\">ansible-playbook -i <span class=\"string\">&quot;<span class=\"variable\">$INVENTORY_FILE</span>&quot;</span> <span class=\"string\">&quot;<span class=\"variable\">$PLAYBOOK_FILE</span>&quot;</span> --ask-become-pass</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> [ $? -eq 0 ]; <span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Ansible playbook executed successfully.&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Your Kubernetes nodes should now be configured to use 10.75.59.76 as their only DNS server.&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">else</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Ansible playbook failed. Please check the output for errors.&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;Process complete.&quot;</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ois@ois:~/data/k8s$ ./updatedns.sh </span><br><span class=\"line\">Starting Ansible DNS update process...</span><br><span class=\"line\">Ansible is already installed.</span><br><span class=\"line\">Creating Ansible inventory file: ansible_dns_update/hosts.ini</span><br><span class=\"line\">Inventory file created.</span><br><span class=\"line\">Creating Ansible playbook file: ansible_dns_update/update_dns.yml</span><br><span class=\"line\">Playbook file created.</span><br><span class=\"line\">Running Ansible playbook to update DNS on Kubernetes nodes...</span><br><span class=\"line\">You will be prompted <span class=\"keyword\">for</span> the <span class=\"string\">&#x27;sudo&#x27;</span> password <span class=\"keyword\">for</span> the <span class=\"string\">&#x27;ubuntu&#x27;</span> user on your VMs.</span><br><span class=\"line\">BECOME password: </span><br><span class=\"line\"></span><br><span class=\"line\">PLAY [Update DNS server on Kubernetes nodes to use <span class=\"built_in\">local</span> DNS only] *********************************************************************************************************************************************************************************************</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Gathering Facts] *****************************************************************************************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [kube-node-1]</span><br><span class=\"line\">ok: [kube-node-2]</span><br><span class=\"line\">ok: [kube-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Ensure netplan configuration directory exists] ***********************************************************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [kube-node-3]</span><br><span class=\"line\">ok: [kube-node-2]</span><br><span class=\"line\">ok: [kube-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Get current network configuration file (e.g., 00-installer-config.yaml)] *********************************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [kube-node-3]</span><br><span class=\"line\">ok: [kube-node-1]</span><br><span class=\"line\">ok: [kube-node-2]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Set network config file variable] ************************************************************************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [kube-node-1]</span><br><span class=\"line\">ok: [kube-node-2]</span><br><span class=\"line\">ok: [kube-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Fail <span class=\"keyword\">if</span> no netplan config file found] ********************************************************************************************************************************************************************************************************************</span><br><span class=\"line\">skipping: [kube-node-1]</span><br><span class=\"line\">skipping: [kube-node-2]</span><br><span class=\"line\">skipping: [kube-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Read current netplan configuration] **********************************************************************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [kube-node-3]</span><br><span class=\"line\">ok: [kube-node-1]</span><br><span class=\"line\">ok: [kube-node-2]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Parse current netplan configuration] *********************************************************************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [kube-node-1]</span><br><span class=\"line\">ok: [kube-node-2]</span><br><span class=\"line\">ok: [kube-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Update nameservers <span class=\"keyword\">in</span> netplan configuration to <span class=\"built_in\">local</span> DNS only] *******************************************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [kube-node-1]</span><br><span class=\"line\">ok: [kube-node-2]</span><br><span class=\"line\">ok: [kube-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Write updated netplan configuration] *********************************************************************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [kube-node-3]</span><br><span class=\"line\">ok: [kube-node-1]</span><br><span class=\"line\">ok: [kube-node-2]</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY RECAP *****************************************************************************************************************************************************************************************************************************************************</span><br><span class=\"line\">kube-node-1                : ok=8    changed=0    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   </span><br><span class=\"line\">kube-node-2                : ok=8    changed=0    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   </span><br><span class=\"line\">kube-node-3                : ok=8    changed=0    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   </span><br><span class=\"line\"></span><br><span class=\"line\">Ansible playbook executed successfully.</span><br><span class=\"line\">Your Kubernetes nodes should now be configured to use 10.75.59.76 as their only DNS server.</span><br><span class=\"line\">Process complete.</span><br><span class=\"line\"></span><br><span class=\"line\">root@kube-node-1:~# <span class=\"built_in\">cat</span> /etc/resolv.conf </span><br><span class=\"line\"><span class=\"comment\"># This is /run/systemd/resolve/stub-resolv.conf managed by man:systemd-resolved(8).</span></span><br><span class=\"line\"><span class=\"comment\"># Do not edit.</span></span><br><span class=\"line\"><span class=\"comment\">#</span></span><br><span class=\"line\"><span class=\"comment\"># This file might be symlinked as /etc/resolv.conf. If you&#x27;re looking at</span></span><br><span class=\"line\"><span class=\"comment\"># /etc/resolv.conf and seeing this text, you have followed the symlink.</span></span><br><span class=\"line\"><span class=\"comment\">#</span></span><br><span class=\"line\"><span class=\"comment\"># This is a dynamic resolv.conf file for connecting local clients to the</span></span><br><span class=\"line\"><span class=\"comment\"># internal DNS stub resolver of systemd-resolved. This file lists all</span></span><br><span class=\"line\"><span class=\"comment\"># configured search domains.</span></span><br><span class=\"line\"><span class=\"comment\">#</span></span><br><span class=\"line\"><span class=\"comment\"># Run &quot;resolvectl status&quot; to see details about the uplink DNS servers</span></span><br><span class=\"line\"><span class=\"comment\"># currently in use.</span></span><br><span class=\"line\"><span class=\"comment\">#</span></span><br><span class=\"line\"><span class=\"comment\"># Third party programs should typically not access this file directly, but only</span></span><br><span class=\"line\"><span class=\"comment\"># through the symlink at /etc/resolv.conf. To manage man:resolv.conf(5) in a</span></span><br><span class=\"line\"><span class=\"comment\"># different way, replace this symlink by a static file or a different symlink.</span></span><br><span class=\"line\"><span class=\"comment\">#</span></span><br><span class=\"line\"><span class=\"comment\"># See man:systemd-resolved.service(8) for details about the supported modes of</span></span><br><span class=\"line\"><span class=\"comment\"># operation for /etc/resolv.conf.</span></span><br><span class=\"line\"></span><br><span class=\"line\">nameserver 127.0.0.53</span><br><span class=\"line\">options edns0 trust-ad</span><br><span class=\"line\">search cisco.com</span><br><span class=\"line\">root@kube-node-1:~# <span class=\"built_in\">cat</span> /etc/netplan/50-cloud-init.yaml </span><br><span class=\"line\">network:</span><br><span class=\"line\">  ethernets:</span><br><span class=\"line\">    enp1s0:</span><br><span class=\"line\">      addresses: [10.75.59.71/24]</span><br><span class=\"line\">      nameservers:</span><br><span class=\"line\">        addresses: [10.75.59.76]</span><br><span class=\"line\">        search: [cisco.com]</span><br><span class=\"line\">      routes:</span><br><span class=\"line\">      - &#123;to: default, via: 10.75.59.1&#125;</span><br><span class=\"line\">  version: 2</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"3-4-使用Ansible配置FRR-BGP\"><a href=\"#3-4-使用Ansible配置FRR-BGP\" class=\"headerlink\" title=\"3.4 使用Ansible配置FRR BGP\"></a>3.4 使用Ansible配置FRR BGP</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#!/bin/bash</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># This script automates the setup of an Ansible environment for installing and configuring FRRouting (FRR).</span></span><br><span class=\"line\"><span class=\"comment\"># It creates the project directory, inventory, configuration, and the playbook</span></span><br><span class=\"line\"><span class=\"comment\"># with an idempotent role to install and configure FRR.</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># --- Configuration ---</span></span><br><span class=\"line\">PROJECT_DIR=<span class=\"string\">&quot;ansible-frr-setup&quot;</span> <span class=\"comment\"># Changed project directory name</span></span><br><span class=\"line\">FRR_NODE_IP=<span class=\"string\">&quot;10.75.59.76&quot;</span> <span class=\"comment\"># IP address of your FRR VM (frr-server-vm)</span></span><br><span class=\"line\">ANSIBLE_USER=<span class=\"string\">&quot;ubuntu&quot;</span> <span class=\"comment\"># The user created by cloud-init on your VMs</span></span><br><span class=\"line\">SSH_PRIVATE_KEY_PATH=<span class=\"string\">&quot;~/.ssh/id_rsa&quot;</span> <span class=\"comment\"># Path to your SSH private key on the Ansible control machine</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># FRR specific configuration</span></span><br><span class=\"line\">FRR_AS=65000 <span class=\"comment\"># The Autonomous System number for this FRR node (example AS, choose your own)</span></span><br><span class=\"line\">K8S_MASTER_IP=<span class=\"string\">&quot;10.75.59.71&quot;</span> <span class=\"comment\"># From your create-vms.sh script</span></span><br><span class=\"line\">K8S_WORKER_1_IP=<span class=\"string\">&quot;10.75.59.72&quot;</span> <span class=\"comment\"># From your create-vms.sh script</span></span><br><span class=\"line\">K8S_WORKER_2_IP=<span class=\"string\">&quot;10.75.59.73&quot;</span> <span class=\"comment\"># From your create-vms.sh script</span></span><br><span class=\"line\">CILIUM_BGP_AS=65000 <span class=\"comment\"># AS for Cilium as per your CiliumBGPClusterConfig</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># --- Functions ---</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Function to install Ansible (if not already installed)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">install_ansible</span></span>() &#123;</span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;--- Installing Ansible ---&quot;</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> ! <span class=\"built_in\">command</span> -v ansible &amp;&gt; /dev/null; <span class=\"keyword\">then</span></span><br><span class=\"line\">        <span class=\"built_in\">sudo</span> apt update -y</span><br><span class=\"line\">        <span class=\"built_in\">sudo</span> apt install -y ansible</span><br><span class=\"line\">        <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Ansible installed successfully.&quot;</span></span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">        <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Ansible is already installed.&quot;</span></span><br><span class=\"line\">    <span class=\"keyword\">fi</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Function to create project directory and navigate into it</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">create_project_dir</span></span>() &#123;</span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;--- Creating project directory: <span class=\"variable\">$&#123;PROJECT_DIR&#125;</span> ---&quot;</span></span><br><span class=\"line\">    <span class=\"comment\"># Check if directory exists, if so, just navigate, otherwise create and navigate</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> [ ! -d <span class=\"string\">&quot;<span class=\"variable\">$&#123;PROJECT_DIR&#125;</span>&quot;</span> ]; <span class=\"keyword\">then</span></span><br><span class=\"line\">        <span class=\"built_in\">mkdir</span> -p <span class=\"string\">&quot;<span class=\"variable\">$&#123;PROJECT_DIR&#125;</span>&quot;</span></span><br><span class=\"line\">        <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Created new directory: <span class=\"variable\">$&#123;PROJECT_DIR&#125;</span>&quot;</span></span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">        <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Directory <span class=\"variable\">$&#123;PROJECT_DIR&#125;</span> already exists.&quot;</span></span><br><span class=\"line\">    <span class=\"keyword\">fi</span></span><br><span class=\"line\">    <span class=\"built_in\">cd</span> <span class=\"string\">&quot;<span class=\"variable\">$&#123;PROJECT_DIR&#125;</span>&quot;</span> || &#123; <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Failed to change directory to <span class=\"variable\">$&#123;PROJECT_DIR&#125;</span>. Exiting.&quot;</span>; <span class=\"built_in\">exit</span> 1; &#125;</span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Changed to directory: <span class=\"subst\">$(pwd)</span>&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Function to create ansible.cfg</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">create_ansible_cfg</span></span>() &#123;</span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;--- Creating ansible.cfg ---&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOF &gt; ansible.cfg</span></span><br><span class=\"line\"><span class=\"string\">[defaults]</span></span><br><span class=\"line\"><span class=\"string\">inventory = inventory.ini</span></span><br><span class=\"line\"><span class=\"string\">roles_path = ./roles</span></span><br><span class=\"line\"><span class=\"string\">host_key_checking = False # WARNING: Disable host key checking for convenience. Re-enable for production!</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;ansible.cfg created.&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Function to create inventory.ini</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">create_inventory</span></span>() &#123;</span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;--- Creating inventory.ini ---&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOF &gt; inventory.ini</span></span><br><span class=\"line\"><span class=\"string\">[frr_nodes]</span></span><br><span class=\"line\"><span class=\"string\">frr-node-1 ansible_host=$&#123;FRR_NODE_IP&#125;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">[all:vars]</span></span><br><span class=\"line\"><span class=\"string\">ansible_user=$&#123;ANSIBLE_USER&#125;</span></span><br><span class=\"line\"><span class=\"string\">ansible_ssh_private_key_file=$&#123;SSH_PRIVATE_KEY_PATH&#125;</span></span><br><span class=\"line\"><span class=\"string\">ansible_python_interpreter=/usr/bin/python3</span></span><br><span class=\"line\"><span class=\"string\">FRR_AS=$&#123;FRR_AS&#125;</span></span><br><span class=\"line\"><span class=\"string\">K8S_MASTER_IP=$&#123;K8S_MASTER_IP&#125;</span></span><br><span class=\"line\"><span class=\"string\">K8S_WORKER_1_IP=$&#123;K8S_WORKER_1_IP&#125;</span></span><br><span class=\"line\"><span class=\"string\">K8S_WORKER_2_IP=$&#123;K8S_WORKER_2_IP&#125;</span></span><br><span class=\"line\"><span class=\"string\">CILIUM_BGP_AS=$&#123;CILIUM_BGP_AS&#125;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;inventory.ini created.&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Function to create the main playbook.yml</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">create_playbook</span></span>() &#123;</span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;--- Creating playbook.yml ---&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOF &gt; playbook.yml</span></span><br><span class=\"line\"><span class=\"string\">---</span></span><br><span class=\"line\"><span class=\"string\">- name: Install and Configure FRRouting (FRR)</span></span><br><span class=\"line\"><span class=\"string\">  hosts: frr_nodes</span></span><br><span class=\"line\"><span class=\"string\">  become: yes</span></span><br><span class=\"line\"><span class=\"string\">  roles:</span></span><br><span class=\"line\"><span class=\"string\">    - frr_setup # Changed role name to frr_setup</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;playbook.yml created.&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Function to create the FRR installation and configuration role</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">create_frr_role</span></span>() &#123; <span class=\"comment\"># Changed function name from create_gobgp_role</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;--- Creating Ansible role for FRR setup ---&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">mkdir</span> -p roles/frr_setup/tasks</span><br><span class=\"line\">    <span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOF &gt; roles/frr_setup/tasks/main.yml</span></span><br><span class=\"line\"><span class=\"string\">---</span></span><br><span class=\"line\"><span class=\"string\">- name: Install FRRouting (FRR)</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.apt:</span></span><br><span class=\"line\"><span class=\"string\">    name: frr</span></span><br><span class=\"line\"><span class=\"string\">    state: present</span></span><br><span class=\"line\"><span class=\"string\">    update_cache: yes</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Configure FRR daemons (enable zebra and bgpd)</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.lineinfile:</span></span><br><span class=\"line\"><span class=\"string\">    path: /etc/frr/daemons</span></span><br><span class=\"line\"><span class=\"string\">    regexp: &#x27;^(zebra|bgpd)=&#x27;</span></span><br><span class=\"line\"><span class=\"string\">    line: &#x27;\\1=yes&#x27;</span></span><br><span class=\"line\"><span class=\"string\">    state: present</span></span><br><span class=\"line\"><span class=\"string\">    backrefs: yes # Required to make regexp work for replacement</span></span><br><span class=\"line\"><span class=\"string\">  notify: Restart FRR service</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Configure frr.conf</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.copy:</span></span><br><span class=\"line\"><span class=\"string\">    dest: /etc/frr/frr.conf</span></span><br><span class=\"line\"><span class=\"string\">    content: |</span></span><br><span class=\"line\"><span class=\"string\">      !</span></span><br><span class=\"line\"><span class=\"string\">      hostname &#123;&#123; ansible_hostname &#125;&#125;</span></span><br><span class=\"line\"><span class=\"string\">      password zebra</span></span><br><span class=\"line\"><span class=\"string\">      enable password zebra</span></span><br><span class=\"line\"><span class=\"string\">      !</span></span><br><span class=\"line\"><span class=\"string\">      log syslog informational</span></span><br><span class=\"line\"><span class=\"string\">      !</span></span><br><span class=\"line\"><span class=\"string\">      router bgp &#123;&#123; FRR_AS &#125;&#125;</span></span><br><span class=\"line\"><span class=\"string\">       bgp router-id &#123;&#123; ansible_host &#125;&#125;</span></span><br><span class=\"line\"><span class=\"string\">       !</span></span><br><span class=\"line\"><span class=\"string\">       neighbor &#123;&#123; K8S_MASTER_IP &#125;&#125; remote-as &#123;&#123; CILIUM_BGP_AS &#125;&#125;</span></span><br><span class=\"line\"><span class=\"string\">       neighbor &#123;&#123; K8S_WORKER_1_IP &#125;&#125; remote-as &#123;&#123; CILIUM_BGP_AS &#125;&#125;</span></span><br><span class=\"line\"><span class=\"string\">       neighbor &#123;&#123; K8S_WORKER_2_IP &#125;&#125; remote-as &#123;&#123; CILIUM_BGP_AS &#125;&#125;</span></span><br><span class=\"line\"><span class=\"string\">       !</span></span><br><span class=\"line\"><span class=\"string\">       address-family ipv4 unicast</span></span><br><span class=\"line\"><span class=\"string\">        # Crucial: Redistribute BGP learned routes into the kernel</span></span><br><span class=\"line\"><span class=\"string\">        redistribute connected</span></span><br><span class=\"line\"><span class=\"string\">        redistribute static</span></span><br><span class=\"line\"><span class=\"string\">        redistribute kernel</span></span><br><span class=\"line\"><span class=\"string\">       exit-address-family</span></span><br><span class=\"line\"><span class=\"string\">      !</span></span><br><span class=\"line\"><span class=\"string\">      line vty</span></span><br><span class=\"line\"><span class=\"string\">      !</span></span><br><span class=\"line\"><span class=\"string\">    mode: &#x27;0644&#x27;</span></span><br><span class=\"line\"><span class=\"string\">  notify: Restart FRR service # Handler only runs if file content changes</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Set permissions for frr.conf</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.file:</span></span><br><span class=\"line\"><span class=\"string\">    path: /etc/frr/frr.conf</span></span><br><span class=\"line\"><span class=\"string\">    owner: frr</span></span><br><span class=\"line\"><span class=\"string\">    group: frr</span></span><br><span class=\"line\"><span class=\"string\">    mode: &#x27;0640&#x27;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Enable and start FRR service</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.systemd:</span></span><br><span class=\"line\"><span class=\"string\">    name: frr</span></span><br><span class=\"line\"><span class=\"string\">    state: started</span></span><br><span class=\"line\"><span class=\"string\">    enabled: yes</span></span><br><span class=\"line\"><span class=\"string\">    daemon_reload: yes # Ensure systemd reloads unit files if service file changed</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">mkdir</span> -p roles/frr_setup/handlers</span><br><span class=\"line\">    <span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOF &gt; roles/frr_setup/handlers/main.yml</span></span><br><span class=\"line\"><span class=\"string\">---</span></span><br><span class=\"line\"><span class=\"string\">- name: Restart FRR service</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.systemd:</span></span><br><span class=\"line\"><span class=\"string\">    name: frr</span></span><br><span class=\"line\"><span class=\"string\">    state: restarted</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;FRR Ansible role created.&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># --- Main execution ---</span></span><br><span class=\"line\">install_ansible</span><br><span class=\"line\">create_project_dir</span><br><span class=\"line\">create_ansible_cfg</span><br><span class=\"line\">create_inventory</span><br><span class=\"line\">create_playbook</span><br><span class=\"line\">create_frr_role <span class=\"comment\"># Changed function call</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;--- Ansible setup for FRR installation is complete! ---&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;Navigate to the new project directory:&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;cd <span class=\"variable\">$&#123;PROJECT_DIR&#125;</span>&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;Then, run the Ansible playbook to install and configure FRR on your VM:&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;ansible-playbook playbook.yml -K&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;After the playbook finishes, FRR should be running and configured on <span class=\"variable\">$&#123;FRR_NODE_IP&#125;</span>.&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;You can SSH into the VM and verify with &#x27;sudo vtysh -c \\&quot;show ip bgp summary\\&quot;&#x27; and &#x27;sudo ip route show&#x27;.&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">ois@ois:~/data/k8s$ ./ansible-frr.sh </span><br><span class=\"line\">--- Installing Ansible ---</span><br><span class=\"line\">Ansible is already installed.</span><br><span class=\"line\">--- Creating project directory: ansible-frr-setup ---</span><br><span class=\"line\">Created new directory: ansible-frr-setup</span><br><span class=\"line\">Changed to directory: /home/ois/data/k8s/ansible-frr-setup</span><br><span class=\"line\">--- Creating ansible.cfg ---</span><br><span class=\"line\">ansible.cfg created.</span><br><span class=\"line\">--- Creating inventory.ini ---</span><br><span class=\"line\">inventory.ini created.</span><br><span class=\"line\">--- Creating playbook.yml ---</span><br><span class=\"line\">playbook.yml created.</span><br><span class=\"line\">--- Creating Ansible role <span class=\"keyword\">for</span> FRR setup ---</span><br><span class=\"line\">FRR Ansible role created.</span><br><span class=\"line\"></span><br><span class=\"line\">--- Ansible setup <span class=\"keyword\">for</span> FRR installation is complete! ---</span><br><span class=\"line\">Navigate to the new project directory:</span><br><span class=\"line\"><span class=\"built_in\">cd</span> ansible-frr-setup</span><br><span class=\"line\"></span><br><span class=\"line\">Then, run the Ansible playbook to install and configure FRR on your VM:</span><br><span class=\"line\">ansible-playbook playbook.yml -K</span><br><span class=\"line\"></span><br><span class=\"line\">After the playbook finishes, FRR should be running and configured on 10.75.59.76.</span><br><span class=\"line\">You can SSH into the VM and verify with <span class=\"string\">&#x27;sudo vtysh -c &quot;show ip bgp summary&quot;&#x27;</span> and <span class=\"string\">&#x27;sudo ip route show&#x27;</span>.</span><br><span class=\"line\">ois@ois:~/data/k8s$ <span class=\"built_in\">cd</span> ansible-frr-setup/</span><br><span class=\"line\">ois@ois:~/data/k8s/ansible-frr-setup$ ansible-playbook playbook.yml -K</span><br><span class=\"line\">BECOME password: </span><br><span class=\"line\"></span><br><span class=\"line\">PLAY [Install and Configure FRRouting (FRR)] *******************************************************************************************************************************************************************************************************************</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Gathering Facts] *****************************************************************************************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [frr-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [frr_setup : Install FRRouting (FRR)] *********************************************************************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [frr-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [frr_setup : Configure FRR daemons (<span class=\"built_in\">enable</span> zebra and bgpd)] ***********************************************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [frr-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [frr_setup : Configure frr.conf] **************************************************************************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [frr-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [frr_setup : Set permissions <span class=\"keyword\">for</span> frr.conf] ****************************************************************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [frr-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [frr_setup : Enable and start FRR service] ****************************************************************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [frr-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">RUNNING HANDLER [frr_setup : Restart FRR service] **************************************************************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [frr-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY RECAP *****************************************************************************************************************************************************************************************************************************************************</span><br><span class=\"line\">frr-node-1                 : ok=7    changed=5    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@dns-server-vm:~# <span class=\"built_in\">cat</span> /etc/frr/frr.conf </span><br><span class=\"line\">!</span><br><span class=\"line\">hostname dns-server-vm</span><br><span class=\"line\">password zebra</span><br><span class=\"line\"><span class=\"built_in\">enable</span> password zebra</span><br><span class=\"line\">!</span><br><span class=\"line\"><span class=\"built_in\">log</span> syslog informational</span><br><span class=\"line\">!</span><br><span class=\"line\">router bgp 65000</span><br><span class=\"line\"> bgp router-id 10.75.59.76</span><br><span class=\"line\"> !</span><br><span class=\"line\"> neighbor 10.75.59.71 remote-as 65000</span><br><span class=\"line\"> neighbor 10.75.59.72 remote-as 65000</span><br><span class=\"line\"> neighbor 10.75.59.73 remote-as 65000</span><br><span class=\"line\"> !</span><br><span class=\"line\"> address-family ipv4 unicast</span><br><span class=\"line\">  <span class=\"comment\"># Crucial: Redistribute BGP learned routes into the kernel</span></span><br><span class=\"line\">  redistribute connected</span><br><span class=\"line\">  redistribute static</span><br><span class=\"line\">  redistribute kernel</span><br><span class=\"line\"> exit-address-family</span><br><span class=\"line\">!</span><br><span class=\"line\">line vty</span><br><span class=\"line\">!</span><br><span class=\"line\">root@dns-server-vm:~# systemctl status frr</span><br><span class=\"line\">* frr.service - FRRouting</span><br><span class=\"line\">     Loaded: loaded (/usr/lib/systemd/system/frr.service; enabled; preset: enabled)</span><br><span class=\"line\">     Active: active (running) since Wed 2025-07-23 12:16:58 JST; 1 week 1 day ago</span><br><span class=\"line\">       Docs: https://frrouting.readthedocs.io/en/latest/setup.html</span><br><span class=\"line\">    Process: 15611 ExecStart=/usr/lib/frr/frrinit.sh start (code=exited, status=0/SUCCESS)</span><br><span class=\"line\">   Main PID: 15623 (watchfrr)</span><br><span class=\"line\">     Status: <span class=\"string\">&quot;FRR Operational&quot;</span></span><br><span class=\"line\">      Tasks: 13 (<span class=\"built_in\">limit</span>: 9486)</span><br><span class=\"line\">     Memory: 21.1M (peak: 28.3M)</span><br><span class=\"line\">        CPU: 5min 23.845s</span><br><span class=\"line\">     CGroup: /system.slice/frr.service</span><br><span class=\"line\">             |-15623 /usr/lib/frr/watchfrr -d -F traditional zebra bgpd staticd</span><br><span class=\"line\">             |-15636 /usr/lib/frr/zebra -d -F traditional -A 127.0.0.1 -s 90000000</span><br><span class=\"line\">             |-15641 /usr/lib/frr/bgpd -d -F traditional -A 127.0.0.1</span><br><span class=\"line\">             `-15648 /usr/lib/frr/staticd -d -F traditional -A 127.0.0.1</span><br><span class=\"line\"></span><br><span class=\"line\">Jul 31 16:26:25 dns-server-vm bgpd[15641]: [M59KS-A3ZXZ] bgp_update_receive: rcvd End-of-RIB <span class=\"keyword\">for</span> IPv4 Unicast from 10.75.59.71 <span class=\"keyword\">in</span> vrf default</span><br><span class=\"line\">Jul 31 16:27:24 dns-server-vm bgpd[15641]: [M59KS-A3ZXZ] bgp_update_receive: rcvd End-of-RIB <span class=\"keyword\">for</span> IPv4 Unicast from 10.75.59.73 <span class=\"keyword\">in</span> vrf default</span><br><span class=\"line\">Jul 31 16:27:24 dns-server-vm bgpd[15641]: [M59KS-A3ZXZ] bgp_update_receive: rcvd End-of-RIB <span class=\"keyword\">for</span> IPv4 Unicast from 10.75.59.72 <span class=\"keyword\">in</span> vrf default</span><br><span class=\"line\">Jul 31 16:27:24 dns-server-vm bgpd[15641]: [M59KS-A3ZXZ] bgp_update_receive: rcvd End-of-RIB <span class=\"keyword\">for</span> IPv4 Unicast from 10.75.59.71 <span class=\"keyword\">in</span> vrf default</span><br><span class=\"line\">Jul 31 16:46:48 dns-server-vm bgpd[15641]: [M59KS-A3ZXZ] bgp_update_receive: rcvd End-of-RIB <span class=\"keyword\">for</span> IPv4 Unicast from 10.75.59.72 <span class=\"keyword\">in</span> vrf default</span><br><span class=\"line\">Jul 31 16:46:48 dns-server-vm bgpd[15641]: [M59KS-A3ZXZ] bgp_update_receive: rcvd End-of-RIB <span class=\"keyword\">for</span> IPv4 Unicast from 10.75.59.73 <span class=\"keyword\">in</span> vrf default</span><br><span class=\"line\">Jul 31 16:46:48 dns-server-vm bgpd[15641]: [M59KS-A3ZXZ] bgp_update_receive: rcvd End-of-RIB <span class=\"keyword\">for</span> IPv4 Unicast from 10.75.59.71 <span class=\"keyword\">in</span> vrf default</span><br><span class=\"line\">Jul 31 16:47:54 dns-server-vm bgpd[15641]: [M59KS-A3ZXZ] bgp_update_receive: rcvd End-of-RIB <span class=\"keyword\">for</span> IPv4 Unicast from 10.75.59.73 <span class=\"keyword\">in</span> vrf default</span><br><span class=\"line\">Jul 31 16:47:54 dns-server-vm bgpd[15641]: [M59KS-A3ZXZ] bgp_update_receive: rcvd End-of-RIB <span class=\"keyword\">for</span> IPv4 Unicast from 10.75.59.72 <span class=\"keyword\">in</span> vrf default</span><br><span class=\"line\">Jul 31 16:47:54 dns-server-vm bgpd[15641]: [M59KS-A3ZXZ] bgp_update_receive: rcvd End-of-RIB <span class=\"keyword\">for</span> IPv4 Unicast from 10.75.59.71 <span class=\"keyword\">in</span> vrf default</span><br><span class=\"line\">root@dns-server-vm:~# ip route show</span><br><span class=\"line\">default via 10.75.59.1 dev enp1s0 proto static </span><br><span class=\"line\">10.75.59.0/24 dev enp1s0 proto kernel scope <span class=\"built_in\">link</span> src 10.75.59.76 </span><br><span class=\"line\">172.16.0.0/24 nhid 95 via 10.75.59.71 dev enp1s0 proto bgp metric 20 </span><br><span class=\"line\">172.16.1.0/24 nhid 90 via 10.75.59.72 dev enp1s0 proto bgp metric 20 </span><br><span class=\"line\">172.16.2.0/24 nhid 100 via 10.75.59.73 dev enp1s0 proto bgp metric 20 </span><br><span class=\"line\">172.16.16.1 nhid 202 proto bgp metric 20 </span><br><span class=\"line\">        nexthop via 10.75.59.72 dev enp1s0 weight 1 </span><br><span class=\"line\">        nexthop via 10.75.59.71 dev enp1s0 weight 1 </span><br><span class=\"line\">        nexthop via 10.75.59.73 dev enp1s0 weight 1 </span><br><span class=\"line\">172.16.16.10 nhid 202 proto bgp metric 20 </span><br><span class=\"line\">        nexthop via 10.75.59.72 dev enp1s0 weight 1 </span><br><span class=\"line\">        nexthop via 10.75.59.71 dev enp1s0 weight 1 </span><br><span class=\"line\">        nexthop via 10.75.59.73 dev enp1s0 weight 1 </span><br><span class=\"line\">172.16.20.119 nhid 202 proto bgp metric 20 </span><br><span class=\"line\">        nexthop via 10.75.59.72 dev enp1s0 weight 1 </span><br><span class=\"line\">        nexthop via 10.75.59.71 dev enp1s0 weight 1 </span><br><span class=\"line\">        nexthop via 10.75.59.73 dev enp1s0 weight 1 </span><br><span class=\"line\">172.16.22.26 nhid 202 proto bgp metric 20 </span><br><span class=\"line\">        nexthop via 10.75.59.72 dev enp1s0 weight 1 </span><br><span class=\"line\">        nexthop via 10.75.59.71 dev enp1s0 weight 1 </span><br><span class=\"line\">        nexthop via 10.75.59.73 dev enp1s0 weight 1 </span><br><span class=\"line\">172.16.23.18 nhid 202 proto bgp metric 20 </span><br><span class=\"line\">        nexthop via 10.75.59.72 dev enp1s0 weight 1 </span><br><span class=\"line\">        nexthop via 10.75.59.71 dev enp1s0 weight 1 </span><br><span class=\"line\">        nexthop via 10.75.59.73 dev enp1s0 weight 1 </span><br><span class=\"line\">172.16.30.170 nhid 202 proto bgp metric 20 </span><br><span class=\"line\">        nexthop via 10.75.59.72 dev enp1s0 weight 1 </span><br><span class=\"line\">        nexthop via 10.75.59.71 dev enp1s0 weight 1 </span><br><span class=\"line\">        nexthop via 10.75.59.73 dev enp1s0 weight 1 </span><br><span class=\"line\">root@dns-server-vm:~# vtysh -c <span class=\"string\">&#x27;show ip bgp summary&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">IPv4 Unicast Summary (VRF default):</span><br><span class=\"line\">BGP router identifier 10.75.59.76, <span class=\"built_in\">local</span> AS number 65000 vrf-id 0</span><br><span class=\"line\">BGP table version 222</span><br><span class=\"line\">RIB entries 19, using 3648 bytes of memory</span><br><span class=\"line\">Peers 3, using 2172 KiB of memory</span><br><span class=\"line\"></span><br><span class=\"line\">Neighbor        V         AS   MsgRcvd   MsgSent   TblVer  InQ OutQ  Up/Down State/PfxRcd   PfxSnt Desc</span><br><span class=\"line\">10.75.59.71     4      65000     71265     71182        0    0    0 03:21:08            7        2 N/A</span><br><span class=\"line\">10.75.59.72     4      65000     71344     71264        0    0    0 03:21:09            7        2 N/A</span><br><span class=\"line\">10.75.59.73     4      65000     71240     71162        0    0    0 03:21:09            7        2 N/A</span><br><span class=\"line\"></span><br><span class=\"line\">Total number of neighbors 3</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"4-设置Kubernetes集群并安装CNI-Cilium\"><a href=\"#4-设置Kubernetes集群并安装CNI-Cilium\" class=\"headerlink\" title=\"4. 设置Kubernetes集群并安装CNI Cilium\"></a>4. 设置Kubernetes集群并安装CNI Cilium</h1><h2 id=\"4-1-使用kubeadm设置Kubernetes\"><a href=\"#4-1-使用kubeadm设置Kubernetes\" class=\"headerlink\" title=\"4.1 使用kubeadm设置Kubernetes\"></a>4.1 使用kubeadm设置Kubernetes</h2><p>使用以下命令进行集群初始化</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubeadm config images pull</span><br><span class=\"line\"></span><br><span class=\"line\">kubeadm init --control-plane-endpoint=kube-node-1 --pod-network-cidr=172.16.0.0/20 --service-cidr=172.16.32.0/20 --skip-phases=addon/kube-proxy</span><br><span class=\"line\"></span><br><span class=\"line\">--skip-phases=addon/kube-proxy 表示不安装kube-proxy，会用Cilium进行替代</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ubuntu@kube-node-1:~$ <span class=\"built_in\">sudo</span> kubeadm init --control-plane-endpoint=kube-node-1 --pod-network-cidr=172.16.0.0/20 --service-cidr=172.16.32.0/20 --skip-phases=addon/kube-proxy[<span class=\"built_in\">sudo</span>] password <span class=\"keyword\">for</span> ubuntu: </span><br><span class=\"line\">[init] Using Kubernetes version: v1.33.3</span><br><span class=\"line\">[preflight] Running pre-flight checks</span><br><span class=\"line\">[preflight] Pulling images required <span class=\"keyword\">for</span> setting up a Kubernetes cluster</span><br><span class=\"line\">[preflight] This might take a minute or two, depending on the speed of your internet connection</span><br><span class=\"line\">[preflight] You can also perform this action beforehand using <span class=\"string\">&#x27;kubeadm config images pull&#x27;</span></span><br><span class=\"line\">[certs] Using certificateDir folder <span class=\"string\">&quot;/etc/kubernetes/pki&quot;</span></span><br><span class=\"line\">[certs] Generating <span class=\"string\">&quot;ca&quot;</span> certificate and key</span><br><span class=\"line\">[certs] Generating <span class=\"string\">&quot;apiserver&quot;</span> certificate and key</span><br><span class=\"line\">[certs] apiserver serving cert is signed <span class=\"keyword\">for</span> DNS names [kube-node-1 kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local] and IPs [10.248.0.1 10.75.59.71]</span><br><span class=\"line\">[certs] Generating <span class=\"string\">&quot;apiserver-kubelet-client&quot;</span> certificate and key</span><br><span class=\"line\">[certs] Generating <span class=\"string\">&quot;front-proxy-ca&quot;</span> certificate and key</span><br><span class=\"line\">[certs] Generating <span class=\"string\">&quot;front-proxy-client&quot;</span> certificate and key</span><br><span class=\"line\">[certs] Generating <span class=\"string\">&quot;etcd/ca&quot;</span> certificate and key</span><br><span class=\"line\">[certs] Generating <span class=\"string\">&quot;etcd/server&quot;</span> certificate and key</span><br><span class=\"line\">[certs] etcd/server serving cert is signed <span class=\"keyword\">for</span> DNS names [kube-node-1 localhost] and IPs [10.75.59.71 127.0.0.1 ::1]</span><br><span class=\"line\">[certs] Generating <span class=\"string\">&quot;etcd/peer&quot;</span> certificate and key</span><br><span class=\"line\">[certs] etcd/peer serving cert is signed <span class=\"keyword\">for</span> DNS names [kube-node-1 localhost] and IPs [10.75.59.71 127.0.0.1 ::1]</span><br><span class=\"line\">[certs] Generating <span class=\"string\">&quot;etcd/healthcheck-client&quot;</span> certificate and key</span><br><span class=\"line\">[certs] Generating <span class=\"string\">&quot;apiserver-etcd-client&quot;</span> certificate and key</span><br><span class=\"line\">[certs] Generating <span class=\"string\">&quot;sa&quot;</span> key and public key</span><br><span class=\"line\">[kubeconfig] Using kubeconfig folder <span class=\"string\">&quot;/etc/kubernetes&quot;</span></span><br><span class=\"line\">[kubeconfig] Writing <span class=\"string\">&quot;admin.conf&quot;</span> kubeconfig file</span><br><span class=\"line\">[kubeconfig] Writing <span class=\"string\">&quot;super-admin.conf&quot;</span> kubeconfig file</span><br><span class=\"line\">[kubeconfig] Writing <span class=\"string\">&quot;kubelet.conf&quot;</span> kubeconfig file</span><br><span class=\"line\">[kubeconfig] Writing <span class=\"string\">&quot;controller-manager.conf&quot;</span> kubeconfig file</span><br><span class=\"line\">[kubeconfig] Writing <span class=\"string\">&quot;scheduler.conf&quot;</span> kubeconfig file</span><br><span class=\"line\">[etcd] Creating static Pod manifest <span class=\"keyword\">for</span> <span class=\"built_in\">local</span> etcd <span class=\"keyword\">in</span> <span class=\"string\">&quot;/etc/kubernetes/manifests&quot;</span></span><br><span class=\"line\">[control-plane] Using manifest folder <span class=\"string\">&quot;/etc/kubernetes/manifests&quot;</span></span><br><span class=\"line\">[control-plane] Creating static Pod manifest <span class=\"keyword\">for</span> <span class=\"string\">&quot;kube-apiserver&quot;</span></span><br><span class=\"line\">[control-plane] Creating static Pod manifest <span class=\"keyword\">for</span> <span class=\"string\">&quot;kube-controller-manager&quot;</span></span><br><span class=\"line\">[control-plane] Creating static Pod manifest <span class=\"keyword\">for</span> <span class=\"string\">&quot;kube-scheduler&quot;</span></span><br><span class=\"line\">[kubelet-start] Writing kubelet environment file with flags to file <span class=\"string\">&quot;/var/lib/kubelet/kubeadm-flags.env&quot;</span></span><br><span class=\"line\">[kubelet-start] Writing kubelet configuration to file <span class=\"string\">&quot;/var/lib/kubelet/config.yaml&quot;</span></span><br><span class=\"line\">[kubelet-start] Starting the kubelet</span><br><span class=\"line\">[wait-control-plane] Waiting <span class=\"keyword\">for</span> the kubelet to boot up the control plane as static Pods from directory <span class=\"string\">&quot;/etc/kubernetes/manifests&quot;</span></span><br><span class=\"line\">[kubelet-check] Waiting <span class=\"keyword\">for</span> a healthy kubelet at http://127.0.0.1:10248/healthz. This can take up to 4m0s</span><br><span class=\"line\">[kubelet-check] The kubelet is healthy after 1.002649961s</span><br><span class=\"line\">[control-plane-check] Waiting <span class=\"keyword\">for</span> healthy control plane components. This can take up to 4m0s</span><br><span class=\"line\">[control-plane-check] Checking kube-apiserver at https://10.75.59.71:6443/livez</span><br><span class=\"line\">[control-plane-check] Checking kube-controller-manager at https://127.0.0.1:10257/healthz</span><br><span class=\"line\">[control-plane-check] Checking kube-scheduler at https://127.0.0.1:10259/livez</span><br><span class=\"line\">[control-plane-check] kube-controller-manager is healthy after 1.813351787s</span><br><span class=\"line\">[control-plane-check] kube-scheduler is healthy after 3.309147352s</span><br><span class=\"line\">[control-plane-check] kube-apiserver is healthy after 5.505049123s</span><br><span class=\"line\">[upload-config] Storing the configuration used <span class=\"keyword\">in</span> ConfigMap <span class=\"string\">&quot;kubeadm-config&quot;</span> <span class=\"keyword\">in</span> the <span class=\"string\">&quot;kube-system&quot;</span> Namespace</span><br><span class=\"line\">[kubelet] Creating a ConfigMap <span class=\"string\">&quot;kubelet-config&quot;</span> <span class=\"keyword\">in</span> namespace kube-system with the configuration <span class=\"keyword\">for</span> the kubelets <span class=\"keyword\">in</span> the cluster</span><br><span class=\"line\">[upload-certs] Skipping phase. Please see --upload-certs</span><br><span class=\"line\">[mark-control-plane] Marking the node kube-node-1 as control-plane by adding the labels: [node-role.kubernetes.io/control-plane node.kubernetes.io/exclude-from-external-load-balancers]</span><br><span class=\"line\">[mark-control-plane] Marking the node kube-node-1 as control-plane by adding the taints [node-role.kubernetes.io/control-plane:NoSchedule]</span><br><span class=\"line\">[bootstrap-token] Using token: 1r5ugd.o2pjzipcq69z71l8</span><br><span class=\"line\">[bootstrap-token] Configuring bootstrap tokens, cluster-info ConfigMap, RBAC Roles</span><br><span class=\"line\">[bootstrap-token] Configured RBAC rules to allow Node Bootstrap tokens to get nodes</span><br><span class=\"line\">[bootstrap-token] Configured RBAC rules to allow Node Bootstrap tokens to post CSRs <span class=\"keyword\">in</span> order <span class=\"keyword\">for</span> nodes to get long term certificate credentials</span><br><span class=\"line\">[bootstrap-token] Configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token</span><br><span class=\"line\">[bootstrap-token] Configured RBAC rules to allow certificate rotation <span class=\"keyword\">for</span> all node client certificates <span class=\"keyword\">in</span> the cluster</span><br><span class=\"line\">[bootstrap-token] Creating the <span class=\"string\">&quot;cluster-info&quot;</span> ConfigMap <span class=\"keyword\">in</span> the <span class=\"string\">&quot;kube-public&quot;</span> namespace</span><br><span class=\"line\">[kubelet-finalize] Updating <span class=\"string\">&quot;/etc/kubernetes/kubelet.conf&quot;</span> to point to a rotatable kubelet client certificate and key</span><br><span class=\"line\">[addons] Applied essential addon: CoreDNS</span><br><span class=\"line\"></span><br><span class=\"line\">Your Kubernetes control-plane has initialized successfully!</span><br><span class=\"line\"></span><br><span class=\"line\">To start using your cluster, you need to run the following as a regular user:</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"built_in\">mkdir</span> -p <span class=\"variable\">$HOME</span>/.kube</span><br><span class=\"line\">  <span class=\"built_in\">sudo</span> <span class=\"built_in\">cp</span> -i /etc/kubernetes/admin.conf <span class=\"variable\">$HOME</span>/.kube/config</span><br><span class=\"line\">  <span class=\"built_in\">sudo</span> <span class=\"built_in\">chown</span> $(<span class=\"built_in\">id</span> -u):$(<span class=\"built_in\">id</span> -g) <span class=\"variable\">$HOME</span>/.kube/config</span><br><span class=\"line\"></span><br><span class=\"line\">Alternatively, <span class=\"keyword\">if</span> you are the root user, you can run:</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"built_in\">export</span> KUBECONFIG=/etc/kubernetes/admin.conf</span><br><span class=\"line\"></span><br><span class=\"line\">You should now deploy a pod network to the cluster.</span><br><span class=\"line\">Run <span class=\"string\">&quot;kubectl apply -f [podnetwork].yaml&quot;</span> with one of the options listed at:</span><br><span class=\"line\">  https://kubernetes.io/docs/concepts/cluster-administration/addons/</span><br><span class=\"line\"></span><br><span class=\"line\">You can now <span class=\"built_in\">join</span> any number of control-plane nodes by copying certificate authorities</span><br><span class=\"line\">and service account keys on each node and <span class=\"keyword\">then</span> running the following as root:</span><br><span class=\"line\"></span><br><span class=\"line\">  kubeadm <span class=\"built_in\">join</span> kube-node-1:6443 --token 1r5ugd.o2pjzipcq69z71l8 \\</span><br><span class=\"line\">        --discovery-token-ca-cert-hash sha256:e29fb62581a4d21268585c3b345f9e060827c52a8325b1d28b8437c792ba7923 \\</span><br><span class=\"line\">        --control-plane </span><br><span class=\"line\"></span><br><span class=\"line\">Then you can <span class=\"built_in\">join</span> any number of worker nodes by running the following on each as root:</span><br><span class=\"line\"></span><br><span class=\"line\">kubeadm <span class=\"built_in\">join</span> kube-node-1:6443 --token 1r5ugd.o2pjzipcq69z71l8 \\</span><br><span class=\"line\">        --discovery-token-ca-cert-hash sha256:e29fb62581a4d21268585c3b345f9e060827c52a8325b1d28b8437c792ba7923 </span><br><span class=\"line\">ubuntu@kube-node-1:~$ </span><br><span class=\"line\">ubuntu@kube-node-1:~$   <span class=\"built_in\">mkdir</span> -p <span class=\"variable\">$HOME</span>/.kube</span><br><span class=\"line\">  <span class=\"built_in\">sudo</span> <span class=\"built_in\">cp</span> -i /etc/kubernetes/admin.conf <span class=\"variable\">$HOME</span>/.kube/config</span><br><span class=\"line\">  <span class=\"built_in\">sudo</span> <span class=\"built_in\">chown</span> $(<span class=\"built_in\">id</span> -u):$(<span class=\"built_in\">id</span> -g) <span class=\"variable\">$HOME</span>/.kube/config</span><br><span class=\"line\">ubuntu@kube-node-1:~$ <span class=\"built_in\">sudo</span> su</span><br><span class=\"line\">root@kube-node-1:/home/ubuntu# <span class=\"built_in\">cd</span></span><br><span class=\"line\"></span><br><span class=\"line\">在.bashrc 中增加以下内容</span><br><span class=\"line\">root@kube-node-1:~# <span class=\"built_in\">cat</span> .bashrc | grep <span class=\"built_in\">export</span></span><br><span class=\"line\"><span class=\"built_in\">export</span> KUBECONFIG=/etc/kubernetes/admin.conf</span><br><span class=\"line\"></span><br><span class=\"line\">这样root才能执行 kubectl 命令与 api-server通信.</span><br><span class=\"line\"></span><br><span class=\"line\">root@kube-node-1:~# kubectl cluster-info</span><br><span class=\"line\">Kubernetes control plane is running at https://kube-node-1:6443</span><br><span class=\"line\">CoreDNS is running at https://kube-node-1:6443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy</span><br><span class=\"line\"></span><br><span class=\"line\">To further debug and diagnose cluster problems, use <span class=\"string\">&#x27;kubectl cluster-info dump&#x27;</span>.</span><br><span class=\"line\">root@kube-node-1:~# kubectl get node -o wide</span><br><span class=\"line\">NAME          STATUS     ROLES           AGE   VERSION   INTERNAL-IP   EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION     CONTAINER-RUNTIME</span><br><span class=\"line\">kube-node-1   NotReady   control-plane   68s   v1.33.3   10.75.59.71   &lt;none&gt;        Ubuntu 24.04.2 LTS   6.8.0-63-generic   containerd://1.7.27</span><br><span class=\"line\"></span><br><span class=\"line\">还没有安装CNI，Node NotReady</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"4-2-使用Ansible安装Helm\"><a href=\"#4-2-使用Ansible安装Helm\" class=\"headerlink\" title=\"4.2 使用Ansible安装Helm\"></a>4.2 使用Ansible安装Helm</h2><p>设置Helm的目的是为了安装Cilium，并非一定要使用Ansible来进行设置，供参考。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#!/bin/bash</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># This script automates the setup of an Ansible environment for installing Helm.</span></span><br><span class=\"line\"><span class=\"comment\"># It creates the project directory, inventory, configuration, and the playbook</span></span><br><span class=\"line\"><span class=\"comment\"># with an idempotent role to install Helm.</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># --- Configuration ---</span></span><br><span class=\"line\">PROJECT_DIR=<span class=\"string\">&quot;ansible-helm&quot;</span></span><br><span class=\"line\">MASTER_NODE_IP=<span class=\"string\">&quot;10.75.59.71&quot;</span> <span class=\"comment\"># IP address of your Kubernetes master node (kube-node-1)</span></span><br><span class=\"line\">ANSIBLE_USER=<span class=\"string\">&quot;ubuntu&quot;</span> <span class=\"comment\"># The user created by cloud-init on your VMs</span></span><br><span class=\"line\">SSH_PRIVATE_KEY_PATH=<span class=\"string\">&quot;~/.ssh/id_rsa&quot;</span> <span class=\"comment\"># Path to your SSH private key on the Ansible control machine</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Helm version to install</span></span><br><span class=\"line\">HELM_VERSION=<span class=\"string\">&quot;v3.18.4&quot;</span> <span class=\"comment\"># You can change this to a desired stable version</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># --- Functions ---</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Function to create project directory and navigate into it</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">create_project_dir</span></span>() &#123;</span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;--- Creating project directory: <span class=\"variable\">$&#123;PROJECT_DIR&#125;</span> ---&quot;</span></span><br><span class=\"line\">    <span class=\"comment\"># Check if directory exists, if so, just navigate, otherwise create and navigate</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> [ ! -d <span class=\"string\">&quot;<span class=\"variable\">$&#123;PROJECT_DIR&#125;</span>&quot;</span> ]; <span class=\"keyword\">then</span></span><br><span class=\"line\">        <span class=\"built_in\">mkdir</span> -p <span class=\"string\">&quot;<span class=\"variable\">$&#123;PROJECT_DIR&#125;</span>&quot;</span></span><br><span class=\"line\">        <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Created new directory: <span class=\"variable\">$&#123;PROJECT_DIR&#125;</span>&quot;</span></span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">        <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Directory <span class=\"variable\">$&#123;PROJECT_DIR&#125;</span> already exists.&quot;</span></span><br><span class=\"line\">    <span class=\"keyword\">fi</span></span><br><span class=\"line\">    <span class=\"built_in\">cd</span> <span class=\"string\">&quot;<span class=\"variable\">$&#123;PROJECT_DIR&#125;</span>&quot;</span> || &#123; <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Failed to change directory to <span class=\"variable\">$&#123;PROJECT_DIR&#125;</span>. Exiting.&quot;</span>; <span class=\"built_in\">exit</span> 1; &#125;</span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Changed to directory: <span class=\"subst\">$(pwd)</span>&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Function to create ansible.cfg</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">create_ansible_cfg</span></span>() &#123;</span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;--- Creating ansible.cfg ---&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOF &gt; ansible.cfg</span></span><br><span class=\"line\"><span class=\"string\">[defaults]</span></span><br><span class=\"line\"><span class=\"string\">inventory = inventory.ini</span></span><br><span class=\"line\"><span class=\"string\">roles_path = ./roles</span></span><br><span class=\"line\"><span class=\"string\">host_key_checking = False # WARNING: Disable host key checking for convenience. Re-enable for production!</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;ansible.cfg created.&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Function to create inventory.ini</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">create_inventory</span></span>() &#123;</span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;--- Creating inventory.ini ---&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOF &gt; inventory.ini</span></span><br><span class=\"line\"><span class=\"string\">[kubernetes_master]</span></span><br><span class=\"line\"><span class=\"string\">kube-node-1 ansible_host=$&#123;MASTER_NODE_IP&#125;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">[all:vars]</span></span><br><span class=\"line\"><span class=\"string\">ansible_user=$&#123;ANSIBLE_USER&#125;</span></span><br><span class=\"line\"><span class=\"string\">ansible_ssh_private_key_file=$&#123;SSH_PRIVATE_KEY_PATH&#125;</span></span><br><span class=\"line\"><span class=\"string\">ansible_python_interpreter=/usr/bin/python3</span></span><br><span class=\"line\"><span class=\"string\">HELM_VERSION=$&#123;HELM_VERSION&#125;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;inventory.ini created.&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Function to create the main playbook.yml</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">create_playbook</span></span>() &#123;</span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;--- Creating playbook.yml ---&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOF &gt; playbook.yml</span></span><br><span class=\"line\"><span class=\"string\">---</span></span><br><span class=\"line\"><span class=\"string\">- name: Install Helm on Kubernetes Master Node</span></span><br><span class=\"line\"><span class=\"string\">  hosts: kubernetes_master</span></span><br><span class=\"line\"><span class=\"string\">  become: yes</span></span><br><span class=\"line\"><span class=\"string\">  environment: # Ensure KUBECONFIG is set for helm commands run with become</span></span><br><span class=\"line\"><span class=\"string\">    KUBECONFIG: /etc/kubernetes/admin.conf # Use the admin kubeconfig on the master</span></span><br><span class=\"line\"><span class=\"string\">  roles:</span></span><br><span class=\"line\"><span class=\"string\">    - helm_install</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;playbook.yml created.&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Function to create the Helm installation role (with idempotent check)</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">create_helm_role</span></span>() &#123;</span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;--- Creating Ansible role for Helm installation ---&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">mkdir</span> -p roles/helm_install/tasks</span><br><span class=\"line\">    <span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOF &gt; roles/helm_install/tasks/main.yml</span></span><br><span class=\"line\"><span class=\"string\">---</span></span><br><span class=\"line\"><span class=\"string\">- name: Check if Helm is installed and get version</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.command: helm version --short</span></span><br><span class=\"line\"><span class=\"string\">  register: helm_version_raw</span></span><br><span class=\"line\"><span class=\"string\">  ignore_errors: yes</span></span><br><span class=\"line\"><span class=\"string\">  changed_when: false</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Set installed Helm version fact</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.set_fact:</span></span><br><span class=\"line\"><span class=\"string\">    installed_helm_version: &quot;&#123;&#123; (helm_version_raw.stdout | default(&#x27;&#x27;) | regex_findall(&#x27;^(v[0-9]+\\\\\\\\.[0-9]+\\\\\\\\.[0-9]+)&#x27;) | first | default(&#x27;&#x27;) | trim) &#125;&#125;&quot;</span></span><br><span class=\"line\"><span class=\"string\">  changed_when: false</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Debug installed Helm version</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.debug:</span></span><br><span class=\"line\"><span class=\"string\">    msg: &quot;Current installed Helm version: &#123;&#123; installed_helm_version | default(&#x27;Not installed&#x27;) &#125;&#125;&quot;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Debug raw Helm version output</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.debug:</span></span><br><span class=\"line\"><span class=\"string\">    msg: &quot;Raw Helm version output: &#123;&#123; helm_version_raw.stdout | default(&#x27;No output&#x27;) &#125;&#125;&quot;</span></span><br><span class=\"line\"><span class=\"string\">  when: helm_version_raw.stdout is defined and helm_version_raw.stdout | length &gt; 0</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Check if Helm binary exists</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.stat:</span></span><br><span class=\"line\"><span class=\"string\">    path: /usr/local/bin/helm</span></span><br><span class=\"line\"><span class=\"string\">  register: helm_binary_stat</span></span><br><span class=\"line\"><span class=\"string\">  when: installed_helm_version == HELM_VERSION</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Download Helm tarball</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.get_url:</span></span><br><span class=\"line\"><span class=\"string\">    url: &quot;https://get.helm.sh/helm-&#123;&#123; HELM_VERSION &#125;&#125;-linux-amd64.tar.gz&quot;</span></span><br><span class=\"line\"><span class=\"string\">    dest: &quot;/tmp/helm-&#123;&#123; HELM_VERSION &#125;&#125;-linux-amd64.tar.gz&quot;</span></span><br><span class=\"line\"><span class=\"string\">    mode: &#x27;0644&#x27;</span></span><br><span class=\"line\"><span class=\"string\">    checksum: &quot;sha256:&#123;&#123; lookup(&#x27;url&#x27;, &#x27;https://get.helm.sh/helm-&#123;&#123; HELM_VERSION &#125;&#125;-linux-amd64.tar.gz.sha256sum&#x27;, wantlist=True)[0].split(&#x27; &#x27;)[0] &#125;&#125;&quot;</span></span><br><span class=\"line\"><span class=\"string\">  register: download_helm_result</span></span><br><span class=\"line\"><span class=\"string\">  until: download_helm_result is success</span></span><br><span class=\"line\"><span class=\"string\">  retries: 5</span></span><br><span class=\"line\"><span class=\"string\">  delay: 5</span></span><br><span class=\"line\"><span class=\"string\">  when: installed_helm_version != HELM_VERSION or not helm_binary_stat.stat.exists</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Create Helm installation directory</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.file:</span></span><br><span class=\"line\"><span class=\"string\">    path: /usr/local/bin</span></span><br><span class=\"line\"><span class=\"string\">    state: directory</span></span><br><span class=\"line\"><span class=\"string\">    mode: &#x27;0755&#x27;</span></span><br><span class=\"line\"><span class=\"string\">  when: installed_helm_version != HELM_VERSION or not helm_binary_stat.stat.exists</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Extract Helm binary</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.unarchive:</span></span><br><span class=\"line\"><span class=\"string\">    src: &quot;/tmp/helm-&#123;&#123; HELM_VERSION &#125;&#125;-linux-amd64.tar.gz&quot;</span></span><br><span class=\"line\"><span class=\"string\">    dest: &quot;/tmp&quot;</span></span><br><span class=\"line\"><span class=\"string\">    remote_src: yes</span></span><br><span class=\"line\"><span class=\"string\">    creates: &quot;/tmp/linux-amd64/helm&quot;</span></span><br><span class=\"line\"><span class=\"string\">  when: installed_helm_version != HELM_VERSION or not helm_binary_stat.stat.exists</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Move Helm binary to /usr/local/bin</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.copy:</span></span><br><span class=\"line\"><span class=\"string\">    src: &quot;/tmp/linux-amd64/helm&quot;</span></span><br><span class=\"line\"><span class=\"string\">    dest: &quot;/usr/local/bin/helm&quot;</span></span><br><span class=\"line\"><span class=\"string\">    mode: &#x27;0755&#x27;</span></span><br><span class=\"line\"><span class=\"string\">    remote_src: yes</span></span><br><span class=\"line\"><span class=\"string\">    owner: root</span></span><br><span class=\"line\"><span class=\"string\">    group: root</span></span><br><span class=\"line\"><span class=\"string\">  when: installed_helm_version != HELM_VERSION or not helm_binary_stat.stat.exists</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Clean up Helm tarball and extracted directory</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.file:</span></span><br><span class=\"line\"><span class=\"string\">    path: &quot;&#123;&#123; item &#125;&#125;&quot;</span></span><br><span class=\"line\"><span class=\"string\">    state: absent</span></span><br><span class=\"line\"><span class=\"string\">  loop:</span></span><br><span class=\"line\"><span class=\"string\">    - &quot;/tmp/helm-&#123;&#123; HELM_VERSION &#125;&#125;-linux-amd64.tar.gz&quot;</span></span><br><span class=\"line\"><span class=\"string\">    - &quot;/tmp/linux-amd64&quot;</span></span><br><span class=\"line\"><span class=\"string\">  when: installed_helm_version != HELM_VERSION or not helm_binary_stat.stat.exists</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Verify Helm installation</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.command: helm version --client</span></span><br><span class=\"line\"><span class=\"string\">  register: helm_version_output</span></span><br><span class=\"line\"><span class=\"string\">  changed_when: false</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">- name: Display Helm version</span></span><br><span class=\"line\"><span class=\"string\">  ansible.builtin.debug:</span></span><br><span class=\"line\"><span class=\"string\">    msg: &quot;&#123;&#123; helm_version_output.stdout &#125;&#125;&quot;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Helm installation role created.&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># --- Main execution ---</span></span><br><span class=\"line\">create_project_dir</span><br><span class=\"line\">create_ansible_cfg</span><br><span class=\"line\">create_inventory</span><br><span class=\"line\">create_playbook</span><br><span class=\"line\">create_helm_role</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;--- Ansible setup for Helm installation is complete! ---&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;Navigate to the new project directory:&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;cd <span class=\"variable\">$&#123;PROJECT_DIR&#125;</span>&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;Then, run the Ansible playbook to install only Helm on your master node:&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;ansible-playbook playbook.yml -K&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;After Helm is installed, you can SSH into your master node (kube-node-1) and manage Cilium Enterprise installation directly using Helm.&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;Remember to use the correct Cilium chart version and your custom values file.&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;Example steps for manual Cilium installation via Helm:&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;ssh ubuntu@<span class=\"variable\">$&#123;MASTER_NODE_IP&#125;</span>&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;sudo helm repo add cilium https://helm.cilium.io/&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;sudo helm repo add isovalent https://helm.isovalent.com&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;sudo helm repo update&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;sudo helm install cilium isovalent/cilium --version 1.17.6 --namespace kube-system -f &lt;path_to_your_cilium_values_file.yaml&gt; --wait&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;Example content for /tmp/cilium-enterprise-values.yaml:&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;hubble:&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;  enabled: true&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;  relay:&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;    enabled: true&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;  ui:&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;    enabled: false&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;kubeProxyReplacement: strict&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;ipam:&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;  mode: kubernetes&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;ipv4NativeRoutingCIDR: 10.244.0.0/16&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;k8s:&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;  requireIPv4PodCIDR: true&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;routingMode: native&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;autoDirectNodeRoutes: false&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;bgpControlPlane:&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;  enabled: true&quot;</span></span><br></pre></td></tr></table></figure>\n\n<p>执行效果如下：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ois@ois:~/data/k8s$ ./ansible-helm.sh </span><br><span class=\"line\">--- Creating project directory: ansible-helm ---</span><br><span class=\"line\">Created new directory: ansible-helm</span><br><span class=\"line\">Changed to directory: /home/ois/data/k8s/ansible-helm</span><br><span class=\"line\">--- Creating ansible.cfg ---</span><br><span class=\"line\">ansible.cfg created.</span><br><span class=\"line\">--- Creating inventory.ini ---</span><br><span class=\"line\">inventory.ini created.</span><br><span class=\"line\">--- Creating playbook.yml ---</span><br><span class=\"line\">playbook.yml created.</span><br><span class=\"line\">--- Creating Ansible role <span class=\"keyword\">for</span> Helm installation ---</span><br><span class=\"line\">Helm installation role created.</span><br><span class=\"line\"></span><br><span class=\"line\">--- Ansible setup <span class=\"keyword\">for</span> Helm installation is complete! ---</span><br><span class=\"line\">Navigate to the new project directory:</span><br><span class=\"line\"><span class=\"built_in\">cd</span> ansible-helm</span><br><span class=\"line\"></span><br><span class=\"line\">Then, run the Ansible playbook to install only Helm on your master node:</span><br><span class=\"line\">ansible-playbook playbook.yml -K</span><br><span class=\"line\"></span><br><span class=\"line\">After Helm is installed, you can SSH into your master node (kube-node-1) and manage Cilium Enterprise installation directly using Helm.</span><br><span class=\"line\">Remember to use the correct Cilium chart version and your custom values file.</span><br><span class=\"line\">Example steps <span class=\"keyword\">for</span> manual Cilium installation via Helm:</span><br><span class=\"line\">ssh ubuntu@10.75.59.71</span><br><span class=\"line\"><span class=\"built_in\">sudo</span> helm repo add cilium https://helm.cilium.io/</span><br><span class=\"line\"><span class=\"built_in\">sudo</span> helm repo add isovalent https://helm.isovalent.com</span><br><span class=\"line\"><span class=\"built_in\">sudo</span> helm repo update</span><br><span class=\"line\"><span class=\"built_in\">sudo</span> helm install cilium isovalent/cilium --version 1.17.6 --namespace kube-system -f &lt;path_to_your_cilium_values_file.yaml&gt; --<span class=\"built_in\">wait</span></span><br><span class=\"line\">Example content <span class=\"keyword\">for</span> /tmp/cilium-enterprise-values.yaml:</span><br><span class=\"line\">hubble:</span><br><span class=\"line\">  enabled: <span class=\"literal\">true</span></span><br><span class=\"line\">  relay:</span><br><span class=\"line\">    enabled: <span class=\"literal\">true</span></span><br><span class=\"line\">  ui:</span><br><span class=\"line\">    enabled: <span class=\"literal\">false</span></span><br><span class=\"line\">kubeProxyReplacement: strict</span><br><span class=\"line\">ipam:</span><br><span class=\"line\">  mode: kubernetes</span><br><span class=\"line\">ipv4NativeRoutingCIDR: 172.16.0.0/20</span><br><span class=\"line\">k8s:</span><br><span class=\"line\">  requireIPv4PodCIDR: <span class=\"literal\">true</span></span><br><span class=\"line\">routingMode: native</span><br><span class=\"line\">autoDirectNodeRoutes: <span class=\"literal\">false</span></span><br><span class=\"line\">bgpControlPlane:</span><br><span class=\"line\">  enabled: <span class=\"literal\">true</span></span><br><span class=\"line\">ois@ois:~/data/k8s$ <span class=\"built_in\">cd</span> ansible-helm</span><br><span class=\"line\">ois@ois:~/data/k8s/ansible-helm$ ansible-playbook playbook.yml -K</span><br><span class=\"line\">BECOME password: </span><br><span class=\"line\"></span><br><span class=\"line\">PLAY [Install Helm on Kubernetes Master Node] ******************************************************************************************************************************************************************************************************************</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Gathering Facts] *****************************************************************************************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [kube-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [helm_install : Check <span class=\"keyword\">if</span> Helm is installed and get version] ***********************************************************************************************************************************************************************************************</span><br><span class=\"line\">fatal: [kube-node-1]: FAILED! =&gt; &#123;<span class=\"string\">&quot;changed&quot;</span>: <span class=\"literal\">false</span>, <span class=\"string\">&quot;cmd&quot;</span>: <span class=\"string\">&quot;helm version --short&quot;</span>, <span class=\"string\">&quot;msg&quot;</span>: <span class=\"string\">&quot;[Errno 2] No such file or directory: b&#x27;helm&#x27;&quot;</span>, <span class=\"string\">&quot;rc&quot;</span>: 2, <span class=\"string\">&quot;stderr&quot;</span>: <span class=\"string\">&quot;&quot;</span>, <span class=\"string\">&quot;stderr_lines&quot;</span>: [], <span class=\"string\">&quot;stdout&quot;</span>: <span class=\"string\">&quot;&quot;</span>, <span class=\"string\">&quot;stdout_lines&quot;</span>: []&#125;</span><br><span class=\"line\">...ignoring</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [helm_install : Set installed Helm version fact] **********************************************************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [kube-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [helm_install : Debug installed Helm version] *************************************************************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [kube-node-1] =&gt; &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;msg&quot;</span>: <span class=\"string\">&quot;Current installed Helm version: &quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [helm_install : Debug raw Helm version output] ************************************************************************************************************************************************************************************************************</span><br><span class=\"line\">skipping: [kube-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [helm_install : Check <span class=\"keyword\">if</span> Helm binary exists] **************************************************************************************************************************************************************************************************************</span><br><span class=\"line\">skipping: [kube-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [helm_install : Download Helm tarball] ********************************************************************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [kube-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [helm_install : Create Helm installation directory] *******************************************************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [kube-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [helm_install : Extract Helm binary] **********************************************************************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [kube-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [helm_install : Move Helm binary to /usr/local/bin] *******************************************************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [kube-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [helm_install : Clean up Helm tarball and extracted directory] ********************************************************************************************************************************************************************************************</span><br><span class=\"line\">changed: [kube-node-1] =&gt; (item=/tmp/helm-v3.18.4-linux-amd64.tar.gz)</span><br><span class=\"line\">changed: [kube-node-1] =&gt; (item=/tmp/linux-amd64)</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [helm_install : Verify Helm installation] *****************************************************************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [kube-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [helm_install : Display Helm version] *********************************************************************************************************************************************************************************************************************</span><br><span class=\"line\">ok: [kube-node-1] =&gt; &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;msg&quot;</span>: <span class=\"string\">&quot;version.BuildInfo&#123;Version:\\&quot;v3.18.4\\&quot;, GitCommit:\\&quot;d80839cf37d860c8aa9a0503fe463278f26cd5e2\\&quot;, GitTreeState:\\&quot;clean\\&quot;, GoVersion:\\&quot;go1.24.4\\&quot;&#125;&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY RECAP *****************************************************************************************************************************************************************************************************************************************************</span><br><span class=\"line\">kube-node-1                : ok=11   changed=4    unreachable=0    failed=0    skipped=2    rescued=0    ignored=1   </span><br></pre></td></tr></table></figure>\n\n<h2 id=\"4-3-使用Helm安装Cilium\"><a href=\"#4-3-使用Helm安装Cilium\" class=\"headerlink\" title=\"4.3 使用Helm安装Cilium\"></a>4.3 使用Helm安装Cilium</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">root@kube-node-1:~# helm repo add cilium https://helm.cilium.io/</span><br><span class=\"line\"><span class=\"string\">&quot;cilium&quot;</span> has been added to your repositories</span><br><span class=\"line\">root@kube-node-1:~# helm repo add isovalent https://helm.isovalent.com</span><br><span class=\"line\"><span class=\"string\">&quot;isovalent&quot;</span> has been added to your repositories</span><br><span class=\"line\">root@kube-node-1:~# </span><br><span class=\"line\"></span><br><span class=\"line\">准备配置文件如下：</span><br><span class=\"line\"></span><br><span class=\"line\">root@kube-node-1:~# <span class=\"built_in\">cat</span> &gt; cilium-enterprise-values.yaml &lt;&lt;<span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">hubble:</span></span><br><span class=\"line\"><span class=\"string\">  enabled: true</span></span><br><span class=\"line\"><span class=\"string\">  relay:</span></span><br><span class=\"line\"><span class=\"string\">    enabled: true</span></span><br><span class=\"line\"><span class=\"string\">  ui:</span></span><br><span class=\"line\"><span class=\"string\">    enabled: false</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\"># Enable Gateway API</span></span><br><span class=\"line\"><span class=\"string\">#gatewayAPI:</span></span><br><span class=\"line\"><span class=\"string\">#  enabled: true</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\"># Explicitly disable Egress Gateway</span></span><br><span class=\"line\"><span class=\"string\">#egressGateway:</span></span><br><span class=\"line\"><span class=\"string\">#  enabled: false</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\"># BGP native-routing configuration</span></span><br><span class=\"line\"><span class=\"string\">ipam:</span></span><br><span class=\"line\"><span class=\"string\">  mode: kubernetes</span></span><br><span class=\"line\"><span class=\"string\">ipv4NativeRoutingCIDR: 172.16.0.0/20 # Advertises all pod CIDRs; ensure BGP router supports this</span></span><br><span class=\"line\"><span class=\"string\">k8s:</span></span><br><span class=\"line\"><span class=\"string\">  requireIPv4PodCIDR: true</span></span><br><span class=\"line\"><span class=\"string\">routingMode: native</span></span><br><span class=\"line\"><span class=\"string\">autoDirectNodeRoutes: true</span></span><br><span class=\"line\"><span class=\"string\">bgpControlPlane:</span></span><br><span class=\"line\"><span class=\"string\">  enabled: true</span></span><br><span class=\"line\"><span class=\"string\">  # Configure BGP peers (replace with your BGP router details)</span></span><br><span class=\"line\"><span class=\"string\">  announce:</span></span><br><span class=\"line\"><span class=\"string\">    podCIDR: true # Advertise pod CIDRs to BGP peers</span></span><br><span class=\"line\"><span class=\"string\">enableIPv4Masquerade: true</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\"># Enable kube-proxy replacement</span></span><br><span class=\"line\"><span class=\"string\">kubeProxyReplacement: true</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">bpf:</span></span><br><span class=\"line\"><span class=\"string\">  masquerade: true</span></span><br><span class=\"line\"><span class=\"string\">  lb:</span></span><br><span class=\"line\"><span class=\"string\">    externalClusterIP: true</span></span><br><span class=\"line\"><span class=\"string\">    sock: true</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\">root@kube-node-1:~# helm install cilium isovalent/cilium --version 1.17.6 \\</span><br><span class=\"line\">    --namespace kube-system \\</span><br><span class=\"line\">    --<span class=\"built_in\">set</span> kubeProxyReplacement=<span class=\"literal\">true</span> \\</span><br><span class=\"line\">    --<span class=\"built_in\">set</span> k8sServiceHost=10.75.59.71 \\</span><br><span class=\"line\">    --<span class=\"built_in\">set</span> k8sServicePort=6443 \\</span><br><span class=\"line\">    -f cilium-enterprise-values.yaml</span><br><span class=\"line\">NAME: cilium</span><br><span class=\"line\">LAST DEPLOYED: Fri Aug  1 09:54:27 2025</span><br><span class=\"line\">NAMESPACE: kube-system</span><br><span class=\"line\">STATUS: deployed</span><br><span class=\"line\">REVISION: 1</span><br><span class=\"line\">TEST SUITE: None</span><br><span class=\"line\">NOTES:</span><br><span class=\"line\">You have successfully installed Cilium with Hubble Relay.</span><br><span class=\"line\"></span><br><span class=\"line\">Your release version is 1.17.6.</span><br><span class=\"line\"></span><br><span class=\"line\">For any further <span class=\"built_in\">help</span>, visit https://docs.isovalent.com/v1.17</span><br><span class=\"line\"></span><br><span class=\"line\">上述命令中的参数k8sServiceHost=10.75.59.71 和 k8sServicePort=6443 是不能少的。</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">在其他Node上执行kubeadm <span class=\"built_in\">join</span></span><br><span class=\"line\"></span><br><span class=\"line\">ubuntu@kube-node-2:~$ <span class=\"built_in\">sudo</span> su</span><br><span class=\"line\">[<span class=\"built_in\">sudo</span>] password <span class=\"keyword\">for</span> ubuntu: </span><br><span class=\"line\">root@kube-node-2:/home/ubuntu# <span class=\"built_in\">cd</span></span><br><span class=\"line\">root@kube-node-2:~# kubeadm <span class=\"built_in\">join</span> kube-node-1:6443 --token wnc2sl.st6g6c4o0cd42bi4 \\</span><br><span class=\"line\">        --discovery-token-ca-cert-hash sha256:381868d3e0faab6dbd3e240d8f40e0e81ab46cb54b2f15ffbfe0f587fac5d982 </span><br><span class=\"line\">[preflight] Running pre-flight checks</span><br><span class=\"line\">[preflight] Reading configuration from the <span class=\"string\">&quot;kubeadm-config&quot;</span> ConfigMap <span class=\"keyword\">in</span> namespace <span class=\"string\">&quot;kube-system&quot;</span>...</span><br><span class=\"line\">[preflight] Use <span class=\"string\">&#x27;kubeadm init phase upload-config --config your-config-file&#x27;</span> to re-upload it.</span><br><span class=\"line\">W0801 09:56:27.830756   47851 configset.go:78] Warning: No kubeproxy.config.k8s.io/v1alpha1 config is loaded. Continuing without it: configmaps <span class=\"string\">&quot;kube-proxy&quot;</span> is forbidden: User <span class=\"string\">&quot;system:bootstrap:wnc2sl&quot;</span> cannot get resource <span class=\"string\">&quot;configmaps&quot;</span> <span class=\"keyword\">in</span> API group <span class=\"string\">&quot;&quot;</span> <span class=\"keyword\">in</span> the namespace <span class=\"string\">&quot;kube-system&quot;</span></span><br><span class=\"line\">[kubelet-start] Writing kubelet configuration to file <span class=\"string\">&quot;/var/lib/kubelet/config.yaml&quot;</span></span><br><span class=\"line\">[kubelet-start] Writing kubelet environment file with flags to file <span class=\"string\">&quot;/var/lib/kubelet/kubeadm-flags.env&quot;</span></span><br><span class=\"line\">[kubelet-start] Starting the kubelet</span><br><span class=\"line\">[kubelet-check] Waiting <span class=\"keyword\">for</span> a healthy kubelet at http://127.0.0.1:10248/healthz. This can take up to 4m0s</span><br><span class=\"line\">[kubelet-check] The kubelet is healthy after 1.503396779s</span><br><span class=\"line\">[kubelet-start] Waiting <span class=\"keyword\">for</span> the kubelet to perform the TLS Bootstrap</span><br><span class=\"line\"></span><br><span class=\"line\">This node has joined the cluster:</span><br><span class=\"line\">* Certificate signing request was sent to apiserver and a response was received.</span><br><span class=\"line\">* The Kubelet was informed of the new secure connection details.</span><br><span class=\"line\"></span><br><span class=\"line\">Run <span class=\"string\">&#x27;kubectl get nodes&#x27;</span> on the control-plane to see this node <span class=\"built_in\">join</span> the cluster.</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>等待一段时间，Cilium、Hubble Relay即可Ready</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@kube-node-1:~# kubectl get pods -n kube-system -o wide</span><br><span class=\"line\">NAME                                  READY   STATUS    RESTARTS   AGE     IP            NODE          NOMINATED NODE   READINESS GATES</span><br><span class=\"line\">cilium-2vrgj                          1/1     Running   0          3m58s   10.75.59.73   kube-node-3   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">cilium-65kvc                          1/1     Running   0          4m14s   10.75.59.72   kube-node-2   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">cilium-envoy-24sd7                    1/1     Running   0          4m14s   10.75.59.72   kube-node-2   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">cilium-envoy-7pr4g                    1/1     Running   0          6m12s   10.75.59.71   kube-node-1   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">cilium-envoy-k86tp                    1/1     Running   0          3m58s   10.75.59.73   kube-node-3   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">cilium-operator-867fb7f659-2vnld      1/1     Running   0          6m12s   10.75.59.72   kube-node-2   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">cilium-operator-867fb7f659-5998x      1/1     Running   0          6m12s   10.75.59.71   kube-node-1   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">cilium-x4pr7                          1/1     Running   0          6m12s   10.75.59.71   kube-node-1   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">coredns-674b8bbfcf-6t8np              1/1     Running   0          13m     172.16.1.40   kube-node-2   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">coredns-674b8bbfcf-bx8xd              1/1     Running   0          13m     172.16.1.64   kube-node-2   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">etcd-kube-node-1                      1/1     Running   1          13m     10.75.59.71   kube-node-1   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">hubble-relay-cfb755899-gch8w          1/1     Running   0          6m12s   172.16.1.81   kube-node-2   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">kube-apiserver-kube-node-1            1/1     Running   1          13m     10.75.59.71   kube-node-1   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">kube-controller-manager-kube-node-1   1/1     Running   1          13m     10.75.59.71   kube-node-1   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">kube-scheduler-kube-node-1            1/1     Running   1          13m     10.75.59.71   kube-node-1   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"4-4-安装企业版Cilium-cli\"><a href=\"#4-4-安装企业版Cilium-cli\" class=\"headerlink\" title=\"4.4 安装企业版Cilium-cli\"></a>4.4 安装企业版Cilium-cli</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -L --remote-name-all https://github.com/isovalent/cilium-cli-releases/releases/latest/download/cilium-linux-amd64.tar.gz&#123;,.<span class=\"built_in\">sha256sum</span>&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">sha256sum</span> --check cilium-linux-amd64.tar.gz.sha256sum</span><br><span class=\"line\"></span><br><span class=\"line\">tar xzvfC cilium-linux-amd64.tar.gz /usr/local/bin</span><br><span class=\"line\"></span><br><span class=\"line\">root@kube-node-1:~# cilium status</span><br><span class=\"line\">    /¯¯\\</span><br><span class=\"line\"> /¯¯\\__/¯¯\\    Cilium:             OK</span><br><span class=\"line\"> \\__/¯¯\\__/    Operator:           OK</span><br><span class=\"line\"> /¯¯\\__/¯¯\\    Envoy DaemonSet:    OK</span><br><span class=\"line\"> \\__/¯¯\\__/    Hubble Relay:       OK</span><br><span class=\"line\">    \\__/       ClusterMesh:        disabled</span><br><span class=\"line\"></span><br><span class=\"line\">DaemonSet              cilium                   Desired: 3, Ready: 3/3, Available: 3/3</span><br><span class=\"line\">DaemonSet              cilium-envoy             Desired: 3, Ready: 3/3, Available: 3/3</span><br><span class=\"line\">Deployment             cilium-operator          Desired: 2, Ready: 2/2, Available: 2/2</span><br><span class=\"line\">Deployment             hubble-relay             Desired: 1, Ready: 1/1, Available: 1/1</span><br><span class=\"line\">Containers:            cilium                   Running: 3</span><br><span class=\"line\">                       cilium-envoy             Running: 3</span><br><span class=\"line\">                       cilium-operator          Running: 2</span><br><span class=\"line\">                       clustermesh-apiserver    </span><br><span class=\"line\">                       hubble-relay             Running: 1</span><br><span class=\"line\">Cluster Pods:          3/3 managed by Cilium</span><br><span class=\"line\">Helm chart version:    1.17.6</span><br><span class=\"line\">Image versions         cilium             quay.io/isovalent/cilium:v1.17.6-cee.1@sha256:2d01daf4f25f7d644889b49ca856e1a4269981fc963e50bd3962665b41b6adb3: 3</span><br><span class=\"line\">                       cilium-envoy       quay.io/isovalent/cilium-envoy:v1.17.6-cee.1@sha256:318eff387835ca2717baab42a84f35a83a5f9e7d519253df87269f80b9ff0171: 3</span><br><span class=\"line\">                       cilium-operator    quay.io/isovalent/operator-generic:v1.17.6-cee.1@sha256:2e602710a7c4f101831df679e5d8251bae8bf0f9fe26c20bbef87f1966ea8265: 2</span><br><span class=\"line\">                       hubble-relay       quay.io/isovalent/hubble-relay:v1.17.6-cee.1@sha256:d378e3607f7492374e65e2bd854cc0ec87480c63ba49a96dadcd75a6946b586e: 1</span><br><span class=\"line\">root@kube-node-1:~# </span><br></pre></td></tr></table></figure>\n\n<h2 id=\"4-5-设置Cilium-BGP\"><a href=\"#4-5-设置Cilium-BGP\" class=\"headerlink\" title=\"4.5 设置Cilium BGP\"></a>4.5 设置Cilium BGP</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@kube-node-1:~#<span class=\"built_in\">cat</span> &gt; cilium-bgp.yaml &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">--- #bgp的对外宣告策略，宣告POD和serviceip</span></span><br><span class=\"line\"><span class=\"string\">apiVersion: cilium.io/v2alpha1</span></span><br><span class=\"line\"><span class=\"string\">kind: CiliumBGPAdvertisement</span></span><br><span class=\"line\"><span class=\"string\">metadata:</span></span><br><span class=\"line\"><span class=\"string\">  name: bgp-advertisements</span></span><br><span class=\"line\"><span class=\"string\">  labels:</span></span><br><span class=\"line\"><span class=\"string\">    advertise: bgp</span></span><br><span class=\"line\"><span class=\"string\">spec:</span></span><br><span class=\"line\"><span class=\"string\">  advertisements:</span></span><br><span class=\"line\"><span class=\"string\">    - advertisementType: &quot;PodCIDR&quot;              # Only for Kubernetes or ClusterPool IPAM cluster-pool</span></span><br><span class=\"line\"><span class=\"string\">    - advertisementType: &quot;Service&quot;</span></span><br><span class=\"line\"><span class=\"string\">      service:</span></span><br><span class=\"line\"><span class=\"string\">        addresses:</span></span><br><span class=\"line\"><span class=\"string\">          - ClusterIP</span></span><br><span class=\"line\"><span class=\"string\">          - ExternalIP</span></span><br><span class=\"line\"><span class=\"string\">          #- LoadBalancerIP</span></span><br><span class=\"line\"><span class=\"string\">      selector:</span></span><br><span class=\"line\"><span class=\"string\">        matchExpressions:</span></span><br><span class=\"line\"><span class=\"string\">        - &#123;key: somekey, operator: NotIn, values: [&#x27;never-used-value&#x27;]&#125;                  # 等同于宣告所有</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">--- #bgp邻居组的配置，类似template peer ,里面调用相关的advertisement策略</span></span><br><span class=\"line\"><span class=\"string\">apiVersion: cilium.io/v2alpha1</span></span><br><span class=\"line\"><span class=\"string\">kind: CiliumBGPPeerConfig</span></span><br><span class=\"line\"><span class=\"string\">metadata:</span></span><br><span class=\"line\"><span class=\"string\">  name: cilium-peer</span></span><br><span class=\"line\"><span class=\"string\">spec:</span></span><br><span class=\"line\"><span class=\"string\">  timers:</span></span><br><span class=\"line\"><span class=\"string\">    holdTimeSeconds: 30             #default 90s</span></span><br><span class=\"line\"><span class=\"string\">    keepAliveTimeSeconds: 10  #default 30s</span></span><br><span class=\"line\"><span class=\"string\">    connectRetryTimeSeconds: 40  #default 120s</span></span><br><span class=\"line\"><span class=\"string\">  gracefulRestart:</span></span><br><span class=\"line\"><span class=\"string\">    enabled: true</span></span><br><span class=\"line\"><span class=\"string\">    restartTimeSeconds: 120        #default 120s</span></span><br><span class=\"line\"><span class=\"string\">  #transport:</span></span><br><span class=\"line\"><span class=\"string\">  #  peerPort: 179</span></span><br><span class=\"line\"><span class=\"string\">  families:</span></span><br><span class=\"line\"><span class=\"string\">    - afi: ipv4</span></span><br><span class=\"line\"><span class=\"string\">      safi: unicast</span></span><br><span class=\"line\"><span class=\"string\">      advertisements:</span></span><br><span class=\"line\"><span class=\"string\">        matchLabels:</span></span><br><span class=\"line\"><span class=\"string\">          advertise: &quot;bgp&quot;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">--- #bgp的邻居配置</span></span><br><span class=\"line\"><span class=\"string\">apiVersion: cilium.io/v2alpha1</span></span><br><span class=\"line\"><span class=\"string\">kind: CiliumBGPClusterConfig</span></span><br><span class=\"line\"><span class=\"string\">metadata:</span></span><br><span class=\"line\"><span class=\"string\">  name: cilium-bgp-default</span></span><br><span class=\"line\"><span class=\"string\">spec:</span></span><br><span class=\"line\"><span class=\"string\">  bgpInstances:</span></span><br><span class=\"line\"><span class=\"string\">  - name: &quot;instance-65000&quot;</span></span><br><span class=\"line\"><span class=\"string\">    localASN: 65000</span></span><br><span class=\"line\"><span class=\"string\">    peers:</span></span><br><span class=\"line\"><span class=\"string\">    - name: &quot;GoBGP&quot;</span></span><br><span class=\"line\"><span class=\"string\">      peerASN: 65000</span></span><br><span class=\"line\"><span class=\"string\">      peerAddress: 10.75.59.76</span></span><br><span class=\"line\"><span class=\"string\">      peerConfigRef:</span></span><br><span class=\"line\"><span class=\"string\">        name: &quot;cilium-peer&quot;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\">root@kube-node-1:~# </span><br><span class=\"line\">root@kube-node-1:~# </span><br><span class=\"line\">root@kube-node-1:~# kubectl apply -f cilium-bgp.yaml </span><br><span class=\"line\">ciliumbgpadvertisement.cilium.io/bgp-advertisements created</span><br><span class=\"line\">ciliumbgppeerconfig.cilium.io/cilium-peer created</span><br><span class=\"line\">ciliumbgpclusterconfig.cilium.io/cilium-bgp-default created</span><br><span class=\"line\">root@kube-node-1:~# cilium bgp peers</span><br><span class=\"line\">Node          Local AS   Peer AS   Peer Address   Session State   Uptime   Family         Received   Advertised</span><br><span class=\"line\">kube-node-1   65000      65000     10.75.59.76    established     7s       ipv4/unicast   2          6    </span><br><span class=\"line\">kube-node-2   65000      65000     10.75.59.76    established     6s       ipv4/unicast   2          6    </span><br><span class=\"line\">kube-node-3   65000      65000     10.75.59.76    established     6s       ipv4/unicast   2          6    </span><br><span class=\"line\">root@kube-node-1:~# cilium bgp routes</span><br><span class=\"line\">(Defaulting to `available ipv4 unicast` routes, please see <span class=\"built_in\">help</span> <span class=\"keyword\">for</span> more options)</span><br><span class=\"line\"></span><br><span class=\"line\">Node          VRouter   Prefix             NextHop   Age   Attrs</span><br><span class=\"line\">kube-node-1   65000     172.16.0.0/24      0.0.0.0   12s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class=\"line\">              65000     172.16.32.1/32     0.0.0.0   12s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class=\"line\">              65000     172.16.32.10/32    0.0.0.0   12s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class=\"line\">              65000     172.16.37.239/32   0.0.0.0   12s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class=\"line\">              65000     172.16.43.10/32    0.0.0.0   12s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class=\"line\">kube-node-2   65000     172.16.1.0/24      0.0.0.0   12s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class=\"line\">              65000     172.16.32.1/32     0.0.0.0   12s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class=\"line\">              65000     172.16.32.10/32    0.0.0.0   12s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class=\"line\">              65000     172.16.37.239/32   0.0.0.0   12s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class=\"line\">              65000     172.16.43.10/32    0.0.0.0   12s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class=\"line\">kube-node-3   65000     172.16.3.0/24      0.0.0.0   12s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class=\"line\">              65000     172.16.32.1/32     0.0.0.0   12s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class=\"line\">              65000     172.16.32.10/32    0.0.0.0   12s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class=\"line\">              65000     172.16.37.239/32   0.0.0.0   12s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class=\"line\">              65000     172.16.43.10/32    0.0.0.0   12s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class=\"line\">root@kube-node-1:~# </span><br></pre></td></tr></table></figure>\n\n<h2 id=\"4-6-安装Hubble-UI\"><a href=\"#4-6-安装Hubble-UI\" class=\"headerlink\" title=\"4.6 安装Hubble UI\"></a>4.6 安装Hubble UI</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@kube-node-1:~# helm search repo isovalent/hubble-ui -l</span><br><span class=\"line\">NAME                    CHART VERSION   APP VERSION     DESCRIPTION         </span><br><span class=\"line\">isovalent/hubble-ui     1.3.6           1.3.6           Hubble UI Enterprise</span><br><span class=\"line\">isovalent/hubble-ui     1.3.5           1.3.5           Hubble UI Enterprise</span><br><span class=\"line\"></span><br><span class=\"line\">root@kube-node-1:~# <span class=\"built_in\">cat</span> &gt; hubble-ui-values.yaml &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">relay:</span></span><br><span class=\"line\"><span class=\"string\">  address: &quot;hubble-relay.kube-system.svc.cluster.local&quot;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\">root@kube-node-1:~#  </span><br><span class=\"line\">root@kube-node-1:~# helm install hubble-ui isovalent/hubble-ui --version 1.3.6 --namespace kube-system --values hubble-ui-values.yaml --<span class=\"built_in\">wait</span></span><br><span class=\"line\">NAME: hubble-ui</span><br><span class=\"line\">LAST DEPLOYED: Fri Aug  1 10:47:58 2025</span><br><span class=\"line\">NAMESPACE: kube-system</span><br><span class=\"line\">STATUS: deployed</span><br><span class=\"line\">REVISION: 1</span><br><span class=\"line\">TEST SUITE: None</span><br><span class=\"line\">NOTES:</span><br><span class=\"line\">You have successfully installed Hubble-Ui.</span><br><span class=\"line\">Your release version is 1.3.6.</span><br><span class=\"line\"></span><br><span class=\"line\">For any further <span class=\"built_in\">help</span>, visit https://docs.isovalent.com</span><br><span class=\"line\">root@kube-node-1:~# kubectl patch service hubble-ui -n kube-system -p <span class=\"string\">&#x27;&#123;&quot;spec&quot;: &#123;&quot;type&quot;: &quot;NodePort&quot;&#125;&#125;&#x27;</span></span><br><span class=\"line\">service/hubble-ui patched</span><br><span class=\"line\">root@kube-node-1:~# kubectl get svc -n kube-system -o wide                                                                  </span><br><span class=\"line\">NAME           TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                  AGE   SELECTOR</span><br><span class=\"line\">cilium-envoy   ClusterIP   None            &lt;none&gt;        9964/TCP                 54m   k8s-app=cilium-envoy</span><br><span class=\"line\">hubble-peer    ClusterIP   172.16.43.10    &lt;none&gt;        443/TCP                  54m   k8s-app=cilium</span><br><span class=\"line\">hubble-relay   NodePort    172.16.37.239   &lt;none&gt;        80:31234/TCP             54m   k8s-app=hubble-relay</span><br><span class=\"line\">hubble-ui      NodePort    172.16.35.177   &lt;none&gt;        80:31225/TCP             64s   k8s-app=hubble-ui</span><br><span class=\"line\">kube-dns       ClusterIP   172.16.32.10    &lt;none&gt;        53/UDP,53/TCP,9153/TCP   61m   k8s-app=kube-dns</span><br><span class=\"line\">root@kube-node-1:~# kubectl -n kube-system <span class=\"built_in\">exec</span> ds/cilium -- cilium service list</span><br><span class=\"line\">Defaulted container <span class=\"string\">&quot;cilium-agent&quot;</span> out of: cilium-agent, config (init), mount-cgroup (init), apply-sysctl-overwrites (init), mount-bpf-fs (init), clean-cilium-state (init), install-cni-binaries (init)</span><br><span class=\"line\">ID   Frontend                Service Type   Backend                               </span><br><span class=\"line\">1    172.16.32.1:443/TCP     ClusterIP      1 =&gt; 10.75.59.71:6443/TCP (active)    </span><br><span class=\"line\">2    172.16.43.10:443/TCP    ClusterIP      1 =&gt; 10.75.59.71:4244/TCP (active)    </span><br><span class=\"line\">3    172.16.37.239:80/TCP    ClusterIP      1 =&gt; 172.16.1.81:4245/TCP (active)    </span><br><span class=\"line\">4    10.75.59.71:31234/TCP   NodePort       1 =&gt; 172.16.1.81:4245/TCP (active)    </span><br><span class=\"line\">5    0.0.0.0:31234/TCP       NodePort       1 =&gt; 172.16.1.81:4245/TCP (active)    </span><br><span class=\"line\">6    172.16.32.10:53/TCP     ClusterIP      1 =&gt; 172.16.1.64:53/TCP (active)      </span><br><span class=\"line\">                                            2 =&gt; 172.16.1.40:53/TCP (active)      </span><br><span class=\"line\">7    172.16.32.10:9153/TCP   ClusterIP      1 =&gt; 172.16.1.64:9153/TCP (active)    </span><br><span class=\"line\">                                            2 =&gt; 172.16.1.40:9153/TCP (active)    </span><br><span class=\"line\">8    172.16.32.10:53/UDP     ClusterIP      1 =&gt; 172.16.1.64:53/UDP (active)      </span><br><span class=\"line\">                                            2 =&gt; 172.16.1.40:53/UDP (active)      </span><br><span class=\"line\">9    172.16.35.177:80/TCP    ClusterIP      1 =&gt; 172.16.3.127:8081/TCP (active)   </span><br><span class=\"line\">10   10.75.59.71:31225/TCP   NodePort       1 =&gt; 172.16.3.127:8081/TCP (active)   </span><br><span class=\"line\">11   0.0.0.0:31225/TCP       NodePort       1 =&gt; 172.16.3.127:8081/TCP (active)  </span><br><span class=\"line\"></span><br><span class=\"line\">浏览器可以通过http://10.75.59.71:31225/ 访问Hubble-ui</span><br><span class=\"line\"></span><br><span class=\"line\">root@dns-server-vm:~# curl http://10.75.59.71:31225/</span><br><span class=\"line\">&lt;!doctype html&gt;&lt;html&gt;&lt;<span class=\"built_in\">head</span>&gt;&lt;meta charset=<span class=\"string\">&quot;utf-8&quot;</span>/&gt;&lt;title&gt;Hubble UI Enterprise&lt;/title&gt;&lt;meta http-equiv=<span class=\"string\">&quot;X-UA-Compatible&quot;</span> content=<span class=\"string\">&quot;IE=edge&quot;</span>/&gt;&lt;meta name=<span class=\"string\">&quot;viewport&quot;</span> content=<span class=\"string\">&quot;width=device-width,user-scalable=0,initial-scale=1,minimum-scale=1,maximum-scale=1&quot;</span>/&gt;&lt;<span class=\"built_in\">link</span> rel=<span class=\"string\">&quot;icon&quot;</span> <span class=\"built_in\">type</span>=<span class=\"string\">&quot;image/png&quot;</span> sizes=<span class=\"string\">&quot;32x32&quot;</span> href=<span class=\"string\">&quot;/favicon-32x32.png&quot;</span>/&gt;&lt;<span class=\"built_in\">link</span> rel=<span class=\"string\">&quot;icon&quot;</span> <span class=\"built_in\">type</span>=<span class=\"string\">&quot;image/png&quot;</span> sizes=<span class=\"string\">&quot;16x16&quot;</span> href=<span class=\"string\">&quot;/favicon-16x16.png&quot;</span>/&gt;&lt;<span class=\"built_in\">link</span> rel=<span class=\"string\">&quot;shortcut icon&quot;</span> href=<span class=\"string\">&quot;/favicon.ico&quot;</span>/&gt;&lt;<span class=\"built_in\">link</span> rel=<span class=\"string\">&quot;stylesheet&quot;</span> href=<span class=\"string\">&quot;/fonts/inter/stylesheet.css&quot;</span>/&gt;&lt;<span class=\"built_in\">link</span> rel=<span class=\"string\">&quot;stylesheet&quot;</span> href=<span class=\"string\">&quot;/fonts/roboto-mono/stylesheet.css&quot;</span>/&gt;&lt;script defer=<span class=\"string\">&quot;defer&quot;</span> src=<span class=\"string\">&quot;/bundle.app.77bec96f333a96efe6ea.js&quot;</span>&gt;&lt;/script&gt;&lt;<span class=\"built_in\">link</span> href=<span class=\"string\">&quot;/bundle.app.f1e6c0c33f1535bc8508.css&quot;</span> rel=<span class=\"string\">&quot;stylesheet&quot;</span>&gt;&lt;script <span class=\"built_in\">type</span>=<span class=\"string\">&quot;text/template&quot;</span> <span class=\"built_in\">id</span>=<span class=\"string\">&quot;hubble-ui/feature-flags&quot;</span>&gt;[10, 0, 18, 0, 26, 0, 34, 0, 42, 0, 50, 0]&lt;/script&gt;&lt;script <span class=\"built_in\">type</span>=<span class=\"string\">&quot;text/template&quot;</span> <span class=\"built_in\">id</span>=<span class=\"string\">&quot;hubble-ui/authorization&quot;</span>&gt;[8, 1, 26, 4, 24, 1, 32, 1]&lt;/script&gt;&lt;/head&gt;&lt;body&gt;&lt;div <span class=\"built_in\">id</span>=<span class=\"string\">&quot;test-process-tree-char&quot;</span> style=<span class=\"string\">&quot;font-family: &#x27;Roboto Mono&#x27;, monospace;</span></span><br><span class=\"line\"><span class=\"string\">        font-size: 16px;</span></span><br><span class=\"line\"><span class=\"string\">        position: absolute;</span></span><br><span class=\"line\"><span class=\"string\">        visibility: hidden;</span></span><br><span class=\"line\"><span class=\"string\">        height: auto;</span></span><br><span class=\"line\"><span class=\"string\">        width: auto;</span></span><br><span class=\"line\"><span class=\"string\">        white-space: nowrap;&quot;</span>&gt;a&lt;/div&gt;&lt;div <span class=\"built_in\">id</span>=<span class=\"string\">&quot;app&quot;</span>&gt;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;root@dns-server-vm:~# </span><br><span class=\"line\">root@dns-server-vm:~# </span><br></pre></td></tr></table></figure>\n\n<h1 id=\"5-部署Star-Wars-App\"><a href=\"#5-部署Star-Wars-App\" class=\"headerlink\" title=\"5. 部署Star Wars App\"></a>5. 部署Star Wars App</h1><h2 id=\"5-1-部署APP\"><a href=\"#5-1-部署APP\" class=\"headerlink\" title=\"5.1 部署APP\"></a>5.1 部署APP</h2><p>Isovalent 提供了一个Demo APP，以下是部署脚本。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@kube-node-1:~# kubectl create namespace star-wars</span><br><span class=\"line\">namespace/star-wars created</span><br><span class=\"line\">root@kube-node-1:~# kubectl apply -n star-wars -f https://raw.githubusercontent.com/cilium/cilium/HEAD/examples/minikube/http-sw-app.yaml</span><br><span class=\"line\">service/deathstar created</span><br><span class=\"line\">deployment.apps/deathstar created</span><br><span class=\"line\">pod/tiefighter created</span><br><span class=\"line\">pod/xwing created</span><br><span class=\"line\">root@kube-node-1:~# kubectl -n star-wars get pod -o wide --show-labels</span><br><span class=\"line\">NAME                         READY   STATUS    RESTARTS   AGE   IP             NODE          NOMINATED NODE   READINESS GATES   LABELS</span><br><span class=\"line\">deathstar-86f85ffb4d-4ldsj   1/1     Running   0          39s   172.16.1.231   kube-node-2   &lt;none&gt;           &lt;none&gt;            app.kubernetes.io/name=deathstar,class=deathstar,org=empire,pod-template-hash=86f85ffb4d</span><br><span class=\"line\">deathstar-86f85ffb4d-dbzft   1/1     Running   0          39s   172.16.3.161   kube-node-3   &lt;none&gt;           &lt;none&gt;            app.kubernetes.io/name=deathstar,class=deathstar,org=empire,pod-template-hash=86f85ffb4d</span><br><span class=\"line\">tiefighter                   1/1     Running   0          39s   172.16.3.247   kube-node-3   &lt;none&gt;           &lt;none&gt;            app.kubernetes.io/name=tiefighter,class=tiefighter,org=empire</span><br><span class=\"line\">xwing                        1/1     Running   0          39s   172.16.3.155   kube-node-3   &lt;none&gt;           &lt;none&gt;            app.kubernetes.io/name=xwing,class=xwing,org=alliance</span><br><span class=\"line\">root@kube-node-1:~# kubectl -n star-wars get service -o wide</span><br><span class=\"line\">NAME        TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE   SELECTOR</span><br><span class=\"line\">deathstar   ClusterIP   172.16.39.138   &lt;none&gt;        80/TCP    82s   class=deathstar,org=empire</span><br><span class=\"line\">root@kube-node-1:~# kubectl -n star-wars patch service deathstar -p <span class=\"string\">&#x27;&#123;&quot;spec&quot;:&#123;&quot;type&quot;:&quot;NodePort&quot;&#125;&#125;&#x27;</span></span><br><span class=\"line\">service/deathstar patched</span><br><span class=\"line\">root@kube-node-1:~# kubectl -n star-wars get service -o wide</span><br><span class=\"line\">NAME        TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE    SELECTOR</span><br><span class=\"line\">deathstar   NodePort   172.16.39.138   &lt;none&gt;        80:32271/TCP   112s   class=deathstar,org=empire</span><br><span class=\"line\">root@kube-node-1:~# kubectl -n kube-system <span class=\"built_in\">exec</span> ds/cilium -- cilium service list</span><br><span class=\"line\">Defaulted container <span class=\"string\">&quot;cilium-agent&quot;</span> out of: cilium-agent, config (init), mount-cgroup (init), apply-sysctl-overwrites (init), mount-bpf-fs (init), clean-cilium-state (init), install-cni-binaries (init)</span><br><span class=\"line\">ID   Frontend                Service Type   Backend                               </span><br><span class=\"line\">1    172.16.32.1:443/TCP     ClusterIP      1 =&gt; 10.75.59.71:6443/TCP (active)    </span><br><span class=\"line\">2    172.16.43.10:443/TCP    ClusterIP      1 =&gt; 10.75.59.71:4244/TCP (active)    </span><br><span class=\"line\">3    172.16.37.239:80/TCP    ClusterIP      1 =&gt; 172.16.1.81:4245/TCP (active)    </span><br><span class=\"line\">4    10.75.59.71:31234/TCP   NodePort       1 =&gt; 172.16.1.81:4245/TCP (active)    </span><br><span class=\"line\">5    0.0.0.0:31234/TCP       NodePort       1 =&gt; 172.16.1.81:4245/TCP (active)    </span><br><span class=\"line\">6    172.16.32.10:53/TCP     ClusterIP      1 =&gt; 172.16.1.64:53/TCP (active)      </span><br><span class=\"line\">                                            2 =&gt; 172.16.1.40:53/TCP (active)      </span><br><span class=\"line\">7    172.16.32.10:9153/TCP   ClusterIP      1 =&gt; 172.16.1.64:9153/TCP (active)    </span><br><span class=\"line\">                                            2 =&gt; 172.16.1.40:9153/TCP (active)    </span><br><span class=\"line\">8    172.16.32.10:53/UDP     ClusterIP      1 =&gt; 172.16.1.64:53/UDP (active)      </span><br><span class=\"line\">                                            2 =&gt; 172.16.1.40:53/UDP (active)      </span><br><span class=\"line\">9    172.16.35.177:80/TCP    ClusterIP      1 =&gt; 172.16.3.127:8081/TCP (active)   </span><br><span class=\"line\">10   10.75.59.71:31225/TCP   NodePort       1 =&gt; 172.16.3.127:8081/TCP (active)   </span><br><span class=\"line\">11   0.0.0.0:31225/TCP       NodePort       1 =&gt; 172.16.3.127:8081/TCP (active)   </span><br><span class=\"line\">12   172.16.39.138:80/TCP    ClusterIP      1 =&gt; 172.16.3.161:80/TCP (active)     </span><br><span class=\"line\">                                            2 =&gt; 172.16.1.231:80/TCP (active)     </span><br><span class=\"line\">13   10.75.59.71:32271/TCP   NodePort       1 =&gt; 172.16.3.161:80/TCP (active)     </span><br><span class=\"line\">                                            2 =&gt; 172.16.1.231:80/TCP (active)     </span><br><span class=\"line\">14   0.0.0.0:32271/TCP       NodePort       1 =&gt; 172.16.3.161:80/TCP (active)     </span><br><span class=\"line\">                                            2 =&gt; 172.16.1.231:80/TCP (active)     </span><br><span class=\"line\">到这里就算部署成功了。</span><br><span class=\"line\"></span><br><span class=\"line\">root@kube-node-1:~# kubectl -n star-wars <span class=\"built_in\">exec</span> tiefighter --   curl -s -XPOST http://deathstar.star-wars.svc.cluster.local/v1/request-landing</span><br><span class=\"line\">Ship landed</span><br><span class=\"line\">root@kube-node-1:~# kubectl -n star-wars <span class=\"built_in\">exec</span> xwing --   curl -s -XPOST http://deathstar.star-wars.svc.cluster.local/v1/request-landing</span><br><span class=\"line\">Ship landed</span><br><span class=\"line\">root@kube-node-1:~# </span><br><span class=\"line\"></span><br><span class=\"line\">在外部的设备也可以通过节点IP访问。</span><br><span class=\"line\"></span><br><span class=\"line\">root@dns-server-vm:~# curl -s -XPOST http://10.75.59.72:32271/v1/request-landing</span><br><span class=\"line\">Ship landed</span><br><span class=\"line\">root@dns-server-vm:~# curl -s -XPOST http://10.75.59.71:32271/v1/request-landing</span><br><span class=\"line\">Ship landed</span><br><span class=\"line\">root@dns-server-vm:~# curl -s -XPOST http://10.75.59.73:32271/v1/request-landing</span><br><span class=\"line\">Ship landed</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"5-2-在Node外部抓包-Pod-to-Pod\"><a href=\"#5-2-在Node外部抓包-Pod-to-Pod\" class=\"headerlink\" title=\"5.2 在Node外部抓包 ( Pod to Pod )\"></a>5.2 在Node外部抓包 ( Pod to Pod )</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">查找虚拟机连接在网桥上的网卡</span><br><span class=\"line\"></span><br><span class=\"line\">root@ois:/home/ois/data/k8s# virsh list</span><br><span class=\"line\"> Id    Name                  State</span><br><span class=\"line\">--------------------------------------</span><br><span class=\"line\"> 4     win1                  running</span><br><span class=\"line\"> 17    r1                    running</span><br><span class=\"line\"> 69    ubuntu-2404-desktop   running</span><br><span class=\"line\"> 96    dns-server-vm         running</span><br><span class=\"line\"> 97    u1                    running</span><br><span class=\"line\"> 98    ubuntu24042           running</span><br><span class=\"line\"> 99    kube-node-1           running</span><br><span class=\"line\"> 100   kube-node-2           running</span><br><span class=\"line\"> 101   kube-node-3           running</span><br><span class=\"line\"></span><br><span class=\"line\">root@ois:/home/ois/data/k8s# virsh domiflist 99</span><br><span class=\"line\"> Interface   Type     Source   Model    MAC</span><br><span class=\"line\">-----------------------------------------------------------</span><br><span class=\"line\"> vnet90      bridge   br0      virtio   52:54:00:90:8c:cf</span><br><span class=\"line\"></span><br><span class=\"line\">root@ois:/home/ois/data/k8s# virsh domiflist 100</span><br><span class=\"line\"> Interface   Type     Source   Model    MAC</span><br><span class=\"line\">-----------------------------------------------------------</span><br><span class=\"line\"> vnet91      bridge   br0      virtio   52:54:00:ba:d4:1f</span><br><span class=\"line\"></span><br><span class=\"line\">root@ois:/home/ois/data/k8s# virsh domiflist 101</span><br><span class=\"line\"> Interface   Type     Source   Model    MAC</span><br><span class=\"line\">-----------------------------------------------------------</span><br><span class=\"line\"> vnet92      bridge   br0      virtio   52:54:00:37:e0:96</span><br><span class=\"line\"> </span><br><span class=\"line\"> </span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">在Pod中发起访问</span><br><span class=\"line\"></span><br><span class=\"line\">root@kube-node-1:~# kubectl -n star-wars get pods -o wide</span><br><span class=\"line\">NAME                         READY   STATUS    RESTARTS   AGE    IP             NODE          NOMINATED NODE   READINESS GATES</span><br><span class=\"line\">deathstar-86f85ffb4d-4ldsj   1/1     Running   0          4m1s   172.16.1.231   kube-node-2   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">deathstar-86f85ffb4d-dbzft   1/1     Running   0          4m1s   172.16.3.161   kube-node-3   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">tiefighter                   1/1     Running   0          4m1s   172.16.3.247   kube-node-3   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">xwing                        1/1     Running   0          4m1s   172.16.3.155   kube-node-3   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">root@kube-node-1:~# kubectl -n star-wars <span class=\"built_in\">exec</span> xwing -- ip a                                                                            </span><br><span class=\"line\">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class=\"line\">    <span class=\"built_in\">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class=\"line\">    inet 127.0.0.1/8 scope host lo</span><br><span class=\"line\">       valid_lft forever preferred_lft forever</span><br><span class=\"line\">    inet6 ::1/128 scope host </span><br><span class=\"line\">       valid_lft forever preferred_lft forever</span><br><span class=\"line\">11: eth0@if12: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default qlen 1000</span><br><span class=\"line\">    <span class=\"built_in\">link</span>/ether f2:2a:b8:da:e7:d2 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span><br><span class=\"line\">    inet 172.16.3.155/32 scope global eth0</span><br><span class=\"line\">       valid_lft forever preferred_lft forever</span><br><span class=\"line\">    inet6 fe80::f02a:b8ff:feda:e7d2/64 scope <span class=\"built_in\">link</span> </span><br><span class=\"line\">       valid_lft forever preferred_lft forever</span><br><span class=\"line\">root@kube-node-1:~# kubectl -n star-wars <span class=\"built_in\">exec</span> xwing -- ping 172.16.1.231</span><br><span class=\"line\">error: Internal error occurred: Internal error occurred: error executing <span class=\"built_in\">command</span> <span class=\"keyword\">in</span> container: failed to <span class=\"built_in\">exec</span> <span class=\"keyword\">in</span> container: failed to start <span class=\"built_in\">exec</span> <span class=\"string\">&quot;1b1120795a5b60f35bac5a4056a1714a5c0df32762e2a79f272cf2c82089e970&quot;</span>: OCI runtime <span class=\"built_in\">exec</span> failed: <span class=\"built_in\">exec</span> failed: unable to start container process: <span class=\"built_in\">exec</span>: <span class=\"string\">&quot;ping&quot;</span>: executable file not found <span class=\"keyword\">in</span> <span class=\"variable\">$PATH</span>: unknown</span><br><span class=\"line\">root@kube-node-1:~# kubectl -n star-wars <span class=\"built_in\">exec</span> xwing -- curl -s http://172.16.1.231/v1</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;name&quot;</span>: <span class=\"string\">&quot;Death Star&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;hostname&quot;</span>: <span class=\"string\">&quot;deathstar-86f85ffb4d-4ldsj&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;model&quot;</span>: <span class=\"string\">&quot;DS-1 Orbital Battle Station&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;manufacturer&quot;</span>: <span class=\"string\">&quot;Imperial Department of Military Research, Sienar Fleet Systems&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;cost_in_credits&quot;</span>: <span class=\"string\">&quot;1000000000000&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;length&quot;</span>: <span class=\"string\">&quot;120000&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;crew&quot;</span>: <span class=\"string\">&quot;342953&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;passengers&quot;</span>: <span class=\"string\">&quot;843342&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;cargo_capacity&quot;</span>: <span class=\"string\">&quot;1000000000000&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;hyperdrive_rating&quot;</span>: <span class=\"string\">&quot;4.0&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;starship_class&quot;</span>: <span class=\"string\">&quot;Deep Space Mobile Battlestation&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;api&quot;</span>: [</span><br><span class=\"line\">                <span class=\"string\">&quot;GET   /v1&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;GET   /v1/healthz&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;POST  /v1/request-landing&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;PUT   /v1/cargobay&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;GET   /v1/hyper-matter-reactor/status&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;PUT   /v1/exhaust-port&quot;</span></span><br><span class=\"line\">        ]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">在宿主机上进行抓包，可以看到两者之间是直接路由的。</span><br><span class=\"line\"></span><br><span class=\"line\">root@ois:/home/ois/data/k8s# tcpdump -i vnet92 -vn <span class=\"string\">&#x27;tcp port 80&#x27;</span></span><br><span class=\"line\">tcpdump: listening on vnet92, link-type EN10MB (Ethernet), snapshot length 262144 bytes</span><br><span class=\"line\">11:11:11.478887 IP (tos 0x0, ttl 63, <span class=\"built_in\">id</span> 25688, offset 0, flags [DF], proto TCP (6), length 60)</span><br><span class=\"line\">    172.16.3.155.37162 &gt; 172.16.1.231.80: Flags [S], <span class=\"built_in\">cksum</span> 0x5dd1 (incorrect -&gt; 0xdb07), <span class=\"built_in\">seq</span> 542023762, win 64240, options [mss 1460,sackOK,TS val 1624400247 ecr 0,nop,wscale 7], length 0</span><br><span class=\"line\">11:11:11.479178 IP (tos 0x0, ttl 63, <span class=\"built_in\">id</span> 0, offset 0, flags [DF], proto TCP (6), length 60)</span><br><span class=\"line\">    172.16.1.231.80 &gt; 172.16.3.155.37162: Flags [S.], <span class=\"built_in\">cksum</span> 0x5dd1 (incorrect -&gt; 0x7b14), <span class=\"built_in\">seq</span> 3892089835, ack 542023763, win 65160, options [mss 1460,sackOK,TS val 727758081 ecr 1624400247,nop,wscale 7], length 0</span><br><span class=\"line\">11:11:11.479479 IP (tos 0x0, ttl 63, <span class=\"built_in\">id</span> 25689, offset 0, flags [DF], proto TCP (6), length 52)</span><br><span class=\"line\">    172.16.3.155.37162 &gt; 172.16.1.231.80: Flags [.], <span class=\"built_in\">cksum</span> 0x5dc9 (incorrect -&gt; 0xa673), ack 1, win 502, options [nop,nop,TS val 1624400247 ecr 727758081], length 0</span><br><span class=\"line\">11:11:11.479552 IP (tos 0x0, ttl 63, <span class=\"built_in\">id</span> 25690, offset 0, flags [DF], proto TCP (6), length 130)</span><br><span class=\"line\">    172.16.3.155.37162 &gt; 172.16.1.231.80: Flags [P.], <span class=\"built_in\">cksum</span> 0x5e17 (incorrect -&gt; 0x366d), <span class=\"built_in\">seq</span> 1:79, ack 1, win 502, options [nop,nop,TS val 1624400247 ecr 727758081], length 78: HTTP, length: 78</span><br><span class=\"line\">        GET /v1 HTTP/1.1</span><br><span class=\"line\">        Host: 172.16.1.231</span><br><span class=\"line\">        User-Agent: curl/7.88.1</span><br><span class=\"line\">        Accept: */*</span><br><span class=\"line\"></span><br><span class=\"line\">11:11:11.479684 IP (tos 0x0, ttl 63, <span class=\"built_in\">id</span> 13836, offset 0, flags [DF], proto TCP (6), length 52)</span><br><span class=\"line\">    172.16.1.231.80 &gt; 172.16.3.155.37162: Flags [.], <span class=\"built_in\">cksum</span> 0x5dc9 (incorrect -&gt; 0xa61e), ack 79, win 509, options [nop,nop,TS val 727758081 ecr 1624400247], length 0</span><br><span class=\"line\">11:11:11.480420 IP (tos 0x0, ttl 63, <span class=\"built_in\">id</span> 13837, offset 0, flags [DF], proto TCP (6), length 746)</span><br><span class=\"line\">    172.16.1.231.80 &gt; 172.16.3.155.37162: Flags [P.], <span class=\"built_in\">cksum</span> 0x607f (incorrect -&gt; 0xc657), <span class=\"built_in\">seq</span> 1:695, ack 79, win 509, options [nop,nop,TS val 727758082 ecr 1624400247], length 694: HTTP, length: 694</span><br><span class=\"line\">        HTTP/1.1 200 OK</span><br><span class=\"line\">        Content-Type: text/plain</span><br><span class=\"line\">        Date: Fri, 01 Aug 2025 03:11:11 GMT</span><br><span class=\"line\">        Content-Length: 591</span><br><span class=\"line\"></span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">                <span class=\"string\">&quot;name&quot;</span>: <span class=\"string\">&quot;Death Star&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;hostname&quot;</span>: <span class=\"string\">&quot;deathstar-86f85ffb4d-4ldsj&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;model&quot;</span>: <span class=\"string\">&quot;DS-1 Orbital Battle Station&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;manufacturer&quot;</span>: <span class=\"string\">&quot;Imperial Department of Military Research, Sienar Fleet Systems&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;cost_in_credits&quot;</span>: <span class=\"string\">&quot;1000000000000&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;length&quot;</span>: <span class=\"string\">&quot;120000&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;crew&quot;</span>: <span class=\"string\">&quot;342953&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;passengers&quot;</span>: <span class=\"string\">&quot;843342&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;cargo_capacity&quot;</span>: <span class=\"string\">&quot;1000000000000&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;hyperdrive_rating&quot;</span>: <span class=\"string\">&quot;4.0&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;starship_class&quot;</span>: <span class=\"string\">&quot;Deep Space Mobile Battlestation&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;api&quot;</span>: [</span><br><span class=\"line\">                        <span class=\"string\">&quot;GET   /v1&quot;</span>,</span><br><span class=\"line\">                        <span class=\"string\">&quot;GET   /v1/healthz&quot;</span>,</span><br><span class=\"line\">                        <span class=\"string\">&quot;POST  /v1/request-landing&quot;</span>,</span><br><span class=\"line\">                        <span class=\"string\">&quot;PUT   /v1/cargobay&quot;</span>,</span><br><span class=\"line\">                        <span class=\"string\">&quot;GET   /v1/hyper-matter-reactor/status&quot;</span>,</span><br><span class=\"line\">                        <span class=\"string\">&quot;PUT   /v1/exhaust-port&quot;</span></span><br><span class=\"line\">                ]</span><br><span class=\"line\">        &#125;       </span><br></pre></td></tr></table></figure>\n\n<p>Cilium将各个Node对应的Pod路由自动安装了</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@kube-node-3:~# ip route show</span><br><span class=\"line\">default via 10.75.59.1 dev enp1s0 proto static </span><br><span class=\"line\">10.75.59.0/24 dev enp1s0 proto kernel scope <span class=\"built_in\">link</span> src 10.75.59.73 </span><br><span class=\"line\">172.16.0.0/24 via 10.75.59.71 dev enp1s0 proto kernel </span><br><span class=\"line\">172.16.1.0/24 via 10.75.59.72 dev enp1s0 proto kernel </span><br><span class=\"line\">172.16.3.0/24 via 172.16.3.22 dev cilium_host proto kernel src 172.16.3.22 </span><br><span class=\"line\">172.16.3.22 dev cilium_host proto kernel scope <span class=\"built_in\">link</span> </span><br><span class=\"line\">root@kube-node-3:~# route -n</span><br><span class=\"line\">Kernel IP routing table</span><br><span class=\"line\">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class=\"line\">0.0.0.0         10.75.59.1      0.0.0.0         UG    0      0        0 enp1s0</span><br><span class=\"line\">10.75.59.0      0.0.0.0         255.255.255.0   U     0      0        0 enp1s0</span><br><span class=\"line\">172.16.0.0      10.75.59.71     255.255.255.0   UG    0      0        0 enp1s0</span><br><span class=\"line\">172.16.1.0      10.75.59.72     255.255.255.0   UG    0      0        0 enp1s0</span><br><span class=\"line\">172.16.3.0      172.16.3.22     255.255.255.0   UG    0      0        0 cilium_host</span><br><span class=\"line\">172.16.3.22     0.0.0.0         255.255.255.255 UH    0      0        0 cilium_host</span><br><span class=\"line\"></span><br><span class=\"line\">root@kube-node-2:~# ip route show</span><br><span class=\"line\">default via 10.75.59.1 dev enp1s0 proto static </span><br><span class=\"line\">10.75.59.0/24 dev enp1s0 proto kernel scope <span class=\"built_in\">link</span> src 10.75.59.72 </span><br><span class=\"line\">172.16.0.0/24 via 10.75.59.71 dev enp1s0 proto kernel </span><br><span class=\"line\">172.16.1.0/24 via 172.16.1.128 dev cilium_host proto kernel src 172.16.1.128 </span><br><span class=\"line\">172.16.1.128 dev cilium_host proto kernel scope <span class=\"built_in\">link</span> </span><br><span class=\"line\">172.16.3.0/24 via 10.75.59.73 dev enp1s0 proto kernel </span><br><span class=\"line\">root@kube-node-2:~# route -n</span><br><span class=\"line\">Kernel IP routing table</span><br><span class=\"line\">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class=\"line\">0.0.0.0         10.75.59.1      0.0.0.0         UG    0      0        0 enp1s0</span><br><span class=\"line\">10.75.59.0      0.0.0.0         255.255.255.0   U     0      0        0 enp1s0</span><br><span class=\"line\">172.16.0.0      10.75.59.71     255.255.255.0   UG    0      0        0 enp1s0</span><br><span class=\"line\">172.16.1.0      172.16.1.128    255.255.255.0   UG    0      0        0 cilium_host</span><br><span class=\"line\">172.16.1.128    0.0.0.0         255.255.255.255 UH    0      0        0 cilium_host</span><br><span class=\"line\">172.16.3.0      10.75.59.73     255.255.255.0   UG    0      0        0 enp1s0</span><br></pre></td></tr></table></figure>\n\n<p>在Hubble UI中，可以看到详细的Flow</p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;uuid&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;2af76725-f6f9-49b4-b9f1-8d01b3f14930&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;verdict&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">1</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;drop_reason&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">0</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;auth_type&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">0</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;Type&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">1</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;node_name&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;kube-node-2&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;node_labels&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span></span><br><span class=\"line\">    <span class=\"string\">&quot;beta.kubernetes.io/arch=amd64&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"string\">&quot;beta.kubernetes.io/os=linux&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"string\">&quot;kubernetes.io/arch=amd64&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"string\">&quot;kubernetes.io/hostname=kube-node-2&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"string\">&quot;kubernetes.io/os=linux&quot;</span></span><br><span class=\"line\">  <span class=\"punctuation\">]</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;source_names&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span><span class=\"punctuation\">]</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;destination_names&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span><span class=\"punctuation\">]</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;reply&quot;</span><span class=\"punctuation\">:</span> <span class=\"literal\"><span class=\"keyword\">false</span></span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;traffic_direction&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">2</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;policy_match_type&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">0</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;trace_observation_point&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">101</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;trace_reason&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">1</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;drop_reason_desc&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">0</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;debug_capture_point&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">0</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;proxy_port&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">0</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;sock_xlate_point&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">0</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;socket_cookie&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">0</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;cgroup_id&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">0</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;Summary&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;TCP Flags: SYN&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;egress_allowed_by&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span><span class=\"punctuation\">]</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;ingress_allowed_by&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span><span class=\"punctuation\">]</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;egress_denied_by&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span><span class=\"punctuation\">]</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;ingress_denied_by&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span><span class=\"punctuation\">]</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;time&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;seconds&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">1754022736</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;nanos&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">962926009</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;ethernet&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;source&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;f2:64:9f:b5:8e:81&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;destination&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;82:31:36:d1:5a:00&quot;</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;IP&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;source&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;172.16.3.155&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;source_xlated&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;destination&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;172.16.1.231&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;ipVersion&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">1</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;encrypted&quot;</span><span class=\"punctuation\">:</span> <span class=\"literal\"><span class=\"keyword\">false</span></span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;l4&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;protocol&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;oneofKind&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;TCP&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"attr\">&quot;TCP&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">        <span class=\"attr\">&quot;source_port&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">38680</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">        <span class=\"attr\">&quot;destination_port&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">80</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">        <span class=\"attr\">&quot;flags&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">          <span class=\"attr\">&quot;FIN&quot;</span><span class=\"punctuation\">:</span> <span class=\"literal\"><span class=\"keyword\">false</span></span><span class=\"punctuation\">,</span></span><br><span class=\"line\">          <span class=\"attr\">&quot;SYN&quot;</span><span class=\"punctuation\">:</span> <span class=\"literal\"><span class=\"keyword\">true</span></span><span class=\"punctuation\">,</span></span><br><span class=\"line\">          <span class=\"attr\">&quot;RST&quot;</span><span class=\"punctuation\">:</span> <span class=\"literal\"><span class=\"keyword\">false</span></span><span class=\"punctuation\">,</span></span><br><span class=\"line\">          <span class=\"attr\">&quot;PSH&quot;</span><span class=\"punctuation\">:</span> <span class=\"literal\"><span class=\"keyword\">false</span></span><span class=\"punctuation\">,</span></span><br><span class=\"line\">          <span class=\"attr\">&quot;ACK&quot;</span><span class=\"punctuation\">:</span> <span class=\"literal\"><span class=\"keyword\">false</span></span><span class=\"punctuation\">,</span></span><br><span class=\"line\">          <span class=\"attr\">&quot;URG&quot;</span><span class=\"punctuation\">:</span> <span class=\"literal\"><span class=\"keyword\">false</span></span><span class=\"punctuation\">,</span></span><br><span class=\"line\">          <span class=\"attr\">&quot;ECE&quot;</span><span class=\"punctuation\">:</span> <span class=\"literal\"><span class=\"keyword\">false</span></span><span class=\"punctuation\">,</span></span><br><span class=\"line\">          <span class=\"attr\">&quot;CWR&quot;</span><span class=\"punctuation\">:</span> <span class=\"literal\"><span class=\"keyword\">false</span></span><span class=\"punctuation\">,</span></span><br><span class=\"line\">          <span class=\"attr\">&quot;NS&quot;</span><span class=\"punctuation\">:</span> <span class=\"literal\"><span class=\"keyword\">false</span></span></span><br><span class=\"line\">        <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">      <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;source&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;ID&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">0</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;identity&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">36770</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;cluster_name&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;default&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;namespace&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;star-wars&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;labels&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span></span><br><span class=\"line\">      <span class=\"string\">&quot;k8s:app.kubernetes.io/name=xwing&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"string\">&quot;k8s:class=xwing&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"string\">&quot;k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=star-wars&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"string\">&quot;k8s:io.cilium.k8s.policy.cluster=default&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"string\">&quot;k8s:io.cilium.k8s.policy.serviceaccount=default&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"string\">&quot;k8s:io.kubernetes.pod.namespace=star-wars&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"string\">&quot;k8s:org=alliance&quot;</span></span><br><span class=\"line\">    <span class=\"punctuation\">]</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;pod_name&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;xwing&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;workloads&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span><span class=\"punctuation\">]</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;destination&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;ID&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">284</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;identity&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">15153</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;cluster_name&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;default&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;namespace&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;star-wars&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;labels&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span></span><br><span class=\"line\">      <span class=\"string\">&quot;k8s:app.kubernetes.io/name=deathstar&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"string\">&quot;k8s:class=deathstar&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"string\">&quot;k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=star-wars&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"string\">&quot;k8s:io.cilium.k8s.policy.cluster=default&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"string\">&quot;k8s:io.cilium.k8s.policy.serviceaccount=default&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"string\">&quot;k8s:io.kubernetes.pod.namespace=star-wars&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"string\">&quot;k8s:org=empire&quot;</span></span><br><span class=\"line\">    <span class=\"punctuation\">]</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;pod_name&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;deathstar-86f85ffb4d-4ldsj&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;workloads&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span></span><br><span class=\"line\">      <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">        <span class=\"attr\">&quot;name&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;deathstar&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">        <span class=\"attr\">&quot;kind&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;Deployment&quot;</span></span><br><span class=\"line\">      <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\">    <span class=\"punctuation\">]</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;event_type&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;type&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">4</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;sub_type&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">0</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;is_reply&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;value&quot;</span><span class=\"punctuation\">:</span> <span class=\"literal\"><span class=\"keyword\">false</span></span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">  <span class=\"attr\">&quot;interface&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;index&quot;</span><span class=\"punctuation\">:</span> <span class=\"number\">14</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;name&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;lxcf734e435e18a&quot;</span></span><br><span class=\"line\">  <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"5-3-在Node外部抓包-Pod-to-External\"><a href=\"#5-3-在Node外部抓包-Pod-to-External\" class=\"headerlink\" title=\"5.3 在Node外部抓包 ( Pod to External )\"></a>5.3 在Node外部抓包 ( Pod to External )</h2><p>接下来，在Pod内部访问Internet进行测试。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@kube-node-1:~# kubectl get configmap cilium-config -n kube-system -o yaml | grep -E <span class=\"string\">&#x27;enable-ipv4-masquerade|enable-bpf-masquerade&#x27;</span></span><br><span class=\"line\">  enable-bpf-masquerade: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  enable-ipv4-masquerade: <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  </span><br><span class=\"line\">Pod xwing 位于Kube-node3，在Node3查看</span><br><span class=\"line\"></span><br><span class=\"line\">root@kube-node-1:~# kubectl get pods -n kube-system -l k8s-app=cilium -o wide | grep kube-node-3</span><br><span class=\"line\">cilium-2vrgj   1/1     Running   0          106m   10.75.59.73   kube-node-3   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">root@kube-node-1:~# kubectl -n star-wars <span class=\"built_in\">exec</span> xwing -- curl -s https://echo.free.beeceptor.com</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;method&quot;</span>: <span class=\"string\">&quot;GET&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;protocol&quot;</span>: <span class=\"string\">&quot;https&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;host&quot;</span>: <span class=\"string\">&quot;echo.free.beeceptor.com&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;path&quot;</span>: <span class=\"string\">&quot;/&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;ip&quot;</span>: <span class=\"string\">&quot;64.104.44.105:35834&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;headers&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;Host&quot;</span>: <span class=\"string\">&quot;echo.free.beeceptor.com&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;User-Agent&quot;</span>: <span class=\"string\">&quot;curl/7.88.1&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;Accept&quot;</span>: <span class=\"string\">&quot;*/*&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;Via&quot;</span>: <span class=\"string\">&quot;2.0 Caddy&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;Accept-Encoding&quot;</span>: <span class=\"string\">&quot;gzip&quot;</span></span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">&quot;parsedQueryParams&quot;</span>: &#123;&#125;</span><br><span class=\"line\">&#125;root@kube-node-1:~# </span><br><span class=\"line\">root@kube-node-1:~# </span><br><span class=\"line\"></span><br><span class=\"line\">使用 cilium bpf nat list 查看NAT表</span><br><span class=\"line\"></span><br><span class=\"line\">root@kube-node-1:~# kubectl <span class=\"built_in\">exec</span> -n kube-system cilium-2vrgj -- cilium bpf nat list | grep 172.16.3.155</span><br><span class=\"line\">Defaulted container <span class=\"string\">&quot;cilium-agent&quot;</span> out of: cilium-agent, config (init), mount-cgroup (init), apply-sysctl-overwrites (init), mount-bpf-fs (init), clean-cilium-state (init), install-cni-binaries (init)</span><br><span class=\"line\">TCP OUT 172.16.3.155:35834 -&gt; 147.182.252.2:443 XLATE_SRC 10.75.59.73:35834 Created=4sec ago NeedsCT=0</span><br><span class=\"line\">TCP IN 147.182.252.2:443 -&gt; 10.75.59.73:35834 XLATE_DST 172.16.3.155:35834 Created=4sec ago NeedsCT=0</span><br><span class=\"line\">root@kube-node-1:~# </span><br><span class=\"line\">root@kube-node-1:~# </span><br><span class=\"line\"></span><br><span class=\"line\">在外部的抓包：</span><br><span class=\"line\">root@ois:/home/ois/data/k8s# tcpdump -i vnet92 -vn <span class=\"string\">&#x27;tcp port 443&#x27;</span></span><br><span class=\"line\">tcpdump: listening on vnet92, link-type EN10MB (Ethernet), snapshot length 262144 bytes</span><br><span class=\"line\">12:28:22.307306 IP (tos 0x0, ttl 63, <span class=\"built_in\">id</span> 45759, offset 0, flags [DF], proto TCP (6), length 60)</span><br><span class=\"line\">    10.75.59.73.49208 &gt; 147.182.252.2.443: Flags [S], <span class=\"built_in\">cksum</span> 0xd57b (incorrect -&gt; 0x363a), <span class=\"built_in\">seq</span> 3275650602, win 64240, options [mss 1460,sackOK,TS val 493037768 ecr 0,nop,wscale 7], length 0</span><br><span class=\"line\">12:28:22.477754 IP (tos 0x0, ttl 42, <span class=\"built_in\">id</span> 0, offset 0, flags [DF], proto TCP (6), length 60)</span><br><span class=\"line\">    147.182.252.2.443 &gt; 10.75.59.73.49208: Flags [S.], <span class=\"built_in\">cksum</span> 0xed16 (correct), <span class=\"built_in\">seq</span> 450982431, ack 3275650603, win 65160, options [mss 1254,sackOK,TS val 1573215106 ecr 493037768,nop,wscale 7], length 0</span><br><span class=\"line\">12:28:22.478053 IP (tos 0x0, ttl 63, <span class=\"built_in\">id</span> 45760, offset 0, flags [DF], proto TCP (6), length 52)</span><br><span class=\"line\">    10.75.59.73.49208 &gt; 147.182.252.2.443: Flags [.], <span class=\"built_in\">cksum</span> 0xd573 (incorrect -&gt; 0x16fd), ack 1, win 502, options [nop,nop,TS val 493037939 ecr 1573215106], length 0</span><br><span class=\"line\">12:28:22.490922 IP (tos 0x0, ttl 63, <span class=\"built_in\">id</span> 45761, offset 0, flags [DF], proto TCP (6), length 569)</span><br><span class=\"line\">    10.75.59.73.49208 &gt; 147.182.252.2.443: Flags [P.], <span class=\"built_in\">cksum</span> 0xd778 (incorrect -&gt; 0x1d27), <span class=\"built_in\">seq</span> 1:518, ack 1, win 502, options [nop,nop,TS val 493037952 ecr 1573215106], length 517</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"6-安装K8S和Cilium脚本自动化\"><a href=\"#6-安装K8S和Cilium脚本自动化\" class=\"headerlink\" title=\"6. 安装K8S和Cilium脚本自动化\"></a>6. 安装K8S和Cilium脚本自动化</h1><p>接下来打算把K8S和Cilium的安装脚本自动化。</p>\n<p>首先需要解决在kube-node-1 能 无密码登录到kube-node-2 和 kube-node-3。</p>\n<h2 id=\"6-1-无密码登录设置\"><a href=\"#6-1-无密码登录设置\" class=\"headerlink\" title=\"6.1 无密码登录设置\"></a>6.1 无密码登录设置</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#!/bin/bash</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># --- Configuration ---</span></span><br><span class=\"line\">ANSIBLE_DIR=<span class=\"string\">&quot;ansible_ssh_setup&quot;</span></span><br><span class=\"line\">INVENTORY_FILE=<span class=\"string\">&quot;<span class=\"variable\">$&#123;ANSIBLE_DIR&#125;</span>/hosts.ini&quot;</span></span><br><span class=\"line\">PLAYBOOK_FILE=<span class=\"string\">&quot;<span class=\"variable\">$&#123;ANSIBLE_DIR&#125;</span>/setup_ssh.yml&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Kubernetes Node IPs</span></span><br><span class=\"line\">KUBE_NODE_1_IP=<span class=\"string\">&quot;10.75.59.71&quot;</span></span><br><span class=\"line\">KUBE_NODE_2_IP=<span class=\"string\">&quot;10.75.59.72&quot;</span></span><br><span class=\"line\">KUBE_NODE_3_IP=<span class=\"string\">&quot;10.75.59.73&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Common Ansible user and Python interpreter</span></span><br><span class=\"line\">ANSIBLE_USER=<span class=\"string\">&quot;ubuntu&quot;</span></span><br><span class=\"line\">ANSIBLE_PYTHON_INTERPRETER=<span class=\"string\">&quot;/usr/bin/python3&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># --- Functions ---</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Function to check and install Ansible</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">install_ansible</span></span>() &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> ! <span class=\"built_in\">command</span> -v ansible &amp;&gt; /dev/null</span><br><span class=\"line\">    <span class=\"keyword\">then</span></span><br><span class=\"line\">        <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Ansible not found. Attempting to install Ansible...&quot;</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> [ -f /etc/debian_version ]; <span class=\"keyword\">then</span></span><br><span class=\"line\">            <span class=\"comment\"># Debian/Ubuntu</span></span><br><span class=\"line\">            <span class=\"built_in\">sudo</span> apt update</span><br><span class=\"line\">            <span class=\"built_in\">sudo</span> apt install -y software-properties-common</span><br><span class=\"line\">            <span class=\"built_in\">sudo</span> add-apt-repository --<span class=\"built_in\">yes</span> --update ppa:ansible/ansible</span><br><span class=\"line\">            <span class=\"built_in\">sudo</span> apt install -y ansible</span><br><span class=\"line\">        <span class=\"keyword\">elif</span> [ -f /etc/redhat-release ]; <span class=\"keyword\">then</span></span><br><span class=\"line\">            <span class=\"comment\"># CentOS/RHEL/Fedora</span></span><br><span class=\"line\">            <span class=\"built_in\">sudo</span> yum install -y epel-release</span><br><span class=\"line\">            <span class=\"built_in\">sudo</span> yum install -y ansible</span><br><span class=\"line\">        <span class=\"keyword\">else</span></span><br><span class=\"line\">            <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Unsupported OS for automatic Ansible installation. Please install Ansible manually.&quot;</span></span><br><span class=\"line\">            <span class=\"built_in\">exit</span> 1</span><br><span class=\"line\">        <span class=\"keyword\">fi</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> ! <span class=\"built_in\">command</span> -v ansible &amp;&gt; /dev/null; <span class=\"keyword\">then</span></span><br><span class=\"line\">            <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Ansible installation failed. Please install it manually and re-run this script.&quot;</span></span><br><span class=\"line\">            <span class=\"built_in\">exit</span> 1</span><br><span class=\"line\">        <span class=\"keyword\">fi</span></span><br><span class=\"line\">        <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Ansible installed successfully.&quot;</span></span><br><span class=\"line\">    <span class=\"keyword\">else</span></span><br><span class=\"line\">        <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Ansible is already installed.&quot;</span></span><br><span class=\"line\">    <span class=\"keyword\">fi</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Function to create Ansible inventory file</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">create_inventory</span></span>() &#123;</span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Creating Ansible inventory file: <span class=\"variable\">$&#123;INVENTORY_FILE&#125;</span>&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">mkdir</span> -p <span class=\"string\">&quot;<span class=\"variable\">$ANSIBLE_DIR</span>&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOF &gt; &quot;$INVENTORY_FILE&quot;</span></span><br><span class=\"line\"><span class=\"string\">[kubernetes_nodes]</span></span><br><span class=\"line\"><span class=\"string\">kube-node-1 ansible_host=$&#123;KUBE_NODE_1_IP&#125;</span></span><br><span class=\"line\"><span class=\"string\">kube-node-2 ansible_host=$&#123;KUBE_NODE_2_IP&#125;</span></span><br><span class=\"line\"><span class=\"string\">kube-node-3 ansible_host=$&#123;KUBE_NODE_3_IP&#125;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">[all:vars]</span></span><br><span class=\"line\"><span class=\"string\">ansible_user=$&#123;ANSIBLE_USER&#125;</span></span><br><span class=\"line\"><span class=\"string\">ansible_python_interpreter=$&#123;ANSIBLE_PYTHON_INTERPRETER&#125;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Inventory file created.&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Function to create Ansible playbook file</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">create_playbook</span></span>() &#123;</span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Creating Ansible playbook file: <span class=\"variable\">$&#123;PLAYBOOK_FILE&#125;</span>&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">mkdir</span> -p <span class=\"string\">&quot;<span class=\"variable\">$ANSIBLE_DIR</span>&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">&#x27;EOF&#x27;</span> &gt; <span class=\"string\">&quot;<span class=\"variable\">$PLAYBOOK_FILE</span>&quot;</span></span><br><span class=\"line\">---</span><br><span class=\"line\">- name: Generate SSH key on kube-node-1 and distribute to other nodes</span><br><span class=\"line\">  hosts: kubernetes_nodes</span><br><span class=\"line\">  become: <span class=\"built_in\">yes</span></span><br><span class=\"line\"></span><br><span class=\"line\">  tasks:</span><br><span class=\"line\">    - name: Generate SSH key on kube-node-1</span><br><span class=\"line\">      ansible.builtin.command:</span><br><span class=\"line\">        cmd: ssh-keygen -t rsa -b 4096 -N <span class=\"string\">&quot;&quot;</span> -f /root/.ssh/id_rsa</span><br><span class=\"line\">        creates: /root/.ssh/id_rsa</span><br><span class=\"line\">      when: inventory_hostname == <span class=\"string\">&#x27;kube-node-1&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    - name: Ensure .ssh directory exists on all nodes</span><br><span class=\"line\">      ansible.builtin.file:</span><br><span class=\"line\">        path: /root/.ssh</span><br><span class=\"line\">        state: directory</span><br><span class=\"line\">        mode: <span class=\"string\">&#x27;0700&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    - name: Ensure authorized_keys file exists</span><br><span class=\"line\">      ansible.builtin.file:</span><br><span class=\"line\">        path: /root/.ssh/authorized_keys</span><br><span class=\"line\">        state: <span class=\"built_in\">touch</span></span><br><span class=\"line\">        mode: <span class=\"string\">&#x27;0600&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    - name: Fetch public key from kube-node-1</span><br><span class=\"line\">      ansible.builtin.slurp:</span><br><span class=\"line\">        src: /root/.ssh/id_rsa.pub</span><br><span class=\"line\">      register: ssh_public_key</span><br><span class=\"line\">      when: inventory_hostname == <span class=\"string\">&#x27;kube-node-1&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    - name: Distribute public key to kube-node-2 and kube-node-3</span><br><span class=\"line\">      ansible.builtin.lineinfile:</span><br><span class=\"line\">        path: /root/.ssh/authorized_keys</span><br><span class=\"line\">        line: <span class=\"string\">&quot;&#123;&#123; hostvars[&#x27;kube-node-1&#x27;][&#x27;ssh_public_key&#x27;][&#x27;content&#x27;] | b64decode &#125;&#125;&quot;</span></span><br><span class=\"line\">        state: present</span><br><span class=\"line\">      when: inventory_hostname <span class=\"keyword\">in</span> [<span class=\"string\">&#x27;kube-node-2&#x27;</span>, <span class=\"string\">&#x27;kube-node-3&#x27;</span>]</span><br><span class=\"line\">EOF</span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Playbook file created.&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># --- Main Script Execution ---</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;Starting Ansible SSH key setup process...&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 1. Install Ansible if not present</span></span><br><span class=\"line\">install_ansible</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2. Create Ansible inventory file</span></span><br><span class=\"line\">create_inventory</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 3. Create Ansible playbook file</span></span><br><span class=\"line\">create_playbook</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;Setup complete. You can now run the Ansible playbook manually using:&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;ansible-playbook -i \\&quot;<span class=\"variable\">$INVENTORY_FILE</span>\\&quot; \\&quot;<span class=\"variable\">$PLAYBOOK_FILE</span>\\&quot; --ask-become-pass&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;You will be prompted for the &#x27;sudo&#x27; password for the &#x27;ubuntu&#x27; user on your VMs.&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;Process complete.&quot;</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">chmod</span> +x ansible_ssh.sh</span><br><span class=\"line\">./ansible_ssh.sh</span><br><span class=\"line\"></span><br><span class=\"line\">ois@ois:~/data/k8s$ ./ansible_ssh.sh</span><br><span class=\"line\">Starting Ansible SSH key setup process...</span><br><span class=\"line\">Ansible is already installed.</span><br><span class=\"line\">Creating Ansible inventory file: ansible_ssh_setup/hosts.ini</span><br><span class=\"line\">Inventory file created.</span><br><span class=\"line\">Creating Ansible playbook file: ansible_ssh_setup/setup_ssh.yml</span><br><span class=\"line\">Playbook file created.</span><br><span class=\"line\">Setup complete. You can now run the Ansible playbook manually using:</span><br><span class=\"line\">ansible-playbook -i <span class=\"string\">&quot;ansible_ssh_setup/hosts.ini&quot;</span> <span class=\"string\">&quot;ansible_ssh_setup/setup_ssh.yml&quot;</span> --ask-become-pass</span><br><span class=\"line\">You will be prompted <span class=\"keyword\">for</span> the <span class=\"string\">&#x27;sudo&#x27;</span> password <span class=\"keyword\">for</span> the <span class=\"string\">&#x27;ubuntu&#x27;</span> user on your VMs.</span><br><span class=\"line\">Process complete.</span><br><span class=\"line\">ois@ois:~/data/k8s$ <span class=\"built_in\">cd</span> ansible_ssh_setup/</span><br><span class=\"line\">ois@ois:~/data/k8s/ansible_ssh_setup$ ansible-playbook setup_ssh.yml -i hosts.ini -K</span><br><span class=\"line\">BECOME password: </span><br><span class=\"line\"></span><br><span class=\"line\">PLAY [Generate SSH key on kube-node-1 and distribute to other nodes] ********************************************************************************************************</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Gathering Facts] ******************************************************************************************************************************************************</span><br><span class=\"line\">ok: [kube-node-1]</span><br><span class=\"line\">ok: [kube-node-3]</span><br><span class=\"line\">ok: [kube-node-2]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Generate SSH key on kube-node-1] **************************************************************************************************************************************</span><br><span class=\"line\">skipping: [kube-node-2]</span><br><span class=\"line\">skipping: [kube-node-3]</span><br><span class=\"line\">changed: [kube-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Ensure .ssh directory exists on all nodes] ****************************************************************************************************************************</span><br><span class=\"line\">ok: [kube-node-2]</span><br><span class=\"line\">ok: [kube-node-1]</span><br><span class=\"line\">ok: [kube-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Ensure authorized_keys file exists] ***********************************************************************************************************************************</span><br><span class=\"line\">changed: [kube-node-1]</span><br><span class=\"line\">changed: [kube-node-2]</span><br><span class=\"line\">changed: [kube-node-3]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Fetch public key from kube-node-1] ************************************************************************************************************************************</span><br><span class=\"line\">skipping: [kube-node-2]</span><br><span class=\"line\">skipping: [kube-node-3]</span><br><span class=\"line\">ok: [kube-node-1]</span><br><span class=\"line\"></span><br><span class=\"line\">TASK [Distribute public key to kube-node-2 and kube-node-3] *****************************************************************************************************************</span><br><span class=\"line\">skipping: [kube-node-1]</span><br><span class=\"line\">changed: [kube-node-3]</span><br><span class=\"line\">changed: [kube-node-2]</span><br><span class=\"line\"></span><br><span class=\"line\">PLAY RECAP ******************************************************************************************************************************************************************</span><br><span class=\"line\">kube-node-1                : ok=5    changed=2    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   </span><br><span class=\"line\">kube-node-2                : ok=4    changed=2    unreachable=0    failed=0    skipped=2    rescued=0    ignored=0   </span><br><span class=\"line\">kube-node-3                : ok=4    changed=2    unreachable=0    failed=0    skipped=2    rescued=0    ignored=0   </span><br></pre></td></tr></table></figure>\n\n<p>效果：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@kube-node-1:~# ssh root@10.75.59.72</span><br><span class=\"line\">Welcome to Ubuntu 24.04.2 LTS (GNU/Linux 6.8.0-63-generic x86_64)</span><br><span class=\"line\"></span><br><span class=\"line\"> * Documentation:  https://help.ubuntu.com</span><br><span class=\"line\"> * Management:     https://landscape.canonical.com</span><br><span class=\"line\"> * Support:        https://ubuntu.com/pro</span><br><span class=\"line\"></span><br><span class=\"line\"> System information as of Fri Aug  1 02:28:23 PM CST 2025</span><br><span class=\"line\"></span><br><span class=\"line\">  System load:  0.13               Processes:               188</span><br><span class=\"line\">  Usage of /:   30.2% of 18.33GB   Users logged <span class=\"keyword\">in</span>:         1</span><br><span class=\"line\">  Memory usage: 10%                IPv4 address <span class=\"keyword\">for</span> enp1s0: 10.75.59.72</span><br><span class=\"line\">  Swap usage:   0%</span><br><span class=\"line\"></span><br><span class=\"line\"> * Strictly confined Kubernetes makes edge and IoT secure. Learn how MicroK8s</span><br><span class=\"line\">   just raised the bar <span class=\"keyword\">for</span> easy, resilient and secure K8s cluster deployment.</span><br><span class=\"line\"></span><br><span class=\"line\">   https://ubuntu.com/engage/secure-kubernetes-at-the-edge</span><br><span class=\"line\"></span><br><span class=\"line\">Expanded Security Maintenance <span class=\"keyword\">for</span> Applications is not enabled.</span><br><span class=\"line\"></span><br><span class=\"line\">0 updates can be applied immediately.</span><br><span class=\"line\"></span><br><span class=\"line\">Enable ESM Apps to receive additional future security updates.</span><br><span class=\"line\">See https://ubuntu.com/esm or run: <span class=\"built_in\">sudo</span> pro status</span><br><span class=\"line\"></span><br><span class=\"line\">*** System restart required ***</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"6-2-自动化安装设置脚本\"><a href=\"#6-2-自动化安装设置脚本\" class=\"headerlink\" title=\"6.2 自动化安装设置脚本\"></a>6.2 自动化安装设置脚本</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#!/bin/bash</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ==============================================================================</span></span><br><span class=\"line\"><span class=\"comment\"># Idempotent Kubernetes and Cilium Setup Script</span></span><br><span class=\"line\"><span class=\"comment\">#</span></span><br><span class=\"line\"><span class=\"comment\"># This script can be run multiple times. It checks the current state</span></span><br><span class=\"line\"><span class=\"comment\"># at each step and only performs actions if necessary.</span></span><br><span class=\"line\"><span class=\"comment\"># It must be run as root on the primary control-plane node.</span></span><br><span class=\"line\"><span class=\"comment\"># ==============================================================================</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># --- Configuration ---</span></span><br><span class=\"line\">CONTROL_PLANE_ENDPOINT=<span class=\"string\">&quot;kube-node-1&quot;</span></span><br><span class=\"line\">CONTROL_PLANE_IP=<span class=\"string\">&quot;10.75.59.71&quot;</span></span><br><span class=\"line\">WORKER_NODES=(<span class=\"string\">&quot;10.75.59.72&quot;</span> <span class=\"string\">&quot;10.75.59.73&quot;</span>)</span><br><span class=\"line\">POD_CIDR=<span class=\"string\">&quot;172.16.0.0/20&quot;</span></span><br><span class=\"line\">SERVICE_CIDR=<span class=\"string\">&quot;172.16.32.0/20&quot;</span></span><br><span class=\"line\">BGP_PEER_IP=<span class=\"string\">&quot;10.75.59.76&quot;</span></span><br><span class=\"line\">LOCAL_ASN=65000</span><br><span class=\"line\">PEER_ASN=65000</span><br><span class=\"line\">CILIUM_VERSION=<span class=\"string\">&quot;1.17.6&quot;</span></span><br><span class=\"line\">HUBBLE_UI_VERSION=<span class=\"string\">&quot;1.3.6&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ==============================================================================</span></span><br><span class=\"line\"><span class=\"comment\"># Helper Function</span></span><br><span class=\"line\"><span class=\"comment\"># ==============================================================================</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">print_header</span></span>() &#123; <span class=\"built_in\">echo</span> -e <span class=\"string\">&quot;\\n### <span class=\"variable\">$1</span> ###&quot;</span>; &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ==============================================================================</span></span><br><span class=\"line\"><span class=\"comment\"># STEP 1: Initialize Kubernetes Control-Plane</span></span><br><span class=\"line\"><span class=\"comment\"># ==============================================================================</span></span><br><span class=\"line\">print_header <span class=\"string\">&quot;STEP 1: Initializing Kubernetes Control-Plane&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> kubectl get nodes &amp;&gt; /dev/null; <span class=\"keyword\">then</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">&quot;✅ Kubernetes cluster is already running. Skipping kubeadm init.&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">else</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">&quot;--&gt; Kubernetes cluster not found. Initializing...&quot;</span></span><br><span class=\"line\">  kubeadm config images pull</span><br><span class=\"line\">  kubeadm init \\</span><br><span class=\"line\">    --control-plane-endpoint=<span class=\"variable\">$&#123;CONTROL_PLANE_ENDPOINT&#125;</span> \\</span><br><span class=\"line\">    --pod-network-cidr=<span class=\"variable\">$&#123;POD_CIDR&#125;</span> \\</span><br><span class=\"line\">    --service-cidr=<span class=\"variable\">$&#123;SERVICE_CIDR&#125;</span> \\</span><br><span class=\"line\">    --skip-phases=addon/kube-proxy</span><br><span class=\"line\">  <span class=\"built_in\">mkdir</span> -p /root/.kube</span><br><span class=\"line\">  <span class=\"built_in\">cp</span> -i /etc/kubernetes/admin.conf /root/.kube/config</span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">&quot;✅ Control-Plane initialization complete.&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ==============================================================================</span></span><br><span class=\"line\"><span class=\"comment\"># STEP 2: Install or Upgrade Cilium CNI</span></span><br><span class=\"line\"><span class=\"comment\"># ==============================================================================</span></span><br><span class=\"line\">print_header <span class=\"string\">&quot;STEP 2: Installing or Upgrading Cilium CNI&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">helm repo add cilium https://helm.cilium.io/ &amp;&gt; /dev/null</span><br><span class=\"line\">helm repo add isovalent https://helm.isovalent.com/ &amp;&gt; /dev/null</span><br><span class=\"line\">helm repo update &gt; /dev/null</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">cat</span> &gt; cilium-values.yaml &lt;&lt;<span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">hubble:</span></span><br><span class=\"line\"><span class=\"string\">  enabled: true</span></span><br><span class=\"line\"><span class=\"string\">  relay:</span></span><br><span class=\"line\"><span class=\"string\">    enabled: true</span></span><br><span class=\"line\"><span class=\"string\">  ui:</span></span><br><span class=\"line\"><span class=\"string\">    enabled: false</span></span><br><span class=\"line\"><span class=\"string\">ipam:</span></span><br><span class=\"line\"><span class=\"string\">  mode: kubernetes</span></span><br><span class=\"line\"><span class=\"string\">ipv4NativeRoutingCIDR: $&#123;POD_CIDR&#125;</span></span><br><span class=\"line\"><span class=\"string\">k8s:</span></span><br><span class=\"line\"><span class=\"string\">  requireIPv4PodCIDR: true</span></span><br><span class=\"line\"><span class=\"string\">routingMode: native</span></span><br><span class=\"line\"><span class=\"string\">autoDirectNodeRoutes: true</span></span><br><span class=\"line\"><span class=\"string\">enableIPv4Masquerade: true</span></span><br><span class=\"line\"><span class=\"string\">bgpControlPlane:</span></span><br><span class=\"line\"><span class=\"string\">  enabled: true</span></span><br><span class=\"line\"><span class=\"string\">  announce:</span></span><br><span class=\"line\"><span class=\"string\">    podCIDR: true</span></span><br><span class=\"line\"><span class=\"string\">kubeProxyReplacement: true</span></span><br><span class=\"line\"><span class=\"string\">bpf:</span></span><br><span class=\"line\"><span class=\"string\">  masquerade: true</span></span><br><span class=\"line\"><span class=\"string\">  lb:</span></span><br><span class=\"line\"><span class=\"string\">    externalClusterIP: true</span></span><br><span class=\"line\"><span class=\"string\">    sock: true</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> helm status cilium -n kube-system &amp;&gt; /dev/null; <span class=\"keyword\">then</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">&quot;--&gt; Cilium is already installed. Upgrading to apply latest configuration...&quot;</span></span><br><span class=\"line\">  helm upgrade cilium isovalent/cilium --version <span class=\"variable\">$&#123;CILIUM_VERSION&#125;</span> --namespace kube-system --<span class=\"built_in\">set</span> k8sServiceHost=<span class=\"variable\">$&#123;CONTROL_PLANE_IP&#125;</span>,k8sServicePort=6443 -f cilium-values.yaml</span><br><span class=\"line\"><span class=\"keyword\">else</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">&quot;--&gt; Cilium not found. Installing...&quot;</span></span><br><span class=\"line\">  helm install cilium isovalent/cilium --version <span class=\"variable\">$&#123;CILIUM_VERSION&#125;</span> --namespace kube-system --<span class=\"built_in\">set</span> k8sServiceHost=<span class=\"variable\">$&#123;CONTROL_PLANE_IP&#125;</span>,k8sServicePort=6443 -f cilium-values.yaml</span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;--&gt; Waiting for Cilium pods to become ready...&quot;</span></span><br><span class=\"line\">kubectl -n kube-system <span class=\"built_in\">wait</span> --<span class=\"keyword\">for</span>=condition=Ready pod -l k8s-app=cilium --<span class=\"built_in\">timeout</span>=5m</span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;✅ Cilium is configured.&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ==============================================================================</span></span><br><span class=\"line\"><span class=\"comment\"># STEP 3: Join Worker Nodes to the Cluster</span></span><br><span class=\"line\"><span class=\"comment\"># ==============================================================================</span></span><br><span class=\"line\">print_header <span class=\"string\">&quot;STEP 3: Joining Worker Nodes&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">for</span> NODE_IP <span class=\"keyword\">in</span> <span class=\"string\">&quot;<span class=\"variable\">$&#123;WORKER_NODES[@]&#125;</span>&quot;</span>; <span class=\"keyword\">do</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> kubectl get nodes -o wide | grep -q <span class=\"string\">&quot;<span class=\"variable\">$NODE_IP</span>&quot;</span>; <span class=\"keyword\">then</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;✅ Node <span class=\"variable\">$&#123;NODE_IP&#125;</span> is already in the cluster. Skipping join.&quot;</span></span><br><span class=\"line\">  <span class=\"keyword\">else</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;--&gt; Node <span class=\"variable\">$&#123;NODE_IP&#125;</span> not found in cluster. Attempting to join...&quot;</span></span><br><span class=\"line\">    JOIN_COMMAND=$(kubeadm token create --print-join-command)</span><br><span class=\"line\">    ssh -o StrictHostKeyChecking=no root@<span class=\"variable\">$&#123;NODE_IP&#125;</span> <span class=\"string\">&quot;<span class=\"variable\">$&#123;JOIN_COMMAND&#125;</span>&quot;</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> [ $? -ne 0 ]; <span class=\"keyword\">then</span></span><br><span class=\"line\">      <span class=\"built_in\">echo</span> <span class=\"string\">&quot;❌ Failed to join node <span class=\"variable\">$&#123;NODE_IP&#125;</span>. Please check SSH connectivity and logs.&quot;</span> &gt;&amp;2</span><br><span class=\"line\">      <span class=\"built_in\">exit</span> 1</span><br><span class=\"line\">    <span class=\"keyword\">fi</span></span><br><span class=\"line\">    <span class=\"built_in\">echo</span> <span class=\"string\">&quot;✅ Node <span class=\"variable\">$&#123;NODE_IP&#125;</span> joined successfully.&quot;</span></span><br><span class=\"line\">  <span class=\"keyword\">fi</span></span><br><span class=\"line\"><span class=\"keyword\">done</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ==============================================================================</span></span><br><span class=\"line\"><span class=\"comment\"># STEP 4: Install Cilium CLI</span></span><br><span class=\"line\"><span class=\"comment\"># ==============================================================================</span></span><br><span class=\"line\">print_header <span class=\"string\">&quot;STEP 4: Installing Cilium CLI&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> <span class=\"built_in\">command</span> -v cilium &amp;&gt; /dev/null; <span class=\"keyword\">then</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">&quot;✅ Cilium CLI is already installed. Skipping.&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">else</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">&quot;--&gt; Installing Cilium CLI...&quot;</span></span><br><span class=\"line\">  curl -L --silent --remote-name-all https://github.com/isovalent/cilium-cli-releases/releases/latest/download/cilium-linux-amd64.tar.gz&#123;,.<span class=\"built_in\">sha256sum</span>&#125;</span><br><span class=\"line\">  <span class=\"built_in\">sha256sum</span> --check cilium-linux-amd64.tar.gz.sha256sum &gt; /dev/null</span><br><span class=\"line\">  tar xzvfC cilium-linux-amd64.tar.gz /usr/local/bin &gt; /dev/null</span><br><span class=\"line\">  <span class=\"built_in\">rm</span> cilium-linux-amd64.tar.gz cilium-linux-amd64.tar.gz.sha256sum</span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">&quot;✅ Cilium CLI installed.&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ==============================================================================</span></span><br><span class=\"line\"><span class=\"comment\"># STEP 5: Configure Cilium BGP Peering</span></span><br><span class=\"line\"><span class=\"comment\"># ==============================================================================</span></span><br><span class=\"line\">print_header <span class=\"string\">&quot;STEP 5: Configuring Cilium BGP Peering&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;--&gt; Applying BGP configuration. &#x27;unchanged&#x27; means it&#x27;s already correct.&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># CORRECTION: Using the correct schema with matchLabels.</span></span><br><span class=\"line\"><span class=\"built_in\">cat</span> &gt; cilium-bgp.yaml &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">---</span></span><br><span class=\"line\"><span class=\"string\">apiVersion: cilium.io/v2alpha1</span></span><br><span class=\"line\"><span class=\"string\">kind: CiliumBGPAdvertisement</span></span><br><span class=\"line\"><span class=\"string\">metadata:</span></span><br><span class=\"line\"><span class=\"string\">  name: bgp-advertisements</span></span><br><span class=\"line\"><span class=\"string\">  labels:</span></span><br><span class=\"line\"><span class=\"string\">    advertise: bgp</span></span><br><span class=\"line\"><span class=\"string\">spec:</span></span><br><span class=\"line\"><span class=\"string\">  advertisements:</span></span><br><span class=\"line\"><span class=\"string\">    - advertisementType: &quot;PodCIDR&quot;              # Only for Kubernetes or ClusterPool IPAM cluster-pool</span></span><br><span class=\"line\"><span class=\"string\">    - advertisementType: &quot;Service&quot;</span></span><br><span class=\"line\"><span class=\"string\">      service:</span></span><br><span class=\"line\"><span class=\"string\">        addresses:</span></span><br><span class=\"line\"><span class=\"string\">          - ClusterIP</span></span><br><span class=\"line\"><span class=\"string\">          - ExternalIP</span></span><br><span class=\"line\"><span class=\"string\">          #- LoadBalancerIP</span></span><br><span class=\"line\"><span class=\"string\">      selector:</span></span><br><span class=\"line\"><span class=\"string\">        matchExpressions:</span></span><br><span class=\"line\"><span class=\"string\">        - &#123;key: somekey, operator: NotIn, values: [&#x27;never-used-value&#x27;]&#125; </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">---</span></span><br><span class=\"line\"><span class=\"string\">apiVersion: cilium.io/v2alpha1</span></span><br><span class=\"line\"><span class=\"string\">kind: CiliumBGPPeerConfig</span></span><br><span class=\"line\"><span class=\"string\">metadata:</span></span><br><span class=\"line\"><span class=\"string\">  name: cilium-peer</span></span><br><span class=\"line\"><span class=\"string\">spec:</span></span><br><span class=\"line\"><span class=\"string\">  timers:</span></span><br><span class=\"line\"><span class=\"string\">    holdTimeSeconds: 30             #default 90s</span></span><br><span class=\"line\"><span class=\"string\">    keepAliveTimeSeconds: 10  #default 30s</span></span><br><span class=\"line\"><span class=\"string\">    connectRetryTimeSeconds: 40  #default 120s</span></span><br><span class=\"line\"><span class=\"string\">  gracefulRestart:</span></span><br><span class=\"line\"><span class=\"string\">    enabled: true</span></span><br><span class=\"line\"><span class=\"string\">    restartTimeSeconds: 120        #default 120s</span></span><br><span class=\"line\"><span class=\"string\">  #transport:</span></span><br><span class=\"line\"><span class=\"string\">  #  peerPort: 179</span></span><br><span class=\"line\"><span class=\"string\">  families:</span></span><br><span class=\"line\"><span class=\"string\">    - afi: ipv4</span></span><br><span class=\"line\"><span class=\"string\">      safi: unicast</span></span><br><span class=\"line\"><span class=\"string\">      advertisements:</span></span><br><span class=\"line\"><span class=\"string\">        matchLabels:</span></span><br><span class=\"line\"><span class=\"string\">          advertise: &quot;bgp&quot;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">---</span></span><br><span class=\"line\"><span class=\"string\">apiVersion: cilium.io/v2alpha1</span></span><br><span class=\"line\"><span class=\"string\">kind: CiliumBGPClusterConfig</span></span><br><span class=\"line\"><span class=\"string\">metadata:</span></span><br><span class=\"line\"><span class=\"string\">  name: cilium-bgp-default</span></span><br><span class=\"line\"><span class=\"string\">spec:</span></span><br><span class=\"line\"><span class=\"string\">  bgpInstances:</span></span><br><span class=\"line\"><span class=\"string\">  - name: &quot;instance-65000&quot;</span></span><br><span class=\"line\"><span class=\"string\">    localASN: $&#123;LOCAL_ASN&#125;</span></span><br><span class=\"line\"><span class=\"string\">    peers:</span></span><br><span class=\"line\"><span class=\"string\">    - name: &quot;FRR_BGP&quot;</span></span><br><span class=\"line\"><span class=\"string\">      peerASN: $&#123;PEER_ASN&#125;</span></span><br><span class=\"line\"><span class=\"string\">      peerAddress: $&#123;BGP_PEER_IP&#125;</span></span><br><span class=\"line\"><span class=\"string\">      peerConfigRef:</span></span><br><span class=\"line\"><span class=\"string\">        name: &quot;cilium-peer&quot;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Apply the configuration and check for errors</span></span><br><span class=\"line\">kubectl apply -f cilium-bgp.yaml</span><br><span class=\"line\"><span class=\"keyword\">if</span> [ $? -ne 0 ]; <span class=\"keyword\">then</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">&quot;❌ Failed to apply BGP configuration. Please check the errors above.&quot;</span> &gt;&amp;2</span><br><span class=\"line\">  <span class=\"built_in\">exit</span> 1</span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;✅ BGP configuration applied.&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ==============================================================================</span></span><br><span class=\"line\"><span class=\"comment\"># STEP 6: Install or Upgrade Hubble UI</span></span><br><span class=\"line\"><span class=\"comment\"># ==============================================================================</span></span><br><span class=\"line\">print_header <span class=\"string\">&quot;STEP 6: Installing or Upgrading Hubble UI&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">cat</span> &gt; hubble-ui-values.yaml &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">relay:</span></span><br><span class=\"line\"><span class=\"string\">  address: &quot;hubble-relay.kube-system.svc.cluster.local&quot;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> helm status hubble-ui -n kube-system &amp;&gt; /dev/null; <span class=\"keyword\">then</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">&quot;--&gt; Hubble UI is already installed. Upgrading...&quot;</span></span><br><span class=\"line\">  helm upgrade hubble-ui isovalent/hubble-ui --version <span class=\"variable\">$&#123;HUBBLE_UI_VERSION&#125;</span> --namespace kube-system --values hubble-ui-values.yaml --<span class=\"built_in\">wait</span></span><br><span class=\"line\"><span class=\"keyword\">else</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">&quot;--&gt; Hubble UI not found. Installing...&quot;</span></span><br><span class=\"line\">  helm install hubble-ui isovalent/hubble-ui --version <span class=\"variable\">$&#123;HUBBLE_UI_VERSION&#125;</span> --namespace kube-system --values hubble-ui-values.yaml --<span class=\"built_in\">wait</span></span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\"></span><br><span class=\"line\">SERVICE_TYPE=$(kubectl get service hubble-ui -n kube-system -o jsonpath=<span class=\"string\">&#x27;&#123;.spec.type&#125;&#x27;</span>)</span><br><span class=\"line\"><span class=\"keyword\">if</span> [ <span class=\"string\">&quot;<span class=\"variable\">$SERVICE_TYPE</span>&quot;</span> != <span class=\"string\">&quot;NodePort&quot;</span> ]; <span class=\"keyword\">then</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">&quot;--&gt; Patching Hubble UI service to NodePort...&quot;</span></span><br><span class=\"line\">  kubectl patch service hubble-ui -n kube-system -p <span class=\"string\">&#x27;&#123;&quot;spec&quot;: &#123;&quot;type&quot;: &quot;NodePort&quot;&#125;&#125;&#x27;</span></span><br><span class=\"line\"><span class=\"keyword\">else</span></span><br><span class=\"line\">  <span class=\"built_in\">echo</span> <span class=\"string\">&quot;--&gt; Hubble UI service is already of type NodePort.&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;✅ Hubble UI is configured.&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ==============================================================================</span></span><br><span class=\"line\"><span class=\"comment\"># STEP 7: Final Verification</span></span><br><span class=\"line\"><span class=\"comment\"># ==============================================================================</span></span><br><span class=\"line\">print_header <span class=\"string\">&quot;STEP 7: Final Verification&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;--&gt; Waiting for all nodes to be ready...&quot;</span></span><br><span class=\"line\">kubectl <span class=\"built_in\">wait</span> --<span class=\"keyword\">for</span>=condition=Ready node --all --<span class=\"built_in\">timeout</span>=5m</span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;--&gt; Checking Cilium status...&quot;</span></span><br><span class=\"line\">cilium status --<span class=\"built_in\">wait</span></span><br><span class=\"line\"></span><br><span class=\"line\">HUBBLE_UI_PORT=$(kubectl get service hubble-ui -n kube-system -o jsonpath=<span class=\"string\">&#x27;&#123;.spec.ports[0].nodePort&#125;&#x27;</span>)</span><br><span class=\"line\"><span class=\"built_in\">echo</span> -e <span class=\"string\">&quot;\\n----------------------------------------------------------------&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;🚀 Cluster setup is complete and verified!&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;Access Hubble UI at: http://<span class=\"variable\">$&#123;CONTROL_PLANE_IP&#125;</span>:<span class=\"variable\">$&#123;HUBBLE_UI_PORT&#125;</span>&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;----------------------------------------------------------------&quot;</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br><span class=\"line\">252</span><br><span class=\"line\">253</span><br><span class=\"line\">254</span><br><span class=\"line\">255</span><br><span class=\"line\">256</span><br><span class=\"line\">257</span><br><span class=\"line\">258</span><br><span class=\"line\">259</span><br><span class=\"line\">260</span><br><span class=\"line\">261</span><br><span class=\"line\">262</span><br><span class=\"line\">263</span><br><span class=\"line\">264</span><br><span class=\"line\">265</span><br><span class=\"line\">266</span><br><span class=\"line\">267</span><br><span class=\"line\">268</span><br><span class=\"line\">269</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@kube-node-1:~# ./k8s-cilium-setup.sh </span><br><span class=\"line\"><span class=\"comment\">### STEP 1: Initializing Kubernetes Control-Plane on kube-node-1... ###</span></span><br><span class=\"line\">--&gt; Pulling Kubernetes container images...</span><br><span class=\"line\">[config/images] Pulled registry.k8s.io/kube-apiserver:v1.33.3</span><br><span class=\"line\">[config/images] Pulled registry.k8s.io/kube-controller-manager:v1.33.3</span><br><span class=\"line\">[config/images] Pulled registry.k8s.io/kube-scheduler:v1.33.3</span><br><span class=\"line\">[config/images] Pulled registry.k8s.io/kube-proxy:v1.33.3</span><br><span class=\"line\">[config/images] Pulled registry.k8s.io/coredns/coredns:v1.12.0</span><br><span class=\"line\">[config/images] Pulled registry.k8s.io/pause:3.10</span><br><span class=\"line\">[config/images] Pulled registry.k8s.io/etcd:3.5.21-0</span><br><span class=\"line\">--&gt; Running kubeadm init...</span><br><span class=\"line\">[init] Using Kubernetes version: v1.33.3</span><br><span class=\"line\">[preflight] Running pre-flight checks</span><br><span class=\"line\">[preflight] Pulling images required <span class=\"keyword\">for</span> setting up a Kubernetes cluster</span><br><span class=\"line\">[preflight] This might take a minute or two, depending on the speed of your internet connection</span><br><span class=\"line\">[preflight] You can also perform this action beforehand using <span class=\"string\">&#x27;kubeadm config images pull&#x27;</span></span><br><span class=\"line\">[certs] Using certificateDir folder <span class=\"string\">&quot;/etc/kubernetes/pki&quot;</span></span><br><span class=\"line\">[certs] Generating <span class=\"string\">&quot;ca&quot;</span> certificate and key</span><br><span class=\"line\">[certs] Generating <span class=\"string\">&quot;apiserver&quot;</span> certificate and key</span><br><span class=\"line\">[certs] apiserver serving cert is signed <span class=\"keyword\">for</span> DNS names [kube-node-1 kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local] and IPs [172.16.32.1 10.75.59.71]</span><br><span class=\"line\">[certs] Generating <span class=\"string\">&quot;apiserver-kubelet-client&quot;</span> certificate and key</span><br><span class=\"line\">[certs] Generating <span class=\"string\">&quot;front-proxy-ca&quot;</span> certificate and key</span><br><span class=\"line\">[certs] Generating <span class=\"string\">&quot;front-proxy-client&quot;</span> certificate and key</span><br><span class=\"line\">[certs] Generating <span class=\"string\">&quot;etcd/ca&quot;</span> certificate and key</span><br><span class=\"line\">[certs] Generating <span class=\"string\">&quot;etcd/server&quot;</span> certificate and key</span><br><span class=\"line\">[certs] etcd/server serving cert is signed <span class=\"keyword\">for</span> DNS names [kube-node-1 localhost] and IPs [10.75.59.71 127.0.0.1 ::1]</span><br><span class=\"line\">[certs] Generating <span class=\"string\">&quot;etcd/peer&quot;</span> certificate and key</span><br><span class=\"line\">[certs] etcd/peer serving cert is signed <span class=\"keyword\">for</span> DNS names [kube-node-1 localhost] and IPs [10.75.59.71 127.0.0.1 ::1]</span><br><span class=\"line\">[certs] Generating <span class=\"string\">&quot;etcd/healthcheck-client&quot;</span> certificate and key</span><br><span class=\"line\">[certs] Generating <span class=\"string\">&quot;apiserver-etcd-client&quot;</span> certificate and key</span><br><span class=\"line\">[certs] Generating <span class=\"string\">&quot;sa&quot;</span> key and public key</span><br><span class=\"line\">[kubeconfig] Using kubeconfig folder <span class=\"string\">&quot;/etc/kubernetes&quot;</span></span><br><span class=\"line\">[kubeconfig] Writing <span class=\"string\">&quot;admin.conf&quot;</span> kubeconfig file</span><br><span class=\"line\">[kubeconfig] Writing <span class=\"string\">&quot;super-admin.conf&quot;</span> kubeconfig file</span><br><span class=\"line\">[kubeconfig] Writing <span class=\"string\">&quot;kubelet.conf&quot;</span> kubeconfig file</span><br><span class=\"line\">[kubeconfig] Writing <span class=\"string\">&quot;controller-manager.conf&quot;</span> kubeconfig file</span><br><span class=\"line\">[kubeconfig] Writing <span class=\"string\">&quot;scheduler.conf&quot;</span> kubeconfig file</span><br><span class=\"line\">[etcd] Creating static Pod manifest <span class=\"keyword\">for</span> <span class=\"built_in\">local</span> etcd <span class=\"keyword\">in</span> <span class=\"string\">&quot;/etc/kubernetes/manifests&quot;</span></span><br><span class=\"line\">[control-plane] Using manifest folder <span class=\"string\">&quot;/etc/kubernetes/manifests&quot;</span></span><br><span class=\"line\">[control-plane] Creating static Pod manifest <span class=\"keyword\">for</span> <span class=\"string\">&quot;kube-apiserver&quot;</span></span><br><span class=\"line\">[control-plane] Creating static Pod manifest <span class=\"keyword\">for</span> <span class=\"string\">&quot;kube-controller-manager&quot;</span></span><br><span class=\"line\">[control-plane] Creating static Pod manifest <span class=\"keyword\">for</span> <span class=\"string\">&quot;kube-scheduler&quot;</span></span><br><span class=\"line\">[kubelet-start] Writing kubelet environment file with flags to file <span class=\"string\">&quot;/var/lib/kubelet/kubeadm-flags.env&quot;</span></span><br><span class=\"line\">[kubelet-start] Writing kubelet configuration to file <span class=\"string\">&quot;/var/lib/kubelet/config.yaml&quot;</span></span><br><span class=\"line\">[kubelet-start] Starting the kubelet</span><br><span class=\"line\">[wait-control-plane] Waiting <span class=\"keyword\">for</span> the kubelet to boot up the control plane as static Pods from directory <span class=\"string\">&quot;/etc/kubernetes/manifests&quot;</span></span><br><span class=\"line\">[kubelet-check] Waiting <span class=\"keyword\">for</span> a healthy kubelet at http://127.0.0.1:10248/healthz. This can take up to 4m0s</span><br><span class=\"line\">[kubelet-check] The kubelet is healthy after 1.001873284s</span><br><span class=\"line\">[control-plane-check] Waiting <span class=\"keyword\">for</span> healthy control plane components. This can take up to 4m0s</span><br><span class=\"line\">[control-plane-check] Checking kube-apiserver at https://10.75.59.71:6443/livez</span><br><span class=\"line\">[control-plane-check] Checking kube-controller-manager at https://127.0.0.1:10257/healthz</span><br><span class=\"line\">[control-plane-check] Checking kube-scheduler at https://127.0.0.1:10259/livez</span><br><span class=\"line\">[control-plane-check] kube-controller-manager is healthy after 2.272937689s</span><br><span class=\"line\">[control-plane-check] kube-scheduler is healthy after 3.04977489s</span><br><span class=\"line\">[control-plane-check] kube-apiserver is healthy after 5.003048769s</span><br><span class=\"line\">[upload-config] Storing the configuration used <span class=\"keyword\">in</span> ConfigMap <span class=\"string\">&quot;kubeadm-config&quot;</span> <span class=\"keyword\">in</span> the <span class=\"string\">&quot;kube-system&quot;</span> Namespace</span><br><span class=\"line\">[kubelet] Creating a ConfigMap <span class=\"string\">&quot;kubelet-config&quot;</span> <span class=\"keyword\">in</span> namespace kube-system with the configuration <span class=\"keyword\">for</span> the kubelets <span class=\"keyword\">in</span> the cluster</span><br><span class=\"line\">[upload-certs] Skipping phase. Please see --upload-certs</span><br><span class=\"line\">[mark-control-plane] Marking the node kube-node-1 as control-plane by adding the labels: [node-role.kubernetes.io/control-plane node.kubernetes.io/exclude-from-external-load-balancers]</span><br><span class=\"line\">[mark-control-plane] Marking the node kube-node-1 as control-plane by adding the taints [node-role.kubernetes.io/control-plane:NoSchedule]</span><br><span class=\"line\">[bootstrap-token] Using token: 0q5m6l.5pc7hz15orcc0b6b</span><br><span class=\"line\">[bootstrap-token] Configuring bootstrap tokens, cluster-info ConfigMap, RBAC Roles</span><br><span class=\"line\">[bootstrap-token] Configured RBAC rules to allow Node Bootstrap tokens to get nodes</span><br><span class=\"line\">[bootstrap-token] Configured RBAC rules to allow Node Bootstrap tokens to post CSRs <span class=\"keyword\">in</span> order <span class=\"keyword\">for</span> nodes to get long term certificate credentials</span><br><span class=\"line\">[bootstrap-token] Configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token</span><br><span class=\"line\">[bootstrap-token] Configured RBAC rules to allow certificate rotation <span class=\"keyword\">for</span> all node client certificates <span class=\"keyword\">in</span> the cluster</span><br><span class=\"line\">[bootstrap-token] Creating the <span class=\"string\">&quot;cluster-info&quot;</span> ConfigMap <span class=\"keyword\">in</span> the <span class=\"string\">&quot;kube-public&quot;</span> namespace</span><br><span class=\"line\">[kubelet-finalize] Updating <span class=\"string\">&quot;/etc/kubernetes/kubelet.conf&quot;</span> to point to a rotatable kubelet client certificate and key</span><br><span class=\"line\">[addons] Applied essential addon: CoreDNS</span><br><span class=\"line\"></span><br><span class=\"line\">Your Kubernetes control-plane has initialized successfully!</span><br><span class=\"line\"></span><br><span class=\"line\">To start using your cluster, you need to run the following as a regular user:</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"built_in\">mkdir</span> -p <span class=\"variable\">$HOME</span>/.kube</span><br><span class=\"line\">  <span class=\"built_in\">sudo</span> <span class=\"built_in\">cp</span> -i /etc/kubernetes/admin.conf <span class=\"variable\">$HOME</span>/.kube/config</span><br><span class=\"line\">  <span class=\"built_in\">sudo</span> <span class=\"built_in\">chown</span> $(<span class=\"built_in\">id</span> -u):$(<span class=\"built_in\">id</span> -g) <span class=\"variable\">$HOME</span>/.kube/config</span><br><span class=\"line\"></span><br><span class=\"line\">Alternatively, <span class=\"keyword\">if</span> you are the root user, you can run:</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"built_in\">export</span> KUBECONFIG=/etc/kubernetes/admin.conf</span><br><span class=\"line\"></span><br><span class=\"line\">You should now deploy a pod network to the cluster.</span><br><span class=\"line\">Run <span class=\"string\">&quot;kubectl apply -f [podnetwork].yaml&quot;</span> with one of the options listed at:</span><br><span class=\"line\">  https://kubernetes.io/docs/concepts/cluster-administration/addons/</span><br><span class=\"line\"></span><br><span class=\"line\">You can now <span class=\"built_in\">join</span> any number of control-plane nodes by copying certificate authorities</span><br><span class=\"line\">and service account keys on each node and <span class=\"keyword\">then</span> running the following as root:</span><br><span class=\"line\"></span><br><span class=\"line\">  kubeadm <span class=\"built_in\">join</span> kube-node-1:6443 --token 0q5m6l.5pc7hz15orcc0b6b \\</span><br><span class=\"line\">        --discovery-token-ca-cert-hash sha256:4795595e8237c54f1bf20c7fb56feea9a1960af5802c08c410733d54b5e317a6 \\</span><br><span class=\"line\">        --control-plane </span><br><span class=\"line\"></span><br><span class=\"line\">Then you can <span class=\"built_in\">join</span> any number of worker nodes by running the following on each as root:</span><br><span class=\"line\"></span><br><span class=\"line\">kubeadm <span class=\"built_in\">join</span> kube-node-1:6443 --token 0q5m6l.5pc7hz15orcc0b6b \\</span><br><span class=\"line\">        --discovery-token-ca-cert-hash sha256:4795595e8237c54f1bf20c7fb56feea9a1960af5802c08c410733d54b5e317a6 </span><br><span class=\"line\">--&gt; Configuring kubectl...</span><br><span class=\"line\">✅ Control-Plane initialization complete.</span><br><span class=\"line\"><span class=\"comment\">### STEP 2: Installing Cilium... ###</span></span><br><span class=\"line\">--&gt; Adding Helm repositories...</span><br><span class=\"line\"><span class=\"string\">&quot;cilium&quot;</span> has been added to your repositories</span><br><span class=\"line\"><span class=\"string\">&quot;isovalent&quot;</span> has been added to your repositories</span><br><span class=\"line\">Hang tight <span class=\"keyword\">while</span> we grab the latest from your chart repositories...</span><br><span class=\"line\">...Successfully got an update from the <span class=\"string\">&quot;cilium&quot;</span> chart repository</span><br><span class=\"line\">...Successfully got an update from the <span class=\"string\">&quot;isovalent&quot;</span> chart repository</span><br><span class=\"line\">Update Complete. ⎈Happy Helming!⎈</span><br><span class=\"line\">--&gt; Creating cilium-enterprise-values.yaml...</span><br><span class=\"line\">--&gt; Installing Cilium with Helm...</span><br><span class=\"line\">NAME: cilium</span><br><span class=\"line\">LAST DEPLOYED: Fri Aug  1 14:16:16 2025</span><br><span class=\"line\">NAMESPACE: kube-system</span><br><span class=\"line\">STATUS: deployed</span><br><span class=\"line\">REVISION: 1</span><br><span class=\"line\">TEST SUITE: None</span><br><span class=\"line\">NOTES:</span><br><span class=\"line\">You have successfully installed Cilium with Hubble Relay.</span><br><span class=\"line\"></span><br><span class=\"line\">Your release version is 1.17.6.</span><br><span class=\"line\"></span><br><span class=\"line\">For any further <span class=\"built_in\">help</span>, visit https://docs.isovalent.com/v1.17</span><br><span class=\"line\">--&gt; Waiting <span class=\"keyword\">for</span> Cilium pods to become ready...</span><br><span class=\"line\">pod/cilium-5ngcm condition met</span><br><span class=\"line\">✅ Cilium installation complete.</span><br><span class=\"line\"><span class=\"comment\">### STEP 3: Joining Worker Nodes... ###</span></span><br><span class=\"line\">--&gt; Generated <span class=\"built_in\">join</span> <span class=\"built_in\">command</span>: kubeadm <span class=\"built_in\">join</span> kube-node-1:6443 --token whltm8.4zs5af6hiht167da --discovery-token-ca-cert-hash sha256:4795595e8237c54f1bf20c7fb56feea9a1960af5802c08c410733d54b5e317a6 </span><br><span class=\"line\">--&gt; Joining node 10.75.59.72 to the cluster...</span><br><span class=\"line\">[preflight] Running pre-flight checks</span><br><span class=\"line\">[preflight] Reading configuration from the <span class=\"string\">&quot;kubeadm-config&quot;</span> ConfigMap <span class=\"keyword\">in</span> namespace <span class=\"string\">&quot;kube-system&quot;</span>...</span><br><span class=\"line\">[preflight] Use <span class=\"string\">&#x27;kubeadm init phase upload-config --config your-config-file&#x27;</span> to re-upload it.</span><br><span class=\"line\">W0801 14:18:01.674767   20870 configset.go:78] Warning: No kubeproxy.config.k8s.io/v1alpha1 config is loaded. Continuing without it: configmaps <span class=\"string\">&quot;kube-proxy&quot;</span> is forbidden: User <span class=\"string\">&quot;system:bootstrap:whltm8&quot;</span> cannot get resource <span class=\"string\">&quot;configmaps&quot;</span> <span class=\"keyword\">in</span> API group <span class=\"string\">&quot;&quot;</span> <span class=\"keyword\">in</span> the namespace <span class=\"string\">&quot;kube-system&quot;</span></span><br><span class=\"line\">[kubelet-start] Writing kubelet configuration to file <span class=\"string\">&quot;/var/lib/kubelet/config.yaml&quot;</span></span><br><span class=\"line\">[kubelet-start] Writing kubelet environment file with flags to file <span class=\"string\">&quot;/var/lib/kubelet/kubeadm-flags.env&quot;</span></span><br><span class=\"line\">[kubelet-start] Starting the kubelet</span><br><span class=\"line\">[kubelet-check] Waiting <span class=\"keyword\">for</span> a healthy kubelet at http://127.0.0.1:10248/healthz. This can take up to 4m0s</span><br><span class=\"line\">[kubelet-check] The kubelet is healthy after 1.501212696s</span><br><span class=\"line\">[kubelet-start] Waiting <span class=\"keyword\">for</span> the kubelet to perform the TLS Bootstrap</span><br><span class=\"line\"></span><br><span class=\"line\">This node has joined the cluster:</span><br><span class=\"line\">* Certificate signing request was sent to apiserver and a response was received.</span><br><span class=\"line\">* The Kubelet was informed of the new secure connection details.</span><br><span class=\"line\"></span><br><span class=\"line\">Run <span class=\"string\">&#x27;kubectl get nodes&#x27;</span> on the control-plane to see this node <span class=\"built_in\">join</span> the cluster.</span><br><span class=\"line\"></span><br><span class=\"line\">✅ Node 10.75.59.72 joined successfully.</span><br><span class=\"line\">--&gt; Joining node 10.75.59.73 to the cluster...</span><br><span class=\"line\">[preflight] Running pre-flight checks</span><br><span class=\"line\">[preflight] Reading configuration from the <span class=\"string\">&quot;kubeadm-config&quot;</span> ConfigMap <span class=\"keyword\">in</span> namespace <span class=\"string\">&quot;kube-system&quot;</span>...</span><br><span class=\"line\">[preflight] Use <span class=\"string\">&#x27;kubeadm init phase upload-config --config your-config-file&#x27;</span> to re-upload it.</span><br><span class=\"line\">W0801 14:18:07.347008   20684 configset.go:78] Warning: No kubeproxy.config.k8s.io/v1alpha1 config is loaded. Continuing without it: configmaps <span class=\"string\">&quot;kube-proxy&quot;</span> is forbidden: User <span class=\"string\">&quot;system:bootstrap:whltm8&quot;</span> cannot get resource <span class=\"string\">&quot;configmaps&quot;</span> <span class=\"keyword\">in</span> API group <span class=\"string\">&quot;&quot;</span> <span class=\"keyword\">in</span> the namespace <span class=\"string\">&quot;kube-system&quot;</span></span><br><span class=\"line\">[kubelet-start] Writing kubelet configuration to file <span class=\"string\">&quot;/var/lib/kubelet/config.yaml&quot;</span></span><br><span class=\"line\">[kubelet-start] Writing kubelet environment file with flags to file <span class=\"string\">&quot;/var/lib/kubelet/kubeadm-flags.env&quot;</span></span><br><span class=\"line\">[kubelet-start] Starting the kubelet</span><br><span class=\"line\">[kubelet-check] Waiting <span class=\"keyword\">for</span> a healthy kubelet at http://127.0.0.1:10248/healthz. This can take up to 4m0s</span><br><span class=\"line\">[kubelet-check] The kubelet is healthy after 1.002187345s</span><br><span class=\"line\">[kubelet-start] Waiting <span class=\"keyword\">for</span> the kubelet to perform the TLS Bootstrap</span><br><span class=\"line\"></span><br><span class=\"line\">This node has joined the cluster:</span><br><span class=\"line\">* Certificate signing request was sent to apiserver and a response was received.</span><br><span class=\"line\">* The Kubelet was informed of the new secure connection details.</span><br><span class=\"line\"></span><br><span class=\"line\">Run <span class=\"string\">&#x27;kubectl get nodes&#x27;</span> on the control-plane to see this node <span class=\"built_in\">join</span> the cluster.</span><br><span class=\"line\"></span><br><span class=\"line\">✅ Node 10.75.59.73 joined successfully.</span><br><span class=\"line\"><span class=\"comment\">### STEP 4: Installing the Cilium CLI... ###</span></span><br><span class=\"line\">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span><br><span class=\"line\">                                 Dload  Upload   Total   Spent    Left  Speed</span><br><span class=\"line\">  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0</span><br><span class=\"line\">  0     0    0     0    0     0      0      0 --:--:--  0:00:01 --:--:--     0</span><br><span class=\"line\">100 59.2M  100 59.2M    0     0  13.1M      0  0:00:04  0:00:04 --:--:-- 23.8M</span><br><span class=\"line\">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span><br><span class=\"line\">                                 Dload  Upload   Total   Spent    Left  Speed</span><br><span class=\"line\">  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0</span><br><span class=\"line\">  0     0    0     0    0     0      0      0 --:--:--  0:00:01 --:--:--     0</span><br><span class=\"line\">100    92  100    92    0     0     70      0  0:00:01  0:00:01 --:--:--    70</span><br><span class=\"line\">cilium-linux-amd64.tar.gz: OK</span><br><span class=\"line\">cilium</span><br><span class=\"line\">✅ Cilium CLI installed.</span><br><span class=\"line\"><span class=\"comment\">### STEP 5: Configuring Cilium BGP Peering ###</span></span><br><span class=\"line\">--&gt; Applying BGP configuration. <span class=\"string\">&#x27;unchanged&#x27;</span> means it<span class=\"string\">&#x27;s already correct.</span></span><br><span class=\"line\"><span class=\"string\">ciliumbgpadvertisement.cilium.io/bgp-advertisements unchanged</span></span><br><span class=\"line\"><span class=\"string\">ciliumbgppeerconfig.cilium.io/cilium-peer unchanged</span></span><br><span class=\"line\"><span class=\"string\">ciliumbgpclusterconfig.cilium.io/cilium-bgp-default configured</span></span><br><span class=\"line\"><span class=\"string\">✅ BGP configuration applied.</span></span><br><span class=\"line\"><span class=\"string\">### STEP 6: Installing Hubble UI... ###</span></span><br><span class=\"line\"><span class=\"string\">--&gt; Creating hubble-ui-values.yaml...</span></span><br><span class=\"line\"><span class=\"string\">--&gt; Installing Hubble UI with Helm...</span></span><br><span class=\"line\"><span class=\"string\">NAME: hubble-ui</span></span><br><span class=\"line\"><span class=\"string\">LAST DEPLOYED: Fri Aug  1 14:18:18 2025</span></span><br><span class=\"line\"><span class=\"string\">NAMESPACE: kube-system</span></span><br><span class=\"line\"><span class=\"string\">STATUS: deployed</span></span><br><span class=\"line\"><span class=\"string\">REVISION: 1</span></span><br><span class=\"line\"><span class=\"string\">TEST SUITE: None</span></span><br><span class=\"line\"><span class=\"string\">NOTES:</span></span><br><span class=\"line\"><span class=\"string\">You have successfully installed Hubble-Ui.</span></span><br><span class=\"line\"><span class=\"string\">Your release version is 1.3.6.</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">For any further help, visit https://docs.isovalent.com</span></span><br><span class=\"line\"><span class=\"string\">--&gt; Exposing Hubble UI service via NodePort...</span></span><br><span class=\"line\"><span class=\"string\">service/hubble-ui patched</span></span><br><span class=\"line\"><span class=\"string\">✅ Hubble UI installed.</span></span><br><span class=\"line\"><span class=\"string\">### STEP 7: Verifying the Setup... ###</span></span><br><span class=\"line\"><span class=\"string\">--&gt; Waiting for all nodes to be ready...</span></span><br><span class=\"line\"><span class=\"string\">node/kube-node-1 condition met</span></span><br><span class=\"line\"><span class=\"string\">node/kube-node-2 condition met</span></span><br><span class=\"line\"><span class=\"string\">node/kube-node-3 condition met</span></span><br><span class=\"line\"><span class=\"string\">--&gt; Checking Cilium status...</span></span><br><span class=\"line\"><span class=\"string\">    /¯¯\\</span></span><br><span class=\"line\"><span class=\"string\"> /¯¯\\__/¯¯\\    Cilium:             OK</span></span><br><span class=\"line\"><span class=\"string\"> \\__/¯¯\\__/    Operator:           OK</span></span><br><span class=\"line\"><span class=\"string\"> /¯¯\\__/¯¯\\    Envoy DaemonSet:    OK</span></span><br><span class=\"line\"><span class=\"string\"> \\__/¯¯\\__/    Hubble Relay:       OK</span></span><br><span class=\"line\"><span class=\"string\">    \\__/       ClusterMesh:        disabled</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">DaemonSet              cilium                   Desired: 3, Ready: 3/3, Available: 3/3</span></span><br><span class=\"line\"><span class=\"string\">DaemonSet              cilium-envoy             Desired: 3, Ready: 3/3, Available: 3/3</span></span><br><span class=\"line\"><span class=\"string\">Deployment             cilium-operator          Desired: 2, Ready: 2/2, Available: 2/2</span></span><br><span class=\"line\"><span class=\"string\">Deployment             hubble-relay             Desired: 1, Ready: 1/1, Available: 1/1</span></span><br><span class=\"line\"><span class=\"string\">Deployment             hubble-ui                Desired: 1, Ready: 1/1, Available: 1/1</span></span><br><span class=\"line\"><span class=\"string\">Containers:            cilium                   Running: 3</span></span><br><span class=\"line\"><span class=\"string\">                       cilium-envoy             Running: 3</span></span><br><span class=\"line\"><span class=\"string\">                       cilium-operator          Running: 2</span></span><br><span class=\"line\"><span class=\"string\">                       clustermesh-apiserver    </span></span><br><span class=\"line\"><span class=\"string\">                       hubble-relay             Running: 1</span></span><br><span class=\"line\"><span class=\"string\">                       hubble-ui                Running: 1</span></span><br><span class=\"line\"><span class=\"string\">Cluster Pods:          8/8 managed by Cilium</span></span><br><span class=\"line\"><span class=\"string\">Helm chart version:    1.17.6</span></span><br><span class=\"line\"><span class=\"string\">Image versions         cilium             quay.io/isovalent/cilium:v1.17.6-cee.1@sha256:2d01daf4f25f7d644889b49ca856e1a4269981fc963e50bd3962665b41b6adb3: 3</span></span><br><span class=\"line\"><span class=\"string\">                       cilium-envoy       quay.io/isovalent/cilium-envoy:v1.17.6-cee.1@sha256:318eff387835ca2717baab42a84f35a83a5f9e7d519253df87269f80b9ff0171: 3</span></span><br><span class=\"line\"><span class=\"string\">                       cilium-operator    quay.io/isovalent/operator-generic:v1.17.6-cee.1@sha256:2e602710a7c4f101831df679e5d8251bae8bf0f9fe26c20bbef87f1966ea8265: 2</span></span><br><span class=\"line\"><span class=\"string\">                       hubble-relay       quay.io/isovalent/hubble-relay:v1.17.6-cee.1@sha256:d378e3607f7492374e65e2bd854cc0ec87480c63ba49a96dadcd75a6946b586e: 1</span></span><br><span class=\"line\"><span class=\"string\">                       hubble-ui          quay.io/isovalent/hubble-ui-enterprise-backend:v1.3.6: 1</span></span><br><span class=\"line\"><span class=\"string\">                       hubble-ui          quay.io/isovalent/hubble-ui-enterprise:v1.3.6: 1</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">----------------------------------------------------------------</span></span><br><span class=\"line\"><span class=\"string\">🚀 Cluster setup is complete and verified!</span></span><br><span class=\"line\"><span class=\"string\">Access Hubble UI at: http://10.75.59.71:30583</span></span><br><span class=\"line\"><span class=\"string\">----------------------------------------------------------------</span></span><br><span class=\"line\"><span class=\"string\">root@kube-node-1:~# cilium bgp peers</span></span><br><span class=\"line\"><span class=\"string\">Node          Local AS   Peer AS   Peer Address   Session State   Uptime   Family         Received   Advertised</span></span><br><span class=\"line\"><span class=\"string\">kube-node-1   65000      65000     10.75.59.76    established     19m1s    ipv4/unicast   2          8    </span></span><br><span class=\"line\"><span class=\"string\">kube-node-2   65000      65000     10.75.59.76    established     19m2s    ipv4/unicast   2          8    </span></span><br><span class=\"line\"><span class=\"string\">kube-node-3   65000      65000     10.75.59.76    established     19m2s    ipv4/unicast   2          8    </span></span><br><span class=\"line\"><span class=\"string\">root@kube-node-1:~# cilium bgp routes</span></span><br><span class=\"line\"><span class=\"string\">(Defaulting to `available ipv4 unicast` routes, please see help for more options)</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">Node          VRouter   Prefix             NextHop   Age     Attrs</span></span><br><span class=\"line\"><span class=\"string\">kube-node-1   65000     172.16.0.0/24      0.0.0.0   19m8s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span></span><br><span class=\"line\"><span class=\"string\">              65000     172.16.32.1/32     0.0.0.0   19m8s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span></span><br><span class=\"line\"><span class=\"string\">              65000     172.16.32.10/32    0.0.0.0   19m8s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span></span><br><span class=\"line\"><span class=\"string\">              65000     172.16.36.130/32   0.0.0.0   19m8s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span></span><br><span class=\"line\"><span class=\"string\">              65000     172.16.40.165/32   0.0.0.0   19m8s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span></span><br><span class=\"line\"><span class=\"string\">              65000     172.16.43.51/32    0.0.0.0   19m8s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span></span><br><span class=\"line\"><span class=\"string\">              65000     172.16.47.30/32    0.0.0.0   19m8s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span></span><br><span class=\"line\"><span class=\"string\">kube-node-2   65000     172.16.1.0/24      0.0.0.0   19m8s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span></span><br><span class=\"line\"><span class=\"string\">              65000     172.16.32.1/32     0.0.0.0   19m8s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span></span><br><span class=\"line\"><span class=\"string\">              65000     172.16.32.10/32    0.0.0.0   19m8s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span></span><br><span class=\"line\"><span class=\"string\">              65000     172.16.36.130/32   0.0.0.0   19m8s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span></span><br><span class=\"line\"><span class=\"string\">              65000     172.16.40.165/32   0.0.0.0   19m8s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span></span><br><span class=\"line\"><span class=\"string\">              65000     172.16.43.51/32    0.0.0.0   19m8s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span></span><br><span class=\"line\"><span class=\"string\">              65000     172.16.47.30/32    0.0.0.0   19m8s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span></span><br><span class=\"line\"><span class=\"string\">kube-node-3   65000     172.16.2.0/24      0.0.0.0   19m8s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span></span><br><span class=\"line\"><span class=\"string\">              65000     172.16.32.1/32     0.0.0.0   19m8s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span></span><br><span class=\"line\"><span class=\"string\">              65000     172.16.32.10/32    0.0.0.0   19m8s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span></span><br><span class=\"line\"><span class=\"string\">              65000     172.16.36.130/32   0.0.0.0   19m8s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span></span><br><span class=\"line\"><span class=\"string\">              65000     172.16.40.165/32   0.0.0.0   19m8s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span></span><br><span class=\"line\"><span class=\"string\">              65000     172.16.43.51/32    0.0.0.0   19m8s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span></span><br><span class=\"line\"><span class=\"string\">              65000     172.16.47.30/32    0.0.0.0   19m8s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span></span><br><span class=\"line\"><span class=\"string\">root@kube-node-1:~# </span></span><br></pre></td></tr></table></figure>\n<h1 id=\"7-Kubectl-常用命令\"><a href=\"#7-Kubectl-常用命令\" class=\"headerlink\" title=\"7. Kubectl 常用命令\"></a>7. Kubectl 常用命令</h1><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl describe pod hubble-ui-5fdd8b4495-dv7nr -n kube-system</span><br><span class=\"line\"></span><br><span class=\"line\">kubectl get nodes -o wide</span><br><span class=\"line\">kubectl get pods -n kube-system -o wide</span><br><span class=\"line\">kubectl get pods --all-namespaces</span><br><span class=\"line\">kubectl get service -n kube-system -o wide</span><br><span class=\"line\">kubectl get daemonset -n kube-system cilium</span><br><span class=\"line\">kubectl get deployment -o wide</span><br><span class=\"line\"></span><br><span class=\"line\">kubectl get endpoints -n kube-system kube-dns</span><br><span class=\"line\">kubectl get cm cilium-config -n kube-system -o yaml</span><br><span class=\"line\">kubectl get endpoints -n kube-system</span><br><span class=\"line\">kubectl get pods -n kube-system -l k8s-app=cilium -o wide</span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">kubectl describe pod hubble-relay-cfb755899-r42l8</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">kubectl -n kube-system get pods -l k8s-app=cilium</span><br><span class=\"line\">kubectl -n kube-system exec ds/cilium -- cilium-dbg bpf ipmasq list</span><br><span class=\"line\">kubectl -n kube-system exec ds/cilium -- cilium-dbg status --verbose</span><br><span class=\"line\">kubectl -n kube-system exec ds/cilium -- cilium status</span><br><span class=\"line\">kubectl -n kube-system exec ds/cilium -- cilium service list</span><br><span class=\"line\">kubectl -n kube-system exec ds/cilium -- cilium bpf nat list</span><br><span class=\"line\">kubectl exec -n kube-system cilium-2vrgj -- cilium bpf nat list</span><br><span class=\"line\"></span><br><span class=\"line\">kubectl -n kube-system get configmap cilium-config -o yaml</span><br><span class=\"line\"></span><br><span class=\"line\">kubectl create namespace star-wars</span><br><span class=\"line\">kubectl apply -n star-wars -f https://raw.githubusercontent.com/cilium/cilium/HEAD/examples/minikube/http-sw-app.yaml</span><br><span class=\"line\">kubectl -n star-wars get pod -o wide --show-labels</span><br><span class=\"line\">kubectl -n star-wars patch service deathstar -p &#x27;&#123;&quot;spec&quot;:&#123;&quot;type&quot;:&quot;NodePort&quot;&#125;&#125;&#x27;</span><br><span class=\"line\">kubectl -n star-wars exec tiefighter --   curl -s -XPOST http://deathstar.star-wars.svc.cluster.local/v1/request-landing</span><br><span class=\"line\">kubectl -n star-wars exec xwing --   curl -s -XPOST http://deathstar.star-wars.svc.cluster.local/v1/request-landing</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">kubectl delete -n star-wars -f https://raw.githubusercontent.com/cilium/cilium/1.18.0/examples/minikube/http-sw-app.yaml</span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">Commands <span class=\"keyword\">for</span> reference only.</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">kubectl delete pod,svc,daemonset -n kube-system -l k8s-app=cilium</span><br><span class=\"line\">kubectl delete daemonset -n kube-system kube-proxy</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">kubectl create deployment nginx --image=nginx</span><br><span class=\"line\">kubectl expose deployment nginx --port=80 --type=ClusterIP</span><br><span class=\"line\"></span><br><span class=\"line\">kubectl run -it --rm busybox --image=busybox --restart=Never -- sh</span><br><span class=\"line\"></span><br><span class=\"line\">kubectl run -it --rm curl --image=curlimages/curl --restart=Never -- sh</span><br><span class=\"line\"></span><br><span class=\"line\">for i in &#123;1..10&#125;; do   kubectl exec -n star-wars tiefighter --     curl -s http://deathstar.default.svc.cluster.local/v1 |     jq -r &#x27;.hostname&#x27;; done</span><br></pre></td></tr></table></figure>"},{"title":"Cisco CSR 1000v & Catalyst 8000v KVM SRIOV安装设置演示","date":"2021-02-08T02:36:08.000Z","description":"本视频演示在 Ubuntu 20.0 版本上安装 KVM，并安装和设置 CSR 1000v/Catalyst 8000v 的指南，内容包括 SRIOV，KVM 调优以及 CSR1KV 初始化配置等内容。","_content":"\n\n{% raw %}\n\n<div style=\"position: relative; width: 100%; height: 0; padding-bottom: 75%;\">\n    <iframe src=\"//player.bilibili.com/player.html?aid=501530216&bvid=BV1VN411R75t&cid=294248612&page=1\" scrolling=\"no\" border=\"0\" frameborder=\"no\" framespacing=\"0\" allowfullscreen=\"true\" style=\"position: absolute; width: 100%; height: 100%; left: 0; top: 0;\">\n    </iframe>\n</div>\n\n{% endraw %}\n\n鸣谢：[Johnny Rong](https://rongtianjie.github.io/) [Hexo博客中添加B站视频播放器](https://rongtianjie.github.io/2019/03/15/2019-03-15-HEXO%E4%B8%AD%E6%B7%BB%E5%8A%A0B%E7%AB%99%E8%A7%86%E9%A2%91%E6%92%AD%E6%94%BE%E5%99%A8/) ","source":"_posts/csr1kv-kvm-sriov-ubuntu-demo.md","raw":"---\ntitle: Cisco CSR 1000v & Catalyst 8000v KVM SRIOV安装设置演示\ndate: 2021-02-08 10:36:08\ntags:\n - sriov\n - csr1000v\n - ztp\ndescription: 本视频演示在 Ubuntu 20.0 版本上安装 KVM，并安装和设置 CSR 1000v/Catalyst 8000v 的指南，内容包括 SRIOV，KVM 调优以及 CSR1KV 初始化配置等内容。\n---\n\n\n{% raw %}\n\n<div style=\"position: relative; width: 100%; height: 0; padding-bottom: 75%;\">\n    <iframe src=\"//player.bilibili.com/player.html?aid=501530216&bvid=BV1VN411R75t&cid=294248612&page=1\" scrolling=\"no\" border=\"0\" frameborder=\"no\" framespacing=\"0\" allowfullscreen=\"true\" style=\"position: absolute; width: 100%; height: 100%; left: 0; top: 0;\">\n    </iframe>\n</div>\n\n{% endraw %}\n\n鸣谢：[Johnny Rong](https://rongtianjie.github.io/) [Hexo博客中添加B站视频播放器](https://rongtianjie.github.io/2019/03/15/2019-03-15-HEXO%E4%B8%AD%E6%B7%BB%E5%8A%A0B%E7%AB%99%E8%A7%86%E9%A2%91%E6%92%AD%E6%94%BE%E5%99%A8/) ","slug":"csr1kv-kvm-sriov-ubuntu-demo","published":1,"updated":"2025-12-14T09:50:07.448Z","comments":1,"layout":"post","photos":[],"_id":"cuidvZ2R6C5lWECwhyVL4oFAS","content":"\n\n<div style=\"position: relative; width: 100%; height: 0; padding-bottom: 75%;\">\n    <iframe src=\"//player.bilibili.com/player.html?aid=501530216&bvid=BV1VN411R75t&cid=294248612&page=1\" scrolling=\"no\" border=\"0\" frameborder=\"no\" framespacing=\"0\" allowfullscreen=\"true\" style=\"position: absolute; width: 100%; height: 100%; left: 0; top: 0;\">\n    </iframe>\n</div>\n\n\n\n<p>鸣谢：<a href=\"https://rongtianjie.github.io/\">Johnny Rong</a> <a href=\"https://rongtianjie.github.io/2019/03/15/2019-03-15-HEXO%E4%B8%AD%E6%B7%BB%E5%8A%A0B%E7%AB%99%E8%A7%86%E9%A2%91%E6%92%AD%E6%94%BE%E5%99%A8/\">Hexo博客中添加B站视频播放器</a> </p>\n","length":65,"excerpt":"","more":"\n\n<div style=\"position: relative; width: 100%; height: 0; padding-bottom: 75%;\">\n    <iframe src=\"//player.bilibili.com/player.html?aid=501530216&bvid=BV1VN411R75t&cid=294248612&page=1\" scrolling=\"no\" border=\"0\" frameborder=\"no\" framespacing=\"0\" allowfullscreen=\"true\" style=\"position: absolute; width: 100%; height: 100%; left: 0; top: 0;\">\n    </iframe>\n</div>\n\n\n\n<p>鸣谢：<a href=\"https://rongtianjie.github.io/\">Johnny Rong</a> <a href=\"https://rongtianjie.github.io/2019/03/15/2019-03-15-HEXO%E4%B8%AD%E6%B7%BB%E5%8A%A0B%E7%AB%99%E8%A7%86%E9%A2%91%E6%92%AD%E6%94%BE%E5%99%A8/\">Hexo博客中添加B站视频播放器</a> </p>\n"},{"title":"在AWS上部署TE Agent并进行测试","date":"2021-06-17T13:00:00.000Z","_content":"\n# ThousandEyes 简介\n\n[ThousandEyes](https://www.thousandeyes.com/)是一个网络性能监控的SAAS云服务，结合了各种主动和被动的监控技术，让您深入了解您提供的以及您消费的应用和服务的用户体验。ThousandEyes使用的监控技术包括网络的可达性探测、时延、丢包、抖动、可视化的逐跳路径分析、可视化的BGP路由分析、DNS监控、HTTP服务监控等。ThousandEyes平台对这些监控收集而来的数据进行分析、交叉关联，将涉及用户体验的方方面面，包括网络和应用的状况统一的呈现在同一个界面之下，让您能够轻松的隔离问题，采取行动，从而快速的解决问题。\n\nThousandEyes提供了三种Agent进行网络和应用的探测，分别是Cloud Agent、Enterprise Agent和Endpoint Agent。Cloud Agent 由ThousandEyes在全球部署和维护，当前，ThousandEyes在全球200多个城市共部署了400多个[Cloud Agent](https://www.thousandeyes.com/product/cloud-agents)，可供全球用户使用。Enterprise Agent由用户自己部署，可以部署为虚拟机或者容器，可以安装在物理硬件，如Intel NCU或者树莓派中，支持Windows、Linux系统，还可以部署在思科或Juniper的网络设备中，也能通过CloudFormation在AWS云中自动部署。Endpoint Agent是浏览器插件，用户在访问网站时，可以自助的使用Endpoint Agent进行测试，由ThousandEyes进行数据分析，从而帮助用户快速了解其数字体验，以及快速定位问题所在。用户可以根据自己的需要来选择一种或多种Agent进行探测，ThousandEyes平台会自动完成分析和展现，提供网络和应用状况的洞见分析。\n\n<!-- more -->\n\n# 在AWS上部署TE Agent\n\n## 了解部署过程\n\n在正式部署之前，快速阅读了一下[AWS Deployment Guide](https://docs.thousandeyes.com/product-documentation/global-vantage-points/enterprise-agents/installing/iaas-enterprise-agent-deployment-amazon-aws)，部署过程是通过AWS的CloudFormation创建一个Stack，整个过程全部自动化。\n\n部署的前提是需要设置好SSH Key-pair，VPC网络、公共子网、以及使用CloudFormation部署EC2的权限。\n\n部署的内容包括：启动基于Ubuntu的EC2实例，并自动安装TE Agent，创建Security Group，并基于最小权限配置Inbound Rules。\n\n## 准备SSH Key-pair\n\n首先，在MAC电脑中，执行以下命令，用于创建一个RSA的秘钥对，并将公钥拷贝至桌面。\n\n```bash\nssh-keygen -t rsa -b 4096 -f .ssh/aws_kp -m PEM\nmv .ssh/aws_kp .ssh/aws_kp.pem\nchmod 400 .ssh/aws_kp.pem\ncp .ssh/aws_kp.pub ~/Desktop\n```\n\n登录AWS的Console管理界面后，选择Region，比如us-east-1，定位到EC2—Network Security—Key Pair，在界面右上侧的Actions下拉框中，选择Import key pair，将aws_kp.pub上传。\n\n在其他的Region，重复上述动作，将key pair上传，这样在多个Region创建的EC2可以使用同一个私钥进行登录。\n\n## 在AWS上部署TE Agent\n\n部署TE Agent的操作路径为：在ThousandEyes的界面中，选择Cloud & Enterprise Agents，再选择Agent Settings，进一步选择Enterprise Agents，点击Add New Enterprise Agent。在右侧出现的界面中，选择IaaS Marketplaces，在该界面中点击Launch in AWS，跳转到AWS的登录界面，并自动进入CloudFormation的界面，该界面已将Stack模板选择好了。\n\nStack模板的链接：\n\n[https://s3-us-west-1.amazonaws.com/oneclick-ea.aws.thousandeyes/aws-ea-oneclick.yaml](https://s3-us-west-1.amazonaws.com/oneclick-ea.aws.thousandeyes/aws-ea-oneclick.yaml)\n\n该模板包含两个组件：EC2 Instance 和 Security Group。\n\n按照上文的部署指南填写表单，并点击下一步，直至完成部署。\n\n在完成安装后，可以使用私钥登录到虚机，注意：用户名为 ubuntu，不是ec2-user 或 root。\n\n```bash\nssh -i .ssh/aws_kp.pem -v [ubuntu@](mailto:ubuntu@18.141.230.240)x.x.x.x\n```\n\n在两个不同的Region，us-east-1 和 ap-southeast-1 分别部署一个TE Agent。\n\n大约5分钟后，即可在app.thousandeyes.com的界面中看到两个TE Agent上线。\n\n# 执行Agent to Agent 测试\n\n分别执行两种测试，一个是通过公网IP进行双向测试，一个是创建VPC Peering后，使用私有地址进行测试，比较两者之间的差异。\n\n## 通过公网IP地址进行双向测试\n\n在ThousandEyes的Agent Settings界面中，点击Agent，在右侧的网页中，选择Advanced Settings，将地址设置为Agent的公网IP地址。\n\n在Test Settings中，选择Add New Test，Layer选择Network，Test Type选择Agent to Agent。\n\n选择一个Agent作为Target，另一个Agent作为源，测试方向选择双向。\n\n经过一段时间后，ThousandEyes上即可呈现测试结果。\n\n测试持续了一个小时左右，测试结果如下：\n\n**AWS us-east-1 to ap-southeast-1 Using Public IP**\n\n| Items        | Result      |\n| ------------ | ----------- |\n| Loss         | 0%          |\n| Latency      | 212ms       |\n| Jitter       | <1ms        |\n| Throughput   | 55Mbps      |\n\n在可视化的路径分析图中，观察到如下信息：\n\n1. 从us-east-1到ap-southeast-1往返，至少各有三条路径，每条路径显示的跳数约有20跳。\n2. 该测试每隔2分钟测试一次，共测试了25次。在这25次中，鲜有路径一致的，有时候全程没有公共节点，有时候两条、甚至三条路径中间有公共节点。\n3. 可视化路径中，从两侧的Agent出发，均有连续的5个或6个连续未知节点。这是由于这些节点不对Traceroute作出回应，导致路径中不可见。\n4. 在整个可视化路径中，可见的公网节点的IP地址属于**AS 16509**或者**AS 14618**，这两个都是AWS的BGP AS域。其他节点的地址为100.65.x.x或100.100.x.x，这段地址属于**100.64.0.0/10**，为IANA保留地址，用于给运营商使用。由此可以推断，两个Agent之间通讯的报文并未离开过AWS的网络，这也解释了为何上述的时延、抖动是很稳定的值，并且整个测试期间，没有丢包。\n5. 在可视化路径中，我还能发现有的路径是一段MPLS 隧道，并给出了转发时用到的Label值。ThousandEyes是如何发现路径中间有MPLS Tunnel呢？这个是值得仔细思考的问题。经查询，这是通过ThousandEyes的[专利技术Deep Path Analysis (DPA)](https://www.thousandeyes.com/pdf/ThousandEyes-Patents.pdf)实现的。\n\n## 通过私网IP地址进行双向测试\n\n本次测试的方法同上，只是需要将Agent的IP地址修改为使用私有IP地址，两个Region的VPC之间建立VPC Peering。\n\n测试结果如下：\n\n**AWS us-east-1 to ap-southeast-1 Using Private IP**\n\n| Items      | Result |\n| ---------- | ------ |\n| Loss       | 0%     |\n| Latency    | 212ms  |\n| Jitter     | <1ms   |\n| Throughput | 56Mbps |\n\n在可视化的路径分析图中，观察到如下信息：\n\n- 两个Agent之间是直连的，没有任何中间节点，两者之间时延为211ms。\n\n做完两次测试，第二天检查了一下AWS的账单，预计花费了0.29美金。\n\n## 测试结果的共享链接\n\n[https://zwskwtsea.share.thousandeyes.com/](https://zwskwtsea.share.thousandeyes.com/)\n\n[https://aieajezsh.share.thousandeyes.com/](https://aieajezsh.share.thousandeyes.com/)","source":"_posts/deploy-thousandeyes-agent-on-aws.md","raw":"---\ntitle: 在AWS上部署TE Agent并进行测试\ndate: 2021-06-17 21:00:00\ntags: \n    - ThousandEyes\n    - AWS\n---\n\n# ThousandEyes 简介\n\n[ThousandEyes](https://www.thousandeyes.com/)是一个网络性能监控的SAAS云服务，结合了各种主动和被动的监控技术，让您深入了解您提供的以及您消费的应用和服务的用户体验。ThousandEyes使用的监控技术包括网络的可达性探测、时延、丢包、抖动、可视化的逐跳路径分析、可视化的BGP路由分析、DNS监控、HTTP服务监控等。ThousandEyes平台对这些监控收集而来的数据进行分析、交叉关联，将涉及用户体验的方方面面，包括网络和应用的状况统一的呈现在同一个界面之下，让您能够轻松的隔离问题，采取行动，从而快速的解决问题。\n\nThousandEyes提供了三种Agent进行网络和应用的探测，分别是Cloud Agent、Enterprise Agent和Endpoint Agent。Cloud Agent 由ThousandEyes在全球部署和维护，当前，ThousandEyes在全球200多个城市共部署了400多个[Cloud Agent](https://www.thousandeyes.com/product/cloud-agents)，可供全球用户使用。Enterprise Agent由用户自己部署，可以部署为虚拟机或者容器，可以安装在物理硬件，如Intel NCU或者树莓派中，支持Windows、Linux系统，还可以部署在思科或Juniper的网络设备中，也能通过CloudFormation在AWS云中自动部署。Endpoint Agent是浏览器插件，用户在访问网站时，可以自助的使用Endpoint Agent进行测试，由ThousandEyes进行数据分析，从而帮助用户快速了解其数字体验，以及快速定位问题所在。用户可以根据自己的需要来选择一种或多种Agent进行探测，ThousandEyes平台会自动完成分析和展现，提供网络和应用状况的洞见分析。\n\n<!-- more -->\n\n# 在AWS上部署TE Agent\n\n## 了解部署过程\n\n在正式部署之前，快速阅读了一下[AWS Deployment Guide](https://docs.thousandeyes.com/product-documentation/global-vantage-points/enterprise-agents/installing/iaas-enterprise-agent-deployment-amazon-aws)，部署过程是通过AWS的CloudFormation创建一个Stack，整个过程全部自动化。\n\n部署的前提是需要设置好SSH Key-pair，VPC网络、公共子网、以及使用CloudFormation部署EC2的权限。\n\n部署的内容包括：启动基于Ubuntu的EC2实例，并自动安装TE Agent，创建Security Group，并基于最小权限配置Inbound Rules。\n\n## 准备SSH Key-pair\n\n首先，在MAC电脑中，执行以下命令，用于创建一个RSA的秘钥对，并将公钥拷贝至桌面。\n\n```bash\nssh-keygen -t rsa -b 4096 -f .ssh/aws_kp -m PEM\nmv .ssh/aws_kp .ssh/aws_kp.pem\nchmod 400 .ssh/aws_kp.pem\ncp .ssh/aws_kp.pub ~/Desktop\n```\n\n登录AWS的Console管理界面后，选择Region，比如us-east-1，定位到EC2—Network Security—Key Pair，在界面右上侧的Actions下拉框中，选择Import key pair，将aws_kp.pub上传。\n\n在其他的Region，重复上述动作，将key pair上传，这样在多个Region创建的EC2可以使用同一个私钥进行登录。\n\n## 在AWS上部署TE Agent\n\n部署TE Agent的操作路径为：在ThousandEyes的界面中，选择Cloud & Enterprise Agents，再选择Agent Settings，进一步选择Enterprise Agents，点击Add New Enterprise Agent。在右侧出现的界面中，选择IaaS Marketplaces，在该界面中点击Launch in AWS，跳转到AWS的登录界面，并自动进入CloudFormation的界面，该界面已将Stack模板选择好了。\n\nStack模板的链接：\n\n[https://s3-us-west-1.amazonaws.com/oneclick-ea.aws.thousandeyes/aws-ea-oneclick.yaml](https://s3-us-west-1.amazonaws.com/oneclick-ea.aws.thousandeyes/aws-ea-oneclick.yaml)\n\n该模板包含两个组件：EC2 Instance 和 Security Group。\n\n按照上文的部署指南填写表单，并点击下一步，直至完成部署。\n\n在完成安装后，可以使用私钥登录到虚机，注意：用户名为 ubuntu，不是ec2-user 或 root。\n\n```bash\nssh -i .ssh/aws_kp.pem -v [ubuntu@](mailto:ubuntu@18.141.230.240)x.x.x.x\n```\n\n在两个不同的Region，us-east-1 和 ap-southeast-1 分别部署一个TE Agent。\n\n大约5分钟后，即可在app.thousandeyes.com的界面中看到两个TE Agent上线。\n\n# 执行Agent to Agent 测试\n\n分别执行两种测试，一个是通过公网IP进行双向测试，一个是创建VPC Peering后，使用私有地址进行测试，比较两者之间的差异。\n\n## 通过公网IP地址进行双向测试\n\n在ThousandEyes的Agent Settings界面中，点击Agent，在右侧的网页中，选择Advanced Settings，将地址设置为Agent的公网IP地址。\n\n在Test Settings中，选择Add New Test，Layer选择Network，Test Type选择Agent to Agent。\n\n选择一个Agent作为Target，另一个Agent作为源，测试方向选择双向。\n\n经过一段时间后，ThousandEyes上即可呈现测试结果。\n\n测试持续了一个小时左右，测试结果如下：\n\n**AWS us-east-1 to ap-southeast-1 Using Public IP**\n\n| Items        | Result      |\n| ------------ | ----------- |\n| Loss         | 0%          |\n| Latency      | 212ms       |\n| Jitter       | <1ms        |\n| Throughput   | 55Mbps      |\n\n在可视化的路径分析图中，观察到如下信息：\n\n1. 从us-east-1到ap-southeast-1往返，至少各有三条路径，每条路径显示的跳数约有20跳。\n2. 该测试每隔2分钟测试一次，共测试了25次。在这25次中，鲜有路径一致的，有时候全程没有公共节点，有时候两条、甚至三条路径中间有公共节点。\n3. 可视化路径中，从两侧的Agent出发，均有连续的5个或6个连续未知节点。这是由于这些节点不对Traceroute作出回应，导致路径中不可见。\n4. 在整个可视化路径中，可见的公网节点的IP地址属于**AS 16509**或者**AS 14618**，这两个都是AWS的BGP AS域。其他节点的地址为100.65.x.x或100.100.x.x，这段地址属于**100.64.0.0/10**，为IANA保留地址，用于给运营商使用。由此可以推断，两个Agent之间通讯的报文并未离开过AWS的网络，这也解释了为何上述的时延、抖动是很稳定的值，并且整个测试期间，没有丢包。\n5. 在可视化路径中，我还能发现有的路径是一段MPLS 隧道，并给出了转发时用到的Label值。ThousandEyes是如何发现路径中间有MPLS Tunnel呢？这个是值得仔细思考的问题。经查询，这是通过ThousandEyes的[专利技术Deep Path Analysis (DPA)](https://www.thousandeyes.com/pdf/ThousandEyes-Patents.pdf)实现的。\n\n## 通过私网IP地址进行双向测试\n\n本次测试的方法同上，只是需要将Agent的IP地址修改为使用私有IP地址，两个Region的VPC之间建立VPC Peering。\n\n测试结果如下：\n\n**AWS us-east-1 to ap-southeast-1 Using Private IP**\n\n| Items      | Result |\n| ---------- | ------ |\n| Loss       | 0%     |\n| Latency    | 212ms  |\n| Jitter     | <1ms   |\n| Throughput | 56Mbps |\n\n在可视化的路径分析图中，观察到如下信息：\n\n- 两个Agent之间是直连的，没有任何中间节点，两者之间时延为211ms。\n\n做完两次测试，第二天检查了一下AWS的账单，预计花费了0.29美金。\n\n## 测试结果的共享链接\n\n[https://zwskwtsea.share.thousandeyes.com/](https://zwskwtsea.share.thousandeyes.com/)\n\n[https://aieajezsh.share.thousandeyes.com/](https://aieajezsh.share.thousandeyes.com/)","slug":"deploy-thousandeyes-agent-on-aws","published":1,"updated":"2025-12-14T09:50:07.448Z","comments":1,"layout":"post","photos":[],"_id":"cuidalk9exSsOGPnRMK_pTACa","content":"<h1 id=\"ThousandEyes-简介\"><a href=\"#ThousandEyes-简介\" class=\"headerlink\" title=\"ThousandEyes 简介\"></a>ThousandEyes 简介</h1><p><a href=\"https://www.thousandeyes.com/\">ThousandEyes</a>是一个网络性能监控的SAAS云服务，结合了各种主动和被动的监控技术，让您深入了解您提供的以及您消费的应用和服务的用户体验。ThousandEyes使用的监控技术包括网络的可达性探测、时延、丢包、抖动、可视化的逐跳路径分析、可视化的BGP路由分析、DNS监控、HTTP服务监控等。ThousandEyes平台对这些监控收集而来的数据进行分析、交叉关联，将涉及用户体验的方方面面，包括网络和应用的状况统一的呈现在同一个界面之下，让您能够轻松的隔离问题，采取行动，从而快速的解决问题。</p>\n<p>ThousandEyes提供了三种Agent进行网络和应用的探测，分别是Cloud Agent、Enterprise Agent和Endpoint Agent。Cloud Agent 由ThousandEyes在全球部署和维护，当前，ThousandEyes在全球200多个城市共部署了400多个<a href=\"https://www.thousandeyes.com/product/cloud-agents\">Cloud Agent</a>，可供全球用户使用。Enterprise Agent由用户自己部署，可以部署为虚拟机或者容器，可以安装在物理硬件，如Intel NCU或者树莓派中，支持Windows、Linux系统，还可以部署在思科或Juniper的网络设备中，也能通过CloudFormation在AWS云中自动部署。Endpoint Agent是浏览器插件，用户在访问网站时，可以自助的使用Endpoint Agent进行测试，由ThousandEyes进行数据分析，从而帮助用户快速了解其数字体验，以及快速定位问题所在。用户可以根据自己的需要来选择一种或多种Agent进行探测，ThousandEyes平台会自动完成分析和展现，提供网络和应用状况的洞见分析。</p>\n<span id=\"more\"></span>\n\n<h1 id=\"在AWS上部署TE-Agent\"><a href=\"#在AWS上部署TE-Agent\" class=\"headerlink\" title=\"在AWS上部署TE Agent\"></a>在AWS上部署TE Agent</h1><h2 id=\"了解部署过程\"><a href=\"#了解部署过程\" class=\"headerlink\" title=\"了解部署过程\"></a>了解部署过程</h2><p>在正式部署之前，快速阅读了一下<a href=\"https://docs.thousandeyes.com/product-documentation/global-vantage-points/enterprise-agents/installing/iaas-enterprise-agent-deployment-amazon-aws\">AWS Deployment Guide</a>，部署过程是通过AWS的CloudFormation创建一个Stack，整个过程全部自动化。</p>\n<p>部署的前提是需要设置好SSH Key-pair，VPC网络、公共子网、以及使用CloudFormation部署EC2的权限。</p>\n<p>部署的内容包括：启动基于Ubuntu的EC2实例，并自动安装TE Agent，创建Security Group，并基于最小权限配置Inbound Rules。</p>\n<h2 id=\"准备SSH-Key-pair\"><a href=\"#准备SSH-Key-pair\" class=\"headerlink\" title=\"准备SSH Key-pair\"></a>准备SSH Key-pair</h2><p>首先，在MAC电脑中，执行以下命令，用于创建一个RSA的秘钥对，并将公钥拷贝至桌面。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ssh-keygen -t rsa -b 4096 -f .ssh/aws_kp -m PEM</span><br><span class=\"line\"><span class=\"built_in\">mv</span> .ssh/aws_kp .ssh/aws_kp.pem</span><br><span class=\"line\"><span class=\"built_in\">chmod</span> 400 .ssh/aws_kp.pem</span><br><span class=\"line\"><span class=\"built_in\">cp</span> .ssh/aws_kp.pub ~/Desktop</span><br></pre></td></tr></table></figure>\n\n<p>登录AWS的Console管理界面后，选择Region，比如us-east-1，定位到EC2—Network Security—Key Pair，在界面右上侧的Actions下拉框中，选择Import key pair，将aws_kp.pub上传。</p>\n<p>在其他的Region，重复上述动作，将key pair上传，这样在多个Region创建的EC2可以使用同一个私钥进行登录。</p>\n<h2 id=\"在AWS上部署TE-Agent-1\"><a href=\"#在AWS上部署TE-Agent-1\" class=\"headerlink\" title=\"在AWS上部署TE Agent\"></a>在AWS上部署TE Agent</h2><p>部署TE Agent的操作路径为：在ThousandEyes的界面中，选择Cloud &amp; Enterprise Agents，再选择Agent Settings，进一步选择Enterprise Agents，点击Add New Enterprise Agent。在右侧出现的界面中，选择IaaS Marketplaces，在该界面中点击Launch in AWS，跳转到AWS的登录界面，并自动进入CloudFormation的界面，该界面已将Stack模板选择好了。</p>\n<p>Stack模板的链接：</p>\n<p><a href=\"https://s3-us-west-1.amazonaws.com/oneclick-ea.aws.thousandeyes/aws-ea-oneclick.yaml\">https://s3-us-west-1.amazonaws.com/oneclick-ea.aws.thousandeyes/aws-ea-oneclick.yaml</a></p>\n<p>该模板包含两个组件：EC2 Instance 和 Security Group。</p>\n<p>按照上文的部署指南填写表单，并点击下一步，直至完成部署。</p>\n<p>在完成安装后，可以使用私钥登录到虚机，注意：用户名为 ubuntu，不是ec2-user 或 root。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ssh -i .ssh/aws_kp.pem -v [ubuntu@](mailto:ubuntu@18.141.230.240)x.x.x.x</span><br></pre></td></tr></table></figure>\n\n<p>在两个不同的Region，us-east-1 和 ap-southeast-1 分别部署一个TE Agent。</p>\n<p>大约5分钟后，即可在app.thousandeyes.com的界面中看到两个TE Agent上线。</p>\n<h1 id=\"执行Agent-to-Agent-测试\"><a href=\"#执行Agent-to-Agent-测试\" class=\"headerlink\" title=\"执行Agent to Agent 测试\"></a>执行Agent to Agent 测试</h1><p>分别执行两种测试，一个是通过公网IP进行双向测试，一个是创建VPC Peering后，使用私有地址进行测试，比较两者之间的差异。</p>\n<h2 id=\"通过公网IP地址进行双向测试\"><a href=\"#通过公网IP地址进行双向测试\" class=\"headerlink\" title=\"通过公网IP地址进行双向测试\"></a>通过公网IP地址进行双向测试</h2><p>在ThousandEyes的Agent Settings界面中，点击Agent，在右侧的网页中，选择Advanced Settings，将地址设置为Agent的公网IP地址。</p>\n<p>在Test Settings中，选择Add New Test，Layer选择Network，Test Type选择Agent to Agent。</p>\n<p>选择一个Agent作为Target，另一个Agent作为源，测试方向选择双向。</p>\n<p>经过一段时间后，ThousandEyes上即可呈现测试结果。</p>\n<p>测试持续了一个小时左右，测试结果如下：</p>\n<p><strong>AWS us-east-1 to ap-southeast-1 Using Public IP</strong></p>\n<table>\n<thead>\n<tr>\n<th>Items</th>\n<th>Result</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Loss</td>\n<td>0%</td>\n</tr>\n<tr>\n<td>Latency</td>\n<td>212ms</td>\n</tr>\n<tr>\n<td>Jitter</td>\n<td>&lt;1ms</td>\n</tr>\n<tr>\n<td>Throughput</td>\n<td>55Mbps</td>\n</tr>\n</tbody></table>\n<p>在可视化的路径分析图中，观察到如下信息：</p>\n<ol>\n<li>从us-east-1到ap-southeast-1往返，至少各有三条路径，每条路径显示的跳数约有20跳。</li>\n<li>该测试每隔2分钟测试一次，共测试了25次。在这25次中，鲜有路径一致的，有时候全程没有公共节点，有时候两条、甚至三条路径中间有公共节点。</li>\n<li>可视化路径中，从两侧的Agent出发，均有连续的5个或6个连续未知节点。这是由于这些节点不对Traceroute作出回应，导致路径中不可见。</li>\n<li>在整个可视化路径中，可见的公网节点的IP地址属于<strong>AS 16509</strong>或者<strong>AS 14618</strong>，这两个都是AWS的BGP AS域。其他节点的地址为100.65.x.x或100.100.x.x，这段地址属于<strong>100.64.0.0&#x2F;10</strong>，为IANA保留地址，用于给运营商使用。由此可以推断，两个Agent之间通讯的报文并未离开过AWS的网络，这也解释了为何上述的时延、抖动是很稳定的值，并且整个测试期间，没有丢包。</li>\n<li>在可视化路径中，我还能发现有的路径是一段MPLS 隧道，并给出了转发时用到的Label值。ThousandEyes是如何发现路径中间有MPLS Tunnel呢？这个是值得仔细思考的问题。经查询，这是通过ThousandEyes的<a href=\"https://www.thousandeyes.com/pdf/ThousandEyes-Patents.pdf\">专利技术Deep Path Analysis (DPA)</a>实现的。</li>\n</ol>\n<h2 id=\"通过私网IP地址进行双向测试\"><a href=\"#通过私网IP地址进行双向测试\" class=\"headerlink\" title=\"通过私网IP地址进行双向测试\"></a>通过私网IP地址进行双向测试</h2><p>本次测试的方法同上，只是需要将Agent的IP地址修改为使用私有IP地址，两个Region的VPC之间建立VPC Peering。</p>\n<p>测试结果如下：</p>\n<p><strong>AWS us-east-1 to ap-southeast-1 Using Private IP</strong></p>\n<table>\n<thead>\n<tr>\n<th>Items</th>\n<th>Result</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Loss</td>\n<td>0%</td>\n</tr>\n<tr>\n<td>Latency</td>\n<td>212ms</td>\n</tr>\n<tr>\n<td>Jitter</td>\n<td>&lt;1ms</td>\n</tr>\n<tr>\n<td>Throughput</td>\n<td>56Mbps</td>\n</tr>\n</tbody></table>\n<p>在可视化的路径分析图中，观察到如下信息：</p>\n<ul>\n<li>两个Agent之间是直连的，没有任何中间节点，两者之间时延为211ms。</li>\n</ul>\n<p>做完两次测试，第二天检查了一下AWS的账单，预计花费了0.29美金。</p>\n<h2 id=\"测试结果的共享链接\"><a href=\"#测试结果的共享链接\" class=\"headerlink\" title=\"测试结果的共享链接\"></a>测试结果的共享链接</h2><p><a href=\"https://zwskwtsea.share.thousandeyes.com/\">https://zwskwtsea.share.thousandeyes.com/</a></p>\n<p><a href=\"https://aieajezsh.share.thousandeyes.com/\">https://aieajezsh.share.thousandeyes.com/</a></p>\n","length":1697,"excerpt":"<h1 id=\"ThousandEyes-简介\"><a href=\"#ThousandEyes-简介\" class=\"headerlink\" title=\"ThousandEyes 简介\"></a>ThousandEyes 简介</h1><p><a href=\"https://www.thousandeyes.com/\">ThousandEyes</a>是一个网络性能监控的SAAS云服务，结合了各种主动和被动的监控技术，让您深入了解您提供的以及您消费的应用和服务的用户体验。ThousandEyes使用的监控技术包括网络的可达性探测、时延、丢包、抖动、可视化的逐跳路径分析、可视化的BGP路由分析、DNS监控、HTTP服务监控等。ThousandEyes平台对这些监控收集而来的数据进行分析、交叉关联，将涉及用户体验的方方面面，包括网络和应用的状况统一的呈现在同一个界面之下，让您能够轻松的隔离问题，采取行动，从而快速的解决问题。</p>\n<p>ThousandEyes提供了三种Agent进行网络和应用的探测，分别是Cloud Agent、Enterprise Agent和Endpoint Agent。Cloud Agent 由ThousandEyes在全球部署和维护，当前，ThousandEyes在全球200多个城市共部署了400多个<a href=\"https://www.thousandeyes.com/product/cloud-agents\">Cloud Agent</a>，可供全球用户使用。Enterprise Agent由用户自己部署，可以部署为虚拟机或者容器，可以安装在物理硬件，如Intel NCU或者树莓派中，支持Windows、Linux系统，还可以部署在思科或Juniper的网络设备中，也能通过CloudFormation在AWS云中自动部署。Endpoint Agent是浏览器插件，用户在访问网站时，可以自助的使用Endpoint Agent进行测试，由ThousandEyes进行数据分析，从而帮助用户快速了解其数字体验，以及快速定位问题所在。用户可以根据自己的需要来选择一种或多种Agent进行探测，ThousandEyes平台会自动完成分析和展现，提供网络和应用状况的洞见分析。</p>","more":"<h1 id=\"在AWS上部署TE-Agent\"><a href=\"#在AWS上部署TE-Agent\" class=\"headerlink\" title=\"在AWS上部署TE Agent\"></a>在AWS上部署TE Agent</h1><h2 id=\"了解部署过程\"><a href=\"#了解部署过程\" class=\"headerlink\" title=\"了解部署过程\"></a>了解部署过程</h2><p>在正式部署之前，快速阅读了一下<a href=\"https://docs.thousandeyes.com/product-documentation/global-vantage-points/enterprise-agents/installing/iaas-enterprise-agent-deployment-amazon-aws\">AWS Deployment Guide</a>，部署过程是通过AWS的CloudFormation创建一个Stack，整个过程全部自动化。</p>\n<p>部署的前提是需要设置好SSH Key-pair，VPC网络、公共子网、以及使用CloudFormation部署EC2的权限。</p>\n<p>部署的内容包括：启动基于Ubuntu的EC2实例，并自动安装TE Agent，创建Security Group，并基于最小权限配置Inbound Rules。</p>\n<h2 id=\"准备SSH-Key-pair\"><a href=\"#准备SSH-Key-pair\" class=\"headerlink\" title=\"准备SSH Key-pair\"></a>准备SSH Key-pair</h2><p>首先，在MAC电脑中，执行以下命令，用于创建一个RSA的秘钥对，并将公钥拷贝至桌面。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ssh-keygen -t rsa -b 4096 -f .ssh/aws_kp -m PEM</span><br><span class=\"line\"><span class=\"built_in\">mv</span> .ssh/aws_kp .ssh/aws_kp.pem</span><br><span class=\"line\"><span class=\"built_in\">chmod</span> 400 .ssh/aws_kp.pem</span><br><span class=\"line\"><span class=\"built_in\">cp</span> .ssh/aws_kp.pub ~/Desktop</span><br></pre></td></tr></table></figure>\n\n<p>登录AWS的Console管理界面后，选择Region，比如us-east-1，定位到EC2—Network Security—Key Pair，在界面右上侧的Actions下拉框中，选择Import key pair，将aws_kp.pub上传。</p>\n<p>在其他的Region，重复上述动作，将key pair上传，这样在多个Region创建的EC2可以使用同一个私钥进行登录。</p>\n<h2 id=\"在AWS上部署TE-Agent-1\"><a href=\"#在AWS上部署TE-Agent-1\" class=\"headerlink\" title=\"在AWS上部署TE Agent\"></a>在AWS上部署TE Agent</h2><p>部署TE Agent的操作路径为：在ThousandEyes的界面中，选择Cloud &amp; Enterprise Agents，再选择Agent Settings，进一步选择Enterprise Agents，点击Add New Enterprise Agent。在右侧出现的界面中，选择IaaS Marketplaces，在该界面中点击Launch in AWS，跳转到AWS的登录界面，并自动进入CloudFormation的界面，该界面已将Stack模板选择好了。</p>\n<p>Stack模板的链接：</p>\n<p><a href=\"https://s3-us-west-1.amazonaws.com/oneclick-ea.aws.thousandeyes/aws-ea-oneclick.yaml\">https://s3-us-west-1.amazonaws.com/oneclick-ea.aws.thousandeyes/aws-ea-oneclick.yaml</a></p>\n<p>该模板包含两个组件：EC2 Instance 和 Security Group。</p>\n<p>按照上文的部署指南填写表单，并点击下一步，直至完成部署。</p>\n<p>在完成安装后，可以使用私钥登录到虚机，注意：用户名为 ubuntu，不是ec2-user 或 root。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ssh -i .ssh/aws_kp.pem -v [ubuntu@](mailto:ubuntu@18.141.230.240)x.x.x.x</span><br></pre></td></tr></table></figure>\n\n<p>在两个不同的Region，us-east-1 和 ap-southeast-1 分别部署一个TE Agent。</p>\n<p>大约5分钟后，即可在app.thousandeyes.com的界面中看到两个TE Agent上线。</p>\n<h1 id=\"执行Agent-to-Agent-测试\"><a href=\"#执行Agent-to-Agent-测试\" class=\"headerlink\" title=\"执行Agent to Agent 测试\"></a>执行Agent to Agent 测试</h1><p>分别执行两种测试，一个是通过公网IP进行双向测试，一个是创建VPC Peering后，使用私有地址进行测试，比较两者之间的差异。</p>\n<h2 id=\"通过公网IP地址进行双向测试\"><a href=\"#通过公网IP地址进行双向测试\" class=\"headerlink\" title=\"通过公网IP地址进行双向测试\"></a>通过公网IP地址进行双向测试</h2><p>在ThousandEyes的Agent Settings界面中，点击Agent，在右侧的网页中，选择Advanced Settings，将地址设置为Agent的公网IP地址。</p>\n<p>在Test Settings中，选择Add New Test，Layer选择Network，Test Type选择Agent to Agent。</p>\n<p>选择一个Agent作为Target，另一个Agent作为源，测试方向选择双向。</p>\n<p>经过一段时间后，ThousandEyes上即可呈现测试结果。</p>\n<p>测试持续了一个小时左右，测试结果如下：</p>\n<p><strong>AWS us-east-1 to ap-southeast-1 Using Public IP</strong></p>\n<table>\n<thead>\n<tr>\n<th>Items</th>\n<th>Result</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Loss</td>\n<td>0%</td>\n</tr>\n<tr>\n<td>Latency</td>\n<td>212ms</td>\n</tr>\n<tr>\n<td>Jitter</td>\n<td>&lt;1ms</td>\n</tr>\n<tr>\n<td>Throughput</td>\n<td>55Mbps</td>\n</tr>\n</tbody></table>\n<p>在可视化的路径分析图中，观察到如下信息：</p>\n<ol>\n<li>从us-east-1到ap-southeast-1往返，至少各有三条路径，每条路径显示的跳数约有20跳。</li>\n<li>该测试每隔2分钟测试一次，共测试了25次。在这25次中，鲜有路径一致的，有时候全程没有公共节点，有时候两条、甚至三条路径中间有公共节点。</li>\n<li>可视化路径中，从两侧的Agent出发，均有连续的5个或6个连续未知节点。这是由于这些节点不对Traceroute作出回应，导致路径中不可见。</li>\n<li>在整个可视化路径中，可见的公网节点的IP地址属于<strong>AS 16509</strong>或者<strong>AS 14618</strong>，这两个都是AWS的BGP AS域。其他节点的地址为100.65.x.x或100.100.x.x，这段地址属于<strong>100.64.0.0&#x2F;10</strong>，为IANA保留地址，用于给运营商使用。由此可以推断，两个Agent之间通讯的报文并未离开过AWS的网络，这也解释了为何上述的时延、抖动是很稳定的值，并且整个测试期间，没有丢包。</li>\n<li>在可视化路径中，我还能发现有的路径是一段MPLS 隧道，并给出了转发时用到的Label值。ThousandEyes是如何发现路径中间有MPLS Tunnel呢？这个是值得仔细思考的问题。经查询，这是通过ThousandEyes的<a href=\"https://www.thousandeyes.com/pdf/ThousandEyes-Patents.pdf\">专利技术Deep Path Analysis (DPA)</a>实现的。</li>\n</ol>\n<h2 id=\"通过私网IP地址进行双向测试\"><a href=\"#通过私网IP地址进行双向测试\" class=\"headerlink\" title=\"通过私网IP地址进行双向测试\"></a>通过私网IP地址进行双向测试</h2><p>本次测试的方法同上，只是需要将Agent的IP地址修改为使用私有IP地址，两个Region的VPC之间建立VPC Peering。</p>\n<p>测试结果如下：</p>\n<p><strong>AWS us-east-1 to ap-southeast-1 Using Private IP</strong></p>\n<table>\n<thead>\n<tr>\n<th>Items</th>\n<th>Result</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Loss</td>\n<td>0%</td>\n</tr>\n<tr>\n<td>Latency</td>\n<td>212ms</td>\n</tr>\n<tr>\n<td>Jitter</td>\n<td>&lt;1ms</td>\n</tr>\n<tr>\n<td>Throughput</td>\n<td>56Mbps</td>\n</tr>\n</tbody></table>\n<p>在可视化的路径分析图中，观察到如下信息：</p>\n<ul>\n<li>两个Agent之间是直连的，没有任何中间节点，两者之间时延为211ms。</li>\n</ul>\n<p>做完两次测试，第二天检查了一下AWS的账单，预计花费了0.29美金。</p>\n<h2 id=\"测试结果的共享链接\"><a href=\"#测试结果的共享链接\" class=\"headerlink\" title=\"测试结果的共享链接\"></a>测试结果的共享链接</h2><p><a href=\"https://zwskwtsea.share.thousandeyes.com/\">https://zwskwtsea.share.thousandeyes.com/</a></p>\n<p><a href=\"https://aieajezsh.share.thousandeyes.com/\">https://aieajezsh.share.thousandeyes.com/</a></p>"},{"title":"AppDynamics AMI cloud-init code update","date":"2023-03-15T04:00:00.000Z","_content":"\n```yaml\n#cloud-config\n#Update the packages onboot.\npackage_update: true\n\n#ncurses-compat-libs is for Amazon Linux 2.\npackages:\n  - libaio\n  - numactl\n  - tzdata\n  - ncurses-compat-libs\n\nwrite_files:\n  - path: /etc/profile.d/lang.sh\n    content: |\n      export LANG=en_US.UTF-8\n      export LC_ALL=en_US.UTF-8\n\n  - path: /etc/security/limits.conf\n    content: |\n      root hard nofile 65535\n      root soft nofile 65535\n      root hard nproc 8192\n      root soft nproc 8192\n\n  - path: /opt/appdynamics/response.varfile.bak\n    content: |\n      serverHostName=HOST_NAME\n      sys.languageId=en\n      disableEULA=true\n      platformAdmin.port=9191\n      platformAdmin.databasePort=3377\n      platformAdmin.dataDir=/opt/appdynamics/platform/mysql/data\n      platformAdmin.databasePassword=ENTER_PASSWORD\n      platformAdmin.databaseRootPassword=ENTER_PASSWORD\n      platformAdmin.adminPassword=ENTER_PASSWORD\n      platformAdmin.useHttps$Boolean=false\n      sys.installationDir=/opt/appdynamics/platform\n\n  - path: /etc/systemd/system/appd.console.service\n    permissions: '0644'\n    content: |\n      [Unit]\n      Description=AppDynamics Enterprise Console\n      After=network.target\n\n      [Service]\n      Type=forking\n      ExecStart=/opt/appdynamics/platform/platform-admin/bin/platform-admin.sh start-platform-admin\n      ExecStop=/opt/appdynamics/platform/platform-admin/bin/platform-admin.sh stop-platform-admin\n      User=root\n      Restart=always\n\n      [Install]\n      WantedBy=multi-user.target\n\n  - path: /etc/systemd/system/appd.console.install.service\n    permissions: '0644'\n    content: |\n      [Unit]\n      Description=AppDynamics Enterprise Console Installation\n      After=network.target\n\n      [Service]\n      Type=oneshot\n      RemainAfterExit=no\n      ExecStart=/bin/sh -c 'sleep 5 && cp /opt/appdynamics/response.varfile.bak /opt/appdynamics/response.varfile && sed -i \\\"s/ENTER_PASSWORD/`curl http://169.254.169.254/latest/meta-data/instance-id`/g\\\" /opt/appdynamics/response.varfile && sed -i \\\"s/HOST_NAME/`curl http://169.254.169.254/latest/meta-data/hostname`/g\\\" /opt/appdynamics/response.varfile && /opt/appdynamics/platform-setup-x64-linux-23.1.1.18.sh -q -varfile /opt/appdynamics/response.varfile && systemctl daemon-reload && systemctl enable appd.console.service && systemctl start appd.console.service'\n\n      [Install]\n      WantedBy=multi-user.target\n\nruncmd:\n  # Create directory and copy Cisco AppDynamics Enterprise Console setup file\n  - aws s3 cp s3://ciscoappdnx/platform-setup-x64-linux-23.1.1.18.sh /opt/appdynamics/ --region cn-northwest-1\n  - chmod +x /opt/appdynamics/platform-setup-x64-linux-23.1.1.18.sh\n  - systemctl daemon-reload\n  - systemctl enable appd.console.install.service\n  - sed -i 's/#PermitRootLogin yes/PermitRootLogin no/g' /etc/ssh/sshd_config\n  - rm -rf /root/.ssh/authorized_keys\n  - rm -rf /home/ec2-user/.ssh/authorized_keys\n  - shred -u /etc/ssh/*_key /etc/ssh/*_key.pub\n```\n","source":"_posts/Update-the-cloud-init-code-for-AppD-AMI.md","raw":"---\ntitle: AppDynamics AMI cloud-init code update\ndate: 2023-03-15 12:00:00\ntags:\n - AppD\n - cloud-init\n---\n\n```yaml\n#cloud-config\n#Update the packages onboot.\npackage_update: true\n\n#ncurses-compat-libs is for Amazon Linux 2.\npackages:\n  - libaio\n  - numactl\n  - tzdata\n  - ncurses-compat-libs\n\nwrite_files:\n  - path: /etc/profile.d/lang.sh\n    content: |\n      export LANG=en_US.UTF-8\n      export LC_ALL=en_US.UTF-8\n\n  - path: /etc/security/limits.conf\n    content: |\n      root hard nofile 65535\n      root soft nofile 65535\n      root hard nproc 8192\n      root soft nproc 8192\n\n  - path: /opt/appdynamics/response.varfile.bak\n    content: |\n      serverHostName=HOST_NAME\n      sys.languageId=en\n      disableEULA=true\n      platformAdmin.port=9191\n      platformAdmin.databasePort=3377\n      platformAdmin.dataDir=/opt/appdynamics/platform/mysql/data\n      platformAdmin.databasePassword=ENTER_PASSWORD\n      platformAdmin.databaseRootPassword=ENTER_PASSWORD\n      platformAdmin.adminPassword=ENTER_PASSWORD\n      platformAdmin.useHttps$Boolean=false\n      sys.installationDir=/opt/appdynamics/platform\n\n  - path: /etc/systemd/system/appd.console.service\n    permissions: '0644'\n    content: |\n      [Unit]\n      Description=AppDynamics Enterprise Console\n      After=network.target\n\n      [Service]\n      Type=forking\n      ExecStart=/opt/appdynamics/platform/platform-admin/bin/platform-admin.sh start-platform-admin\n      ExecStop=/opt/appdynamics/platform/platform-admin/bin/platform-admin.sh stop-platform-admin\n      User=root\n      Restart=always\n\n      [Install]\n      WantedBy=multi-user.target\n\n  - path: /etc/systemd/system/appd.console.install.service\n    permissions: '0644'\n    content: |\n      [Unit]\n      Description=AppDynamics Enterprise Console Installation\n      After=network.target\n\n      [Service]\n      Type=oneshot\n      RemainAfterExit=no\n      ExecStart=/bin/sh -c 'sleep 5 && cp /opt/appdynamics/response.varfile.bak /opt/appdynamics/response.varfile && sed -i \\\"s/ENTER_PASSWORD/`curl http://169.254.169.254/latest/meta-data/instance-id`/g\\\" /opt/appdynamics/response.varfile && sed -i \\\"s/HOST_NAME/`curl http://169.254.169.254/latest/meta-data/hostname`/g\\\" /opt/appdynamics/response.varfile && /opt/appdynamics/platform-setup-x64-linux-23.1.1.18.sh -q -varfile /opt/appdynamics/response.varfile && systemctl daemon-reload && systemctl enable appd.console.service && systemctl start appd.console.service'\n\n      [Install]\n      WantedBy=multi-user.target\n\nruncmd:\n  # Create directory and copy Cisco AppDynamics Enterprise Console setup file\n  - aws s3 cp s3://ciscoappdnx/platform-setup-x64-linux-23.1.1.18.sh /opt/appdynamics/ --region cn-northwest-1\n  - chmod +x /opt/appdynamics/platform-setup-x64-linux-23.1.1.18.sh\n  - systemctl daemon-reload\n  - systemctl enable appd.console.install.service\n  - sed -i 's/#PermitRootLogin yes/PermitRootLogin no/g' /etc/ssh/sshd_config\n  - rm -rf /root/.ssh/authorized_keys\n  - rm -rf /home/ec2-user/.ssh/authorized_keys\n  - shred -u /etc/ssh/*_key /etc/ssh/*_key.pub\n```\n","slug":"Update-the-cloud-init-code-for-AppD-AMI","published":1,"updated":"2025-12-14T09:50:07.439Z","comments":1,"layout":"post","photos":[],"_id":"cuid6x1Z-P-eIi0SWdr69o_ot","content":"<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#cloud-config</span></span><br><span class=\"line\"><span class=\"comment\">#Update the packages onboot.</span></span><br><span class=\"line\"><span class=\"attr\">package_update:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#ncurses-compat-libs is for Amazon Linux 2.</span></span><br><span class=\"line\"><span class=\"attr\">packages:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">libaio</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">numactl</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">tzdata</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">ncurses-compat-libs</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">write_files:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">path:</span> <span class=\"string\">/etc/profile.d/lang.sh</span></span><br><span class=\"line\">    <span class=\"attr\">content:</span> <span class=\"string\">|</span></span><br><span class=\"line\"><span class=\"string\">      export LANG=en_US.UTF-8</span></span><br><span class=\"line\"><span class=\"string\">      export LC_ALL=en_US.UTF-8</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">path:</span> <span class=\"string\">/etc/security/limits.conf</span></span><br><span class=\"line\">    <span class=\"attr\">content:</span> <span class=\"string\">|</span></span><br><span class=\"line\"><span class=\"string\">      root hard nofile 65535</span></span><br><span class=\"line\"><span class=\"string\">      root soft nofile 65535</span></span><br><span class=\"line\"><span class=\"string\">      root hard nproc 8192</span></span><br><span class=\"line\"><span class=\"string\">      root soft nproc 8192</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">path:</span> <span class=\"string\">/opt/appdynamics/response.varfile.bak</span></span><br><span class=\"line\">    <span class=\"attr\">content:</span> <span class=\"string\">|</span></span><br><span class=\"line\"><span class=\"string\">      serverHostName=HOST_NAME</span></span><br><span class=\"line\"><span class=\"string\">      sys.languageId=en</span></span><br><span class=\"line\"><span class=\"string\">      disableEULA=true</span></span><br><span class=\"line\"><span class=\"string\">      platformAdmin.port=9191</span></span><br><span class=\"line\"><span class=\"string\">      platformAdmin.databasePort=3377</span></span><br><span class=\"line\"><span class=\"string\">      platformAdmin.dataDir=/opt/appdynamics/platform/mysql/data</span></span><br><span class=\"line\"><span class=\"string\">      platformAdmin.databasePassword=ENTER_PASSWORD</span></span><br><span class=\"line\"><span class=\"string\">      platformAdmin.databaseRootPassword=ENTER_PASSWORD</span></span><br><span class=\"line\"><span class=\"string\">      platformAdmin.adminPassword=ENTER_PASSWORD</span></span><br><span class=\"line\"><span class=\"string\">      platformAdmin.useHttps$Boolean=false</span></span><br><span class=\"line\"><span class=\"string\">      sys.installationDir=/opt/appdynamics/platform</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">path:</span> <span class=\"string\">/etc/systemd/system/appd.console.service</span></span><br><span class=\"line\">    <span class=\"attr\">permissions:</span> <span class=\"string\">&#x27;0644&#x27;</span></span><br><span class=\"line\">    <span class=\"attr\">content:</span> <span class=\"string\">|</span></span><br><span class=\"line\"><span class=\"string\">      [Unit]</span></span><br><span class=\"line\"><span class=\"string\">      Description=AppDynamics Enterprise Console</span></span><br><span class=\"line\"><span class=\"string\">      After=network.target</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\">      [<span class=\"string\">Service</span>]</span><br><span class=\"line\">      <span class=\"string\">Type=forking</span></span><br><span class=\"line\">      <span class=\"string\">ExecStart=/opt/appdynamics/platform/platform-admin/bin/platform-admin.sh</span> <span class=\"string\">start-platform-admin</span></span><br><span class=\"line\">      <span class=\"string\">ExecStop=/opt/appdynamics/platform/platform-admin/bin/platform-admin.sh</span> <span class=\"string\">stop-platform-admin</span></span><br><span class=\"line\">      <span class=\"string\">User=root</span></span><br><span class=\"line\">      <span class=\"string\">Restart=always</span></span><br><span class=\"line\"></span><br><span class=\"line\">      [<span class=\"string\">Install</span>]</span><br><span class=\"line\">      <span class=\"string\">WantedBy=multi-user.target</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">path:</span> <span class=\"string\">/etc/systemd/system/appd.console.install.service</span></span><br><span class=\"line\">    <span class=\"attr\">permissions:</span> <span class=\"string\">&#x27;0644&#x27;</span></span><br><span class=\"line\">    <span class=\"attr\">content:</span> <span class=\"string\">|</span></span><br><span class=\"line\"><span class=\"string\">      [Unit]</span></span><br><span class=\"line\"><span class=\"string\">      Description=AppDynamics Enterprise Console Installation</span></span><br><span class=\"line\"><span class=\"string\">      After=network.target</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\">      [<span class=\"string\">Service</span>]</span><br><span class=\"line\">      <span class=\"string\">Type=oneshot</span></span><br><span class=\"line\">      <span class=\"string\">RemainAfterExit=no</span></span><br><span class=\"line\">      <span class=\"string\">ExecStart=/bin/sh</span> <span class=\"string\">-c</span> <span class=\"string\">&#x27;sleep 5 &amp;&amp; cp /opt/appdynamics/response.varfile.bak /opt/appdynamics/response.varfile &amp;&amp; sed -i \\&quot;s/ENTER_PASSWORD/`curl http://169.254.169.254/latest/meta-data/instance-id`/g\\&quot; /opt/appdynamics/response.varfile &amp;&amp; sed -i \\&quot;s/HOST_NAME/`curl http://169.254.169.254/latest/meta-data/hostname`/g\\&quot; /opt/appdynamics/response.varfile &amp;&amp; /opt/appdynamics/platform-setup-x64-linux-23.1.1.18.sh -q -varfile /opt/appdynamics/response.varfile &amp;&amp; systemctl daemon-reload &amp;&amp; systemctl enable appd.console.service &amp;&amp; systemctl start appd.console.service&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">      [<span class=\"string\">Install</span>]</span><br><span class=\"line\">      <span class=\"string\">WantedBy=multi-user.target</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">runcmd:</span></span><br><span class=\"line\">  <span class=\"comment\"># Create directory and copy Cisco AppDynamics Enterprise Console setup file</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">aws</span> <span class=\"string\">s3</span> <span class=\"string\">cp</span> <span class=\"string\">s3://ciscoappdnx/platform-setup-x64-linux-23.1.1.18.sh</span> <span class=\"string\">/opt/appdynamics/</span> <span class=\"string\">--region</span> <span class=\"string\">cn-northwest-1</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">chmod</span> <span class=\"string\">+x</span> <span class=\"string\">/opt/appdynamics/platform-setup-x64-linux-23.1.1.18.sh</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">systemctl</span> <span class=\"string\">daemon-reload</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">systemctl</span> <span class=\"string\">enable</span> <span class=\"string\">appd.console.install.service</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">sed</span> <span class=\"string\">-i</span> <span class=\"string\">&#x27;s/#PermitRootLogin yes/PermitRootLogin no/g&#x27;</span> <span class=\"string\">/etc/ssh/sshd_config</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">rm</span> <span class=\"string\">-rf</span> <span class=\"string\">/root/.ssh/authorized_keys</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">rm</span> <span class=\"string\">-rf</span> <span class=\"string\">/home/ec2-user/.ssh/authorized_keys</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">shred</span> <span class=\"string\">-u</span> <span class=\"string\">/etc/ssh/*_key</span> <span class=\"string\">/etc/ssh/*_key.pub</span></span><br></pre></td></tr></table></figure>\n","length":309,"excerpt":"","more":"<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#cloud-config</span></span><br><span class=\"line\"><span class=\"comment\">#Update the packages onboot.</span></span><br><span class=\"line\"><span class=\"attr\">package_update:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#ncurses-compat-libs is for Amazon Linux 2.</span></span><br><span class=\"line\"><span class=\"attr\">packages:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">libaio</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">numactl</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">tzdata</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">ncurses-compat-libs</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">write_files:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">path:</span> <span class=\"string\">/etc/profile.d/lang.sh</span></span><br><span class=\"line\">    <span class=\"attr\">content:</span> <span class=\"string\">|</span></span><br><span class=\"line\"><span class=\"string\">      export LANG=en_US.UTF-8</span></span><br><span class=\"line\"><span class=\"string\">      export LC_ALL=en_US.UTF-8</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">path:</span> <span class=\"string\">/etc/security/limits.conf</span></span><br><span class=\"line\">    <span class=\"attr\">content:</span> <span class=\"string\">|</span></span><br><span class=\"line\"><span class=\"string\">      root hard nofile 65535</span></span><br><span class=\"line\"><span class=\"string\">      root soft nofile 65535</span></span><br><span class=\"line\"><span class=\"string\">      root hard nproc 8192</span></span><br><span class=\"line\"><span class=\"string\">      root soft nproc 8192</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">path:</span> <span class=\"string\">/opt/appdynamics/response.varfile.bak</span></span><br><span class=\"line\">    <span class=\"attr\">content:</span> <span class=\"string\">|</span></span><br><span class=\"line\"><span class=\"string\">      serverHostName=HOST_NAME</span></span><br><span class=\"line\"><span class=\"string\">      sys.languageId=en</span></span><br><span class=\"line\"><span class=\"string\">      disableEULA=true</span></span><br><span class=\"line\"><span class=\"string\">      platformAdmin.port=9191</span></span><br><span class=\"line\"><span class=\"string\">      platformAdmin.databasePort=3377</span></span><br><span class=\"line\"><span class=\"string\">      platformAdmin.dataDir=/opt/appdynamics/platform/mysql/data</span></span><br><span class=\"line\"><span class=\"string\">      platformAdmin.databasePassword=ENTER_PASSWORD</span></span><br><span class=\"line\"><span class=\"string\">      platformAdmin.databaseRootPassword=ENTER_PASSWORD</span></span><br><span class=\"line\"><span class=\"string\">      platformAdmin.adminPassword=ENTER_PASSWORD</span></span><br><span class=\"line\"><span class=\"string\">      platformAdmin.useHttps$Boolean=false</span></span><br><span class=\"line\"><span class=\"string\">      sys.installationDir=/opt/appdynamics/platform</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">path:</span> <span class=\"string\">/etc/systemd/system/appd.console.service</span></span><br><span class=\"line\">    <span class=\"attr\">permissions:</span> <span class=\"string\">&#x27;0644&#x27;</span></span><br><span class=\"line\">    <span class=\"attr\">content:</span> <span class=\"string\">|</span></span><br><span class=\"line\"><span class=\"string\">      [Unit]</span></span><br><span class=\"line\"><span class=\"string\">      Description=AppDynamics Enterprise Console</span></span><br><span class=\"line\"><span class=\"string\">      After=network.target</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\">      [<span class=\"string\">Service</span>]</span><br><span class=\"line\">      <span class=\"string\">Type=forking</span></span><br><span class=\"line\">      <span class=\"string\">ExecStart=/opt/appdynamics/platform/platform-admin/bin/platform-admin.sh</span> <span class=\"string\">start-platform-admin</span></span><br><span class=\"line\">      <span class=\"string\">ExecStop=/opt/appdynamics/platform/platform-admin/bin/platform-admin.sh</span> <span class=\"string\">stop-platform-admin</span></span><br><span class=\"line\">      <span class=\"string\">User=root</span></span><br><span class=\"line\">      <span class=\"string\">Restart=always</span></span><br><span class=\"line\"></span><br><span class=\"line\">      [<span class=\"string\">Install</span>]</span><br><span class=\"line\">      <span class=\"string\">WantedBy=multi-user.target</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">path:</span> <span class=\"string\">/etc/systemd/system/appd.console.install.service</span></span><br><span class=\"line\">    <span class=\"attr\">permissions:</span> <span class=\"string\">&#x27;0644&#x27;</span></span><br><span class=\"line\">    <span class=\"attr\">content:</span> <span class=\"string\">|</span></span><br><span class=\"line\"><span class=\"string\">      [Unit]</span></span><br><span class=\"line\"><span class=\"string\">      Description=AppDynamics Enterprise Console Installation</span></span><br><span class=\"line\"><span class=\"string\">      After=network.target</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\">      [<span class=\"string\">Service</span>]</span><br><span class=\"line\">      <span class=\"string\">Type=oneshot</span></span><br><span class=\"line\">      <span class=\"string\">RemainAfterExit=no</span></span><br><span class=\"line\">      <span class=\"string\">ExecStart=/bin/sh</span> <span class=\"string\">-c</span> <span class=\"string\">&#x27;sleep 5 &amp;&amp; cp /opt/appdynamics/response.varfile.bak /opt/appdynamics/response.varfile &amp;&amp; sed -i \\&quot;s/ENTER_PASSWORD/`curl http://169.254.169.254/latest/meta-data/instance-id`/g\\&quot; /opt/appdynamics/response.varfile &amp;&amp; sed -i \\&quot;s/HOST_NAME/`curl http://169.254.169.254/latest/meta-data/hostname`/g\\&quot; /opt/appdynamics/response.varfile &amp;&amp; /opt/appdynamics/platform-setup-x64-linux-23.1.1.18.sh -q -varfile /opt/appdynamics/response.varfile &amp;&amp; systemctl daemon-reload &amp;&amp; systemctl enable appd.console.service &amp;&amp; systemctl start appd.console.service&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">      [<span class=\"string\">Install</span>]</span><br><span class=\"line\">      <span class=\"string\">WantedBy=multi-user.target</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">runcmd:</span></span><br><span class=\"line\">  <span class=\"comment\"># Create directory and copy Cisco AppDynamics Enterprise Console setup file</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">aws</span> <span class=\"string\">s3</span> <span class=\"string\">cp</span> <span class=\"string\">s3://ciscoappdnx/platform-setup-x64-linux-23.1.1.18.sh</span> <span class=\"string\">/opt/appdynamics/</span> <span class=\"string\">--region</span> <span class=\"string\">cn-northwest-1</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">chmod</span> <span class=\"string\">+x</span> <span class=\"string\">/opt/appdynamics/platform-setup-x64-linux-23.1.1.18.sh</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">systemctl</span> <span class=\"string\">daemon-reload</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">systemctl</span> <span class=\"string\">enable</span> <span class=\"string\">appd.console.install.service</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">sed</span> <span class=\"string\">-i</span> <span class=\"string\">&#x27;s/#PermitRootLogin yes/PermitRootLogin no/g&#x27;</span> <span class=\"string\">/etc/ssh/sshd_config</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">rm</span> <span class=\"string\">-rf</span> <span class=\"string\">/root/.ssh/authorized_keys</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">rm</span> <span class=\"string\">-rf</span> <span class=\"string\">/home/ec2-user/.ssh/authorized_keys</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">shred</span> <span class=\"string\">-u</span> <span class=\"string\">/etc/ssh/*_key</span> <span class=\"string\">/etc/ssh/*_key.pub</span></span><br></pre></td></tr></table></figure>\n"},{"title":"Cisco NFVIS CSR1Kv ZTP Onboarding for SDWAN","date":"2021-02-08T03:02:43.000Z","description":"本视频演示在Cisco NFVIS平台上零配置上线CSR1000v，并完成SDWAN的配置。","_content":"\n{% raw %}\n\n<div style=\"position: relative; width: 100%; height: 0; padding-bottom: 75%;\">\n    <iframe src=\"//player.bilibili.com/player.html?aid=544065936&bvid=BV1Zv4y1o7YJ&cid=294265132&page=1\" scrolling=\"no\" border=\"0\" frameborder=\"no\" framespacing=\"0\" allowfullscreen=\"true\" style=\"position: absolute; width: 100%; height: 100%; left: 0; top: 0;\">\n    </iframe>\n</div>\n\n{% endraw %}\n","source":"_posts/csr1kv-nfvis-ztp-demo.md","raw":"---\ntitle: Cisco NFVIS CSR1Kv ZTP Onboarding for SDWAN\ndate: 2021-02-08 11:02:43\ntags: \n - nfvis\n - ztp\ndescription: 本视频演示在Cisco NFVIS平台上零配置上线CSR1000v，并完成SDWAN的配置。\n---\n\n{% raw %}\n\n<div style=\"position: relative; width: 100%; height: 0; padding-bottom: 75%;\">\n    <iframe src=\"//player.bilibili.com/player.html?aid=544065936&bvid=BV1Zv4y1o7YJ&cid=294265132&page=1\" scrolling=\"no\" border=\"0\" frameborder=\"no\" framespacing=\"0\" allowfullscreen=\"true\" style=\"position: absolute; width: 100%; height: 100%; left: 0; top: 0;\">\n    </iframe>\n</div>\n\n{% endraw %}\n","slug":"csr1kv-nfvis-ztp-demo","published":1,"updated":"2025-12-14T09:50:07.448Z","comments":1,"layout":"post","photos":[],"_id":"cuidOrYEGbG1wwCNgePOc-cRG","content":"\n\n<div style=\"position: relative; width: 100%; height: 0; padding-bottom: 75%;\">\n    <iframe src=\"//player.bilibili.com/player.html?aid=544065936&bvid=BV1Zv4y1o7YJ&cid=294265132&page=1\" scrolling=\"no\" border=\"0\" frameborder=\"no\" framespacing=\"0\" allowfullscreen=\"true\" style=\"position: absolute; width: 100%; height: 100%; left: 0; top: 0;\">\n    </iframe>\n</div>\n\n\n","length":48,"excerpt":"","more":"\n\n<div style=\"position: relative; width: 100%; height: 0; padding-bottom: 75%;\">\n    <iframe src=\"//player.bilibili.com/player.html?aid=544065936&bvid=BV1Zv4y1o7YJ&cid=294265132&page=1\" scrolling=\"no\" border=\"0\" frameborder=\"no\" framespacing=\"0\" allowfullscreen=\"true\" style=\"position: absolute; width: 100%; height: 100%; left: 0; top: 0;\">\n    </iframe>\n</div>\n\n\n"},{"title":"在Docker容器中tcpdump抓包探秘Traceroute","date":"2021-06-29T07:20:00.000Z","description":"本文记录了在一个纯净的容器环境下进行抓包分析Traceroute的过程；通过番外篇介绍ThousandEyes的探针在容器中安装部署，并展示路径可视化分析的效果。","_content":"\n在上一篇文章[《通过Wireshark重新认识Traceroute》](https://weiborao.github.io/get-known-traceroute-by-wireshark.html)中，我在MAC电脑上进行抓包来对MAC上的Traceroute过程进行分析。但是MAC电脑上运行了多个应用，我在抓完报文后，使用过滤器将其他报文过滤掉了，但是也很可能把Traceroute产生的报文给删掉了。\n\n为了打造一个纯净的Traceroute环境，我又使用容器来做一次测试。\n\n本文记录以下内容：\n\n1. 创建一个包含traceroute、ping、whois等工具的容器，取名traceroute\n2. 创建一个只包含tcpdump的容器，对traceroute容器抓包\n3. 简略的分析抓包文件----不是本文重点\n\n# 创建Traceroute容器镜像\n\n## Dockerfile准备\n\n如果我们执行**docker run -it ubuntu**，想在该容器中执行ping、traceroute命令，抱歉，找不到该命令。\n\n```shell\n➜  docker pull ubuntu\n➜  docker run -it --rm ubuntu\nroot@631c227046f7:/# ping 8.8.8.8\nbash: ping: command not found\nroot@631c227046f7:/# traceroute 8.8.8.8\nbash: traceroute: command not found\nroot@631c227046f7:/#\n```\n\n这时候，您可以直接在容器里执行：\n\n```shell\nroot@631c227046f7:/# apt-get update && apt-get install traceroute iputils-ping --no-install-recommends\n```\n\n当然，您也可以创建一个容器镜像，如下：\n\n```shell\nmkdir traceroute\ncd traceroute\ntouch Dockerfile\n```\n\nDockerfile 内容如下：\n\n```\nFROM ubuntu:latest\n\nRUN apt-get update && apt-get install -y \\\n\ttraceroute \\\n\tiputils-ping \\\n\twhois \\\n\tnetbase \\\n\tiproute2 \\\n\t--no-install-recommends \\\n\t&& rm -rf /var/lib/apt/lists/*\n```\n\n注：上述要安装的软件包，是我经过尝试后，一个个增加的。\n\n1. 最开始我只安装了traceroute，当我执行traceroute -A 8.8.8.8时，提示如下错误信息：\n\n   ```shell\n   whois.radb.net/nicname: Servname not supported for ai_socktype\n   ```\n\n2. 我想起traceroute可能需要调用whois来查询BGP AS号，于是我继续安装whois，仍然报错。----经过验证，如果不安装whois软件包，traceroute -A 8.8.8.8 可正常工作。\n\n3. 只能在网上搜索答案了，果然有人遇到过类似问题：\n\n   ```shell\nhttps://stackoverflow.com/questions/56430294/bash-script-that-uses-whois-command-gets-servname-not-supported-error-on-do\n解决办法：\napt-get update && apt-get install -y --no-install-recommends netbase\n   ```\n\n4. 安装iproute2的目的是为了执行ip a,  ip link 这些命令。\n\n## 根据Dockerfile创建容器镜像\n\n根据上述的Dockerfile创建容器镜像，执行命令：**docker image build -t traceroute:latest .** 注意末尾的小点，表示当前目录。\n\n```shell\n➜  traceroute docker image build -t traceroute:latest .\n[+] Building 48.7s (6/6) FINISHED\n => [internal] load build definition from Dockerfile                                                               0.0s\n => => transferring dockerfile: 274B                                                                               0.0s\n => [internal] load .dockerignore                                                                                  0.0s\n => => transferring context: 2B                                                                                    0.0s\n => [internal] load metadata for docker.io/library/ubuntu:latest                                                   0.0s\n => CACHED [1/2] FROM docker.io/library/ubuntu:latest                                                              0.0s\n => [2/2] RUN apt-get update && apt-get install -y  traceroute  iputils-ping  whois  netbase  iproute2  --no-ins  48.5s\n => exporting to image                                                                                             0.1s\n => => exporting layers                                                                                            0.1s\n => => writing image sha256:bbf499e59136872e8d171fddcd1548497a9e76b96d154dcb340b8326252d97d5                       0.0s\n => => naming to docker.io/library/traceroute:latest                                                               0.0s\n \n➜  traceroute docker images\nREPOSITORY   TAG       IMAGE ID       CREATED          SIZE\ntraceroute   latest    bbf499e59136   5 seconds ago    77.4MB\n```\n\n# 如何抓取容器的网络报文\n\n接下来，需要考虑的问题是在MAC电脑上如何抓取容器的网络报文呢？\n\n## Wireshark on macOS如何抓包？\n\n我执行了docker run -it --name traceroute traceroute 启动了一个名为tracertoute的容器，打开Wireshark，哪一个接口对应的是这个容器的接口呢？\n\n![wireshark-int-list](docker-traceroute-tcpdump/wireshark-int-list.png)\n\n上面的接口眼花缭乱的，找不出是哪一个接口，en0和lo0上有流量，但是并不是容器连接的端口，只得寻求其他方法。\n\n## 基于 Container 网络共享机制来抓包\n\n通过搜索\"how to tcpdump in docker\"，找到一篇文章[How to TCPdump effectively in Docker](https://xxradar.medium.com/how-to-tcpdump-effectively-in-docker-2ed0a09b5406)，获益匪浅。\n\n该文章介绍了一种Docker的网络模式，container模式。\n\n> In the `--net=container:id` all traffic in/out a specific container (or group of containers) can be captured.\n\n另一篇文章：https://www.freeaihub.com/article/container-module-in-docker-network.html\n\n> Docker网络container模式是指，创建新容器的时候，通过`--net container`参数，指定其和已经存在的某个容器共享一个 Network Namespace。如下图所示，右方黄色新创建的container，其网卡共享左边容器。因此就不会拥有自己独立的 IP，而是共享左边容器的 IP 172.17.0.2,端口范围等网络资源，两个容器的进程通过 lo 网卡设备通信。\n>\n> 但这两个容器在其他的资源上，如文件系统、进程列表等还是隔离的。\n>\n> ![container-module-in-docker-network](docker-traceroute-tcpdump/container-module-in-docker-network.png)\n\n专门创建一个安装了tcpdump的容器，对上文创建的traceroute容器进行抓包。\n\n参考[How to TCPdump effectively in Docker](https://xxradar.medium.com/how-to-tcpdump-effectively-in-docker-2ed0a09b5406)，在Terminal中执行以下命令，创建一个tcpdump的容器镜像\n\n```shell\ndocker build -t tcpdump - <<EOF \nFROM ubuntu \nRUN apt-get update && apt-get install -y tcpdump \nCMD tcpdump -i eth0 -w /var/traceroute-ubuntu.pcapng\nEOF\n```\n\n创建过程如下：\n\n```\n[+] Building 0.1s (6/6) FINISHED\n => [internal] load build definition from Dockerfile                                                               0.0s\n => => transferring dockerfile: 159B                                                                               0.0s\n => [internal] load .dockerignore                                                                                  0.0s\n => => transferring context: 2B                                                                                    0.0s\n => [internal] load metadata for docker.io/library/ubuntu:latest                                                   0.0s\n => [1/2] FROM docker.io/library/ubuntu                                                                            0.0s\n => CACHED [2/2] RUN apt-get update && apt-get install -y tcpdump                                                  0.0s\n => exporting to image                                                                                             0.0s\n => => exporting layers                                                                                            0.0s\n => => writing image sha256:d5d8942d4836fabbb0343a082d9aa0009c6dd5071c70a54ae57baf6728462562                       0.0s\n => => naming to docker.io/library/tcpdump                                                                         0.0s\n```\n\n镜像列表：\n\n```shell\n➜  traceroute docker images\nREPOSITORY   TAG       IMAGE ID       CREATED          SIZE\ntcpdump      latest    d5d8942d4836   3 minutes ago    109MB\ntraceroute   latest    bbf499e59136   35 minutes ago   77.4MB\nubuntu       latest    9873176a8ff5   11 days ago      72.7MB\n```\n\n启动traceroute容器：\n\n```shell\n➜ docker run -it --name traceroute traceroute\nroot@fbe3eb98ae63:/#\n```\n\n启动tcpdump容器，进行抓包：\n\n```shell\n➜  ~ docker run -it --net=container:traceroute tcpdump\ntcpdump: listening on eth0, link-type EN10MB (Ethernet), capture size 262144 bytes\n```\n\n在traceroute容器发起traceroute：\n\n```shell\nroot@fbe3eb98ae63:/# traceroute -A -q 1 -N 1 -z 500 -e 8.8.8.8\ntraceroute to 8.8.8.8 (8.8.8.8), 30 hops max, 60 byte packets\n 1  localhost (172.17.0.1) [*]  0.129 ms\n 2  localhost (10.39.101.1) [*]  3.716 ms\n 3  localhost (192.168.1.1) [*]  3.926 ms\n 4  222.129.32.1 (222.129.32.1) [AS4808]  6.837 ms\n 5  61.148.163.181 (61.148.163.181) [AS4808]  9.247 ms\n 6  219.232.11.65 (219.232.11.65) [AS17431]  7.049 ms\n 7  61.149.203.205 (61.149.203.205) [AS4808]  7.650 ms\n 8  219.158.7.22 (219.158.7.22) [AS4837]  40.815 ms\n 9  219.158.103.218 (219.158.103.218) [AS4837]  64.771 ms\n10  219.158.103.30 (219.158.103.30) [AS4837]  50.402 ms\n11  219.158.10.30 (219.158.10.30) [AS4837]  53.261 ms\n12  219.158.33.174 (219.158.33.174) [AS4837]  55.503 ms\n13  108.170.241.65 (108.170.241.65) [AS15169]  54.876 ms\n14  142.251.64.173 (142.251.64.173) [AS15169]  45.966 ms\n15  dns.google (8.8.8.8) [AS15169]  52.492 ms\n```\n\n**traceroute -A -q 1 -N 1 -z 500 -e 8.8.8.8** 参数解释如下：\n\n- -A： \t向radb.net查找对应节点IP所在的AS Path信息，并将查询信息输出\n- -q 1：  将缺省发送3个探测包改为1个\n- -N 1： 将并发16个探测改为一次一个，以便于逐个分析\n- -z 500： 表示每次等待500毫秒再发出下一个探测\n- -e：    显示ICMP的扩展消息，如果有的话\n\n按下CTRL+C，停止tcpdump容器的抓包：\n\n```shell\n➜  ~ docker run -it --net=container:traceroute tcpdump\ntcpdump: listening on eth0, link-type EN10MB (Ethernet), capture size 262144 bytes\n^C237 packets captured\n237 packets received by filter\n0 packets dropped by kernel\n```\n\n该容器在抓完包后自动停止，并将抓包文件存储在容器内部的/var/traceroute-ubuntu.pcapng，通过**docker cp**命令将抓包文件拷贝出来。\n\n```shell\n➜  ~ docker ps -a\nCONTAINER ID   IMAGE        COMMAND                  CREATED          STATUS                        PORTS     NAMES\nf397f50267ae   tcpdump      \"/bin/sh -c 'tcpdump…\"   2 minutes ago    Exited (130) 20 seconds ago             condescending_cori\nfbe3eb98ae63   traceroute   \"bash\"                   48 minutes ago   Up 48 minutes                           traceroute\n➜  ~ docker cp f397f50267ae:/var/traceroute-ubuntu.pcapng ./\n```\n\n# 简略分析抓包文件\n\n以下是本次抓取的237个报文的头36个报文，如下：\n\n![docker-packet1-36](docker-traceroute-tcpdump/docker-packet1-36.png)\n\n上图中，Wireshare直接分析出来Whois报文。\n\n过程概述如下：\n\n1. 向8.8.8.8发起UDP报文，目的端口为**33434**，TTL设置为1\n2. 收到路由器的ICMP TTL超时消息，获取路由器对应的IP地址\n3. 尝试向DNS服务器查询路由器IP地址的反向域名解析，如果得到域名，就将其显示在Traceroute的输出结果中。\n4. 发起DNS查询，查询**whois.radb.net**域名，得到应答为198.108.0.18\n5. 发起TCP连接请求，与198.108.0.18建立TCP连接。\n6. 向**whois.radb.net**发起查询，询问路由器IP地址对应的AS号，并得到回应，如果是私有地址，其AS号为0。\n7. 重复上述第1、2、3、6步，每次将TTL加1，直至目标地址接收到探测报文，并返回ICMP Port Unreachable消息。\n\n[抓包文件下载](docker-traceroute-tcpdump/traceroute-ubuntu.pcapng)\n\n# 番外篇\n\nThousandEyes的介绍可参考这篇文章[《在AWS上部署TE Agent并进行测试》](https://weiborao.github.io/deploy-thousandeyes-agent-on-aws.html)。\n\nThousandEyes可将探针部署到容器中，而且安装十分简单，从ThousandEyes的Cloud & Enterprise Agents中，选择Agent Settings，再选择Enterprise Agents，再点击Add New Enterprise Agent，切换到Docker这个TAB。\n\n![te-agent-docker](docker-traceroute-tcpdump/te-agent-docker.png)\n\n将下面的文字复制粘贴到Terminal终端：\n\n```shell\ndocker pull thousandeyes/enterprise-agent > /dev/null 2>&1\ndocker stop 'TEagent' > /dev/null 2>&1\ndocker rm 'TEagent' > /dev/null 2>&1\ndocker run \\\n  --hostname='TEagent' \\\n  --memory=2g \\\n  --memory-swap=2g \\\n  --detach=true \\\n  --tty=true \\\n  --shm-size=512M \\\n  -e TEAGENT_ACCOUNT_TOKEN=lje1co39qi       8b5oviy \\\n  -e TEAGENT_INET=4 \\\n  -v '/Users/werao/thousandeyes/TEagent/te-agent':/var/lib/te-agent \\\n  -v '/Users/werao/thousandeyes/TEagent/te-browserbot':/var/lib/te-browserbot \\\n  -v '/Users/werao/thousandeyes/TEagent/log/':/var/log/agent \\\n  --cap-add=NET_ADMIN \\\n  --cap-add=SYS_ADMIN \\\n  --name 'TEagent' \\\n  --restart=unless-stopped \\\n  thousandeyes/enterprise-agent /sbin/my_init\n```\n\n安装完后，ThousandEyes即可使用该Agent进行测试了。\n\n创建一个简单的探测如下：\n\n![probe-anycast-dns](docker-traceroute-tcpdump/probe-anycast-dns.png)\n\n在ThousandEyes的界面，可观测上述的探测结果：\n\n时延比较稳定，维持在50ms左右。\n\n![thousandeyes-path](docker-traceroute-tcpdump/thousandeyes-path.png)\n\n路径可视化分析中，当我们把鼠标落在某个节点上，网页会弹出交互式的信息，包括：\n\n- 网络前缀信息，如：124.65.192.0/18\n- 运营商AS信息，如：CNCGROUP Beijing Province (AS 4808)\n- 地理位置，如：Beijing, Beijing, China\n- DSCP\n- 平均时延，指从探测的Agent到对应节点的平均时延\n\n![thousandeyes-path-node1](docker-traceroute-tcpdump/thousandeyes-path-node1.png)\n\n![thousandeyes-path-node2](docker-traceroute-tcpdump/thousandeyes-path-node2.png)\n\n![thousandeyes-path-node3](docker-traceroute-tcpdump/thousandeyes-path-node3.png)\n\n\n\nThousandEyes的探针所收集的数据是常规的网络工具都能收集到的，ThousandEyes的平台对收集到的数据进行存储、分析、交叉关联，为用户的数字体验提供全方位的洞见。\n\n本节是突发奇想的内容，故而放到番外篇。\n\n\n\n全文完。\n","source":"_posts/docker-traceroute-tcpdump.md","raw":"---\ntitle: 在Docker容器中tcpdump抓包探秘Traceroute\ndate: 2021-06-29 15:20:00\ntags:\n    - docker\n    - tcpdump\n    - traceroute\ndescription: 本文记录了在一个纯净的容器环境下进行抓包分析Traceroute的过程；通过番外篇介绍ThousandEyes的探针在容器中安装部署，并展示路径可视化分析的效果。\n---\n\n在上一篇文章[《通过Wireshark重新认识Traceroute》](https://weiborao.github.io/get-known-traceroute-by-wireshark.html)中，我在MAC电脑上进行抓包来对MAC上的Traceroute过程进行分析。但是MAC电脑上运行了多个应用，我在抓完报文后，使用过滤器将其他报文过滤掉了，但是也很可能把Traceroute产生的报文给删掉了。\n\n为了打造一个纯净的Traceroute环境，我又使用容器来做一次测试。\n\n本文记录以下内容：\n\n1. 创建一个包含traceroute、ping、whois等工具的容器，取名traceroute\n2. 创建一个只包含tcpdump的容器，对traceroute容器抓包\n3. 简略的分析抓包文件----不是本文重点\n\n# 创建Traceroute容器镜像\n\n## Dockerfile准备\n\n如果我们执行**docker run -it ubuntu**，想在该容器中执行ping、traceroute命令，抱歉，找不到该命令。\n\n```shell\n➜  docker pull ubuntu\n➜  docker run -it --rm ubuntu\nroot@631c227046f7:/# ping 8.8.8.8\nbash: ping: command not found\nroot@631c227046f7:/# traceroute 8.8.8.8\nbash: traceroute: command not found\nroot@631c227046f7:/#\n```\n\n这时候，您可以直接在容器里执行：\n\n```shell\nroot@631c227046f7:/# apt-get update && apt-get install traceroute iputils-ping --no-install-recommends\n```\n\n当然，您也可以创建一个容器镜像，如下：\n\n```shell\nmkdir traceroute\ncd traceroute\ntouch Dockerfile\n```\n\nDockerfile 内容如下：\n\n```\nFROM ubuntu:latest\n\nRUN apt-get update && apt-get install -y \\\n\ttraceroute \\\n\tiputils-ping \\\n\twhois \\\n\tnetbase \\\n\tiproute2 \\\n\t--no-install-recommends \\\n\t&& rm -rf /var/lib/apt/lists/*\n```\n\n注：上述要安装的软件包，是我经过尝试后，一个个增加的。\n\n1. 最开始我只安装了traceroute，当我执行traceroute -A 8.8.8.8时，提示如下错误信息：\n\n   ```shell\n   whois.radb.net/nicname: Servname not supported for ai_socktype\n   ```\n\n2. 我想起traceroute可能需要调用whois来查询BGP AS号，于是我继续安装whois，仍然报错。----经过验证，如果不安装whois软件包，traceroute -A 8.8.8.8 可正常工作。\n\n3. 只能在网上搜索答案了，果然有人遇到过类似问题：\n\n   ```shell\nhttps://stackoverflow.com/questions/56430294/bash-script-that-uses-whois-command-gets-servname-not-supported-error-on-do\n解决办法：\napt-get update && apt-get install -y --no-install-recommends netbase\n   ```\n\n4. 安装iproute2的目的是为了执行ip a,  ip link 这些命令。\n\n## 根据Dockerfile创建容器镜像\n\n根据上述的Dockerfile创建容器镜像，执行命令：**docker image build -t traceroute:latest .** 注意末尾的小点，表示当前目录。\n\n```shell\n➜  traceroute docker image build -t traceroute:latest .\n[+] Building 48.7s (6/6) FINISHED\n => [internal] load build definition from Dockerfile                                                               0.0s\n => => transferring dockerfile: 274B                                                                               0.0s\n => [internal] load .dockerignore                                                                                  0.0s\n => => transferring context: 2B                                                                                    0.0s\n => [internal] load metadata for docker.io/library/ubuntu:latest                                                   0.0s\n => CACHED [1/2] FROM docker.io/library/ubuntu:latest                                                              0.0s\n => [2/2] RUN apt-get update && apt-get install -y  traceroute  iputils-ping  whois  netbase  iproute2  --no-ins  48.5s\n => exporting to image                                                                                             0.1s\n => => exporting layers                                                                                            0.1s\n => => writing image sha256:bbf499e59136872e8d171fddcd1548497a9e76b96d154dcb340b8326252d97d5                       0.0s\n => => naming to docker.io/library/traceroute:latest                                                               0.0s\n \n➜  traceroute docker images\nREPOSITORY   TAG       IMAGE ID       CREATED          SIZE\ntraceroute   latest    bbf499e59136   5 seconds ago    77.4MB\n```\n\n# 如何抓取容器的网络报文\n\n接下来，需要考虑的问题是在MAC电脑上如何抓取容器的网络报文呢？\n\n## Wireshark on macOS如何抓包？\n\n我执行了docker run -it --name traceroute traceroute 启动了一个名为tracertoute的容器，打开Wireshark，哪一个接口对应的是这个容器的接口呢？\n\n![wireshark-int-list](docker-traceroute-tcpdump/wireshark-int-list.png)\n\n上面的接口眼花缭乱的，找不出是哪一个接口，en0和lo0上有流量，但是并不是容器连接的端口，只得寻求其他方法。\n\n## 基于 Container 网络共享机制来抓包\n\n通过搜索\"how to tcpdump in docker\"，找到一篇文章[How to TCPdump effectively in Docker](https://xxradar.medium.com/how-to-tcpdump-effectively-in-docker-2ed0a09b5406)，获益匪浅。\n\n该文章介绍了一种Docker的网络模式，container模式。\n\n> In the `--net=container:id` all traffic in/out a specific container (or group of containers) can be captured.\n\n另一篇文章：https://www.freeaihub.com/article/container-module-in-docker-network.html\n\n> Docker网络container模式是指，创建新容器的时候，通过`--net container`参数，指定其和已经存在的某个容器共享一个 Network Namespace。如下图所示，右方黄色新创建的container，其网卡共享左边容器。因此就不会拥有自己独立的 IP，而是共享左边容器的 IP 172.17.0.2,端口范围等网络资源，两个容器的进程通过 lo 网卡设备通信。\n>\n> 但这两个容器在其他的资源上，如文件系统、进程列表等还是隔离的。\n>\n> ![container-module-in-docker-network](docker-traceroute-tcpdump/container-module-in-docker-network.png)\n\n专门创建一个安装了tcpdump的容器，对上文创建的traceroute容器进行抓包。\n\n参考[How to TCPdump effectively in Docker](https://xxradar.medium.com/how-to-tcpdump-effectively-in-docker-2ed0a09b5406)，在Terminal中执行以下命令，创建一个tcpdump的容器镜像\n\n```shell\ndocker build -t tcpdump - <<EOF \nFROM ubuntu \nRUN apt-get update && apt-get install -y tcpdump \nCMD tcpdump -i eth0 -w /var/traceroute-ubuntu.pcapng\nEOF\n```\n\n创建过程如下：\n\n```\n[+] Building 0.1s (6/6) FINISHED\n => [internal] load build definition from Dockerfile                                                               0.0s\n => => transferring dockerfile: 159B                                                                               0.0s\n => [internal] load .dockerignore                                                                                  0.0s\n => => transferring context: 2B                                                                                    0.0s\n => [internal] load metadata for docker.io/library/ubuntu:latest                                                   0.0s\n => [1/2] FROM docker.io/library/ubuntu                                                                            0.0s\n => CACHED [2/2] RUN apt-get update && apt-get install -y tcpdump                                                  0.0s\n => exporting to image                                                                                             0.0s\n => => exporting layers                                                                                            0.0s\n => => writing image sha256:d5d8942d4836fabbb0343a082d9aa0009c6dd5071c70a54ae57baf6728462562                       0.0s\n => => naming to docker.io/library/tcpdump                                                                         0.0s\n```\n\n镜像列表：\n\n```shell\n➜  traceroute docker images\nREPOSITORY   TAG       IMAGE ID       CREATED          SIZE\ntcpdump      latest    d5d8942d4836   3 minutes ago    109MB\ntraceroute   latest    bbf499e59136   35 minutes ago   77.4MB\nubuntu       latest    9873176a8ff5   11 days ago      72.7MB\n```\n\n启动traceroute容器：\n\n```shell\n➜ docker run -it --name traceroute traceroute\nroot@fbe3eb98ae63:/#\n```\n\n启动tcpdump容器，进行抓包：\n\n```shell\n➜  ~ docker run -it --net=container:traceroute tcpdump\ntcpdump: listening on eth0, link-type EN10MB (Ethernet), capture size 262144 bytes\n```\n\n在traceroute容器发起traceroute：\n\n```shell\nroot@fbe3eb98ae63:/# traceroute -A -q 1 -N 1 -z 500 -e 8.8.8.8\ntraceroute to 8.8.8.8 (8.8.8.8), 30 hops max, 60 byte packets\n 1  localhost (172.17.0.1) [*]  0.129 ms\n 2  localhost (10.39.101.1) [*]  3.716 ms\n 3  localhost (192.168.1.1) [*]  3.926 ms\n 4  222.129.32.1 (222.129.32.1) [AS4808]  6.837 ms\n 5  61.148.163.181 (61.148.163.181) [AS4808]  9.247 ms\n 6  219.232.11.65 (219.232.11.65) [AS17431]  7.049 ms\n 7  61.149.203.205 (61.149.203.205) [AS4808]  7.650 ms\n 8  219.158.7.22 (219.158.7.22) [AS4837]  40.815 ms\n 9  219.158.103.218 (219.158.103.218) [AS4837]  64.771 ms\n10  219.158.103.30 (219.158.103.30) [AS4837]  50.402 ms\n11  219.158.10.30 (219.158.10.30) [AS4837]  53.261 ms\n12  219.158.33.174 (219.158.33.174) [AS4837]  55.503 ms\n13  108.170.241.65 (108.170.241.65) [AS15169]  54.876 ms\n14  142.251.64.173 (142.251.64.173) [AS15169]  45.966 ms\n15  dns.google (8.8.8.8) [AS15169]  52.492 ms\n```\n\n**traceroute -A -q 1 -N 1 -z 500 -e 8.8.8.8** 参数解释如下：\n\n- -A： \t向radb.net查找对应节点IP所在的AS Path信息，并将查询信息输出\n- -q 1：  将缺省发送3个探测包改为1个\n- -N 1： 将并发16个探测改为一次一个，以便于逐个分析\n- -z 500： 表示每次等待500毫秒再发出下一个探测\n- -e：    显示ICMP的扩展消息，如果有的话\n\n按下CTRL+C，停止tcpdump容器的抓包：\n\n```shell\n➜  ~ docker run -it --net=container:traceroute tcpdump\ntcpdump: listening on eth0, link-type EN10MB (Ethernet), capture size 262144 bytes\n^C237 packets captured\n237 packets received by filter\n0 packets dropped by kernel\n```\n\n该容器在抓完包后自动停止，并将抓包文件存储在容器内部的/var/traceroute-ubuntu.pcapng，通过**docker cp**命令将抓包文件拷贝出来。\n\n```shell\n➜  ~ docker ps -a\nCONTAINER ID   IMAGE        COMMAND                  CREATED          STATUS                        PORTS     NAMES\nf397f50267ae   tcpdump      \"/bin/sh -c 'tcpdump…\"   2 minutes ago    Exited (130) 20 seconds ago             condescending_cori\nfbe3eb98ae63   traceroute   \"bash\"                   48 minutes ago   Up 48 minutes                           traceroute\n➜  ~ docker cp f397f50267ae:/var/traceroute-ubuntu.pcapng ./\n```\n\n# 简略分析抓包文件\n\n以下是本次抓取的237个报文的头36个报文，如下：\n\n![docker-packet1-36](docker-traceroute-tcpdump/docker-packet1-36.png)\n\n上图中，Wireshare直接分析出来Whois报文。\n\n过程概述如下：\n\n1. 向8.8.8.8发起UDP报文，目的端口为**33434**，TTL设置为1\n2. 收到路由器的ICMP TTL超时消息，获取路由器对应的IP地址\n3. 尝试向DNS服务器查询路由器IP地址的反向域名解析，如果得到域名，就将其显示在Traceroute的输出结果中。\n4. 发起DNS查询，查询**whois.radb.net**域名，得到应答为198.108.0.18\n5. 发起TCP连接请求，与198.108.0.18建立TCP连接。\n6. 向**whois.radb.net**发起查询，询问路由器IP地址对应的AS号，并得到回应，如果是私有地址，其AS号为0。\n7. 重复上述第1、2、3、6步，每次将TTL加1，直至目标地址接收到探测报文，并返回ICMP Port Unreachable消息。\n\n[抓包文件下载](docker-traceroute-tcpdump/traceroute-ubuntu.pcapng)\n\n# 番外篇\n\nThousandEyes的介绍可参考这篇文章[《在AWS上部署TE Agent并进行测试》](https://weiborao.github.io/deploy-thousandeyes-agent-on-aws.html)。\n\nThousandEyes可将探针部署到容器中，而且安装十分简单，从ThousandEyes的Cloud & Enterprise Agents中，选择Agent Settings，再选择Enterprise Agents，再点击Add New Enterprise Agent，切换到Docker这个TAB。\n\n![te-agent-docker](docker-traceroute-tcpdump/te-agent-docker.png)\n\n将下面的文字复制粘贴到Terminal终端：\n\n```shell\ndocker pull thousandeyes/enterprise-agent > /dev/null 2>&1\ndocker stop 'TEagent' > /dev/null 2>&1\ndocker rm 'TEagent' > /dev/null 2>&1\ndocker run \\\n  --hostname='TEagent' \\\n  --memory=2g \\\n  --memory-swap=2g \\\n  --detach=true \\\n  --tty=true \\\n  --shm-size=512M \\\n  -e TEAGENT_ACCOUNT_TOKEN=lje1co39qi       8b5oviy \\\n  -e TEAGENT_INET=4 \\\n  -v '/Users/werao/thousandeyes/TEagent/te-agent':/var/lib/te-agent \\\n  -v '/Users/werao/thousandeyes/TEagent/te-browserbot':/var/lib/te-browserbot \\\n  -v '/Users/werao/thousandeyes/TEagent/log/':/var/log/agent \\\n  --cap-add=NET_ADMIN \\\n  --cap-add=SYS_ADMIN \\\n  --name 'TEagent' \\\n  --restart=unless-stopped \\\n  thousandeyes/enterprise-agent /sbin/my_init\n```\n\n安装完后，ThousandEyes即可使用该Agent进行测试了。\n\n创建一个简单的探测如下：\n\n![probe-anycast-dns](docker-traceroute-tcpdump/probe-anycast-dns.png)\n\n在ThousandEyes的界面，可观测上述的探测结果：\n\n时延比较稳定，维持在50ms左右。\n\n![thousandeyes-path](docker-traceroute-tcpdump/thousandeyes-path.png)\n\n路径可视化分析中，当我们把鼠标落在某个节点上，网页会弹出交互式的信息，包括：\n\n- 网络前缀信息，如：124.65.192.0/18\n- 运营商AS信息，如：CNCGROUP Beijing Province (AS 4808)\n- 地理位置，如：Beijing, Beijing, China\n- DSCP\n- 平均时延，指从探测的Agent到对应节点的平均时延\n\n![thousandeyes-path-node1](docker-traceroute-tcpdump/thousandeyes-path-node1.png)\n\n![thousandeyes-path-node2](docker-traceroute-tcpdump/thousandeyes-path-node2.png)\n\n![thousandeyes-path-node3](docker-traceroute-tcpdump/thousandeyes-path-node3.png)\n\n\n\nThousandEyes的探针所收集的数据是常规的网络工具都能收集到的，ThousandEyes的平台对收集到的数据进行存储、分析、交叉关联，为用户的数字体验提供全方位的洞见。\n\n本节是突发奇想的内容，故而放到番外篇。\n\n\n\n全文完。\n","slug":"docker-traceroute-tcpdump","published":1,"updated":"2025-12-14T09:50:07.448Z","comments":1,"layout":"post","photos":[],"_id":"cuid4D4jqFLyj5HtJ5uWNkV-p","content":"<p>在上一篇文章<a href=\"https://weiborao.github.io/get-known-traceroute-by-wireshark.html\">《通过Wireshark重新认识Traceroute》</a>中，我在MAC电脑上进行抓包来对MAC上的Traceroute过程进行分析。但是MAC电脑上运行了多个应用，我在抓完报文后，使用过滤器将其他报文过滤掉了，但是也很可能把Traceroute产生的报文给删掉了。</p>\n<p>为了打造一个纯净的Traceroute环境，我又使用容器来做一次测试。</p>\n<p>本文记录以下内容：</p>\n<ol>\n<li>创建一个包含traceroute、ping、whois等工具的容器，取名traceroute</li>\n<li>创建一个只包含tcpdump的容器，对traceroute容器抓包</li>\n<li>简略的分析抓包文件—-不是本文重点</li>\n</ol>\n<h1 id=\"创建Traceroute容器镜像\"><a href=\"#创建Traceroute容器镜像\" class=\"headerlink\" title=\"创建Traceroute容器镜像\"></a>创建Traceroute容器镜像</h1><h2 id=\"Dockerfile准备\"><a href=\"#Dockerfile准备\" class=\"headerlink\" title=\"Dockerfile准备\"></a>Dockerfile准备</h2><p>如果我们执行<strong>docker run -it ubuntu</strong>，想在该容器中执行ping、traceroute命令，抱歉，找不到该命令。</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  docker pull ubuntu</span><br><span class=\"line\">➜  docker run -it --rm ubuntu</span><br><span class=\"line\">root@631c227046f7:/# ping 8.8.8.8</span><br><span class=\"line\">bash: ping: command not found</span><br><span class=\"line\">root@631c227046f7:/# traceroute 8.8.8.8</span><br><span class=\"line\">bash: traceroute: command not found</span><br><span class=\"line\">root@631c227046f7:/#</span><br></pre></td></tr></table></figure>\n\n<p>这时候，您可以直接在容器里执行：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@631c227046f7:/# apt-get update &amp;&amp; apt-get install traceroute iputils-ping --no-install-recommends</span><br></pre></td></tr></table></figure>\n\n<p>当然，您也可以创建一个容器镜像，如下：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mkdir traceroute</span><br><span class=\"line\">cd traceroute</span><br><span class=\"line\">touch Dockerfile</span><br></pre></td></tr></table></figure>\n\n<p>Dockerfile 内容如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">FROM ubuntu:latest</span><br><span class=\"line\"></span><br><span class=\"line\">RUN apt-get update &amp;&amp; apt-get install -y \\</span><br><span class=\"line\">\ttraceroute \\</span><br><span class=\"line\">\tiputils-ping \\</span><br><span class=\"line\">\twhois \\</span><br><span class=\"line\">\tnetbase \\</span><br><span class=\"line\">\tiproute2 \\</span><br><span class=\"line\">\t--no-install-recommends \\</span><br><span class=\"line\">\t&amp;&amp; rm -rf /var/lib/apt/lists/*</span><br></pre></td></tr></table></figure>\n\n<p>注：上述要安装的软件包，是我经过尝试后，一个个增加的。</p>\n<ol>\n<li><p>最开始我只安装了traceroute，当我执行traceroute -A 8.8.8.8时，提示如下错误信息：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">whois.radb.net/nicname: Servname not supported for ai_socktype</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>我想起traceroute可能需要调用whois来查询BGP AS号，于是我继续安装whois，仍然报错。—-经过验证，如果不安装whois软件包，traceroute -A 8.8.8.8 可正常工作。</p>\n</li>\n<li><p>只能在网上搜索答案了，果然有人遇到过类似问题：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">https://stackoverflow.com/questions/56430294/bash-script-that-uses-whois-command-gets-servname-not-supported-error-on-do</span><br><span class=\"line\">解决办法：</span><br><span class=\"line\">apt-get update &amp;&amp; apt-get install -y --no-install-recommends netbase</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>安装iproute2的目的是为了执行ip a,  ip link 这些命令。</p>\n</li>\n</ol>\n<h2 id=\"根据Dockerfile创建容器镜像\"><a href=\"#根据Dockerfile创建容器镜像\" class=\"headerlink\" title=\"根据Dockerfile创建容器镜像\"></a>根据Dockerfile创建容器镜像</h2><p>根据上述的Dockerfile创建容器镜像，执行命令：<strong>docker image build -t traceroute:latest .</strong> 注意末尾的小点，表示当前目录。</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  traceroute docker image build -t traceroute:latest .</span><br><span class=\"line\">[+] Building 48.7s (6/6) FINISHED</span><br><span class=\"line\"> =&gt; [internal] load build definition from Dockerfile                                                               0.0s</span><br><span class=\"line\"> =&gt; =&gt; transferring dockerfile: 274B                                                                               0.0s</span><br><span class=\"line\"> =&gt; [internal] load .dockerignore                                                                                  0.0s</span><br><span class=\"line\"> =&gt; =&gt; transferring context: 2B                                                                                    0.0s</span><br><span class=\"line\"> =&gt; [internal] load metadata for docker.io/library/ubuntu:latest                                                   0.0s</span><br><span class=\"line\"> =&gt; CACHED [1/2] FROM docker.io/library/ubuntu:latest                                                              0.0s</span><br><span class=\"line\"> =&gt; [2/2] RUN apt-get update &amp;&amp; apt-get install -y  traceroute  iputils-ping  whois  netbase  iproute2  --no-ins  48.5s</span><br><span class=\"line\"> =&gt; exporting to image                                                                                             0.1s</span><br><span class=\"line\"> =&gt; =&gt; exporting layers                                                                                            0.1s</span><br><span class=\"line\"> =&gt; =&gt; writing image sha256:bbf499e59136872e8d171fddcd1548497a9e76b96d154dcb340b8326252d97d5                       0.0s</span><br><span class=\"line\"> =&gt; =&gt; naming to docker.io/library/traceroute:latest                                                               0.0s</span><br><span class=\"line\"> </span><br><span class=\"line\">➜  traceroute docker images</span><br><span class=\"line\">REPOSITORY   TAG       IMAGE ID       CREATED          SIZE</span><br><span class=\"line\">traceroute   latest    bbf499e59136   5 seconds ago    77.4MB</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"如何抓取容器的网络报文\"><a href=\"#如何抓取容器的网络报文\" class=\"headerlink\" title=\"如何抓取容器的网络报文\"></a>如何抓取容器的网络报文</h1><p>接下来，需要考虑的问题是在MAC电脑上如何抓取容器的网络报文呢？</p>\n<h2 id=\"Wireshark-on-macOS如何抓包？\"><a href=\"#Wireshark-on-macOS如何抓包？\" class=\"headerlink\" title=\"Wireshark on macOS如何抓包？\"></a>Wireshark on macOS如何抓包？</h2><p>我执行了docker run -it –name traceroute traceroute 启动了一个名为tracertoute的容器，打开Wireshark，哪一个接口对应的是这个容器的接口呢？</p>\n<p><img src=\"/docker-traceroute-tcpdump/wireshark-int-list.png\" alt=\"wireshark-int-list\"></p>\n<p>上面的接口眼花缭乱的，找不出是哪一个接口，en0和lo0上有流量，但是并不是容器连接的端口，只得寻求其他方法。</p>\n<h2 id=\"基于-Container-网络共享机制来抓包\"><a href=\"#基于-Container-网络共享机制来抓包\" class=\"headerlink\" title=\"基于 Container 网络共享机制来抓包\"></a>基于 Container 网络共享机制来抓包</h2><p>通过搜索”how to tcpdump in docker”，找到一篇文章<a href=\"https://xxradar.medium.com/how-to-tcpdump-effectively-in-docker-2ed0a09b5406\">How to TCPdump effectively in Docker</a>，获益匪浅。</p>\n<p>该文章介绍了一种Docker的网络模式，container模式。</p>\n<blockquote>\n<p>In the <code>--net=container:id</code> all traffic in&#x2F;out a specific container (or group of containers) can be captured.</p>\n</blockquote>\n<p>另一篇文章：<a href=\"https://www.freeaihub.com/article/container-module-in-docker-network.html\">https://www.freeaihub.com/article/container-module-in-docker-network.html</a></p>\n<blockquote>\n<p>Docker网络container模式是指，创建新容器的时候，通过<code>--net container</code>参数，指定其和已经存在的某个容器共享一个 Network Namespace。如下图所示，右方黄色新创建的container，其网卡共享左边容器。因此就不会拥有自己独立的 IP，而是共享左边容器的 IP 172.17.0.2,端口范围等网络资源，两个容器的进程通过 lo 网卡设备通信。</p>\n<p>但这两个容器在其他的资源上，如文件系统、进程列表等还是隔离的。</p>\n<p><img src=\"/docker-traceroute-tcpdump/container-module-in-docker-network.png\" alt=\"container-module-in-docker-network\"></p>\n</blockquote>\n<p>专门创建一个安装了tcpdump的容器，对上文创建的traceroute容器进行抓包。</p>\n<p>参考<a href=\"https://xxradar.medium.com/how-to-tcpdump-effectively-in-docker-2ed0a09b5406\">How to TCPdump effectively in Docker</a>，在Terminal中执行以下命令，创建一个tcpdump的容器镜像</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker build -t tcpdump - &lt;&lt;EOF </span><br><span class=\"line\">FROM ubuntu </span><br><span class=\"line\">RUN apt-get update &amp;&amp; apt-get install -y tcpdump </span><br><span class=\"line\">CMD tcpdump -i eth0 -w /var/traceroute-ubuntu.pcapng</span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure>\n\n<p>创建过程如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[+] Building 0.1s (6/6) FINISHED</span><br><span class=\"line\"> =&gt; [internal] load build definition from Dockerfile                                                               0.0s</span><br><span class=\"line\"> =&gt; =&gt; transferring dockerfile: 159B                                                                               0.0s</span><br><span class=\"line\"> =&gt; [internal] load .dockerignore                                                                                  0.0s</span><br><span class=\"line\"> =&gt; =&gt; transferring context: 2B                                                                                    0.0s</span><br><span class=\"line\"> =&gt; [internal] load metadata for docker.io/library/ubuntu:latest                                                   0.0s</span><br><span class=\"line\"> =&gt; [1/2] FROM docker.io/library/ubuntu                                                                            0.0s</span><br><span class=\"line\"> =&gt; CACHED [2/2] RUN apt-get update &amp;&amp; apt-get install -y tcpdump                                                  0.0s</span><br><span class=\"line\"> =&gt; exporting to image                                                                                             0.0s</span><br><span class=\"line\"> =&gt; =&gt; exporting layers                                                                                            0.0s</span><br><span class=\"line\"> =&gt; =&gt; writing image sha256:d5d8942d4836fabbb0343a082d9aa0009c6dd5071c70a54ae57baf6728462562                       0.0s</span><br><span class=\"line\"> =&gt; =&gt; naming to docker.io/library/tcpdump                                                                         0.0s</span><br></pre></td></tr></table></figure>\n\n<p>镜像列表：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  traceroute docker images</span><br><span class=\"line\">REPOSITORY   TAG       IMAGE ID       CREATED          SIZE</span><br><span class=\"line\">tcpdump      latest    d5d8942d4836   3 minutes ago    109MB</span><br><span class=\"line\">traceroute   latest    bbf499e59136   35 minutes ago   77.4MB</span><br><span class=\"line\">ubuntu       latest    9873176a8ff5   11 days ago      72.7MB</span><br></pre></td></tr></table></figure>\n\n<p>启动traceroute容器：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜ docker run -it --name traceroute traceroute</span><br><span class=\"line\">root@fbe3eb98ae63:/#</span><br></pre></td></tr></table></figure>\n\n<p>启动tcpdump容器，进行抓包：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  ~ docker run -it --net=container:traceroute tcpdump</span><br><span class=\"line\">tcpdump: listening on eth0, link-type EN10MB (Ethernet), capture size 262144 bytes</span><br></pre></td></tr></table></figure>\n\n<p>在traceroute容器发起traceroute：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@fbe3eb98ae63:/# traceroute -A -q 1 -N 1 -z 500 -e 8.8.8.8</span><br><span class=\"line\">traceroute to 8.8.8.8 (8.8.8.8), 30 hops max, 60 byte packets</span><br><span class=\"line\"> 1  localhost (172.17.0.1) [*]  0.129 ms</span><br><span class=\"line\"> 2  localhost (10.39.101.1) [*]  3.716 ms</span><br><span class=\"line\"> 3  localhost (192.168.1.1) [*]  3.926 ms</span><br><span class=\"line\"> 4  222.129.32.1 (222.129.32.1) [AS4808]  6.837 ms</span><br><span class=\"line\"> 5  61.148.163.181 (61.148.163.181) [AS4808]  9.247 ms</span><br><span class=\"line\"> 6  219.232.11.65 (219.232.11.65) [AS17431]  7.049 ms</span><br><span class=\"line\"> 7  61.149.203.205 (61.149.203.205) [AS4808]  7.650 ms</span><br><span class=\"line\"> 8  219.158.7.22 (219.158.7.22) [AS4837]  40.815 ms</span><br><span class=\"line\"> 9  219.158.103.218 (219.158.103.218) [AS4837]  64.771 ms</span><br><span class=\"line\">10  219.158.103.30 (219.158.103.30) [AS4837]  50.402 ms</span><br><span class=\"line\">11  219.158.10.30 (219.158.10.30) [AS4837]  53.261 ms</span><br><span class=\"line\">12  219.158.33.174 (219.158.33.174) [AS4837]  55.503 ms</span><br><span class=\"line\">13  108.170.241.65 (108.170.241.65) [AS15169]  54.876 ms</span><br><span class=\"line\">14  142.251.64.173 (142.251.64.173) [AS15169]  45.966 ms</span><br><span class=\"line\">15  dns.google (8.8.8.8) [AS15169]  52.492 ms</span><br></pre></td></tr></table></figure>\n\n<p><strong>traceroute -A -q 1 -N 1 -z 500 -e 8.8.8.8</strong> 参数解释如下：</p>\n<ul>\n<li>-A： \t向radb.net查找对应节点IP所在的AS Path信息，并将查询信息输出</li>\n<li>-q 1：  将缺省发送3个探测包改为1个</li>\n<li>-N 1： 将并发16个探测改为一次一个，以便于逐个分析</li>\n<li>-z 500： 表示每次等待500毫秒再发出下一个探测</li>\n<li>-e：    显示ICMP的扩展消息，如果有的话</li>\n</ul>\n<p>按下CTRL+C，停止tcpdump容器的抓包：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  ~ docker run -it --net=container:traceroute tcpdump</span><br><span class=\"line\">tcpdump: listening on eth0, link-type EN10MB (Ethernet), capture size 262144 bytes</span><br><span class=\"line\">^C237 packets captured</span><br><span class=\"line\">237 packets received by filter</span><br><span class=\"line\">0 packets dropped by kernel</span><br></pre></td></tr></table></figure>\n\n<p>该容器在抓完包后自动停止，并将抓包文件存储在容器内部的&#x2F;var&#x2F;traceroute-ubuntu.pcapng，通过<strong>docker cp</strong>命令将抓包文件拷贝出来。</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  ~ docker ps -a</span><br><span class=\"line\">CONTAINER ID   IMAGE        COMMAND                  CREATED          STATUS                        PORTS     NAMES</span><br><span class=\"line\">f397f50267ae   tcpdump      &quot;/bin/sh -c &#x27;tcpdump…&quot;   2 minutes ago    Exited (130) 20 seconds ago             condescending_cori</span><br><span class=\"line\">fbe3eb98ae63   traceroute   &quot;bash&quot;                   48 minutes ago   Up 48 minutes                           traceroute</span><br><span class=\"line\">➜  ~ docker cp f397f50267ae:/var/traceroute-ubuntu.pcapng ./</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"简略分析抓包文件\"><a href=\"#简略分析抓包文件\" class=\"headerlink\" title=\"简略分析抓包文件\"></a>简略分析抓包文件</h1><p>以下是本次抓取的237个报文的头36个报文，如下：</p>\n<p><img src=\"/docker-traceroute-tcpdump/docker-packet1-36.png\" alt=\"docker-packet1-36\"></p>\n<p>上图中，Wireshare直接分析出来Whois报文。</p>\n<p>过程概述如下：</p>\n<ol>\n<li>向8.8.8.8发起UDP报文，目的端口为<strong>33434</strong>，TTL设置为1</li>\n<li>收到路由器的ICMP TTL超时消息，获取路由器对应的IP地址</li>\n<li>尝试向DNS服务器查询路由器IP地址的反向域名解析，如果得到域名，就将其显示在Traceroute的输出结果中。</li>\n<li>发起DNS查询，查询<strong>whois.radb.net</strong>域名，得到应答为198.108.0.18</li>\n<li>发起TCP连接请求，与198.108.0.18建立TCP连接。</li>\n<li>向<strong>whois.radb.net</strong>发起查询，询问路由器IP地址对应的AS号，并得到回应，如果是私有地址，其AS号为0。</li>\n<li>重复上述第1、2、3、6步，每次将TTL加1，直至目标地址接收到探测报文，并返回ICMP Port Unreachable消息。</li>\n</ol>\n<p><a href=\"docker-traceroute-tcpdump/traceroute-ubuntu.pcapng\">抓包文件下载</a></p>\n<h1 id=\"番外篇\"><a href=\"#番外篇\" class=\"headerlink\" title=\"番外篇\"></a>番外篇</h1><p>ThousandEyes的介绍可参考这篇文章<a href=\"https://weiborao.github.io/deploy-thousandeyes-agent-on-aws.html\">《在AWS上部署TE Agent并进行测试》</a>。</p>\n<p>ThousandEyes可将探针部署到容器中，而且安装十分简单，从ThousandEyes的Cloud &amp; Enterprise Agents中，选择Agent Settings，再选择Enterprise Agents，再点击Add New Enterprise Agent，切换到Docker这个TAB。</p>\n<p><img src=\"/docker-traceroute-tcpdump/te-agent-docker.png\" alt=\"te-agent-docker\"></p>\n<p>将下面的文字复制粘贴到Terminal终端：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker pull thousandeyes/enterprise-agent &gt; /dev/null 2&gt;&amp;1</span><br><span class=\"line\">docker stop &#x27;TEagent&#x27; &gt; /dev/null 2&gt;&amp;1</span><br><span class=\"line\">docker rm &#x27;TEagent&#x27; &gt; /dev/null 2&gt;&amp;1</span><br><span class=\"line\">docker run \\</span><br><span class=\"line\">  --hostname=&#x27;TEagent&#x27; \\</span><br><span class=\"line\">  --memory=2g \\</span><br><span class=\"line\">  --memory-swap=2g \\</span><br><span class=\"line\">  --detach=true \\</span><br><span class=\"line\">  --tty=true \\</span><br><span class=\"line\">  --shm-size=512M \\</span><br><span class=\"line\">  -e TEAGENT_ACCOUNT_TOKEN=lje1co39qi       8b5oviy \\</span><br><span class=\"line\">  -e TEAGENT_INET=4 \\</span><br><span class=\"line\">  -v &#x27;/Users/werao/thousandeyes/TEagent/te-agent&#x27;:/var/lib/te-agent \\</span><br><span class=\"line\">  -v &#x27;/Users/werao/thousandeyes/TEagent/te-browserbot&#x27;:/var/lib/te-browserbot \\</span><br><span class=\"line\">  -v &#x27;/Users/werao/thousandeyes/TEagent/log/&#x27;:/var/log/agent \\</span><br><span class=\"line\">  --cap-add=NET_ADMIN \\</span><br><span class=\"line\">  --cap-add=SYS_ADMIN \\</span><br><span class=\"line\">  --name &#x27;TEagent&#x27; \\</span><br><span class=\"line\">  --restart=unless-stopped \\</span><br><span class=\"line\">  thousandeyes/enterprise-agent /sbin/my_init</span><br></pre></td></tr></table></figure>\n\n<p>安装完后，ThousandEyes即可使用该Agent进行测试了。</p>\n<p>创建一个简单的探测如下：</p>\n<p><img src=\"/docker-traceroute-tcpdump/probe-anycast-dns.png\" alt=\"probe-anycast-dns\"></p>\n<p>在ThousandEyes的界面，可观测上述的探测结果：</p>\n<p>时延比较稳定，维持在50ms左右。</p>\n<p><img src=\"/docker-traceroute-tcpdump/thousandeyes-path.png\" alt=\"thousandeyes-path\"></p>\n<p>路径可视化分析中，当我们把鼠标落在某个节点上，网页会弹出交互式的信息，包括：</p>\n<ul>\n<li>网络前缀信息，如：124.65.192.0&#x2F;18</li>\n<li>运营商AS信息，如：CNCGROUP Beijing Province (AS 4808)</li>\n<li>地理位置，如：Beijing, Beijing, China</li>\n<li>DSCP</li>\n<li>平均时延，指从探测的Agent到对应节点的平均时延</li>\n</ul>\n<p><img src=\"/docker-traceroute-tcpdump/thousandeyes-path-node1.png\" alt=\"thousandeyes-path-node1\"></p>\n<p><img src=\"/docker-traceroute-tcpdump/thousandeyes-path-node2.png\" alt=\"thousandeyes-path-node2\"></p>\n<p><img src=\"/docker-traceroute-tcpdump/thousandeyes-path-node3.png\" alt=\"thousandeyes-path-node3\"></p>\n<p>ThousandEyes的探针所收集的数据是常规的网络工具都能收集到的，ThousandEyes的平台对收集到的数据进行存储、分析、交叉关联，为用户的数字体验提供全方位的洞见。</p>\n<p>本节是突发奇想的内容，故而放到番外篇。</p>\n<p>全文完。</p>\n","length":2276,"excerpt":"","more":"<p>在上一篇文章<a href=\"https://weiborao.github.io/get-known-traceroute-by-wireshark.html\">《通过Wireshark重新认识Traceroute》</a>中，我在MAC电脑上进行抓包来对MAC上的Traceroute过程进行分析。但是MAC电脑上运行了多个应用，我在抓完报文后，使用过滤器将其他报文过滤掉了，但是也很可能把Traceroute产生的报文给删掉了。</p>\n<p>为了打造一个纯净的Traceroute环境，我又使用容器来做一次测试。</p>\n<p>本文记录以下内容：</p>\n<ol>\n<li>创建一个包含traceroute、ping、whois等工具的容器，取名traceroute</li>\n<li>创建一个只包含tcpdump的容器，对traceroute容器抓包</li>\n<li>简略的分析抓包文件—-不是本文重点</li>\n</ol>\n<h1 id=\"创建Traceroute容器镜像\"><a href=\"#创建Traceroute容器镜像\" class=\"headerlink\" title=\"创建Traceroute容器镜像\"></a>创建Traceroute容器镜像</h1><h2 id=\"Dockerfile准备\"><a href=\"#Dockerfile准备\" class=\"headerlink\" title=\"Dockerfile准备\"></a>Dockerfile准备</h2><p>如果我们执行<strong>docker run -it ubuntu</strong>，想在该容器中执行ping、traceroute命令，抱歉，找不到该命令。</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  docker pull ubuntu</span><br><span class=\"line\">➜  docker run -it --rm ubuntu</span><br><span class=\"line\">root@631c227046f7:/# ping 8.8.8.8</span><br><span class=\"line\">bash: ping: command not found</span><br><span class=\"line\">root@631c227046f7:/# traceroute 8.8.8.8</span><br><span class=\"line\">bash: traceroute: command not found</span><br><span class=\"line\">root@631c227046f7:/#</span><br></pre></td></tr></table></figure>\n\n<p>这时候，您可以直接在容器里执行：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@631c227046f7:/# apt-get update &amp;&amp; apt-get install traceroute iputils-ping --no-install-recommends</span><br></pre></td></tr></table></figure>\n\n<p>当然，您也可以创建一个容器镜像，如下：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mkdir traceroute</span><br><span class=\"line\">cd traceroute</span><br><span class=\"line\">touch Dockerfile</span><br></pre></td></tr></table></figure>\n\n<p>Dockerfile 内容如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">FROM ubuntu:latest</span><br><span class=\"line\"></span><br><span class=\"line\">RUN apt-get update &amp;&amp; apt-get install -y \\</span><br><span class=\"line\">\ttraceroute \\</span><br><span class=\"line\">\tiputils-ping \\</span><br><span class=\"line\">\twhois \\</span><br><span class=\"line\">\tnetbase \\</span><br><span class=\"line\">\tiproute2 \\</span><br><span class=\"line\">\t--no-install-recommends \\</span><br><span class=\"line\">\t&amp;&amp; rm -rf /var/lib/apt/lists/*</span><br></pre></td></tr></table></figure>\n\n<p>注：上述要安装的软件包，是我经过尝试后，一个个增加的。</p>\n<ol>\n<li><p>最开始我只安装了traceroute，当我执行traceroute -A 8.8.8.8时，提示如下错误信息：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">whois.radb.net/nicname: Servname not supported for ai_socktype</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>我想起traceroute可能需要调用whois来查询BGP AS号，于是我继续安装whois，仍然报错。—-经过验证，如果不安装whois软件包，traceroute -A 8.8.8.8 可正常工作。</p>\n</li>\n<li><p>只能在网上搜索答案了，果然有人遇到过类似问题：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">https://stackoverflow.com/questions/56430294/bash-script-that-uses-whois-command-gets-servname-not-supported-error-on-do</span><br><span class=\"line\">解决办法：</span><br><span class=\"line\">apt-get update &amp;&amp; apt-get install -y --no-install-recommends netbase</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>安装iproute2的目的是为了执行ip a,  ip link 这些命令。</p>\n</li>\n</ol>\n<h2 id=\"根据Dockerfile创建容器镜像\"><a href=\"#根据Dockerfile创建容器镜像\" class=\"headerlink\" title=\"根据Dockerfile创建容器镜像\"></a>根据Dockerfile创建容器镜像</h2><p>根据上述的Dockerfile创建容器镜像，执行命令：<strong>docker image build -t traceroute:latest .</strong> 注意末尾的小点，表示当前目录。</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  traceroute docker image build -t traceroute:latest .</span><br><span class=\"line\">[+] Building 48.7s (6/6) FINISHED</span><br><span class=\"line\"> =&gt; [internal] load build definition from Dockerfile                                                               0.0s</span><br><span class=\"line\"> =&gt; =&gt; transferring dockerfile: 274B                                                                               0.0s</span><br><span class=\"line\"> =&gt; [internal] load .dockerignore                                                                                  0.0s</span><br><span class=\"line\"> =&gt; =&gt; transferring context: 2B                                                                                    0.0s</span><br><span class=\"line\"> =&gt; [internal] load metadata for docker.io/library/ubuntu:latest                                                   0.0s</span><br><span class=\"line\"> =&gt; CACHED [1/2] FROM docker.io/library/ubuntu:latest                                                              0.0s</span><br><span class=\"line\"> =&gt; [2/2] RUN apt-get update &amp;&amp; apt-get install -y  traceroute  iputils-ping  whois  netbase  iproute2  --no-ins  48.5s</span><br><span class=\"line\"> =&gt; exporting to image                                                                                             0.1s</span><br><span class=\"line\"> =&gt; =&gt; exporting layers                                                                                            0.1s</span><br><span class=\"line\"> =&gt; =&gt; writing image sha256:bbf499e59136872e8d171fddcd1548497a9e76b96d154dcb340b8326252d97d5                       0.0s</span><br><span class=\"line\"> =&gt; =&gt; naming to docker.io/library/traceroute:latest                                                               0.0s</span><br><span class=\"line\"> </span><br><span class=\"line\">➜  traceroute docker images</span><br><span class=\"line\">REPOSITORY   TAG       IMAGE ID       CREATED          SIZE</span><br><span class=\"line\">traceroute   latest    bbf499e59136   5 seconds ago    77.4MB</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"如何抓取容器的网络报文\"><a href=\"#如何抓取容器的网络报文\" class=\"headerlink\" title=\"如何抓取容器的网络报文\"></a>如何抓取容器的网络报文</h1><p>接下来，需要考虑的问题是在MAC电脑上如何抓取容器的网络报文呢？</p>\n<h2 id=\"Wireshark-on-macOS如何抓包？\"><a href=\"#Wireshark-on-macOS如何抓包？\" class=\"headerlink\" title=\"Wireshark on macOS如何抓包？\"></a>Wireshark on macOS如何抓包？</h2><p>我执行了docker run -it –name traceroute traceroute 启动了一个名为tracertoute的容器，打开Wireshark，哪一个接口对应的是这个容器的接口呢？</p>\n<p><img src=\"/docker-traceroute-tcpdump/wireshark-int-list.png\" alt=\"wireshark-int-list\"></p>\n<p>上面的接口眼花缭乱的，找不出是哪一个接口，en0和lo0上有流量，但是并不是容器连接的端口，只得寻求其他方法。</p>\n<h2 id=\"基于-Container-网络共享机制来抓包\"><a href=\"#基于-Container-网络共享机制来抓包\" class=\"headerlink\" title=\"基于 Container 网络共享机制来抓包\"></a>基于 Container 网络共享机制来抓包</h2><p>通过搜索”how to tcpdump in docker”，找到一篇文章<a href=\"https://xxradar.medium.com/how-to-tcpdump-effectively-in-docker-2ed0a09b5406\">How to TCPdump effectively in Docker</a>，获益匪浅。</p>\n<p>该文章介绍了一种Docker的网络模式，container模式。</p>\n<blockquote>\n<p>In the <code>--net=container:id</code> all traffic in&#x2F;out a specific container (or group of containers) can be captured.</p>\n</blockquote>\n<p>另一篇文章：<a href=\"https://www.freeaihub.com/article/container-module-in-docker-network.html\">https://www.freeaihub.com/article/container-module-in-docker-network.html</a></p>\n<blockquote>\n<p>Docker网络container模式是指，创建新容器的时候，通过<code>--net container</code>参数，指定其和已经存在的某个容器共享一个 Network Namespace。如下图所示，右方黄色新创建的container，其网卡共享左边容器。因此就不会拥有自己独立的 IP，而是共享左边容器的 IP 172.17.0.2,端口范围等网络资源，两个容器的进程通过 lo 网卡设备通信。</p>\n<p>但这两个容器在其他的资源上，如文件系统、进程列表等还是隔离的。</p>\n<p><img src=\"/docker-traceroute-tcpdump/container-module-in-docker-network.png\" alt=\"container-module-in-docker-network\"></p>\n</blockquote>\n<p>专门创建一个安装了tcpdump的容器，对上文创建的traceroute容器进行抓包。</p>\n<p>参考<a href=\"https://xxradar.medium.com/how-to-tcpdump-effectively-in-docker-2ed0a09b5406\">How to TCPdump effectively in Docker</a>，在Terminal中执行以下命令，创建一个tcpdump的容器镜像</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker build -t tcpdump - &lt;&lt;EOF </span><br><span class=\"line\">FROM ubuntu </span><br><span class=\"line\">RUN apt-get update &amp;&amp; apt-get install -y tcpdump </span><br><span class=\"line\">CMD tcpdump -i eth0 -w /var/traceroute-ubuntu.pcapng</span><br><span class=\"line\">EOF</span><br></pre></td></tr></table></figure>\n\n<p>创建过程如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[+] Building 0.1s (6/6) FINISHED</span><br><span class=\"line\"> =&gt; [internal] load build definition from Dockerfile                                                               0.0s</span><br><span class=\"line\"> =&gt; =&gt; transferring dockerfile: 159B                                                                               0.0s</span><br><span class=\"line\"> =&gt; [internal] load .dockerignore                                                                                  0.0s</span><br><span class=\"line\"> =&gt; =&gt; transferring context: 2B                                                                                    0.0s</span><br><span class=\"line\"> =&gt; [internal] load metadata for docker.io/library/ubuntu:latest                                                   0.0s</span><br><span class=\"line\"> =&gt; [1/2] FROM docker.io/library/ubuntu                                                                            0.0s</span><br><span class=\"line\"> =&gt; CACHED [2/2] RUN apt-get update &amp;&amp; apt-get install -y tcpdump                                                  0.0s</span><br><span class=\"line\"> =&gt; exporting to image                                                                                             0.0s</span><br><span class=\"line\"> =&gt; =&gt; exporting layers                                                                                            0.0s</span><br><span class=\"line\"> =&gt; =&gt; writing image sha256:d5d8942d4836fabbb0343a082d9aa0009c6dd5071c70a54ae57baf6728462562                       0.0s</span><br><span class=\"line\"> =&gt; =&gt; naming to docker.io/library/tcpdump                                                                         0.0s</span><br></pre></td></tr></table></figure>\n\n<p>镜像列表：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  traceroute docker images</span><br><span class=\"line\">REPOSITORY   TAG       IMAGE ID       CREATED          SIZE</span><br><span class=\"line\">tcpdump      latest    d5d8942d4836   3 minutes ago    109MB</span><br><span class=\"line\">traceroute   latest    bbf499e59136   35 minutes ago   77.4MB</span><br><span class=\"line\">ubuntu       latest    9873176a8ff5   11 days ago      72.7MB</span><br></pre></td></tr></table></figure>\n\n<p>启动traceroute容器：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜ docker run -it --name traceroute traceroute</span><br><span class=\"line\">root@fbe3eb98ae63:/#</span><br></pre></td></tr></table></figure>\n\n<p>启动tcpdump容器，进行抓包：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  ~ docker run -it --net=container:traceroute tcpdump</span><br><span class=\"line\">tcpdump: listening on eth0, link-type EN10MB (Ethernet), capture size 262144 bytes</span><br></pre></td></tr></table></figure>\n\n<p>在traceroute容器发起traceroute：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@fbe3eb98ae63:/# traceroute -A -q 1 -N 1 -z 500 -e 8.8.8.8</span><br><span class=\"line\">traceroute to 8.8.8.8 (8.8.8.8), 30 hops max, 60 byte packets</span><br><span class=\"line\"> 1  localhost (172.17.0.1) [*]  0.129 ms</span><br><span class=\"line\"> 2  localhost (10.39.101.1) [*]  3.716 ms</span><br><span class=\"line\"> 3  localhost (192.168.1.1) [*]  3.926 ms</span><br><span class=\"line\"> 4  222.129.32.1 (222.129.32.1) [AS4808]  6.837 ms</span><br><span class=\"line\"> 5  61.148.163.181 (61.148.163.181) [AS4808]  9.247 ms</span><br><span class=\"line\"> 6  219.232.11.65 (219.232.11.65) [AS17431]  7.049 ms</span><br><span class=\"line\"> 7  61.149.203.205 (61.149.203.205) [AS4808]  7.650 ms</span><br><span class=\"line\"> 8  219.158.7.22 (219.158.7.22) [AS4837]  40.815 ms</span><br><span class=\"line\"> 9  219.158.103.218 (219.158.103.218) [AS4837]  64.771 ms</span><br><span class=\"line\">10  219.158.103.30 (219.158.103.30) [AS4837]  50.402 ms</span><br><span class=\"line\">11  219.158.10.30 (219.158.10.30) [AS4837]  53.261 ms</span><br><span class=\"line\">12  219.158.33.174 (219.158.33.174) [AS4837]  55.503 ms</span><br><span class=\"line\">13  108.170.241.65 (108.170.241.65) [AS15169]  54.876 ms</span><br><span class=\"line\">14  142.251.64.173 (142.251.64.173) [AS15169]  45.966 ms</span><br><span class=\"line\">15  dns.google (8.8.8.8) [AS15169]  52.492 ms</span><br></pre></td></tr></table></figure>\n\n<p><strong>traceroute -A -q 1 -N 1 -z 500 -e 8.8.8.8</strong> 参数解释如下：</p>\n<ul>\n<li>-A： \t向radb.net查找对应节点IP所在的AS Path信息，并将查询信息输出</li>\n<li>-q 1：  将缺省发送3个探测包改为1个</li>\n<li>-N 1： 将并发16个探测改为一次一个，以便于逐个分析</li>\n<li>-z 500： 表示每次等待500毫秒再发出下一个探测</li>\n<li>-e：    显示ICMP的扩展消息，如果有的话</li>\n</ul>\n<p>按下CTRL+C，停止tcpdump容器的抓包：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  ~ docker run -it --net=container:traceroute tcpdump</span><br><span class=\"line\">tcpdump: listening on eth0, link-type EN10MB (Ethernet), capture size 262144 bytes</span><br><span class=\"line\">^C237 packets captured</span><br><span class=\"line\">237 packets received by filter</span><br><span class=\"line\">0 packets dropped by kernel</span><br></pre></td></tr></table></figure>\n\n<p>该容器在抓完包后自动停止，并将抓包文件存储在容器内部的&#x2F;var&#x2F;traceroute-ubuntu.pcapng，通过<strong>docker cp</strong>命令将抓包文件拷贝出来。</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  ~ docker ps -a</span><br><span class=\"line\">CONTAINER ID   IMAGE        COMMAND                  CREATED          STATUS                        PORTS     NAMES</span><br><span class=\"line\">f397f50267ae   tcpdump      &quot;/bin/sh -c &#x27;tcpdump…&quot;   2 minutes ago    Exited (130) 20 seconds ago             condescending_cori</span><br><span class=\"line\">fbe3eb98ae63   traceroute   &quot;bash&quot;                   48 minutes ago   Up 48 minutes                           traceroute</span><br><span class=\"line\">➜  ~ docker cp f397f50267ae:/var/traceroute-ubuntu.pcapng ./</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"简略分析抓包文件\"><a href=\"#简略分析抓包文件\" class=\"headerlink\" title=\"简略分析抓包文件\"></a>简略分析抓包文件</h1><p>以下是本次抓取的237个报文的头36个报文，如下：</p>\n<p><img src=\"/docker-traceroute-tcpdump/docker-packet1-36.png\" alt=\"docker-packet1-36\"></p>\n<p>上图中，Wireshare直接分析出来Whois报文。</p>\n<p>过程概述如下：</p>\n<ol>\n<li>向8.8.8.8发起UDP报文，目的端口为<strong>33434</strong>，TTL设置为1</li>\n<li>收到路由器的ICMP TTL超时消息，获取路由器对应的IP地址</li>\n<li>尝试向DNS服务器查询路由器IP地址的反向域名解析，如果得到域名，就将其显示在Traceroute的输出结果中。</li>\n<li>发起DNS查询，查询<strong>whois.radb.net</strong>域名，得到应答为198.108.0.18</li>\n<li>发起TCP连接请求，与198.108.0.18建立TCP连接。</li>\n<li>向<strong>whois.radb.net</strong>发起查询，询问路由器IP地址对应的AS号，并得到回应，如果是私有地址，其AS号为0。</li>\n<li>重复上述第1、2、3、6步，每次将TTL加1，直至目标地址接收到探测报文，并返回ICMP Port Unreachable消息。</li>\n</ol>\n<p><a href=\"docker-traceroute-tcpdump/traceroute-ubuntu.pcapng\">抓包文件下载</a></p>\n<h1 id=\"番外篇\"><a href=\"#番外篇\" class=\"headerlink\" title=\"番外篇\"></a>番外篇</h1><p>ThousandEyes的介绍可参考这篇文章<a href=\"https://weiborao.github.io/deploy-thousandeyes-agent-on-aws.html\">《在AWS上部署TE Agent并进行测试》</a>。</p>\n<p>ThousandEyes可将探针部署到容器中，而且安装十分简单，从ThousandEyes的Cloud &amp; Enterprise Agents中，选择Agent Settings，再选择Enterprise Agents，再点击Add New Enterprise Agent，切换到Docker这个TAB。</p>\n<p><img src=\"/docker-traceroute-tcpdump/te-agent-docker.png\" alt=\"te-agent-docker\"></p>\n<p>将下面的文字复制粘贴到Terminal终端：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker pull thousandeyes/enterprise-agent &gt; /dev/null 2&gt;&amp;1</span><br><span class=\"line\">docker stop &#x27;TEagent&#x27; &gt; /dev/null 2&gt;&amp;1</span><br><span class=\"line\">docker rm &#x27;TEagent&#x27; &gt; /dev/null 2&gt;&amp;1</span><br><span class=\"line\">docker run \\</span><br><span class=\"line\">  --hostname=&#x27;TEagent&#x27; \\</span><br><span class=\"line\">  --memory=2g \\</span><br><span class=\"line\">  --memory-swap=2g \\</span><br><span class=\"line\">  --detach=true \\</span><br><span class=\"line\">  --tty=true \\</span><br><span class=\"line\">  --shm-size=512M \\</span><br><span class=\"line\">  -e TEAGENT_ACCOUNT_TOKEN=lje1co39qi       8b5oviy \\</span><br><span class=\"line\">  -e TEAGENT_INET=4 \\</span><br><span class=\"line\">  -v &#x27;/Users/werao/thousandeyes/TEagent/te-agent&#x27;:/var/lib/te-agent \\</span><br><span class=\"line\">  -v &#x27;/Users/werao/thousandeyes/TEagent/te-browserbot&#x27;:/var/lib/te-browserbot \\</span><br><span class=\"line\">  -v &#x27;/Users/werao/thousandeyes/TEagent/log/&#x27;:/var/log/agent \\</span><br><span class=\"line\">  --cap-add=NET_ADMIN \\</span><br><span class=\"line\">  --cap-add=SYS_ADMIN \\</span><br><span class=\"line\">  --name &#x27;TEagent&#x27; \\</span><br><span class=\"line\">  --restart=unless-stopped \\</span><br><span class=\"line\">  thousandeyes/enterprise-agent /sbin/my_init</span><br></pre></td></tr></table></figure>\n\n<p>安装完后，ThousandEyes即可使用该Agent进行测试了。</p>\n<p>创建一个简单的探测如下：</p>\n<p><img src=\"/docker-traceroute-tcpdump/probe-anycast-dns.png\" alt=\"probe-anycast-dns\"></p>\n<p>在ThousandEyes的界面，可观测上述的探测结果：</p>\n<p>时延比较稳定，维持在50ms左右。</p>\n<p><img src=\"/docker-traceroute-tcpdump/thousandeyes-path.png\" alt=\"thousandeyes-path\"></p>\n<p>路径可视化分析中，当我们把鼠标落在某个节点上，网页会弹出交互式的信息，包括：</p>\n<ul>\n<li>网络前缀信息，如：124.65.192.0&#x2F;18</li>\n<li>运营商AS信息，如：CNCGROUP Beijing Province (AS 4808)</li>\n<li>地理位置，如：Beijing, Beijing, China</li>\n<li>DSCP</li>\n<li>平均时延，指从探测的Agent到对应节点的平均时延</li>\n</ul>\n<p><img src=\"/docker-traceroute-tcpdump/thousandeyes-path-node1.png\" alt=\"thousandeyes-path-node1\"></p>\n<p><img src=\"/docker-traceroute-tcpdump/thousandeyes-path-node2.png\" alt=\"thousandeyes-path-node2\"></p>\n<p><img src=\"/docker-traceroute-tcpdump/thousandeyes-path-node3.png\" alt=\"thousandeyes-path-node3\"></p>\n<p>ThousandEyes的探针所收集的数据是常规的网络工具都能收集到的，ThousandEyes的平台对收集到的数据进行存储、分析、交叉关联，为用户的数字体验提供全方位的洞见。</p>\n<p>本节是突发奇想的内容，故而放到番外篇。</p>\n<p>全文完。</p>\n"},{"title":"Hexo 安装设置遇到的问题及解决办法","date":"2021-02-07T15:36:19.000Z","description":"记录在Hexo安装过程中遇到的Hexo与Node.js版本兼容性的问题，使用nvm安装低版本的node.js解决问题，参考成百川的解决办法。","_content":"\n# 遇到的问题\n\n正常按照**brew install node** 以及 **npm install -g hexo-cli** 安装完以后，运行**hexo deploy**报错，如下：\n\n```bash\n➜  blog hexo d\nINFO  Validating config\nINFO  Deploying: git\nINFO  Clearing .deploy_git folder...\nINFO  Copying files from public folder...\nFATAL {\n  err: TypeError [ERR_INVALID_ARG_TYPE]: The \"mode\" argument must be integer. Received an instance of Object\n      at copyFile (node:fs:2019:10)\n      at tryCatcher (/Users/werao/blog/node_modules/bluebird/js/release/util.js:16:23)\n      at ret (eval at makeNodePromisifiedEval (/usr/local/lib/node_modules/hexo-cli/node_modules/bluebird/js/release/promisify.js:184:12), <anonymous>:13:39)\n```\n\n网上查找了一下，报错的原因是Hexo与Node.js的兼容性问题。\n\n# 解决办法\n\n非常幸运，找到一篇文章：[重装Hexo遇到的坑](http://franktianyirenjian.github.io/2020/04/28/%E9%87%8D%E8%A3%85Hexo%E9%81%87%E5%88%B0%E7%9A%84%E5%9D%91/) 作者 成百川。\n\n简要记录步骤如下：\n\n1. 卸载**node**\n   **brew uninstall node**\n\n2. 安装**nvm**\n   **brew install nvm**\n记得按提示修改**~/.zshrc**文件，否则下次启动会找不到**nvm**。\n   \n3. 使用**nvm**安装低于14.0版本的node.js--如果后续版本升级，还可以使用nvm安装新版本。\n   **nvm install v13.14.0**\n\n   ```bash\n   Now using node v13.14.0 (npm v6.14.4)\n   Creating default alias: default -> v13.14.0\n   ```\n\n4. 重新运行**hexo deploy -g** 发布本文。\n\n鸣谢**成百川**。","source":"_posts/hexo-setup-log-md.md","raw":"---\ntitle: Hexo 安装设置遇到的问题及解决办法\ndate: 2021-02-07 23:36:19\ntags: \n- hexo\ndescription: 记录在Hexo安装过程中遇到的Hexo与Node.js版本兼容性的问题，使用nvm安装低版本的node.js解决问题，参考成百川的解决办法。\n---\n\n# 遇到的问题\n\n正常按照**brew install node** 以及 **npm install -g hexo-cli** 安装完以后，运行**hexo deploy**报错，如下：\n\n```bash\n➜  blog hexo d\nINFO  Validating config\nINFO  Deploying: git\nINFO  Clearing .deploy_git folder...\nINFO  Copying files from public folder...\nFATAL {\n  err: TypeError [ERR_INVALID_ARG_TYPE]: The \"mode\" argument must be integer. Received an instance of Object\n      at copyFile (node:fs:2019:10)\n      at tryCatcher (/Users/werao/blog/node_modules/bluebird/js/release/util.js:16:23)\n      at ret (eval at makeNodePromisifiedEval (/usr/local/lib/node_modules/hexo-cli/node_modules/bluebird/js/release/promisify.js:184:12), <anonymous>:13:39)\n```\n\n网上查找了一下，报错的原因是Hexo与Node.js的兼容性问题。\n\n# 解决办法\n\n非常幸运，找到一篇文章：[重装Hexo遇到的坑](http://franktianyirenjian.github.io/2020/04/28/%E9%87%8D%E8%A3%85Hexo%E9%81%87%E5%88%B0%E7%9A%84%E5%9D%91/) 作者 成百川。\n\n简要记录步骤如下：\n\n1. 卸载**node**\n   **brew uninstall node**\n\n2. 安装**nvm**\n   **brew install nvm**\n记得按提示修改**~/.zshrc**文件，否则下次启动会找不到**nvm**。\n   \n3. 使用**nvm**安装低于14.0版本的node.js--如果后续版本升级，还可以使用nvm安装新版本。\n   **nvm install v13.14.0**\n\n   ```bash\n   Now using node v13.14.0 (npm v6.14.4)\n   Creating default alias: default -> v13.14.0\n   ```\n\n4. 重新运行**hexo deploy -g** 发布本文。\n\n鸣谢**成百川**。","slug":"hexo-setup-log-md","published":1,"updated":"2025-12-14T09:50:07.477Z","comments":1,"layout":"post","photos":[],"_id":"cuidyitPcZc94wsVJ0_DWj0LO","content":"<h1 id=\"遇到的问题\"><a href=\"#遇到的问题\" class=\"headerlink\" title=\"遇到的问题\"></a>遇到的问题</h1><p>正常按照<strong>brew install node</strong> 以及 <strong>npm install -g hexo-cli</strong> 安装完以后，运行<strong>hexo deploy</strong>报错，如下：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  blog hexo d</span><br><span class=\"line\">INFO  Validating config</span><br><span class=\"line\">INFO  Deploying: git</span><br><span class=\"line\">INFO  Clearing .deploy_git folder...</span><br><span class=\"line\">INFO  Copying files from public folder...</span><br><span class=\"line\">FATAL &#123;</span><br><span class=\"line\">  err: TypeError [ERR_INVALID_ARG_TYPE]: The <span class=\"string\">&quot;mode&quot;</span> argument must be <span class=\"built_in\">integer</span>. Received an instance of Object</span><br><span class=\"line\">      at copyFile (node:fs:2019:10)</span><br><span class=\"line\">      at tryCatcher (/Users/werao/blog/node_modules/bluebird/js/release/util.js:16:23)</span><br><span class=\"line\">      at ret (<span class=\"built_in\">eval</span> at makeNodePromisifiedEval (/usr/local/lib/node_modules/hexo-cli/node_modules/bluebird/js/release/promisify.js:184:12), &lt;anonymous&gt;:13:39)</span><br></pre></td></tr></table></figure>\n\n<p>网上查找了一下，报错的原因是Hexo与Node.js的兼容性问题。</p>\n<h1 id=\"解决办法\"><a href=\"#解决办法\" class=\"headerlink\" title=\"解决办法\"></a>解决办法</h1><p>非常幸运，找到一篇文章：<a href=\"http://franktianyirenjian.github.io/2020/04/28/%E9%87%8D%E8%A3%85Hexo%E9%81%87%E5%88%B0%E7%9A%84%E5%9D%91/\">重装Hexo遇到的坑</a> 作者 成百川。</p>\n<p>简要记录步骤如下：</p>\n<ol>\n<li><p>卸载<strong>node</strong><br><strong>brew uninstall node</strong></p>\n</li>\n<li><p>安装<strong>nvm</strong><br><strong>brew install nvm</strong><br>记得按提示修改**~&#x2F;.zshrc<strong>文件，否则下次启动会找不到</strong>nvm**。</p>\n</li>\n<li><p>使用<strong>nvm</strong>安装低于14.0版本的node.js–如果后续版本升级，还可以使用nvm安装新版本。<br><strong>nvm install v13.14.0</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Now using node v13.14.0 (npm v6.14.4)</span><br><span class=\"line\">Creating default <span class=\"built_in\">alias</span>: default -&gt; v13.14.0</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>重新运行<strong>hexo deploy -g</strong> 发布本文。</p>\n</li>\n</ol>\n<p>鸣谢<strong>成百川</strong>。</p>\n","length":260,"excerpt":"","more":"<h1 id=\"遇到的问题\"><a href=\"#遇到的问题\" class=\"headerlink\" title=\"遇到的问题\"></a>遇到的问题</h1><p>正常按照<strong>brew install node</strong> 以及 <strong>npm install -g hexo-cli</strong> 安装完以后，运行<strong>hexo deploy</strong>报错，如下：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  blog hexo d</span><br><span class=\"line\">INFO  Validating config</span><br><span class=\"line\">INFO  Deploying: git</span><br><span class=\"line\">INFO  Clearing .deploy_git folder...</span><br><span class=\"line\">INFO  Copying files from public folder...</span><br><span class=\"line\">FATAL &#123;</span><br><span class=\"line\">  err: TypeError [ERR_INVALID_ARG_TYPE]: The <span class=\"string\">&quot;mode&quot;</span> argument must be <span class=\"built_in\">integer</span>. Received an instance of Object</span><br><span class=\"line\">      at copyFile (node:fs:2019:10)</span><br><span class=\"line\">      at tryCatcher (/Users/werao/blog/node_modules/bluebird/js/release/util.js:16:23)</span><br><span class=\"line\">      at ret (<span class=\"built_in\">eval</span> at makeNodePromisifiedEval (/usr/local/lib/node_modules/hexo-cli/node_modules/bluebird/js/release/promisify.js:184:12), &lt;anonymous&gt;:13:39)</span><br></pre></td></tr></table></figure>\n\n<p>网上查找了一下，报错的原因是Hexo与Node.js的兼容性问题。</p>\n<h1 id=\"解决办法\"><a href=\"#解决办法\" class=\"headerlink\" title=\"解决办法\"></a>解决办法</h1><p>非常幸运，找到一篇文章：<a href=\"http://franktianyirenjian.github.io/2020/04/28/%E9%87%8D%E8%A3%85Hexo%E9%81%87%E5%88%B0%E7%9A%84%E5%9D%91/\">重装Hexo遇到的坑</a> 作者 成百川。</p>\n<p>简要记录步骤如下：</p>\n<ol>\n<li><p>卸载<strong>node</strong><br><strong>brew uninstall node</strong></p>\n</li>\n<li><p>安装<strong>nvm</strong><br><strong>brew install nvm</strong><br>记得按提示修改**~&#x2F;.zshrc<strong>文件，否则下次启动会找不到</strong>nvm**。</p>\n</li>\n<li><p>使用<strong>nvm</strong>安装低于14.0版本的node.js–如果后续版本升级，还可以使用nvm安装新版本。<br><strong>nvm install v13.14.0</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Now using node v13.14.0 (npm v6.14.4)</span><br><span class=\"line\">Creating default <span class=\"built_in\">alias</span>: default -&gt; v13.14.0</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>重新运行<strong>hexo deploy -g</strong> 发布本文。</p>\n</li>\n</ol>\n<p>鸣谢<strong>成百川</strong>。</p>\n"},{"title":"通过Wireshark重新认识Traceroute","date":"2021-06-27T06:50:00.000Z","description":"本文对Traceroute的工作原理进行分析，介绍Traceroute在输出结果中显示AS号的功能参数，并通过Wireshark抓包分析MAC电脑上Traceroute的工作收发包过程，从而重新认识Traceroute；在此基础上，介绍Traceroute的进阶工具MTR。","_content":"\n# 初识Traceroute\n\nTraceroute是一种常见的网络分析工具，用于探测数据包从源地址到目的地址经过的路由器的IP地址。\n\n以下的示例显示从一个MAC电脑到8.8.8.8的路径探测结果：\n\n```shell\n➜  ~ traceroute 8.8.8.8\ntraceroute to 8.8.8.8 (8.8.8.8), 64 hops max, 52 byte packets\n 1  localhost (10.39.101.1)  8.662 ms  1.307 ms  1.155 ms\n 2  localhost (192.168.1.1)  2.287 ms  2.157 ms  1.897 ms\n 3  222.129.32.1 (222.129.32.1)  5.844 ms  13.092 ms  10.332 ms\n 4  114.244.95.105 (114.244.95.105)  7.541 ms\n    61.51.101.101 (61.51.101.101)  7.420 ms\n    61.148.163.81 (61.148.163.81)  7.075 ms\n 5  61.148.4.213 (61.148.4.213)  7.759 ms\n    219.232.11.65 (219.232.11.65)  5.976 ms\n    bt-230-081.bta.net.cn (202.106.230.81)  6.021 ms\n 6  202.96.12.13 (202.96.12.13)  7.828 ms * *\n 7  219.158.112.26 (219.158.112.26)  39.486 ms *\n    219.158.7.22 (219.158.7.22)  45.959 ms\n 8  219.158.103.218 (219.158.103.218)  48.469 ms\n    219.158.97.2 (219.158.97.2)  47.146 ms\n    219.158.103.218 (219.158.103.218)  50.320 ms\n 9  219.158.103.30 (219.158.103.30)  50.739 ms  50.382 ms  48.348 ms\n10  219.158.10.30 (219.158.10.30)  49.927 ms  44.264 ms  56.353 ms\n11  219.158.33.174 (219.158.33.174)  54.123 ms  61.131 ms  47.302 ms\n12  108.170.241.97 (108.170.241.97)  56.082 ms\n    108.170.241.33 (108.170.241.33)  52.942 ms  54.393 ms\n13  142.250.58.189 (142.250.58.189)  48.958 ms\n    209.85.143.37 (209.85.143.37)  51.217 ms\n    108.170.226.115 (108.170.226.115)  141.544 ms\n14  dns.google (8.8.8.8)  48.935 ms  46.364 ms  51.043 ms\n\n➜  ~ ping 8.8.8.8\nPING 8.8.8.8 (8.8.8.8): 56 data bytes\n64 bytes from 8.8.8.8: icmp_seq=0 ttl=113 time=52.060 ms\n64 bytes from 8.8.8.8: icmp_seq=1 ttl=113 time=44.845 ms\n64 bytes from 8.8.8.8: icmp_seq=2 ttl=113 time=52.393 ms\n64 bytes from 8.8.8.8: icmp_seq=3 ttl=113 time=51.059 ms\n64 bytes from 8.8.8.8: icmp_seq=4 ttl=113 time=44.437 ms\n64 bytes from 8.8.8.8: icmp_seq=5 ttl=113 time=44.534 ms\n^C\n--- 8.8.8.8 ping statistics ---\n6 packets transmitted, 6 packets received, 0.0% packet loss\nround-trip min/avg/max/stddev = 44.437/48.221/52.393/3.640 ms\n```\n\n输出结果表明：\n1. 从MAC电脑到8.8.8.8的路径包含14个网络节点。\n2. 每个节点后面都显示时延信息，表明从MAC电脑到该节点的往返时延。您可能会发现，中间的某些节点往返时延可能要高于更远的节点的往返时延。这是由于该时延包含了路由器将TTL=0的报文交给控制面处理的时延，因而往往比路径上的传播时延要高，尤其是当控制面CPU繁忙时。Traceroute对每一个节点发出3个探测报文，每个报文的路径不尽相同，例如在第4、5、7、8、12、13跳经过不同的路由器转发。\n3. 有的探测没有得到回应，因此在有的节点本应显示时延信息的，显示了\\*。这并不能断定中间的网络不可达，很可能的原因是该节点的路由器在接口上配置了 ***no ip unreachable*** 命令，该接口不回应ICMP Unreachable消息，而该消息正是Traceroute探测路径所依赖的信息来源。\n\n接下来，我们简要描述一下，在MAC电脑下，Traceroute的工作原理，并使用Wireshark进一步的探究Traceroute的工作过程。\n\n# Traceroute的工作原理\n\n每当IP数据包经过一个路由器，其存活时间TTL就会减1。当其存活时间是0时，主机便取消数据包，并发送一个ICMP TTL超时数据包给原数据包的发出者。Traceroute程序通过向目的地址发送一系列的探测包，设置探测包的TTL初始值分别为1,2,3…，根据返回的超时通知（ICMP Time Exceeded Message）得到源地址与目的地址之间的每一跳路由信息。\n\n![Traceroute 的工作原理](get-known-traceroute-by-wireshark/Traceroute-work.png)\n\n1. 从源地址发出一个UDP探测包到目的地址，并将TTL设置为1；\n\n2. 到达路由器时，将TTL减1；\n\n3. 当TTL变为0时，包被丢弃，路由器向源地址发回一个ICMP超时通知（ICMP Time Exceeded Message），内含发送IP包的源地址，IP包的所有内容及路由器的IP地址；\n\n4. 当源地址收到该ICMP包时，显示这一跳路由信息；\n\n5. 重复1～5，并每次设置TTL加1；\n\n6. 直至目标地址收到探测数据包，并返回端口不可达通知（ICMP Port Unreachable）；\n\n7. 当源地址收到ICMP Port Unreachable包时停止traceroute。\n\n以上内容引自[Traceroute/tracert原理和实践](https://blog.csdn.net/shb_derek1/article/details/100097050)\n\n# 通过Wireshark探究Traceroute\n\n## 在Traceroute输出结果中显示AS号\n\n在Mac电脑的Traceroute命令中，通过'-a'的参数可以开启路径中遇到的IP地址所在的BGP AS号，以便于获知路径中每一跳所归属的运营商，通过'-q 1'可将缺省发送3个探测报文改为发送1个探测报文，输出示例如下：\n```shell\n➜  ~ traceroute -aq 1 8.8.8.8\ntraceroute to 8.8.8.8 (8.8.8.8), 64 hops max, 52 byte packets\n 1  [AS0] bogon (10.39.101.1)  2.424 ms\n 2  [AS0] localhost (192.168.1.1)  3.031 ms\n 3  [AS4808] 222.129.32.1 (222.129.32.1)  6.496 ms\n 4  [AS4808] 61.51.101.101 (61.51.101.101)  8.114 ms\n 5  [AS17431] 219.232.11.29 (219.232.11.29)  5.865 ms\n 6  [AS4808] 202.96.12.13 (202.96.12.13)  6.558 ms\n 7  [AS4837] 219.158.112.46 (219.158.112.46)  44.826 ms\n 8  [AS4837] 219.158.103.218 (219.158.103.218)  52.181 ms\n 9  [AS4837] 219.158.103.30 (219.158.103.30)  47.851 ms\n10  [AS4837] 219.158.10.30 (219.158.10.30)  56.963 ms\n11  [AS4837] 219.158.33.174 (219.158.33.174)  46.523 ms\n12  [AS15169] 108.170.241.1 (108.170.241.1)  48.503 ms\n13  [AS15169] 172.253.64.111 (172.253.64.111)  142.926 ms\n14  [AS15169] dns.google (8.8.8.8)  52.208 ms\n```\n上述的AS编号信息是如何获得的？下面我们通过Wireshark抓取报文进行分析。\n\n## 上述Traceroute的收发包过程简述\n开启Wireshark，并迅速执行**traceroute -aq 1 8.8.8.8**，Traceroute完整输出后，停止Wireshark的报文抓取。\n针对抓取的报文进行过滤，在过滤框中输入 **udp or icmp or ip.addr == 198.108.0.18**\n经过Wireshark的报文分析，以下为Traceroute的简要的收发包过程：\n\n1. 发起DNS查询，查询**whois.radb.net**域名，得到应答为198.108.0.18----上述过滤器中IP地址来源于此。\n2. 发起TCP连接请求，与198.108.0.18建立TCP连接。\n3. 向8.8.8.8发起UDP报文，目的端口为33435，TTL设置为1\n4. 收到路由器的ICMP TTL超时消息，获取路由器对应的IP地址\n5. 向**whois.radb.net**发起查询，询问路由器IP地址对应的AS号，并得到回应，如果是私有地址，其AS号为0。\n6. 尝试向DNS服务器查询路由器IP地址的反向域名解析，如果得到域名，就将其显示在Traceroute的输出结果中。\n7. 重复上述第3~6步，每次将TTL加1，直至目标地址接收到探测报文，并返回ICMP Port Unreachable消息。\n\n## Wireshark抓包详细分析\n下图为Wireshark抓取的报文的前36个：![packet1-36](get-known-traceroute-by-wireshark/packet1-36.png)\n\n1. 第1和第2个报文为DNS查询，查询whois.radb.net的地址为198.108.0.18。\n\n2. 第3~5的报文为TCP三次握手，并成功建立TCP 连接10.39.101.141:51705<--->198.108.0.18:43，TCP 43端口通常是whois server的端口。\n\n3. 第6个报文由10.39.101.141发向198.108.0.18，并将PSH置位，请求接收端一收到就进行向上交付，以缩短Traceroute的等待时间。\n\n4. 第7个报文发出第一个UDP的探测报文，目标端口号为33435，TTL=1，具体如下：\n\n   ![UDP-Probe-1](get-known-traceroute-by-wireshark/UDP-Probe-1.png)\n\n5. 第8个报文为网关回复的ICMP Time-to-live exceeded (Time to live exceeded in transit)报文，Traceroute从IP报文中的源地址获取路由器的IP地址10.39.101.1。该报文包含原始的UDP报文信息，具体如下：\n\n   ![ICMP-Reply-1](get-known-traceroute-by-wireshark/ICMP-Reply-1.png)\n\n6. 第9个报文为第6个报文的TCP确认报文，第10个报文为向whois.radb.net查询网关10.39.101.1/32所在的AS号。第11个报文为第10个报文的TCP确认，第12个报文答复查询结果，由于该地址为私有IP地址段，没有查询到结果，因此Traceroute 将AS号显示为[AS0]。以下使用第29和30报文，用于展示AS号查询的报文，如下：\n  \n  ![AS-query-1](get-known-traceroute-by-wireshark/AS-query-1.png)\n  \n  ![AS-reply-1](get-known-traceroute-by-wireshark/AS-reply-1.png)\n  \n  查询结果的文本内容如下：\n  \n  ```text\n  route:      222.129.0.0/18\n  descr:      CMI  (Customer Route)\n  origin:     AS4808\n  mnt-by:     MAINT-AS58453\n  changed:    qas_support@cmi.chinamobile.com 20160525\n  source:     RADB\n  \n  route:          222.128.0.0/14\n  descr:          China Unicom Beijing Province Network\n  country:        CN\n  origin:         AS4808\n  mnt-by:         MAINT-CNCGROUP-RR\n  changed:        abuse@cnc-noc.net 20160516\n  source:         APNIC\n  \n  route:      222.129.0.0/18\n  descr:      CMI IP Transit\n  origin:     AS4808\n  admin-c:    MAINT-CMI-INT-HK\n  tech-c:     MAINT-CMI-INT-HK\n  mnt-by:     MAINT-CMI-INT-HK\n  changed:    qas_support@cmi.chinamobile.com 20160525\n  source:     NTTCOM\n  ```\n  \n7. 第14~17报文是DNS解析报文，分别对主机名WERAO-M-40KA进行域名解析，以及对网关IP 10.39.101.1进行反向域名解析，由于是私有主机名和私有地址，自然公网DNS是解析不出来。以下将针对8.8.8.8进行反向域名解析为dns.google的截图作为示例：\n\n   ![dns-query-1](get-known-traceroute-by-wireshark/dns-query-1.png)\n\n8. 报文18\\~26重复报文7\\~17的过程，其中报文18的TTL为2，如下：\n\n   ![UDP-Probe-2](get-known-traceroute-by-wireshark/UDP-Probe-2.png)\n\n   过程持续至8.8.8.8返回Code: 3 (Port unreachable)的消息，并对8.8.8.8进行反向域名解析。\n\n   ![ICMP-last-reply](get-known-traceroute-by-wireshark/ICMP-last-reply.png)\n\n以上详细的分析了**traceroute -aq 1 8.8.8.8**的报文收发过程。\n\n## 后记\n\n在上述的Traceroute完成输出后，Wireshark成功的将Whois的交互报文进行重新组装，并完成内容的解析。\n\n在Wireshark分析完第133个报文后，Wireshark成功的组装出whois的查询报文，如下：\n\n![whois-query](get-known-traceroute-by-wireshark/whois-query.png)\n\n在Wireshark分析完第135个报文后，Wireshark成功的组装出Whois的应答报文，如下：\n\n![whois-answer](get-known-traceroute-by-wireshark/whois-answer.png)\n\n\n\n在Terminal执行whois 8.8.8.8/32，并进行报文抓取，解析出Whois的报文应答如下：\n\n![whois-answer-2](get-known-traceroute-by-wireshark/whois-answer-2.png)\n\n该报文也是Wireshark 拼装了多个TCP Segment，#101、#103、#104、#106、#109后解析出来的。对比该解析结果和上文中，Traceroute过程中的查询结果，可以发现，报文结构是一致的，都被Wireshark解析成Whois的报文。\n\n据此，我推测，MAC电脑上的Traceroute 在增加了-a的参数后，会主动发起Whois查询，缺省的Whois服务器是whois.radb.net。\n\n此部分内容是在Traceroute收发包过程分析完成后，再后知后觉发现的，因此将此部分内容作为“后记”进行记录。\n\n# Traceroute 进阶版工具MTR\n\nMTR （My Traceroute）工具将ping和traceroute命令的功能并入了同一个工具中，实现更强大的功能。相对于traceroute命令只会做一次链路跟踪测试，mtr命令会对链路上的相关节点做持续探测并给出相应的统计信息。\n\n如下为MTR的输出：\n\n```shell\n➜  ~ sudo mtr -ry 4 8.8.8.8\nStart: 2021-06-27T23:37:21+0800\nHOST: WERAO-M-40KA                Loss%   Snt   Last   Avg  Best  Wrst StDev\n  1. ???        localhost          0.0%    10    1.8   2.2   1.2  10.1   2.8\n  2. ???        bogon              0.0%    10    2.2   2.3   1.9   3.3   0.5\n  3. 2003-11-19 222.129.32.1       0.0%    10    6.3   9.5   5.0  29.2   7.7\n  4. 2000-03-14 61.148.163.181     0.0%    10    5.3   7.4   5.3   8.7   1.2\n  5. 2002-04-17 219.232.11.65     70.0%    10    5.4   6.1   5.4   6.8   0.7\n  6. 2006-01-09 124.65.194.153    30.0%    10   28.9   9.6   5.7  28.9   8.5\n  7. 2002-03-21 219.158.112.26    40.0%    10   38.9  44.2  38.5  63.7   9.7\n  8. 2002-03-21 219.158.19.66      0.0%    10   74.4  64.1  46.4  74.4   8.8\n  9. 2002-03-21 219.158.97.25      0.0%    10   90.8  90.8  82.2  96.7   4.3\n 10. 2002-03-21 219.158.20.94      0.0%    10   97.5  89.8  74.1 104.6  11.8\n 11. 2002-03-21 219.158.33.174     0.0%    10   73.0  62.1  49.7  74.0   8.5\n 12. 2012-02-07 108.170.241.65     0.0%    10   59.0  67.3  53.1  75.4   7.2\n 13. 2013-04-04 172.253.69.229    10.0%    10   62.9  68.3  54.5  76.6   6.5\n 14. 1992-12-01 dns.google         0.0%    10   71.0  65.6  56.4  71.0   5.7\n```\n\nMTR命令，通过-r 输出报告，-z 可输出地址所在的AS号，-y 4 可输出该地址的分配时间。\n\n输出信息解释如下：\n\n- 第一列（Host）：节点IP地址和域名。\n- 第二列（Loss%）：节点丢包率。\n- 第三列（Snt）：发送的Ping包数。默认值是10，可以通过参数“-c”指定。\n- 第四列（Last）：最近一次的探测延迟值。\n- 第五、六、七列（Avg、Best、Wrst）：分别是探测延迟的平均值、最小值和最大值。\n- 第八列（StDev）：标准偏差。越大说明相应节点越不稳定。\n\n上述解释引用自：[MTR工具使用说明与结果分析](https://help.aliyun.com/knowledge_detail/98706.html)，略有改动。\n\n# Q&A\n\n1. David Tian:  赞，请教下，为什么ipv4的traceroute 会触发用ipv6去查dns呢？\n\n   答：好眼力，好问题~~实际上，我抓取的报文中，每次得到ICMP报文后，Traceroute也会向208.67.222.222发送DNS请求。但是报文是加密的，看不出是什么内容，不能猜测，所以我将这些不确定的报文删除了。208.67.222.222是OpenDNS的DNS服务器，这是Cisco IT设置的DNS服务器。😄\n\n# 附录\n\n以下是Wireshark抓包文件的前60个报文的概览。\n\n| No.  | Source                    | Destination               | Protocol | Info                                                         |\n| ---- | ------------------------- | ------------------------- | -------- | ------------------------------------------------------------ |\n| 1    | fe80::1c7a:24fd:c837:3017 | fe80::1                   | DNS      | Standard query 0xc7d5 A whois.radb.net                       |\n| 2    | fe80::1                   | fe80::1c7a:24fd:c837:3017 | DNS      | Standard query response 0xc7d5 A whois.radb.net A 198.108.0.18 |\n| 3    | 10.39.101.141             | 198.108.0.18              | TCP      | 51705 → 43 [SYN] Seq=0 Win=65535 Len=0 MSS=1460 WS=64 TSval=2785245374  TSecr=0 SACK_PERM=1 |\n| 4    | 198.108.0.18              | 10.39.101.141             | TCP      | 43 → 51705 [SYN, ACK] Seq=0 Ack=1 Win=28960 Len=0 MSS=1412  TSval=3642352050 TSecr=2785245374 WS=256 |\n| 5    | 10.39.101.141             | 198.108.0.18              | TCP      | 51705 → 43 [ACK] Seq=1 Ack=1 Win=131584 Len=0 TSval=2785245692  TSecr=3642352050 |\n| 6    | 10.39.101.141             | 198.108.0.18              | TCP      | 51705 → 43 [PSH, ACK] Seq=1 Ack=1 Win=131584 Len=3 TSval=2785245692  TSecr=3642352050 [TCP segment of a reassembled PDU] |\n| 7    | 10.39.101.141             | 8.8.8.8                   | UDP      | 36904 → 33435 Len=24                                         |\n| 8    | 10.39.101.1               | 10.39.101.141             | ICMP     | Time-to-live exceeded (Time to live exceeded in transit)     |\n| 9    | 198.108.0.18              | 10.39.101.141             | TCP      | 43 → 51705 [ACK] Seq=1 Ack=4 Win=29184 Len=0 TSval=3642352370  TSecr=2785245692 |\n| 10   | 10.39.101.141             | 198.108.0.18              | TCP      | 51705 → 43 [PSH, ACK] Seq=4 Ack=1 Win=131584 Len=19 TSval=2785246039  TSecr=3642352370 [TCP segment of a reassembled PDU] |\n| 11   | 198.108.0.18              | 10.39.101.141             | TCP      | 43 → 51705 [ACK] Seq=1 Ack=23 Win=29184 Len=0 TSval=3642352717  TSecr=2785246039 |\n| 12   | 198.108.0.18              | 10.39.101.141             | TCP      | 43 → 51705 [PSH, ACK] Seq=1 Ack=23 Win=29184 Len=2 TSval=3642352717  TSecr=2785246039 [TCP segment of a reassembled PDU] |\n| 13   | 10.39.101.141             | 198.108.0.18              | TCP      | 51705 → 43 [ACK] Seq=23 Ack=3 Win=131584 Len=0 TSval=2785246448  TSecr=3642352717 |\n| 14   | fe80::1c7a:24fd:c837:3017 | fe80::1                   | DNS      | Standard query 0x93fc A WERAO-M-40KA                         |\n| 15   | fe80::1                   | fe80::1c7a:24fd:c837:3017 | DNS      | Standard query response 0x93fc No such name A WERAO-M-40KA   |\n| 16   | fe80::1c7a:24fd:c837:3017 | fe80::1                   | DNS      | Standard query 0xbcf9 PTR 1.101.39.10.in-addr.arpa           |\n| 17   | fe80::1                   | fe80::1c7a:24fd:c837:3017 | DNS      | Standard query response 0xbcf9 PTR 1.101.39.10.in-addr.arpa PTR bogon |\n| 18   | 10.39.101.141             | 8.8.8.8                   | UDP      | 36904 → 33436 Len=24                                         |\n| 19   | 192.168.1.1               | 10.39.101.141             | ICMP     | Time-to-live exceeded (Time to live exceeded in transit)     |\n| 20   | 10.39.101.141             | 198.108.0.18              | TCP      | 51705 → 43 [PSH, ACK] Seq=23 Ack=3 Win=131584 Len=19 TSval=2785248590  TSecr=3642352717 [TCP segment of a reassembled PDU] |\n| 21   | 10.39.101.141             | 10.39.101.1               | DNS      | Standard query 0xc81a A WERAO-M-40KA                         |\n| 22   | 10.39.101.1               | 10.39.101.141             | DNS      | Standard query response 0xc81a A WERAO-M-40KA A 10.39.101.141 |\n| 23   | 198.108.0.18              | 10.39.101.141             | TCP      | 43 → 51705 [PSH, ACK] Seq=3 Ack=42 Win=29184 Len=2 TSval=3642355278  TSecr=2785248590 [TCP segment of a reassembled PDU] |\n| 24   | 10.39.101.141             | 198.108.0.18              | TCP      | 51705 → 43 [ACK] Seq=42 Ack=5 Win=131584 Len=0 TSval=2785248902  TSecr=3642355278 |\n| 25   | fe80::1c7a:24fd:c837:3017 | fe80::1                   | DNS      | Standard query 0x7504 PTR 1.1.168.192.in-addr.arpa           |\n| 26   | fe80::1                   | fe80::1c7a:24fd:c837:3017 | DNS      | Standard query response 0x7504 PTR 1.1.168.192.in-addr.arpa PTR localhost |\n| 27   | 10.39.101.141             | 8.8.8.8                   | UDP      | 36904 → 33437 Len=24                                         |\n| 28   | 222.129.32.1              | 10.39.101.141             | ICMP     | Time-to-live exceeded (Time to live exceeded in transit)     |\n| 29   | 10.39.101.141             | 198.108.0.18              | TCP      | 51705 → 43 [PSH, ACK] Seq=42 Ack=5 Win=131584 Len=20 TSval=2785249974  TSecr=3642355278 [TCP segment of a reassembled PDU] |\n| 30   | 198.108.0.18              | 10.39.101.141             | TCP      | 43 → 51705 [PSH, ACK] Seq=5 Ack=62 Win=29184 Len=643 TSval=3642356666  TSecr=2785249974 [TCP segment of a reassembled PDU] |\n| 31   | 10.39.101.141             | 198.108.0.18              | TCP      | 51705 → 43 [ACK] Seq=62 Ack=648 Win=130944 Len=0 TSval=2785250324  TSecr=3642356666 |\n| 32   | fe80::1c7a:24fd:c837:3017 | fe80::1                   | DNS      | Standard query 0x4f56 PTR 1.32.129.222.in-addr.arpa          |\n| 33   | fe80::1                   | fe80::1c7a:24fd:c837:3017 | DNS      | Standard query response 0x4f56 No such name PTR 1.32.129.222.in-addr.arpa |\n| 34   | 10.39.101.141             | 8.8.8.8                   | UDP      | 36904 → 33438 Len=24                                         |\n| 35   | 61.51.101.101             | 10.39.101.141             | ICMP     | Time-to-live exceeded (Time to live exceeded in transit)     |\n| 36   | 10.39.101.141             | 198.108.0.18              | TCP      | 51705 → 43 [PSH, ACK] Seq=62 Ack=648 Win=131072 Len=21 TSval=2785251389  TSecr=3642356666 [TCP segment of a reassembled PDU] |\n| 37   | 198.108.0.18              | 10.39.101.141             | TCP      | 43 → 51705 [PSH, ACK] Seq=648 Ack=83 Win=29184 Len=639 TSval=3642358087  TSecr=2785251389 [TCP segment of a reassembled PDU] |\n| 38   | 10.39.101.141             | 198.108.0.18              | TCP      | 51705 → 43 [ACK] Seq=83 Ack=1287 Win=130432 Len=0 TSval=2785251697  TSecr=3642358087 |\n| 39   | 10.39.101.141             | 10.39.101.1               | DNS      | Standard query 0x521b PTR 1.32.129.222.in-addr.arpa          |\n| 40   | 10.39.101.1               | 10.39.101.141             | DNS      | Standard query response 0x521b No such name PTR 1.32.129.222.in-addr.arpa |\n| 41   | fe80::1c7a:24fd:c837:3017 | fe80::1                   | DNS      | Standard query 0x5931 PTR 101.101.51.61.in-addr.arpa         |\n| 42   | fe80::1                   | fe80::1c7a:24fd:c837:3017 | DNS      | Standard query response 0x5931 No such name PTR  101.101.51.61.in-addr.arpa |\n| 43   | 10.39.101.141             | 8.8.8.8                   | UDP      | 36904 → 33439 Len=24                                         |\n| 44   | 219.232.11.29             | 10.39.101.141             | ICMP     | Time-to-live exceeded (Time to live exceeded in transit)     |\n| 45   | 10.39.101.141             | 198.108.0.18              | TCP      | 51705 → 43 [PSH, ACK] Seq=83 Ack=1287 Win=131072 Len=21 TSval=2785252732  TSecr=3642358087 [TCP segment of a reassembled PDU] |\n| 46   | 198.108.0.18              | 10.39.101.141             | TCP      | 43 → 51705 [PSH, ACK] Seq=1287 Ack=104 Win=29184 Len=418 TSval=3642359437  TSecr=2785252732 [TCP segment of a reassembled PDU] |\n| 47   | 10.39.101.141             | 198.108.0.18              | TCP      | 51705 → 43 [ACK] Seq=104 Ack=1705 Win=130624 Len=0 TSval=2785253042  TSecr=3642359437 |\n| 48   | fe80::1c7a:24fd:c837:3017 | fe80::1                   | DNS      | Standard query 0x7d09 PTR 29.11.232.219.in-addr.arpa         |\n| 49   | fe80::1                   | fe80::1c7a:24fd:c837:3017 | DNS      | Standard query response 0x7d09 No such name PTR  29.11.232.219.in-addr.arpa |\n| 50   | 10.39.101.141             | 8.8.8.8                   | UDP      | 36904 → 33440 Len=24                                         |\n| 51   | 202.96.12.13              | 10.39.101.141             | ICMP     | Time-to-live exceeded (Time to live exceeded in transit)     |\n| 52   | 10.39.101.141             | 198.108.0.18              | TCP      | 51705 → 43 [PSH, ACK] Seq=104 Ack=1705 Win=131072 Len=20 TSval=2785254068  TSecr=3642359437 [TCP segment of a reassembled PDU] |\n| 53   | 10.39.101.141             | 10.39.101.1               | DNS      | Standard query 0x961b PTR 101.101.51.61.in-addr.arpa         |\n| 54   | 10.39.101.1               | 10.39.101.141             | DNS      | Standard query response 0x961b No such name PTR  101.101.51.61.in-addr.arpa |\n| 55   | 198.108.0.18              | 10.39.101.141             | TCP      | 43 → 51705 [PSH, ACK] Seq=1705 Ack=124 Win=29184 Len=642 TSval=3642360779  TSecr=2785254068 [TCP segment of a reassembled PDU] |\n| 56   | 10.39.101.141             | 198.108.0.18              | TCP      | 51705 → 43 [ACK] Seq=124 Ack=2347 Win=130368 Len=0 TSval=2785254400  TSecr=3642360779 |\n| 57   | fe80::1c7a:24fd:c837:3017 | fe80::1                   | DNS      | Standard query 0xb016 PTR 13.12.96.202.in-addr.arpa          |\n| 58   | fe80::1                   | fe80::1c7a:24fd:c837:3017 | DNS      | Standard query response 0xb016 No such name PTR 13.12.96.202.in-addr.arpa  SOA beijing.cn.net |\n| 59   | 10.39.101.141             | 8.8.8.8                   | UDP      | 36904 → 33441 Len=24                                         |\n| 60   | 219.158.112.46            | 10.39.101.141             | ICMP     | Time-to-live exceeded (Time to live exceeded in transit)     |\n\n[抓包文件下载](get-known-traceroute-by-wireshark/traceroute-google-dns.pcapng)\n\n","source":"_posts/get-known-traceroute-by-wireshark.md","raw":"---\ntitle: 通过Wireshark重新认识Traceroute\ndate: 2021-06-27 14:50:00\ntags:\n    - traceroute\n    - wireshark\ndescription: 本文对Traceroute的工作原理进行分析，介绍Traceroute在输出结果中显示AS号的功能参数，并通过Wireshark抓包分析MAC电脑上Traceroute的工作收发包过程，从而重新认识Traceroute；在此基础上，介绍Traceroute的进阶工具MTR。\n---\n\n# 初识Traceroute\n\nTraceroute是一种常见的网络分析工具，用于探测数据包从源地址到目的地址经过的路由器的IP地址。\n\n以下的示例显示从一个MAC电脑到8.8.8.8的路径探测结果：\n\n```shell\n➜  ~ traceroute 8.8.8.8\ntraceroute to 8.8.8.8 (8.8.8.8), 64 hops max, 52 byte packets\n 1  localhost (10.39.101.1)  8.662 ms  1.307 ms  1.155 ms\n 2  localhost (192.168.1.1)  2.287 ms  2.157 ms  1.897 ms\n 3  222.129.32.1 (222.129.32.1)  5.844 ms  13.092 ms  10.332 ms\n 4  114.244.95.105 (114.244.95.105)  7.541 ms\n    61.51.101.101 (61.51.101.101)  7.420 ms\n    61.148.163.81 (61.148.163.81)  7.075 ms\n 5  61.148.4.213 (61.148.4.213)  7.759 ms\n    219.232.11.65 (219.232.11.65)  5.976 ms\n    bt-230-081.bta.net.cn (202.106.230.81)  6.021 ms\n 6  202.96.12.13 (202.96.12.13)  7.828 ms * *\n 7  219.158.112.26 (219.158.112.26)  39.486 ms *\n    219.158.7.22 (219.158.7.22)  45.959 ms\n 8  219.158.103.218 (219.158.103.218)  48.469 ms\n    219.158.97.2 (219.158.97.2)  47.146 ms\n    219.158.103.218 (219.158.103.218)  50.320 ms\n 9  219.158.103.30 (219.158.103.30)  50.739 ms  50.382 ms  48.348 ms\n10  219.158.10.30 (219.158.10.30)  49.927 ms  44.264 ms  56.353 ms\n11  219.158.33.174 (219.158.33.174)  54.123 ms  61.131 ms  47.302 ms\n12  108.170.241.97 (108.170.241.97)  56.082 ms\n    108.170.241.33 (108.170.241.33)  52.942 ms  54.393 ms\n13  142.250.58.189 (142.250.58.189)  48.958 ms\n    209.85.143.37 (209.85.143.37)  51.217 ms\n    108.170.226.115 (108.170.226.115)  141.544 ms\n14  dns.google (8.8.8.8)  48.935 ms  46.364 ms  51.043 ms\n\n➜  ~ ping 8.8.8.8\nPING 8.8.8.8 (8.8.8.8): 56 data bytes\n64 bytes from 8.8.8.8: icmp_seq=0 ttl=113 time=52.060 ms\n64 bytes from 8.8.8.8: icmp_seq=1 ttl=113 time=44.845 ms\n64 bytes from 8.8.8.8: icmp_seq=2 ttl=113 time=52.393 ms\n64 bytes from 8.8.8.8: icmp_seq=3 ttl=113 time=51.059 ms\n64 bytes from 8.8.8.8: icmp_seq=4 ttl=113 time=44.437 ms\n64 bytes from 8.8.8.8: icmp_seq=5 ttl=113 time=44.534 ms\n^C\n--- 8.8.8.8 ping statistics ---\n6 packets transmitted, 6 packets received, 0.0% packet loss\nround-trip min/avg/max/stddev = 44.437/48.221/52.393/3.640 ms\n```\n\n输出结果表明：\n1. 从MAC电脑到8.8.8.8的路径包含14个网络节点。\n2. 每个节点后面都显示时延信息，表明从MAC电脑到该节点的往返时延。您可能会发现，中间的某些节点往返时延可能要高于更远的节点的往返时延。这是由于该时延包含了路由器将TTL=0的报文交给控制面处理的时延，因而往往比路径上的传播时延要高，尤其是当控制面CPU繁忙时。Traceroute对每一个节点发出3个探测报文，每个报文的路径不尽相同，例如在第4、5、7、8、12、13跳经过不同的路由器转发。\n3. 有的探测没有得到回应，因此在有的节点本应显示时延信息的，显示了\\*。这并不能断定中间的网络不可达，很可能的原因是该节点的路由器在接口上配置了 ***no ip unreachable*** 命令，该接口不回应ICMP Unreachable消息，而该消息正是Traceroute探测路径所依赖的信息来源。\n\n接下来，我们简要描述一下，在MAC电脑下，Traceroute的工作原理，并使用Wireshark进一步的探究Traceroute的工作过程。\n\n# Traceroute的工作原理\n\n每当IP数据包经过一个路由器，其存活时间TTL就会减1。当其存活时间是0时，主机便取消数据包，并发送一个ICMP TTL超时数据包给原数据包的发出者。Traceroute程序通过向目的地址发送一系列的探测包，设置探测包的TTL初始值分别为1,2,3…，根据返回的超时通知（ICMP Time Exceeded Message）得到源地址与目的地址之间的每一跳路由信息。\n\n![Traceroute 的工作原理](get-known-traceroute-by-wireshark/Traceroute-work.png)\n\n1. 从源地址发出一个UDP探测包到目的地址，并将TTL设置为1；\n\n2. 到达路由器时，将TTL减1；\n\n3. 当TTL变为0时，包被丢弃，路由器向源地址发回一个ICMP超时通知（ICMP Time Exceeded Message），内含发送IP包的源地址，IP包的所有内容及路由器的IP地址；\n\n4. 当源地址收到该ICMP包时，显示这一跳路由信息；\n\n5. 重复1～5，并每次设置TTL加1；\n\n6. 直至目标地址收到探测数据包，并返回端口不可达通知（ICMP Port Unreachable）；\n\n7. 当源地址收到ICMP Port Unreachable包时停止traceroute。\n\n以上内容引自[Traceroute/tracert原理和实践](https://blog.csdn.net/shb_derek1/article/details/100097050)\n\n# 通过Wireshark探究Traceroute\n\n## 在Traceroute输出结果中显示AS号\n\n在Mac电脑的Traceroute命令中，通过'-a'的参数可以开启路径中遇到的IP地址所在的BGP AS号，以便于获知路径中每一跳所归属的运营商，通过'-q 1'可将缺省发送3个探测报文改为发送1个探测报文，输出示例如下：\n```shell\n➜  ~ traceroute -aq 1 8.8.8.8\ntraceroute to 8.8.8.8 (8.8.8.8), 64 hops max, 52 byte packets\n 1  [AS0] bogon (10.39.101.1)  2.424 ms\n 2  [AS0] localhost (192.168.1.1)  3.031 ms\n 3  [AS4808] 222.129.32.1 (222.129.32.1)  6.496 ms\n 4  [AS4808] 61.51.101.101 (61.51.101.101)  8.114 ms\n 5  [AS17431] 219.232.11.29 (219.232.11.29)  5.865 ms\n 6  [AS4808] 202.96.12.13 (202.96.12.13)  6.558 ms\n 7  [AS4837] 219.158.112.46 (219.158.112.46)  44.826 ms\n 8  [AS4837] 219.158.103.218 (219.158.103.218)  52.181 ms\n 9  [AS4837] 219.158.103.30 (219.158.103.30)  47.851 ms\n10  [AS4837] 219.158.10.30 (219.158.10.30)  56.963 ms\n11  [AS4837] 219.158.33.174 (219.158.33.174)  46.523 ms\n12  [AS15169] 108.170.241.1 (108.170.241.1)  48.503 ms\n13  [AS15169] 172.253.64.111 (172.253.64.111)  142.926 ms\n14  [AS15169] dns.google (8.8.8.8)  52.208 ms\n```\n上述的AS编号信息是如何获得的？下面我们通过Wireshark抓取报文进行分析。\n\n## 上述Traceroute的收发包过程简述\n开启Wireshark，并迅速执行**traceroute -aq 1 8.8.8.8**，Traceroute完整输出后，停止Wireshark的报文抓取。\n针对抓取的报文进行过滤，在过滤框中输入 **udp or icmp or ip.addr == 198.108.0.18**\n经过Wireshark的报文分析，以下为Traceroute的简要的收发包过程：\n\n1. 发起DNS查询，查询**whois.radb.net**域名，得到应答为198.108.0.18----上述过滤器中IP地址来源于此。\n2. 发起TCP连接请求，与198.108.0.18建立TCP连接。\n3. 向8.8.8.8发起UDP报文，目的端口为33435，TTL设置为1\n4. 收到路由器的ICMP TTL超时消息，获取路由器对应的IP地址\n5. 向**whois.radb.net**发起查询，询问路由器IP地址对应的AS号，并得到回应，如果是私有地址，其AS号为0。\n6. 尝试向DNS服务器查询路由器IP地址的反向域名解析，如果得到域名，就将其显示在Traceroute的输出结果中。\n7. 重复上述第3~6步，每次将TTL加1，直至目标地址接收到探测报文，并返回ICMP Port Unreachable消息。\n\n## Wireshark抓包详细分析\n下图为Wireshark抓取的报文的前36个：![packet1-36](get-known-traceroute-by-wireshark/packet1-36.png)\n\n1. 第1和第2个报文为DNS查询，查询whois.radb.net的地址为198.108.0.18。\n\n2. 第3~5的报文为TCP三次握手，并成功建立TCP 连接10.39.101.141:51705<--->198.108.0.18:43，TCP 43端口通常是whois server的端口。\n\n3. 第6个报文由10.39.101.141发向198.108.0.18，并将PSH置位，请求接收端一收到就进行向上交付，以缩短Traceroute的等待时间。\n\n4. 第7个报文发出第一个UDP的探测报文，目标端口号为33435，TTL=1，具体如下：\n\n   ![UDP-Probe-1](get-known-traceroute-by-wireshark/UDP-Probe-1.png)\n\n5. 第8个报文为网关回复的ICMP Time-to-live exceeded (Time to live exceeded in transit)报文，Traceroute从IP报文中的源地址获取路由器的IP地址10.39.101.1。该报文包含原始的UDP报文信息，具体如下：\n\n   ![ICMP-Reply-1](get-known-traceroute-by-wireshark/ICMP-Reply-1.png)\n\n6. 第9个报文为第6个报文的TCP确认报文，第10个报文为向whois.radb.net查询网关10.39.101.1/32所在的AS号。第11个报文为第10个报文的TCP确认，第12个报文答复查询结果，由于该地址为私有IP地址段，没有查询到结果，因此Traceroute 将AS号显示为[AS0]。以下使用第29和30报文，用于展示AS号查询的报文，如下：\n  \n  ![AS-query-1](get-known-traceroute-by-wireshark/AS-query-1.png)\n  \n  ![AS-reply-1](get-known-traceroute-by-wireshark/AS-reply-1.png)\n  \n  查询结果的文本内容如下：\n  \n  ```text\n  route:      222.129.0.0/18\n  descr:      CMI  (Customer Route)\n  origin:     AS4808\n  mnt-by:     MAINT-AS58453\n  changed:    qas_support@cmi.chinamobile.com 20160525\n  source:     RADB\n  \n  route:          222.128.0.0/14\n  descr:          China Unicom Beijing Province Network\n  country:        CN\n  origin:         AS4808\n  mnt-by:         MAINT-CNCGROUP-RR\n  changed:        abuse@cnc-noc.net 20160516\n  source:         APNIC\n  \n  route:      222.129.0.0/18\n  descr:      CMI IP Transit\n  origin:     AS4808\n  admin-c:    MAINT-CMI-INT-HK\n  tech-c:     MAINT-CMI-INT-HK\n  mnt-by:     MAINT-CMI-INT-HK\n  changed:    qas_support@cmi.chinamobile.com 20160525\n  source:     NTTCOM\n  ```\n  \n7. 第14~17报文是DNS解析报文，分别对主机名WERAO-M-40KA进行域名解析，以及对网关IP 10.39.101.1进行反向域名解析，由于是私有主机名和私有地址，自然公网DNS是解析不出来。以下将针对8.8.8.8进行反向域名解析为dns.google的截图作为示例：\n\n   ![dns-query-1](get-known-traceroute-by-wireshark/dns-query-1.png)\n\n8. 报文18\\~26重复报文7\\~17的过程，其中报文18的TTL为2，如下：\n\n   ![UDP-Probe-2](get-known-traceroute-by-wireshark/UDP-Probe-2.png)\n\n   过程持续至8.8.8.8返回Code: 3 (Port unreachable)的消息，并对8.8.8.8进行反向域名解析。\n\n   ![ICMP-last-reply](get-known-traceroute-by-wireshark/ICMP-last-reply.png)\n\n以上详细的分析了**traceroute -aq 1 8.8.8.8**的报文收发过程。\n\n## 后记\n\n在上述的Traceroute完成输出后，Wireshark成功的将Whois的交互报文进行重新组装，并完成内容的解析。\n\n在Wireshark分析完第133个报文后，Wireshark成功的组装出whois的查询报文，如下：\n\n![whois-query](get-known-traceroute-by-wireshark/whois-query.png)\n\n在Wireshark分析完第135个报文后，Wireshark成功的组装出Whois的应答报文，如下：\n\n![whois-answer](get-known-traceroute-by-wireshark/whois-answer.png)\n\n\n\n在Terminal执行whois 8.8.8.8/32，并进行报文抓取，解析出Whois的报文应答如下：\n\n![whois-answer-2](get-known-traceroute-by-wireshark/whois-answer-2.png)\n\n该报文也是Wireshark 拼装了多个TCP Segment，#101、#103、#104、#106、#109后解析出来的。对比该解析结果和上文中，Traceroute过程中的查询结果，可以发现，报文结构是一致的，都被Wireshark解析成Whois的报文。\n\n据此，我推测，MAC电脑上的Traceroute 在增加了-a的参数后，会主动发起Whois查询，缺省的Whois服务器是whois.radb.net。\n\n此部分内容是在Traceroute收发包过程分析完成后，再后知后觉发现的，因此将此部分内容作为“后记”进行记录。\n\n# Traceroute 进阶版工具MTR\n\nMTR （My Traceroute）工具将ping和traceroute命令的功能并入了同一个工具中，实现更强大的功能。相对于traceroute命令只会做一次链路跟踪测试，mtr命令会对链路上的相关节点做持续探测并给出相应的统计信息。\n\n如下为MTR的输出：\n\n```shell\n➜  ~ sudo mtr -ry 4 8.8.8.8\nStart: 2021-06-27T23:37:21+0800\nHOST: WERAO-M-40KA                Loss%   Snt   Last   Avg  Best  Wrst StDev\n  1. ???        localhost          0.0%    10    1.8   2.2   1.2  10.1   2.8\n  2. ???        bogon              0.0%    10    2.2   2.3   1.9   3.3   0.5\n  3. 2003-11-19 222.129.32.1       0.0%    10    6.3   9.5   5.0  29.2   7.7\n  4. 2000-03-14 61.148.163.181     0.0%    10    5.3   7.4   5.3   8.7   1.2\n  5. 2002-04-17 219.232.11.65     70.0%    10    5.4   6.1   5.4   6.8   0.7\n  6. 2006-01-09 124.65.194.153    30.0%    10   28.9   9.6   5.7  28.9   8.5\n  7. 2002-03-21 219.158.112.26    40.0%    10   38.9  44.2  38.5  63.7   9.7\n  8. 2002-03-21 219.158.19.66      0.0%    10   74.4  64.1  46.4  74.4   8.8\n  9. 2002-03-21 219.158.97.25      0.0%    10   90.8  90.8  82.2  96.7   4.3\n 10. 2002-03-21 219.158.20.94      0.0%    10   97.5  89.8  74.1 104.6  11.8\n 11. 2002-03-21 219.158.33.174     0.0%    10   73.0  62.1  49.7  74.0   8.5\n 12. 2012-02-07 108.170.241.65     0.0%    10   59.0  67.3  53.1  75.4   7.2\n 13. 2013-04-04 172.253.69.229    10.0%    10   62.9  68.3  54.5  76.6   6.5\n 14. 1992-12-01 dns.google         0.0%    10   71.0  65.6  56.4  71.0   5.7\n```\n\nMTR命令，通过-r 输出报告，-z 可输出地址所在的AS号，-y 4 可输出该地址的分配时间。\n\n输出信息解释如下：\n\n- 第一列（Host）：节点IP地址和域名。\n- 第二列（Loss%）：节点丢包率。\n- 第三列（Snt）：发送的Ping包数。默认值是10，可以通过参数“-c”指定。\n- 第四列（Last）：最近一次的探测延迟值。\n- 第五、六、七列（Avg、Best、Wrst）：分别是探测延迟的平均值、最小值和最大值。\n- 第八列（StDev）：标准偏差。越大说明相应节点越不稳定。\n\n上述解释引用自：[MTR工具使用说明与结果分析](https://help.aliyun.com/knowledge_detail/98706.html)，略有改动。\n\n# Q&A\n\n1. David Tian:  赞，请教下，为什么ipv4的traceroute 会触发用ipv6去查dns呢？\n\n   答：好眼力，好问题~~实际上，我抓取的报文中，每次得到ICMP报文后，Traceroute也会向208.67.222.222发送DNS请求。但是报文是加密的，看不出是什么内容，不能猜测，所以我将这些不确定的报文删除了。208.67.222.222是OpenDNS的DNS服务器，这是Cisco IT设置的DNS服务器。😄\n\n# 附录\n\n以下是Wireshark抓包文件的前60个报文的概览。\n\n| No.  | Source                    | Destination               | Protocol | Info                                                         |\n| ---- | ------------------------- | ------------------------- | -------- | ------------------------------------------------------------ |\n| 1    | fe80::1c7a:24fd:c837:3017 | fe80::1                   | DNS      | Standard query 0xc7d5 A whois.radb.net                       |\n| 2    | fe80::1                   | fe80::1c7a:24fd:c837:3017 | DNS      | Standard query response 0xc7d5 A whois.radb.net A 198.108.0.18 |\n| 3    | 10.39.101.141             | 198.108.0.18              | TCP      | 51705 → 43 [SYN] Seq=0 Win=65535 Len=0 MSS=1460 WS=64 TSval=2785245374  TSecr=0 SACK_PERM=1 |\n| 4    | 198.108.0.18              | 10.39.101.141             | TCP      | 43 → 51705 [SYN, ACK] Seq=0 Ack=1 Win=28960 Len=0 MSS=1412  TSval=3642352050 TSecr=2785245374 WS=256 |\n| 5    | 10.39.101.141             | 198.108.0.18              | TCP      | 51705 → 43 [ACK] Seq=1 Ack=1 Win=131584 Len=0 TSval=2785245692  TSecr=3642352050 |\n| 6    | 10.39.101.141             | 198.108.0.18              | TCP      | 51705 → 43 [PSH, ACK] Seq=1 Ack=1 Win=131584 Len=3 TSval=2785245692  TSecr=3642352050 [TCP segment of a reassembled PDU] |\n| 7    | 10.39.101.141             | 8.8.8.8                   | UDP      | 36904 → 33435 Len=24                                         |\n| 8    | 10.39.101.1               | 10.39.101.141             | ICMP     | Time-to-live exceeded (Time to live exceeded in transit)     |\n| 9    | 198.108.0.18              | 10.39.101.141             | TCP      | 43 → 51705 [ACK] Seq=1 Ack=4 Win=29184 Len=0 TSval=3642352370  TSecr=2785245692 |\n| 10   | 10.39.101.141             | 198.108.0.18              | TCP      | 51705 → 43 [PSH, ACK] Seq=4 Ack=1 Win=131584 Len=19 TSval=2785246039  TSecr=3642352370 [TCP segment of a reassembled PDU] |\n| 11   | 198.108.0.18              | 10.39.101.141             | TCP      | 43 → 51705 [ACK] Seq=1 Ack=23 Win=29184 Len=0 TSval=3642352717  TSecr=2785246039 |\n| 12   | 198.108.0.18              | 10.39.101.141             | TCP      | 43 → 51705 [PSH, ACK] Seq=1 Ack=23 Win=29184 Len=2 TSval=3642352717  TSecr=2785246039 [TCP segment of a reassembled PDU] |\n| 13   | 10.39.101.141             | 198.108.0.18              | TCP      | 51705 → 43 [ACK] Seq=23 Ack=3 Win=131584 Len=0 TSval=2785246448  TSecr=3642352717 |\n| 14   | fe80::1c7a:24fd:c837:3017 | fe80::1                   | DNS      | Standard query 0x93fc A WERAO-M-40KA                         |\n| 15   | fe80::1                   | fe80::1c7a:24fd:c837:3017 | DNS      | Standard query response 0x93fc No such name A WERAO-M-40KA   |\n| 16   | fe80::1c7a:24fd:c837:3017 | fe80::1                   | DNS      | Standard query 0xbcf9 PTR 1.101.39.10.in-addr.arpa           |\n| 17   | fe80::1                   | fe80::1c7a:24fd:c837:3017 | DNS      | Standard query response 0xbcf9 PTR 1.101.39.10.in-addr.arpa PTR bogon |\n| 18   | 10.39.101.141             | 8.8.8.8                   | UDP      | 36904 → 33436 Len=24                                         |\n| 19   | 192.168.1.1               | 10.39.101.141             | ICMP     | Time-to-live exceeded (Time to live exceeded in transit)     |\n| 20   | 10.39.101.141             | 198.108.0.18              | TCP      | 51705 → 43 [PSH, ACK] Seq=23 Ack=3 Win=131584 Len=19 TSval=2785248590  TSecr=3642352717 [TCP segment of a reassembled PDU] |\n| 21   | 10.39.101.141             | 10.39.101.1               | DNS      | Standard query 0xc81a A WERAO-M-40KA                         |\n| 22   | 10.39.101.1               | 10.39.101.141             | DNS      | Standard query response 0xc81a A WERAO-M-40KA A 10.39.101.141 |\n| 23   | 198.108.0.18              | 10.39.101.141             | TCP      | 43 → 51705 [PSH, ACK] Seq=3 Ack=42 Win=29184 Len=2 TSval=3642355278  TSecr=2785248590 [TCP segment of a reassembled PDU] |\n| 24   | 10.39.101.141             | 198.108.0.18              | TCP      | 51705 → 43 [ACK] Seq=42 Ack=5 Win=131584 Len=0 TSval=2785248902  TSecr=3642355278 |\n| 25   | fe80::1c7a:24fd:c837:3017 | fe80::1                   | DNS      | Standard query 0x7504 PTR 1.1.168.192.in-addr.arpa           |\n| 26   | fe80::1                   | fe80::1c7a:24fd:c837:3017 | DNS      | Standard query response 0x7504 PTR 1.1.168.192.in-addr.arpa PTR localhost |\n| 27   | 10.39.101.141             | 8.8.8.8                   | UDP      | 36904 → 33437 Len=24                                         |\n| 28   | 222.129.32.1              | 10.39.101.141             | ICMP     | Time-to-live exceeded (Time to live exceeded in transit)     |\n| 29   | 10.39.101.141             | 198.108.0.18              | TCP      | 51705 → 43 [PSH, ACK] Seq=42 Ack=5 Win=131584 Len=20 TSval=2785249974  TSecr=3642355278 [TCP segment of a reassembled PDU] |\n| 30   | 198.108.0.18              | 10.39.101.141             | TCP      | 43 → 51705 [PSH, ACK] Seq=5 Ack=62 Win=29184 Len=643 TSval=3642356666  TSecr=2785249974 [TCP segment of a reassembled PDU] |\n| 31   | 10.39.101.141             | 198.108.0.18              | TCP      | 51705 → 43 [ACK] Seq=62 Ack=648 Win=130944 Len=0 TSval=2785250324  TSecr=3642356666 |\n| 32   | fe80::1c7a:24fd:c837:3017 | fe80::1                   | DNS      | Standard query 0x4f56 PTR 1.32.129.222.in-addr.arpa          |\n| 33   | fe80::1                   | fe80::1c7a:24fd:c837:3017 | DNS      | Standard query response 0x4f56 No such name PTR 1.32.129.222.in-addr.arpa |\n| 34   | 10.39.101.141             | 8.8.8.8                   | UDP      | 36904 → 33438 Len=24                                         |\n| 35   | 61.51.101.101             | 10.39.101.141             | ICMP     | Time-to-live exceeded (Time to live exceeded in transit)     |\n| 36   | 10.39.101.141             | 198.108.0.18              | TCP      | 51705 → 43 [PSH, ACK] Seq=62 Ack=648 Win=131072 Len=21 TSval=2785251389  TSecr=3642356666 [TCP segment of a reassembled PDU] |\n| 37   | 198.108.0.18              | 10.39.101.141             | TCP      | 43 → 51705 [PSH, ACK] Seq=648 Ack=83 Win=29184 Len=639 TSval=3642358087  TSecr=2785251389 [TCP segment of a reassembled PDU] |\n| 38   | 10.39.101.141             | 198.108.0.18              | TCP      | 51705 → 43 [ACK] Seq=83 Ack=1287 Win=130432 Len=0 TSval=2785251697  TSecr=3642358087 |\n| 39   | 10.39.101.141             | 10.39.101.1               | DNS      | Standard query 0x521b PTR 1.32.129.222.in-addr.arpa          |\n| 40   | 10.39.101.1               | 10.39.101.141             | DNS      | Standard query response 0x521b No such name PTR 1.32.129.222.in-addr.arpa |\n| 41   | fe80::1c7a:24fd:c837:3017 | fe80::1                   | DNS      | Standard query 0x5931 PTR 101.101.51.61.in-addr.arpa         |\n| 42   | fe80::1                   | fe80::1c7a:24fd:c837:3017 | DNS      | Standard query response 0x5931 No such name PTR  101.101.51.61.in-addr.arpa |\n| 43   | 10.39.101.141             | 8.8.8.8                   | UDP      | 36904 → 33439 Len=24                                         |\n| 44   | 219.232.11.29             | 10.39.101.141             | ICMP     | Time-to-live exceeded (Time to live exceeded in transit)     |\n| 45   | 10.39.101.141             | 198.108.0.18              | TCP      | 51705 → 43 [PSH, ACK] Seq=83 Ack=1287 Win=131072 Len=21 TSval=2785252732  TSecr=3642358087 [TCP segment of a reassembled PDU] |\n| 46   | 198.108.0.18              | 10.39.101.141             | TCP      | 43 → 51705 [PSH, ACK] Seq=1287 Ack=104 Win=29184 Len=418 TSval=3642359437  TSecr=2785252732 [TCP segment of a reassembled PDU] |\n| 47   | 10.39.101.141             | 198.108.0.18              | TCP      | 51705 → 43 [ACK] Seq=104 Ack=1705 Win=130624 Len=0 TSval=2785253042  TSecr=3642359437 |\n| 48   | fe80::1c7a:24fd:c837:3017 | fe80::1                   | DNS      | Standard query 0x7d09 PTR 29.11.232.219.in-addr.arpa         |\n| 49   | fe80::1                   | fe80::1c7a:24fd:c837:3017 | DNS      | Standard query response 0x7d09 No such name PTR  29.11.232.219.in-addr.arpa |\n| 50   | 10.39.101.141             | 8.8.8.8                   | UDP      | 36904 → 33440 Len=24                                         |\n| 51   | 202.96.12.13              | 10.39.101.141             | ICMP     | Time-to-live exceeded (Time to live exceeded in transit)     |\n| 52   | 10.39.101.141             | 198.108.0.18              | TCP      | 51705 → 43 [PSH, ACK] Seq=104 Ack=1705 Win=131072 Len=20 TSval=2785254068  TSecr=3642359437 [TCP segment of a reassembled PDU] |\n| 53   | 10.39.101.141             | 10.39.101.1               | DNS      | Standard query 0x961b PTR 101.101.51.61.in-addr.arpa         |\n| 54   | 10.39.101.1               | 10.39.101.141             | DNS      | Standard query response 0x961b No such name PTR  101.101.51.61.in-addr.arpa |\n| 55   | 198.108.0.18              | 10.39.101.141             | TCP      | 43 → 51705 [PSH, ACK] Seq=1705 Ack=124 Win=29184 Len=642 TSval=3642360779  TSecr=2785254068 [TCP segment of a reassembled PDU] |\n| 56   | 10.39.101.141             | 198.108.0.18              | TCP      | 51705 → 43 [ACK] Seq=124 Ack=2347 Win=130368 Len=0 TSval=2785254400  TSecr=3642360779 |\n| 57   | fe80::1c7a:24fd:c837:3017 | fe80::1                   | DNS      | Standard query 0xb016 PTR 13.12.96.202.in-addr.arpa          |\n| 58   | fe80::1                   | fe80::1c7a:24fd:c837:3017 | DNS      | Standard query response 0xb016 No such name PTR 13.12.96.202.in-addr.arpa  SOA beijing.cn.net |\n| 59   | 10.39.101.141             | 8.8.8.8                   | UDP      | 36904 → 33441 Len=24                                         |\n| 60   | 219.158.112.46            | 10.39.101.141             | ICMP     | Time-to-live exceeded (Time to live exceeded in transit)     |\n\n[抓包文件下载](get-known-traceroute-by-wireshark/traceroute-google-dns.pcapng)\n\n","slug":"get-known-traceroute-by-wireshark","published":1,"updated":"2025-12-14T09:50:07.459Z","comments":1,"layout":"post","photos":[],"_id":"cuidP4cJUhUqjSVn67nvwwNua","content":"<h1 id=\"初识Traceroute\"><a href=\"#初识Traceroute\" class=\"headerlink\" title=\"初识Traceroute\"></a>初识Traceroute</h1><p>Traceroute是一种常见的网络分析工具，用于探测数据包从源地址到目的地址经过的路由器的IP地址。</p>\n<p>以下的示例显示从一个MAC电脑到8.8.8.8的路径探测结果：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  ~ traceroute 8.8.8.8</span><br><span class=\"line\">traceroute to 8.8.8.8 (8.8.8.8), 64 hops max, 52 byte packets</span><br><span class=\"line\"> 1  localhost (10.39.101.1)  8.662 ms  1.307 ms  1.155 ms</span><br><span class=\"line\"> 2  localhost (192.168.1.1)  2.287 ms  2.157 ms  1.897 ms</span><br><span class=\"line\"> 3  222.129.32.1 (222.129.32.1)  5.844 ms  13.092 ms  10.332 ms</span><br><span class=\"line\"> 4  114.244.95.105 (114.244.95.105)  7.541 ms</span><br><span class=\"line\">    61.51.101.101 (61.51.101.101)  7.420 ms</span><br><span class=\"line\">    61.148.163.81 (61.148.163.81)  7.075 ms</span><br><span class=\"line\"> 5  61.148.4.213 (61.148.4.213)  7.759 ms</span><br><span class=\"line\">    219.232.11.65 (219.232.11.65)  5.976 ms</span><br><span class=\"line\">    bt-230-081.bta.net.cn (202.106.230.81)  6.021 ms</span><br><span class=\"line\"> 6  202.96.12.13 (202.96.12.13)  7.828 ms * *</span><br><span class=\"line\"> 7  219.158.112.26 (219.158.112.26)  39.486 ms *</span><br><span class=\"line\">    219.158.7.22 (219.158.7.22)  45.959 ms</span><br><span class=\"line\"> 8  219.158.103.218 (219.158.103.218)  48.469 ms</span><br><span class=\"line\">    219.158.97.2 (219.158.97.2)  47.146 ms</span><br><span class=\"line\">    219.158.103.218 (219.158.103.218)  50.320 ms</span><br><span class=\"line\"> 9  219.158.103.30 (219.158.103.30)  50.739 ms  50.382 ms  48.348 ms</span><br><span class=\"line\">10  219.158.10.30 (219.158.10.30)  49.927 ms  44.264 ms  56.353 ms</span><br><span class=\"line\">11  219.158.33.174 (219.158.33.174)  54.123 ms  61.131 ms  47.302 ms</span><br><span class=\"line\">12  108.170.241.97 (108.170.241.97)  56.082 ms</span><br><span class=\"line\">    108.170.241.33 (108.170.241.33)  52.942 ms  54.393 ms</span><br><span class=\"line\">13  142.250.58.189 (142.250.58.189)  48.958 ms</span><br><span class=\"line\">    209.85.143.37 (209.85.143.37)  51.217 ms</span><br><span class=\"line\">    108.170.226.115 (108.170.226.115)  141.544 ms</span><br><span class=\"line\">14  dns.google (8.8.8.8)  48.935 ms  46.364 ms  51.043 ms</span><br><span class=\"line\"></span><br><span class=\"line\">➜  ~ ping 8.8.8.8</span><br><span class=\"line\">PING 8.8.8.8 (8.8.8.8): 56 data bytes</span><br><span class=\"line\">64 bytes from 8.8.8.8: icmp_seq=0 ttl=113 time=52.060 ms</span><br><span class=\"line\">64 bytes from 8.8.8.8: icmp_seq=1 ttl=113 time=44.845 ms</span><br><span class=\"line\">64 bytes from 8.8.8.8: icmp_seq=2 ttl=113 time=52.393 ms</span><br><span class=\"line\">64 bytes from 8.8.8.8: icmp_seq=3 ttl=113 time=51.059 ms</span><br><span class=\"line\">64 bytes from 8.8.8.8: icmp_seq=4 ttl=113 time=44.437 ms</span><br><span class=\"line\">64 bytes from 8.8.8.8: icmp_seq=5 ttl=113 time=44.534 ms</span><br><span class=\"line\">^C</span><br><span class=\"line\">--- 8.8.8.8 ping statistics ---</span><br><span class=\"line\">6 packets transmitted, 6 packets received, 0.0% packet loss</span><br><span class=\"line\">round-trip min/avg/max/stddev = 44.437/48.221/52.393/3.640 ms</span><br></pre></td></tr></table></figure>\n\n<p>输出结果表明：</p>\n<ol>\n<li>从MAC电脑到8.8.8.8的路径包含14个网络节点。</li>\n<li>每个节点后面都显示时延信息，表明从MAC电脑到该节点的往返时延。您可能会发现，中间的某些节点往返时延可能要高于更远的节点的往返时延。这是由于该时延包含了路由器将TTL&#x3D;0的报文交给控制面处理的时延，因而往往比路径上的传播时延要高，尤其是当控制面CPU繁忙时。Traceroute对每一个节点发出3个探测报文，每个报文的路径不尽相同，例如在第4、5、7、8、12、13跳经过不同的路由器转发。</li>\n<li>有的探测没有得到回应，因此在有的节点本应显示时延信息的，显示了*。这并不能断定中间的网络不可达，很可能的原因是该节点的路由器在接口上配置了 <em><strong>no ip unreachable</strong></em> 命令，该接口不回应ICMP Unreachable消息，而该消息正是Traceroute探测路径所依赖的信息来源。</li>\n</ol>\n<p>接下来，我们简要描述一下，在MAC电脑下，Traceroute的工作原理，并使用Wireshark进一步的探究Traceroute的工作过程。</p>\n<h1 id=\"Traceroute的工作原理\"><a href=\"#Traceroute的工作原理\" class=\"headerlink\" title=\"Traceroute的工作原理\"></a>Traceroute的工作原理</h1><p>每当IP数据包经过一个路由器，其存活时间TTL就会减1。当其存活时间是0时，主机便取消数据包，并发送一个ICMP TTL超时数据包给原数据包的发出者。Traceroute程序通过向目的地址发送一系列的探测包，设置探测包的TTL初始值分别为1,2,3…，根据返回的超时通知（ICMP Time Exceeded Message）得到源地址与目的地址之间的每一跳路由信息。</p>\n<p><img src=\"/get-known-traceroute-by-wireshark/Traceroute-work.png\" alt=\"Traceroute 的工作原理\"></p>\n<ol>\n<li><p>从源地址发出一个UDP探测包到目的地址，并将TTL设置为1；</p>\n</li>\n<li><p>到达路由器时，将TTL减1；</p>\n</li>\n<li><p>当TTL变为0时，包被丢弃，路由器向源地址发回一个ICMP超时通知（ICMP Time Exceeded Message），内含发送IP包的源地址，IP包的所有内容及路由器的IP地址；</p>\n</li>\n<li><p>当源地址收到该ICMP包时，显示这一跳路由信息；</p>\n</li>\n<li><p>重复1～5，并每次设置TTL加1；</p>\n</li>\n<li><p>直至目标地址收到探测数据包，并返回端口不可达通知（ICMP Port Unreachable）；</p>\n</li>\n<li><p>当源地址收到ICMP Port Unreachable包时停止traceroute。</p>\n</li>\n</ol>\n<p>以上内容引自<a href=\"https://blog.csdn.net/shb_derek1/article/details/100097050\">Traceroute&#x2F;tracert原理和实践</a></p>\n<h1 id=\"通过Wireshark探究Traceroute\"><a href=\"#通过Wireshark探究Traceroute\" class=\"headerlink\" title=\"通过Wireshark探究Traceroute\"></a>通过Wireshark探究Traceroute</h1><h2 id=\"在Traceroute输出结果中显示AS号\"><a href=\"#在Traceroute输出结果中显示AS号\" class=\"headerlink\" title=\"在Traceroute输出结果中显示AS号\"></a>在Traceroute输出结果中显示AS号</h2><p>在Mac电脑的Traceroute命令中，通过’-a’的参数可以开启路径中遇到的IP地址所在的BGP AS号，以便于获知路径中每一跳所归属的运营商，通过’-q 1’可将缺省发送3个探测报文改为发送1个探测报文，输出示例如下：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  ~ traceroute -aq 1 8.8.8.8</span><br><span class=\"line\">traceroute to 8.8.8.8 (8.8.8.8), 64 hops max, 52 byte packets</span><br><span class=\"line\"> 1  [AS0] bogon (10.39.101.1)  2.424 ms</span><br><span class=\"line\"> 2  [AS0] localhost (192.168.1.1)  3.031 ms</span><br><span class=\"line\"> 3  [AS4808] 222.129.32.1 (222.129.32.1)  6.496 ms</span><br><span class=\"line\"> 4  [AS4808] 61.51.101.101 (61.51.101.101)  8.114 ms</span><br><span class=\"line\"> 5  [AS17431] 219.232.11.29 (219.232.11.29)  5.865 ms</span><br><span class=\"line\"> 6  [AS4808] 202.96.12.13 (202.96.12.13)  6.558 ms</span><br><span class=\"line\"> 7  [AS4837] 219.158.112.46 (219.158.112.46)  44.826 ms</span><br><span class=\"line\"> 8  [AS4837] 219.158.103.218 (219.158.103.218)  52.181 ms</span><br><span class=\"line\"> 9  [AS4837] 219.158.103.30 (219.158.103.30)  47.851 ms</span><br><span class=\"line\">10  [AS4837] 219.158.10.30 (219.158.10.30)  56.963 ms</span><br><span class=\"line\">11  [AS4837] 219.158.33.174 (219.158.33.174)  46.523 ms</span><br><span class=\"line\">12  [AS15169] 108.170.241.1 (108.170.241.1)  48.503 ms</span><br><span class=\"line\">13  [AS15169] 172.253.64.111 (172.253.64.111)  142.926 ms</span><br><span class=\"line\">14  [AS15169] dns.google (8.8.8.8)  52.208 ms</span><br></pre></td></tr></table></figure>\n<p>上述的AS编号信息是如何获得的？下面我们通过Wireshark抓取报文进行分析。</p>\n<h2 id=\"上述Traceroute的收发包过程简述\"><a href=\"#上述Traceroute的收发包过程简述\" class=\"headerlink\" title=\"上述Traceroute的收发包过程简述\"></a>上述Traceroute的收发包过程简述</h2><p>开启Wireshark，并迅速执行<strong>traceroute -aq 1 8.8.8.8</strong>，Traceroute完整输出后，停止Wireshark的报文抓取。<br>针对抓取的报文进行过滤，在过滤框中输入 <strong>udp or icmp or ip.addr &#x3D;&#x3D; 198.108.0.18</strong><br>经过Wireshark的报文分析，以下为Traceroute的简要的收发包过程：</p>\n<ol>\n<li>发起DNS查询，查询<strong>whois.radb.net</strong>域名，得到应答为198.108.0.18—-上述过滤器中IP地址来源于此。</li>\n<li>发起TCP连接请求，与198.108.0.18建立TCP连接。</li>\n<li>向8.8.8.8发起UDP报文，目的端口为33435，TTL设置为1</li>\n<li>收到路由器的ICMP TTL超时消息，获取路由器对应的IP地址</li>\n<li>向<strong>whois.radb.net</strong>发起查询，询问路由器IP地址对应的AS号，并得到回应，如果是私有地址，其AS号为0。</li>\n<li>尝试向DNS服务器查询路由器IP地址的反向域名解析，如果得到域名，就将其显示在Traceroute的输出结果中。</li>\n<li>重复上述第3~6步，每次将TTL加1，直至目标地址接收到探测报文，并返回ICMP Port Unreachable消息。</li>\n</ol>\n<h2 id=\"Wireshark抓包详细分析\"><a href=\"#Wireshark抓包详细分析\" class=\"headerlink\" title=\"Wireshark抓包详细分析\"></a>Wireshark抓包详细分析</h2><p>下图为Wireshark抓取的报文的前36个：<img src=\"/get-known-traceroute-by-wireshark/packet1-36.png\" alt=\"packet1-36\"></p>\n<ol>\n<li><p>第1和第2个报文为DNS查询，查询whois.radb.net的地址为198.108.0.18。</p>\n</li>\n<li><p>第3~5的报文为TCP三次握手，并成功建立TCP 连接10.39.101.141:51705&lt;—&gt;198.108.0.18:43，TCP 43端口通常是whois server的端口。</p>\n</li>\n<li><p>第6个报文由10.39.101.141发向198.108.0.18，并将PSH置位，请求接收端一收到就进行向上交付，以缩短Traceroute的等待时间。</p>\n</li>\n<li><p>第7个报文发出第一个UDP的探测报文，目标端口号为33435，TTL&#x3D;1，具体如下：</p>\n<p><img src=\"/get-known-traceroute-by-wireshark/UDP-Probe-1.png\" alt=\"UDP-Probe-1\"></p>\n</li>\n<li><p>第8个报文为网关回复的ICMP Time-to-live exceeded (Time to live exceeded in transit)报文，Traceroute从IP报文中的源地址获取路由器的IP地址10.39.101.1。该报文包含原始的UDP报文信息，具体如下：</p>\n<p><img src=\"/get-known-traceroute-by-wireshark/ICMP-Reply-1.png\" alt=\"ICMP-Reply-1\"></p>\n</li>\n<li><p>第9个报文为第6个报文的TCP确认报文，第10个报文为向whois.radb.net查询网关10.39.101.1&#x2F;32所在的AS号。第11个报文为第10个报文的TCP确认，第12个报文答复查询结果，由于该地址为私有IP地址段，没有查询到结果，因此Traceroute 将AS号显示为[AS0]。以下使用第29和30报文，用于展示AS号查询的报文，如下：</p>\n</li>\n</ol>\n<p>  <img src=\"/get-known-traceroute-by-wireshark/AS-query-1.png\" alt=\"AS-query-1\"></p>\n<p>  <img src=\"/get-known-traceroute-by-wireshark/AS-reply-1.png\" alt=\"AS-reply-1\"></p>\n<p>  查询结果的文本内容如下：</p>\n  <figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">route:      222.129.0.0/18</span><br><span class=\"line\">descr:      CMI  (Customer Route)</span><br><span class=\"line\">origin:     AS4808</span><br><span class=\"line\">mnt-by:     MAINT-AS58453</span><br><span class=\"line\">changed:    qas_support@cmi.chinamobile.com 20160525</span><br><span class=\"line\">source:     RADB</span><br><span class=\"line\"></span><br><span class=\"line\">route:          222.128.0.0/14</span><br><span class=\"line\">descr:          China Unicom Beijing Province Network</span><br><span class=\"line\">country:        CN</span><br><span class=\"line\">origin:         AS4808</span><br><span class=\"line\">mnt-by:         MAINT-CNCGROUP-RR</span><br><span class=\"line\">changed:        abuse@cnc-noc.net 20160516</span><br><span class=\"line\">source:         APNIC</span><br><span class=\"line\"></span><br><span class=\"line\">route:      222.129.0.0/18</span><br><span class=\"line\">descr:      CMI IP Transit</span><br><span class=\"line\">origin:     AS4808</span><br><span class=\"line\">admin-c:    MAINT-CMI-INT-HK</span><br><span class=\"line\">tech-c:     MAINT-CMI-INT-HK</span><br><span class=\"line\">mnt-by:     MAINT-CMI-INT-HK</span><br><span class=\"line\">changed:    qas_support@cmi.chinamobile.com 20160525</span><br><span class=\"line\">source:     NTTCOM</span><br></pre></td></tr></table></figure>\n<ol start=\"7\">\n<li><p>第14~17报文是DNS解析报文，分别对主机名WERAO-M-40KA进行域名解析，以及对网关IP 10.39.101.1进行反向域名解析，由于是私有主机名和私有地址，自然公网DNS是解析不出来。以下将针对8.8.8.8进行反向域名解析为dns.google的截图作为示例：</p>\n<p><img src=\"/get-known-traceroute-by-wireshark/dns-query-1.png\" alt=\"dns-query-1\"></p>\n</li>\n<li><p>报文18~26重复报文7~17的过程，其中报文18的TTL为2，如下：</p>\n<p><img src=\"/get-known-traceroute-by-wireshark/UDP-Probe-2.png\" alt=\"UDP-Probe-2\"></p>\n<p>过程持续至8.8.8.8返回Code: 3 (Port unreachable)的消息，并对8.8.8.8进行反向域名解析。</p>\n<p><img src=\"/get-known-traceroute-by-wireshark/ICMP-last-reply.png\" alt=\"ICMP-last-reply\"></p>\n</li>\n</ol>\n<p>以上详细的分析了<strong>traceroute -aq 1 8.8.8.8</strong>的报文收发过程。</p>\n<h2 id=\"后记\"><a href=\"#后记\" class=\"headerlink\" title=\"后记\"></a>后记</h2><p>在上述的Traceroute完成输出后，Wireshark成功的将Whois的交互报文进行重新组装，并完成内容的解析。</p>\n<p>在Wireshark分析完第133个报文后，Wireshark成功的组装出whois的查询报文，如下：</p>\n<p><img src=\"/get-known-traceroute-by-wireshark/whois-query.png\" alt=\"whois-query\"></p>\n<p>在Wireshark分析完第135个报文后，Wireshark成功的组装出Whois的应答报文，如下：</p>\n<p><img src=\"/get-known-traceroute-by-wireshark/whois-answer.png\" alt=\"whois-answer\"></p>\n<p>在Terminal执行whois 8.8.8.8&#x2F;32，并进行报文抓取，解析出Whois的报文应答如下：</p>\n<p><img src=\"/get-known-traceroute-by-wireshark/whois-answer-2.png\" alt=\"whois-answer-2\"></p>\n<p>该报文也是Wireshark 拼装了多个TCP Segment，#101、#103、#104、#106、#109后解析出来的。对比该解析结果和上文中，Traceroute过程中的查询结果，可以发现，报文结构是一致的，都被Wireshark解析成Whois的报文。</p>\n<p>据此，我推测，MAC电脑上的Traceroute 在增加了-a的参数后，会主动发起Whois查询，缺省的Whois服务器是whois.radb.net。</p>\n<p>此部分内容是在Traceroute收发包过程分析完成后，再后知后觉发现的，因此将此部分内容作为“后记”进行记录。</p>\n<h1 id=\"Traceroute-进阶版工具MTR\"><a href=\"#Traceroute-进阶版工具MTR\" class=\"headerlink\" title=\"Traceroute 进阶版工具MTR\"></a>Traceroute 进阶版工具MTR</h1><p>MTR （My Traceroute）工具将ping和traceroute命令的功能并入了同一个工具中，实现更强大的功能。相对于traceroute命令只会做一次链路跟踪测试，mtr命令会对链路上的相关节点做持续探测并给出相应的统计信息。</p>\n<p>如下为MTR的输出：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  ~ sudo mtr -ry 4 8.8.8.8</span><br><span class=\"line\">Start: 2021-06-27T23:37:21+0800</span><br><span class=\"line\">HOST: WERAO-M-40KA                Loss%   Snt   Last   Avg  Best  Wrst StDev</span><br><span class=\"line\">  1. ???        localhost          0.0%    10    1.8   2.2   1.2  10.1   2.8</span><br><span class=\"line\">  2. ???        bogon              0.0%    10    2.2   2.3   1.9   3.3   0.5</span><br><span class=\"line\">  3. 2003-11-19 222.129.32.1       0.0%    10    6.3   9.5   5.0  29.2   7.7</span><br><span class=\"line\">  4. 2000-03-14 61.148.163.181     0.0%    10    5.3   7.4   5.3   8.7   1.2</span><br><span class=\"line\">  5. 2002-04-17 219.232.11.65     70.0%    10    5.4   6.1   5.4   6.8   0.7</span><br><span class=\"line\">  6. 2006-01-09 124.65.194.153    30.0%    10   28.9   9.6   5.7  28.9   8.5</span><br><span class=\"line\">  7. 2002-03-21 219.158.112.26    40.0%    10   38.9  44.2  38.5  63.7   9.7</span><br><span class=\"line\">  8. 2002-03-21 219.158.19.66      0.0%    10   74.4  64.1  46.4  74.4   8.8</span><br><span class=\"line\">  9. 2002-03-21 219.158.97.25      0.0%    10   90.8  90.8  82.2  96.7   4.3</span><br><span class=\"line\"> 10. 2002-03-21 219.158.20.94      0.0%    10   97.5  89.8  74.1 104.6  11.8</span><br><span class=\"line\"> 11. 2002-03-21 219.158.33.174     0.0%    10   73.0  62.1  49.7  74.0   8.5</span><br><span class=\"line\"> 12. 2012-02-07 108.170.241.65     0.0%    10   59.0  67.3  53.1  75.4   7.2</span><br><span class=\"line\"> 13. 2013-04-04 172.253.69.229    10.0%    10   62.9  68.3  54.5  76.6   6.5</span><br><span class=\"line\"> 14. 1992-12-01 dns.google         0.0%    10   71.0  65.6  56.4  71.0   5.7</span><br></pre></td></tr></table></figure>\n\n<p>MTR命令，通过-r 输出报告，-z 可输出地址所在的AS号，-y 4 可输出该地址的分配时间。</p>\n<p>输出信息解释如下：</p>\n<ul>\n<li>第一列（Host）：节点IP地址和域名。</li>\n<li>第二列（Loss%）：节点丢包率。</li>\n<li>第三列（Snt）：发送的Ping包数。默认值是10，可以通过参数“-c”指定。</li>\n<li>第四列（Last）：最近一次的探测延迟值。</li>\n<li>第五、六、七列（Avg、Best、Wrst）：分别是探测延迟的平均值、最小值和最大值。</li>\n<li>第八列（StDev）：标准偏差。越大说明相应节点越不稳定。</li>\n</ul>\n<p>上述解释引用自：<a href=\"https://help.aliyun.com/knowledge_detail/98706.html\">MTR工具使用说明与结果分析</a>，略有改动。</p>\n<h1 id=\"Q-A\"><a href=\"#Q-A\" class=\"headerlink\" title=\"Q&amp;A\"></a>Q&amp;A</h1><ol>\n<li><p>David Tian:  赞，请教下，为什么ipv4的traceroute 会触发用ipv6去查dns呢？</p>\n<p>答：好眼力，好问题~~实际上，我抓取的报文中，每次得到ICMP报文后，Traceroute也会向208.67.222.222发送DNS请求。但是报文是加密的，看不出是什么内容，不能猜测，所以我将这些不确定的报文删除了。208.67.222.222是OpenDNS的DNS服务器，这是Cisco IT设置的DNS服务器。😄</p>\n</li>\n</ol>\n<h1 id=\"附录\"><a href=\"#附录\" class=\"headerlink\" title=\"附录\"></a>附录</h1><p>以下是Wireshark抓包文件的前60个报文的概览。</p>\n<table>\n<thead>\n<tr>\n<th>No.</th>\n<th>Source</th>\n<th>Destination</th>\n<th>Protocol</th>\n<th>Info</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>1</td>\n<td>fe80::1c7a:24fd:c837:3017</td>\n<td>fe80::1</td>\n<td>DNS</td>\n<td>Standard query 0xc7d5 A whois.radb.net</td>\n</tr>\n<tr>\n<td>2</td>\n<td>fe80::1</td>\n<td>fe80::1c7a:24fd:c837:3017</td>\n<td>DNS</td>\n<td>Standard query response 0xc7d5 A whois.radb.net A 198.108.0.18</td>\n</tr>\n<tr>\n<td>3</td>\n<td>10.39.101.141</td>\n<td>198.108.0.18</td>\n<td>TCP</td>\n<td>51705 → 43 [SYN] Seq&#x3D;0 Win&#x3D;65535 Len&#x3D;0 MSS&#x3D;1460 WS&#x3D;64 TSval&#x3D;2785245374  TSecr&#x3D;0 SACK_PERM&#x3D;1</td>\n</tr>\n<tr>\n<td>4</td>\n<td>198.108.0.18</td>\n<td>10.39.101.141</td>\n<td>TCP</td>\n<td>43 → 51705 [SYN, ACK] Seq&#x3D;0 Ack&#x3D;1 Win&#x3D;28960 Len&#x3D;0 MSS&#x3D;1412  TSval&#x3D;3642352050 TSecr&#x3D;2785245374 WS&#x3D;256</td>\n</tr>\n<tr>\n<td>5</td>\n<td>10.39.101.141</td>\n<td>198.108.0.18</td>\n<td>TCP</td>\n<td>51705 → 43 [ACK] Seq&#x3D;1 Ack&#x3D;1 Win&#x3D;131584 Len&#x3D;0 TSval&#x3D;2785245692  TSecr&#x3D;3642352050</td>\n</tr>\n<tr>\n<td>6</td>\n<td>10.39.101.141</td>\n<td>198.108.0.18</td>\n<td>TCP</td>\n<td>51705 → 43 [PSH, ACK] Seq&#x3D;1 Ack&#x3D;1 Win&#x3D;131584 Len&#x3D;3 TSval&#x3D;2785245692  TSecr&#x3D;3642352050 [TCP segment of a reassembled PDU]</td>\n</tr>\n<tr>\n<td>7</td>\n<td>10.39.101.141</td>\n<td>8.8.8.8</td>\n<td>UDP</td>\n<td>36904 → 33435 Len&#x3D;24</td>\n</tr>\n<tr>\n<td>8</td>\n<td>10.39.101.1</td>\n<td>10.39.101.141</td>\n<td>ICMP</td>\n<td>Time-to-live exceeded (Time to live exceeded in transit)</td>\n</tr>\n<tr>\n<td>9</td>\n<td>198.108.0.18</td>\n<td>10.39.101.141</td>\n<td>TCP</td>\n<td>43 → 51705 [ACK] Seq&#x3D;1 Ack&#x3D;4 Win&#x3D;29184 Len&#x3D;0 TSval&#x3D;3642352370  TSecr&#x3D;2785245692</td>\n</tr>\n<tr>\n<td>10</td>\n<td>10.39.101.141</td>\n<td>198.108.0.18</td>\n<td>TCP</td>\n<td>51705 → 43 [PSH, ACK] Seq&#x3D;4 Ack&#x3D;1 Win&#x3D;131584 Len&#x3D;19 TSval&#x3D;2785246039  TSecr&#x3D;3642352370 [TCP segment of a reassembled PDU]</td>\n</tr>\n<tr>\n<td>11</td>\n<td>198.108.0.18</td>\n<td>10.39.101.141</td>\n<td>TCP</td>\n<td>43 → 51705 [ACK] Seq&#x3D;1 Ack&#x3D;23 Win&#x3D;29184 Len&#x3D;0 TSval&#x3D;3642352717  TSecr&#x3D;2785246039</td>\n</tr>\n<tr>\n<td>12</td>\n<td>198.108.0.18</td>\n<td>10.39.101.141</td>\n<td>TCP</td>\n<td>43 → 51705 [PSH, ACK] Seq&#x3D;1 Ack&#x3D;23 Win&#x3D;29184 Len&#x3D;2 TSval&#x3D;3642352717  TSecr&#x3D;2785246039 [TCP segment of a reassembled PDU]</td>\n</tr>\n<tr>\n<td>13</td>\n<td>10.39.101.141</td>\n<td>198.108.0.18</td>\n<td>TCP</td>\n<td>51705 → 43 [ACK] Seq&#x3D;23 Ack&#x3D;3 Win&#x3D;131584 Len&#x3D;0 TSval&#x3D;2785246448  TSecr&#x3D;3642352717</td>\n</tr>\n<tr>\n<td>14</td>\n<td>fe80::1c7a:24fd:c837:3017</td>\n<td>fe80::1</td>\n<td>DNS</td>\n<td>Standard query 0x93fc A WERAO-M-40KA</td>\n</tr>\n<tr>\n<td>15</td>\n<td>fe80::1</td>\n<td>fe80::1c7a:24fd:c837:3017</td>\n<td>DNS</td>\n<td>Standard query response 0x93fc No such name A WERAO-M-40KA</td>\n</tr>\n<tr>\n<td>16</td>\n<td>fe80::1c7a:24fd:c837:3017</td>\n<td>fe80::1</td>\n<td>DNS</td>\n<td>Standard query 0xbcf9 PTR 1.101.39.10.in-addr.arpa</td>\n</tr>\n<tr>\n<td>17</td>\n<td>fe80::1</td>\n<td>fe80::1c7a:24fd:c837:3017</td>\n<td>DNS</td>\n<td>Standard query response 0xbcf9 PTR 1.101.39.10.in-addr.arpa PTR bogon</td>\n</tr>\n<tr>\n<td>18</td>\n<td>10.39.101.141</td>\n<td>8.8.8.8</td>\n<td>UDP</td>\n<td>36904 → 33436 Len&#x3D;24</td>\n</tr>\n<tr>\n<td>19</td>\n<td>192.168.1.1</td>\n<td>10.39.101.141</td>\n<td>ICMP</td>\n<td>Time-to-live exceeded (Time to live exceeded in transit)</td>\n</tr>\n<tr>\n<td>20</td>\n<td>10.39.101.141</td>\n<td>198.108.0.18</td>\n<td>TCP</td>\n<td>51705 → 43 [PSH, ACK] Seq&#x3D;23 Ack&#x3D;3 Win&#x3D;131584 Len&#x3D;19 TSval&#x3D;2785248590  TSecr&#x3D;3642352717 [TCP segment of a reassembled PDU]</td>\n</tr>\n<tr>\n<td>21</td>\n<td>10.39.101.141</td>\n<td>10.39.101.1</td>\n<td>DNS</td>\n<td>Standard query 0xc81a A WERAO-M-40KA</td>\n</tr>\n<tr>\n<td>22</td>\n<td>10.39.101.1</td>\n<td>10.39.101.141</td>\n<td>DNS</td>\n<td>Standard query response 0xc81a A WERAO-M-40KA A 10.39.101.141</td>\n</tr>\n<tr>\n<td>23</td>\n<td>198.108.0.18</td>\n<td>10.39.101.141</td>\n<td>TCP</td>\n<td>43 → 51705 [PSH, ACK] Seq&#x3D;3 Ack&#x3D;42 Win&#x3D;29184 Len&#x3D;2 TSval&#x3D;3642355278  TSecr&#x3D;2785248590 [TCP segment of a reassembled PDU]</td>\n</tr>\n<tr>\n<td>24</td>\n<td>10.39.101.141</td>\n<td>198.108.0.18</td>\n<td>TCP</td>\n<td>51705 → 43 [ACK] Seq&#x3D;42 Ack&#x3D;5 Win&#x3D;131584 Len&#x3D;0 TSval&#x3D;2785248902  TSecr&#x3D;3642355278</td>\n</tr>\n<tr>\n<td>25</td>\n<td>fe80::1c7a:24fd:c837:3017</td>\n<td>fe80::1</td>\n<td>DNS</td>\n<td>Standard query 0x7504 PTR 1.1.168.192.in-addr.arpa</td>\n</tr>\n<tr>\n<td>26</td>\n<td>fe80::1</td>\n<td>fe80::1c7a:24fd:c837:3017</td>\n<td>DNS</td>\n<td>Standard query response 0x7504 PTR 1.1.168.192.in-addr.arpa PTR localhost</td>\n</tr>\n<tr>\n<td>27</td>\n<td>10.39.101.141</td>\n<td>8.8.8.8</td>\n<td>UDP</td>\n<td>36904 → 33437 Len&#x3D;24</td>\n</tr>\n<tr>\n<td>28</td>\n<td>222.129.32.1</td>\n<td>10.39.101.141</td>\n<td>ICMP</td>\n<td>Time-to-live exceeded (Time to live exceeded in transit)</td>\n</tr>\n<tr>\n<td>29</td>\n<td>10.39.101.141</td>\n<td>198.108.0.18</td>\n<td>TCP</td>\n<td>51705 → 43 [PSH, ACK] Seq&#x3D;42 Ack&#x3D;5 Win&#x3D;131584 Len&#x3D;20 TSval&#x3D;2785249974  TSecr&#x3D;3642355278 [TCP segment of a reassembled PDU]</td>\n</tr>\n<tr>\n<td>30</td>\n<td>198.108.0.18</td>\n<td>10.39.101.141</td>\n<td>TCP</td>\n<td>43 → 51705 [PSH, ACK] Seq&#x3D;5 Ack&#x3D;62 Win&#x3D;29184 Len&#x3D;643 TSval&#x3D;3642356666  TSecr&#x3D;2785249974 [TCP segment of a reassembled PDU]</td>\n</tr>\n<tr>\n<td>31</td>\n<td>10.39.101.141</td>\n<td>198.108.0.18</td>\n<td>TCP</td>\n<td>51705 → 43 [ACK] Seq&#x3D;62 Ack&#x3D;648 Win&#x3D;130944 Len&#x3D;0 TSval&#x3D;2785250324  TSecr&#x3D;3642356666</td>\n</tr>\n<tr>\n<td>32</td>\n<td>fe80::1c7a:24fd:c837:3017</td>\n<td>fe80::1</td>\n<td>DNS</td>\n<td>Standard query 0x4f56 PTR 1.32.129.222.in-addr.arpa</td>\n</tr>\n<tr>\n<td>33</td>\n<td>fe80::1</td>\n<td>fe80::1c7a:24fd:c837:3017</td>\n<td>DNS</td>\n<td>Standard query response 0x4f56 No such name PTR 1.32.129.222.in-addr.arpa</td>\n</tr>\n<tr>\n<td>34</td>\n<td>10.39.101.141</td>\n<td>8.8.8.8</td>\n<td>UDP</td>\n<td>36904 → 33438 Len&#x3D;24</td>\n</tr>\n<tr>\n<td>35</td>\n<td>61.51.101.101</td>\n<td>10.39.101.141</td>\n<td>ICMP</td>\n<td>Time-to-live exceeded (Time to live exceeded in transit)</td>\n</tr>\n<tr>\n<td>36</td>\n<td>10.39.101.141</td>\n<td>198.108.0.18</td>\n<td>TCP</td>\n<td>51705 → 43 [PSH, ACK] Seq&#x3D;62 Ack&#x3D;648 Win&#x3D;131072 Len&#x3D;21 TSval&#x3D;2785251389  TSecr&#x3D;3642356666 [TCP segment of a reassembled PDU]</td>\n</tr>\n<tr>\n<td>37</td>\n<td>198.108.0.18</td>\n<td>10.39.101.141</td>\n<td>TCP</td>\n<td>43 → 51705 [PSH, ACK] Seq&#x3D;648 Ack&#x3D;83 Win&#x3D;29184 Len&#x3D;639 TSval&#x3D;3642358087  TSecr&#x3D;2785251389 [TCP segment of a reassembled PDU]</td>\n</tr>\n<tr>\n<td>38</td>\n<td>10.39.101.141</td>\n<td>198.108.0.18</td>\n<td>TCP</td>\n<td>51705 → 43 [ACK] Seq&#x3D;83 Ack&#x3D;1287 Win&#x3D;130432 Len&#x3D;0 TSval&#x3D;2785251697  TSecr&#x3D;3642358087</td>\n</tr>\n<tr>\n<td>39</td>\n<td>10.39.101.141</td>\n<td>10.39.101.1</td>\n<td>DNS</td>\n<td>Standard query 0x521b PTR 1.32.129.222.in-addr.arpa</td>\n</tr>\n<tr>\n<td>40</td>\n<td>10.39.101.1</td>\n<td>10.39.101.141</td>\n<td>DNS</td>\n<td>Standard query response 0x521b No such name PTR 1.32.129.222.in-addr.arpa</td>\n</tr>\n<tr>\n<td>41</td>\n<td>fe80::1c7a:24fd:c837:3017</td>\n<td>fe80::1</td>\n<td>DNS</td>\n<td>Standard query 0x5931 PTR 101.101.51.61.in-addr.arpa</td>\n</tr>\n<tr>\n<td>42</td>\n<td>fe80::1</td>\n<td>fe80::1c7a:24fd:c837:3017</td>\n<td>DNS</td>\n<td>Standard query response 0x5931 No such name PTR  101.101.51.61.in-addr.arpa</td>\n</tr>\n<tr>\n<td>43</td>\n<td>10.39.101.141</td>\n<td>8.8.8.8</td>\n<td>UDP</td>\n<td>36904 → 33439 Len&#x3D;24</td>\n</tr>\n<tr>\n<td>44</td>\n<td>219.232.11.29</td>\n<td>10.39.101.141</td>\n<td>ICMP</td>\n<td>Time-to-live exceeded (Time to live exceeded in transit)</td>\n</tr>\n<tr>\n<td>45</td>\n<td>10.39.101.141</td>\n<td>198.108.0.18</td>\n<td>TCP</td>\n<td>51705 → 43 [PSH, ACK] Seq&#x3D;83 Ack&#x3D;1287 Win&#x3D;131072 Len&#x3D;21 TSval&#x3D;2785252732  TSecr&#x3D;3642358087 [TCP segment of a reassembled PDU]</td>\n</tr>\n<tr>\n<td>46</td>\n<td>198.108.0.18</td>\n<td>10.39.101.141</td>\n<td>TCP</td>\n<td>43 → 51705 [PSH, ACK] Seq&#x3D;1287 Ack&#x3D;104 Win&#x3D;29184 Len&#x3D;418 TSval&#x3D;3642359437  TSecr&#x3D;2785252732 [TCP segment of a reassembled PDU]</td>\n</tr>\n<tr>\n<td>47</td>\n<td>10.39.101.141</td>\n<td>198.108.0.18</td>\n<td>TCP</td>\n<td>51705 → 43 [ACK] Seq&#x3D;104 Ack&#x3D;1705 Win&#x3D;130624 Len&#x3D;0 TSval&#x3D;2785253042  TSecr&#x3D;3642359437</td>\n</tr>\n<tr>\n<td>48</td>\n<td>fe80::1c7a:24fd:c837:3017</td>\n<td>fe80::1</td>\n<td>DNS</td>\n<td>Standard query 0x7d09 PTR 29.11.232.219.in-addr.arpa</td>\n</tr>\n<tr>\n<td>49</td>\n<td>fe80::1</td>\n<td>fe80::1c7a:24fd:c837:3017</td>\n<td>DNS</td>\n<td>Standard query response 0x7d09 No such name PTR  29.11.232.219.in-addr.arpa</td>\n</tr>\n<tr>\n<td>50</td>\n<td>10.39.101.141</td>\n<td>8.8.8.8</td>\n<td>UDP</td>\n<td>36904 → 33440 Len&#x3D;24</td>\n</tr>\n<tr>\n<td>51</td>\n<td>202.96.12.13</td>\n<td>10.39.101.141</td>\n<td>ICMP</td>\n<td>Time-to-live exceeded (Time to live exceeded in transit)</td>\n</tr>\n<tr>\n<td>52</td>\n<td>10.39.101.141</td>\n<td>198.108.0.18</td>\n<td>TCP</td>\n<td>51705 → 43 [PSH, ACK] Seq&#x3D;104 Ack&#x3D;1705 Win&#x3D;131072 Len&#x3D;20 TSval&#x3D;2785254068  TSecr&#x3D;3642359437 [TCP segment of a reassembled PDU]</td>\n</tr>\n<tr>\n<td>53</td>\n<td>10.39.101.141</td>\n<td>10.39.101.1</td>\n<td>DNS</td>\n<td>Standard query 0x961b PTR 101.101.51.61.in-addr.arpa</td>\n</tr>\n<tr>\n<td>54</td>\n<td>10.39.101.1</td>\n<td>10.39.101.141</td>\n<td>DNS</td>\n<td>Standard query response 0x961b No such name PTR  101.101.51.61.in-addr.arpa</td>\n</tr>\n<tr>\n<td>55</td>\n<td>198.108.0.18</td>\n<td>10.39.101.141</td>\n<td>TCP</td>\n<td>43 → 51705 [PSH, ACK] Seq&#x3D;1705 Ack&#x3D;124 Win&#x3D;29184 Len&#x3D;642 TSval&#x3D;3642360779  TSecr&#x3D;2785254068 [TCP segment of a reassembled PDU]</td>\n</tr>\n<tr>\n<td>56</td>\n<td>10.39.101.141</td>\n<td>198.108.0.18</td>\n<td>TCP</td>\n<td>51705 → 43 [ACK] Seq&#x3D;124 Ack&#x3D;2347 Win&#x3D;130368 Len&#x3D;0 TSval&#x3D;2785254400  TSecr&#x3D;3642360779</td>\n</tr>\n<tr>\n<td>57</td>\n<td>fe80::1c7a:24fd:c837:3017</td>\n<td>fe80::1</td>\n<td>DNS</td>\n<td>Standard query 0xb016 PTR 13.12.96.202.in-addr.arpa</td>\n</tr>\n<tr>\n<td>58</td>\n<td>fe80::1</td>\n<td>fe80::1c7a:24fd:c837:3017</td>\n<td>DNS</td>\n<td>Standard query response 0xb016 No such name PTR 13.12.96.202.in-addr.arpa  SOA beijing.cn.net</td>\n</tr>\n<tr>\n<td>59</td>\n<td>10.39.101.141</td>\n<td>8.8.8.8</td>\n<td>UDP</td>\n<td>36904 → 33441 Len&#x3D;24</td>\n</tr>\n<tr>\n<td>60</td>\n<td>219.158.112.46</td>\n<td>10.39.101.141</td>\n<td>ICMP</td>\n<td>Time-to-live exceeded (Time to live exceeded in transit)</td>\n</tr>\n</tbody></table>\n<p><a href=\"get-known-traceroute-by-wireshark/traceroute-google-dns.pcapng\">抓包文件下载</a></p>\n","length":3980,"excerpt":"","more":"<h1 id=\"初识Traceroute\"><a href=\"#初识Traceroute\" class=\"headerlink\" title=\"初识Traceroute\"></a>初识Traceroute</h1><p>Traceroute是一种常见的网络分析工具，用于探测数据包从源地址到目的地址经过的路由器的IP地址。</p>\n<p>以下的示例显示从一个MAC电脑到8.8.8.8的路径探测结果：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  ~ traceroute 8.8.8.8</span><br><span class=\"line\">traceroute to 8.8.8.8 (8.8.8.8), 64 hops max, 52 byte packets</span><br><span class=\"line\"> 1  localhost (10.39.101.1)  8.662 ms  1.307 ms  1.155 ms</span><br><span class=\"line\"> 2  localhost (192.168.1.1)  2.287 ms  2.157 ms  1.897 ms</span><br><span class=\"line\"> 3  222.129.32.1 (222.129.32.1)  5.844 ms  13.092 ms  10.332 ms</span><br><span class=\"line\"> 4  114.244.95.105 (114.244.95.105)  7.541 ms</span><br><span class=\"line\">    61.51.101.101 (61.51.101.101)  7.420 ms</span><br><span class=\"line\">    61.148.163.81 (61.148.163.81)  7.075 ms</span><br><span class=\"line\"> 5  61.148.4.213 (61.148.4.213)  7.759 ms</span><br><span class=\"line\">    219.232.11.65 (219.232.11.65)  5.976 ms</span><br><span class=\"line\">    bt-230-081.bta.net.cn (202.106.230.81)  6.021 ms</span><br><span class=\"line\"> 6  202.96.12.13 (202.96.12.13)  7.828 ms * *</span><br><span class=\"line\"> 7  219.158.112.26 (219.158.112.26)  39.486 ms *</span><br><span class=\"line\">    219.158.7.22 (219.158.7.22)  45.959 ms</span><br><span class=\"line\"> 8  219.158.103.218 (219.158.103.218)  48.469 ms</span><br><span class=\"line\">    219.158.97.2 (219.158.97.2)  47.146 ms</span><br><span class=\"line\">    219.158.103.218 (219.158.103.218)  50.320 ms</span><br><span class=\"line\"> 9  219.158.103.30 (219.158.103.30)  50.739 ms  50.382 ms  48.348 ms</span><br><span class=\"line\">10  219.158.10.30 (219.158.10.30)  49.927 ms  44.264 ms  56.353 ms</span><br><span class=\"line\">11  219.158.33.174 (219.158.33.174)  54.123 ms  61.131 ms  47.302 ms</span><br><span class=\"line\">12  108.170.241.97 (108.170.241.97)  56.082 ms</span><br><span class=\"line\">    108.170.241.33 (108.170.241.33)  52.942 ms  54.393 ms</span><br><span class=\"line\">13  142.250.58.189 (142.250.58.189)  48.958 ms</span><br><span class=\"line\">    209.85.143.37 (209.85.143.37)  51.217 ms</span><br><span class=\"line\">    108.170.226.115 (108.170.226.115)  141.544 ms</span><br><span class=\"line\">14  dns.google (8.8.8.8)  48.935 ms  46.364 ms  51.043 ms</span><br><span class=\"line\"></span><br><span class=\"line\">➜  ~ ping 8.8.8.8</span><br><span class=\"line\">PING 8.8.8.8 (8.8.8.8): 56 data bytes</span><br><span class=\"line\">64 bytes from 8.8.8.8: icmp_seq=0 ttl=113 time=52.060 ms</span><br><span class=\"line\">64 bytes from 8.8.8.8: icmp_seq=1 ttl=113 time=44.845 ms</span><br><span class=\"line\">64 bytes from 8.8.8.8: icmp_seq=2 ttl=113 time=52.393 ms</span><br><span class=\"line\">64 bytes from 8.8.8.8: icmp_seq=3 ttl=113 time=51.059 ms</span><br><span class=\"line\">64 bytes from 8.8.8.8: icmp_seq=4 ttl=113 time=44.437 ms</span><br><span class=\"line\">64 bytes from 8.8.8.8: icmp_seq=5 ttl=113 time=44.534 ms</span><br><span class=\"line\">^C</span><br><span class=\"line\">--- 8.8.8.8 ping statistics ---</span><br><span class=\"line\">6 packets transmitted, 6 packets received, 0.0% packet loss</span><br><span class=\"line\">round-trip min/avg/max/stddev = 44.437/48.221/52.393/3.640 ms</span><br></pre></td></tr></table></figure>\n\n<p>输出结果表明：</p>\n<ol>\n<li>从MAC电脑到8.8.8.8的路径包含14个网络节点。</li>\n<li>每个节点后面都显示时延信息，表明从MAC电脑到该节点的往返时延。您可能会发现，中间的某些节点往返时延可能要高于更远的节点的往返时延。这是由于该时延包含了路由器将TTL&#x3D;0的报文交给控制面处理的时延，因而往往比路径上的传播时延要高，尤其是当控制面CPU繁忙时。Traceroute对每一个节点发出3个探测报文，每个报文的路径不尽相同，例如在第4、5、7、8、12、13跳经过不同的路由器转发。</li>\n<li>有的探测没有得到回应，因此在有的节点本应显示时延信息的，显示了*。这并不能断定中间的网络不可达，很可能的原因是该节点的路由器在接口上配置了 <em><strong>no ip unreachable</strong></em> 命令，该接口不回应ICMP Unreachable消息，而该消息正是Traceroute探测路径所依赖的信息来源。</li>\n</ol>\n<p>接下来，我们简要描述一下，在MAC电脑下，Traceroute的工作原理，并使用Wireshark进一步的探究Traceroute的工作过程。</p>\n<h1 id=\"Traceroute的工作原理\"><a href=\"#Traceroute的工作原理\" class=\"headerlink\" title=\"Traceroute的工作原理\"></a>Traceroute的工作原理</h1><p>每当IP数据包经过一个路由器，其存活时间TTL就会减1。当其存活时间是0时，主机便取消数据包，并发送一个ICMP TTL超时数据包给原数据包的发出者。Traceroute程序通过向目的地址发送一系列的探测包，设置探测包的TTL初始值分别为1,2,3…，根据返回的超时通知（ICMP Time Exceeded Message）得到源地址与目的地址之间的每一跳路由信息。</p>\n<p><img src=\"/get-known-traceroute-by-wireshark/Traceroute-work.png\" alt=\"Traceroute 的工作原理\"></p>\n<ol>\n<li><p>从源地址发出一个UDP探测包到目的地址，并将TTL设置为1；</p>\n</li>\n<li><p>到达路由器时，将TTL减1；</p>\n</li>\n<li><p>当TTL变为0时，包被丢弃，路由器向源地址发回一个ICMP超时通知（ICMP Time Exceeded Message），内含发送IP包的源地址，IP包的所有内容及路由器的IP地址；</p>\n</li>\n<li><p>当源地址收到该ICMP包时，显示这一跳路由信息；</p>\n</li>\n<li><p>重复1～5，并每次设置TTL加1；</p>\n</li>\n<li><p>直至目标地址收到探测数据包，并返回端口不可达通知（ICMP Port Unreachable）；</p>\n</li>\n<li><p>当源地址收到ICMP Port Unreachable包时停止traceroute。</p>\n</li>\n</ol>\n<p>以上内容引自<a href=\"https://blog.csdn.net/shb_derek1/article/details/100097050\">Traceroute&#x2F;tracert原理和实践</a></p>\n<h1 id=\"通过Wireshark探究Traceroute\"><a href=\"#通过Wireshark探究Traceroute\" class=\"headerlink\" title=\"通过Wireshark探究Traceroute\"></a>通过Wireshark探究Traceroute</h1><h2 id=\"在Traceroute输出结果中显示AS号\"><a href=\"#在Traceroute输出结果中显示AS号\" class=\"headerlink\" title=\"在Traceroute输出结果中显示AS号\"></a>在Traceroute输出结果中显示AS号</h2><p>在Mac电脑的Traceroute命令中，通过’-a’的参数可以开启路径中遇到的IP地址所在的BGP AS号，以便于获知路径中每一跳所归属的运营商，通过’-q 1’可将缺省发送3个探测报文改为发送1个探测报文，输出示例如下：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  ~ traceroute -aq 1 8.8.8.8</span><br><span class=\"line\">traceroute to 8.8.8.8 (8.8.8.8), 64 hops max, 52 byte packets</span><br><span class=\"line\"> 1  [AS0] bogon (10.39.101.1)  2.424 ms</span><br><span class=\"line\"> 2  [AS0] localhost (192.168.1.1)  3.031 ms</span><br><span class=\"line\"> 3  [AS4808] 222.129.32.1 (222.129.32.1)  6.496 ms</span><br><span class=\"line\"> 4  [AS4808] 61.51.101.101 (61.51.101.101)  8.114 ms</span><br><span class=\"line\"> 5  [AS17431] 219.232.11.29 (219.232.11.29)  5.865 ms</span><br><span class=\"line\"> 6  [AS4808] 202.96.12.13 (202.96.12.13)  6.558 ms</span><br><span class=\"line\"> 7  [AS4837] 219.158.112.46 (219.158.112.46)  44.826 ms</span><br><span class=\"line\"> 8  [AS4837] 219.158.103.218 (219.158.103.218)  52.181 ms</span><br><span class=\"line\"> 9  [AS4837] 219.158.103.30 (219.158.103.30)  47.851 ms</span><br><span class=\"line\">10  [AS4837] 219.158.10.30 (219.158.10.30)  56.963 ms</span><br><span class=\"line\">11  [AS4837] 219.158.33.174 (219.158.33.174)  46.523 ms</span><br><span class=\"line\">12  [AS15169] 108.170.241.1 (108.170.241.1)  48.503 ms</span><br><span class=\"line\">13  [AS15169] 172.253.64.111 (172.253.64.111)  142.926 ms</span><br><span class=\"line\">14  [AS15169] dns.google (8.8.8.8)  52.208 ms</span><br></pre></td></tr></table></figure>\n<p>上述的AS编号信息是如何获得的？下面我们通过Wireshark抓取报文进行分析。</p>\n<h2 id=\"上述Traceroute的收发包过程简述\"><a href=\"#上述Traceroute的收发包过程简述\" class=\"headerlink\" title=\"上述Traceroute的收发包过程简述\"></a>上述Traceroute的收发包过程简述</h2><p>开启Wireshark，并迅速执行<strong>traceroute -aq 1 8.8.8.8</strong>，Traceroute完整输出后，停止Wireshark的报文抓取。<br>针对抓取的报文进行过滤，在过滤框中输入 <strong>udp or icmp or ip.addr &#x3D;&#x3D; 198.108.0.18</strong><br>经过Wireshark的报文分析，以下为Traceroute的简要的收发包过程：</p>\n<ol>\n<li>发起DNS查询，查询<strong>whois.radb.net</strong>域名，得到应答为198.108.0.18—-上述过滤器中IP地址来源于此。</li>\n<li>发起TCP连接请求，与198.108.0.18建立TCP连接。</li>\n<li>向8.8.8.8发起UDP报文，目的端口为33435，TTL设置为1</li>\n<li>收到路由器的ICMP TTL超时消息，获取路由器对应的IP地址</li>\n<li>向<strong>whois.radb.net</strong>发起查询，询问路由器IP地址对应的AS号，并得到回应，如果是私有地址，其AS号为0。</li>\n<li>尝试向DNS服务器查询路由器IP地址的反向域名解析，如果得到域名，就将其显示在Traceroute的输出结果中。</li>\n<li>重复上述第3~6步，每次将TTL加1，直至目标地址接收到探测报文，并返回ICMP Port Unreachable消息。</li>\n</ol>\n<h2 id=\"Wireshark抓包详细分析\"><a href=\"#Wireshark抓包详细分析\" class=\"headerlink\" title=\"Wireshark抓包详细分析\"></a>Wireshark抓包详细分析</h2><p>下图为Wireshark抓取的报文的前36个：<img src=\"/get-known-traceroute-by-wireshark/packet1-36.png\" alt=\"packet1-36\"></p>\n<ol>\n<li><p>第1和第2个报文为DNS查询，查询whois.radb.net的地址为198.108.0.18。</p>\n</li>\n<li><p>第3~5的报文为TCP三次握手，并成功建立TCP 连接10.39.101.141:51705&lt;—&gt;198.108.0.18:43，TCP 43端口通常是whois server的端口。</p>\n</li>\n<li><p>第6个报文由10.39.101.141发向198.108.0.18，并将PSH置位，请求接收端一收到就进行向上交付，以缩短Traceroute的等待时间。</p>\n</li>\n<li><p>第7个报文发出第一个UDP的探测报文，目标端口号为33435，TTL&#x3D;1，具体如下：</p>\n<p><img src=\"/get-known-traceroute-by-wireshark/UDP-Probe-1.png\" alt=\"UDP-Probe-1\"></p>\n</li>\n<li><p>第8个报文为网关回复的ICMP Time-to-live exceeded (Time to live exceeded in transit)报文，Traceroute从IP报文中的源地址获取路由器的IP地址10.39.101.1。该报文包含原始的UDP报文信息，具体如下：</p>\n<p><img src=\"/get-known-traceroute-by-wireshark/ICMP-Reply-1.png\" alt=\"ICMP-Reply-1\"></p>\n</li>\n<li><p>第9个报文为第6个报文的TCP确认报文，第10个报文为向whois.radb.net查询网关10.39.101.1&#x2F;32所在的AS号。第11个报文为第10个报文的TCP确认，第12个报文答复查询结果，由于该地址为私有IP地址段，没有查询到结果，因此Traceroute 将AS号显示为[AS0]。以下使用第29和30报文，用于展示AS号查询的报文，如下：</p>\n</li>\n</ol>\n<p>  <img src=\"/get-known-traceroute-by-wireshark/AS-query-1.png\" alt=\"AS-query-1\"></p>\n<p>  <img src=\"/get-known-traceroute-by-wireshark/AS-reply-1.png\" alt=\"AS-reply-1\"></p>\n<p>  查询结果的文本内容如下：</p>\n  <figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">route:      222.129.0.0/18</span><br><span class=\"line\">descr:      CMI  (Customer Route)</span><br><span class=\"line\">origin:     AS4808</span><br><span class=\"line\">mnt-by:     MAINT-AS58453</span><br><span class=\"line\">changed:    qas_support@cmi.chinamobile.com 20160525</span><br><span class=\"line\">source:     RADB</span><br><span class=\"line\"></span><br><span class=\"line\">route:          222.128.0.0/14</span><br><span class=\"line\">descr:          China Unicom Beijing Province Network</span><br><span class=\"line\">country:        CN</span><br><span class=\"line\">origin:         AS4808</span><br><span class=\"line\">mnt-by:         MAINT-CNCGROUP-RR</span><br><span class=\"line\">changed:        abuse@cnc-noc.net 20160516</span><br><span class=\"line\">source:         APNIC</span><br><span class=\"line\"></span><br><span class=\"line\">route:      222.129.0.0/18</span><br><span class=\"line\">descr:      CMI IP Transit</span><br><span class=\"line\">origin:     AS4808</span><br><span class=\"line\">admin-c:    MAINT-CMI-INT-HK</span><br><span class=\"line\">tech-c:     MAINT-CMI-INT-HK</span><br><span class=\"line\">mnt-by:     MAINT-CMI-INT-HK</span><br><span class=\"line\">changed:    qas_support@cmi.chinamobile.com 20160525</span><br><span class=\"line\">source:     NTTCOM</span><br></pre></td></tr></table></figure>\n<ol start=\"7\">\n<li><p>第14~17报文是DNS解析报文，分别对主机名WERAO-M-40KA进行域名解析，以及对网关IP 10.39.101.1进行反向域名解析，由于是私有主机名和私有地址，自然公网DNS是解析不出来。以下将针对8.8.8.8进行反向域名解析为dns.google的截图作为示例：</p>\n<p><img src=\"/get-known-traceroute-by-wireshark/dns-query-1.png\" alt=\"dns-query-1\"></p>\n</li>\n<li><p>报文18~26重复报文7~17的过程，其中报文18的TTL为2，如下：</p>\n<p><img src=\"/get-known-traceroute-by-wireshark/UDP-Probe-2.png\" alt=\"UDP-Probe-2\"></p>\n<p>过程持续至8.8.8.8返回Code: 3 (Port unreachable)的消息，并对8.8.8.8进行反向域名解析。</p>\n<p><img src=\"/get-known-traceroute-by-wireshark/ICMP-last-reply.png\" alt=\"ICMP-last-reply\"></p>\n</li>\n</ol>\n<p>以上详细的分析了<strong>traceroute -aq 1 8.8.8.8</strong>的报文收发过程。</p>\n<h2 id=\"后记\"><a href=\"#后记\" class=\"headerlink\" title=\"后记\"></a>后记</h2><p>在上述的Traceroute完成输出后，Wireshark成功的将Whois的交互报文进行重新组装，并完成内容的解析。</p>\n<p>在Wireshark分析完第133个报文后，Wireshark成功的组装出whois的查询报文，如下：</p>\n<p><img src=\"/get-known-traceroute-by-wireshark/whois-query.png\" alt=\"whois-query\"></p>\n<p>在Wireshark分析完第135个报文后，Wireshark成功的组装出Whois的应答报文，如下：</p>\n<p><img src=\"/get-known-traceroute-by-wireshark/whois-answer.png\" alt=\"whois-answer\"></p>\n<p>在Terminal执行whois 8.8.8.8&#x2F;32，并进行报文抓取，解析出Whois的报文应答如下：</p>\n<p><img src=\"/get-known-traceroute-by-wireshark/whois-answer-2.png\" alt=\"whois-answer-2\"></p>\n<p>该报文也是Wireshark 拼装了多个TCP Segment，#101、#103、#104、#106、#109后解析出来的。对比该解析结果和上文中，Traceroute过程中的查询结果，可以发现，报文结构是一致的，都被Wireshark解析成Whois的报文。</p>\n<p>据此，我推测，MAC电脑上的Traceroute 在增加了-a的参数后，会主动发起Whois查询，缺省的Whois服务器是whois.radb.net。</p>\n<p>此部分内容是在Traceroute收发包过程分析完成后，再后知后觉发现的，因此将此部分内容作为“后记”进行记录。</p>\n<h1 id=\"Traceroute-进阶版工具MTR\"><a href=\"#Traceroute-进阶版工具MTR\" class=\"headerlink\" title=\"Traceroute 进阶版工具MTR\"></a>Traceroute 进阶版工具MTR</h1><p>MTR （My Traceroute）工具将ping和traceroute命令的功能并入了同一个工具中，实现更强大的功能。相对于traceroute命令只会做一次链路跟踪测试，mtr命令会对链路上的相关节点做持续探测并给出相应的统计信息。</p>\n<p>如下为MTR的输出：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">➜  ~ sudo mtr -ry 4 8.8.8.8</span><br><span class=\"line\">Start: 2021-06-27T23:37:21+0800</span><br><span class=\"line\">HOST: WERAO-M-40KA                Loss%   Snt   Last   Avg  Best  Wrst StDev</span><br><span class=\"line\">  1. ???        localhost          0.0%    10    1.8   2.2   1.2  10.1   2.8</span><br><span class=\"line\">  2. ???        bogon              0.0%    10    2.2   2.3   1.9   3.3   0.5</span><br><span class=\"line\">  3. 2003-11-19 222.129.32.1       0.0%    10    6.3   9.5   5.0  29.2   7.7</span><br><span class=\"line\">  4. 2000-03-14 61.148.163.181     0.0%    10    5.3   7.4   5.3   8.7   1.2</span><br><span class=\"line\">  5. 2002-04-17 219.232.11.65     70.0%    10    5.4   6.1   5.4   6.8   0.7</span><br><span class=\"line\">  6. 2006-01-09 124.65.194.153    30.0%    10   28.9   9.6   5.7  28.9   8.5</span><br><span class=\"line\">  7. 2002-03-21 219.158.112.26    40.0%    10   38.9  44.2  38.5  63.7   9.7</span><br><span class=\"line\">  8. 2002-03-21 219.158.19.66      0.0%    10   74.4  64.1  46.4  74.4   8.8</span><br><span class=\"line\">  9. 2002-03-21 219.158.97.25      0.0%    10   90.8  90.8  82.2  96.7   4.3</span><br><span class=\"line\"> 10. 2002-03-21 219.158.20.94      0.0%    10   97.5  89.8  74.1 104.6  11.8</span><br><span class=\"line\"> 11. 2002-03-21 219.158.33.174     0.0%    10   73.0  62.1  49.7  74.0   8.5</span><br><span class=\"line\"> 12. 2012-02-07 108.170.241.65     0.0%    10   59.0  67.3  53.1  75.4   7.2</span><br><span class=\"line\"> 13. 2013-04-04 172.253.69.229    10.0%    10   62.9  68.3  54.5  76.6   6.5</span><br><span class=\"line\"> 14. 1992-12-01 dns.google         0.0%    10   71.0  65.6  56.4  71.0   5.7</span><br></pre></td></tr></table></figure>\n\n<p>MTR命令，通过-r 输出报告，-z 可输出地址所在的AS号，-y 4 可输出该地址的分配时间。</p>\n<p>输出信息解释如下：</p>\n<ul>\n<li>第一列（Host）：节点IP地址和域名。</li>\n<li>第二列（Loss%）：节点丢包率。</li>\n<li>第三列（Snt）：发送的Ping包数。默认值是10，可以通过参数“-c”指定。</li>\n<li>第四列（Last）：最近一次的探测延迟值。</li>\n<li>第五、六、七列（Avg、Best、Wrst）：分别是探测延迟的平均值、最小值和最大值。</li>\n<li>第八列（StDev）：标准偏差。越大说明相应节点越不稳定。</li>\n</ul>\n<p>上述解释引用自：<a href=\"https://help.aliyun.com/knowledge_detail/98706.html\">MTR工具使用说明与结果分析</a>，略有改动。</p>\n<h1 id=\"Q-A\"><a href=\"#Q-A\" class=\"headerlink\" title=\"Q&amp;A\"></a>Q&amp;A</h1><ol>\n<li><p>David Tian:  赞，请教下，为什么ipv4的traceroute 会触发用ipv6去查dns呢？</p>\n<p>答：好眼力，好问题~~实际上，我抓取的报文中，每次得到ICMP报文后，Traceroute也会向208.67.222.222发送DNS请求。但是报文是加密的，看不出是什么内容，不能猜测，所以我将这些不确定的报文删除了。208.67.222.222是OpenDNS的DNS服务器，这是Cisco IT设置的DNS服务器。😄</p>\n</li>\n</ol>\n<h1 id=\"附录\"><a href=\"#附录\" class=\"headerlink\" title=\"附录\"></a>附录</h1><p>以下是Wireshark抓包文件的前60个报文的概览。</p>\n<table>\n<thead>\n<tr>\n<th>No.</th>\n<th>Source</th>\n<th>Destination</th>\n<th>Protocol</th>\n<th>Info</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>1</td>\n<td>fe80::1c7a:24fd:c837:3017</td>\n<td>fe80::1</td>\n<td>DNS</td>\n<td>Standard query 0xc7d5 A whois.radb.net</td>\n</tr>\n<tr>\n<td>2</td>\n<td>fe80::1</td>\n<td>fe80::1c7a:24fd:c837:3017</td>\n<td>DNS</td>\n<td>Standard query response 0xc7d5 A whois.radb.net A 198.108.0.18</td>\n</tr>\n<tr>\n<td>3</td>\n<td>10.39.101.141</td>\n<td>198.108.0.18</td>\n<td>TCP</td>\n<td>51705 → 43 [SYN] Seq&#x3D;0 Win&#x3D;65535 Len&#x3D;0 MSS&#x3D;1460 WS&#x3D;64 TSval&#x3D;2785245374  TSecr&#x3D;0 SACK_PERM&#x3D;1</td>\n</tr>\n<tr>\n<td>4</td>\n<td>198.108.0.18</td>\n<td>10.39.101.141</td>\n<td>TCP</td>\n<td>43 → 51705 [SYN, ACK] Seq&#x3D;0 Ack&#x3D;1 Win&#x3D;28960 Len&#x3D;0 MSS&#x3D;1412  TSval&#x3D;3642352050 TSecr&#x3D;2785245374 WS&#x3D;256</td>\n</tr>\n<tr>\n<td>5</td>\n<td>10.39.101.141</td>\n<td>198.108.0.18</td>\n<td>TCP</td>\n<td>51705 → 43 [ACK] Seq&#x3D;1 Ack&#x3D;1 Win&#x3D;131584 Len&#x3D;0 TSval&#x3D;2785245692  TSecr&#x3D;3642352050</td>\n</tr>\n<tr>\n<td>6</td>\n<td>10.39.101.141</td>\n<td>198.108.0.18</td>\n<td>TCP</td>\n<td>51705 → 43 [PSH, ACK] Seq&#x3D;1 Ack&#x3D;1 Win&#x3D;131584 Len&#x3D;3 TSval&#x3D;2785245692  TSecr&#x3D;3642352050 [TCP segment of a reassembled PDU]</td>\n</tr>\n<tr>\n<td>7</td>\n<td>10.39.101.141</td>\n<td>8.8.8.8</td>\n<td>UDP</td>\n<td>36904 → 33435 Len&#x3D;24</td>\n</tr>\n<tr>\n<td>8</td>\n<td>10.39.101.1</td>\n<td>10.39.101.141</td>\n<td>ICMP</td>\n<td>Time-to-live exceeded (Time to live exceeded in transit)</td>\n</tr>\n<tr>\n<td>9</td>\n<td>198.108.0.18</td>\n<td>10.39.101.141</td>\n<td>TCP</td>\n<td>43 → 51705 [ACK] Seq&#x3D;1 Ack&#x3D;4 Win&#x3D;29184 Len&#x3D;0 TSval&#x3D;3642352370  TSecr&#x3D;2785245692</td>\n</tr>\n<tr>\n<td>10</td>\n<td>10.39.101.141</td>\n<td>198.108.0.18</td>\n<td>TCP</td>\n<td>51705 → 43 [PSH, ACK] Seq&#x3D;4 Ack&#x3D;1 Win&#x3D;131584 Len&#x3D;19 TSval&#x3D;2785246039  TSecr&#x3D;3642352370 [TCP segment of a reassembled PDU]</td>\n</tr>\n<tr>\n<td>11</td>\n<td>198.108.0.18</td>\n<td>10.39.101.141</td>\n<td>TCP</td>\n<td>43 → 51705 [ACK] Seq&#x3D;1 Ack&#x3D;23 Win&#x3D;29184 Len&#x3D;0 TSval&#x3D;3642352717  TSecr&#x3D;2785246039</td>\n</tr>\n<tr>\n<td>12</td>\n<td>198.108.0.18</td>\n<td>10.39.101.141</td>\n<td>TCP</td>\n<td>43 → 51705 [PSH, ACK] Seq&#x3D;1 Ack&#x3D;23 Win&#x3D;29184 Len&#x3D;2 TSval&#x3D;3642352717  TSecr&#x3D;2785246039 [TCP segment of a reassembled PDU]</td>\n</tr>\n<tr>\n<td>13</td>\n<td>10.39.101.141</td>\n<td>198.108.0.18</td>\n<td>TCP</td>\n<td>51705 → 43 [ACK] Seq&#x3D;23 Ack&#x3D;3 Win&#x3D;131584 Len&#x3D;0 TSval&#x3D;2785246448  TSecr&#x3D;3642352717</td>\n</tr>\n<tr>\n<td>14</td>\n<td>fe80::1c7a:24fd:c837:3017</td>\n<td>fe80::1</td>\n<td>DNS</td>\n<td>Standard query 0x93fc A WERAO-M-40KA</td>\n</tr>\n<tr>\n<td>15</td>\n<td>fe80::1</td>\n<td>fe80::1c7a:24fd:c837:3017</td>\n<td>DNS</td>\n<td>Standard query response 0x93fc No such name A WERAO-M-40KA</td>\n</tr>\n<tr>\n<td>16</td>\n<td>fe80::1c7a:24fd:c837:3017</td>\n<td>fe80::1</td>\n<td>DNS</td>\n<td>Standard query 0xbcf9 PTR 1.101.39.10.in-addr.arpa</td>\n</tr>\n<tr>\n<td>17</td>\n<td>fe80::1</td>\n<td>fe80::1c7a:24fd:c837:3017</td>\n<td>DNS</td>\n<td>Standard query response 0xbcf9 PTR 1.101.39.10.in-addr.arpa PTR bogon</td>\n</tr>\n<tr>\n<td>18</td>\n<td>10.39.101.141</td>\n<td>8.8.8.8</td>\n<td>UDP</td>\n<td>36904 → 33436 Len&#x3D;24</td>\n</tr>\n<tr>\n<td>19</td>\n<td>192.168.1.1</td>\n<td>10.39.101.141</td>\n<td>ICMP</td>\n<td>Time-to-live exceeded (Time to live exceeded in transit)</td>\n</tr>\n<tr>\n<td>20</td>\n<td>10.39.101.141</td>\n<td>198.108.0.18</td>\n<td>TCP</td>\n<td>51705 → 43 [PSH, ACK] Seq&#x3D;23 Ack&#x3D;3 Win&#x3D;131584 Len&#x3D;19 TSval&#x3D;2785248590  TSecr&#x3D;3642352717 [TCP segment of a reassembled PDU]</td>\n</tr>\n<tr>\n<td>21</td>\n<td>10.39.101.141</td>\n<td>10.39.101.1</td>\n<td>DNS</td>\n<td>Standard query 0xc81a A WERAO-M-40KA</td>\n</tr>\n<tr>\n<td>22</td>\n<td>10.39.101.1</td>\n<td>10.39.101.141</td>\n<td>DNS</td>\n<td>Standard query response 0xc81a A WERAO-M-40KA A 10.39.101.141</td>\n</tr>\n<tr>\n<td>23</td>\n<td>198.108.0.18</td>\n<td>10.39.101.141</td>\n<td>TCP</td>\n<td>43 → 51705 [PSH, ACK] Seq&#x3D;3 Ack&#x3D;42 Win&#x3D;29184 Len&#x3D;2 TSval&#x3D;3642355278  TSecr&#x3D;2785248590 [TCP segment of a reassembled PDU]</td>\n</tr>\n<tr>\n<td>24</td>\n<td>10.39.101.141</td>\n<td>198.108.0.18</td>\n<td>TCP</td>\n<td>51705 → 43 [ACK] Seq&#x3D;42 Ack&#x3D;5 Win&#x3D;131584 Len&#x3D;0 TSval&#x3D;2785248902  TSecr&#x3D;3642355278</td>\n</tr>\n<tr>\n<td>25</td>\n<td>fe80::1c7a:24fd:c837:3017</td>\n<td>fe80::1</td>\n<td>DNS</td>\n<td>Standard query 0x7504 PTR 1.1.168.192.in-addr.arpa</td>\n</tr>\n<tr>\n<td>26</td>\n<td>fe80::1</td>\n<td>fe80::1c7a:24fd:c837:3017</td>\n<td>DNS</td>\n<td>Standard query response 0x7504 PTR 1.1.168.192.in-addr.arpa PTR localhost</td>\n</tr>\n<tr>\n<td>27</td>\n<td>10.39.101.141</td>\n<td>8.8.8.8</td>\n<td>UDP</td>\n<td>36904 → 33437 Len&#x3D;24</td>\n</tr>\n<tr>\n<td>28</td>\n<td>222.129.32.1</td>\n<td>10.39.101.141</td>\n<td>ICMP</td>\n<td>Time-to-live exceeded (Time to live exceeded in transit)</td>\n</tr>\n<tr>\n<td>29</td>\n<td>10.39.101.141</td>\n<td>198.108.0.18</td>\n<td>TCP</td>\n<td>51705 → 43 [PSH, ACK] Seq&#x3D;42 Ack&#x3D;5 Win&#x3D;131584 Len&#x3D;20 TSval&#x3D;2785249974  TSecr&#x3D;3642355278 [TCP segment of a reassembled PDU]</td>\n</tr>\n<tr>\n<td>30</td>\n<td>198.108.0.18</td>\n<td>10.39.101.141</td>\n<td>TCP</td>\n<td>43 → 51705 [PSH, ACK] Seq&#x3D;5 Ack&#x3D;62 Win&#x3D;29184 Len&#x3D;643 TSval&#x3D;3642356666  TSecr&#x3D;2785249974 [TCP segment of a reassembled PDU]</td>\n</tr>\n<tr>\n<td>31</td>\n<td>10.39.101.141</td>\n<td>198.108.0.18</td>\n<td>TCP</td>\n<td>51705 → 43 [ACK] Seq&#x3D;62 Ack&#x3D;648 Win&#x3D;130944 Len&#x3D;0 TSval&#x3D;2785250324  TSecr&#x3D;3642356666</td>\n</tr>\n<tr>\n<td>32</td>\n<td>fe80::1c7a:24fd:c837:3017</td>\n<td>fe80::1</td>\n<td>DNS</td>\n<td>Standard query 0x4f56 PTR 1.32.129.222.in-addr.arpa</td>\n</tr>\n<tr>\n<td>33</td>\n<td>fe80::1</td>\n<td>fe80::1c7a:24fd:c837:3017</td>\n<td>DNS</td>\n<td>Standard query response 0x4f56 No such name PTR 1.32.129.222.in-addr.arpa</td>\n</tr>\n<tr>\n<td>34</td>\n<td>10.39.101.141</td>\n<td>8.8.8.8</td>\n<td>UDP</td>\n<td>36904 → 33438 Len&#x3D;24</td>\n</tr>\n<tr>\n<td>35</td>\n<td>61.51.101.101</td>\n<td>10.39.101.141</td>\n<td>ICMP</td>\n<td>Time-to-live exceeded (Time to live exceeded in transit)</td>\n</tr>\n<tr>\n<td>36</td>\n<td>10.39.101.141</td>\n<td>198.108.0.18</td>\n<td>TCP</td>\n<td>51705 → 43 [PSH, ACK] Seq&#x3D;62 Ack&#x3D;648 Win&#x3D;131072 Len&#x3D;21 TSval&#x3D;2785251389  TSecr&#x3D;3642356666 [TCP segment of a reassembled PDU]</td>\n</tr>\n<tr>\n<td>37</td>\n<td>198.108.0.18</td>\n<td>10.39.101.141</td>\n<td>TCP</td>\n<td>43 → 51705 [PSH, ACK] Seq&#x3D;648 Ack&#x3D;83 Win&#x3D;29184 Len&#x3D;639 TSval&#x3D;3642358087  TSecr&#x3D;2785251389 [TCP segment of a reassembled PDU]</td>\n</tr>\n<tr>\n<td>38</td>\n<td>10.39.101.141</td>\n<td>198.108.0.18</td>\n<td>TCP</td>\n<td>51705 → 43 [ACK] Seq&#x3D;83 Ack&#x3D;1287 Win&#x3D;130432 Len&#x3D;0 TSval&#x3D;2785251697  TSecr&#x3D;3642358087</td>\n</tr>\n<tr>\n<td>39</td>\n<td>10.39.101.141</td>\n<td>10.39.101.1</td>\n<td>DNS</td>\n<td>Standard query 0x521b PTR 1.32.129.222.in-addr.arpa</td>\n</tr>\n<tr>\n<td>40</td>\n<td>10.39.101.1</td>\n<td>10.39.101.141</td>\n<td>DNS</td>\n<td>Standard query response 0x521b No such name PTR 1.32.129.222.in-addr.arpa</td>\n</tr>\n<tr>\n<td>41</td>\n<td>fe80::1c7a:24fd:c837:3017</td>\n<td>fe80::1</td>\n<td>DNS</td>\n<td>Standard query 0x5931 PTR 101.101.51.61.in-addr.arpa</td>\n</tr>\n<tr>\n<td>42</td>\n<td>fe80::1</td>\n<td>fe80::1c7a:24fd:c837:3017</td>\n<td>DNS</td>\n<td>Standard query response 0x5931 No such name PTR  101.101.51.61.in-addr.arpa</td>\n</tr>\n<tr>\n<td>43</td>\n<td>10.39.101.141</td>\n<td>8.8.8.8</td>\n<td>UDP</td>\n<td>36904 → 33439 Len&#x3D;24</td>\n</tr>\n<tr>\n<td>44</td>\n<td>219.232.11.29</td>\n<td>10.39.101.141</td>\n<td>ICMP</td>\n<td>Time-to-live exceeded (Time to live exceeded in transit)</td>\n</tr>\n<tr>\n<td>45</td>\n<td>10.39.101.141</td>\n<td>198.108.0.18</td>\n<td>TCP</td>\n<td>51705 → 43 [PSH, ACK] Seq&#x3D;83 Ack&#x3D;1287 Win&#x3D;131072 Len&#x3D;21 TSval&#x3D;2785252732  TSecr&#x3D;3642358087 [TCP segment of a reassembled PDU]</td>\n</tr>\n<tr>\n<td>46</td>\n<td>198.108.0.18</td>\n<td>10.39.101.141</td>\n<td>TCP</td>\n<td>43 → 51705 [PSH, ACK] Seq&#x3D;1287 Ack&#x3D;104 Win&#x3D;29184 Len&#x3D;418 TSval&#x3D;3642359437  TSecr&#x3D;2785252732 [TCP segment of a reassembled PDU]</td>\n</tr>\n<tr>\n<td>47</td>\n<td>10.39.101.141</td>\n<td>198.108.0.18</td>\n<td>TCP</td>\n<td>51705 → 43 [ACK] Seq&#x3D;104 Ack&#x3D;1705 Win&#x3D;130624 Len&#x3D;0 TSval&#x3D;2785253042  TSecr&#x3D;3642359437</td>\n</tr>\n<tr>\n<td>48</td>\n<td>fe80::1c7a:24fd:c837:3017</td>\n<td>fe80::1</td>\n<td>DNS</td>\n<td>Standard query 0x7d09 PTR 29.11.232.219.in-addr.arpa</td>\n</tr>\n<tr>\n<td>49</td>\n<td>fe80::1</td>\n<td>fe80::1c7a:24fd:c837:3017</td>\n<td>DNS</td>\n<td>Standard query response 0x7d09 No such name PTR  29.11.232.219.in-addr.arpa</td>\n</tr>\n<tr>\n<td>50</td>\n<td>10.39.101.141</td>\n<td>8.8.8.8</td>\n<td>UDP</td>\n<td>36904 → 33440 Len&#x3D;24</td>\n</tr>\n<tr>\n<td>51</td>\n<td>202.96.12.13</td>\n<td>10.39.101.141</td>\n<td>ICMP</td>\n<td>Time-to-live exceeded (Time to live exceeded in transit)</td>\n</tr>\n<tr>\n<td>52</td>\n<td>10.39.101.141</td>\n<td>198.108.0.18</td>\n<td>TCP</td>\n<td>51705 → 43 [PSH, ACK] Seq&#x3D;104 Ack&#x3D;1705 Win&#x3D;131072 Len&#x3D;20 TSval&#x3D;2785254068  TSecr&#x3D;3642359437 [TCP segment of a reassembled PDU]</td>\n</tr>\n<tr>\n<td>53</td>\n<td>10.39.101.141</td>\n<td>10.39.101.1</td>\n<td>DNS</td>\n<td>Standard query 0x961b PTR 101.101.51.61.in-addr.arpa</td>\n</tr>\n<tr>\n<td>54</td>\n<td>10.39.101.1</td>\n<td>10.39.101.141</td>\n<td>DNS</td>\n<td>Standard query response 0x961b No such name PTR  101.101.51.61.in-addr.arpa</td>\n</tr>\n<tr>\n<td>55</td>\n<td>198.108.0.18</td>\n<td>10.39.101.141</td>\n<td>TCP</td>\n<td>43 → 51705 [PSH, ACK] Seq&#x3D;1705 Ack&#x3D;124 Win&#x3D;29184 Len&#x3D;642 TSval&#x3D;3642360779  TSecr&#x3D;2785254068 [TCP segment of a reassembled PDU]</td>\n</tr>\n<tr>\n<td>56</td>\n<td>10.39.101.141</td>\n<td>198.108.0.18</td>\n<td>TCP</td>\n<td>51705 → 43 [ACK] Seq&#x3D;124 Ack&#x3D;2347 Win&#x3D;130368 Len&#x3D;0 TSval&#x3D;2785254400  TSecr&#x3D;3642360779</td>\n</tr>\n<tr>\n<td>57</td>\n<td>fe80::1c7a:24fd:c837:3017</td>\n<td>fe80::1</td>\n<td>DNS</td>\n<td>Standard query 0xb016 PTR 13.12.96.202.in-addr.arpa</td>\n</tr>\n<tr>\n<td>58</td>\n<td>fe80::1</td>\n<td>fe80::1c7a:24fd:c837:3017</td>\n<td>DNS</td>\n<td>Standard query response 0xb016 No such name PTR 13.12.96.202.in-addr.arpa  SOA beijing.cn.net</td>\n</tr>\n<tr>\n<td>59</td>\n<td>10.39.101.141</td>\n<td>8.8.8.8</td>\n<td>UDP</td>\n<td>36904 → 33441 Len&#x3D;24</td>\n</tr>\n<tr>\n<td>60</td>\n<td>219.158.112.46</td>\n<td>10.39.101.141</td>\n<td>ICMP</td>\n<td>Time-to-live exceeded (Time to live exceeded in transit)</td>\n</tr>\n</tbody></table>\n<p><a href=\"get-known-traceroute-by-wireshark/traceroute-google-dns.pcapng\">抓包文件下载</a></p>\n"},{"layout":"post","title":"ISE 故事","date":"2025-12-14T12:00:00.000Z","_content":"\n这是我通过 AI 生成的 ISE 技术解析页面。你可以在下方直接浏览，或点击链接全屏查看。\n\n<!--more-->\n\n<div style=\"position: relative; width: 100%; height: 0; padding-bottom: 75%; overflow: hidden; border: 1px solid #eee; border-radius: 8px;\">\n    <iframe src=\"/isestory.html\" style=\"position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0;\"></iframe>\n</div>\n\n<div style=\"margin-top: 20px; text-align: center;\">\n    <a href=\"/isestory.html\" target=\"_blank\" style=\"display: inline-block; padding: 10px 20px; background: #333; color: #fff; text-decoration: none; border-radius: 4px;\">🚀 全屏浏览此页面</a>\n</div>\n\n---\n","source":"_posts/ise-story-md.md","raw":"---\nlayout: post\ntitle: ISE 故事\ndate: 2025-12-14 20:00:00\ntags: [ISE, AI Works]\ncategories: 作品集\n---\n\n这是我通过 AI 生成的 ISE 技术解析页面。你可以在下方直接浏览，或点击链接全屏查看。\n\n<!--more-->\n\n<div style=\"position: relative; width: 100%; height: 0; padding-bottom: 75%; overflow: hidden; border: 1px solid #eee; border-radius: 8px;\">\n    <iframe src=\"/isestory.html\" style=\"position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0;\"></iframe>\n</div>\n\n<div style=\"margin-top: 20px; text-align: center;\">\n    <a href=\"/isestory.html\" target=\"_blank\" style=\"display: inline-block; padding: 10px 20px; background: #333; color: #fff; text-decoration: none; border-radius: 4px;\">🚀 全屏浏览此页面</a>\n</div>\n\n---\n","slug":"ise-story-md","published":1,"updated":"2025-12-14T12:06:42.696Z","comments":1,"photos":[],"_id":"cuidtg_FuUlUQQ5BRfGY8QsMI","content":"<p>这是我通过 AI 生成的 ISE 技术解析页面。你可以在下方直接浏览，或点击链接全屏查看。</p>\n<span id=\"more\"></span>\n\n<div style=\"position: relative; width: 100%; height: 0; padding-bottom: 75%; overflow: hidden; border: 1px solid #eee; border-radius: 8px;\">\n    <iframe src=\"/isestory.html\" style=\"position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0;\"></iframe>\n</div>\n\n<div style=\"margin-top: 20px; text-align: center;\">\n    <a href=\"/isestory.html\" target=\"_blank\" style=\"display: inline-block; padding: 10px 20px; background: #333; color: #fff; text-decoration: none; border-radius: 4px;\">🚀 全屏浏览此页面</a>\n</div>\n\n<hr>\n","length":113,"excerpt":"<p>这是我通过 AI 生成的 ISE 技术解析页面。你可以在下方直接浏览，或点击链接全屏查看。</p>","more":"<div style=\"position: relative; width: 100%; height: 0; padding-bottom: 75%; overflow: hidden; border: 1px solid #eee; border-radius: 8px;\">\n    <iframe src=\"/isestory.html\" style=\"position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0;\"></iframe>\n</div>\n\n<div style=\"margin-top: 20px; text-align: center;\">\n    <a href=\"/isestory.html\" target=\"_blank\" style=\"display: inline-block; padding: 10px 20px; background: #333; color: #fff; text-decoration: none; border-radius: 4px;\">🚀 全屏浏览此页面</a>\n</div>\n\n<hr>"},{"title":"CSR 1000v KVM SRIOV CentOS 7安装设置指南","date":"2021-02-03T05:58:32.000Z","description":"本文提供在 CentOS 7 版本上安装 KVM，并安装和设置 CSR 1000v/Catalyst 8000v 的指南，内容包括 SRIOV，KVM 调优以及 CSR1KV 初始化配置等内容。","_content":"\n作者：Rao Weibo\n\n版本：1.0\n\n更新日期：20210203\n\n本文提供在 CentOS 7 版本上安装 KVM，并安装和设置 CSR 1000v/Catalyst 8000v 的指南，内容包括 SRIOV，KVM 调优以及 CSR1KV 初始化配置等内容。\n\n# CentOS7 安装及设置\n\n## （1）BIOS 设置建议\n\n| Configuration                       | Recommended Setting |\n| :---------------------------------- | :------------------ |\n| Intel Hyper-Threading Technology    | Disabled            |\n| Number of Enable Cores              | ALL                 |\n| Execute Disable                     | Enabled             |\n| Intel VT                            | Enabled             |\n| Intel VT-D                          | Enabled             |\n| Intel VT-D coherency support        | Enabled             |\n| Intel VT-D ATS support              | Enabled             |\n| CPU Performance                     | High throughput     |\n| Hardware Perfetcher                 | Disabled            |\n| Adjacent Cache Line Prefetcher      | Disabled            |\n| DCU Streamer Prefetch               | Disable             |\n| Power Technology                    | Custom              |\n| Enhanced Intel Speedstep Technology | Disabled            |\n| Intel Turbo Boost Technology        | Enabled             |\n| Processor Power State C6            | Disabled            |\n| Processor Power State C1 Enhanced   | Disabled            |\n| Frequency Poor Override             | Enabled             |\n| P-State Coordination                | HW_ALL              |\n| Energy Performance                  | Performance         |\n\n以上建议来自 CSR 1000v 的安装指南。\n\n## （2）CentOS 7 的安装\n\n在安装的时候选择\n\n- Server with GUI\n- Virtualization Client\n- Virtualization Hypervisor\n- Virtualization Tools\n\n启动完毕以后关闭 selinux，重启生效。\n\n```shell\nsed -i 's/SELINUX=enforcing/SELINUX=disabled/g' /etc/selinux/config\n\ngetenforce\t\t//结果为：Enforcing（开启状态）disabled(关闭状态)\n```\n\n```shell\n# 安装完后，SSH登录可能显示中文，可修改 .bash_profile\n\nLANG=\"en_US.UTF-8\"\n\nexport LANG\n\nsource .bash_profile\n\negrep -o '(vmx|svm)' /proc/cpuinfo | sort | uniq\n\n# 注：在生产环境中，需要在服务器连接的交换机以及出口防火墙上做好安全策略。\n\nsystemctl stop firewalld\n\nsystemctl disable firewalld\n```\n\n本文档采用 NetworkManager 配置，故在此并不停用 NetworkManager。\n\n```shell\ncat /etc/sysctl.conf\n\nnet.ipv4.ip_forward = 1\n\nnet.bridge.bridge-nf-call-ip6tables = 0\n\nnet.bridge.bridge-nf-call-iptables = 0\n\nnet.bridge.bridge-nf-call-arptables = 0\n```\n\n检查 KVM 组件版本：\n\n```shell\n[root@centos7 ~]# libvirtd -V\n\nlibvirtd (libvirt) 4.5.0\n\n[root@centos7 ~]# /usr/libexec/qemu-kvm --version\n\nQEMU emulator version 1.5.3 (qemu-kvm-1.5.3-173.el7_8.3), Copyright (c) 2003-2008 Fabrice Bellard\n\n[root@centos7 ~]# virt-manager --version\n\n1.5.0\n\n[root@centos7 ~]# modinfo kvm-intel\n\nfilename:       /lib/modules/3.10.0-1127.18.2.el7.x86_64/kernel/arch/x86/kvm/kvm-intel.ko.xz\n\n[root@centos7 ~]# modinfo ixgbevf\n\nfilename:       /lib/modules/3.10.0-1127.18.2.el7.x86_64/kernel/drivers/net/ethernet/intel/ixgbevf/ixgbevf.ko.xz\n\nversion:        4.1.0-k-rh7.7\n```\n\n## （3）创建本地 Yum 源（可选）\n\n```shell\n# 1、备份本地/etc/yum.repos.d 目录下的yum源\n\ncd /etc/yum.repos.d/\n\nmkdir bak\n\nmv C* bak/\n\n# 2、上传CentOS-7-x86_64-Everything-2009.iso镜像到/opt\n\n# 3、挂载镜像\n\nmkdir -p /media/cdrom\n\nmount -t iso9660 -o loop /opt/CentOS-7-x86_64-Everything-2009.iso /media/cdrom/\n\nmount\t\t//查看挂载信息\n\ndf -h\n\nvi /etc/fstab\n\n/opt/CentOS-7-x86_64-Everything-2009.iso    /media/cdrom    iso9660 loop 0 0\n\ntail -1 /etc/fstab\t\t//查看是否写入/etc/fstab\n\n# 4、配置本地yum源\n\ncd /etc/yum.repos.d/\n\nvi local.repo\n\n[local]\n\nname=local\n\nbaseurl=file:///media/cdrom\t   //前面的file://是协议,后面的/media/cdrom是光盘挂载点\n\ngpgcheck=0\t\t//1使用公钥验证rpm包的正确性,0不验证\n\nenabled=1\t\t//1启用yum源,0禁用yum源\n\nyum install -y numactl telnet\n```\n\n运行 virt-manager 启动图形化界面。\n\n如果对 virsh CLI 命令熟悉，可以使用 virsh 命令创建虚拟机。\n\n## （4）服务器网卡配置—NetworkManager 配置\n\n在终端界面，可以通过 nmtui 打开图形化界面进行设置；以下使用 nmcli 进行设置。\n\n```shell\nnmcli connection add con-name eno1 type ethernet autoconnect yes ifname eno1\n\nnmcli connection modify eno1 ipv4.method manual ipv4.addresses 10.75.58.43/24 ipv4.gateway 10.75.58.1 ipv4.dns 64.104.123.245\n\nnmcli connection up eno1\n\nnmcli connection show eno1\n\nping 10.75.58.1\n```\n\n上述命令完成后，在/etc/sysconfig/network-scripts 中会生成网卡的 ifcfg 配置文件。\n\n```shell\ncat /etc/sysconfig/network-scripts/ifcfg-eno1\n\nHWADDR=70:7D:B9:59:5B:AE\n\nTYPE=Ethernet\n\nPROXY_METHOD=none\n\nBROWSER_ONLY=no\n\nBOOTPROTO=none\n\nIPADDR=10.75.58.43\n\nPREFIX=24\n\nGATEWAY=10.75.58.1\n\nDNS1=64.104.123.245\n\nDEFROUTE=yes\n\nIPV4_FAILURE_FATAL=no\n\nIPV6INIT=yes\n\nIPV6_AUTOCONF=yes\n\nIPV6_DEFROUTE=yes\n\nIPV6_FAILURE_FATAL=no\n\nIPV6_ADDR_GEN_MODE=stable-privacy\n\nNAME=eno1\n\nUUID=2a1c8b39-7f44-321b-a65f-a93e70ab0616\n\nONBOOT=yes\n\nAUTOCONNECT_PRIORITY=-999\n\nDEVICE=eno1\n```\n\n此时，可以将 network.service 停止和关闭。\n\n```shell\nsystemctl stop network\n\nsystemctl disable network\n```\n\n注意，如果 NetworkManager 未设置妥当，执行 systemctl stop network 后，会导致服务器无法管理。\n\n准备开启 SRIOV 的网卡设置，以 eno2 为例：\n\n```bash\nnmcli connection add con-name eno2 type ethernet autoconnect yes ifname eno2\n\nnmcli connection modify eno2 ethernet.mtu 9216 ipv4.method disabled\n\nnmcli connection up eno2\n\nnmcli connection show eno2\n\nip link show dev eno2\n```\n\n注：上述 MTU 值设置为 9216 是借鉴自 Cisco NFVIS 平台，如下：\n\n```ios\nCSP5228-1# show pnic-detail mtu\n\nName          MTU\n\n=============================\n\neth0-1        9216\n\neth0-2        9216\n\neth1-1        9216\n\neth1-2        9216\n```\n\n## （5）配置 Linux 网桥 （可选）\n\n网桥 br1 配置示例：\n\n```bash\nnmcli connection add con-name br1 type bridge autoconnect yes ipv4.method disabled ethernet.mtu 9216 ifname br1\n\nnmcli connection up br1\n\nip link show dev br1\n```\n\n网桥 br1 的物理网卡配置\n\n```bash\nnmcli connection add con-name eno5 type ethernet autoconnect yes ifname eno5\n\nnmcli connection modify eno5 ethernet.mtu 9216 ipv4.method disabled master br1\n\nnmcli connection up eno5\n\nip link show dev eno5\n```\n\n创建 net-br1 网络\n\n[root@centos7 ~]# cat net-br1.xml\n\n```xml\n<network>\n\n <name>net-br1</name>\n\n <forward mode=\"bridge\"/>\n\n <bridge name=\"br1\"/>\n\n</network>\n```\n\n```bash\n[root@centos7 ~]# virsh net-define net-br1.xml\n\nNetwork net-br1 defined from net-br1.xml\n\n[root@centos7 ~]# virsh net-start net-br1\n\nNetwork net-br1 started\n\n[root@centos7 ~]# virsh net-autostart net-br1\n\nNetwork net-br1 marked as autostarted\n```\n\n# 配置 SR-IOV\n\n## （1）检查网卡对 SR-IOV 的支持，并配置网卡\n\n可使用 lshw 和 lspci 检查网卡对 SR-IOV 的支持\n\nlshw -c network -businfo\n\n```shell\nBus info          Device      Class          Description\n\n========================================================\n\npci@0000:1d:00.0  eno5        network        VIC Ethernet NIC\n\npci@0000:1d:00.1  eno6        network        VIC Ethernet NIC\n\npci@0000:1d:00.2  eno7        network        VIC Ethernet NIC\n\npci@0000:1d:00.3  eno8        network        VIC Ethernet NIC\n\npci@0000:3b:00.0  eno1        network        Ethernet Controller 10G X550T\n\npci@0000:3b:00.1  eno2        network        Ethernet Controller 10G X550T\n```\n\nlspci -vv -s 3b:00.1 | grep -A 5 -i SR-IOV\n\n```bash\nCapabilities: [160 v1] Single Root I/O Virtualization (SR-IOV)\n\n  IOVCap:\tMigration-, Interrupt Message Number: 000\n\n\tIOVCtl:\tEnable+ Migration- Interrupt- MSE+ ARIHierarchy-\n\n\tIOVSta:\tMigration-\n\n\tInitial VFs: 64, Total VFs: 64, Number of VFs: 8, Function Dependency Link: 01\n\n\tVF offset: 128, stride: 2, Device ID: 1565\n```\n\n## （2）设置启动参数\n\n```shell\nvi /etc/default/grub\n\nGRUB_CMDLINE_LINUX=\"crashkernel=auto spectre_v2=retpoline rd.lvm.lv=centos/root rd.lvm.lv=centos/swap rhgb quiet hugepagesz=1G hugepages=32 default_hugepagesz=1G intel_iommu=on iommu=pt isolcpus=1-8,37-44\"\n\n注：页面数字不要过大，不然启动失败，如果后续不够，可以在运行时添加。\n\ngrub2-mkconfig -o /boot/grub2/grub.cfg\n\ngrub2-mkconfig -o /boot/efi/EFI/centos/grub.cfg\n\niommu=pt 参数是将SRIOV设备支持PCI Passthrough\n```\n\n重启后验证\n\n```shell\ncat /proc/cmdline |grep intel_iommu=on\n\ndmesg |grep -e DMAR -e IOMMU\n\ndmesg | grep -e DMAR -e IOMMU -e AMD-Vi\n```\n\n- **default_hugepagesz=1G hugepagesz=1G hugepages=32** 参数设置主机在启动时分配 32 个 1GB 的内存大页，这些是静态内存大页。 CSR 1000v 虚拟机将试用这些静态大页以获得最优性能。\n- **isolcpus=1-8,37-44** 参数设置的作用是隔离 1-8，37-44 的 CPU 核，使其独立于内核的平衡调度算法，也就是内核本身不会将进程分配到被隔离的 CPU。之后我们可将指定的进程 CSR 1000v 虚拟机绑定到被隔离的 CPU 上运行，让进程独占 CPU，使其实时性可得到一定程度的提高。\n\n可参考 这个章节获取主机 CPU 核的相关信息。\n\n```shell\nroot@centos7 ~]# cat /proc/cmdline |grep intel_iommu=on\n\nBOOT_IMAGE=/vmlinuz-3.10.0-1127.el7.x86_64 root=/dev/mapper/centos-root ro crashkernel=auto spectre_v2=retpoline rd.lvm.lv=centos/root rd.lvm.lv=centos/swap rhgb quiet hugepagesz=1G hugepages=32 default_hugepagesz=1G intel_iommu=on iommu=pt LANG=en_US.UTF-8\n\n[root@centos7 ~]# dmesg |grep -e DMAR -e IOMMU\n\n[    0.000000] ACPI: DMAR 000000005d6f5d70 00250 (v01 Cisco0 CiscoUCS 00000001 INTL 20091013)\n\n[    0.000000] DMAR: IOMMU enabled\n```\n\n查看隔离的 CPU 核以及所有的 CPU 核。\n\n```bash\n[root@centos7 ~]# cat /sys/devices/system/cpu/isolated\n\n1-8,37-44\n\n[root@centos7 ~]# cat /sys/devices/system/cpu/present\n\n0-71\n```\n\n## （3）通过 nmcli 持久化 VFs 配置\n\nnmcli 可以设置网卡的 sriov 参数，如下：\n\n```bash\nnmcli connection modify eno2 sriov.total-vfs 4\n```\n\n还可以设置每一个 VF 设备的 MAC 地址，便于管理：\n\n```bash\nnmcli connection modify eno2 sriov.vfs '0 mac=8E:DF:08:C1:D1:DE trust=true, 1 mac=5A:B9:2F:99:A6:CE trust=true, 2 mac=46:78:69:E3:71:3D trust=true, 3 mac=7E:A7:DB:3B:1B:B3 trust=true'\n```\n\n执行上述命令后：\n\ncat /etc/sysconfig/network-scripts/ifcfg-eno2\n\n```bash\nTYPE=Ethernet\n\nNAME=eno2\n\nUUID=64ffa204-0158-40c8-ba86-2b7aebf27619\n\nDEVICE=eno2\n\nONBOOT=yes\n\nMTU=9216\n\nHWADDR=70:7D:B9:59:5B:AF\n\nPROXY_METHOD=none\n\nBROWSER_ONLY=no\n\nIPV6INIT=no\n\nSRIOV_TOTAL_VFS=4\n\nSRIOV_VF0=\"mac=8E:DF:08:C1:D1:DE trust=true\"\n\nSRIOV_VF1=\"mac=5A:B9:2F:99:A6:CE trust=true\"\n\nSRIOV_VF2=\"mac=46:78:69:E3:71:3D trust=true\"\n\nSRIOV_VF3=\"mac=7E:A7:DB:3B:1B:B3 trust=true\"\n```\n\n重启后，检查 dmesg：\n\ndmesg | grep -i vf | grep -i eno2\n\n```bash\n[   11.953333] ixgbe 0000:3b:00.1 eno2: SR-IOV enabled with 4 VFs\n\n[   12.541801] ixgbe 0000:3b:00.1: setting MAC 8e:df:08:c1:d1:de on VF 0\n\n[   12.541805] ixgbe 0000:3b:00.1: Reload the VF driver to make this change effective.\n\n[   12.541841] ixgbe 0000:3b:00.1 eno2: VF 0 is trusted\n\n[   12.541846] ixgbe 0000:3b:00.1: setting MAC 5a:b9:2f:99:a6:ce on VF 1\n\n[   12.541850] ixgbe 0000:3b:00.1: Reload the VF driver to make this change effective.\n\n[   12.541883] ixgbe 0000:3b:00.1 eno2: VF 1 is trusted\n\n[   12.541887] ixgbe 0000:3b:00.1: setting MAC 46:78:69:e3:71:3d on VF 2\n\n[   12.541891] ixgbe 0000:3b:00.1: Reload the VF driver to make this change effective.\n\n[   12.541923] ixgbe 0000:3b:00.1 eno2: VF 2 is trusted\n\n[   12.541928] ixgbe 0000:3b:00.1: setting MAC 7e:a7:db:3b:1b:b3 on VF 3\n\n[   12.541932] ixgbe 0000:3b:00.1: Reload the VF driver to make this change effective.\n\n[   12.541965] ixgbe 0000:3b:00.1 eno2: VF 3 is trusted\n```\n\n## （4）检查 VF\n\n可通过 lspci 和 ip link 检查 VF，如下：\n\n```bash\n[root@centos7 ~]# lspci | grep -i Virtual\n\n[root@centos7 ~]# ip link show | grep -B2 vf\n```\n\n寻找 Physical Function 和 Virtual Function 之间的对应关系：\n\n```bash\n[root@centos7 ~]# ls -l /sys/class/net/eno1/device/ | grep virtfn\n```\n\nVF 被创建后，NetworkManager 自动给新的设备创建 Connection，可以修改名称，如下：\n\nnmcli connection\n\n```bash\nNAME        UUID                                  TYPE      DEVICE\n\neno1        2a1c8b39-7f44-321b-a65f-a93e70ab0616  ethernet  eno1\n\neno2        64ffa204-0158-40c8-ba86-2b7aebf27619  ethernet  eno2\n\nenp59s16f1  19c28a93-aa36-38e6-a556-55a922a0a332  ethernet  enp59s16f1\n\nenp59s16f3  428d9707-1515-3475-b356-7eb229c3f937  ethernet  enp59s16f3\n\nenp59s16f5  21a8dd5f-239f-37b2-9b09-24ce0e7413bc  ethernet  enp59s16f5\n\nenp59s16f7  0ca0da65-64c4-314d-89a4-4213f9e4f478  ethernet  enp59s16f7\n```\n\n修改名称：\n\n```bash\nnmcli connection modify uuid 19c28a93-aa36-38e6-a556-55a922a0a332 connection.id enp59s16f1\n```\n\n修改 MTU 值，并禁用 IPv4 和 IPv6，网卡启动更快\n\n```bash\nnmcli connection modify enp59s16f1 ifname enp59s16f1 ipv4.method disabled ipv6.method ignore ethernet.mtu 9216 ethernet.mac-address \"\"\n\nnmcli connection up enp59s16f1\n\nnmcli connection show enp59s16f1\n```\n\n上述命令生成的 ifcfg 配置文件如下：\n\n[root@centos7 ~]# cat /etc/sysconfig/network-scripts/ifcfg-enp59s16f1\n\n```bash\nTYPE=Ethernet\n\nPROXY_METHOD=none\n\nBROWSER_ONLY=no\n\nDEFROUTE=yes\n\nIPV4_FAILURE_FATAL=no\n\nIPV6INIT=no\n\nIPV6_AUTOCONF=no\n\nIPV6_DEFROUTE=yes\n\nIPV6_FAILURE_FATAL=no\n\nIPV6_ADDR_GEN_MODE=stable-privacy\n\nNAME=enp59s16f1\n\nUUID=19c28a93-aa36-38e6-a556-55a922a0a332\n\nONBOOT=yes\n\nAUTOCONNECT_PRIORITY=-999\n\nDEVICE=enp59s16f1\n\nMTU=9216\n```\n\n这样，即便系统重启，上述配置依然能生效。\n\n# 使用 KVM 的虚拟网络适配器池\n\n主机上创建一个 VF 网络设备的资源池，资源池内的设备可以自动地分配给虚拟机使用。\n\n## （1）创建一个 xml 文件。\n\n[root@centos7 ~]# cat eno2_sriov_pool.xml\n\n```xml\n<network>\n\n  <name>eno2_sriov_pool</name> <!-- This is the name of the file you created -->\n\n  <forward mode='hostdev' managed='yes'>\n\n   <pf dev='eno2'/> <!-- Use the netdev name of your SR-IOV devices PF here -->\n\n  </forward>\n\n</network>\n```\n\n## （2）根据 xml 定义一个网络，并设置为自动重启\n\n```bash\nvirsh net-define eno2_sriov_pool.xml\n\nvirsh net-start eno2_sriov_pool\n\nvirsh net-autostart eno2_sriov_pool\n```\n\n[root@centos7 ~]# virsh net-dumpxml eno2_sriov_pool\n\n```xml\n<network connections='1'>\n\n <name>eno2_sriov_pool</name>\n\n <uuid>e0842451-0137-4255-8783-305ca27f082d</uuid>\n\n <forward mode='hostdev' managed='yes'>\n\n  <pf dev='eno2'/>\n\n  <address type='pci' domain='0x0000' bus='0x3b' slot='0x10' function='0x1'/>\n\n  <address type='pci' domain='0x0000' bus='0x3b' slot='0x10' function='0x3'/>\n\n  <address type='pci' domain='0x0000' bus='0x3b' slot='0x10' function='0x5'/>\n\n  <address type='pci' domain='0x0000' bus='0x3b' slot='0x10' function='0x7'/>\n\n </forward>\n\n</network>\n```\n\n## （3）从网络适配器池中分配网卡给虚拟机\n\n用这种方法添加 SRIOV 网卡比较简单：\n\n![SRIOV Adapter Pool](csr1kv-kvm-CentOS7/sriov-pool-001.png)\n\n按照如上方法添加网卡，等同于以下 xml 配置：\n\n```xml\n  <interface type='network'>\n\n   <mac address='52:54:00:2d:87:99'/>\n\n   <source network='eno2_sriov_pool'/>\n\n   <model type='virtio'/>\n\n   <address type='pci' domain='0x0000' bus='0x00' slot='0x04' function='0x0'/>\n\n  </interface>\n```\n\n开机后 dumpxml 如下：\n\n```xml\n  <interface type='hostdev' managed='yes'>\n\n   <mac address='52:54:00:2d:87:99'/>\n\n   <driver name='vfio'/>\n\n   <source>\n\n    <address type='pci' domain='0x0000' bus='0x3b' slot='0x10' function='0x1'/>\n\n   </source>\n\n   <model type='virtio'/>\n\n   <alias name='hostdev0'/>\n\n   <address type='pci' domain='0x0000' bus='0x00' slot='0x0f' function='0x0'/>\n\n</interface>\n```\n\n# 使用 Virt-manager 安装 CSR1000v\n\n在 CentOS 图形界面中，打开 Terminal，运行 virt-manager，按照以下步骤创建 CSR1000v；添加网卡，并选择 en2_sriov_pool。\n\n![Step 1](csr1kv-kvm-CentOS7/virt-manager-1.png)\n\n![选择镜像](csr1kv-kvm-CentOS7/virt-manager-2.png)\n\n![Step 2](csr1kv-kvm-CentOS7/virt-manager-3.png)\n\n![Step 3](csr1kv-kvm-CentOS7/virt-manager-3.png)\n\n![Step 4](csr1kv-kvm-CentOS7/virt-manager-5.png)\n\n注：csr1kv-1 的第一个网口选择**macvtap Bridge**模式，这样就无需创建一个 Linux 网桥。但是，csr1kv-1 启动以后不能通过该接口与 Linux 主机进行通信，仅能通过该接口访问 Linux 主机外的网络。\n\n![Step 5](csr1kv-kvm-CentOS7/virt-manager-6.png)\n\n![Step 6](csr1kv-kvm-CentOS7/virt-manager-7.png)\n\n添加完网卡后，点击开始安装，然后就可以关闭虚拟机了。上述操作完成后，virt-manager 会在**/etc/libvirtd/qemu/**目录下创建**csr1kv-1.xml**。\n\n# KVM 调优配置\n\nKVM 的调优比较复杂，主要是 NUMA、内存大页、vCPU PIN 等，参考资料为 Redhat Linux 7 PERFORMANCE TUNING GUIDE。\n\n## （1）检查平台的能力\n\n```bash\n[root@centos7 ~]# virsh nodeinfo\n\nCPU model:           x86_64\n\nCPU(s):              72\n\nCPU frequency:       999 MHz\n\nCPU socket(s):       1\n\nCore(s) per socket:  18\n\nThread(s) per core:  2\n\nNUMA cell(s):        2\n\nMemory size:         263665612 KiB\n```\n\n```bash\n[root@centos7 ~]# virsh capabilities\n\n<capabilities>\n\n <host>\n\n  <uuid>4e53df1f-5b36-6842-99ee-1369d7c68730</uuid>\n\n  <cpu>\n\n   <arch>x86_64</arch>\n\n   <model>Skylake-Server-IBRS</model>\n\n   <vendor>Intel</vendor>\n\n   <microcode version='33581318'/>\n\n   <counter name='tsc' frequency='2294597000' scaling='yes'/>\n\n   <topology sockets='1' cores='18' threads='2'/>\n\n……\n```\n\n可检查平台的 CPU 核数、分布，内存的 NUMA 分布等。\n\n## （2）NUMA 调优\n\n```bash\n[root@centos7 ~]# numactl --hardware\n\navailable: 2 nodes (0-1)\n\nnode 0 cpus: 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53\n\nnode 0 size: 128491 MB\n\nnode 0 free: 112157 MB\n\nnode 1 cpus: 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71\n\nnode 1 size: 128994 MB\n\nnode 1 free: 124120 MB\n\nnode distances:\n\nnode  0  1\n\n 0: 10 21\n\n 1: 21 10\n```\n\n两颗 CPU，每颗 CPU 各有 128GB 内存，分别是 node 0 和 node 1。\n\n## （3）内存大页 HugePage 以及透明大页\n\n` `cat /proc/meminfo | grep HugePages 查看当前系统有多少个大页：\n\n```bash\n[root@centos7 ~]# cat /proc/meminfo | grep Huge\n\nAnonHugePages:   1685504 kB\n\nHugePages_Total:      64\n\nHugePages_Free:       60\n\nHugePages_Rsvd:        0\n\nHugePages_Surp:        0\n\nHugepagesize:    1048576 kB\n```\n\n在系统运行时修改大页数量：\n\n```bash\n[root@centos7 ~]# cat /sys/devices/system/node/node0/hugepages/hugepages-1048576kB/nr_hugepages\n\n16\n\n[root@centos7 ~]# echo 32 > /sys/devices/system/node/node0/hugepages/hugepages-1048576kB/nr_hugepages\n\n[root@centos7 ~]# echo 32 > /sys/devices/system/node/node1/hugepages/hugepages-1048576kB/nr_hugepages\n\n[root@centos7 ~]#\n\n[root@centos7 ~]# numastat -cm | egrep 'Node|Huge'\n\n`                 `Node 0 Node 1  Total\n\nAnonHugePages     10962   1528  12490\n\nHugePages_Total   32768  32768  65536\n\nHugePages_Free    32768  32768  65536\n\nHugePages_Surp        0      0      0\n```\n\n检查透明大页参数，在 CentOS7 上缺省开启；开启了透明大页，不影响静态大页的使用。\n\n```bash\ncat /sys/kernel/mm/transparent_hugepage/enabled\n\n[always] madvise never\n```\n\n## （4）vCPU 钉选\n\n设置 CPU Affinity 的好处是提高 CPU 缓存效率，避免进程在多个 CPU 核之间跳跃，切换 CPU 核均会导致缓存中的数据无效，缓存命中率大幅降低，导致数据获取的开销居高不下，损失性能。\n\n**virsh vcpuinfo csr1kv-1** 可以查看 vCPU 的分配。\n\n## （5）编辑 CSR 1000v 的 XML 调优参数\n\nvirsh edit csr1kv-1 可以编辑 XML 的参数，如下：\n\n```xml\n  <memoryBacking>\n    <hugepages>\n      <page size='1048576' unit='KiB'/>\n    </hugepages>\n    <locked/>\n    <nosharepages/>\n  </memoryBacking>\n  <vcpu placement='static'>8</vcpu>\n  <cputune>\n    <vcpupin vcpu='0' cpuset='1'/>\n    <vcpupin vcpu='1' cpuset='2'/>\n    <vcpupin vcpu='2' cpuset='3'/>\n    <vcpupin vcpu='3' cpuset='4'/>\n    <vcpupin vcpu='4' cpuset='5'/>\n    <vcpupin vcpu='5' cpuset='6'/>\n    <vcpupin vcpu='6' cpuset='7'/>\n    <vcpupin vcpu='7' cpuset='8'/>\n    <emulatorpin cpuset='45-52'/> <!-- If Hyper-threading were enabled -->\n  </cputune>\n  <numatune>\n    <memory mode='strict' nodeset='0'/>\n  </numatune>\n  <cpu mode='host-passthrough' check='none'/>\n    <memballoon model='none'/>\n```\n\n注：**<emulatorpin cpuset='37-44'/>** 参数，仅当 Hyper-Threating 开启时使用；有一些平台并未关闭超线程，例如 Cisco 专门的 NFV 平台 CSP。通过 virsh chapabilities 查看 siblings='1,37'，当 core 1 设置为 vcpupin 时，core 37 应设置到 emulatorpin cpuset 中。\n\n以下关于 CPU 和内存的参数设定建议来自于<https://libvirt.org/formatdomain.html> 和 <https://libvirt.org/kbase/kvm-realtime.html>\n\n```xml\n<domain type='kvm'>\n  <name>csr1kv-1</name>\n  <uuid>59581018-6387-49df-ab09-2bcf40fc12ba</uuid>\n  <memory unit='KiB'>8388608</memory>\n  <currentMemory unit='KiB'>8388608</currentMemory>\n  <memoryBacking>\n    <hugepages>\n      <page size='1048576' unit='KiB'/>\n</hugepages>\n<locked/>\n    <nosharepages/>\n  </memoryBacking>\n  <vcpu placement='static'>8</vcpu>\n  <cputune>\n    <vcpupin vcpu='0' cpuset='1'/>\n    <vcpupin vcpu='1' cpuset='2'/>\n    <vcpupin vcpu='2' cpuset='3'/>\n    <vcpupin vcpu='3' cpuset='4'/>\n    <vcpupin vcpu='4' cpuset='5'/>\n    <vcpupin vcpu='5' cpuset='6'/>\n    <vcpupin vcpu='6' cpuset='7'/>\n    <vcpupin vcpu='7' cpuset='8'/>\n    <emulatorpin cpuset='37-44'/>\n  </cputune>\n  <numatune>\n    <memory mode='strict' nodeset='0'/>\n  </numatune>\n  <os>\n    <type arch='x86_64' machine='pc-i440fx-rhel7.0.0'>hvm</type>\n    <boot dev='hd'/>\n  </os>\n  <features>\n    <acpi/>\n    <apic/>\n  </features>\n  <cpu mode='host-passthrough' check='none'/>\n  <clock offset='utc'>\n    <timer name='rtc' tickpolicy='catchup'/>\n    <timer name='pit' tickpolicy='delay'/>\n    <timer name='hpet' present='no'/>\n  </clock>\n  <on_poweroff>destroy</on_poweroff>\n  <on_reboot>restart</on_reboot>\n  <on_crash>destroy</on_crash>\n  <pm>\n    <suspend-to-mem enabled='no'/>\n    <suspend-to-disk enabled='no'/>\n  </pm>\n  <devices>\n    <emulator>/usr/libexec/qemu-kvm</emulator>\n    <disk type='file' device='disk'>\n      <driver name='qemu' type='qcow2'/>\n      <source file='/home/root/images/csr1000v-universalk9.17.02.01v.qcow2'/>\n      <target dev='vda' bus='virtio'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x07' function='0x0'/>\n    </disk>\n    <controller type='usb' index='0' model='ich9-ehci1'>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x05' function='0x7'/>\n    </controller>\n    <controller type='usb' index='0' model='ich9-uhci1'>\n      <master startport='0'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x05' function='0x0' multifunction='on'/>\n    </controller>\n    <controller type='usb' index='0' model='ich9-uhci2'>\n      <master startport='2'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x05' function='0x1'/>\n    </controller>\n    <controller type='usb' index='0' model='ich9-uhci3'>\n      <master startport='4'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x05' function='0x2'/>\n    </controller>\n    <controller type='pci' index='0' model='pci-root'/>\n    <controller type='virtio-serial' index='0'>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x06' function='0x0'/>\n    </controller>\n    <interface type='direct'>\n      <mac address='52:54:00:36:95:f0'/>\n      <source dev='eno1' mode='bridge'/>\n      <model type='virtio'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x03' function='0x0'/>\n    </interface>\n    <interface type='network'>\n      <mac address='52:54:00:2d:87:99'/>\n      <source network='eno2_sriov_pool'/>\n      <model type='virtio'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x04' function='0x0'/>\n    </interface>\n    <serial type='pty'>\n      <target type='isa-serial' port='0'>\n        <model name='isa-serial'/>\n      </target>\n    </serial>\n    <console type='pty'>\n      <target type='serial' port='0'/>\n    </console>\n    <channel type='unix'>\n      <target type='virtio' name='org.qemu.guest_agent.0'/>\n      <address type='virtio-serial' controller='0' bus='0' port='1'/>\n    </channel>\n    <channel type='spicevmc'>\n      <target type='virtio' name='com.redhat.spice.0'/>\n      <address type='virtio-serial' controller='0' bus='0' port='2'/>\n    </channel>\n    <input type='tablet' bus='usb'>\n      <address type='usb' bus='0' port='1'/>\n    </input>\n    <input type='mouse' bus='ps2'/>\n    <input type='keyboard' bus='ps2'/>\n    <graphics type='spice' autoport='yes'>\n      <listen type='address'/>\n      <image compression='off'/>\n    </graphics>\n    <video>\n      <model type='qxl' ram='65536' vram='65536' vgamem='16384' heads='1' primary='yes'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x02' function='0x0'/>\n    </video>\n    <redirdev bus='usb' type='spicevmc'>\n      <address type='usb' bus='0' port='2'/>\n    </redirdev>\n    <redirdev bus='usb' type='spicevmc'>\n      <address type='usb' bus='0' port='3'/>\n    </redirdev>\n    <memballoon model='none'/>\n    <rng model='virtio'>\n      <backend model='random'>/dev/urandom</backend>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x09' function='0x0'/>\n    </rng>\n  </devices>\n</domain>\n```\n\n上述参数整理自[《Cisco CSR 1000v and Cisco ISRv Software Configuration Guide》](https://www.cisco.com/c/en/us/td/docs/routers/csr1000/software/configuration/b_CSR1000v_Configuration_Guide/b_CSR1000v_Configuration_Guide_chapter_0101.html)\n\n完成上述 XML 文件的编辑后，执行\n\n```bash\ncd /etc/libvirtd/qemu\n\nvirsh define csr1kv-1.xml\n\nvirsh start csr1kv-1\n```\n\n## （6）在 KVM 主机上访问 CSR1000v 的 Console\n\n在 virt-manager 创建 CSR1000v 虚拟机的时候，缺省会添加一个 Serial Device。\n\n```bash\n[root@centos7 qemu]# virsh console 20\n\nConnected to domain CSR1000v-1\n\nEscape character is ^]\n```\n\nCSR 1000v 暂时不能通过 Console 配置，需要通过 virt-manager 的图形化界面进行初始化配置。\n\nvCloud 的 Console 访问正常。\n\n## （7）检验 CSR1000v 的调优配置\n\n```xml\n[root@centos7 ~]# virsh list\n\nId  Name              State\n\n----------------------------------------------------\n\n 6   csr1kv-1            running\n\n\n\n[root@centos7 ~]# virsh vcpuinfo 6\n\nVCPU:      0\n\nCPU:      1\n\nState:     running\n\nCPU time:    34.5s\n\nCPU Affinity:  -y----------------------------------------------------------------------\n\n\n\nVCPU:      1\n\nCPU:      2\n\nState:     running\n\nCPU time:    32.0s\n\nCPU Affinity:  --y---------------------------------------------------------------------\n\n\n\nVCPU:      2\n\nCPU:      3\n\nState:     running\n\nCPU time:    23.8s\n\nCPU Affinity:  ---y--------------------------------------------------------------------\n\n\n\nVCPU:      3\n\nCPU:      4\n\nState:     running\n\nCPU time:    19.8s\n\nCPU Affinity:  ----y-------------------------------------------------------------------\n\n\n\nVCPU:      4\n\nCPU:      5\n\nState:     running\n\nCPU time:    23.0s\n\nCPU Affinity:  -----y------------------------------------------------------------------\n\n\n\nVCPU:      5\n\nCPU:      6\n\nState:     running\n\nCPU time:    23.4s\n\nCPU Affinity:  ------y-----------------------------------------------------------------\n\n\n\nVCPU:      6\n\nCPU:      7\n\nState:     running\n\nCPU time:    28.5s\n\nCPU Affinity:  -------y----------------------------------------------------------------\n\n\n\nVCPU:      7\n\nCPU:      8\n\nState:     running\n\nCPU time:    28.2s\n\nCPU Affinity:  --------y---------------------------------------------------------------\n```\n\n以上显示 CSR1000v 虚拟机的 CPU 亲和性在 1-8 核上。\n\n```bash\n[root@centos7 ~]# numastat -c qemu-kvm\n\nPer-node process memory usage (in MBs) for PID 46895 (qemu-kvm)\n\n     Node 0 Node 1 Total\n\n     ------ ------ -----\n\nHuge    8192   0 8192\n\nHeap    118   0  118\n\nStack     0   0   0\n\nPrivate   144   7  151\n\n------- ------ ------ -----\n\nTotal   8455   7 8461\n\n\n```\n\n以上显示，内存主要使用 Node 0。\n\n```bash\n[root@centos7 ~]# numastat -vm -p 13428 | grep HugePage\n\nAnonHugePages       956.00     494.00     1450.00\n\nHugePages_Total     16384.00    16384.00    32768.00\n\nHugePages_Free      8192.00    16384.00    24576.00\n\nHugePages_Surp       0.00       0.00      0.00\n```\n\n## （8）在 CSR1KV 上检查虚拟网卡\n\n```ios\ncsr1kv-1#show platform software vnic-if interface-mapping\n\n-------------------------------------------------------------\n\n Interface Name    Driver Name     Mac Addr\n\n-------------------------------------------------------------\n\n GigabitEthernet2    net_ixgbe_vf    5254.002d.8799\n\n GigabitEthernet1    net_virtio     5254.0036.95f0\n```\n\n上述驱动名显示为 net_ixgbe_vf 表明该虚拟网卡是一个 SR-IOV 池中分配的 VF 设备。\n\n# Linux 上抓取虚拟网卡的报文（参考）\n\n查找虚拟机的网卡列表\n\n```bash\n[root@centos7 ~]# virsh domiflist 10\n\nInterface Type    Source   Model    MAC\n\n-------------------------------------------------------\n\nvnet0   network  default  virtio   52:54:00:38:71:4a\n\nmacvtap0  direct   eno1    virtio   52:54:00:b2:70:90\n\nvnet5   bridge   net-br1  virtio   52:54:00:69:93:23\n```\n\n抓取 vnet5 的报文\n\n```bash\n[root@centos7 ~]# tcpdump -i vnet5 -w ping.pcap\n\ntcpdump: listening on vnet5, link-type EN10MB (Ethernet), capture size 262144 bytes\n\n^C49 packets captured\n\n51 packets received by filter\n\n0 packets dropped by kernel\n```\n\n注：VF 如果被分配给虚拟机，那么在 Linux 主机里，通过 ip link 则查看不到该设备，无法通过上述办法抓包。\n\n# CSR 1000v 的初始化配置及 Smart License 注册\n\n## （1）CSR 1000v 初始化配置示例\n\n部分节略，其他为缺省配置。\n\n```ios\nCSR1000v-1#show sdwan running-config\n\nsystem\n\n system-ip       1.1.10.1\n\n site-id        101\n\n sp-organization-name CiscoBJ\n\n organization-name   CiscoBJ\n\n vbond 10.75.58.51 port 12346\n\n!\n\nhostname CSR1000v-1\n\nusername admin privilege 15 secret 9 $9$4/QL2V2K4/6H1k$XUmRNf.T7t3KDOj/FmoNexpEypCxr482dExXHDnohSI\n\nip name-server 64.104.123.245\n\nip route 0.0.0.0 0.0.0.0 10.75.59.1\n\n\n\ninterface GigabitEthernet1\n\n no shutdown\n\n arp timeout 1200\n\n ip address 10.75.59.35 255.255.255.0\n\n no ip redirects\n\n ip mtu  1500\n\n mtu 1500\n\n negotiation auto\n\nexit\n\n\n\ninterface Tunnel1\n\n no shutdown\n\n ip unnumbered GigabitEthernet1\n\n no ip redirects\n\n ipv6 unnumbered GigabitEthernet1\n\n no ipv6 redirects\n\n tunnel source GigabitEthernet1\n\n tunnel mode sdwan\n\nexit\n\n\n\nclock timezone CST 8 0\n\nntp server 10.75.58.1 version 4\n\nsdwan\n\n interface GigabitEthernet1\n\n tunnel-interface\n\n  encapsulation ipsec\n\n  allow-service sshd\n\n exit\n```\n\n## （2）常用命令\n\n- show sdwan control local-properties\n- show sdwan control connections\n- show sdwan control connection-history\n- show sdwan running-config\n- show sdwan bfd sessions\n- show sdwan omp peers\n- show sdwan omp routes\n\n## （3）CSR 1000v Smart License 注册\n\nCSR 1000v 默认限速为 250Mbps，需要注册 Smart License 才可解开限速。\n\n```ios\nCSR1000v-2#show platform hardware throughput level\n\nThe current throughput level is 250000 kb/s\n```\n\n注册 Smart License 需要满足以下条件：\n\n1、 CSR 1000v 已经注册到 vManage，控制面连接正常；\n\n2、 配置 ip http client source-interface GigabitEthernet2\n\n3、 sdwan interface GigabitEthernet2 tunnel-interface allow-service all ---针对 16.12.x 版本；在新版本中仅需要 allow https\n\n4、 CSR 1000v 可以访问 URL：<https://tools.cisco.com/its/service/oddce/services/DDCEService>\n\n允许访问 114.114.114.114，CSR 1000v 可解析域名 tools.cisco.com\n\n替代办法，增加一条命令 ip host tools.cisco.com 72.163.4.38\n\n执行 license smart register idtoken xxxxxx 进行注册\n\nshow license status 查看注册结果\n\n注册完成后，系统解开限速：\n\n```ios\nCSR1000v-1#show platform hardware throughput level\n\nThe current throughput level is 200000000 kb/s\n```\n\n# 性能和相关限制\n\n## （1）SRIOV 的性能\n\n在上述 CSR1KV-1 安装好后，使用测试仪进行性能测试，测试条件中，设置丢包率为 0%，其性能如下：\n\n| Packet Site | SDWAN Performance (Mbps) | CEF Performance (Mbps) |\n| :---------- | :----------------------: | :--------------------: |\n| 128Byte     |           800            |        2843.75         |\n| 256Byte     |         1431.26          |        6500.00         |\n| 512Byte     |         2581.26          |        10578.13        |\n| 1024Byte    |         3731.26          |        15500.00        |\n| 1400Byte    |         4306.26          |        18171.88        |\n\n![性能现状图表](csr1kv-kvm-CentOS7/line-chart-009.png)\n\n注：上述测试结果非官方结果，不同服务器和网卡可能测试结果有区别，上述性能数据仅供参考。\n\n## （2）SRIOV 的限制\n\nSRIOV 的主要限制是每一个 VF 设备支持的 VLAN 数，ixgbevf 所支持的最大 VLAN 数为 64；因此，在 CSR1KV 中对应的虚拟接口配置的活跃子接口数最大为 64。\n\n配置指南中有关于 SRIOV 子接口限制的说明：\n\n` `[Cisco CSR 1000v and Cisco ISRv Software Configuration Guide](https://www.cisco.com/c/en/us/td/docs/routers/csr1000/software/configuration/b_CSR1000v_Configuration_Guide/b_CSR1000v_Configuration_Guide_chapter_0101.html):\n\n> SR-IOV (ixgbevf)\n>\n> Maximum VLANs: The maximum number of VLANs supported on PF is 64. Together, all VFs can have a total of 64 VLANs. (Intel limitation.)\n>\n> SR-IOV (i40evf)\n>\n> Maximum VLANs: The maximum number of VLANs supported on PF is 512. Together, all VFs can have a total of 512 VLANs. (Intel limitation.) Per-VF resources are managed by the PF (host) device driver.\n\n# 附录\n\n## （1）Virt-manager 设置虚机的 CPU 模式说明\n\nLibvirt 主要支持三种 CPU mode：\n\n- host-passthrough: libvirt 令 KVM 把宿主机的 CPU 指令集全部透传给虚拟机。因此虚拟机能够最大限度的使用宿主机 CPU 指令集，故性能是最好的。但是在热迁移时，它要求目的节点的 CPU 和源节点的一致。\n- host-model: libvirt 根据当前宿主机 CPU 指令集从配置文件 /usr/share/libvirt/cpu_map.xml 选择一种最相配的 CPU 型号。在这种 mode 下，虚拟机的指令集往往比宿主机少，性能相对 host-passthrough 要差一点，但是热迁移时，它允许目的节点 CPU 和源节点的存在一定的差异。\n- custom: 这种模式下虚拟机 CPU 指令集数最少，故性能相对最差，但是它在热迁移时跨不同型号 CPU 的能力最强。此外，custom 模式下支持用户添加额外的指令集。\n\n三种 mode 的性能排序是：host-passthrough > host-model > custom\n\n实际性能差异不大：100%> 95.84%>94.73%\n\n引自：<http://wsfdl.com/openstack/2018/01/02/libvirt_cpu_mode.html>\n\n## （2）有关网卡模式的说明\n\n使用 virt-manager 创建虚拟机，在添加网卡时，有 3 中选择，分别是 e1000, rtl8139, virtio。\n\n“rtl8139”这个网卡模式是 qemu-kvm 默认的模拟网卡类型，RTL8139 是 Realtek 半导体公司的一个 10/100M 网卡系列，是曾经非常流行（当然现在看来有点古老）且兼容性好的网卡，几乎所有的现代操作系统都对 RTL8139 网卡驱动的提供支持。\n\n“e1000”系列提供 Intel e1000 系列的网卡模拟，纯的 QEMU（非 qemu-kvm）默认就是提供 Intel e1000 系列的虚拟网卡。\n\n“virtio” 类型是 qemu-kvm 对半虚拟化 IO（virtio）驱动的支持。\n\n这三个网卡的最大区别(此处指最需要关注的地方)是速度：\n\n- rtl8139 10/100Mb/s\n\n- e1000 1Gb/s\n\n- virtio 10Gb/s\n\n注意 virtio 是唯一可以达到 10Gb/s 的。\n\nvirtio 是一种 I/O 半虚拟化解决方案，是一套通用 I/O 设备虚拟化的程序，是对半虚拟化 Hypervisor 中的一组通用 I/O 设备的抽象。提供了一套上层应用与各 Hypervisor 虚拟化设备（KVM，Xen，VMware 等）之间的通信框架和编程接口，减少跨平台所带来的兼容性问题，大大提高驱动程序开发效率。\n\n## （3）有关 MACVTAP\n\n以下内容来自：<https://www.ibm.com/developerworks/cn/linux/1312_xiawc_linuxvirtnet/index.html>\n\nMACVTAP 的实现基于传统的 MACVLAN。和 TAP 设备一样，每一个 MACVTAP 设备拥有一个对应的 Linux 字符设备，并拥有和 TAP 设备一样的 IOCTL 接口，因此能直接被 KVM/Qemu 使用，方便地完成网络数据交换工作。引入 MACVTAP 设备的目标是：简化虚拟化环境中的交换网络，代替传统的 Linux TAP 设备加 Bridge 设备组合，同时支持新的虚拟化网络技术，如 802.1 Qbg。\n\nMACVTAP 设备和 VLAN 设备类似，是以一对多的母子关系出现的。在一个母设备上可以创建多个 MACVTAP 子设备，一个 MACVTAP 设备只有一个母设备，MACVTAP 子设备可以做为母设备，再一次嵌套的创建 MACVTAP 子设备。母子设备之间被隐含的桥接起来，母设备相当于现实世界中的交换机 TRUNK 口。实际上当 MACVTAP 设备被创建并且模式不为 Passthrough 时，内核隐含的创建了 MACVLAN 网络，完成转发功能。MACVTAP 设备有四种工作模式：Bridge、VEPA、Private，Passthrough。\n\nBridge 模式下，它完成与 Bridge 设备类似功能，数据可以在属于同一个母设备的子设备间交换转发，虚拟机相当于简单接入了一个交换机。当前的 Linux 实现有一个缺陷，此模式下 MACVTAP 子设备无法和 Linux Host 通讯，即虚拟机无法和 Host 通讯。----经验证，属实。\n\nPassthrough 模式下，内核的 MACVLAN 数据处理逻辑被跳过，硬件决定数据如何处理，从而释放了 Host CPU 资源。\n\n![MACVTAP 直通 vs PCI 直通](csr1kv-kvm-CentOS7/macvtap-ibm.png)\n\nMACVTAP Passthrough 概念与 PCI Passthrough 概念不同，上图详细解释了两种情况的区别。\n\nPCI Passthrough 针对的是任意 PCI 设备，不一定是网络设备，目的是让 Guest OS 直接使用 Host 上的 PCI 硬件以提高效率。以 X86 平台为例，数据将通过需要硬件支持的 VT-D 技术从 Guest OS 直接传递到 Host 硬件上。这样做固然效率很高，但因为模拟器失去了对虚拟硬件的控制，难以同步不同 Host 上的硬件状态，因此当前在使用 PCI Passthrough 的情况下难以做动态迁移。\n\nMACVTAP Passthrough 仅仅针对 MACVTAP 网络设备，目的是绕过内核里 MACVTAP 的部分软件处理过程，转而交给硬件处理。在虚拟化条件下，数据还是会先到达模拟器 I/O 层，再转发到硬件上。这样做效率有损失，但模拟器仍然控制虚拟硬件的状态及数据的走向，可以做动态迁移。\n\n## （4）SR-IOV 介绍\n\n如果网卡支持 SRIOV，请使用 SRIOV PCI Passthrough。\n\n![nic-type-010](csr1kv-kvm-CentOS7/nic-type-010.png)\n\n软件模拟是通过 Hypervisor 层模拟虚拟网卡，实现与物理设备完全一样的接口，虚拟机操作系统无须修改就能直接驱动虚拟网卡，其最大的缺点是性能相对较差；\n\n网卡直通支持虚拟机绕过 Hypervisor 层，直接访问物理 I/O 设备，具有最高的性能，但是在同一时刻物理 I/O 设备只能被一个虚拟机独享；\n\nSR-IOV 是 Intel 在 2007 年提出的解决虚拟化网络 I/O 的硬件技术方案，该技术不仅能够继承网卡直通的高性能优势，而且同时支持物理 I/O 设备的跨虚拟机共享，具有较好的应用前景。\n\n原文链接：<https://blog.csdn.net/lsz137105/article/details/100752930>\n\nSR-IOV（Single Root I/O Virtualization）是一个将 PCIe 设备（如网卡）共享给虚拟机的标准，通过为虚拟机提供独立的内存空间、中断、DMA 流，来绕过 VMM 实现数据访问。\n\nSR-IOV 引入了两种 PCIe functions：\n\n- PF（Physical Function）：包含完整的 PCIe 功能，包括 SR-IOV 的扩张能力，该功能用于 SR-IOV 的配置和管理。\n- VF（Virtual Function）：包含轻量级的 PCIe 功能。每一个 VF 有它自己独享的 PCI 配置区域，并且可能与其他 VF 共享着同一个物理资源。\n\nSR-IOV 网卡通过将 SR-IOV 功能集成到物理网卡上，将单一的物理网卡虚拟成多个 VF 接口，每个 VF 接口都有单独的虚拟 PCIe 通道，这些虚拟的 PCIe 通道共用物理网卡的 PCIe 通道。每个虚拟机可占用一个或多个 VF 接口，这样虚拟机就可以直接访问自己的 VF 接口，而不需要 Hypervisor 的协调干预，从而大幅提升网络吞吐性能。\n\n## （5）探索虚拟机进程\n\n每一个客户机就是宿主机中的一个 QEMU 进程，而一个客户机的多个 vCPU 就是一个 QEMU 进程中的多个线程。\n\n```bash\n[root@centos7 ~]# ps -ef | grep qemu\n\nqemu      52595      1 99 10:37 ?        01:24:12 /usr/libexec/qemu-kvm -name csr1kv-1 -S -machine pc-i440fx-rhel7.0.0,accel=kvm,usb=off,dump-guest-core=off,mem-merge=off -cpu host -m 8192 -mem-prealloc -mem-path /dev/hugepages/libvirt/qemu/7-csr1kv-1 -realtime mlock=on -smp 8,sockets=8,cores=1,threads=1 -uuid 59581018-6387-49df-ab09-2bcf40fc12ba -no-user-config -nodefaults -chardev socket,id=charmonitor,path=/var/lib/libvirt/qemu/domain-7-csr1kv-1/monitor.sock,server,nowait -mon chardev=charmonitor,id=monitor,mode=control -rtc base=utc,driftfix=slew -global kvm-pit.lost_tick_policy=delay -no-hpet -no-shutdown -global PIIX4_PM.disable_s3=1 -global PIIX4_PM.disable_s4=1 -boot strict=on -device piix3-usb-uhci,id=usb,bus=pci.0,addr=0x1.0x2 -device virtio-serial-pci,id=virtio-serial0,bus=pci.0,addr=0x6 -drive file=/home/root/images/csr1000v-universalk9.17.02.01v.qcow2,format=qcow2,if=none,id=drive-virtio-disk0 -device virtio-blk-pci,scsi=off,bus=pci.0,addr=0x7,drive=drive-virtio-disk0,id=virtio-disk0,bootindex=1 -netdev tap,fd=26,id=hostnet0,vhost=on,vhostfd=28 -device virtio-net-pci,netdev=hostnet0,id=net0,mac=52:54:00:36:95:f0,bus=pci.0,addr=0x3 -chardev pty,id=charserial0 -device isa-serial,chardev=charserial0,id=serial0 -chardev socket,id=charchannel0,path=/var/lib/libvirt/qemu/channel/target/domain-7-csr1kv-1/org.qemu.guest_agent.0,server,nowait -device virtserialport,bus=virtio-serial0.0,nr=1,chardev=charchannel0,id=channel0,name=org.qemu.guest_agent.0 -chardev spicevmc,id=charchannel1,name=vdagent -device virtserialport,bus=virtio-serial0.0,nr=2,chardev=charchannel1,id=channel1,name=com.redhat.spice.0 -spice port=5900,addr=127.0.0.1,disable-ticketing,image-compression=off,seamless-migration=on -vga qxl -global qxl-vga.ram_size=67108864 -global qxl-vga.vram_size=67108864 -global qxl-vga.vgamem_mb=16 -global qxl-vga.max_outputs=1 -device vfio-pci,host=1d:00.0,id=hostdev1,bus=pci.0,addr=0x8 -device vfio-pci,host=3b:10.1,id=hostdev0,bus=pci.0,addr=0x4 -msg timestamp=on\n```\n\n使用 virsh 命令或 virt-manager 开启虚拟机，是通过调用/usr/libexec/qemu-kvm 并附带虚拟配置的参数，来开启 qemu-kvm 的进程。可以看到上述的参数是非常复杂的，libvirt 提供 XML 参数进行简化。\n\nps -efL | grep qemu 可以列出所有的线程，但是输出篇幅很长，不在此列出；使用 pstree 可列出其父进程、线程关系，如下：\n\n![Pstree](csr1kv-kvm-CentOS7/pstree-011.png)\n\nvirt-top 可查看虚机运行状态和资源利用率：\n\n[root@centos7 ~]# virt-top -1\n\n![Virt-top](csr1kv-kvm-CentOS7/virt-top-012.png)\n\n# 参考资料连接\n\n- <https://cloud.tencent.com/developer/article/1703094>\n- <https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html-single/performance_tuning_guide/index>\n- <https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/7/html-single/virtualization_tuning_and_optimization_guide/index>\n- <https://computingforgeeks.com/how-to-create-and-configure-bridge-networking-for-kvm-in-linux/>\n- <https://software.intel.com/content/www/us/en/develop/articles/configure-sr-iov-network-virtual-functions-in-linux-kvm.html>\n","source":"_posts/csr1kv-kvm-CentOS7.md","raw":"---\ntitle: CSR 1000v KVM SRIOV CentOS 7安装设置指南\ndate: 2021-02-03 13:58:32\ntags: \n    - CSR1000v\n    - KVM\n    - SRIOV\n    - NetworkManager\n    - Cisco\ndescription: 本文提供在 CentOS 7 版本上安装 KVM，并安装和设置 CSR 1000v/Catalyst 8000v 的指南，内容包括 SRIOV，KVM 调优以及 CSR1KV 初始化配置等内容。\n---\n\n作者：Rao Weibo\n\n版本：1.0\n\n更新日期：20210203\n\n本文提供在 CentOS 7 版本上安装 KVM，并安装和设置 CSR 1000v/Catalyst 8000v 的指南，内容包括 SRIOV，KVM 调优以及 CSR1KV 初始化配置等内容。\n\n# CentOS7 安装及设置\n\n## （1）BIOS 设置建议\n\n| Configuration                       | Recommended Setting |\n| :---------------------------------- | :------------------ |\n| Intel Hyper-Threading Technology    | Disabled            |\n| Number of Enable Cores              | ALL                 |\n| Execute Disable                     | Enabled             |\n| Intel VT                            | Enabled             |\n| Intel VT-D                          | Enabled             |\n| Intel VT-D coherency support        | Enabled             |\n| Intel VT-D ATS support              | Enabled             |\n| CPU Performance                     | High throughput     |\n| Hardware Perfetcher                 | Disabled            |\n| Adjacent Cache Line Prefetcher      | Disabled            |\n| DCU Streamer Prefetch               | Disable             |\n| Power Technology                    | Custom              |\n| Enhanced Intel Speedstep Technology | Disabled            |\n| Intel Turbo Boost Technology        | Enabled             |\n| Processor Power State C6            | Disabled            |\n| Processor Power State C1 Enhanced   | Disabled            |\n| Frequency Poor Override             | Enabled             |\n| P-State Coordination                | HW_ALL              |\n| Energy Performance                  | Performance         |\n\n以上建议来自 CSR 1000v 的安装指南。\n\n## （2）CentOS 7 的安装\n\n在安装的时候选择\n\n- Server with GUI\n- Virtualization Client\n- Virtualization Hypervisor\n- Virtualization Tools\n\n启动完毕以后关闭 selinux，重启生效。\n\n```shell\nsed -i 's/SELINUX=enforcing/SELINUX=disabled/g' /etc/selinux/config\n\ngetenforce\t\t//结果为：Enforcing（开启状态）disabled(关闭状态)\n```\n\n```shell\n# 安装完后，SSH登录可能显示中文，可修改 .bash_profile\n\nLANG=\"en_US.UTF-8\"\n\nexport LANG\n\nsource .bash_profile\n\negrep -o '(vmx|svm)' /proc/cpuinfo | sort | uniq\n\n# 注：在生产环境中，需要在服务器连接的交换机以及出口防火墙上做好安全策略。\n\nsystemctl stop firewalld\n\nsystemctl disable firewalld\n```\n\n本文档采用 NetworkManager 配置，故在此并不停用 NetworkManager。\n\n```shell\ncat /etc/sysctl.conf\n\nnet.ipv4.ip_forward = 1\n\nnet.bridge.bridge-nf-call-ip6tables = 0\n\nnet.bridge.bridge-nf-call-iptables = 0\n\nnet.bridge.bridge-nf-call-arptables = 0\n```\n\n检查 KVM 组件版本：\n\n```shell\n[root@centos7 ~]# libvirtd -V\n\nlibvirtd (libvirt) 4.5.0\n\n[root@centos7 ~]# /usr/libexec/qemu-kvm --version\n\nQEMU emulator version 1.5.3 (qemu-kvm-1.5.3-173.el7_8.3), Copyright (c) 2003-2008 Fabrice Bellard\n\n[root@centos7 ~]# virt-manager --version\n\n1.5.0\n\n[root@centos7 ~]# modinfo kvm-intel\n\nfilename:       /lib/modules/3.10.0-1127.18.2.el7.x86_64/kernel/arch/x86/kvm/kvm-intel.ko.xz\n\n[root@centos7 ~]# modinfo ixgbevf\n\nfilename:       /lib/modules/3.10.0-1127.18.2.el7.x86_64/kernel/drivers/net/ethernet/intel/ixgbevf/ixgbevf.ko.xz\n\nversion:        4.1.0-k-rh7.7\n```\n\n## （3）创建本地 Yum 源（可选）\n\n```shell\n# 1、备份本地/etc/yum.repos.d 目录下的yum源\n\ncd /etc/yum.repos.d/\n\nmkdir bak\n\nmv C* bak/\n\n# 2、上传CentOS-7-x86_64-Everything-2009.iso镜像到/opt\n\n# 3、挂载镜像\n\nmkdir -p /media/cdrom\n\nmount -t iso9660 -o loop /opt/CentOS-7-x86_64-Everything-2009.iso /media/cdrom/\n\nmount\t\t//查看挂载信息\n\ndf -h\n\nvi /etc/fstab\n\n/opt/CentOS-7-x86_64-Everything-2009.iso    /media/cdrom    iso9660 loop 0 0\n\ntail -1 /etc/fstab\t\t//查看是否写入/etc/fstab\n\n# 4、配置本地yum源\n\ncd /etc/yum.repos.d/\n\nvi local.repo\n\n[local]\n\nname=local\n\nbaseurl=file:///media/cdrom\t   //前面的file://是协议,后面的/media/cdrom是光盘挂载点\n\ngpgcheck=0\t\t//1使用公钥验证rpm包的正确性,0不验证\n\nenabled=1\t\t//1启用yum源,0禁用yum源\n\nyum install -y numactl telnet\n```\n\n运行 virt-manager 启动图形化界面。\n\n如果对 virsh CLI 命令熟悉，可以使用 virsh 命令创建虚拟机。\n\n## （4）服务器网卡配置—NetworkManager 配置\n\n在终端界面，可以通过 nmtui 打开图形化界面进行设置；以下使用 nmcli 进行设置。\n\n```shell\nnmcli connection add con-name eno1 type ethernet autoconnect yes ifname eno1\n\nnmcli connection modify eno1 ipv4.method manual ipv4.addresses 10.75.58.43/24 ipv4.gateway 10.75.58.1 ipv4.dns 64.104.123.245\n\nnmcli connection up eno1\n\nnmcli connection show eno1\n\nping 10.75.58.1\n```\n\n上述命令完成后，在/etc/sysconfig/network-scripts 中会生成网卡的 ifcfg 配置文件。\n\n```shell\ncat /etc/sysconfig/network-scripts/ifcfg-eno1\n\nHWADDR=70:7D:B9:59:5B:AE\n\nTYPE=Ethernet\n\nPROXY_METHOD=none\n\nBROWSER_ONLY=no\n\nBOOTPROTO=none\n\nIPADDR=10.75.58.43\n\nPREFIX=24\n\nGATEWAY=10.75.58.1\n\nDNS1=64.104.123.245\n\nDEFROUTE=yes\n\nIPV4_FAILURE_FATAL=no\n\nIPV6INIT=yes\n\nIPV6_AUTOCONF=yes\n\nIPV6_DEFROUTE=yes\n\nIPV6_FAILURE_FATAL=no\n\nIPV6_ADDR_GEN_MODE=stable-privacy\n\nNAME=eno1\n\nUUID=2a1c8b39-7f44-321b-a65f-a93e70ab0616\n\nONBOOT=yes\n\nAUTOCONNECT_PRIORITY=-999\n\nDEVICE=eno1\n```\n\n此时，可以将 network.service 停止和关闭。\n\n```shell\nsystemctl stop network\n\nsystemctl disable network\n```\n\n注意，如果 NetworkManager 未设置妥当，执行 systemctl stop network 后，会导致服务器无法管理。\n\n准备开启 SRIOV 的网卡设置，以 eno2 为例：\n\n```bash\nnmcli connection add con-name eno2 type ethernet autoconnect yes ifname eno2\n\nnmcli connection modify eno2 ethernet.mtu 9216 ipv4.method disabled\n\nnmcli connection up eno2\n\nnmcli connection show eno2\n\nip link show dev eno2\n```\n\n注：上述 MTU 值设置为 9216 是借鉴自 Cisco NFVIS 平台，如下：\n\n```ios\nCSP5228-1# show pnic-detail mtu\n\nName          MTU\n\n=============================\n\neth0-1        9216\n\neth0-2        9216\n\neth1-1        9216\n\neth1-2        9216\n```\n\n## （5）配置 Linux 网桥 （可选）\n\n网桥 br1 配置示例：\n\n```bash\nnmcli connection add con-name br1 type bridge autoconnect yes ipv4.method disabled ethernet.mtu 9216 ifname br1\n\nnmcli connection up br1\n\nip link show dev br1\n```\n\n网桥 br1 的物理网卡配置\n\n```bash\nnmcli connection add con-name eno5 type ethernet autoconnect yes ifname eno5\n\nnmcli connection modify eno5 ethernet.mtu 9216 ipv4.method disabled master br1\n\nnmcli connection up eno5\n\nip link show dev eno5\n```\n\n创建 net-br1 网络\n\n[root@centos7 ~]# cat net-br1.xml\n\n```xml\n<network>\n\n <name>net-br1</name>\n\n <forward mode=\"bridge\"/>\n\n <bridge name=\"br1\"/>\n\n</network>\n```\n\n```bash\n[root@centos7 ~]# virsh net-define net-br1.xml\n\nNetwork net-br1 defined from net-br1.xml\n\n[root@centos7 ~]# virsh net-start net-br1\n\nNetwork net-br1 started\n\n[root@centos7 ~]# virsh net-autostart net-br1\n\nNetwork net-br1 marked as autostarted\n```\n\n# 配置 SR-IOV\n\n## （1）检查网卡对 SR-IOV 的支持，并配置网卡\n\n可使用 lshw 和 lspci 检查网卡对 SR-IOV 的支持\n\nlshw -c network -businfo\n\n```shell\nBus info          Device      Class          Description\n\n========================================================\n\npci@0000:1d:00.0  eno5        network        VIC Ethernet NIC\n\npci@0000:1d:00.1  eno6        network        VIC Ethernet NIC\n\npci@0000:1d:00.2  eno7        network        VIC Ethernet NIC\n\npci@0000:1d:00.3  eno8        network        VIC Ethernet NIC\n\npci@0000:3b:00.0  eno1        network        Ethernet Controller 10G X550T\n\npci@0000:3b:00.1  eno2        network        Ethernet Controller 10G X550T\n```\n\nlspci -vv -s 3b:00.1 | grep -A 5 -i SR-IOV\n\n```bash\nCapabilities: [160 v1] Single Root I/O Virtualization (SR-IOV)\n\n  IOVCap:\tMigration-, Interrupt Message Number: 000\n\n\tIOVCtl:\tEnable+ Migration- Interrupt- MSE+ ARIHierarchy-\n\n\tIOVSta:\tMigration-\n\n\tInitial VFs: 64, Total VFs: 64, Number of VFs: 8, Function Dependency Link: 01\n\n\tVF offset: 128, stride: 2, Device ID: 1565\n```\n\n## （2）设置启动参数\n\n```shell\nvi /etc/default/grub\n\nGRUB_CMDLINE_LINUX=\"crashkernel=auto spectre_v2=retpoline rd.lvm.lv=centos/root rd.lvm.lv=centos/swap rhgb quiet hugepagesz=1G hugepages=32 default_hugepagesz=1G intel_iommu=on iommu=pt isolcpus=1-8,37-44\"\n\n注：页面数字不要过大，不然启动失败，如果后续不够，可以在运行时添加。\n\ngrub2-mkconfig -o /boot/grub2/grub.cfg\n\ngrub2-mkconfig -o /boot/efi/EFI/centos/grub.cfg\n\niommu=pt 参数是将SRIOV设备支持PCI Passthrough\n```\n\n重启后验证\n\n```shell\ncat /proc/cmdline |grep intel_iommu=on\n\ndmesg |grep -e DMAR -e IOMMU\n\ndmesg | grep -e DMAR -e IOMMU -e AMD-Vi\n```\n\n- **default_hugepagesz=1G hugepagesz=1G hugepages=32** 参数设置主机在启动时分配 32 个 1GB 的内存大页，这些是静态内存大页。 CSR 1000v 虚拟机将试用这些静态大页以获得最优性能。\n- **isolcpus=1-8,37-44** 参数设置的作用是隔离 1-8，37-44 的 CPU 核，使其独立于内核的平衡调度算法，也就是内核本身不会将进程分配到被隔离的 CPU。之后我们可将指定的进程 CSR 1000v 虚拟机绑定到被隔离的 CPU 上运行，让进程独占 CPU，使其实时性可得到一定程度的提高。\n\n可参考 这个章节获取主机 CPU 核的相关信息。\n\n```shell\nroot@centos7 ~]# cat /proc/cmdline |grep intel_iommu=on\n\nBOOT_IMAGE=/vmlinuz-3.10.0-1127.el7.x86_64 root=/dev/mapper/centos-root ro crashkernel=auto spectre_v2=retpoline rd.lvm.lv=centos/root rd.lvm.lv=centos/swap rhgb quiet hugepagesz=1G hugepages=32 default_hugepagesz=1G intel_iommu=on iommu=pt LANG=en_US.UTF-8\n\n[root@centos7 ~]# dmesg |grep -e DMAR -e IOMMU\n\n[    0.000000] ACPI: DMAR 000000005d6f5d70 00250 (v01 Cisco0 CiscoUCS 00000001 INTL 20091013)\n\n[    0.000000] DMAR: IOMMU enabled\n```\n\n查看隔离的 CPU 核以及所有的 CPU 核。\n\n```bash\n[root@centos7 ~]# cat /sys/devices/system/cpu/isolated\n\n1-8,37-44\n\n[root@centos7 ~]# cat /sys/devices/system/cpu/present\n\n0-71\n```\n\n## （3）通过 nmcli 持久化 VFs 配置\n\nnmcli 可以设置网卡的 sriov 参数，如下：\n\n```bash\nnmcli connection modify eno2 sriov.total-vfs 4\n```\n\n还可以设置每一个 VF 设备的 MAC 地址，便于管理：\n\n```bash\nnmcli connection modify eno2 sriov.vfs '0 mac=8E:DF:08:C1:D1:DE trust=true, 1 mac=5A:B9:2F:99:A6:CE trust=true, 2 mac=46:78:69:E3:71:3D trust=true, 3 mac=7E:A7:DB:3B:1B:B3 trust=true'\n```\n\n执行上述命令后：\n\ncat /etc/sysconfig/network-scripts/ifcfg-eno2\n\n```bash\nTYPE=Ethernet\n\nNAME=eno2\n\nUUID=64ffa204-0158-40c8-ba86-2b7aebf27619\n\nDEVICE=eno2\n\nONBOOT=yes\n\nMTU=9216\n\nHWADDR=70:7D:B9:59:5B:AF\n\nPROXY_METHOD=none\n\nBROWSER_ONLY=no\n\nIPV6INIT=no\n\nSRIOV_TOTAL_VFS=4\n\nSRIOV_VF0=\"mac=8E:DF:08:C1:D1:DE trust=true\"\n\nSRIOV_VF1=\"mac=5A:B9:2F:99:A6:CE trust=true\"\n\nSRIOV_VF2=\"mac=46:78:69:E3:71:3D trust=true\"\n\nSRIOV_VF3=\"mac=7E:A7:DB:3B:1B:B3 trust=true\"\n```\n\n重启后，检查 dmesg：\n\ndmesg | grep -i vf | grep -i eno2\n\n```bash\n[   11.953333] ixgbe 0000:3b:00.1 eno2: SR-IOV enabled with 4 VFs\n\n[   12.541801] ixgbe 0000:3b:00.1: setting MAC 8e:df:08:c1:d1:de on VF 0\n\n[   12.541805] ixgbe 0000:3b:00.1: Reload the VF driver to make this change effective.\n\n[   12.541841] ixgbe 0000:3b:00.1 eno2: VF 0 is trusted\n\n[   12.541846] ixgbe 0000:3b:00.1: setting MAC 5a:b9:2f:99:a6:ce on VF 1\n\n[   12.541850] ixgbe 0000:3b:00.1: Reload the VF driver to make this change effective.\n\n[   12.541883] ixgbe 0000:3b:00.1 eno2: VF 1 is trusted\n\n[   12.541887] ixgbe 0000:3b:00.1: setting MAC 46:78:69:e3:71:3d on VF 2\n\n[   12.541891] ixgbe 0000:3b:00.1: Reload the VF driver to make this change effective.\n\n[   12.541923] ixgbe 0000:3b:00.1 eno2: VF 2 is trusted\n\n[   12.541928] ixgbe 0000:3b:00.1: setting MAC 7e:a7:db:3b:1b:b3 on VF 3\n\n[   12.541932] ixgbe 0000:3b:00.1: Reload the VF driver to make this change effective.\n\n[   12.541965] ixgbe 0000:3b:00.1 eno2: VF 3 is trusted\n```\n\n## （4）检查 VF\n\n可通过 lspci 和 ip link 检查 VF，如下：\n\n```bash\n[root@centos7 ~]# lspci | grep -i Virtual\n\n[root@centos7 ~]# ip link show | grep -B2 vf\n```\n\n寻找 Physical Function 和 Virtual Function 之间的对应关系：\n\n```bash\n[root@centos7 ~]# ls -l /sys/class/net/eno1/device/ | grep virtfn\n```\n\nVF 被创建后，NetworkManager 自动给新的设备创建 Connection，可以修改名称，如下：\n\nnmcli connection\n\n```bash\nNAME        UUID                                  TYPE      DEVICE\n\neno1        2a1c8b39-7f44-321b-a65f-a93e70ab0616  ethernet  eno1\n\neno2        64ffa204-0158-40c8-ba86-2b7aebf27619  ethernet  eno2\n\nenp59s16f1  19c28a93-aa36-38e6-a556-55a922a0a332  ethernet  enp59s16f1\n\nenp59s16f3  428d9707-1515-3475-b356-7eb229c3f937  ethernet  enp59s16f3\n\nenp59s16f5  21a8dd5f-239f-37b2-9b09-24ce0e7413bc  ethernet  enp59s16f5\n\nenp59s16f7  0ca0da65-64c4-314d-89a4-4213f9e4f478  ethernet  enp59s16f7\n```\n\n修改名称：\n\n```bash\nnmcli connection modify uuid 19c28a93-aa36-38e6-a556-55a922a0a332 connection.id enp59s16f1\n```\n\n修改 MTU 值，并禁用 IPv4 和 IPv6，网卡启动更快\n\n```bash\nnmcli connection modify enp59s16f1 ifname enp59s16f1 ipv4.method disabled ipv6.method ignore ethernet.mtu 9216 ethernet.mac-address \"\"\n\nnmcli connection up enp59s16f1\n\nnmcli connection show enp59s16f1\n```\n\n上述命令生成的 ifcfg 配置文件如下：\n\n[root@centos7 ~]# cat /etc/sysconfig/network-scripts/ifcfg-enp59s16f1\n\n```bash\nTYPE=Ethernet\n\nPROXY_METHOD=none\n\nBROWSER_ONLY=no\n\nDEFROUTE=yes\n\nIPV4_FAILURE_FATAL=no\n\nIPV6INIT=no\n\nIPV6_AUTOCONF=no\n\nIPV6_DEFROUTE=yes\n\nIPV6_FAILURE_FATAL=no\n\nIPV6_ADDR_GEN_MODE=stable-privacy\n\nNAME=enp59s16f1\n\nUUID=19c28a93-aa36-38e6-a556-55a922a0a332\n\nONBOOT=yes\n\nAUTOCONNECT_PRIORITY=-999\n\nDEVICE=enp59s16f1\n\nMTU=9216\n```\n\n这样，即便系统重启，上述配置依然能生效。\n\n# 使用 KVM 的虚拟网络适配器池\n\n主机上创建一个 VF 网络设备的资源池，资源池内的设备可以自动地分配给虚拟机使用。\n\n## （1）创建一个 xml 文件。\n\n[root@centos7 ~]# cat eno2_sriov_pool.xml\n\n```xml\n<network>\n\n  <name>eno2_sriov_pool</name> <!-- This is the name of the file you created -->\n\n  <forward mode='hostdev' managed='yes'>\n\n   <pf dev='eno2'/> <!-- Use the netdev name of your SR-IOV devices PF here -->\n\n  </forward>\n\n</network>\n```\n\n## （2）根据 xml 定义一个网络，并设置为自动重启\n\n```bash\nvirsh net-define eno2_sriov_pool.xml\n\nvirsh net-start eno2_sriov_pool\n\nvirsh net-autostart eno2_sriov_pool\n```\n\n[root@centos7 ~]# virsh net-dumpxml eno2_sriov_pool\n\n```xml\n<network connections='1'>\n\n <name>eno2_sriov_pool</name>\n\n <uuid>e0842451-0137-4255-8783-305ca27f082d</uuid>\n\n <forward mode='hostdev' managed='yes'>\n\n  <pf dev='eno2'/>\n\n  <address type='pci' domain='0x0000' bus='0x3b' slot='0x10' function='0x1'/>\n\n  <address type='pci' domain='0x0000' bus='0x3b' slot='0x10' function='0x3'/>\n\n  <address type='pci' domain='0x0000' bus='0x3b' slot='0x10' function='0x5'/>\n\n  <address type='pci' domain='0x0000' bus='0x3b' slot='0x10' function='0x7'/>\n\n </forward>\n\n</network>\n```\n\n## （3）从网络适配器池中分配网卡给虚拟机\n\n用这种方法添加 SRIOV 网卡比较简单：\n\n![SRIOV Adapter Pool](csr1kv-kvm-CentOS7/sriov-pool-001.png)\n\n按照如上方法添加网卡，等同于以下 xml 配置：\n\n```xml\n  <interface type='network'>\n\n   <mac address='52:54:00:2d:87:99'/>\n\n   <source network='eno2_sriov_pool'/>\n\n   <model type='virtio'/>\n\n   <address type='pci' domain='0x0000' bus='0x00' slot='0x04' function='0x0'/>\n\n  </interface>\n```\n\n开机后 dumpxml 如下：\n\n```xml\n  <interface type='hostdev' managed='yes'>\n\n   <mac address='52:54:00:2d:87:99'/>\n\n   <driver name='vfio'/>\n\n   <source>\n\n    <address type='pci' domain='0x0000' bus='0x3b' slot='0x10' function='0x1'/>\n\n   </source>\n\n   <model type='virtio'/>\n\n   <alias name='hostdev0'/>\n\n   <address type='pci' domain='0x0000' bus='0x00' slot='0x0f' function='0x0'/>\n\n</interface>\n```\n\n# 使用 Virt-manager 安装 CSR1000v\n\n在 CentOS 图形界面中，打开 Terminal，运行 virt-manager，按照以下步骤创建 CSR1000v；添加网卡，并选择 en2_sriov_pool。\n\n![Step 1](csr1kv-kvm-CentOS7/virt-manager-1.png)\n\n![选择镜像](csr1kv-kvm-CentOS7/virt-manager-2.png)\n\n![Step 2](csr1kv-kvm-CentOS7/virt-manager-3.png)\n\n![Step 3](csr1kv-kvm-CentOS7/virt-manager-3.png)\n\n![Step 4](csr1kv-kvm-CentOS7/virt-manager-5.png)\n\n注：csr1kv-1 的第一个网口选择**macvtap Bridge**模式，这样就无需创建一个 Linux 网桥。但是，csr1kv-1 启动以后不能通过该接口与 Linux 主机进行通信，仅能通过该接口访问 Linux 主机外的网络。\n\n![Step 5](csr1kv-kvm-CentOS7/virt-manager-6.png)\n\n![Step 6](csr1kv-kvm-CentOS7/virt-manager-7.png)\n\n添加完网卡后，点击开始安装，然后就可以关闭虚拟机了。上述操作完成后，virt-manager 会在**/etc/libvirtd/qemu/**目录下创建**csr1kv-1.xml**。\n\n# KVM 调优配置\n\nKVM 的调优比较复杂，主要是 NUMA、内存大页、vCPU PIN 等，参考资料为 Redhat Linux 7 PERFORMANCE TUNING GUIDE。\n\n## （1）检查平台的能力\n\n```bash\n[root@centos7 ~]# virsh nodeinfo\n\nCPU model:           x86_64\n\nCPU(s):              72\n\nCPU frequency:       999 MHz\n\nCPU socket(s):       1\n\nCore(s) per socket:  18\n\nThread(s) per core:  2\n\nNUMA cell(s):        2\n\nMemory size:         263665612 KiB\n```\n\n```bash\n[root@centos7 ~]# virsh capabilities\n\n<capabilities>\n\n <host>\n\n  <uuid>4e53df1f-5b36-6842-99ee-1369d7c68730</uuid>\n\n  <cpu>\n\n   <arch>x86_64</arch>\n\n   <model>Skylake-Server-IBRS</model>\n\n   <vendor>Intel</vendor>\n\n   <microcode version='33581318'/>\n\n   <counter name='tsc' frequency='2294597000' scaling='yes'/>\n\n   <topology sockets='1' cores='18' threads='2'/>\n\n……\n```\n\n可检查平台的 CPU 核数、分布，内存的 NUMA 分布等。\n\n## （2）NUMA 调优\n\n```bash\n[root@centos7 ~]# numactl --hardware\n\navailable: 2 nodes (0-1)\n\nnode 0 cpus: 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53\n\nnode 0 size: 128491 MB\n\nnode 0 free: 112157 MB\n\nnode 1 cpus: 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71\n\nnode 1 size: 128994 MB\n\nnode 1 free: 124120 MB\n\nnode distances:\n\nnode  0  1\n\n 0: 10 21\n\n 1: 21 10\n```\n\n两颗 CPU，每颗 CPU 各有 128GB 内存，分别是 node 0 和 node 1。\n\n## （3）内存大页 HugePage 以及透明大页\n\n` `cat /proc/meminfo | grep HugePages 查看当前系统有多少个大页：\n\n```bash\n[root@centos7 ~]# cat /proc/meminfo | grep Huge\n\nAnonHugePages:   1685504 kB\n\nHugePages_Total:      64\n\nHugePages_Free:       60\n\nHugePages_Rsvd:        0\n\nHugePages_Surp:        0\n\nHugepagesize:    1048576 kB\n```\n\n在系统运行时修改大页数量：\n\n```bash\n[root@centos7 ~]# cat /sys/devices/system/node/node0/hugepages/hugepages-1048576kB/nr_hugepages\n\n16\n\n[root@centos7 ~]# echo 32 > /sys/devices/system/node/node0/hugepages/hugepages-1048576kB/nr_hugepages\n\n[root@centos7 ~]# echo 32 > /sys/devices/system/node/node1/hugepages/hugepages-1048576kB/nr_hugepages\n\n[root@centos7 ~]#\n\n[root@centos7 ~]# numastat -cm | egrep 'Node|Huge'\n\n`                 `Node 0 Node 1  Total\n\nAnonHugePages     10962   1528  12490\n\nHugePages_Total   32768  32768  65536\n\nHugePages_Free    32768  32768  65536\n\nHugePages_Surp        0      0      0\n```\n\n检查透明大页参数，在 CentOS7 上缺省开启；开启了透明大页，不影响静态大页的使用。\n\n```bash\ncat /sys/kernel/mm/transparent_hugepage/enabled\n\n[always] madvise never\n```\n\n## （4）vCPU 钉选\n\n设置 CPU Affinity 的好处是提高 CPU 缓存效率，避免进程在多个 CPU 核之间跳跃，切换 CPU 核均会导致缓存中的数据无效，缓存命中率大幅降低，导致数据获取的开销居高不下，损失性能。\n\n**virsh vcpuinfo csr1kv-1** 可以查看 vCPU 的分配。\n\n## （5）编辑 CSR 1000v 的 XML 调优参数\n\nvirsh edit csr1kv-1 可以编辑 XML 的参数，如下：\n\n```xml\n  <memoryBacking>\n    <hugepages>\n      <page size='1048576' unit='KiB'/>\n    </hugepages>\n    <locked/>\n    <nosharepages/>\n  </memoryBacking>\n  <vcpu placement='static'>8</vcpu>\n  <cputune>\n    <vcpupin vcpu='0' cpuset='1'/>\n    <vcpupin vcpu='1' cpuset='2'/>\n    <vcpupin vcpu='2' cpuset='3'/>\n    <vcpupin vcpu='3' cpuset='4'/>\n    <vcpupin vcpu='4' cpuset='5'/>\n    <vcpupin vcpu='5' cpuset='6'/>\n    <vcpupin vcpu='6' cpuset='7'/>\n    <vcpupin vcpu='7' cpuset='8'/>\n    <emulatorpin cpuset='45-52'/> <!-- If Hyper-threading were enabled -->\n  </cputune>\n  <numatune>\n    <memory mode='strict' nodeset='0'/>\n  </numatune>\n  <cpu mode='host-passthrough' check='none'/>\n    <memballoon model='none'/>\n```\n\n注：**<emulatorpin cpuset='37-44'/>** 参数，仅当 Hyper-Threating 开启时使用；有一些平台并未关闭超线程，例如 Cisco 专门的 NFV 平台 CSP。通过 virsh chapabilities 查看 siblings='1,37'，当 core 1 设置为 vcpupin 时，core 37 应设置到 emulatorpin cpuset 中。\n\n以下关于 CPU 和内存的参数设定建议来自于<https://libvirt.org/formatdomain.html> 和 <https://libvirt.org/kbase/kvm-realtime.html>\n\n```xml\n<domain type='kvm'>\n  <name>csr1kv-1</name>\n  <uuid>59581018-6387-49df-ab09-2bcf40fc12ba</uuid>\n  <memory unit='KiB'>8388608</memory>\n  <currentMemory unit='KiB'>8388608</currentMemory>\n  <memoryBacking>\n    <hugepages>\n      <page size='1048576' unit='KiB'/>\n</hugepages>\n<locked/>\n    <nosharepages/>\n  </memoryBacking>\n  <vcpu placement='static'>8</vcpu>\n  <cputune>\n    <vcpupin vcpu='0' cpuset='1'/>\n    <vcpupin vcpu='1' cpuset='2'/>\n    <vcpupin vcpu='2' cpuset='3'/>\n    <vcpupin vcpu='3' cpuset='4'/>\n    <vcpupin vcpu='4' cpuset='5'/>\n    <vcpupin vcpu='5' cpuset='6'/>\n    <vcpupin vcpu='6' cpuset='7'/>\n    <vcpupin vcpu='7' cpuset='8'/>\n    <emulatorpin cpuset='37-44'/>\n  </cputune>\n  <numatune>\n    <memory mode='strict' nodeset='0'/>\n  </numatune>\n  <os>\n    <type arch='x86_64' machine='pc-i440fx-rhel7.0.0'>hvm</type>\n    <boot dev='hd'/>\n  </os>\n  <features>\n    <acpi/>\n    <apic/>\n  </features>\n  <cpu mode='host-passthrough' check='none'/>\n  <clock offset='utc'>\n    <timer name='rtc' tickpolicy='catchup'/>\n    <timer name='pit' tickpolicy='delay'/>\n    <timer name='hpet' present='no'/>\n  </clock>\n  <on_poweroff>destroy</on_poweroff>\n  <on_reboot>restart</on_reboot>\n  <on_crash>destroy</on_crash>\n  <pm>\n    <suspend-to-mem enabled='no'/>\n    <suspend-to-disk enabled='no'/>\n  </pm>\n  <devices>\n    <emulator>/usr/libexec/qemu-kvm</emulator>\n    <disk type='file' device='disk'>\n      <driver name='qemu' type='qcow2'/>\n      <source file='/home/root/images/csr1000v-universalk9.17.02.01v.qcow2'/>\n      <target dev='vda' bus='virtio'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x07' function='0x0'/>\n    </disk>\n    <controller type='usb' index='0' model='ich9-ehci1'>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x05' function='0x7'/>\n    </controller>\n    <controller type='usb' index='0' model='ich9-uhci1'>\n      <master startport='0'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x05' function='0x0' multifunction='on'/>\n    </controller>\n    <controller type='usb' index='0' model='ich9-uhci2'>\n      <master startport='2'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x05' function='0x1'/>\n    </controller>\n    <controller type='usb' index='0' model='ich9-uhci3'>\n      <master startport='4'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x05' function='0x2'/>\n    </controller>\n    <controller type='pci' index='0' model='pci-root'/>\n    <controller type='virtio-serial' index='0'>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x06' function='0x0'/>\n    </controller>\n    <interface type='direct'>\n      <mac address='52:54:00:36:95:f0'/>\n      <source dev='eno1' mode='bridge'/>\n      <model type='virtio'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x03' function='0x0'/>\n    </interface>\n    <interface type='network'>\n      <mac address='52:54:00:2d:87:99'/>\n      <source network='eno2_sriov_pool'/>\n      <model type='virtio'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x04' function='0x0'/>\n    </interface>\n    <serial type='pty'>\n      <target type='isa-serial' port='0'>\n        <model name='isa-serial'/>\n      </target>\n    </serial>\n    <console type='pty'>\n      <target type='serial' port='0'/>\n    </console>\n    <channel type='unix'>\n      <target type='virtio' name='org.qemu.guest_agent.0'/>\n      <address type='virtio-serial' controller='0' bus='0' port='1'/>\n    </channel>\n    <channel type='spicevmc'>\n      <target type='virtio' name='com.redhat.spice.0'/>\n      <address type='virtio-serial' controller='0' bus='0' port='2'/>\n    </channel>\n    <input type='tablet' bus='usb'>\n      <address type='usb' bus='0' port='1'/>\n    </input>\n    <input type='mouse' bus='ps2'/>\n    <input type='keyboard' bus='ps2'/>\n    <graphics type='spice' autoport='yes'>\n      <listen type='address'/>\n      <image compression='off'/>\n    </graphics>\n    <video>\n      <model type='qxl' ram='65536' vram='65536' vgamem='16384' heads='1' primary='yes'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x02' function='0x0'/>\n    </video>\n    <redirdev bus='usb' type='spicevmc'>\n      <address type='usb' bus='0' port='2'/>\n    </redirdev>\n    <redirdev bus='usb' type='spicevmc'>\n      <address type='usb' bus='0' port='3'/>\n    </redirdev>\n    <memballoon model='none'/>\n    <rng model='virtio'>\n      <backend model='random'>/dev/urandom</backend>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x09' function='0x0'/>\n    </rng>\n  </devices>\n</domain>\n```\n\n上述参数整理自[《Cisco CSR 1000v and Cisco ISRv Software Configuration Guide》](https://www.cisco.com/c/en/us/td/docs/routers/csr1000/software/configuration/b_CSR1000v_Configuration_Guide/b_CSR1000v_Configuration_Guide_chapter_0101.html)\n\n完成上述 XML 文件的编辑后，执行\n\n```bash\ncd /etc/libvirtd/qemu\n\nvirsh define csr1kv-1.xml\n\nvirsh start csr1kv-1\n```\n\n## （6）在 KVM 主机上访问 CSR1000v 的 Console\n\n在 virt-manager 创建 CSR1000v 虚拟机的时候，缺省会添加一个 Serial Device。\n\n```bash\n[root@centos7 qemu]# virsh console 20\n\nConnected to domain CSR1000v-1\n\nEscape character is ^]\n```\n\nCSR 1000v 暂时不能通过 Console 配置，需要通过 virt-manager 的图形化界面进行初始化配置。\n\nvCloud 的 Console 访问正常。\n\n## （7）检验 CSR1000v 的调优配置\n\n```xml\n[root@centos7 ~]# virsh list\n\nId  Name              State\n\n----------------------------------------------------\n\n 6   csr1kv-1            running\n\n\n\n[root@centos7 ~]# virsh vcpuinfo 6\n\nVCPU:      0\n\nCPU:      1\n\nState:     running\n\nCPU time:    34.5s\n\nCPU Affinity:  -y----------------------------------------------------------------------\n\n\n\nVCPU:      1\n\nCPU:      2\n\nState:     running\n\nCPU time:    32.0s\n\nCPU Affinity:  --y---------------------------------------------------------------------\n\n\n\nVCPU:      2\n\nCPU:      3\n\nState:     running\n\nCPU time:    23.8s\n\nCPU Affinity:  ---y--------------------------------------------------------------------\n\n\n\nVCPU:      3\n\nCPU:      4\n\nState:     running\n\nCPU time:    19.8s\n\nCPU Affinity:  ----y-------------------------------------------------------------------\n\n\n\nVCPU:      4\n\nCPU:      5\n\nState:     running\n\nCPU time:    23.0s\n\nCPU Affinity:  -----y------------------------------------------------------------------\n\n\n\nVCPU:      5\n\nCPU:      6\n\nState:     running\n\nCPU time:    23.4s\n\nCPU Affinity:  ------y-----------------------------------------------------------------\n\n\n\nVCPU:      6\n\nCPU:      7\n\nState:     running\n\nCPU time:    28.5s\n\nCPU Affinity:  -------y----------------------------------------------------------------\n\n\n\nVCPU:      7\n\nCPU:      8\n\nState:     running\n\nCPU time:    28.2s\n\nCPU Affinity:  --------y---------------------------------------------------------------\n```\n\n以上显示 CSR1000v 虚拟机的 CPU 亲和性在 1-8 核上。\n\n```bash\n[root@centos7 ~]# numastat -c qemu-kvm\n\nPer-node process memory usage (in MBs) for PID 46895 (qemu-kvm)\n\n     Node 0 Node 1 Total\n\n     ------ ------ -----\n\nHuge    8192   0 8192\n\nHeap    118   0  118\n\nStack     0   0   0\n\nPrivate   144   7  151\n\n------- ------ ------ -----\n\nTotal   8455   7 8461\n\n\n```\n\n以上显示，内存主要使用 Node 0。\n\n```bash\n[root@centos7 ~]# numastat -vm -p 13428 | grep HugePage\n\nAnonHugePages       956.00     494.00     1450.00\n\nHugePages_Total     16384.00    16384.00    32768.00\n\nHugePages_Free      8192.00    16384.00    24576.00\n\nHugePages_Surp       0.00       0.00      0.00\n```\n\n## （8）在 CSR1KV 上检查虚拟网卡\n\n```ios\ncsr1kv-1#show platform software vnic-if interface-mapping\n\n-------------------------------------------------------------\n\n Interface Name    Driver Name     Mac Addr\n\n-------------------------------------------------------------\n\n GigabitEthernet2    net_ixgbe_vf    5254.002d.8799\n\n GigabitEthernet1    net_virtio     5254.0036.95f0\n```\n\n上述驱动名显示为 net_ixgbe_vf 表明该虚拟网卡是一个 SR-IOV 池中分配的 VF 设备。\n\n# Linux 上抓取虚拟网卡的报文（参考）\n\n查找虚拟机的网卡列表\n\n```bash\n[root@centos7 ~]# virsh domiflist 10\n\nInterface Type    Source   Model    MAC\n\n-------------------------------------------------------\n\nvnet0   network  default  virtio   52:54:00:38:71:4a\n\nmacvtap0  direct   eno1    virtio   52:54:00:b2:70:90\n\nvnet5   bridge   net-br1  virtio   52:54:00:69:93:23\n```\n\n抓取 vnet5 的报文\n\n```bash\n[root@centos7 ~]# tcpdump -i vnet5 -w ping.pcap\n\ntcpdump: listening on vnet5, link-type EN10MB (Ethernet), capture size 262144 bytes\n\n^C49 packets captured\n\n51 packets received by filter\n\n0 packets dropped by kernel\n```\n\n注：VF 如果被分配给虚拟机，那么在 Linux 主机里，通过 ip link 则查看不到该设备，无法通过上述办法抓包。\n\n# CSR 1000v 的初始化配置及 Smart License 注册\n\n## （1）CSR 1000v 初始化配置示例\n\n部分节略，其他为缺省配置。\n\n```ios\nCSR1000v-1#show sdwan running-config\n\nsystem\n\n system-ip       1.1.10.1\n\n site-id        101\n\n sp-organization-name CiscoBJ\n\n organization-name   CiscoBJ\n\n vbond 10.75.58.51 port 12346\n\n!\n\nhostname CSR1000v-1\n\nusername admin privilege 15 secret 9 $9$4/QL2V2K4/6H1k$XUmRNf.T7t3KDOj/FmoNexpEypCxr482dExXHDnohSI\n\nip name-server 64.104.123.245\n\nip route 0.0.0.0 0.0.0.0 10.75.59.1\n\n\n\ninterface GigabitEthernet1\n\n no shutdown\n\n arp timeout 1200\n\n ip address 10.75.59.35 255.255.255.0\n\n no ip redirects\n\n ip mtu  1500\n\n mtu 1500\n\n negotiation auto\n\nexit\n\n\n\ninterface Tunnel1\n\n no shutdown\n\n ip unnumbered GigabitEthernet1\n\n no ip redirects\n\n ipv6 unnumbered GigabitEthernet1\n\n no ipv6 redirects\n\n tunnel source GigabitEthernet1\n\n tunnel mode sdwan\n\nexit\n\n\n\nclock timezone CST 8 0\n\nntp server 10.75.58.1 version 4\n\nsdwan\n\n interface GigabitEthernet1\n\n tunnel-interface\n\n  encapsulation ipsec\n\n  allow-service sshd\n\n exit\n```\n\n## （2）常用命令\n\n- show sdwan control local-properties\n- show sdwan control connections\n- show sdwan control connection-history\n- show sdwan running-config\n- show sdwan bfd sessions\n- show sdwan omp peers\n- show sdwan omp routes\n\n## （3）CSR 1000v Smart License 注册\n\nCSR 1000v 默认限速为 250Mbps，需要注册 Smart License 才可解开限速。\n\n```ios\nCSR1000v-2#show platform hardware throughput level\n\nThe current throughput level is 250000 kb/s\n```\n\n注册 Smart License 需要满足以下条件：\n\n1、 CSR 1000v 已经注册到 vManage，控制面连接正常；\n\n2、 配置 ip http client source-interface GigabitEthernet2\n\n3、 sdwan interface GigabitEthernet2 tunnel-interface allow-service all ---针对 16.12.x 版本；在新版本中仅需要 allow https\n\n4、 CSR 1000v 可以访问 URL：<https://tools.cisco.com/its/service/oddce/services/DDCEService>\n\n允许访问 114.114.114.114，CSR 1000v 可解析域名 tools.cisco.com\n\n替代办法，增加一条命令 ip host tools.cisco.com 72.163.4.38\n\n执行 license smart register idtoken xxxxxx 进行注册\n\nshow license status 查看注册结果\n\n注册完成后，系统解开限速：\n\n```ios\nCSR1000v-1#show platform hardware throughput level\n\nThe current throughput level is 200000000 kb/s\n```\n\n# 性能和相关限制\n\n## （1）SRIOV 的性能\n\n在上述 CSR1KV-1 安装好后，使用测试仪进行性能测试，测试条件中，设置丢包率为 0%，其性能如下：\n\n| Packet Site | SDWAN Performance (Mbps) | CEF Performance (Mbps) |\n| :---------- | :----------------------: | :--------------------: |\n| 128Byte     |           800            |        2843.75         |\n| 256Byte     |         1431.26          |        6500.00         |\n| 512Byte     |         2581.26          |        10578.13        |\n| 1024Byte    |         3731.26          |        15500.00        |\n| 1400Byte    |         4306.26          |        18171.88        |\n\n![性能现状图表](csr1kv-kvm-CentOS7/line-chart-009.png)\n\n注：上述测试结果非官方结果，不同服务器和网卡可能测试结果有区别，上述性能数据仅供参考。\n\n## （2）SRIOV 的限制\n\nSRIOV 的主要限制是每一个 VF 设备支持的 VLAN 数，ixgbevf 所支持的最大 VLAN 数为 64；因此，在 CSR1KV 中对应的虚拟接口配置的活跃子接口数最大为 64。\n\n配置指南中有关于 SRIOV 子接口限制的说明：\n\n` `[Cisco CSR 1000v and Cisco ISRv Software Configuration Guide](https://www.cisco.com/c/en/us/td/docs/routers/csr1000/software/configuration/b_CSR1000v_Configuration_Guide/b_CSR1000v_Configuration_Guide_chapter_0101.html):\n\n> SR-IOV (ixgbevf)\n>\n> Maximum VLANs: The maximum number of VLANs supported on PF is 64. Together, all VFs can have a total of 64 VLANs. (Intel limitation.)\n>\n> SR-IOV (i40evf)\n>\n> Maximum VLANs: The maximum number of VLANs supported on PF is 512. Together, all VFs can have a total of 512 VLANs. (Intel limitation.) Per-VF resources are managed by the PF (host) device driver.\n\n# 附录\n\n## （1）Virt-manager 设置虚机的 CPU 模式说明\n\nLibvirt 主要支持三种 CPU mode：\n\n- host-passthrough: libvirt 令 KVM 把宿主机的 CPU 指令集全部透传给虚拟机。因此虚拟机能够最大限度的使用宿主机 CPU 指令集，故性能是最好的。但是在热迁移时，它要求目的节点的 CPU 和源节点的一致。\n- host-model: libvirt 根据当前宿主机 CPU 指令集从配置文件 /usr/share/libvirt/cpu_map.xml 选择一种最相配的 CPU 型号。在这种 mode 下，虚拟机的指令集往往比宿主机少，性能相对 host-passthrough 要差一点，但是热迁移时，它允许目的节点 CPU 和源节点的存在一定的差异。\n- custom: 这种模式下虚拟机 CPU 指令集数最少，故性能相对最差，但是它在热迁移时跨不同型号 CPU 的能力最强。此外，custom 模式下支持用户添加额外的指令集。\n\n三种 mode 的性能排序是：host-passthrough > host-model > custom\n\n实际性能差异不大：100%> 95.84%>94.73%\n\n引自：<http://wsfdl.com/openstack/2018/01/02/libvirt_cpu_mode.html>\n\n## （2）有关网卡模式的说明\n\n使用 virt-manager 创建虚拟机，在添加网卡时，有 3 中选择，分别是 e1000, rtl8139, virtio。\n\n“rtl8139”这个网卡模式是 qemu-kvm 默认的模拟网卡类型，RTL8139 是 Realtek 半导体公司的一个 10/100M 网卡系列，是曾经非常流行（当然现在看来有点古老）且兼容性好的网卡，几乎所有的现代操作系统都对 RTL8139 网卡驱动的提供支持。\n\n“e1000”系列提供 Intel e1000 系列的网卡模拟，纯的 QEMU（非 qemu-kvm）默认就是提供 Intel e1000 系列的虚拟网卡。\n\n“virtio” 类型是 qemu-kvm 对半虚拟化 IO（virtio）驱动的支持。\n\n这三个网卡的最大区别(此处指最需要关注的地方)是速度：\n\n- rtl8139 10/100Mb/s\n\n- e1000 1Gb/s\n\n- virtio 10Gb/s\n\n注意 virtio 是唯一可以达到 10Gb/s 的。\n\nvirtio 是一种 I/O 半虚拟化解决方案，是一套通用 I/O 设备虚拟化的程序，是对半虚拟化 Hypervisor 中的一组通用 I/O 设备的抽象。提供了一套上层应用与各 Hypervisor 虚拟化设备（KVM，Xen，VMware 等）之间的通信框架和编程接口，减少跨平台所带来的兼容性问题，大大提高驱动程序开发效率。\n\n## （3）有关 MACVTAP\n\n以下内容来自：<https://www.ibm.com/developerworks/cn/linux/1312_xiawc_linuxvirtnet/index.html>\n\nMACVTAP 的实现基于传统的 MACVLAN。和 TAP 设备一样，每一个 MACVTAP 设备拥有一个对应的 Linux 字符设备，并拥有和 TAP 设备一样的 IOCTL 接口，因此能直接被 KVM/Qemu 使用，方便地完成网络数据交换工作。引入 MACVTAP 设备的目标是：简化虚拟化环境中的交换网络，代替传统的 Linux TAP 设备加 Bridge 设备组合，同时支持新的虚拟化网络技术，如 802.1 Qbg。\n\nMACVTAP 设备和 VLAN 设备类似，是以一对多的母子关系出现的。在一个母设备上可以创建多个 MACVTAP 子设备，一个 MACVTAP 设备只有一个母设备，MACVTAP 子设备可以做为母设备，再一次嵌套的创建 MACVTAP 子设备。母子设备之间被隐含的桥接起来，母设备相当于现实世界中的交换机 TRUNK 口。实际上当 MACVTAP 设备被创建并且模式不为 Passthrough 时，内核隐含的创建了 MACVLAN 网络，完成转发功能。MACVTAP 设备有四种工作模式：Bridge、VEPA、Private，Passthrough。\n\nBridge 模式下，它完成与 Bridge 设备类似功能，数据可以在属于同一个母设备的子设备间交换转发，虚拟机相当于简单接入了一个交换机。当前的 Linux 实现有一个缺陷，此模式下 MACVTAP 子设备无法和 Linux Host 通讯，即虚拟机无法和 Host 通讯。----经验证，属实。\n\nPassthrough 模式下，内核的 MACVLAN 数据处理逻辑被跳过，硬件决定数据如何处理，从而释放了 Host CPU 资源。\n\n![MACVTAP 直通 vs PCI 直通](csr1kv-kvm-CentOS7/macvtap-ibm.png)\n\nMACVTAP Passthrough 概念与 PCI Passthrough 概念不同，上图详细解释了两种情况的区别。\n\nPCI Passthrough 针对的是任意 PCI 设备，不一定是网络设备，目的是让 Guest OS 直接使用 Host 上的 PCI 硬件以提高效率。以 X86 平台为例，数据将通过需要硬件支持的 VT-D 技术从 Guest OS 直接传递到 Host 硬件上。这样做固然效率很高，但因为模拟器失去了对虚拟硬件的控制，难以同步不同 Host 上的硬件状态，因此当前在使用 PCI Passthrough 的情况下难以做动态迁移。\n\nMACVTAP Passthrough 仅仅针对 MACVTAP 网络设备，目的是绕过内核里 MACVTAP 的部分软件处理过程，转而交给硬件处理。在虚拟化条件下，数据还是会先到达模拟器 I/O 层，再转发到硬件上。这样做效率有损失，但模拟器仍然控制虚拟硬件的状态及数据的走向，可以做动态迁移。\n\n## （4）SR-IOV 介绍\n\n如果网卡支持 SRIOV，请使用 SRIOV PCI Passthrough。\n\n![nic-type-010](csr1kv-kvm-CentOS7/nic-type-010.png)\n\n软件模拟是通过 Hypervisor 层模拟虚拟网卡，实现与物理设备完全一样的接口，虚拟机操作系统无须修改就能直接驱动虚拟网卡，其最大的缺点是性能相对较差；\n\n网卡直通支持虚拟机绕过 Hypervisor 层，直接访问物理 I/O 设备，具有最高的性能，但是在同一时刻物理 I/O 设备只能被一个虚拟机独享；\n\nSR-IOV 是 Intel 在 2007 年提出的解决虚拟化网络 I/O 的硬件技术方案，该技术不仅能够继承网卡直通的高性能优势，而且同时支持物理 I/O 设备的跨虚拟机共享，具有较好的应用前景。\n\n原文链接：<https://blog.csdn.net/lsz137105/article/details/100752930>\n\nSR-IOV（Single Root I/O Virtualization）是一个将 PCIe 设备（如网卡）共享给虚拟机的标准，通过为虚拟机提供独立的内存空间、中断、DMA 流，来绕过 VMM 实现数据访问。\n\nSR-IOV 引入了两种 PCIe functions：\n\n- PF（Physical Function）：包含完整的 PCIe 功能，包括 SR-IOV 的扩张能力，该功能用于 SR-IOV 的配置和管理。\n- VF（Virtual Function）：包含轻量级的 PCIe 功能。每一个 VF 有它自己独享的 PCI 配置区域，并且可能与其他 VF 共享着同一个物理资源。\n\nSR-IOV 网卡通过将 SR-IOV 功能集成到物理网卡上，将单一的物理网卡虚拟成多个 VF 接口，每个 VF 接口都有单独的虚拟 PCIe 通道，这些虚拟的 PCIe 通道共用物理网卡的 PCIe 通道。每个虚拟机可占用一个或多个 VF 接口，这样虚拟机就可以直接访问自己的 VF 接口，而不需要 Hypervisor 的协调干预，从而大幅提升网络吞吐性能。\n\n## （5）探索虚拟机进程\n\n每一个客户机就是宿主机中的一个 QEMU 进程，而一个客户机的多个 vCPU 就是一个 QEMU 进程中的多个线程。\n\n```bash\n[root@centos7 ~]# ps -ef | grep qemu\n\nqemu      52595      1 99 10:37 ?        01:24:12 /usr/libexec/qemu-kvm -name csr1kv-1 -S -machine pc-i440fx-rhel7.0.0,accel=kvm,usb=off,dump-guest-core=off,mem-merge=off -cpu host -m 8192 -mem-prealloc -mem-path /dev/hugepages/libvirt/qemu/7-csr1kv-1 -realtime mlock=on -smp 8,sockets=8,cores=1,threads=1 -uuid 59581018-6387-49df-ab09-2bcf40fc12ba -no-user-config -nodefaults -chardev socket,id=charmonitor,path=/var/lib/libvirt/qemu/domain-7-csr1kv-1/monitor.sock,server,nowait -mon chardev=charmonitor,id=monitor,mode=control -rtc base=utc,driftfix=slew -global kvm-pit.lost_tick_policy=delay -no-hpet -no-shutdown -global PIIX4_PM.disable_s3=1 -global PIIX4_PM.disable_s4=1 -boot strict=on -device piix3-usb-uhci,id=usb,bus=pci.0,addr=0x1.0x2 -device virtio-serial-pci,id=virtio-serial0,bus=pci.0,addr=0x6 -drive file=/home/root/images/csr1000v-universalk9.17.02.01v.qcow2,format=qcow2,if=none,id=drive-virtio-disk0 -device virtio-blk-pci,scsi=off,bus=pci.0,addr=0x7,drive=drive-virtio-disk0,id=virtio-disk0,bootindex=1 -netdev tap,fd=26,id=hostnet0,vhost=on,vhostfd=28 -device virtio-net-pci,netdev=hostnet0,id=net0,mac=52:54:00:36:95:f0,bus=pci.0,addr=0x3 -chardev pty,id=charserial0 -device isa-serial,chardev=charserial0,id=serial0 -chardev socket,id=charchannel0,path=/var/lib/libvirt/qemu/channel/target/domain-7-csr1kv-1/org.qemu.guest_agent.0,server,nowait -device virtserialport,bus=virtio-serial0.0,nr=1,chardev=charchannel0,id=channel0,name=org.qemu.guest_agent.0 -chardev spicevmc,id=charchannel1,name=vdagent -device virtserialport,bus=virtio-serial0.0,nr=2,chardev=charchannel1,id=channel1,name=com.redhat.spice.0 -spice port=5900,addr=127.0.0.1,disable-ticketing,image-compression=off,seamless-migration=on -vga qxl -global qxl-vga.ram_size=67108864 -global qxl-vga.vram_size=67108864 -global qxl-vga.vgamem_mb=16 -global qxl-vga.max_outputs=1 -device vfio-pci,host=1d:00.0,id=hostdev1,bus=pci.0,addr=0x8 -device vfio-pci,host=3b:10.1,id=hostdev0,bus=pci.0,addr=0x4 -msg timestamp=on\n```\n\n使用 virsh 命令或 virt-manager 开启虚拟机，是通过调用/usr/libexec/qemu-kvm 并附带虚拟配置的参数，来开启 qemu-kvm 的进程。可以看到上述的参数是非常复杂的，libvirt 提供 XML 参数进行简化。\n\nps -efL | grep qemu 可以列出所有的线程，但是输出篇幅很长，不在此列出；使用 pstree 可列出其父进程、线程关系，如下：\n\n![Pstree](csr1kv-kvm-CentOS7/pstree-011.png)\n\nvirt-top 可查看虚机运行状态和资源利用率：\n\n[root@centos7 ~]# virt-top -1\n\n![Virt-top](csr1kv-kvm-CentOS7/virt-top-012.png)\n\n# 参考资料连接\n\n- <https://cloud.tencent.com/developer/article/1703094>\n- <https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html-single/performance_tuning_guide/index>\n- <https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/7/html-single/virtualization_tuning_and_optimization_guide/index>\n- <https://computingforgeeks.com/how-to-create-and-configure-bridge-networking-for-kvm-in-linux/>\n- <https://software.intel.com/content/www/us/en/develop/articles/configure-sr-iov-network-virtual-functions-in-linux-kvm.html>\n","slug":"csr1kv-kvm-CentOS7","published":1,"updated":"2025-12-14T09:50:07.440Z","comments":1,"layout":"post","photos":[],"_id":"cuidRCOgRoGMsTkR3PcorDgKD","content":"<p>作者：Rao Weibo</p>\n<p>版本：1.0</p>\n<p>更新日期：20210203</p>\n<p>本文提供在 CentOS 7 版本上安装 KVM，并安装和设置 CSR 1000v&#x2F;Catalyst 8000v 的指南，内容包括 SRIOV，KVM 调优以及 CSR1KV 初始化配置等内容。</p>\n<h1 id=\"CentOS7-安装及设置\"><a href=\"#CentOS7-安装及设置\" class=\"headerlink\" title=\"CentOS7 安装及设置\"></a>CentOS7 安装及设置</h1><h2 id=\"（1）BIOS-设置建议\"><a href=\"#（1）BIOS-设置建议\" class=\"headerlink\" title=\"（1）BIOS 设置建议\"></a>（1）BIOS 设置建议</h2><table>\n<thead>\n<tr>\n<th align=\"left\">Configuration</th>\n<th align=\"left\">Recommended Setting</th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"left\">Intel Hyper-Threading Technology</td>\n<td align=\"left\">Disabled</td>\n</tr>\n<tr>\n<td align=\"left\">Number of Enable Cores</td>\n<td align=\"left\">ALL</td>\n</tr>\n<tr>\n<td align=\"left\">Execute Disable</td>\n<td align=\"left\">Enabled</td>\n</tr>\n<tr>\n<td align=\"left\">Intel VT</td>\n<td align=\"left\">Enabled</td>\n</tr>\n<tr>\n<td align=\"left\">Intel VT-D</td>\n<td align=\"left\">Enabled</td>\n</tr>\n<tr>\n<td align=\"left\">Intel VT-D coherency support</td>\n<td align=\"left\">Enabled</td>\n</tr>\n<tr>\n<td align=\"left\">Intel VT-D ATS support</td>\n<td align=\"left\">Enabled</td>\n</tr>\n<tr>\n<td align=\"left\">CPU Performance</td>\n<td align=\"left\">High throughput</td>\n</tr>\n<tr>\n<td align=\"left\">Hardware Perfetcher</td>\n<td align=\"left\">Disabled</td>\n</tr>\n<tr>\n<td align=\"left\">Adjacent Cache Line Prefetcher</td>\n<td align=\"left\">Disabled</td>\n</tr>\n<tr>\n<td align=\"left\">DCU Streamer Prefetch</td>\n<td align=\"left\">Disable</td>\n</tr>\n<tr>\n<td align=\"left\">Power Technology</td>\n<td align=\"left\">Custom</td>\n</tr>\n<tr>\n<td align=\"left\">Enhanced Intel Speedstep Technology</td>\n<td align=\"left\">Disabled</td>\n</tr>\n<tr>\n<td align=\"left\">Intel Turbo Boost Technology</td>\n<td align=\"left\">Enabled</td>\n</tr>\n<tr>\n<td align=\"left\">Processor Power State C6</td>\n<td align=\"left\">Disabled</td>\n</tr>\n<tr>\n<td align=\"left\">Processor Power State C1 Enhanced</td>\n<td align=\"left\">Disabled</td>\n</tr>\n<tr>\n<td align=\"left\">Frequency Poor Override</td>\n<td align=\"left\">Enabled</td>\n</tr>\n<tr>\n<td align=\"left\">P-State Coordination</td>\n<td align=\"left\">HW_ALL</td>\n</tr>\n<tr>\n<td align=\"left\">Energy Performance</td>\n<td align=\"left\">Performance</td>\n</tr>\n</tbody></table>\n<p>以上建议来自 CSR 1000v 的安装指南。</p>\n<h2 id=\"（2）CentOS-7-的安装\"><a href=\"#（2）CentOS-7-的安装\" class=\"headerlink\" title=\"（2）CentOS 7 的安装\"></a>（2）CentOS 7 的安装</h2><p>在安装的时候选择</p>\n<ul>\n<li>Server with GUI</li>\n<li>Virtualization Client</li>\n<li>Virtualization Hypervisor</li>\n<li>Virtualization Tools</li>\n</ul>\n<p>启动完毕以后关闭 selinux，重启生效。</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sed -i &#x27;s/SELINUX=enforcing/SELINUX=disabled/g&#x27; /etc/selinux/config</span><br><span class=\"line\"></span><br><span class=\"line\">getenforce\t\t//结果为：Enforcing（开启状态）disabled(关闭状态)</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">安装完后，SSH登录可能显示中文，可修改 .bash_profile</span></span><br><span class=\"line\"></span><br><span class=\"line\">LANG=&quot;en_US.UTF-8&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">export LANG</span><br><span class=\"line\"></span><br><span class=\"line\">source .bash_profile</span><br><span class=\"line\"></span><br><span class=\"line\">egrep -o &#x27;(vmx|svm)&#x27; /proc/cpuinfo | sort | uniq</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">注：在生产环境中，需要在服务器连接的交换机以及出口防火墙上做好安全策略。</span></span><br><span class=\"line\"></span><br><span class=\"line\">systemctl stop firewalld</span><br><span class=\"line\"></span><br><span class=\"line\">systemctl disable firewalld</span><br></pre></td></tr></table></figure>\n\n<p>本文档采用 NetworkManager 配置，故在此并不停用 NetworkManager。</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat /etc/sysctl.conf</span><br><span class=\"line\"></span><br><span class=\"line\">net.ipv4.ip_forward = 1</span><br><span class=\"line\"></span><br><span class=\"line\">net.bridge.bridge-nf-call-ip6tables = 0</span><br><span class=\"line\"></span><br><span class=\"line\">net.bridge.bridge-nf-call-iptables = 0</span><br><span class=\"line\"></span><br><span class=\"line\">net.bridge.bridge-nf-call-arptables = 0</span><br></pre></td></tr></table></figure>\n\n<p>检查 KVM 组件版本：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@centos7 ~]# libvirtd -V</span><br><span class=\"line\"></span><br><span class=\"line\">libvirtd (libvirt) 4.5.0</span><br><span class=\"line\"></span><br><span class=\"line\">[root@centos7 ~]# /usr/libexec/qemu-kvm --version</span><br><span class=\"line\"></span><br><span class=\"line\">QEMU emulator version 1.5.3 (qemu-kvm-1.5.3-173.el7_8.3), Copyright (c) 2003-2008 Fabrice Bellard</span><br><span class=\"line\"></span><br><span class=\"line\">[root@centos7 ~]# virt-manager --version</span><br><span class=\"line\"></span><br><span class=\"line\">1.5.0</span><br><span class=\"line\"></span><br><span class=\"line\">[root@centos7 ~]# modinfo kvm-intel</span><br><span class=\"line\"></span><br><span class=\"line\">filename:       /lib/modules/3.10.0-1127.18.2.el7.x86_64/kernel/arch/x86/kvm/kvm-intel.ko.xz</span><br><span class=\"line\"></span><br><span class=\"line\">[root@centos7 ~]# modinfo ixgbevf</span><br><span class=\"line\"></span><br><span class=\"line\">filename:       /lib/modules/3.10.0-1127.18.2.el7.x86_64/kernel/drivers/net/ethernet/intel/ixgbevf/ixgbevf.ko.xz</span><br><span class=\"line\"></span><br><span class=\"line\">version:        4.1.0-k-rh7.7</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"（3）创建本地-Yum-源（可选）\"><a href=\"#（3）创建本地-Yum-源（可选）\" class=\"headerlink\" title=\"（3）创建本地 Yum 源（可选）\"></a>（3）创建本地 Yum 源（可选）</h2><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">1、备份本地/etc/yum.repos.d 目录下的yum源</span></span><br><span class=\"line\"></span><br><span class=\"line\">cd /etc/yum.repos.d/</span><br><span class=\"line\"></span><br><span class=\"line\">mkdir bak</span><br><span class=\"line\"></span><br><span class=\"line\">mv C* bak/</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">2、上传CentOS-7-x86_64-Everything-2009.iso镜像到/opt</span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">3、挂载镜像</span></span><br><span class=\"line\"></span><br><span class=\"line\">mkdir -p /media/cdrom</span><br><span class=\"line\"></span><br><span class=\"line\">mount -t iso9660 -o loop /opt/CentOS-7-x86_64-Everything-2009.iso /media/cdrom/</span><br><span class=\"line\"></span><br><span class=\"line\">mount\t\t//查看挂载信息</span><br><span class=\"line\"></span><br><span class=\"line\">df -h</span><br><span class=\"line\"></span><br><span class=\"line\">vi /etc/fstab</span><br><span class=\"line\"></span><br><span class=\"line\">/opt/CentOS-7-x86_64-Everything-2009.iso    /media/cdrom    iso9660 loop 0 0</span><br><span class=\"line\"></span><br><span class=\"line\">tail -1 /etc/fstab\t\t//查看是否写入/etc/fstab</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">4、配置本地yum源</span></span><br><span class=\"line\"></span><br><span class=\"line\">cd /etc/yum.repos.d/</span><br><span class=\"line\"></span><br><span class=\"line\">vi local.repo</span><br><span class=\"line\"></span><br><span class=\"line\">[local]</span><br><span class=\"line\"></span><br><span class=\"line\">name=local</span><br><span class=\"line\"></span><br><span class=\"line\">baseurl=file:///media/cdrom\t   //前面的file://是协议,后面的/media/cdrom是光盘挂载点</span><br><span class=\"line\"></span><br><span class=\"line\">gpgcheck=0\t\t//1使用公钥验证rpm包的正确性,0不验证</span><br><span class=\"line\"></span><br><span class=\"line\">enabled=1\t\t//1启用yum源,0禁用yum源</span><br><span class=\"line\"></span><br><span class=\"line\">yum install -y numactl telnet</span><br></pre></td></tr></table></figure>\n\n<p>运行 virt-manager 启动图形化界面。</p>\n<p>如果对 virsh CLI 命令熟悉，可以使用 virsh 命令创建虚拟机。</p>\n<h2 id=\"（4）服务器网卡配置—NetworkManager-配置\"><a href=\"#（4）服务器网卡配置—NetworkManager-配置\" class=\"headerlink\" title=\"（4）服务器网卡配置—NetworkManager 配置\"></a>（4）服务器网卡配置—NetworkManager 配置</h2><p>在终端界面，可以通过 nmtui 打开图形化界面进行设置；以下使用 nmcli 进行设置。</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nmcli connection add con-name eno1 type ethernet autoconnect yes ifname eno1</span><br><span class=\"line\"></span><br><span class=\"line\">nmcli connection modify eno1 ipv4.method manual ipv4.addresses 10.75.58.43/24 ipv4.gateway 10.75.58.1 ipv4.dns 64.104.123.245</span><br><span class=\"line\"></span><br><span class=\"line\">nmcli connection up eno1</span><br><span class=\"line\"></span><br><span class=\"line\">nmcli connection show eno1</span><br><span class=\"line\"></span><br><span class=\"line\">ping 10.75.58.1</span><br></pre></td></tr></table></figure>\n\n<p>上述命令完成后，在&#x2F;etc&#x2F;sysconfig&#x2F;network-scripts 中会生成网卡的 ifcfg 配置文件。</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat /etc/sysconfig/network-scripts/ifcfg-eno1</span><br><span class=\"line\"></span><br><span class=\"line\">HWADDR=70:7D:B9:59:5B:AE</span><br><span class=\"line\"></span><br><span class=\"line\">TYPE=Ethernet</span><br><span class=\"line\"></span><br><span class=\"line\">PROXY_METHOD=none</span><br><span class=\"line\"></span><br><span class=\"line\">BROWSER_ONLY=no</span><br><span class=\"line\"></span><br><span class=\"line\">BOOTPROTO=none</span><br><span class=\"line\"></span><br><span class=\"line\">IPADDR=10.75.58.43</span><br><span class=\"line\"></span><br><span class=\"line\">PREFIX=24</span><br><span class=\"line\"></span><br><span class=\"line\">GATEWAY=10.75.58.1</span><br><span class=\"line\"></span><br><span class=\"line\">DNS1=64.104.123.245</span><br><span class=\"line\"></span><br><span class=\"line\">DEFROUTE=yes</span><br><span class=\"line\"></span><br><span class=\"line\">IPV4_FAILURE_FATAL=no</span><br><span class=\"line\"></span><br><span class=\"line\">IPV6INIT=yes</span><br><span class=\"line\"></span><br><span class=\"line\">IPV6_AUTOCONF=yes</span><br><span class=\"line\"></span><br><span class=\"line\">IPV6_DEFROUTE=yes</span><br><span class=\"line\"></span><br><span class=\"line\">IPV6_FAILURE_FATAL=no</span><br><span class=\"line\"></span><br><span class=\"line\">IPV6_ADDR_GEN_MODE=stable-privacy</span><br><span class=\"line\"></span><br><span class=\"line\">NAME=eno1</span><br><span class=\"line\"></span><br><span class=\"line\">UUID=2a1c8b39-7f44-321b-a65f-a93e70ab0616</span><br><span class=\"line\"></span><br><span class=\"line\">ONBOOT=yes</span><br><span class=\"line\"></span><br><span class=\"line\">AUTOCONNECT_PRIORITY=-999</span><br><span class=\"line\"></span><br><span class=\"line\">DEVICE=eno1</span><br></pre></td></tr></table></figure>\n\n<p>此时，可以将 network.service 停止和关闭。</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl stop network</span><br><span class=\"line\"></span><br><span class=\"line\">systemctl disable network</span><br></pre></td></tr></table></figure>\n\n<p>注意，如果 NetworkManager 未设置妥当，执行 systemctl stop network 后，会导致服务器无法管理。</p>\n<p>准备开启 SRIOV 的网卡设置，以 eno2 为例：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nmcli connection add con-name eno2 <span class=\"built_in\">type</span> ethernet autoconnect <span class=\"built_in\">yes</span> ifname eno2</span><br><span class=\"line\"></span><br><span class=\"line\">nmcli connection modify eno2 ethernet.mtu 9216 ipv4.method disabled</span><br><span class=\"line\"></span><br><span class=\"line\">nmcli connection up eno2</span><br><span class=\"line\"></span><br><span class=\"line\">nmcli connection show eno2</span><br><span class=\"line\"></span><br><span class=\"line\">ip <span class=\"built_in\">link</span> show dev eno2</span><br></pre></td></tr></table></figure>\n\n<p>注：上述 MTU 值设置为 9216 是借鉴自 Cisco NFVIS 平台，如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">CSP5228-1# show pnic-detail mtu</span><br><span class=\"line\"></span><br><span class=\"line\">Name          MTU</span><br><span class=\"line\"></span><br><span class=\"line\">=============================</span><br><span class=\"line\"></span><br><span class=\"line\">eth0-1        9216</span><br><span class=\"line\"></span><br><span class=\"line\">eth0-2        9216</span><br><span class=\"line\"></span><br><span class=\"line\">eth1-1        9216</span><br><span class=\"line\"></span><br><span class=\"line\">eth1-2        9216</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"（5）配置-Linux-网桥-（可选）\"><a href=\"#（5）配置-Linux-网桥-（可选）\" class=\"headerlink\" title=\"（5）配置 Linux 网桥 （可选）\"></a>（5）配置 Linux 网桥 （可选）</h2><p>网桥 br1 配置示例：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nmcli connection add con-name br1 <span class=\"built_in\">type</span> bridge autoconnect <span class=\"built_in\">yes</span> ipv4.method disabled ethernet.mtu 9216 ifname br1</span><br><span class=\"line\"></span><br><span class=\"line\">nmcli connection up br1</span><br><span class=\"line\"></span><br><span class=\"line\">ip <span class=\"built_in\">link</span> show dev br1</span><br></pre></td></tr></table></figure>\n\n<p>网桥 br1 的物理网卡配置</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nmcli connection add con-name eno5 <span class=\"built_in\">type</span> ethernet autoconnect <span class=\"built_in\">yes</span> ifname eno5</span><br><span class=\"line\"></span><br><span class=\"line\">nmcli connection modify eno5 ethernet.mtu 9216 ipv4.method disabled master br1</span><br><span class=\"line\"></span><br><span class=\"line\">nmcli connection up eno5</span><br><span class=\"line\"></span><br><span class=\"line\">ip <span class=\"built_in\">link</span> show dev eno5</span><br></pre></td></tr></table></figure>\n\n<p>创建 net-br1 网络</p>\n<p>[root@centos7 ~]# cat net-br1.xml</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">network</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"tag\">&lt;<span class=\"name\">name</span>&gt;</span>net-br1<span class=\"tag\">&lt;/<span class=\"name\">name</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"tag\">&lt;<span class=\"name\">forward</span> <span class=\"attr\">mode</span>=<span class=\"string\">&quot;bridge&quot;</span>/&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"tag\">&lt;<span class=\"name\">bridge</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;br1&quot;</span>/&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">network</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@centos7 ~]# virsh net-define net-br1.xml</span><br><span class=\"line\"></span><br><span class=\"line\">Network net-br1 defined from net-br1.xml</span><br><span class=\"line\"></span><br><span class=\"line\">[root@centos7 ~]# virsh net-start net-br1</span><br><span class=\"line\"></span><br><span class=\"line\">Network net-br1 started</span><br><span class=\"line\"></span><br><span class=\"line\">[root@centos7 ~]# virsh net-autostart net-br1</span><br><span class=\"line\"></span><br><span class=\"line\">Network net-br1 marked as autostarted</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"配置-SR-IOV\"><a href=\"#配置-SR-IOV\" class=\"headerlink\" title=\"配置 SR-IOV\"></a>配置 SR-IOV</h1><h2 id=\"（1）检查网卡对-SR-IOV-的支持，并配置网卡\"><a href=\"#（1）检查网卡对-SR-IOV-的支持，并配置网卡\" class=\"headerlink\" title=\"（1）检查网卡对 SR-IOV 的支持，并配置网卡\"></a>（1）检查网卡对 SR-IOV 的支持，并配置网卡</h2><p>可使用 lshw 和 lspci 检查网卡对 SR-IOV 的支持</p>\n<p>lshw -c network -businfo</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Bus info          Device      Class          Description</span><br><span class=\"line\"></span><br><span class=\"line\">========================================================</span><br><span class=\"line\"></span><br><span class=\"line\">pci@0000:1d:00.0  eno5        network        VIC Ethernet NIC</span><br><span class=\"line\"></span><br><span class=\"line\">pci@0000:1d:00.1  eno6        network        VIC Ethernet NIC</span><br><span class=\"line\"></span><br><span class=\"line\">pci@0000:1d:00.2  eno7        network        VIC Ethernet NIC</span><br><span class=\"line\"></span><br><span class=\"line\">pci@0000:1d:00.3  eno8        network        VIC Ethernet NIC</span><br><span class=\"line\"></span><br><span class=\"line\">pci@0000:3b:00.0  eno1        network        Ethernet Controller 10G X550T</span><br><span class=\"line\"></span><br><span class=\"line\">pci@0000:3b:00.1  eno2        network        Ethernet Controller 10G X550T</span><br></pre></td></tr></table></figure>\n\n<p>lspci -vv -s 3b:00.1 | grep -A 5 -i SR-IOV</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Capabilities: [160 v1] Single Root I/O Virtualization (SR-IOV)</span><br><span class=\"line\"></span><br><span class=\"line\">  IOVCap:\tMigration-, Interrupt Message Number: 000</span><br><span class=\"line\"></span><br><span class=\"line\">\tIOVCtl:\tEnable+ Migration- Interrupt- MSE+ ARIHierarchy-</span><br><span class=\"line\"></span><br><span class=\"line\">\tIOVSta:\tMigration-</span><br><span class=\"line\"></span><br><span class=\"line\">\tInitial VFs: 64, Total VFs: 64, Number of VFs: 8, Function Dependency Link: 01</span><br><span class=\"line\"></span><br><span class=\"line\">\tVF offset: 128, stride: 2, Device ID: 1565</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"（2）设置启动参数\"><a href=\"#（2）设置启动参数\" class=\"headerlink\" title=\"（2）设置启动参数\"></a>（2）设置启动参数</h2><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vi /etc/default/grub</span><br><span class=\"line\"></span><br><span class=\"line\">GRUB_CMDLINE_LINUX=&quot;crashkernel=auto spectre_v2=retpoline rd.lvm.lv=centos/root rd.lvm.lv=centos/swap rhgb quiet hugepagesz=1G hugepages=32 default_hugepagesz=1G intel_iommu=on iommu=pt isolcpus=1-8,37-44&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">注：页面数字不要过大，不然启动失败，如果后续不够，可以在运行时添加。</span><br><span class=\"line\"></span><br><span class=\"line\">grub2-mkconfig -o /boot/grub2/grub.cfg</span><br><span class=\"line\"></span><br><span class=\"line\">grub2-mkconfig -o /boot/efi/EFI/centos/grub.cfg</span><br><span class=\"line\"></span><br><span class=\"line\">iommu=pt 参数是将SRIOV设备支持PCI Passthrough</span><br></pre></td></tr></table></figure>\n\n<p>重启后验证</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat /proc/cmdline |grep intel_iommu=on</span><br><span class=\"line\"></span><br><span class=\"line\">dmesg |grep -e DMAR -e IOMMU</span><br><span class=\"line\"></span><br><span class=\"line\">dmesg | grep -e DMAR -e IOMMU -e AMD-Vi</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li><strong>default_hugepagesz&#x3D;1G hugepagesz&#x3D;1G hugepages&#x3D;32</strong> 参数设置主机在启动时分配 32 个 1GB 的内存大页，这些是静态内存大页。 CSR 1000v 虚拟机将试用这些静态大页以获得最优性能。</li>\n<li><strong>isolcpus&#x3D;1-8,37-44</strong> 参数设置的作用是隔离 1-8，37-44 的 CPU 核，使其独立于内核的平衡调度算法，也就是内核本身不会将进程分配到被隔离的 CPU。之后我们可将指定的进程 CSR 1000v 虚拟机绑定到被隔离的 CPU 上运行，让进程独占 CPU，使其实时性可得到一定程度的提高。</li>\n</ul>\n<p>可参考 这个章节获取主机 CPU 核的相关信息。</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@centos7 ~]# cat /proc/cmdline |grep intel_iommu=on</span><br><span class=\"line\"></span><br><span class=\"line\">BOOT_IMAGE=/vmlinuz-3.10.0-1127.el7.x86_64 root=/dev/mapper/centos-root ro crashkernel=auto spectre_v2=retpoline rd.lvm.lv=centos/root rd.lvm.lv=centos/swap rhgb quiet hugepagesz=1G hugepages=32 default_hugepagesz=1G intel_iommu=on iommu=pt LANG=en_US.UTF-8</span><br><span class=\"line\"></span><br><span class=\"line\">[root@centos7 ~]# dmesg |grep -e DMAR -e IOMMU</span><br><span class=\"line\"></span><br><span class=\"line\">[    0.000000] ACPI: DMAR 000000005d6f5d70 00250 (v01 Cisco0 CiscoUCS 00000001 INTL 20091013)</span><br><span class=\"line\"></span><br><span class=\"line\">[    0.000000] DMAR: IOMMU enabled</span><br></pre></td></tr></table></figure>\n\n<p>查看隔离的 CPU 核以及所有的 CPU 核。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@centos7 ~]# <span class=\"built_in\">cat</span> /sys/devices/system/cpu/isolated</span><br><span class=\"line\"></span><br><span class=\"line\">1-8,37-44</span><br><span class=\"line\"></span><br><span class=\"line\">[root@centos7 ~]# <span class=\"built_in\">cat</span> /sys/devices/system/cpu/present</span><br><span class=\"line\"></span><br><span class=\"line\">0-71</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"（3）通过-nmcli-持久化-VFs-配置\"><a href=\"#（3）通过-nmcli-持久化-VFs-配置\" class=\"headerlink\" title=\"（3）通过 nmcli 持久化 VFs 配置\"></a>（3）通过 nmcli 持久化 VFs 配置</h2><p>nmcli 可以设置网卡的 sriov 参数，如下：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nmcli connection modify eno2 sriov.total-vfs 4</span><br></pre></td></tr></table></figure>\n\n<p>还可以设置每一个 VF 设备的 MAC 地址，便于管理：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nmcli connection modify eno2 sriov.vfs <span class=\"string\">&#x27;0 mac=8E:DF:08:C1:D1:DE trust=true, 1 mac=5A:B9:2F:99:A6:CE trust=true, 2 mac=46:78:69:E3:71:3D trust=true, 3 mac=7E:A7:DB:3B:1B:B3 trust=true&#x27;</span></span><br></pre></td></tr></table></figure>\n\n<p>执行上述命令后：</p>\n<p>cat &#x2F;etc&#x2F;sysconfig&#x2F;network-scripts&#x2F;ifcfg-eno2</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">TYPE=Ethernet</span><br><span class=\"line\"></span><br><span class=\"line\">NAME=eno2</span><br><span class=\"line\"></span><br><span class=\"line\">UUID=64ffa204-0158-40c8-ba86-2b7aebf27619</span><br><span class=\"line\"></span><br><span class=\"line\">DEVICE=eno2</span><br><span class=\"line\"></span><br><span class=\"line\">ONBOOT=<span class=\"built_in\">yes</span></span><br><span class=\"line\"></span><br><span class=\"line\">MTU=9216</span><br><span class=\"line\"></span><br><span class=\"line\">HWADDR=70:7D:B9:59:5B:AF</span><br><span class=\"line\"></span><br><span class=\"line\">PROXY_METHOD=none</span><br><span class=\"line\"></span><br><span class=\"line\">BROWSER_ONLY=no</span><br><span class=\"line\"></span><br><span class=\"line\">IPV6INIT=no</span><br><span class=\"line\"></span><br><span class=\"line\">SRIOV_TOTAL_VFS=4</span><br><span class=\"line\"></span><br><span class=\"line\">SRIOV_VF0=<span class=\"string\">&quot;mac=8E:DF:08:C1:D1:DE trust=true&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">SRIOV_VF1=<span class=\"string\">&quot;mac=5A:B9:2F:99:A6:CE trust=true&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">SRIOV_VF2=<span class=\"string\">&quot;mac=46:78:69:E3:71:3D trust=true&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">SRIOV_VF3=<span class=\"string\">&quot;mac=7E:A7:DB:3B:1B:B3 trust=true&quot;</span></span><br></pre></td></tr></table></figure>\n\n<p>重启后，检查 dmesg：</p>\n<p>dmesg | grep -i vf | grep -i eno2</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[   11.953333] ixgbe 0000:3b:00.1 eno2: SR-IOV enabled with 4 VFs</span><br><span class=\"line\"></span><br><span class=\"line\">[   12.541801] ixgbe 0000:3b:00.1: setting MAC 8e:<span class=\"built_in\">df</span>:08:c1:d1:de on VF 0</span><br><span class=\"line\"></span><br><span class=\"line\">[   12.541805] ixgbe 0000:3b:00.1: Reload the VF driver to make this change effective.</span><br><span class=\"line\"></span><br><span class=\"line\">[   12.541841] ixgbe 0000:3b:00.1 eno2: VF 0 is trusted</span><br><span class=\"line\"></span><br><span class=\"line\">[   12.541846] ixgbe 0000:3b:00.1: setting MAC 5a:b9:2f:99:a6:ce on VF 1</span><br><span class=\"line\"></span><br><span class=\"line\">[   12.541850] ixgbe 0000:3b:00.1: Reload the VF driver to make this change effective.</span><br><span class=\"line\"></span><br><span class=\"line\">[   12.541883] ixgbe 0000:3b:00.1 eno2: VF 1 is trusted</span><br><span class=\"line\"></span><br><span class=\"line\">[   12.541887] ixgbe 0000:3b:00.1: setting MAC 46:78:69:e3:71:3d on VF 2</span><br><span class=\"line\"></span><br><span class=\"line\">[   12.541891] ixgbe 0000:3b:00.1: Reload the VF driver to make this change effective.</span><br><span class=\"line\"></span><br><span class=\"line\">[   12.541923] ixgbe 0000:3b:00.1 eno2: VF 2 is trusted</span><br><span class=\"line\"></span><br><span class=\"line\">[   12.541928] ixgbe 0000:3b:00.1: setting MAC 7e:a7:db:3b:1b:b3 on VF 3</span><br><span class=\"line\"></span><br><span class=\"line\">[   12.541932] ixgbe 0000:3b:00.1: Reload the VF driver to make this change effective.</span><br><span class=\"line\"></span><br><span class=\"line\">[   12.541965] ixgbe 0000:3b:00.1 eno2: VF 3 is trusted</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"（4）检查-VF\"><a href=\"#（4）检查-VF\" class=\"headerlink\" title=\"（4）检查 VF\"></a>（4）检查 VF</h2><p>可通过 lspci 和 ip link 检查 VF，如下：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@centos7 ~]# lspci | grep -i Virtual</span><br><span class=\"line\"></span><br><span class=\"line\">[root@centos7 ~]# ip <span class=\"built_in\">link</span> show | grep -B2 vf</span><br></pre></td></tr></table></figure>\n\n<p>寻找 Physical Function 和 Virtual Function 之间的对应关系：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@centos7 ~]# <span class=\"built_in\">ls</span> -l /sys/class/net/eno1/device/ | grep virtfn</span><br></pre></td></tr></table></figure>\n\n<p>VF 被创建后，NetworkManager 自动给新的设备创建 Connection，可以修改名称，如下：</p>\n<p>nmcli connection</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">NAME        UUID                                  TYPE      DEVICE</span><br><span class=\"line\"></span><br><span class=\"line\">eno1        2a1c8b39-7f44-321b-a65f-a93e70ab0616  ethernet  eno1</span><br><span class=\"line\"></span><br><span class=\"line\">eno2        64ffa204-0158-40c8-ba86-2b7aebf27619  ethernet  eno2</span><br><span class=\"line\"></span><br><span class=\"line\">enp59s16f1  19c28a93-aa36-38e6-a556-55a922a0a332  ethernet  enp59s16f1</span><br><span class=\"line\"></span><br><span class=\"line\">enp59s16f3  428d9707-1515-3475-b356-7eb229c3f937  ethernet  enp59s16f3</span><br><span class=\"line\"></span><br><span class=\"line\">enp59s16f5  21a8dd5f-239f-37b2-9b09-24ce0e7413bc  ethernet  enp59s16f5</span><br><span class=\"line\"></span><br><span class=\"line\">enp59s16f7  0ca0da65-64c4-314d-89a4-4213f9e4f478  ethernet  enp59s16f7</span><br></pre></td></tr></table></figure>\n\n<p>修改名称：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nmcli connection modify uuid 19c28a93-aa36-38e6-a556-55a922a0a332 connection.id enp59s16f1</span><br></pre></td></tr></table></figure>\n\n<p>修改 MTU 值，并禁用 IPv4 和 IPv6，网卡启动更快</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nmcli connection modify enp59s16f1 ifname enp59s16f1 ipv4.method disabled ipv6.method ignore ethernet.mtu 9216 ethernet.mac-address <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">nmcli connection up enp59s16f1</span><br><span class=\"line\"></span><br><span class=\"line\">nmcli connection show enp59s16f1</span><br></pre></td></tr></table></figure>\n\n<p>上述命令生成的 ifcfg 配置文件如下：</p>\n<p>[root@centos7 ~]# cat &#x2F;etc&#x2F;sysconfig&#x2F;network-scripts&#x2F;ifcfg-enp59s16f1</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">TYPE=Ethernet</span><br><span class=\"line\"></span><br><span class=\"line\">PROXY_METHOD=none</span><br><span class=\"line\"></span><br><span class=\"line\">BROWSER_ONLY=no</span><br><span class=\"line\"></span><br><span class=\"line\">DEFROUTE=<span class=\"built_in\">yes</span></span><br><span class=\"line\"></span><br><span class=\"line\">IPV4_FAILURE_FATAL=no</span><br><span class=\"line\"></span><br><span class=\"line\">IPV6INIT=no</span><br><span class=\"line\"></span><br><span class=\"line\">IPV6_AUTOCONF=no</span><br><span class=\"line\"></span><br><span class=\"line\">IPV6_DEFROUTE=<span class=\"built_in\">yes</span></span><br><span class=\"line\"></span><br><span class=\"line\">IPV6_FAILURE_FATAL=no</span><br><span class=\"line\"></span><br><span class=\"line\">IPV6_ADDR_GEN_MODE=stable-privacy</span><br><span class=\"line\"></span><br><span class=\"line\">NAME=enp59s16f1</span><br><span class=\"line\"></span><br><span class=\"line\">UUID=19c28a93-aa36-38e6-a556-55a922a0a332</span><br><span class=\"line\"></span><br><span class=\"line\">ONBOOT=<span class=\"built_in\">yes</span></span><br><span class=\"line\"></span><br><span class=\"line\">AUTOCONNECT_PRIORITY=-999</span><br><span class=\"line\"></span><br><span class=\"line\">DEVICE=enp59s16f1</span><br><span class=\"line\"></span><br><span class=\"line\">MTU=9216</span><br></pre></td></tr></table></figure>\n\n<p>这样，即便系统重启，上述配置依然能生效。</p>\n<h1 id=\"使用-KVM-的虚拟网络适配器池\"><a href=\"#使用-KVM-的虚拟网络适配器池\" class=\"headerlink\" title=\"使用 KVM 的虚拟网络适配器池\"></a>使用 KVM 的虚拟网络适配器池</h1><p>主机上创建一个 VF 网络设备的资源池，资源池内的设备可以自动地分配给虚拟机使用。</p>\n<h2 id=\"（1）创建一个-xml-文件。\"><a href=\"#（1）创建一个-xml-文件。\" class=\"headerlink\" title=\"（1）创建一个 xml 文件。\"></a>（1）创建一个 xml 文件。</h2><p>[root@centos7 ~]# cat eno2_sriov_pool.xml</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">network</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">name</span>&gt;</span>eno2_sriov_pool<span class=\"tag\">&lt;/<span class=\"name\">name</span>&gt;</span> <span class=\"comment\">&lt;!-- This is the name of the file you created --&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">forward</span> <span class=\"attr\">mode</span>=<span class=\"string\">&#x27;hostdev&#x27;</span> <span class=\"attr\">managed</span>=<span class=\"string\">&#x27;yes&#x27;</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">pf</span> <span class=\"attr\">dev</span>=<span class=\"string\">&#x27;eno2&#x27;</span>/&gt;</span> <span class=\"comment\">&lt;!-- Use the netdev name of your SR-IOV devices PF here --&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">forward</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">network</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"（2）根据-xml-定义一个网络，并设置为自动重启\"><a href=\"#（2）根据-xml-定义一个网络，并设置为自动重启\" class=\"headerlink\" title=\"（2）根据 xml 定义一个网络，并设置为自动重启\"></a>（2）根据 xml 定义一个网络，并设置为自动重启</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">virsh net-define eno2_sriov_pool.xml</span><br><span class=\"line\"></span><br><span class=\"line\">virsh net-start eno2_sriov_pool</span><br><span class=\"line\"></span><br><span class=\"line\">virsh net-autostart eno2_sriov_pool</span><br></pre></td></tr></table></figure>\n\n<p>[root@centos7 ~]# virsh net-dumpxml eno2_sriov_pool</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">network</span> <span class=\"attr\">connections</span>=<span class=\"string\">&#x27;1&#x27;</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"tag\">&lt;<span class=\"name\">name</span>&gt;</span>eno2_sriov_pool<span class=\"tag\">&lt;/<span class=\"name\">name</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"tag\">&lt;<span class=\"name\">uuid</span>&gt;</span>e0842451-0137-4255-8783-305ca27f082d<span class=\"tag\">&lt;/<span class=\"name\">uuid</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"tag\">&lt;<span class=\"name\">forward</span> <span class=\"attr\">mode</span>=<span class=\"string\">&#x27;hostdev&#x27;</span> <span class=\"attr\">managed</span>=<span class=\"string\">&#x27;yes&#x27;</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">pf</span> <span class=\"attr\">dev</span>=<span class=\"string\">&#x27;eno2&#x27;</span>/&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">domain</span>=<span class=\"string\">&#x27;0x0000&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0x3b&#x27;</span> <span class=\"attr\">slot</span>=<span class=\"string\">&#x27;0x10&#x27;</span> <span class=\"attr\">function</span>=<span class=\"string\">&#x27;0x1&#x27;</span>/&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">domain</span>=<span class=\"string\">&#x27;0x0000&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0x3b&#x27;</span> <span class=\"attr\">slot</span>=<span class=\"string\">&#x27;0x10&#x27;</span> <span class=\"attr\">function</span>=<span class=\"string\">&#x27;0x3&#x27;</span>/&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">domain</span>=<span class=\"string\">&#x27;0x0000&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0x3b&#x27;</span> <span class=\"attr\">slot</span>=<span class=\"string\">&#x27;0x10&#x27;</span> <span class=\"attr\">function</span>=<span class=\"string\">&#x27;0x5&#x27;</span>/&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">domain</span>=<span class=\"string\">&#x27;0x0000&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0x3b&#x27;</span> <span class=\"attr\">slot</span>=<span class=\"string\">&#x27;0x10&#x27;</span> <span class=\"attr\">function</span>=<span class=\"string\">&#x27;0x7&#x27;</span>/&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"tag\">&lt;/<span class=\"name\">forward</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">network</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"（3）从网络适配器池中分配网卡给虚拟机\"><a href=\"#（3）从网络适配器池中分配网卡给虚拟机\" class=\"headerlink\" title=\"（3）从网络适配器池中分配网卡给虚拟机\"></a>（3）从网络适配器池中分配网卡给虚拟机</h2><p>用这种方法添加 SRIOV 网卡比较简单：</p>\n<p><img src=\"/csr1kv-kvm-CentOS7/sriov-pool-001.png\" alt=\"SRIOV Adapter Pool\"></p>\n<p>按照如上方法添加网卡，等同于以下 xml 配置：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">interface</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;network&#x27;</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"tag\">&lt;<span class=\"name\">mac</span> <span class=\"attr\">address</span>=<span class=\"string\">&#x27;52:54:00:2d:87:99&#x27;</span>/&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"tag\">&lt;<span class=\"name\">source</span> <span class=\"attr\">network</span>=<span class=\"string\">&#x27;eno2_sriov_pool&#x27;</span>/&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"tag\">&lt;<span class=\"name\">model</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;virtio&#x27;</span>/&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">domain</span>=<span class=\"string\">&#x27;0x0000&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0x00&#x27;</span> <span class=\"attr\">slot</span>=<span class=\"string\">&#x27;0x04&#x27;</span> <span class=\"attr\">function</span>=<span class=\"string\">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">interface</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>开机后 dumpxml 如下：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">interface</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;hostdev&#x27;</span> <span class=\"attr\">managed</span>=<span class=\"string\">&#x27;yes&#x27;</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">mac</span> <span class=\"attr\">address</span>=<span class=\"string\">&#x27;52:54:00:2d:87:99&#x27;</span>/&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">driver</span> <span class=\"attr\">name</span>=<span class=\"string\">&#x27;vfio&#x27;</span>/&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">source</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">domain</span>=<span class=\"string\">&#x27;0x0000&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0x3b&#x27;</span> <span class=\"attr\">slot</span>=<span class=\"string\">&#x27;0x10&#x27;</span> <span class=\"attr\">function</span>=<span class=\"string\">&#x27;0x1&#x27;</span>/&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">   <span class=\"tag\">&lt;/<span class=\"name\">source</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">model</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;virtio&#x27;</span>/&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">alias</span> <span class=\"attr\">name</span>=<span class=\"string\">&#x27;hostdev0&#x27;</span>/&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">domain</span>=<span class=\"string\">&#x27;0x0000&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0x00&#x27;</span> <span class=\"attr\">slot</span>=<span class=\"string\">&#x27;0x0f&#x27;</span> <span class=\"attr\">function</span>=<span class=\"string\">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">interface</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"使用-Virt-manager-安装-CSR1000v\"><a href=\"#使用-Virt-manager-安装-CSR1000v\" class=\"headerlink\" title=\"使用 Virt-manager 安装 CSR1000v\"></a>使用 Virt-manager 安装 CSR1000v</h1><p>在 CentOS 图形界面中，打开 Terminal，运行 virt-manager，按照以下步骤创建 CSR1000v；添加网卡，并选择 en2_sriov_pool。</p>\n<p><img src=\"/csr1kv-kvm-CentOS7/virt-manager-1.png\" alt=\"Step 1\"></p>\n<p><img src=\"/csr1kv-kvm-CentOS7/virt-manager-2.png\" alt=\"选择镜像\"></p>\n<p><img src=\"/csr1kv-kvm-CentOS7/virt-manager-3.png\" alt=\"Step 2\"></p>\n<p><img src=\"/csr1kv-kvm-CentOS7/virt-manager-3.png\" alt=\"Step 3\"></p>\n<p><img src=\"/csr1kv-kvm-CentOS7/virt-manager-5.png\" alt=\"Step 4\"></p>\n<p>注：csr1kv-1 的第一个网口选择<strong>macvtap Bridge</strong>模式，这样就无需创建一个 Linux 网桥。但是，csr1kv-1 启动以后不能通过该接口与 Linux 主机进行通信，仅能通过该接口访问 Linux 主机外的网络。</p>\n<p><img src=\"/csr1kv-kvm-CentOS7/virt-manager-6.png\" alt=\"Step 5\"></p>\n<p><img src=\"/csr1kv-kvm-CentOS7/virt-manager-7.png\" alt=\"Step 6\"></p>\n<p>添加完网卡后，点击开始安装，然后就可以关闭虚拟机了。上述操作完成后，virt-manager 会在**&#x2F;etc&#x2F;libvirtd&#x2F;qemu&#x2F;<strong>目录下创建</strong>csr1kv-1.xml**。</p>\n<h1 id=\"KVM-调优配置\"><a href=\"#KVM-调优配置\" class=\"headerlink\" title=\"KVM 调优配置\"></a>KVM 调优配置</h1><p>KVM 的调优比较复杂，主要是 NUMA、内存大页、vCPU PIN 等，参考资料为 Redhat Linux 7 PERFORMANCE TUNING GUIDE。</p>\n<h2 id=\"（1）检查平台的能力\"><a href=\"#（1）检查平台的能力\" class=\"headerlink\" title=\"（1）检查平台的能力\"></a>（1）检查平台的能力</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@centos7 ~]# virsh nodeinfo</span><br><span class=\"line\"></span><br><span class=\"line\">CPU model:           x86_64</span><br><span class=\"line\"></span><br><span class=\"line\">CPU(s):              72</span><br><span class=\"line\"></span><br><span class=\"line\">CPU frequency:       999 MHz</span><br><span class=\"line\"></span><br><span class=\"line\">CPU socket(s):       1</span><br><span class=\"line\"></span><br><span class=\"line\">Core(s) per socket:  18</span><br><span class=\"line\"></span><br><span class=\"line\">Thread(s) per core:  2</span><br><span class=\"line\"></span><br><span class=\"line\">NUMA cell(s):        2</span><br><span class=\"line\"></span><br><span class=\"line\">Memory size:         263665612 KiB</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@centos7 ~]# virsh capabilities</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;capabilities&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"> &lt;host&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">  &lt;uuid&gt;4e53df1f-5b36-6842-99ee-1369d7c68730&lt;/uuid&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">  &lt;cpu&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">   &lt;<span class=\"built_in\">arch</span>&gt;x86_64&lt;/arch&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">   &lt;model&gt;Skylake-Server-IBRS&lt;/model&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">   &lt;vendor&gt;Intel&lt;/vendor&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">   &lt;microcode version=<span class=\"string\">&#x27;33581318&#x27;</span>/&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">   &lt;counter name=<span class=\"string\">&#x27;tsc&#x27;</span> frequency=<span class=\"string\">&#x27;2294597000&#x27;</span> scaling=<span class=\"string\">&#x27;yes&#x27;</span>/&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">   &lt;topology sockets=<span class=\"string\">&#x27;1&#x27;</span> cores=<span class=\"string\">&#x27;18&#x27;</span> threads=<span class=\"string\">&#x27;2&#x27;</span>/&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">……</span><br></pre></td></tr></table></figure>\n\n<p>可检查平台的 CPU 核数、分布，内存的 NUMA 分布等。</p>\n<h2 id=\"（2）NUMA-调优\"><a href=\"#（2）NUMA-调优\" class=\"headerlink\" title=\"（2）NUMA 调优\"></a>（2）NUMA 调优</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@centos7 ~]# numactl --hardware</span><br><span class=\"line\"></span><br><span class=\"line\">available: 2 nodes (0-1)</span><br><span class=\"line\"></span><br><span class=\"line\">node 0 cpus: 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53</span><br><span class=\"line\"></span><br><span class=\"line\">node 0 size: 128491 MB</span><br><span class=\"line\"></span><br><span class=\"line\">node 0 free: 112157 MB</span><br><span class=\"line\"></span><br><span class=\"line\">node 1 cpus: 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71</span><br><span class=\"line\"></span><br><span class=\"line\">node 1 size: 128994 MB</span><br><span class=\"line\"></span><br><span class=\"line\">node 1 free: 124120 MB</span><br><span class=\"line\"></span><br><span class=\"line\">node distances:</span><br><span class=\"line\"></span><br><span class=\"line\">node  0  1</span><br><span class=\"line\"></span><br><span class=\"line\"> 0: 10 21</span><br><span class=\"line\"></span><br><span class=\"line\"> 1: 21 10</span><br></pre></td></tr></table></figure>\n\n<p>两颗 CPU，每颗 CPU 各有 128GB 内存，分别是 node 0 和 node 1。</p>\n<h2 id=\"（3）内存大页-HugePage-以及透明大页\"><a href=\"#（3）内存大页-HugePage-以及透明大页\" class=\"headerlink\" title=\"（3）内存大页 HugePage 以及透明大页\"></a>（3）内存大页 HugePage 以及透明大页</h2><p><code> </code>cat &#x2F;proc&#x2F;meminfo | grep HugePages 查看当前系统有多少个大页：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@centos7 ~]# <span class=\"built_in\">cat</span> /proc/meminfo | grep Huge</span><br><span class=\"line\"></span><br><span class=\"line\">AnonHugePages:   1685504 kB</span><br><span class=\"line\"></span><br><span class=\"line\">HugePages_Total:      64</span><br><span class=\"line\"></span><br><span class=\"line\">HugePages_Free:       60</span><br><span class=\"line\"></span><br><span class=\"line\">HugePages_Rsvd:        0</span><br><span class=\"line\"></span><br><span class=\"line\">HugePages_Surp:        0</span><br><span class=\"line\"></span><br><span class=\"line\">Hugepagesize:    1048576 kB</span><br></pre></td></tr></table></figure>\n\n<p>在系统运行时修改大页数量：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@centos7 ~]# <span class=\"built_in\">cat</span> /sys/devices/system/node/node0/hugepages/hugepages-1048576kB/nr_hugepages</span><br><span class=\"line\"></span><br><span class=\"line\">16</span><br><span class=\"line\"></span><br><span class=\"line\">[root@centos7 ~]# <span class=\"built_in\">echo</span> 32 &gt; /sys/devices/system/node/node0/hugepages/hugepages-1048576kB/nr_hugepages</span><br><span class=\"line\"></span><br><span class=\"line\">[root@centos7 ~]# <span class=\"built_in\">echo</span> 32 &gt; /sys/devices/system/node/node1/hugepages/hugepages-1048576kB/nr_hugepages</span><br><span class=\"line\"></span><br><span class=\"line\">[root@centos7 ~]#</span><br><span class=\"line\"></span><br><span class=\"line\">[root@centos7 ~]# numastat -cm | egrep <span class=\"string\">&#x27;Node|Huge&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">`                 `Node 0 Node 1  Total</span><br><span class=\"line\"></span><br><span class=\"line\">AnonHugePages     10962   1528  12490</span><br><span class=\"line\"></span><br><span class=\"line\">HugePages_Total   32768  32768  65536</span><br><span class=\"line\"></span><br><span class=\"line\">HugePages_Free    32768  32768  65536</span><br><span class=\"line\"></span><br><span class=\"line\">HugePages_Surp        0      0      0</span><br></pre></td></tr></table></figure>\n\n<p>检查透明大页参数，在 CentOS7 上缺省开启；开启了透明大页，不影响静态大页的使用。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cat</span> /sys/kernel/mm/transparent_hugepage/enabled</span><br><span class=\"line\"></span><br><span class=\"line\">[always] madvise never</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"（4）vCPU-钉选\"><a href=\"#（4）vCPU-钉选\" class=\"headerlink\" title=\"（4）vCPU 钉选\"></a>（4）vCPU 钉选</h2><p>设置 CPU Affinity 的好处是提高 CPU 缓存效率，避免进程在多个 CPU 核之间跳跃，切换 CPU 核均会导致缓存中的数据无效，缓存命中率大幅降低，导致数据获取的开销居高不下，损失性能。</p>\n<p><strong>virsh vcpuinfo csr1kv-1</strong> 可以查看 vCPU 的分配。</p>\n<h2 id=\"（5）编辑-CSR-1000v-的-XML-调优参数\"><a href=\"#（5）编辑-CSR-1000v-的-XML-调优参数\" class=\"headerlink\" title=\"（5）编辑 CSR 1000v 的 XML 调优参数\"></a>（5）编辑 CSR 1000v 的 XML 调优参数</h2><p>virsh edit csr1kv-1 可以编辑 XML 的参数，如下：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">memoryBacking</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">hugepages</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">page</span> <span class=\"attr\">size</span>=<span class=\"string\">&#x27;1048576&#x27;</span> <span class=\"attr\">unit</span>=<span class=\"string\">&#x27;KiB&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">hugepages</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">locked</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">nosharepages</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">memoryBacking</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">vcpu</span> <span class=\"attr\">placement</span>=<span class=\"string\">&#x27;static&#x27;</span>&gt;</span>8<span class=\"tag\">&lt;/<span class=\"name\">vcpu</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">cputune</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">vcpupin</span> <span class=\"attr\">vcpu</span>=<span class=\"string\">&#x27;0&#x27;</span> <span class=\"attr\">cpuset</span>=<span class=\"string\">&#x27;1&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">vcpupin</span> <span class=\"attr\">vcpu</span>=<span class=\"string\">&#x27;1&#x27;</span> <span class=\"attr\">cpuset</span>=<span class=\"string\">&#x27;2&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">vcpupin</span> <span class=\"attr\">vcpu</span>=<span class=\"string\">&#x27;2&#x27;</span> <span class=\"attr\">cpuset</span>=<span class=\"string\">&#x27;3&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">vcpupin</span> <span class=\"attr\">vcpu</span>=<span class=\"string\">&#x27;3&#x27;</span> <span class=\"attr\">cpuset</span>=<span class=\"string\">&#x27;4&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">vcpupin</span> <span class=\"attr\">vcpu</span>=<span class=\"string\">&#x27;4&#x27;</span> <span class=\"attr\">cpuset</span>=<span class=\"string\">&#x27;5&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">vcpupin</span> <span class=\"attr\">vcpu</span>=<span class=\"string\">&#x27;5&#x27;</span> <span class=\"attr\">cpuset</span>=<span class=\"string\">&#x27;6&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">vcpupin</span> <span class=\"attr\">vcpu</span>=<span class=\"string\">&#x27;6&#x27;</span> <span class=\"attr\">cpuset</span>=<span class=\"string\">&#x27;7&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">vcpupin</span> <span class=\"attr\">vcpu</span>=<span class=\"string\">&#x27;7&#x27;</span> <span class=\"attr\">cpuset</span>=<span class=\"string\">&#x27;8&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">emulatorpin</span> <span class=\"attr\">cpuset</span>=<span class=\"string\">&#x27;45-52&#x27;</span>/&gt;</span> <span class=\"comment\">&lt;!-- If Hyper-threading were enabled --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">cputune</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">numatune</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">memory</span> <span class=\"attr\">mode</span>=<span class=\"string\">&#x27;strict&#x27;</span> <span class=\"attr\">nodeset</span>=<span class=\"string\">&#x27;0&#x27;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">numatune</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">cpu</span> <span class=\"attr\">mode</span>=<span class=\"string\">&#x27;host-passthrough&#x27;</span> <span class=\"attr\">check</span>=<span class=\"string\">&#x27;none&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">memballoon</span> <span class=\"attr\">model</span>=<span class=\"string\">&#x27;none&#x27;</span>/&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>注：**<emulatorpin cpuset='37-44'/>** 参数，仅当 Hyper-Threating 开启时使用；有一些平台并未关闭超线程，例如 Cisco 专门的 NFV 平台 CSP。通过 virsh chapabilities 查看 siblings&#x3D;’1,37’，当 core 1 设置为 vcpupin 时，core 37 应设置到 emulatorpin cpuset 中。</p>\n<p>以下关于 CPU 和内存的参数设定建议来自于<a href=\"https://libvirt.org/formatdomain.html\">https://libvirt.org/formatdomain.html</a> 和 <a href=\"https://libvirt.org/kbase/kvm-realtime.html\">https://libvirt.org/kbase/kvm-realtime.html</a></p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">domain</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;kvm&#x27;</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">name</span>&gt;</span>csr1kv-1<span class=\"tag\">&lt;/<span class=\"name\">name</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">uuid</span>&gt;</span>59581018-6387-49df-ab09-2bcf40fc12ba<span class=\"tag\">&lt;/<span class=\"name\">uuid</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">memory</span> <span class=\"attr\">unit</span>=<span class=\"string\">&#x27;KiB&#x27;</span>&gt;</span>8388608<span class=\"tag\">&lt;/<span class=\"name\">memory</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">currentMemory</span> <span class=\"attr\">unit</span>=<span class=\"string\">&#x27;KiB&#x27;</span>&gt;</span>8388608<span class=\"tag\">&lt;/<span class=\"name\">currentMemory</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">memoryBacking</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">hugepages</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">page</span> <span class=\"attr\">size</span>=<span class=\"string\">&#x27;1048576&#x27;</span> <span class=\"attr\">unit</span>=<span class=\"string\">&#x27;KiB&#x27;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">hugepages</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">locked</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">nosharepages</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">memoryBacking</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">vcpu</span> <span class=\"attr\">placement</span>=<span class=\"string\">&#x27;static&#x27;</span>&gt;</span>8<span class=\"tag\">&lt;/<span class=\"name\">vcpu</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">cputune</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">vcpupin</span> <span class=\"attr\">vcpu</span>=<span class=\"string\">&#x27;0&#x27;</span> <span class=\"attr\">cpuset</span>=<span class=\"string\">&#x27;1&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">vcpupin</span> <span class=\"attr\">vcpu</span>=<span class=\"string\">&#x27;1&#x27;</span> <span class=\"attr\">cpuset</span>=<span class=\"string\">&#x27;2&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">vcpupin</span> <span class=\"attr\">vcpu</span>=<span class=\"string\">&#x27;2&#x27;</span> <span class=\"attr\">cpuset</span>=<span class=\"string\">&#x27;3&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">vcpupin</span> <span class=\"attr\">vcpu</span>=<span class=\"string\">&#x27;3&#x27;</span> <span class=\"attr\">cpuset</span>=<span class=\"string\">&#x27;4&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">vcpupin</span> <span class=\"attr\">vcpu</span>=<span class=\"string\">&#x27;4&#x27;</span> <span class=\"attr\">cpuset</span>=<span class=\"string\">&#x27;5&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">vcpupin</span> <span class=\"attr\">vcpu</span>=<span class=\"string\">&#x27;5&#x27;</span> <span class=\"attr\">cpuset</span>=<span class=\"string\">&#x27;6&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">vcpupin</span> <span class=\"attr\">vcpu</span>=<span class=\"string\">&#x27;6&#x27;</span> <span class=\"attr\">cpuset</span>=<span class=\"string\">&#x27;7&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">vcpupin</span> <span class=\"attr\">vcpu</span>=<span class=\"string\">&#x27;7&#x27;</span> <span class=\"attr\">cpuset</span>=<span class=\"string\">&#x27;8&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">emulatorpin</span> <span class=\"attr\">cpuset</span>=<span class=\"string\">&#x27;37-44&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">cputune</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">numatune</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">memory</span> <span class=\"attr\">mode</span>=<span class=\"string\">&#x27;strict&#x27;</span> <span class=\"attr\">nodeset</span>=<span class=\"string\">&#x27;0&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">numatune</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">os</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">type</span> <span class=\"attr\">arch</span>=<span class=\"string\">&#x27;x86_64&#x27;</span> <span class=\"attr\">machine</span>=<span class=\"string\">&#x27;pc-i440fx-rhel7.0.0&#x27;</span>&gt;</span>hvm<span class=\"tag\">&lt;/<span class=\"name\">type</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">boot</span> <span class=\"attr\">dev</span>=<span class=\"string\">&#x27;hd&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">os</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">features</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">acpi</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">apic</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">features</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">cpu</span> <span class=\"attr\">mode</span>=<span class=\"string\">&#x27;host-passthrough&#x27;</span> <span class=\"attr\">check</span>=<span class=\"string\">&#x27;none&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">clock</span> <span class=\"attr\">offset</span>=<span class=\"string\">&#x27;utc&#x27;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">timer</span> <span class=\"attr\">name</span>=<span class=\"string\">&#x27;rtc&#x27;</span> <span class=\"attr\">tickpolicy</span>=<span class=\"string\">&#x27;catchup&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">timer</span> <span class=\"attr\">name</span>=<span class=\"string\">&#x27;pit&#x27;</span> <span class=\"attr\">tickpolicy</span>=<span class=\"string\">&#x27;delay&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">timer</span> <span class=\"attr\">name</span>=<span class=\"string\">&#x27;hpet&#x27;</span> <span class=\"attr\">present</span>=<span class=\"string\">&#x27;no&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">clock</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">on_poweroff</span>&gt;</span>destroy<span class=\"tag\">&lt;/<span class=\"name\">on_poweroff</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">on_reboot</span>&gt;</span>restart<span class=\"tag\">&lt;/<span class=\"name\">on_reboot</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">on_crash</span>&gt;</span>destroy<span class=\"tag\">&lt;/<span class=\"name\">on_crash</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">pm</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">suspend-to-mem</span> <span class=\"attr\">enabled</span>=<span class=\"string\">&#x27;no&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">suspend-to-disk</span> <span class=\"attr\">enabled</span>=<span class=\"string\">&#x27;no&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">pm</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">devices</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">emulator</span>&gt;</span>/usr/libexec/qemu-kvm<span class=\"tag\">&lt;/<span class=\"name\">emulator</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">disk</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;file&#x27;</span> <span class=\"attr\">device</span>=<span class=\"string\">&#x27;disk&#x27;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">driver</span> <span class=\"attr\">name</span>=<span class=\"string\">&#x27;qemu&#x27;</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;qcow2&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">source</span> <span class=\"attr\">file</span>=<span class=\"string\">&#x27;/home/root/images/csr1000v-universalk9.17.02.01v.qcow2&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">target</span> <span class=\"attr\">dev</span>=<span class=\"string\">&#x27;vda&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;virtio&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">domain</span>=<span class=\"string\">&#x27;0x0000&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0x00&#x27;</span> <span class=\"attr\">slot</span>=<span class=\"string\">&#x27;0x07&#x27;</span> <span class=\"attr\">function</span>=<span class=\"string\">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">disk</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">controller</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;usb&#x27;</span> <span class=\"attr\">index</span>=<span class=\"string\">&#x27;0&#x27;</span> <span class=\"attr\">model</span>=<span class=\"string\">&#x27;ich9-ehci1&#x27;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">domain</span>=<span class=\"string\">&#x27;0x0000&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0x00&#x27;</span> <span class=\"attr\">slot</span>=<span class=\"string\">&#x27;0x05&#x27;</span> <span class=\"attr\">function</span>=<span class=\"string\">&#x27;0x7&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">controller</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">controller</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;usb&#x27;</span> <span class=\"attr\">index</span>=<span class=\"string\">&#x27;0&#x27;</span> <span class=\"attr\">model</span>=<span class=\"string\">&#x27;ich9-uhci1&#x27;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">master</span> <span class=\"attr\">startport</span>=<span class=\"string\">&#x27;0&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">domain</span>=<span class=\"string\">&#x27;0x0000&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0x00&#x27;</span> <span class=\"attr\">slot</span>=<span class=\"string\">&#x27;0x05&#x27;</span> <span class=\"attr\">function</span>=<span class=\"string\">&#x27;0x0&#x27;</span> <span class=\"attr\">multifunction</span>=<span class=\"string\">&#x27;on&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">controller</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">controller</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;usb&#x27;</span> <span class=\"attr\">index</span>=<span class=\"string\">&#x27;0&#x27;</span> <span class=\"attr\">model</span>=<span class=\"string\">&#x27;ich9-uhci2&#x27;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">master</span> <span class=\"attr\">startport</span>=<span class=\"string\">&#x27;2&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">domain</span>=<span class=\"string\">&#x27;0x0000&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0x00&#x27;</span> <span class=\"attr\">slot</span>=<span class=\"string\">&#x27;0x05&#x27;</span> <span class=\"attr\">function</span>=<span class=\"string\">&#x27;0x1&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">controller</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">controller</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;usb&#x27;</span> <span class=\"attr\">index</span>=<span class=\"string\">&#x27;0&#x27;</span> <span class=\"attr\">model</span>=<span class=\"string\">&#x27;ich9-uhci3&#x27;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">master</span> <span class=\"attr\">startport</span>=<span class=\"string\">&#x27;4&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">domain</span>=<span class=\"string\">&#x27;0x0000&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0x00&#x27;</span> <span class=\"attr\">slot</span>=<span class=\"string\">&#x27;0x05&#x27;</span> <span class=\"attr\">function</span>=<span class=\"string\">&#x27;0x2&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">controller</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">controller</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">index</span>=<span class=\"string\">&#x27;0&#x27;</span> <span class=\"attr\">model</span>=<span class=\"string\">&#x27;pci-root&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">controller</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;virtio-serial&#x27;</span> <span class=\"attr\">index</span>=<span class=\"string\">&#x27;0&#x27;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">domain</span>=<span class=\"string\">&#x27;0x0000&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0x00&#x27;</span> <span class=\"attr\">slot</span>=<span class=\"string\">&#x27;0x06&#x27;</span> <span class=\"attr\">function</span>=<span class=\"string\">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">controller</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">interface</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;direct&#x27;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">mac</span> <span class=\"attr\">address</span>=<span class=\"string\">&#x27;52:54:00:36:95:f0&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">source</span> <span class=\"attr\">dev</span>=<span class=\"string\">&#x27;eno1&#x27;</span> <span class=\"attr\">mode</span>=<span class=\"string\">&#x27;bridge&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">model</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;virtio&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">domain</span>=<span class=\"string\">&#x27;0x0000&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0x00&#x27;</span> <span class=\"attr\">slot</span>=<span class=\"string\">&#x27;0x03&#x27;</span> <span class=\"attr\">function</span>=<span class=\"string\">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">interface</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">interface</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;network&#x27;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">mac</span> <span class=\"attr\">address</span>=<span class=\"string\">&#x27;52:54:00:2d:87:99&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">source</span> <span class=\"attr\">network</span>=<span class=\"string\">&#x27;eno2_sriov_pool&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">model</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;virtio&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">domain</span>=<span class=\"string\">&#x27;0x0000&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0x00&#x27;</span> <span class=\"attr\">slot</span>=<span class=\"string\">&#x27;0x04&#x27;</span> <span class=\"attr\">function</span>=<span class=\"string\">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">interface</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">serial</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pty&#x27;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">target</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;isa-serial&#x27;</span> <span class=\"attr\">port</span>=<span class=\"string\">&#x27;0&#x27;</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">model</span> <span class=\"attr\">name</span>=<span class=\"string\">&#x27;isa-serial&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;/<span class=\"name\">target</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">serial</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">console</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pty&#x27;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">target</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;serial&#x27;</span> <span class=\"attr\">port</span>=<span class=\"string\">&#x27;0&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">console</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">channel</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;unix&#x27;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">target</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;virtio&#x27;</span> <span class=\"attr\">name</span>=<span class=\"string\">&#x27;org.qemu.guest_agent.0&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;virtio-serial&#x27;</span> <span class=\"attr\">controller</span>=<span class=\"string\">&#x27;0&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0&#x27;</span> <span class=\"attr\">port</span>=<span class=\"string\">&#x27;1&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">channel</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">channel</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;spicevmc&#x27;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">target</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;virtio&#x27;</span> <span class=\"attr\">name</span>=<span class=\"string\">&#x27;com.redhat.spice.0&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;virtio-serial&#x27;</span> <span class=\"attr\">controller</span>=<span class=\"string\">&#x27;0&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0&#x27;</span> <span class=\"attr\">port</span>=<span class=\"string\">&#x27;2&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">channel</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;tablet&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;usb&#x27;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;usb&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0&#x27;</span> <span class=\"attr\">port</span>=<span class=\"string\">&#x27;1&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">input</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;mouse&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;ps2&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;keyboard&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;ps2&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">graphics</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;spice&#x27;</span> <span class=\"attr\">autoport</span>=<span class=\"string\">&#x27;yes&#x27;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">listen</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;address&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">image</span> <span class=\"attr\">compression</span>=<span class=\"string\">&#x27;off&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">graphics</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">video</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">model</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;qxl&#x27;</span> <span class=\"attr\">ram</span>=<span class=\"string\">&#x27;65536&#x27;</span> <span class=\"attr\">vram</span>=<span class=\"string\">&#x27;65536&#x27;</span> <span class=\"attr\">vgamem</span>=<span class=\"string\">&#x27;16384&#x27;</span> <span class=\"attr\">heads</span>=<span class=\"string\">&#x27;1&#x27;</span> <span class=\"attr\">primary</span>=<span class=\"string\">&#x27;yes&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">domain</span>=<span class=\"string\">&#x27;0x0000&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0x00&#x27;</span> <span class=\"attr\">slot</span>=<span class=\"string\">&#x27;0x02&#x27;</span> <span class=\"attr\">function</span>=<span class=\"string\">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">video</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">redirdev</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;usb&#x27;</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;spicevmc&#x27;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;usb&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0&#x27;</span> <span class=\"attr\">port</span>=<span class=\"string\">&#x27;2&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">redirdev</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">redirdev</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;usb&#x27;</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;spicevmc&#x27;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;usb&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0&#x27;</span> <span class=\"attr\">port</span>=<span class=\"string\">&#x27;3&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">redirdev</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">memballoon</span> <span class=\"attr\">model</span>=<span class=\"string\">&#x27;none&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">rng</span> <span class=\"attr\">model</span>=<span class=\"string\">&#x27;virtio&#x27;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">backend</span> <span class=\"attr\">model</span>=<span class=\"string\">&#x27;random&#x27;</span>&gt;</span>/dev/urandom<span class=\"tag\">&lt;/<span class=\"name\">backend</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">domain</span>=<span class=\"string\">&#x27;0x0000&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0x00&#x27;</span> <span class=\"attr\">slot</span>=<span class=\"string\">&#x27;0x09&#x27;</span> <span class=\"attr\">function</span>=<span class=\"string\">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">rng</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">devices</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">domain</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>上述参数整理自<a href=\"https://www.cisco.com/c/en/us/td/docs/routers/csr1000/software/configuration/b_CSR1000v_Configuration_Guide/b_CSR1000v_Configuration_Guide_chapter_0101.html\">《Cisco CSR 1000v and Cisco ISRv Software Configuration Guide》</a></p>\n<p>完成上述 XML 文件的编辑后，执行</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cd</span> /etc/libvirtd/qemu</span><br><span class=\"line\"></span><br><span class=\"line\">virsh define csr1kv-1.xml</span><br><span class=\"line\"></span><br><span class=\"line\">virsh start csr1kv-1</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"（6）在-KVM-主机上访问-CSR1000v-的-Console\"><a href=\"#（6）在-KVM-主机上访问-CSR1000v-的-Console\" class=\"headerlink\" title=\"（6）在 KVM 主机上访问 CSR1000v 的 Console\"></a>（6）在 KVM 主机上访问 CSR1000v 的 Console</h2><p>在 virt-manager 创建 CSR1000v 虚拟机的时候，缺省会添加一个 Serial Device。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@centos7 qemu]# virsh console 20</span><br><span class=\"line\"></span><br><span class=\"line\">Connected to domain CSR1000v-1</span><br><span class=\"line\"></span><br><span class=\"line\">Escape character is ^]</span><br></pre></td></tr></table></figure>\n\n<p>CSR 1000v 暂时不能通过 Console 配置，需要通过 virt-manager 的图形化界面进行初始化配置。</p>\n<p>vCloud 的 Console 访问正常。</p>\n<h2 id=\"（7）检验-CSR1000v-的调优配置\"><a href=\"#（7）检验-CSR1000v-的调优配置\" class=\"headerlink\" title=\"（7）检验 CSR1000v 的调优配置\"></a>（7）检验 CSR1000v 的调优配置</h2><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@centos7 ~]# virsh list</span><br><span class=\"line\"></span><br><span class=\"line\">Id  Name              State</span><br><span class=\"line\"></span><br><span class=\"line\">----------------------------------------------------</span><br><span class=\"line\"></span><br><span class=\"line\"> 6   csr1kv-1            running</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">[root@centos7 ~]# virsh vcpuinfo 6</span><br><span class=\"line\"></span><br><span class=\"line\">VCPU:      0</span><br><span class=\"line\"></span><br><span class=\"line\">CPU:      1</span><br><span class=\"line\"></span><br><span class=\"line\">State:     running</span><br><span class=\"line\"></span><br><span class=\"line\">CPU time:    34.5s</span><br><span class=\"line\"></span><br><span class=\"line\">CPU Affinity:  -y----------------------------------------------------------------------</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">VCPU:      1</span><br><span class=\"line\"></span><br><span class=\"line\">CPU:      2</span><br><span class=\"line\"></span><br><span class=\"line\">State:     running</span><br><span class=\"line\"></span><br><span class=\"line\">CPU time:    32.0s</span><br><span class=\"line\"></span><br><span class=\"line\">CPU Affinity:  --y---------------------------------------------------------------------</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">VCPU:      2</span><br><span class=\"line\"></span><br><span class=\"line\">CPU:      3</span><br><span class=\"line\"></span><br><span class=\"line\">State:     running</span><br><span class=\"line\"></span><br><span class=\"line\">CPU time:    23.8s</span><br><span class=\"line\"></span><br><span class=\"line\">CPU Affinity:  ---y--------------------------------------------------------------------</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">VCPU:      3</span><br><span class=\"line\"></span><br><span class=\"line\">CPU:      4</span><br><span class=\"line\"></span><br><span class=\"line\">State:     running</span><br><span class=\"line\"></span><br><span class=\"line\">CPU time:    19.8s</span><br><span class=\"line\"></span><br><span class=\"line\">CPU Affinity:  ----y-------------------------------------------------------------------</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">VCPU:      4</span><br><span class=\"line\"></span><br><span class=\"line\">CPU:      5</span><br><span class=\"line\"></span><br><span class=\"line\">State:     running</span><br><span class=\"line\"></span><br><span class=\"line\">CPU time:    23.0s</span><br><span class=\"line\"></span><br><span class=\"line\">CPU Affinity:  -----y------------------------------------------------------------------</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">VCPU:      5</span><br><span class=\"line\"></span><br><span class=\"line\">CPU:      6</span><br><span class=\"line\"></span><br><span class=\"line\">State:     running</span><br><span class=\"line\"></span><br><span class=\"line\">CPU time:    23.4s</span><br><span class=\"line\"></span><br><span class=\"line\">CPU Affinity:  ------y-----------------------------------------------------------------</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">VCPU:      6</span><br><span class=\"line\"></span><br><span class=\"line\">CPU:      7</span><br><span class=\"line\"></span><br><span class=\"line\">State:     running</span><br><span class=\"line\"></span><br><span class=\"line\">CPU time:    28.5s</span><br><span class=\"line\"></span><br><span class=\"line\">CPU Affinity:  -------y----------------------------------------------------------------</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">VCPU:      7</span><br><span class=\"line\"></span><br><span class=\"line\">CPU:      8</span><br><span class=\"line\"></span><br><span class=\"line\">State:     running</span><br><span class=\"line\"></span><br><span class=\"line\">CPU time:    28.2s</span><br><span class=\"line\"></span><br><span class=\"line\">CPU Affinity:  --------y---------------------------------------------------------------</span><br></pre></td></tr></table></figure>\n\n<p>以上显示 CSR1000v 虚拟机的 CPU 亲和性在 1-8 核上。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@centos7 ~]# numastat -c qemu-kvm</span><br><span class=\"line\"></span><br><span class=\"line\">Per-node process memory usage (<span class=\"keyword\">in</span> MBs) <span class=\"keyword\">for</span> PID 46895 (qemu-kvm)</span><br><span class=\"line\"></span><br><span class=\"line\">     Node 0 Node 1 Total</span><br><span class=\"line\"></span><br><span class=\"line\">     ------ ------ -----</span><br><span class=\"line\"></span><br><span class=\"line\">Huge    8192   0 8192</span><br><span class=\"line\"></span><br><span class=\"line\">Heap    118   0  118</span><br><span class=\"line\"></span><br><span class=\"line\">Stack     0   0   0</span><br><span class=\"line\"></span><br><span class=\"line\">Private   144   7  151</span><br><span class=\"line\"></span><br><span class=\"line\">------- ------ ------ -----</span><br><span class=\"line\"></span><br><span class=\"line\">Total   8455   7 8461</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>以上显示，内存主要使用 Node 0。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@centos7 ~]# numastat -vm -p 13428 | grep HugePage</span><br><span class=\"line\"></span><br><span class=\"line\">AnonHugePages       956.00     494.00     1450.00</span><br><span class=\"line\"></span><br><span class=\"line\">HugePages_Total     16384.00    16384.00    32768.00</span><br><span class=\"line\"></span><br><span class=\"line\">HugePages_Free      8192.00    16384.00    24576.00</span><br><span class=\"line\"></span><br><span class=\"line\">HugePages_Surp       0.00       0.00      0.00</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"（8）在-CSR1KV-上检查虚拟网卡\"><a href=\"#（8）在-CSR1KV-上检查虚拟网卡\" class=\"headerlink\" title=\"（8）在 CSR1KV 上检查虚拟网卡\"></a>（8）在 CSR1KV 上检查虚拟网卡</h2><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">csr1kv-1#show platform software vnic-if interface-mapping</span><br><span class=\"line\"></span><br><span class=\"line\">-------------------------------------------------------------</span><br><span class=\"line\"></span><br><span class=\"line\"> Interface Name    Driver Name     Mac Addr</span><br><span class=\"line\"></span><br><span class=\"line\">-------------------------------------------------------------</span><br><span class=\"line\"></span><br><span class=\"line\"> GigabitEthernet2    net_ixgbe_vf    5254.002d.8799</span><br><span class=\"line\"></span><br><span class=\"line\"> GigabitEthernet1    net_virtio     5254.0036.95f0</span><br></pre></td></tr></table></figure>\n\n<p>上述驱动名显示为 net_ixgbe_vf 表明该虚拟网卡是一个 SR-IOV 池中分配的 VF 设备。</p>\n<h1 id=\"Linux-上抓取虚拟网卡的报文（参考）\"><a href=\"#Linux-上抓取虚拟网卡的报文（参考）\" class=\"headerlink\" title=\"Linux 上抓取虚拟网卡的报文（参考）\"></a>Linux 上抓取虚拟网卡的报文（参考）</h1><p>查找虚拟机的网卡列表</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@centos7 ~]# virsh domiflist 10</span><br><span class=\"line\"></span><br><span class=\"line\">Interface Type    Source   Model    MAC</span><br><span class=\"line\"></span><br><span class=\"line\">-------------------------------------------------------</span><br><span class=\"line\"></span><br><span class=\"line\">vnet0   network  default  virtio   52:54:00:38:71:4a</span><br><span class=\"line\"></span><br><span class=\"line\">macvtap0  direct   eno1    virtio   52:54:00:b2:70:90</span><br><span class=\"line\"></span><br><span class=\"line\">vnet5   bridge   net-br1  virtio   52:54:00:69:93:23</span><br></pre></td></tr></table></figure>\n\n<p>抓取 vnet5 的报文</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@centos7 ~]# tcpdump -i vnet5 -w ping.pcap</span><br><span class=\"line\"></span><br><span class=\"line\">tcpdump: listening on vnet5, link-type EN10MB (Ethernet), capture size 262144 bytes</span><br><span class=\"line\"></span><br><span class=\"line\">^C49 packets captured</span><br><span class=\"line\"></span><br><span class=\"line\">51 packets received by filter</span><br><span class=\"line\"></span><br><span class=\"line\">0 packets dropped by kernel</span><br></pre></td></tr></table></figure>\n\n<p>注：VF 如果被分配给虚拟机，那么在 Linux 主机里，通过 ip link 则查看不到该设备，无法通过上述办法抓包。</p>\n<h1 id=\"CSR-1000v-的初始化配置及-Smart-License-注册\"><a href=\"#CSR-1000v-的初始化配置及-Smart-License-注册\" class=\"headerlink\" title=\"CSR 1000v 的初始化配置及 Smart License 注册\"></a>CSR 1000v 的初始化配置及 Smart License 注册</h1><h2 id=\"（1）CSR-1000v-初始化配置示例\"><a href=\"#（1）CSR-1000v-初始化配置示例\" class=\"headerlink\" title=\"（1）CSR 1000v 初始化配置示例\"></a>（1）CSR 1000v 初始化配置示例</h2><p>部分节略，其他为缺省配置。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">CSR1000v-1#show sdwan running-config</span><br><span class=\"line\"></span><br><span class=\"line\">system</span><br><span class=\"line\"></span><br><span class=\"line\"> system-ip       1.1.10.1</span><br><span class=\"line\"></span><br><span class=\"line\"> site-id        101</span><br><span class=\"line\"></span><br><span class=\"line\"> sp-organization-name CiscoBJ</span><br><span class=\"line\"></span><br><span class=\"line\"> organization-name   CiscoBJ</span><br><span class=\"line\"></span><br><span class=\"line\"> vbond 10.75.58.51 port 12346</span><br><span class=\"line\"></span><br><span class=\"line\">!</span><br><span class=\"line\"></span><br><span class=\"line\">hostname CSR1000v-1</span><br><span class=\"line\"></span><br><span class=\"line\">username admin privilege 15 secret 9 $9$4/QL2V2K4/6H1k$XUmRNf.T7t3KDOj/FmoNexpEypCxr482dExXHDnohSI</span><br><span class=\"line\"></span><br><span class=\"line\">ip name-server 64.104.123.245</span><br><span class=\"line\"></span><br><span class=\"line\">ip route 0.0.0.0 0.0.0.0 10.75.59.1</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">interface GigabitEthernet1</span><br><span class=\"line\"></span><br><span class=\"line\"> no shutdown</span><br><span class=\"line\"></span><br><span class=\"line\"> arp timeout 1200</span><br><span class=\"line\"></span><br><span class=\"line\"> ip address 10.75.59.35 255.255.255.0</span><br><span class=\"line\"></span><br><span class=\"line\"> no ip redirects</span><br><span class=\"line\"></span><br><span class=\"line\"> ip mtu  1500</span><br><span class=\"line\"></span><br><span class=\"line\"> mtu 1500</span><br><span class=\"line\"></span><br><span class=\"line\"> negotiation auto</span><br><span class=\"line\"></span><br><span class=\"line\">exit</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">interface Tunnel1</span><br><span class=\"line\"></span><br><span class=\"line\"> no shutdown</span><br><span class=\"line\"></span><br><span class=\"line\"> ip unnumbered GigabitEthernet1</span><br><span class=\"line\"></span><br><span class=\"line\"> no ip redirects</span><br><span class=\"line\"></span><br><span class=\"line\"> ipv6 unnumbered GigabitEthernet1</span><br><span class=\"line\"></span><br><span class=\"line\"> no ipv6 redirects</span><br><span class=\"line\"></span><br><span class=\"line\"> tunnel source GigabitEthernet1</span><br><span class=\"line\"></span><br><span class=\"line\"> tunnel mode sdwan</span><br><span class=\"line\"></span><br><span class=\"line\">exit</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">clock timezone CST 8 0</span><br><span class=\"line\"></span><br><span class=\"line\">ntp server 10.75.58.1 version 4</span><br><span class=\"line\"></span><br><span class=\"line\">sdwan</span><br><span class=\"line\"></span><br><span class=\"line\"> interface GigabitEthernet1</span><br><span class=\"line\"></span><br><span class=\"line\"> tunnel-interface</span><br><span class=\"line\"></span><br><span class=\"line\">  encapsulation ipsec</span><br><span class=\"line\"></span><br><span class=\"line\">  allow-service sshd</span><br><span class=\"line\"></span><br><span class=\"line\"> exit</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"（2）常用命令\"><a href=\"#（2）常用命令\" class=\"headerlink\" title=\"（2）常用命令\"></a>（2）常用命令</h2><ul>\n<li>show sdwan control local-properties</li>\n<li>show sdwan control connections</li>\n<li>show sdwan control connection-history</li>\n<li>show sdwan running-config</li>\n<li>show sdwan bfd sessions</li>\n<li>show sdwan omp peers</li>\n<li>show sdwan omp routes</li>\n</ul>\n<h2 id=\"（3）CSR-1000v-Smart-License-注册\"><a href=\"#（3）CSR-1000v-Smart-License-注册\" class=\"headerlink\" title=\"（3）CSR 1000v Smart License 注册\"></a>（3）CSR 1000v Smart License 注册</h2><p>CSR 1000v 默认限速为 250Mbps，需要注册 Smart License 才可解开限速。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">CSR1000v-2#show platform hardware throughput level</span><br><span class=\"line\"></span><br><span class=\"line\">The current throughput level is 250000 kb/s</span><br></pre></td></tr></table></figure>\n\n<p>注册 Smart License 需要满足以下条件：</p>\n<p>1、 CSR 1000v 已经注册到 vManage，控制面连接正常；</p>\n<p>2、 配置 ip http client source-interface GigabitEthernet2</p>\n<p>3、 sdwan interface GigabitEthernet2 tunnel-interface allow-service all —针对 16.12.x 版本；在新版本中仅需要 allow https</p>\n<p>4、 CSR 1000v 可以访问 URL：<a href=\"https://tools.cisco.com/its/service/oddce/services/DDCEService\">https://tools.cisco.com/its/service/oddce/services/DDCEService</a></p>\n<p>允许访问 114.114.114.114，CSR 1000v 可解析域名 tools.cisco.com</p>\n<p>替代办法，增加一条命令 ip host tools.cisco.com 72.163.4.38</p>\n<p>执行 license smart register idtoken xxxxxx 进行注册</p>\n<p>show license status 查看注册结果</p>\n<p>注册完成后，系统解开限速：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">CSR1000v-1#show platform hardware throughput level</span><br><span class=\"line\"></span><br><span class=\"line\">The current throughput level is 200000000 kb/s</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"性能和相关限制\"><a href=\"#性能和相关限制\" class=\"headerlink\" title=\"性能和相关限制\"></a>性能和相关限制</h1><h2 id=\"（1）SRIOV-的性能\"><a href=\"#（1）SRIOV-的性能\" class=\"headerlink\" title=\"（1）SRIOV 的性能\"></a>（1）SRIOV 的性能</h2><p>在上述 CSR1KV-1 安装好后，使用测试仪进行性能测试，测试条件中，设置丢包率为 0%，其性能如下：</p>\n<table>\n<thead>\n<tr>\n<th align=\"left\">Packet Site</th>\n<th align=\"center\">SDWAN Performance (Mbps)</th>\n<th align=\"center\">CEF Performance (Mbps)</th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"left\">128Byte</td>\n<td align=\"center\">800</td>\n<td align=\"center\">2843.75</td>\n</tr>\n<tr>\n<td align=\"left\">256Byte</td>\n<td align=\"center\">1431.26</td>\n<td align=\"center\">6500.00</td>\n</tr>\n<tr>\n<td align=\"left\">512Byte</td>\n<td align=\"center\">2581.26</td>\n<td align=\"center\">10578.13</td>\n</tr>\n<tr>\n<td align=\"left\">1024Byte</td>\n<td align=\"center\">3731.26</td>\n<td align=\"center\">15500.00</td>\n</tr>\n<tr>\n<td align=\"left\">1400Byte</td>\n<td align=\"center\">4306.26</td>\n<td align=\"center\">18171.88</td>\n</tr>\n</tbody></table>\n<p><img src=\"/csr1kv-kvm-CentOS7/line-chart-009.png\" alt=\"性能现状图表\"></p>\n<p>注：上述测试结果非官方结果，不同服务器和网卡可能测试结果有区别，上述性能数据仅供参考。</p>\n<h2 id=\"（2）SRIOV-的限制\"><a href=\"#（2）SRIOV-的限制\" class=\"headerlink\" title=\"（2）SRIOV 的限制\"></a>（2）SRIOV 的限制</h2><p>SRIOV 的主要限制是每一个 VF 设备支持的 VLAN 数，ixgbevf 所支持的最大 VLAN 数为 64；因此，在 CSR1KV 中对应的虚拟接口配置的活跃子接口数最大为 64。</p>\n<p>配置指南中有关于 SRIOV 子接口限制的说明：</p>\n<p><code> </code><a href=\"https://www.cisco.com/c/en/us/td/docs/routers/csr1000/software/configuration/b_CSR1000v_Configuration_Guide/b_CSR1000v_Configuration_Guide_chapter_0101.html\">Cisco CSR 1000v and Cisco ISRv Software Configuration Guide</a>:</p>\n<blockquote>\n<p>SR-IOV (ixgbevf)</p>\n<p>Maximum VLANs: The maximum number of VLANs supported on PF is 64. Together, all VFs can have a total of 64 VLANs. (Intel limitation.)</p>\n<p>SR-IOV (i40evf)</p>\n<p>Maximum VLANs: The maximum number of VLANs supported on PF is 512. Together, all VFs can have a total of 512 VLANs. (Intel limitation.) Per-VF resources are managed by the PF (host) device driver.</p>\n</blockquote>\n<h1 id=\"附录\"><a href=\"#附录\" class=\"headerlink\" title=\"附录\"></a>附录</h1><h2 id=\"（1）Virt-manager-设置虚机的-CPU-模式说明\"><a href=\"#（1）Virt-manager-设置虚机的-CPU-模式说明\" class=\"headerlink\" title=\"（1）Virt-manager 设置虚机的 CPU 模式说明\"></a>（1）Virt-manager 设置虚机的 CPU 模式说明</h2><p>Libvirt 主要支持三种 CPU mode：</p>\n<ul>\n<li>host-passthrough: libvirt 令 KVM 把宿主机的 CPU 指令集全部透传给虚拟机。因此虚拟机能够最大限度的使用宿主机 CPU 指令集，故性能是最好的。但是在热迁移时，它要求目的节点的 CPU 和源节点的一致。</li>\n<li>host-model: libvirt 根据当前宿主机 CPU 指令集从配置文件 &#x2F;usr&#x2F;share&#x2F;libvirt&#x2F;cpu_map.xml 选择一种最相配的 CPU 型号。在这种 mode 下，虚拟机的指令集往往比宿主机少，性能相对 host-passthrough 要差一点，但是热迁移时，它允许目的节点 CPU 和源节点的存在一定的差异。</li>\n<li>custom: 这种模式下虚拟机 CPU 指令集数最少，故性能相对最差，但是它在热迁移时跨不同型号 CPU 的能力最强。此外，custom 模式下支持用户添加额外的指令集。</li>\n</ul>\n<p>三种 mode 的性能排序是：host-passthrough &gt; host-model &gt; custom</p>\n<p>实际性能差异不大：100%&gt; 95.84%&gt;94.73%</p>\n<p>引自：<a href=\"http://wsfdl.com/openstack/2018/01/02/libvirt_cpu_mode.html\">http://wsfdl.com/openstack/2018/01/02/libvirt_cpu_mode.html</a></p>\n<h2 id=\"（2）有关网卡模式的说明\"><a href=\"#（2）有关网卡模式的说明\" class=\"headerlink\" title=\"（2）有关网卡模式的说明\"></a>（2）有关网卡模式的说明</h2><p>使用 virt-manager 创建虚拟机，在添加网卡时，有 3 中选择，分别是 e1000, rtl8139, virtio。</p>\n<p>“rtl8139”这个网卡模式是 qemu-kvm 默认的模拟网卡类型，RTL8139 是 Realtek 半导体公司的一个 10&#x2F;100M 网卡系列，是曾经非常流行（当然现在看来有点古老）且兼容性好的网卡，几乎所有的现代操作系统都对 RTL8139 网卡驱动的提供支持。</p>\n<p>“e1000”系列提供 Intel e1000 系列的网卡模拟，纯的 QEMU（非 qemu-kvm）默认就是提供 Intel e1000 系列的虚拟网卡。</p>\n<p>“virtio” 类型是 qemu-kvm 对半虚拟化 IO（virtio）驱动的支持。</p>\n<p>这三个网卡的最大区别(此处指最需要关注的地方)是速度：</p>\n<ul>\n<li><p>rtl8139 10&#x2F;100Mb&#x2F;s</p>\n</li>\n<li><p>e1000 1Gb&#x2F;s</p>\n</li>\n<li><p>virtio 10Gb&#x2F;s</p>\n</li>\n</ul>\n<p>注意 virtio 是唯一可以达到 10Gb&#x2F;s 的。</p>\n<p>virtio 是一种 I&#x2F;O 半虚拟化解决方案，是一套通用 I&#x2F;O 设备虚拟化的程序，是对半虚拟化 Hypervisor 中的一组通用 I&#x2F;O 设备的抽象。提供了一套上层应用与各 Hypervisor 虚拟化设备（KVM，Xen，VMware 等）之间的通信框架和编程接口，减少跨平台所带来的兼容性问题，大大提高驱动程序开发效率。</p>\n<h2 id=\"（3）有关-MACVTAP\"><a href=\"#（3）有关-MACVTAP\" class=\"headerlink\" title=\"（3）有关 MACVTAP\"></a>（3）有关 MACVTAP</h2><p>以下内容来自：<a href=\"https://www.ibm.com/developerworks/cn/linux/1312_xiawc_linuxvirtnet/index.html\">https://www.ibm.com/developerworks/cn/linux/1312_xiawc_linuxvirtnet/index.html</a></p>\n<p>MACVTAP 的实现基于传统的 MACVLAN。和 TAP 设备一样，每一个 MACVTAP 设备拥有一个对应的 Linux 字符设备，并拥有和 TAP 设备一样的 IOCTL 接口，因此能直接被 KVM&#x2F;Qemu 使用，方便地完成网络数据交换工作。引入 MACVTAP 设备的目标是：简化虚拟化环境中的交换网络，代替传统的 Linux TAP 设备加 Bridge 设备组合，同时支持新的虚拟化网络技术，如 802.1 Qbg。</p>\n<p>MACVTAP 设备和 VLAN 设备类似，是以一对多的母子关系出现的。在一个母设备上可以创建多个 MACVTAP 子设备，一个 MACVTAP 设备只有一个母设备，MACVTAP 子设备可以做为母设备，再一次嵌套的创建 MACVTAP 子设备。母子设备之间被隐含的桥接起来，母设备相当于现实世界中的交换机 TRUNK 口。实际上当 MACVTAP 设备被创建并且模式不为 Passthrough 时，内核隐含的创建了 MACVLAN 网络，完成转发功能。MACVTAP 设备有四种工作模式：Bridge、VEPA、Private，Passthrough。</p>\n<p>Bridge 模式下，它完成与 Bridge 设备类似功能，数据可以在属于同一个母设备的子设备间交换转发，虚拟机相当于简单接入了一个交换机。当前的 Linux 实现有一个缺陷，此模式下 MACVTAP 子设备无法和 Linux Host 通讯，即虚拟机无法和 Host 通讯。—-经验证，属实。</p>\n<p>Passthrough 模式下，内核的 MACVLAN 数据处理逻辑被跳过，硬件决定数据如何处理，从而释放了 Host CPU 资源。</p>\n<p><img src=\"/csr1kv-kvm-CentOS7/macvtap-ibm.png\" alt=\"MACVTAP 直通 vs PCI 直通\"></p>\n<p>MACVTAP Passthrough 概念与 PCI Passthrough 概念不同，上图详细解释了两种情况的区别。</p>\n<p>PCI Passthrough 针对的是任意 PCI 设备，不一定是网络设备，目的是让 Guest OS 直接使用 Host 上的 PCI 硬件以提高效率。以 X86 平台为例，数据将通过需要硬件支持的 VT-D 技术从 Guest OS 直接传递到 Host 硬件上。这样做固然效率很高，但因为模拟器失去了对虚拟硬件的控制，难以同步不同 Host 上的硬件状态，因此当前在使用 PCI Passthrough 的情况下难以做动态迁移。</p>\n<p>MACVTAP Passthrough 仅仅针对 MACVTAP 网络设备，目的是绕过内核里 MACVTAP 的部分软件处理过程，转而交给硬件处理。在虚拟化条件下，数据还是会先到达模拟器 I&#x2F;O 层，再转发到硬件上。这样做效率有损失，但模拟器仍然控制虚拟硬件的状态及数据的走向，可以做动态迁移。</p>\n<h2 id=\"（4）SR-IOV-介绍\"><a href=\"#（4）SR-IOV-介绍\" class=\"headerlink\" title=\"（4）SR-IOV 介绍\"></a>（4）SR-IOV 介绍</h2><p>如果网卡支持 SRIOV，请使用 SRIOV PCI Passthrough。</p>\n<p><img src=\"/csr1kv-kvm-CentOS7/nic-type-010.png\" alt=\"nic-type-010\"></p>\n<p>软件模拟是通过 Hypervisor 层模拟虚拟网卡，实现与物理设备完全一样的接口，虚拟机操作系统无须修改就能直接驱动虚拟网卡，其最大的缺点是性能相对较差；</p>\n<p>网卡直通支持虚拟机绕过 Hypervisor 层，直接访问物理 I&#x2F;O 设备，具有最高的性能，但是在同一时刻物理 I&#x2F;O 设备只能被一个虚拟机独享；</p>\n<p>SR-IOV 是 Intel 在 2007 年提出的解决虚拟化网络 I&#x2F;O 的硬件技术方案，该技术不仅能够继承网卡直通的高性能优势，而且同时支持物理 I&#x2F;O 设备的跨虚拟机共享，具有较好的应用前景。</p>\n<p>原文链接：<a href=\"https://blog.csdn.net/lsz137105/article/details/100752930\">https://blog.csdn.net/lsz137105/article/details/100752930</a></p>\n<p>SR-IOV（Single Root I&#x2F;O Virtualization）是一个将 PCIe 设备（如网卡）共享给虚拟机的标准，通过为虚拟机提供独立的内存空间、中断、DMA 流，来绕过 VMM 实现数据访问。</p>\n<p>SR-IOV 引入了两种 PCIe functions：</p>\n<ul>\n<li>PF（Physical Function）：包含完整的 PCIe 功能，包括 SR-IOV 的扩张能力，该功能用于 SR-IOV 的配置和管理。</li>\n<li>VF（Virtual Function）：包含轻量级的 PCIe 功能。每一个 VF 有它自己独享的 PCI 配置区域，并且可能与其他 VF 共享着同一个物理资源。</li>\n</ul>\n<p>SR-IOV 网卡通过将 SR-IOV 功能集成到物理网卡上，将单一的物理网卡虚拟成多个 VF 接口，每个 VF 接口都有单独的虚拟 PCIe 通道，这些虚拟的 PCIe 通道共用物理网卡的 PCIe 通道。每个虚拟机可占用一个或多个 VF 接口，这样虚拟机就可以直接访问自己的 VF 接口，而不需要 Hypervisor 的协调干预，从而大幅提升网络吞吐性能。</p>\n<h2 id=\"（5）探索虚拟机进程\"><a href=\"#（5）探索虚拟机进程\" class=\"headerlink\" title=\"（5）探索虚拟机进程\"></a>（5）探索虚拟机进程</h2><p>每一个客户机就是宿主机中的一个 QEMU 进程，而一个客户机的多个 vCPU 就是一个 QEMU 进程中的多个线程。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@centos7 ~]# ps -ef | grep qemu</span><br><span class=\"line\"></span><br><span class=\"line\">qemu      52595      1 99 10:37 ?        01:24:12 /usr/libexec/qemu-kvm -name csr1kv-1 -S -machine pc-i440fx-rhel7.0.0,accel=kvm,usb=off,dump-guest-core=off,mem-merge=off -cpu host -m 8192 -mem-prealloc -mem-path /dev/hugepages/libvirt/qemu/7-csr1kv-1 -realtime mlock=on -smp 8,sockets=8,cores=1,threads=1 -uuid 59581018-6387-49df-ab09-2bcf40fc12ba -no-user-config -nodefaults -chardev socket,<span class=\"built_in\">id</span>=charmonitor,path=/var/lib/libvirt/qemu/domain-7-csr1kv-1/monitor.sock,server,nowait -mon chardev=charmonitor,<span class=\"built_in\">id</span>=monitor,mode=control -rtc base=utc,driftfix=slew -global kvm-pit.lost_tick_policy=delay -no-hpet -no-shutdown -global PIIX4_PM.disable_s3=1 -global PIIX4_PM.disable_s4=1 -boot strict=on -device piix3-usb-uhci,<span class=\"built_in\">id</span>=usb,bus=pci.0,addr=0x1.0x2 -device virtio-serial-pci,<span class=\"built_in\">id</span>=virtio-serial0,bus=pci.0,addr=0x6 -drive file=/home/root/images/csr1000v-universalk9.17.02.01v.qcow2,format=qcow2,<span class=\"keyword\">if</span>=none,<span class=\"built_in\">id</span>=drive-virtio-disk0 -device virtio-blk-pci,scsi=off,bus=pci.0,addr=0x7,drive=drive-virtio-disk0,<span class=\"built_in\">id</span>=virtio-disk0,bootindex=1 -netdev tap,fd=26,<span class=\"built_in\">id</span>=hostnet0,vhost=on,vhostfd=28 -device virtio-net-pci,netdev=hostnet0,<span class=\"built_in\">id</span>=net0,mac=52:54:00:36:95:f0,bus=pci.0,addr=0x3 -chardev pty,<span class=\"built_in\">id</span>=charserial0 -device isa-serial,chardev=charserial0,<span class=\"built_in\">id</span>=serial0 -chardev socket,<span class=\"built_in\">id</span>=charchannel0,path=/var/lib/libvirt/qemu/channel/target/domain-7-csr1kv-1/org.qemu.guest_agent.0,server,nowait -device virtserialport,bus=virtio-serial0.0,nr=1,chardev=charchannel0,<span class=\"built_in\">id</span>=channel0,name=org.qemu.guest_agent.0 -chardev spicevmc,<span class=\"built_in\">id</span>=charchannel1,name=vdagent -device virtserialport,bus=virtio-serial0.0,nr=2,chardev=charchannel1,<span class=\"built_in\">id</span>=channel1,name=com.redhat.spice.0 -spice port=5900,addr=127.0.0.1,disable-ticketing,image-compression=off,seamless-migration=on -vga qxl -global qxl-vga.ram_size=67108864 -global qxl-vga.vram_size=67108864 -global qxl-vga.vgamem_mb=16 -global qxl-vga.max_outputs=1 -device vfio-pci,host=1d:00.0,<span class=\"built_in\">id</span>=hostdev1,bus=pci.0,addr=0x8 -device vfio-pci,host=3b:10.1,<span class=\"built_in\">id</span>=hostdev0,bus=pci.0,addr=0x4 -msg timestamp=on</span><br></pre></td></tr></table></figure>\n\n<p>使用 virsh 命令或 virt-manager 开启虚拟机，是通过调用&#x2F;usr&#x2F;libexec&#x2F;qemu-kvm 并附带虚拟配置的参数，来开启 qemu-kvm 的进程。可以看到上述的参数是非常复杂的，libvirt 提供 XML 参数进行简化。</p>\n<p>ps -efL | grep qemu 可以列出所有的线程，但是输出篇幅很长，不在此列出；使用 pstree 可列出其父进程、线程关系，如下：</p>\n<p><img src=\"/csr1kv-kvm-CentOS7/pstree-011.png\" alt=\"Pstree\"></p>\n<p>virt-top 可查看虚机运行状态和资源利用率：</p>\n<p>[root@centos7 ~]# virt-top -1</p>\n<p><img src=\"/csr1kv-kvm-CentOS7/virt-top-012.png\" alt=\"Virt-top\"></p>\n<h1 id=\"参考资料连接\"><a href=\"#参考资料连接\" class=\"headerlink\" title=\"参考资料连接\"></a>参考资料连接</h1><ul>\n<li><a href=\"https://cloud.tencent.com/developer/article/1703094\">https://cloud.tencent.com/developer/article/1703094</a></li>\n<li><a href=\"https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html-single/performance_tuning_guide/index\">https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html-single/performance_tuning_guide/index</a></li>\n<li><a href=\"https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/7/html-single/virtualization_tuning_and_optimization_guide/index\">https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/7/html-single/virtualization_tuning_and_optimization_guide/index</a></li>\n<li><a href=\"https://computingforgeeks.com/how-to-create-and-configure-bridge-networking-for-kvm-in-linux/\">https://computingforgeeks.com/how-to-create-and-configure-bridge-networking-for-kvm-in-linux/</a></li>\n<li><a href=\"https://software.intel.com/content/www/us/en/develop/articles/configure-sr-iov-network-virtual-functions-in-linux-kvm.html\">https://software.intel.com/content/www/us/en/develop/articles/configure-sr-iov-network-virtual-functions-in-linux-kvm.html</a></li>\n</ul>\n","length":7624,"excerpt":"","more":"<p>作者：Rao Weibo</p>\n<p>版本：1.0</p>\n<p>更新日期：20210203</p>\n<p>本文提供在 CentOS 7 版本上安装 KVM，并安装和设置 CSR 1000v&#x2F;Catalyst 8000v 的指南，内容包括 SRIOV，KVM 调优以及 CSR1KV 初始化配置等内容。</p>\n<h1 id=\"CentOS7-安装及设置\"><a href=\"#CentOS7-安装及设置\" class=\"headerlink\" title=\"CentOS7 安装及设置\"></a>CentOS7 安装及设置</h1><h2 id=\"（1）BIOS-设置建议\"><a href=\"#（1）BIOS-设置建议\" class=\"headerlink\" title=\"（1）BIOS 设置建议\"></a>（1）BIOS 设置建议</h2><table>\n<thead>\n<tr>\n<th align=\"left\">Configuration</th>\n<th align=\"left\">Recommended Setting</th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"left\">Intel Hyper-Threading Technology</td>\n<td align=\"left\">Disabled</td>\n</tr>\n<tr>\n<td align=\"left\">Number of Enable Cores</td>\n<td align=\"left\">ALL</td>\n</tr>\n<tr>\n<td align=\"left\">Execute Disable</td>\n<td align=\"left\">Enabled</td>\n</tr>\n<tr>\n<td align=\"left\">Intel VT</td>\n<td align=\"left\">Enabled</td>\n</tr>\n<tr>\n<td align=\"left\">Intel VT-D</td>\n<td align=\"left\">Enabled</td>\n</tr>\n<tr>\n<td align=\"left\">Intel VT-D coherency support</td>\n<td align=\"left\">Enabled</td>\n</tr>\n<tr>\n<td align=\"left\">Intel VT-D ATS support</td>\n<td align=\"left\">Enabled</td>\n</tr>\n<tr>\n<td align=\"left\">CPU Performance</td>\n<td align=\"left\">High throughput</td>\n</tr>\n<tr>\n<td align=\"left\">Hardware Perfetcher</td>\n<td align=\"left\">Disabled</td>\n</tr>\n<tr>\n<td align=\"left\">Adjacent Cache Line Prefetcher</td>\n<td align=\"left\">Disabled</td>\n</tr>\n<tr>\n<td align=\"left\">DCU Streamer Prefetch</td>\n<td align=\"left\">Disable</td>\n</tr>\n<tr>\n<td align=\"left\">Power Technology</td>\n<td align=\"left\">Custom</td>\n</tr>\n<tr>\n<td align=\"left\">Enhanced Intel Speedstep Technology</td>\n<td align=\"left\">Disabled</td>\n</tr>\n<tr>\n<td align=\"left\">Intel Turbo Boost Technology</td>\n<td align=\"left\">Enabled</td>\n</tr>\n<tr>\n<td align=\"left\">Processor Power State C6</td>\n<td align=\"left\">Disabled</td>\n</tr>\n<tr>\n<td align=\"left\">Processor Power State C1 Enhanced</td>\n<td align=\"left\">Disabled</td>\n</tr>\n<tr>\n<td align=\"left\">Frequency Poor Override</td>\n<td align=\"left\">Enabled</td>\n</tr>\n<tr>\n<td align=\"left\">P-State Coordination</td>\n<td align=\"left\">HW_ALL</td>\n</tr>\n<tr>\n<td align=\"left\">Energy Performance</td>\n<td align=\"left\">Performance</td>\n</tr>\n</tbody></table>\n<p>以上建议来自 CSR 1000v 的安装指南。</p>\n<h2 id=\"（2）CentOS-7-的安装\"><a href=\"#（2）CentOS-7-的安装\" class=\"headerlink\" title=\"（2）CentOS 7 的安装\"></a>（2）CentOS 7 的安装</h2><p>在安装的时候选择</p>\n<ul>\n<li>Server with GUI</li>\n<li>Virtualization Client</li>\n<li>Virtualization Hypervisor</li>\n<li>Virtualization Tools</li>\n</ul>\n<p>启动完毕以后关闭 selinux，重启生效。</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sed -i &#x27;s/SELINUX=enforcing/SELINUX=disabled/g&#x27; /etc/selinux/config</span><br><span class=\"line\"></span><br><span class=\"line\">getenforce\t\t//结果为：Enforcing（开启状态）disabled(关闭状态)</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">安装完后，SSH登录可能显示中文，可修改 .bash_profile</span></span><br><span class=\"line\"></span><br><span class=\"line\">LANG=&quot;en_US.UTF-8&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">export LANG</span><br><span class=\"line\"></span><br><span class=\"line\">source .bash_profile</span><br><span class=\"line\"></span><br><span class=\"line\">egrep -o &#x27;(vmx|svm)&#x27; /proc/cpuinfo | sort | uniq</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">注：在生产环境中，需要在服务器连接的交换机以及出口防火墙上做好安全策略。</span></span><br><span class=\"line\"></span><br><span class=\"line\">systemctl stop firewalld</span><br><span class=\"line\"></span><br><span class=\"line\">systemctl disable firewalld</span><br></pre></td></tr></table></figure>\n\n<p>本文档采用 NetworkManager 配置，故在此并不停用 NetworkManager。</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat /etc/sysctl.conf</span><br><span class=\"line\"></span><br><span class=\"line\">net.ipv4.ip_forward = 1</span><br><span class=\"line\"></span><br><span class=\"line\">net.bridge.bridge-nf-call-ip6tables = 0</span><br><span class=\"line\"></span><br><span class=\"line\">net.bridge.bridge-nf-call-iptables = 0</span><br><span class=\"line\"></span><br><span class=\"line\">net.bridge.bridge-nf-call-arptables = 0</span><br></pre></td></tr></table></figure>\n\n<p>检查 KVM 组件版本：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@centos7 ~]# libvirtd -V</span><br><span class=\"line\"></span><br><span class=\"line\">libvirtd (libvirt) 4.5.0</span><br><span class=\"line\"></span><br><span class=\"line\">[root@centos7 ~]# /usr/libexec/qemu-kvm --version</span><br><span class=\"line\"></span><br><span class=\"line\">QEMU emulator version 1.5.3 (qemu-kvm-1.5.3-173.el7_8.3), Copyright (c) 2003-2008 Fabrice Bellard</span><br><span class=\"line\"></span><br><span class=\"line\">[root@centos7 ~]# virt-manager --version</span><br><span class=\"line\"></span><br><span class=\"line\">1.5.0</span><br><span class=\"line\"></span><br><span class=\"line\">[root@centos7 ~]# modinfo kvm-intel</span><br><span class=\"line\"></span><br><span class=\"line\">filename:       /lib/modules/3.10.0-1127.18.2.el7.x86_64/kernel/arch/x86/kvm/kvm-intel.ko.xz</span><br><span class=\"line\"></span><br><span class=\"line\">[root@centos7 ~]# modinfo ixgbevf</span><br><span class=\"line\"></span><br><span class=\"line\">filename:       /lib/modules/3.10.0-1127.18.2.el7.x86_64/kernel/drivers/net/ethernet/intel/ixgbevf/ixgbevf.ko.xz</span><br><span class=\"line\"></span><br><span class=\"line\">version:        4.1.0-k-rh7.7</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"（3）创建本地-Yum-源（可选）\"><a href=\"#（3）创建本地-Yum-源（可选）\" class=\"headerlink\" title=\"（3）创建本地 Yum 源（可选）\"></a>（3）创建本地 Yum 源（可选）</h2><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">1、备份本地/etc/yum.repos.d 目录下的yum源</span></span><br><span class=\"line\"></span><br><span class=\"line\">cd /etc/yum.repos.d/</span><br><span class=\"line\"></span><br><span class=\"line\">mkdir bak</span><br><span class=\"line\"></span><br><span class=\"line\">mv C* bak/</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">2、上传CentOS-7-x86_64-Everything-2009.iso镜像到/opt</span></span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">3、挂载镜像</span></span><br><span class=\"line\"></span><br><span class=\"line\">mkdir -p /media/cdrom</span><br><span class=\"line\"></span><br><span class=\"line\">mount -t iso9660 -o loop /opt/CentOS-7-x86_64-Everything-2009.iso /media/cdrom/</span><br><span class=\"line\"></span><br><span class=\"line\">mount\t\t//查看挂载信息</span><br><span class=\"line\"></span><br><span class=\"line\">df -h</span><br><span class=\"line\"></span><br><span class=\"line\">vi /etc/fstab</span><br><span class=\"line\"></span><br><span class=\"line\">/opt/CentOS-7-x86_64-Everything-2009.iso    /media/cdrom    iso9660 loop 0 0</span><br><span class=\"line\"></span><br><span class=\"line\">tail -1 /etc/fstab\t\t//查看是否写入/etc/fstab</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">4、配置本地yum源</span></span><br><span class=\"line\"></span><br><span class=\"line\">cd /etc/yum.repos.d/</span><br><span class=\"line\"></span><br><span class=\"line\">vi local.repo</span><br><span class=\"line\"></span><br><span class=\"line\">[local]</span><br><span class=\"line\"></span><br><span class=\"line\">name=local</span><br><span class=\"line\"></span><br><span class=\"line\">baseurl=file:///media/cdrom\t   //前面的file://是协议,后面的/media/cdrom是光盘挂载点</span><br><span class=\"line\"></span><br><span class=\"line\">gpgcheck=0\t\t//1使用公钥验证rpm包的正确性,0不验证</span><br><span class=\"line\"></span><br><span class=\"line\">enabled=1\t\t//1启用yum源,0禁用yum源</span><br><span class=\"line\"></span><br><span class=\"line\">yum install -y numactl telnet</span><br></pre></td></tr></table></figure>\n\n<p>运行 virt-manager 启动图形化界面。</p>\n<p>如果对 virsh CLI 命令熟悉，可以使用 virsh 命令创建虚拟机。</p>\n<h2 id=\"（4）服务器网卡配置—NetworkManager-配置\"><a href=\"#（4）服务器网卡配置—NetworkManager-配置\" class=\"headerlink\" title=\"（4）服务器网卡配置—NetworkManager 配置\"></a>（4）服务器网卡配置—NetworkManager 配置</h2><p>在终端界面，可以通过 nmtui 打开图形化界面进行设置；以下使用 nmcli 进行设置。</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nmcli connection add con-name eno1 type ethernet autoconnect yes ifname eno1</span><br><span class=\"line\"></span><br><span class=\"line\">nmcli connection modify eno1 ipv4.method manual ipv4.addresses 10.75.58.43/24 ipv4.gateway 10.75.58.1 ipv4.dns 64.104.123.245</span><br><span class=\"line\"></span><br><span class=\"line\">nmcli connection up eno1</span><br><span class=\"line\"></span><br><span class=\"line\">nmcli connection show eno1</span><br><span class=\"line\"></span><br><span class=\"line\">ping 10.75.58.1</span><br></pre></td></tr></table></figure>\n\n<p>上述命令完成后，在&#x2F;etc&#x2F;sysconfig&#x2F;network-scripts 中会生成网卡的 ifcfg 配置文件。</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat /etc/sysconfig/network-scripts/ifcfg-eno1</span><br><span class=\"line\"></span><br><span class=\"line\">HWADDR=70:7D:B9:59:5B:AE</span><br><span class=\"line\"></span><br><span class=\"line\">TYPE=Ethernet</span><br><span class=\"line\"></span><br><span class=\"line\">PROXY_METHOD=none</span><br><span class=\"line\"></span><br><span class=\"line\">BROWSER_ONLY=no</span><br><span class=\"line\"></span><br><span class=\"line\">BOOTPROTO=none</span><br><span class=\"line\"></span><br><span class=\"line\">IPADDR=10.75.58.43</span><br><span class=\"line\"></span><br><span class=\"line\">PREFIX=24</span><br><span class=\"line\"></span><br><span class=\"line\">GATEWAY=10.75.58.1</span><br><span class=\"line\"></span><br><span class=\"line\">DNS1=64.104.123.245</span><br><span class=\"line\"></span><br><span class=\"line\">DEFROUTE=yes</span><br><span class=\"line\"></span><br><span class=\"line\">IPV4_FAILURE_FATAL=no</span><br><span class=\"line\"></span><br><span class=\"line\">IPV6INIT=yes</span><br><span class=\"line\"></span><br><span class=\"line\">IPV6_AUTOCONF=yes</span><br><span class=\"line\"></span><br><span class=\"line\">IPV6_DEFROUTE=yes</span><br><span class=\"line\"></span><br><span class=\"line\">IPV6_FAILURE_FATAL=no</span><br><span class=\"line\"></span><br><span class=\"line\">IPV6_ADDR_GEN_MODE=stable-privacy</span><br><span class=\"line\"></span><br><span class=\"line\">NAME=eno1</span><br><span class=\"line\"></span><br><span class=\"line\">UUID=2a1c8b39-7f44-321b-a65f-a93e70ab0616</span><br><span class=\"line\"></span><br><span class=\"line\">ONBOOT=yes</span><br><span class=\"line\"></span><br><span class=\"line\">AUTOCONNECT_PRIORITY=-999</span><br><span class=\"line\"></span><br><span class=\"line\">DEVICE=eno1</span><br></pre></td></tr></table></figure>\n\n<p>此时，可以将 network.service 停止和关闭。</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl stop network</span><br><span class=\"line\"></span><br><span class=\"line\">systemctl disable network</span><br></pre></td></tr></table></figure>\n\n<p>注意，如果 NetworkManager 未设置妥当，执行 systemctl stop network 后，会导致服务器无法管理。</p>\n<p>准备开启 SRIOV 的网卡设置，以 eno2 为例：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nmcli connection add con-name eno2 <span class=\"built_in\">type</span> ethernet autoconnect <span class=\"built_in\">yes</span> ifname eno2</span><br><span class=\"line\"></span><br><span class=\"line\">nmcli connection modify eno2 ethernet.mtu 9216 ipv4.method disabled</span><br><span class=\"line\"></span><br><span class=\"line\">nmcli connection up eno2</span><br><span class=\"line\"></span><br><span class=\"line\">nmcli connection show eno2</span><br><span class=\"line\"></span><br><span class=\"line\">ip <span class=\"built_in\">link</span> show dev eno2</span><br></pre></td></tr></table></figure>\n\n<p>注：上述 MTU 值设置为 9216 是借鉴自 Cisco NFVIS 平台，如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">CSP5228-1# show pnic-detail mtu</span><br><span class=\"line\"></span><br><span class=\"line\">Name          MTU</span><br><span class=\"line\"></span><br><span class=\"line\">=============================</span><br><span class=\"line\"></span><br><span class=\"line\">eth0-1        9216</span><br><span class=\"line\"></span><br><span class=\"line\">eth0-2        9216</span><br><span class=\"line\"></span><br><span class=\"line\">eth1-1        9216</span><br><span class=\"line\"></span><br><span class=\"line\">eth1-2        9216</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"（5）配置-Linux-网桥-（可选）\"><a href=\"#（5）配置-Linux-网桥-（可选）\" class=\"headerlink\" title=\"（5）配置 Linux 网桥 （可选）\"></a>（5）配置 Linux 网桥 （可选）</h2><p>网桥 br1 配置示例：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nmcli connection add con-name br1 <span class=\"built_in\">type</span> bridge autoconnect <span class=\"built_in\">yes</span> ipv4.method disabled ethernet.mtu 9216 ifname br1</span><br><span class=\"line\"></span><br><span class=\"line\">nmcli connection up br1</span><br><span class=\"line\"></span><br><span class=\"line\">ip <span class=\"built_in\">link</span> show dev br1</span><br></pre></td></tr></table></figure>\n\n<p>网桥 br1 的物理网卡配置</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nmcli connection add con-name eno5 <span class=\"built_in\">type</span> ethernet autoconnect <span class=\"built_in\">yes</span> ifname eno5</span><br><span class=\"line\"></span><br><span class=\"line\">nmcli connection modify eno5 ethernet.mtu 9216 ipv4.method disabled master br1</span><br><span class=\"line\"></span><br><span class=\"line\">nmcli connection up eno5</span><br><span class=\"line\"></span><br><span class=\"line\">ip <span class=\"built_in\">link</span> show dev eno5</span><br></pre></td></tr></table></figure>\n\n<p>创建 net-br1 网络</p>\n<p>[root@centos7 ~]# cat net-br1.xml</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">network</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"tag\">&lt;<span class=\"name\">name</span>&gt;</span>net-br1<span class=\"tag\">&lt;/<span class=\"name\">name</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"tag\">&lt;<span class=\"name\">forward</span> <span class=\"attr\">mode</span>=<span class=\"string\">&quot;bridge&quot;</span>/&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"tag\">&lt;<span class=\"name\">bridge</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;br1&quot;</span>/&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">network</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@centos7 ~]# virsh net-define net-br1.xml</span><br><span class=\"line\"></span><br><span class=\"line\">Network net-br1 defined from net-br1.xml</span><br><span class=\"line\"></span><br><span class=\"line\">[root@centos7 ~]# virsh net-start net-br1</span><br><span class=\"line\"></span><br><span class=\"line\">Network net-br1 started</span><br><span class=\"line\"></span><br><span class=\"line\">[root@centos7 ~]# virsh net-autostart net-br1</span><br><span class=\"line\"></span><br><span class=\"line\">Network net-br1 marked as autostarted</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"配置-SR-IOV\"><a href=\"#配置-SR-IOV\" class=\"headerlink\" title=\"配置 SR-IOV\"></a>配置 SR-IOV</h1><h2 id=\"（1）检查网卡对-SR-IOV-的支持，并配置网卡\"><a href=\"#（1）检查网卡对-SR-IOV-的支持，并配置网卡\" class=\"headerlink\" title=\"（1）检查网卡对 SR-IOV 的支持，并配置网卡\"></a>（1）检查网卡对 SR-IOV 的支持，并配置网卡</h2><p>可使用 lshw 和 lspci 检查网卡对 SR-IOV 的支持</p>\n<p>lshw -c network -businfo</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Bus info          Device      Class          Description</span><br><span class=\"line\"></span><br><span class=\"line\">========================================================</span><br><span class=\"line\"></span><br><span class=\"line\">pci@0000:1d:00.0  eno5        network        VIC Ethernet NIC</span><br><span class=\"line\"></span><br><span class=\"line\">pci@0000:1d:00.1  eno6        network        VIC Ethernet NIC</span><br><span class=\"line\"></span><br><span class=\"line\">pci@0000:1d:00.2  eno7        network        VIC Ethernet NIC</span><br><span class=\"line\"></span><br><span class=\"line\">pci@0000:1d:00.3  eno8        network        VIC Ethernet NIC</span><br><span class=\"line\"></span><br><span class=\"line\">pci@0000:3b:00.0  eno1        network        Ethernet Controller 10G X550T</span><br><span class=\"line\"></span><br><span class=\"line\">pci@0000:3b:00.1  eno2        network        Ethernet Controller 10G X550T</span><br></pre></td></tr></table></figure>\n\n<p>lspci -vv -s 3b:00.1 | grep -A 5 -i SR-IOV</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Capabilities: [160 v1] Single Root I/O Virtualization (SR-IOV)</span><br><span class=\"line\"></span><br><span class=\"line\">  IOVCap:\tMigration-, Interrupt Message Number: 000</span><br><span class=\"line\"></span><br><span class=\"line\">\tIOVCtl:\tEnable+ Migration- Interrupt- MSE+ ARIHierarchy-</span><br><span class=\"line\"></span><br><span class=\"line\">\tIOVSta:\tMigration-</span><br><span class=\"line\"></span><br><span class=\"line\">\tInitial VFs: 64, Total VFs: 64, Number of VFs: 8, Function Dependency Link: 01</span><br><span class=\"line\"></span><br><span class=\"line\">\tVF offset: 128, stride: 2, Device ID: 1565</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"（2）设置启动参数\"><a href=\"#（2）设置启动参数\" class=\"headerlink\" title=\"（2）设置启动参数\"></a>（2）设置启动参数</h2><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vi /etc/default/grub</span><br><span class=\"line\"></span><br><span class=\"line\">GRUB_CMDLINE_LINUX=&quot;crashkernel=auto spectre_v2=retpoline rd.lvm.lv=centos/root rd.lvm.lv=centos/swap rhgb quiet hugepagesz=1G hugepages=32 default_hugepagesz=1G intel_iommu=on iommu=pt isolcpus=1-8,37-44&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">注：页面数字不要过大，不然启动失败，如果后续不够，可以在运行时添加。</span><br><span class=\"line\"></span><br><span class=\"line\">grub2-mkconfig -o /boot/grub2/grub.cfg</span><br><span class=\"line\"></span><br><span class=\"line\">grub2-mkconfig -o /boot/efi/EFI/centos/grub.cfg</span><br><span class=\"line\"></span><br><span class=\"line\">iommu=pt 参数是将SRIOV设备支持PCI Passthrough</span><br></pre></td></tr></table></figure>\n\n<p>重启后验证</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat /proc/cmdline |grep intel_iommu=on</span><br><span class=\"line\"></span><br><span class=\"line\">dmesg |grep -e DMAR -e IOMMU</span><br><span class=\"line\"></span><br><span class=\"line\">dmesg | grep -e DMAR -e IOMMU -e AMD-Vi</span><br></pre></td></tr></table></figure>\n\n<ul>\n<li><strong>default_hugepagesz&#x3D;1G hugepagesz&#x3D;1G hugepages&#x3D;32</strong> 参数设置主机在启动时分配 32 个 1GB 的内存大页，这些是静态内存大页。 CSR 1000v 虚拟机将试用这些静态大页以获得最优性能。</li>\n<li><strong>isolcpus&#x3D;1-8,37-44</strong> 参数设置的作用是隔离 1-8，37-44 的 CPU 核，使其独立于内核的平衡调度算法，也就是内核本身不会将进程分配到被隔离的 CPU。之后我们可将指定的进程 CSR 1000v 虚拟机绑定到被隔离的 CPU 上运行，让进程独占 CPU，使其实时性可得到一定程度的提高。</li>\n</ul>\n<p>可参考 这个章节获取主机 CPU 核的相关信息。</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@centos7 ~]# cat /proc/cmdline |grep intel_iommu=on</span><br><span class=\"line\"></span><br><span class=\"line\">BOOT_IMAGE=/vmlinuz-3.10.0-1127.el7.x86_64 root=/dev/mapper/centos-root ro crashkernel=auto spectre_v2=retpoline rd.lvm.lv=centos/root rd.lvm.lv=centos/swap rhgb quiet hugepagesz=1G hugepages=32 default_hugepagesz=1G intel_iommu=on iommu=pt LANG=en_US.UTF-8</span><br><span class=\"line\"></span><br><span class=\"line\">[root@centos7 ~]# dmesg |grep -e DMAR -e IOMMU</span><br><span class=\"line\"></span><br><span class=\"line\">[    0.000000] ACPI: DMAR 000000005d6f5d70 00250 (v01 Cisco0 CiscoUCS 00000001 INTL 20091013)</span><br><span class=\"line\"></span><br><span class=\"line\">[    0.000000] DMAR: IOMMU enabled</span><br></pre></td></tr></table></figure>\n\n<p>查看隔离的 CPU 核以及所有的 CPU 核。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@centos7 ~]# <span class=\"built_in\">cat</span> /sys/devices/system/cpu/isolated</span><br><span class=\"line\"></span><br><span class=\"line\">1-8,37-44</span><br><span class=\"line\"></span><br><span class=\"line\">[root@centos7 ~]# <span class=\"built_in\">cat</span> /sys/devices/system/cpu/present</span><br><span class=\"line\"></span><br><span class=\"line\">0-71</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"（3）通过-nmcli-持久化-VFs-配置\"><a href=\"#（3）通过-nmcli-持久化-VFs-配置\" class=\"headerlink\" title=\"（3）通过 nmcli 持久化 VFs 配置\"></a>（3）通过 nmcli 持久化 VFs 配置</h2><p>nmcli 可以设置网卡的 sriov 参数，如下：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nmcli connection modify eno2 sriov.total-vfs 4</span><br></pre></td></tr></table></figure>\n\n<p>还可以设置每一个 VF 设备的 MAC 地址，便于管理：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nmcli connection modify eno2 sriov.vfs <span class=\"string\">&#x27;0 mac=8E:DF:08:C1:D1:DE trust=true, 1 mac=5A:B9:2F:99:A6:CE trust=true, 2 mac=46:78:69:E3:71:3D trust=true, 3 mac=7E:A7:DB:3B:1B:B3 trust=true&#x27;</span></span><br></pre></td></tr></table></figure>\n\n<p>执行上述命令后：</p>\n<p>cat &#x2F;etc&#x2F;sysconfig&#x2F;network-scripts&#x2F;ifcfg-eno2</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">TYPE=Ethernet</span><br><span class=\"line\"></span><br><span class=\"line\">NAME=eno2</span><br><span class=\"line\"></span><br><span class=\"line\">UUID=64ffa204-0158-40c8-ba86-2b7aebf27619</span><br><span class=\"line\"></span><br><span class=\"line\">DEVICE=eno2</span><br><span class=\"line\"></span><br><span class=\"line\">ONBOOT=<span class=\"built_in\">yes</span></span><br><span class=\"line\"></span><br><span class=\"line\">MTU=9216</span><br><span class=\"line\"></span><br><span class=\"line\">HWADDR=70:7D:B9:59:5B:AF</span><br><span class=\"line\"></span><br><span class=\"line\">PROXY_METHOD=none</span><br><span class=\"line\"></span><br><span class=\"line\">BROWSER_ONLY=no</span><br><span class=\"line\"></span><br><span class=\"line\">IPV6INIT=no</span><br><span class=\"line\"></span><br><span class=\"line\">SRIOV_TOTAL_VFS=4</span><br><span class=\"line\"></span><br><span class=\"line\">SRIOV_VF0=<span class=\"string\">&quot;mac=8E:DF:08:C1:D1:DE trust=true&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">SRIOV_VF1=<span class=\"string\">&quot;mac=5A:B9:2F:99:A6:CE trust=true&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">SRIOV_VF2=<span class=\"string\">&quot;mac=46:78:69:E3:71:3D trust=true&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">SRIOV_VF3=<span class=\"string\">&quot;mac=7E:A7:DB:3B:1B:B3 trust=true&quot;</span></span><br></pre></td></tr></table></figure>\n\n<p>重启后，检查 dmesg：</p>\n<p>dmesg | grep -i vf | grep -i eno2</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[   11.953333] ixgbe 0000:3b:00.1 eno2: SR-IOV enabled with 4 VFs</span><br><span class=\"line\"></span><br><span class=\"line\">[   12.541801] ixgbe 0000:3b:00.1: setting MAC 8e:<span class=\"built_in\">df</span>:08:c1:d1:de on VF 0</span><br><span class=\"line\"></span><br><span class=\"line\">[   12.541805] ixgbe 0000:3b:00.1: Reload the VF driver to make this change effective.</span><br><span class=\"line\"></span><br><span class=\"line\">[   12.541841] ixgbe 0000:3b:00.1 eno2: VF 0 is trusted</span><br><span class=\"line\"></span><br><span class=\"line\">[   12.541846] ixgbe 0000:3b:00.1: setting MAC 5a:b9:2f:99:a6:ce on VF 1</span><br><span class=\"line\"></span><br><span class=\"line\">[   12.541850] ixgbe 0000:3b:00.1: Reload the VF driver to make this change effective.</span><br><span class=\"line\"></span><br><span class=\"line\">[   12.541883] ixgbe 0000:3b:00.1 eno2: VF 1 is trusted</span><br><span class=\"line\"></span><br><span class=\"line\">[   12.541887] ixgbe 0000:3b:00.1: setting MAC 46:78:69:e3:71:3d on VF 2</span><br><span class=\"line\"></span><br><span class=\"line\">[   12.541891] ixgbe 0000:3b:00.1: Reload the VF driver to make this change effective.</span><br><span class=\"line\"></span><br><span class=\"line\">[   12.541923] ixgbe 0000:3b:00.1 eno2: VF 2 is trusted</span><br><span class=\"line\"></span><br><span class=\"line\">[   12.541928] ixgbe 0000:3b:00.1: setting MAC 7e:a7:db:3b:1b:b3 on VF 3</span><br><span class=\"line\"></span><br><span class=\"line\">[   12.541932] ixgbe 0000:3b:00.1: Reload the VF driver to make this change effective.</span><br><span class=\"line\"></span><br><span class=\"line\">[   12.541965] ixgbe 0000:3b:00.1 eno2: VF 3 is trusted</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"（4）检查-VF\"><a href=\"#（4）检查-VF\" class=\"headerlink\" title=\"（4）检查 VF\"></a>（4）检查 VF</h2><p>可通过 lspci 和 ip link 检查 VF，如下：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@centos7 ~]# lspci | grep -i Virtual</span><br><span class=\"line\"></span><br><span class=\"line\">[root@centos7 ~]# ip <span class=\"built_in\">link</span> show | grep -B2 vf</span><br></pre></td></tr></table></figure>\n\n<p>寻找 Physical Function 和 Virtual Function 之间的对应关系：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@centos7 ~]# <span class=\"built_in\">ls</span> -l /sys/class/net/eno1/device/ | grep virtfn</span><br></pre></td></tr></table></figure>\n\n<p>VF 被创建后，NetworkManager 自动给新的设备创建 Connection，可以修改名称，如下：</p>\n<p>nmcli connection</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">NAME        UUID                                  TYPE      DEVICE</span><br><span class=\"line\"></span><br><span class=\"line\">eno1        2a1c8b39-7f44-321b-a65f-a93e70ab0616  ethernet  eno1</span><br><span class=\"line\"></span><br><span class=\"line\">eno2        64ffa204-0158-40c8-ba86-2b7aebf27619  ethernet  eno2</span><br><span class=\"line\"></span><br><span class=\"line\">enp59s16f1  19c28a93-aa36-38e6-a556-55a922a0a332  ethernet  enp59s16f1</span><br><span class=\"line\"></span><br><span class=\"line\">enp59s16f3  428d9707-1515-3475-b356-7eb229c3f937  ethernet  enp59s16f3</span><br><span class=\"line\"></span><br><span class=\"line\">enp59s16f5  21a8dd5f-239f-37b2-9b09-24ce0e7413bc  ethernet  enp59s16f5</span><br><span class=\"line\"></span><br><span class=\"line\">enp59s16f7  0ca0da65-64c4-314d-89a4-4213f9e4f478  ethernet  enp59s16f7</span><br></pre></td></tr></table></figure>\n\n<p>修改名称：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nmcli connection modify uuid 19c28a93-aa36-38e6-a556-55a922a0a332 connection.id enp59s16f1</span><br></pre></td></tr></table></figure>\n\n<p>修改 MTU 值，并禁用 IPv4 和 IPv6，网卡启动更快</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nmcli connection modify enp59s16f1 ifname enp59s16f1 ipv4.method disabled ipv6.method ignore ethernet.mtu 9216 ethernet.mac-address <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">nmcli connection up enp59s16f1</span><br><span class=\"line\"></span><br><span class=\"line\">nmcli connection show enp59s16f1</span><br></pre></td></tr></table></figure>\n\n<p>上述命令生成的 ifcfg 配置文件如下：</p>\n<p>[root@centos7 ~]# cat &#x2F;etc&#x2F;sysconfig&#x2F;network-scripts&#x2F;ifcfg-enp59s16f1</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">TYPE=Ethernet</span><br><span class=\"line\"></span><br><span class=\"line\">PROXY_METHOD=none</span><br><span class=\"line\"></span><br><span class=\"line\">BROWSER_ONLY=no</span><br><span class=\"line\"></span><br><span class=\"line\">DEFROUTE=<span class=\"built_in\">yes</span></span><br><span class=\"line\"></span><br><span class=\"line\">IPV4_FAILURE_FATAL=no</span><br><span class=\"line\"></span><br><span class=\"line\">IPV6INIT=no</span><br><span class=\"line\"></span><br><span class=\"line\">IPV6_AUTOCONF=no</span><br><span class=\"line\"></span><br><span class=\"line\">IPV6_DEFROUTE=<span class=\"built_in\">yes</span></span><br><span class=\"line\"></span><br><span class=\"line\">IPV6_FAILURE_FATAL=no</span><br><span class=\"line\"></span><br><span class=\"line\">IPV6_ADDR_GEN_MODE=stable-privacy</span><br><span class=\"line\"></span><br><span class=\"line\">NAME=enp59s16f1</span><br><span class=\"line\"></span><br><span class=\"line\">UUID=19c28a93-aa36-38e6-a556-55a922a0a332</span><br><span class=\"line\"></span><br><span class=\"line\">ONBOOT=<span class=\"built_in\">yes</span></span><br><span class=\"line\"></span><br><span class=\"line\">AUTOCONNECT_PRIORITY=-999</span><br><span class=\"line\"></span><br><span class=\"line\">DEVICE=enp59s16f1</span><br><span class=\"line\"></span><br><span class=\"line\">MTU=9216</span><br></pre></td></tr></table></figure>\n\n<p>这样，即便系统重启，上述配置依然能生效。</p>\n<h1 id=\"使用-KVM-的虚拟网络适配器池\"><a href=\"#使用-KVM-的虚拟网络适配器池\" class=\"headerlink\" title=\"使用 KVM 的虚拟网络适配器池\"></a>使用 KVM 的虚拟网络适配器池</h1><p>主机上创建一个 VF 网络设备的资源池，资源池内的设备可以自动地分配给虚拟机使用。</p>\n<h2 id=\"（1）创建一个-xml-文件。\"><a href=\"#（1）创建一个-xml-文件。\" class=\"headerlink\" title=\"（1）创建一个 xml 文件。\"></a>（1）创建一个 xml 文件。</h2><p>[root@centos7 ~]# cat eno2_sriov_pool.xml</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">network</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">name</span>&gt;</span>eno2_sriov_pool<span class=\"tag\">&lt;/<span class=\"name\">name</span>&gt;</span> <span class=\"comment\">&lt;!-- This is the name of the file you created --&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">forward</span> <span class=\"attr\">mode</span>=<span class=\"string\">&#x27;hostdev&#x27;</span> <span class=\"attr\">managed</span>=<span class=\"string\">&#x27;yes&#x27;</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">pf</span> <span class=\"attr\">dev</span>=<span class=\"string\">&#x27;eno2&#x27;</span>/&gt;</span> <span class=\"comment\">&lt;!-- Use the netdev name of your SR-IOV devices PF here --&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">forward</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">network</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"（2）根据-xml-定义一个网络，并设置为自动重启\"><a href=\"#（2）根据-xml-定义一个网络，并设置为自动重启\" class=\"headerlink\" title=\"（2）根据 xml 定义一个网络，并设置为自动重启\"></a>（2）根据 xml 定义一个网络，并设置为自动重启</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">virsh net-define eno2_sriov_pool.xml</span><br><span class=\"line\"></span><br><span class=\"line\">virsh net-start eno2_sriov_pool</span><br><span class=\"line\"></span><br><span class=\"line\">virsh net-autostart eno2_sriov_pool</span><br></pre></td></tr></table></figure>\n\n<p>[root@centos7 ~]# virsh net-dumpxml eno2_sriov_pool</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">network</span> <span class=\"attr\">connections</span>=<span class=\"string\">&#x27;1&#x27;</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"tag\">&lt;<span class=\"name\">name</span>&gt;</span>eno2_sriov_pool<span class=\"tag\">&lt;/<span class=\"name\">name</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"tag\">&lt;<span class=\"name\">uuid</span>&gt;</span>e0842451-0137-4255-8783-305ca27f082d<span class=\"tag\">&lt;/<span class=\"name\">uuid</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"tag\">&lt;<span class=\"name\">forward</span> <span class=\"attr\">mode</span>=<span class=\"string\">&#x27;hostdev&#x27;</span> <span class=\"attr\">managed</span>=<span class=\"string\">&#x27;yes&#x27;</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">pf</span> <span class=\"attr\">dev</span>=<span class=\"string\">&#x27;eno2&#x27;</span>/&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">domain</span>=<span class=\"string\">&#x27;0x0000&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0x3b&#x27;</span> <span class=\"attr\">slot</span>=<span class=\"string\">&#x27;0x10&#x27;</span> <span class=\"attr\">function</span>=<span class=\"string\">&#x27;0x1&#x27;</span>/&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">domain</span>=<span class=\"string\">&#x27;0x0000&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0x3b&#x27;</span> <span class=\"attr\">slot</span>=<span class=\"string\">&#x27;0x10&#x27;</span> <span class=\"attr\">function</span>=<span class=\"string\">&#x27;0x3&#x27;</span>/&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">domain</span>=<span class=\"string\">&#x27;0x0000&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0x3b&#x27;</span> <span class=\"attr\">slot</span>=<span class=\"string\">&#x27;0x10&#x27;</span> <span class=\"attr\">function</span>=<span class=\"string\">&#x27;0x5&#x27;</span>/&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">domain</span>=<span class=\"string\">&#x27;0x0000&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0x3b&#x27;</span> <span class=\"attr\">slot</span>=<span class=\"string\">&#x27;0x10&#x27;</span> <span class=\"attr\">function</span>=<span class=\"string\">&#x27;0x7&#x27;</span>/&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"tag\">&lt;/<span class=\"name\">forward</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">network</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"（3）从网络适配器池中分配网卡给虚拟机\"><a href=\"#（3）从网络适配器池中分配网卡给虚拟机\" class=\"headerlink\" title=\"（3）从网络适配器池中分配网卡给虚拟机\"></a>（3）从网络适配器池中分配网卡给虚拟机</h2><p>用这种方法添加 SRIOV 网卡比较简单：</p>\n<p><img src=\"/csr1kv-kvm-CentOS7/sriov-pool-001.png\" alt=\"SRIOV Adapter Pool\"></p>\n<p>按照如上方法添加网卡，等同于以下 xml 配置：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">interface</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;network&#x27;</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"tag\">&lt;<span class=\"name\">mac</span> <span class=\"attr\">address</span>=<span class=\"string\">&#x27;52:54:00:2d:87:99&#x27;</span>/&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"tag\">&lt;<span class=\"name\">source</span> <span class=\"attr\">network</span>=<span class=\"string\">&#x27;eno2_sriov_pool&#x27;</span>/&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"tag\">&lt;<span class=\"name\">model</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;virtio&#x27;</span>/&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">domain</span>=<span class=\"string\">&#x27;0x0000&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0x00&#x27;</span> <span class=\"attr\">slot</span>=<span class=\"string\">&#x27;0x04&#x27;</span> <span class=\"attr\">function</span>=<span class=\"string\">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">interface</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>开机后 dumpxml 如下：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">interface</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;hostdev&#x27;</span> <span class=\"attr\">managed</span>=<span class=\"string\">&#x27;yes&#x27;</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">mac</span> <span class=\"attr\">address</span>=<span class=\"string\">&#x27;52:54:00:2d:87:99&#x27;</span>/&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">driver</span> <span class=\"attr\">name</span>=<span class=\"string\">&#x27;vfio&#x27;</span>/&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">source</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">domain</span>=<span class=\"string\">&#x27;0x0000&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0x3b&#x27;</span> <span class=\"attr\">slot</span>=<span class=\"string\">&#x27;0x10&#x27;</span> <span class=\"attr\">function</span>=<span class=\"string\">&#x27;0x1&#x27;</span>/&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">   <span class=\"tag\">&lt;/<span class=\"name\">source</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">model</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;virtio&#x27;</span>/&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">alias</span> <span class=\"attr\">name</span>=<span class=\"string\">&#x27;hostdev0&#x27;</span>/&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">domain</span>=<span class=\"string\">&#x27;0x0000&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0x00&#x27;</span> <span class=\"attr\">slot</span>=<span class=\"string\">&#x27;0x0f&#x27;</span> <span class=\"attr\">function</span>=<span class=\"string\">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">interface</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"使用-Virt-manager-安装-CSR1000v\"><a href=\"#使用-Virt-manager-安装-CSR1000v\" class=\"headerlink\" title=\"使用 Virt-manager 安装 CSR1000v\"></a>使用 Virt-manager 安装 CSR1000v</h1><p>在 CentOS 图形界面中，打开 Terminal，运行 virt-manager，按照以下步骤创建 CSR1000v；添加网卡，并选择 en2_sriov_pool。</p>\n<p><img src=\"/csr1kv-kvm-CentOS7/virt-manager-1.png\" alt=\"Step 1\"></p>\n<p><img src=\"/csr1kv-kvm-CentOS7/virt-manager-2.png\" alt=\"选择镜像\"></p>\n<p><img src=\"/csr1kv-kvm-CentOS7/virt-manager-3.png\" alt=\"Step 2\"></p>\n<p><img src=\"/csr1kv-kvm-CentOS7/virt-manager-3.png\" alt=\"Step 3\"></p>\n<p><img src=\"/csr1kv-kvm-CentOS7/virt-manager-5.png\" alt=\"Step 4\"></p>\n<p>注：csr1kv-1 的第一个网口选择<strong>macvtap Bridge</strong>模式，这样就无需创建一个 Linux 网桥。但是，csr1kv-1 启动以后不能通过该接口与 Linux 主机进行通信，仅能通过该接口访问 Linux 主机外的网络。</p>\n<p><img src=\"/csr1kv-kvm-CentOS7/virt-manager-6.png\" alt=\"Step 5\"></p>\n<p><img src=\"/csr1kv-kvm-CentOS7/virt-manager-7.png\" alt=\"Step 6\"></p>\n<p>添加完网卡后，点击开始安装，然后就可以关闭虚拟机了。上述操作完成后，virt-manager 会在**&#x2F;etc&#x2F;libvirtd&#x2F;qemu&#x2F;<strong>目录下创建</strong>csr1kv-1.xml**。</p>\n<h1 id=\"KVM-调优配置\"><a href=\"#KVM-调优配置\" class=\"headerlink\" title=\"KVM 调优配置\"></a>KVM 调优配置</h1><p>KVM 的调优比较复杂，主要是 NUMA、内存大页、vCPU PIN 等，参考资料为 Redhat Linux 7 PERFORMANCE TUNING GUIDE。</p>\n<h2 id=\"（1）检查平台的能力\"><a href=\"#（1）检查平台的能力\" class=\"headerlink\" title=\"（1）检查平台的能力\"></a>（1）检查平台的能力</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@centos7 ~]# virsh nodeinfo</span><br><span class=\"line\"></span><br><span class=\"line\">CPU model:           x86_64</span><br><span class=\"line\"></span><br><span class=\"line\">CPU(s):              72</span><br><span class=\"line\"></span><br><span class=\"line\">CPU frequency:       999 MHz</span><br><span class=\"line\"></span><br><span class=\"line\">CPU socket(s):       1</span><br><span class=\"line\"></span><br><span class=\"line\">Core(s) per socket:  18</span><br><span class=\"line\"></span><br><span class=\"line\">Thread(s) per core:  2</span><br><span class=\"line\"></span><br><span class=\"line\">NUMA cell(s):        2</span><br><span class=\"line\"></span><br><span class=\"line\">Memory size:         263665612 KiB</span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@centos7 ~]# virsh capabilities</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;capabilities&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"> &lt;host&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">  &lt;uuid&gt;4e53df1f-5b36-6842-99ee-1369d7c68730&lt;/uuid&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">  &lt;cpu&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">   &lt;<span class=\"built_in\">arch</span>&gt;x86_64&lt;/arch&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">   &lt;model&gt;Skylake-Server-IBRS&lt;/model&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">   &lt;vendor&gt;Intel&lt;/vendor&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">   &lt;microcode version=<span class=\"string\">&#x27;33581318&#x27;</span>/&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">   &lt;counter name=<span class=\"string\">&#x27;tsc&#x27;</span> frequency=<span class=\"string\">&#x27;2294597000&#x27;</span> scaling=<span class=\"string\">&#x27;yes&#x27;</span>/&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">   &lt;topology sockets=<span class=\"string\">&#x27;1&#x27;</span> cores=<span class=\"string\">&#x27;18&#x27;</span> threads=<span class=\"string\">&#x27;2&#x27;</span>/&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">……</span><br></pre></td></tr></table></figure>\n\n<p>可检查平台的 CPU 核数、分布，内存的 NUMA 分布等。</p>\n<h2 id=\"（2）NUMA-调优\"><a href=\"#（2）NUMA-调优\" class=\"headerlink\" title=\"（2）NUMA 调优\"></a>（2）NUMA 调优</h2><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@centos7 ~]# numactl --hardware</span><br><span class=\"line\"></span><br><span class=\"line\">available: 2 nodes (0-1)</span><br><span class=\"line\"></span><br><span class=\"line\">node 0 cpus: 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53</span><br><span class=\"line\"></span><br><span class=\"line\">node 0 size: 128491 MB</span><br><span class=\"line\"></span><br><span class=\"line\">node 0 free: 112157 MB</span><br><span class=\"line\"></span><br><span class=\"line\">node 1 cpus: 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71</span><br><span class=\"line\"></span><br><span class=\"line\">node 1 size: 128994 MB</span><br><span class=\"line\"></span><br><span class=\"line\">node 1 free: 124120 MB</span><br><span class=\"line\"></span><br><span class=\"line\">node distances:</span><br><span class=\"line\"></span><br><span class=\"line\">node  0  1</span><br><span class=\"line\"></span><br><span class=\"line\"> 0: 10 21</span><br><span class=\"line\"></span><br><span class=\"line\"> 1: 21 10</span><br></pre></td></tr></table></figure>\n\n<p>两颗 CPU，每颗 CPU 各有 128GB 内存，分别是 node 0 和 node 1。</p>\n<h2 id=\"（3）内存大页-HugePage-以及透明大页\"><a href=\"#（3）内存大页-HugePage-以及透明大页\" class=\"headerlink\" title=\"（3）内存大页 HugePage 以及透明大页\"></a>（3）内存大页 HugePage 以及透明大页</h2><p><code> </code>cat &#x2F;proc&#x2F;meminfo | grep HugePages 查看当前系统有多少个大页：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@centos7 ~]# <span class=\"built_in\">cat</span> /proc/meminfo | grep Huge</span><br><span class=\"line\"></span><br><span class=\"line\">AnonHugePages:   1685504 kB</span><br><span class=\"line\"></span><br><span class=\"line\">HugePages_Total:      64</span><br><span class=\"line\"></span><br><span class=\"line\">HugePages_Free:       60</span><br><span class=\"line\"></span><br><span class=\"line\">HugePages_Rsvd:        0</span><br><span class=\"line\"></span><br><span class=\"line\">HugePages_Surp:        0</span><br><span class=\"line\"></span><br><span class=\"line\">Hugepagesize:    1048576 kB</span><br></pre></td></tr></table></figure>\n\n<p>在系统运行时修改大页数量：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@centos7 ~]# <span class=\"built_in\">cat</span> /sys/devices/system/node/node0/hugepages/hugepages-1048576kB/nr_hugepages</span><br><span class=\"line\"></span><br><span class=\"line\">16</span><br><span class=\"line\"></span><br><span class=\"line\">[root@centos7 ~]# <span class=\"built_in\">echo</span> 32 &gt; /sys/devices/system/node/node0/hugepages/hugepages-1048576kB/nr_hugepages</span><br><span class=\"line\"></span><br><span class=\"line\">[root@centos7 ~]# <span class=\"built_in\">echo</span> 32 &gt; /sys/devices/system/node/node1/hugepages/hugepages-1048576kB/nr_hugepages</span><br><span class=\"line\"></span><br><span class=\"line\">[root@centos7 ~]#</span><br><span class=\"line\"></span><br><span class=\"line\">[root@centos7 ~]# numastat -cm | egrep <span class=\"string\">&#x27;Node|Huge&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">`                 `Node 0 Node 1  Total</span><br><span class=\"line\"></span><br><span class=\"line\">AnonHugePages     10962   1528  12490</span><br><span class=\"line\"></span><br><span class=\"line\">HugePages_Total   32768  32768  65536</span><br><span class=\"line\"></span><br><span class=\"line\">HugePages_Free    32768  32768  65536</span><br><span class=\"line\"></span><br><span class=\"line\">HugePages_Surp        0      0      0</span><br></pre></td></tr></table></figure>\n\n<p>检查透明大页参数，在 CentOS7 上缺省开启；开启了透明大页，不影响静态大页的使用。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cat</span> /sys/kernel/mm/transparent_hugepage/enabled</span><br><span class=\"line\"></span><br><span class=\"line\">[always] madvise never</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"（4）vCPU-钉选\"><a href=\"#（4）vCPU-钉选\" class=\"headerlink\" title=\"（4）vCPU 钉选\"></a>（4）vCPU 钉选</h2><p>设置 CPU Affinity 的好处是提高 CPU 缓存效率，避免进程在多个 CPU 核之间跳跃，切换 CPU 核均会导致缓存中的数据无效，缓存命中率大幅降低，导致数据获取的开销居高不下，损失性能。</p>\n<p><strong>virsh vcpuinfo csr1kv-1</strong> 可以查看 vCPU 的分配。</p>\n<h2 id=\"（5）编辑-CSR-1000v-的-XML-调优参数\"><a href=\"#（5）编辑-CSR-1000v-的-XML-调优参数\" class=\"headerlink\" title=\"（5）编辑 CSR 1000v 的 XML 调优参数\"></a>（5）编辑 CSR 1000v 的 XML 调优参数</h2><p>virsh edit csr1kv-1 可以编辑 XML 的参数，如下：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">memoryBacking</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">hugepages</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">page</span> <span class=\"attr\">size</span>=<span class=\"string\">&#x27;1048576&#x27;</span> <span class=\"attr\">unit</span>=<span class=\"string\">&#x27;KiB&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">hugepages</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">locked</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">nosharepages</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">memoryBacking</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">vcpu</span> <span class=\"attr\">placement</span>=<span class=\"string\">&#x27;static&#x27;</span>&gt;</span>8<span class=\"tag\">&lt;/<span class=\"name\">vcpu</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">cputune</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">vcpupin</span> <span class=\"attr\">vcpu</span>=<span class=\"string\">&#x27;0&#x27;</span> <span class=\"attr\">cpuset</span>=<span class=\"string\">&#x27;1&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">vcpupin</span> <span class=\"attr\">vcpu</span>=<span class=\"string\">&#x27;1&#x27;</span> <span class=\"attr\">cpuset</span>=<span class=\"string\">&#x27;2&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">vcpupin</span> <span class=\"attr\">vcpu</span>=<span class=\"string\">&#x27;2&#x27;</span> <span class=\"attr\">cpuset</span>=<span class=\"string\">&#x27;3&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">vcpupin</span> <span class=\"attr\">vcpu</span>=<span class=\"string\">&#x27;3&#x27;</span> <span class=\"attr\">cpuset</span>=<span class=\"string\">&#x27;4&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">vcpupin</span> <span class=\"attr\">vcpu</span>=<span class=\"string\">&#x27;4&#x27;</span> <span class=\"attr\">cpuset</span>=<span class=\"string\">&#x27;5&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">vcpupin</span> <span class=\"attr\">vcpu</span>=<span class=\"string\">&#x27;5&#x27;</span> <span class=\"attr\">cpuset</span>=<span class=\"string\">&#x27;6&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">vcpupin</span> <span class=\"attr\">vcpu</span>=<span class=\"string\">&#x27;6&#x27;</span> <span class=\"attr\">cpuset</span>=<span class=\"string\">&#x27;7&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">vcpupin</span> <span class=\"attr\">vcpu</span>=<span class=\"string\">&#x27;7&#x27;</span> <span class=\"attr\">cpuset</span>=<span class=\"string\">&#x27;8&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">emulatorpin</span> <span class=\"attr\">cpuset</span>=<span class=\"string\">&#x27;45-52&#x27;</span>/&gt;</span> <span class=\"comment\">&lt;!-- If Hyper-threading were enabled --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">cputune</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">numatune</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">memory</span> <span class=\"attr\">mode</span>=<span class=\"string\">&#x27;strict&#x27;</span> <span class=\"attr\">nodeset</span>=<span class=\"string\">&#x27;0&#x27;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">numatune</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">cpu</span> <span class=\"attr\">mode</span>=<span class=\"string\">&#x27;host-passthrough&#x27;</span> <span class=\"attr\">check</span>=<span class=\"string\">&#x27;none&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">memballoon</span> <span class=\"attr\">model</span>=<span class=\"string\">&#x27;none&#x27;</span>/&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>注：**<emulatorpin cpuset='37-44'/>** 参数，仅当 Hyper-Threating 开启时使用；有一些平台并未关闭超线程，例如 Cisco 专门的 NFV 平台 CSP。通过 virsh chapabilities 查看 siblings&#x3D;’1,37’，当 core 1 设置为 vcpupin 时，core 37 应设置到 emulatorpin cpuset 中。</p>\n<p>以下关于 CPU 和内存的参数设定建议来自于<a href=\"https://libvirt.org/formatdomain.html\">https://libvirt.org/formatdomain.html</a> 和 <a href=\"https://libvirt.org/kbase/kvm-realtime.html\">https://libvirt.org/kbase/kvm-realtime.html</a></p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">domain</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;kvm&#x27;</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">name</span>&gt;</span>csr1kv-1<span class=\"tag\">&lt;/<span class=\"name\">name</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">uuid</span>&gt;</span>59581018-6387-49df-ab09-2bcf40fc12ba<span class=\"tag\">&lt;/<span class=\"name\">uuid</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">memory</span> <span class=\"attr\">unit</span>=<span class=\"string\">&#x27;KiB&#x27;</span>&gt;</span>8388608<span class=\"tag\">&lt;/<span class=\"name\">memory</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">currentMemory</span> <span class=\"attr\">unit</span>=<span class=\"string\">&#x27;KiB&#x27;</span>&gt;</span>8388608<span class=\"tag\">&lt;/<span class=\"name\">currentMemory</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">memoryBacking</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">hugepages</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">page</span> <span class=\"attr\">size</span>=<span class=\"string\">&#x27;1048576&#x27;</span> <span class=\"attr\">unit</span>=<span class=\"string\">&#x27;KiB&#x27;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">hugepages</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">locked</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">nosharepages</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">memoryBacking</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">vcpu</span> <span class=\"attr\">placement</span>=<span class=\"string\">&#x27;static&#x27;</span>&gt;</span>8<span class=\"tag\">&lt;/<span class=\"name\">vcpu</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">cputune</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">vcpupin</span> <span class=\"attr\">vcpu</span>=<span class=\"string\">&#x27;0&#x27;</span> <span class=\"attr\">cpuset</span>=<span class=\"string\">&#x27;1&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">vcpupin</span> <span class=\"attr\">vcpu</span>=<span class=\"string\">&#x27;1&#x27;</span> <span class=\"attr\">cpuset</span>=<span class=\"string\">&#x27;2&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">vcpupin</span> <span class=\"attr\">vcpu</span>=<span class=\"string\">&#x27;2&#x27;</span> <span class=\"attr\">cpuset</span>=<span class=\"string\">&#x27;3&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">vcpupin</span> <span class=\"attr\">vcpu</span>=<span class=\"string\">&#x27;3&#x27;</span> <span class=\"attr\">cpuset</span>=<span class=\"string\">&#x27;4&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">vcpupin</span> <span class=\"attr\">vcpu</span>=<span class=\"string\">&#x27;4&#x27;</span> <span class=\"attr\">cpuset</span>=<span class=\"string\">&#x27;5&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">vcpupin</span> <span class=\"attr\">vcpu</span>=<span class=\"string\">&#x27;5&#x27;</span> <span class=\"attr\">cpuset</span>=<span class=\"string\">&#x27;6&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">vcpupin</span> <span class=\"attr\">vcpu</span>=<span class=\"string\">&#x27;6&#x27;</span> <span class=\"attr\">cpuset</span>=<span class=\"string\">&#x27;7&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">vcpupin</span> <span class=\"attr\">vcpu</span>=<span class=\"string\">&#x27;7&#x27;</span> <span class=\"attr\">cpuset</span>=<span class=\"string\">&#x27;8&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">emulatorpin</span> <span class=\"attr\">cpuset</span>=<span class=\"string\">&#x27;37-44&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">cputune</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">numatune</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">memory</span> <span class=\"attr\">mode</span>=<span class=\"string\">&#x27;strict&#x27;</span> <span class=\"attr\">nodeset</span>=<span class=\"string\">&#x27;0&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">numatune</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">os</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">type</span> <span class=\"attr\">arch</span>=<span class=\"string\">&#x27;x86_64&#x27;</span> <span class=\"attr\">machine</span>=<span class=\"string\">&#x27;pc-i440fx-rhel7.0.0&#x27;</span>&gt;</span>hvm<span class=\"tag\">&lt;/<span class=\"name\">type</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">boot</span> <span class=\"attr\">dev</span>=<span class=\"string\">&#x27;hd&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">os</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">features</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">acpi</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">apic</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">features</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">cpu</span> <span class=\"attr\">mode</span>=<span class=\"string\">&#x27;host-passthrough&#x27;</span> <span class=\"attr\">check</span>=<span class=\"string\">&#x27;none&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">clock</span> <span class=\"attr\">offset</span>=<span class=\"string\">&#x27;utc&#x27;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">timer</span> <span class=\"attr\">name</span>=<span class=\"string\">&#x27;rtc&#x27;</span> <span class=\"attr\">tickpolicy</span>=<span class=\"string\">&#x27;catchup&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">timer</span> <span class=\"attr\">name</span>=<span class=\"string\">&#x27;pit&#x27;</span> <span class=\"attr\">tickpolicy</span>=<span class=\"string\">&#x27;delay&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">timer</span> <span class=\"attr\">name</span>=<span class=\"string\">&#x27;hpet&#x27;</span> <span class=\"attr\">present</span>=<span class=\"string\">&#x27;no&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">clock</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">on_poweroff</span>&gt;</span>destroy<span class=\"tag\">&lt;/<span class=\"name\">on_poweroff</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">on_reboot</span>&gt;</span>restart<span class=\"tag\">&lt;/<span class=\"name\">on_reboot</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">on_crash</span>&gt;</span>destroy<span class=\"tag\">&lt;/<span class=\"name\">on_crash</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">pm</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">suspend-to-mem</span> <span class=\"attr\">enabled</span>=<span class=\"string\">&#x27;no&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">suspend-to-disk</span> <span class=\"attr\">enabled</span>=<span class=\"string\">&#x27;no&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">pm</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">devices</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">emulator</span>&gt;</span>/usr/libexec/qemu-kvm<span class=\"tag\">&lt;/<span class=\"name\">emulator</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">disk</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;file&#x27;</span> <span class=\"attr\">device</span>=<span class=\"string\">&#x27;disk&#x27;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">driver</span> <span class=\"attr\">name</span>=<span class=\"string\">&#x27;qemu&#x27;</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;qcow2&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">source</span> <span class=\"attr\">file</span>=<span class=\"string\">&#x27;/home/root/images/csr1000v-universalk9.17.02.01v.qcow2&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">target</span> <span class=\"attr\">dev</span>=<span class=\"string\">&#x27;vda&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;virtio&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">domain</span>=<span class=\"string\">&#x27;0x0000&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0x00&#x27;</span> <span class=\"attr\">slot</span>=<span class=\"string\">&#x27;0x07&#x27;</span> <span class=\"attr\">function</span>=<span class=\"string\">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">disk</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">controller</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;usb&#x27;</span> <span class=\"attr\">index</span>=<span class=\"string\">&#x27;0&#x27;</span> <span class=\"attr\">model</span>=<span class=\"string\">&#x27;ich9-ehci1&#x27;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">domain</span>=<span class=\"string\">&#x27;0x0000&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0x00&#x27;</span> <span class=\"attr\">slot</span>=<span class=\"string\">&#x27;0x05&#x27;</span> <span class=\"attr\">function</span>=<span class=\"string\">&#x27;0x7&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">controller</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">controller</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;usb&#x27;</span> <span class=\"attr\">index</span>=<span class=\"string\">&#x27;0&#x27;</span> <span class=\"attr\">model</span>=<span class=\"string\">&#x27;ich9-uhci1&#x27;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">master</span> <span class=\"attr\">startport</span>=<span class=\"string\">&#x27;0&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">domain</span>=<span class=\"string\">&#x27;0x0000&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0x00&#x27;</span> <span class=\"attr\">slot</span>=<span class=\"string\">&#x27;0x05&#x27;</span> <span class=\"attr\">function</span>=<span class=\"string\">&#x27;0x0&#x27;</span> <span class=\"attr\">multifunction</span>=<span class=\"string\">&#x27;on&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">controller</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">controller</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;usb&#x27;</span> <span class=\"attr\">index</span>=<span class=\"string\">&#x27;0&#x27;</span> <span class=\"attr\">model</span>=<span class=\"string\">&#x27;ich9-uhci2&#x27;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">master</span> <span class=\"attr\">startport</span>=<span class=\"string\">&#x27;2&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">domain</span>=<span class=\"string\">&#x27;0x0000&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0x00&#x27;</span> <span class=\"attr\">slot</span>=<span class=\"string\">&#x27;0x05&#x27;</span> <span class=\"attr\">function</span>=<span class=\"string\">&#x27;0x1&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">controller</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">controller</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;usb&#x27;</span> <span class=\"attr\">index</span>=<span class=\"string\">&#x27;0&#x27;</span> <span class=\"attr\">model</span>=<span class=\"string\">&#x27;ich9-uhci3&#x27;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">master</span> <span class=\"attr\">startport</span>=<span class=\"string\">&#x27;4&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">domain</span>=<span class=\"string\">&#x27;0x0000&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0x00&#x27;</span> <span class=\"attr\">slot</span>=<span class=\"string\">&#x27;0x05&#x27;</span> <span class=\"attr\">function</span>=<span class=\"string\">&#x27;0x2&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">controller</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">controller</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">index</span>=<span class=\"string\">&#x27;0&#x27;</span> <span class=\"attr\">model</span>=<span class=\"string\">&#x27;pci-root&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">controller</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;virtio-serial&#x27;</span> <span class=\"attr\">index</span>=<span class=\"string\">&#x27;0&#x27;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">domain</span>=<span class=\"string\">&#x27;0x0000&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0x00&#x27;</span> <span class=\"attr\">slot</span>=<span class=\"string\">&#x27;0x06&#x27;</span> <span class=\"attr\">function</span>=<span class=\"string\">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">controller</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">interface</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;direct&#x27;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">mac</span> <span class=\"attr\">address</span>=<span class=\"string\">&#x27;52:54:00:36:95:f0&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">source</span> <span class=\"attr\">dev</span>=<span class=\"string\">&#x27;eno1&#x27;</span> <span class=\"attr\">mode</span>=<span class=\"string\">&#x27;bridge&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">model</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;virtio&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">domain</span>=<span class=\"string\">&#x27;0x0000&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0x00&#x27;</span> <span class=\"attr\">slot</span>=<span class=\"string\">&#x27;0x03&#x27;</span> <span class=\"attr\">function</span>=<span class=\"string\">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">interface</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">interface</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;network&#x27;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">mac</span> <span class=\"attr\">address</span>=<span class=\"string\">&#x27;52:54:00:2d:87:99&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">source</span> <span class=\"attr\">network</span>=<span class=\"string\">&#x27;eno2_sriov_pool&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">model</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;virtio&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">domain</span>=<span class=\"string\">&#x27;0x0000&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0x00&#x27;</span> <span class=\"attr\">slot</span>=<span class=\"string\">&#x27;0x04&#x27;</span> <span class=\"attr\">function</span>=<span class=\"string\">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">interface</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">serial</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pty&#x27;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">target</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;isa-serial&#x27;</span> <span class=\"attr\">port</span>=<span class=\"string\">&#x27;0&#x27;</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">model</span> <span class=\"attr\">name</span>=<span class=\"string\">&#x27;isa-serial&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;/<span class=\"name\">target</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">serial</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">console</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pty&#x27;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">target</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;serial&#x27;</span> <span class=\"attr\">port</span>=<span class=\"string\">&#x27;0&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">console</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">channel</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;unix&#x27;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">target</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;virtio&#x27;</span> <span class=\"attr\">name</span>=<span class=\"string\">&#x27;org.qemu.guest_agent.0&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;virtio-serial&#x27;</span> <span class=\"attr\">controller</span>=<span class=\"string\">&#x27;0&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0&#x27;</span> <span class=\"attr\">port</span>=<span class=\"string\">&#x27;1&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">channel</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">channel</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;spicevmc&#x27;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">target</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;virtio&#x27;</span> <span class=\"attr\">name</span>=<span class=\"string\">&#x27;com.redhat.spice.0&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;virtio-serial&#x27;</span> <span class=\"attr\">controller</span>=<span class=\"string\">&#x27;0&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0&#x27;</span> <span class=\"attr\">port</span>=<span class=\"string\">&#x27;2&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">channel</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;tablet&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;usb&#x27;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;usb&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0&#x27;</span> <span class=\"attr\">port</span>=<span class=\"string\">&#x27;1&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">input</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;mouse&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;ps2&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;keyboard&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;ps2&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">graphics</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;spice&#x27;</span> <span class=\"attr\">autoport</span>=<span class=\"string\">&#x27;yes&#x27;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">listen</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;address&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">image</span> <span class=\"attr\">compression</span>=<span class=\"string\">&#x27;off&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">graphics</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">video</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">model</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;qxl&#x27;</span> <span class=\"attr\">ram</span>=<span class=\"string\">&#x27;65536&#x27;</span> <span class=\"attr\">vram</span>=<span class=\"string\">&#x27;65536&#x27;</span> <span class=\"attr\">vgamem</span>=<span class=\"string\">&#x27;16384&#x27;</span> <span class=\"attr\">heads</span>=<span class=\"string\">&#x27;1&#x27;</span> <span class=\"attr\">primary</span>=<span class=\"string\">&#x27;yes&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">domain</span>=<span class=\"string\">&#x27;0x0000&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0x00&#x27;</span> <span class=\"attr\">slot</span>=<span class=\"string\">&#x27;0x02&#x27;</span> <span class=\"attr\">function</span>=<span class=\"string\">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">video</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">redirdev</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;usb&#x27;</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;spicevmc&#x27;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;usb&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0&#x27;</span> <span class=\"attr\">port</span>=<span class=\"string\">&#x27;2&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">redirdev</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">redirdev</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;usb&#x27;</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;spicevmc&#x27;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;usb&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0&#x27;</span> <span class=\"attr\">port</span>=<span class=\"string\">&#x27;3&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">redirdev</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">memballoon</span> <span class=\"attr\">model</span>=<span class=\"string\">&#x27;none&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">rng</span> <span class=\"attr\">model</span>=<span class=\"string\">&#x27;virtio&#x27;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">backend</span> <span class=\"attr\">model</span>=<span class=\"string\">&#x27;random&#x27;</span>&gt;</span>/dev/urandom<span class=\"tag\">&lt;/<span class=\"name\">backend</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">domain</span>=<span class=\"string\">&#x27;0x0000&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0x00&#x27;</span> <span class=\"attr\">slot</span>=<span class=\"string\">&#x27;0x09&#x27;</span> <span class=\"attr\">function</span>=<span class=\"string\">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">rng</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">devices</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">domain</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>上述参数整理自<a href=\"https://www.cisco.com/c/en/us/td/docs/routers/csr1000/software/configuration/b_CSR1000v_Configuration_Guide/b_CSR1000v_Configuration_Guide_chapter_0101.html\">《Cisco CSR 1000v and Cisco ISRv Software Configuration Guide》</a></p>\n<p>完成上述 XML 文件的编辑后，执行</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cd</span> /etc/libvirtd/qemu</span><br><span class=\"line\"></span><br><span class=\"line\">virsh define csr1kv-1.xml</span><br><span class=\"line\"></span><br><span class=\"line\">virsh start csr1kv-1</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"（6）在-KVM-主机上访问-CSR1000v-的-Console\"><a href=\"#（6）在-KVM-主机上访问-CSR1000v-的-Console\" class=\"headerlink\" title=\"（6）在 KVM 主机上访问 CSR1000v 的 Console\"></a>（6）在 KVM 主机上访问 CSR1000v 的 Console</h2><p>在 virt-manager 创建 CSR1000v 虚拟机的时候，缺省会添加一个 Serial Device。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@centos7 qemu]# virsh console 20</span><br><span class=\"line\"></span><br><span class=\"line\">Connected to domain CSR1000v-1</span><br><span class=\"line\"></span><br><span class=\"line\">Escape character is ^]</span><br></pre></td></tr></table></figure>\n\n<p>CSR 1000v 暂时不能通过 Console 配置，需要通过 virt-manager 的图形化界面进行初始化配置。</p>\n<p>vCloud 的 Console 访问正常。</p>\n<h2 id=\"（7）检验-CSR1000v-的调优配置\"><a href=\"#（7）检验-CSR1000v-的调优配置\" class=\"headerlink\" title=\"（7）检验 CSR1000v 的调优配置\"></a>（7）检验 CSR1000v 的调优配置</h2><figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@centos7 ~]# virsh list</span><br><span class=\"line\"></span><br><span class=\"line\">Id  Name              State</span><br><span class=\"line\"></span><br><span class=\"line\">----------------------------------------------------</span><br><span class=\"line\"></span><br><span class=\"line\"> 6   csr1kv-1            running</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">[root@centos7 ~]# virsh vcpuinfo 6</span><br><span class=\"line\"></span><br><span class=\"line\">VCPU:      0</span><br><span class=\"line\"></span><br><span class=\"line\">CPU:      1</span><br><span class=\"line\"></span><br><span class=\"line\">State:     running</span><br><span class=\"line\"></span><br><span class=\"line\">CPU time:    34.5s</span><br><span class=\"line\"></span><br><span class=\"line\">CPU Affinity:  -y----------------------------------------------------------------------</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">VCPU:      1</span><br><span class=\"line\"></span><br><span class=\"line\">CPU:      2</span><br><span class=\"line\"></span><br><span class=\"line\">State:     running</span><br><span class=\"line\"></span><br><span class=\"line\">CPU time:    32.0s</span><br><span class=\"line\"></span><br><span class=\"line\">CPU Affinity:  --y---------------------------------------------------------------------</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">VCPU:      2</span><br><span class=\"line\"></span><br><span class=\"line\">CPU:      3</span><br><span class=\"line\"></span><br><span class=\"line\">State:     running</span><br><span class=\"line\"></span><br><span class=\"line\">CPU time:    23.8s</span><br><span class=\"line\"></span><br><span class=\"line\">CPU Affinity:  ---y--------------------------------------------------------------------</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">VCPU:      3</span><br><span class=\"line\"></span><br><span class=\"line\">CPU:      4</span><br><span class=\"line\"></span><br><span class=\"line\">State:     running</span><br><span class=\"line\"></span><br><span class=\"line\">CPU time:    19.8s</span><br><span class=\"line\"></span><br><span class=\"line\">CPU Affinity:  ----y-------------------------------------------------------------------</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">VCPU:      4</span><br><span class=\"line\"></span><br><span class=\"line\">CPU:      5</span><br><span class=\"line\"></span><br><span class=\"line\">State:     running</span><br><span class=\"line\"></span><br><span class=\"line\">CPU time:    23.0s</span><br><span class=\"line\"></span><br><span class=\"line\">CPU Affinity:  -----y------------------------------------------------------------------</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">VCPU:      5</span><br><span class=\"line\"></span><br><span class=\"line\">CPU:      6</span><br><span class=\"line\"></span><br><span class=\"line\">State:     running</span><br><span class=\"line\"></span><br><span class=\"line\">CPU time:    23.4s</span><br><span class=\"line\"></span><br><span class=\"line\">CPU Affinity:  ------y-----------------------------------------------------------------</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">VCPU:      6</span><br><span class=\"line\"></span><br><span class=\"line\">CPU:      7</span><br><span class=\"line\"></span><br><span class=\"line\">State:     running</span><br><span class=\"line\"></span><br><span class=\"line\">CPU time:    28.5s</span><br><span class=\"line\"></span><br><span class=\"line\">CPU Affinity:  -------y----------------------------------------------------------------</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">VCPU:      7</span><br><span class=\"line\"></span><br><span class=\"line\">CPU:      8</span><br><span class=\"line\"></span><br><span class=\"line\">State:     running</span><br><span class=\"line\"></span><br><span class=\"line\">CPU time:    28.2s</span><br><span class=\"line\"></span><br><span class=\"line\">CPU Affinity:  --------y---------------------------------------------------------------</span><br></pre></td></tr></table></figure>\n\n<p>以上显示 CSR1000v 虚拟机的 CPU 亲和性在 1-8 核上。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@centos7 ~]# numastat -c qemu-kvm</span><br><span class=\"line\"></span><br><span class=\"line\">Per-node process memory usage (<span class=\"keyword\">in</span> MBs) <span class=\"keyword\">for</span> PID 46895 (qemu-kvm)</span><br><span class=\"line\"></span><br><span class=\"line\">     Node 0 Node 1 Total</span><br><span class=\"line\"></span><br><span class=\"line\">     ------ ------ -----</span><br><span class=\"line\"></span><br><span class=\"line\">Huge    8192   0 8192</span><br><span class=\"line\"></span><br><span class=\"line\">Heap    118   0  118</span><br><span class=\"line\"></span><br><span class=\"line\">Stack     0   0   0</span><br><span class=\"line\"></span><br><span class=\"line\">Private   144   7  151</span><br><span class=\"line\"></span><br><span class=\"line\">------- ------ ------ -----</span><br><span class=\"line\"></span><br><span class=\"line\">Total   8455   7 8461</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>以上显示，内存主要使用 Node 0。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@centos7 ~]# numastat -vm -p 13428 | grep HugePage</span><br><span class=\"line\"></span><br><span class=\"line\">AnonHugePages       956.00     494.00     1450.00</span><br><span class=\"line\"></span><br><span class=\"line\">HugePages_Total     16384.00    16384.00    32768.00</span><br><span class=\"line\"></span><br><span class=\"line\">HugePages_Free      8192.00    16384.00    24576.00</span><br><span class=\"line\"></span><br><span class=\"line\">HugePages_Surp       0.00       0.00      0.00</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"（8）在-CSR1KV-上检查虚拟网卡\"><a href=\"#（8）在-CSR1KV-上检查虚拟网卡\" class=\"headerlink\" title=\"（8）在 CSR1KV 上检查虚拟网卡\"></a>（8）在 CSR1KV 上检查虚拟网卡</h2><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">csr1kv-1#show platform software vnic-if interface-mapping</span><br><span class=\"line\"></span><br><span class=\"line\">-------------------------------------------------------------</span><br><span class=\"line\"></span><br><span class=\"line\"> Interface Name    Driver Name     Mac Addr</span><br><span class=\"line\"></span><br><span class=\"line\">-------------------------------------------------------------</span><br><span class=\"line\"></span><br><span class=\"line\"> GigabitEthernet2    net_ixgbe_vf    5254.002d.8799</span><br><span class=\"line\"></span><br><span class=\"line\"> GigabitEthernet1    net_virtio     5254.0036.95f0</span><br></pre></td></tr></table></figure>\n\n<p>上述驱动名显示为 net_ixgbe_vf 表明该虚拟网卡是一个 SR-IOV 池中分配的 VF 设备。</p>\n<h1 id=\"Linux-上抓取虚拟网卡的报文（参考）\"><a href=\"#Linux-上抓取虚拟网卡的报文（参考）\" class=\"headerlink\" title=\"Linux 上抓取虚拟网卡的报文（参考）\"></a>Linux 上抓取虚拟网卡的报文（参考）</h1><p>查找虚拟机的网卡列表</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@centos7 ~]# virsh domiflist 10</span><br><span class=\"line\"></span><br><span class=\"line\">Interface Type    Source   Model    MAC</span><br><span class=\"line\"></span><br><span class=\"line\">-------------------------------------------------------</span><br><span class=\"line\"></span><br><span class=\"line\">vnet0   network  default  virtio   52:54:00:38:71:4a</span><br><span class=\"line\"></span><br><span class=\"line\">macvtap0  direct   eno1    virtio   52:54:00:b2:70:90</span><br><span class=\"line\"></span><br><span class=\"line\">vnet5   bridge   net-br1  virtio   52:54:00:69:93:23</span><br></pre></td></tr></table></figure>\n\n<p>抓取 vnet5 的报文</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@centos7 ~]# tcpdump -i vnet5 -w ping.pcap</span><br><span class=\"line\"></span><br><span class=\"line\">tcpdump: listening on vnet5, link-type EN10MB (Ethernet), capture size 262144 bytes</span><br><span class=\"line\"></span><br><span class=\"line\">^C49 packets captured</span><br><span class=\"line\"></span><br><span class=\"line\">51 packets received by filter</span><br><span class=\"line\"></span><br><span class=\"line\">0 packets dropped by kernel</span><br></pre></td></tr></table></figure>\n\n<p>注：VF 如果被分配给虚拟机，那么在 Linux 主机里，通过 ip link 则查看不到该设备，无法通过上述办法抓包。</p>\n<h1 id=\"CSR-1000v-的初始化配置及-Smart-License-注册\"><a href=\"#CSR-1000v-的初始化配置及-Smart-License-注册\" class=\"headerlink\" title=\"CSR 1000v 的初始化配置及 Smart License 注册\"></a>CSR 1000v 的初始化配置及 Smart License 注册</h1><h2 id=\"（1）CSR-1000v-初始化配置示例\"><a href=\"#（1）CSR-1000v-初始化配置示例\" class=\"headerlink\" title=\"（1）CSR 1000v 初始化配置示例\"></a>（1）CSR 1000v 初始化配置示例</h2><p>部分节略，其他为缺省配置。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">CSR1000v-1#show sdwan running-config</span><br><span class=\"line\"></span><br><span class=\"line\">system</span><br><span class=\"line\"></span><br><span class=\"line\"> system-ip       1.1.10.1</span><br><span class=\"line\"></span><br><span class=\"line\"> site-id        101</span><br><span class=\"line\"></span><br><span class=\"line\"> sp-organization-name CiscoBJ</span><br><span class=\"line\"></span><br><span class=\"line\"> organization-name   CiscoBJ</span><br><span class=\"line\"></span><br><span class=\"line\"> vbond 10.75.58.51 port 12346</span><br><span class=\"line\"></span><br><span class=\"line\">!</span><br><span class=\"line\"></span><br><span class=\"line\">hostname CSR1000v-1</span><br><span class=\"line\"></span><br><span class=\"line\">username admin privilege 15 secret 9 $9$4/QL2V2K4/6H1k$XUmRNf.T7t3KDOj/FmoNexpEypCxr482dExXHDnohSI</span><br><span class=\"line\"></span><br><span class=\"line\">ip name-server 64.104.123.245</span><br><span class=\"line\"></span><br><span class=\"line\">ip route 0.0.0.0 0.0.0.0 10.75.59.1</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">interface GigabitEthernet1</span><br><span class=\"line\"></span><br><span class=\"line\"> no shutdown</span><br><span class=\"line\"></span><br><span class=\"line\"> arp timeout 1200</span><br><span class=\"line\"></span><br><span class=\"line\"> ip address 10.75.59.35 255.255.255.0</span><br><span class=\"line\"></span><br><span class=\"line\"> no ip redirects</span><br><span class=\"line\"></span><br><span class=\"line\"> ip mtu  1500</span><br><span class=\"line\"></span><br><span class=\"line\"> mtu 1500</span><br><span class=\"line\"></span><br><span class=\"line\"> negotiation auto</span><br><span class=\"line\"></span><br><span class=\"line\">exit</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">interface Tunnel1</span><br><span class=\"line\"></span><br><span class=\"line\"> no shutdown</span><br><span class=\"line\"></span><br><span class=\"line\"> ip unnumbered GigabitEthernet1</span><br><span class=\"line\"></span><br><span class=\"line\"> no ip redirects</span><br><span class=\"line\"></span><br><span class=\"line\"> ipv6 unnumbered GigabitEthernet1</span><br><span class=\"line\"></span><br><span class=\"line\"> no ipv6 redirects</span><br><span class=\"line\"></span><br><span class=\"line\"> tunnel source GigabitEthernet1</span><br><span class=\"line\"></span><br><span class=\"line\"> tunnel mode sdwan</span><br><span class=\"line\"></span><br><span class=\"line\">exit</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">clock timezone CST 8 0</span><br><span class=\"line\"></span><br><span class=\"line\">ntp server 10.75.58.1 version 4</span><br><span class=\"line\"></span><br><span class=\"line\">sdwan</span><br><span class=\"line\"></span><br><span class=\"line\"> interface GigabitEthernet1</span><br><span class=\"line\"></span><br><span class=\"line\"> tunnel-interface</span><br><span class=\"line\"></span><br><span class=\"line\">  encapsulation ipsec</span><br><span class=\"line\"></span><br><span class=\"line\">  allow-service sshd</span><br><span class=\"line\"></span><br><span class=\"line\"> exit</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"（2）常用命令\"><a href=\"#（2）常用命令\" class=\"headerlink\" title=\"（2）常用命令\"></a>（2）常用命令</h2><ul>\n<li>show sdwan control local-properties</li>\n<li>show sdwan control connections</li>\n<li>show sdwan control connection-history</li>\n<li>show sdwan running-config</li>\n<li>show sdwan bfd sessions</li>\n<li>show sdwan omp peers</li>\n<li>show sdwan omp routes</li>\n</ul>\n<h2 id=\"（3）CSR-1000v-Smart-License-注册\"><a href=\"#（3）CSR-1000v-Smart-License-注册\" class=\"headerlink\" title=\"（3）CSR 1000v Smart License 注册\"></a>（3）CSR 1000v Smart License 注册</h2><p>CSR 1000v 默认限速为 250Mbps，需要注册 Smart License 才可解开限速。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">CSR1000v-2#show platform hardware throughput level</span><br><span class=\"line\"></span><br><span class=\"line\">The current throughput level is 250000 kb/s</span><br></pre></td></tr></table></figure>\n\n<p>注册 Smart License 需要满足以下条件：</p>\n<p>1、 CSR 1000v 已经注册到 vManage，控制面连接正常；</p>\n<p>2、 配置 ip http client source-interface GigabitEthernet2</p>\n<p>3、 sdwan interface GigabitEthernet2 tunnel-interface allow-service all —针对 16.12.x 版本；在新版本中仅需要 allow https</p>\n<p>4、 CSR 1000v 可以访问 URL：<a href=\"https://tools.cisco.com/its/service/oddce/services/DDCEService\">https://tools.cisco.com/its/service/oddce/services/DDCEService</a></p>\n<p>允许访问 114.114.114.114，CSR 1000v 可解析域名 tools.cisco.com</p>\n<p>替代办法，增加一条命令 ip host tools.cisco.com 72.163.4.38</p>\n<p>执行 license smart register idtoken xxxxxx 进行注册</p>\n<p>show license status 查看注册结果</p>\n<p>注册完成后，系统解开限速：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">CSR1000v-1#show platform hardware throughput level</span><br><span class=\"line\"></span><br><span class=\"line\">The current throughput level is 200000000 kb/s</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"性能和相关限制\"><a href=\"#性能和相关限制\" class=\"headerlink\" title=\"性能和相关限制\"></a>性能和相关限制</h1><h2 id=\"（1）SRIOV-的性能\"><a href=\"#（1）SRIOV-的性能\" class=\"headerlink\" title=\"（1）SRIOV 的性能\"></a>（1）SRIOV 的性能</h2><p>在上述 CSR1KV-1 安装好后，使用测试仪进行性能测试，测试条件中，设置丢包率为 0%，其性能如下：</p>\n<table>\n<thead>\n<tr>\n<th align=\"left\">Packet Site</th>\n<th align=\"center\">SDWAN Performance (Mbps)</th>\n<th align=\"center\">CEF Performance (Mbps)</th>\n</tr>\n</thead>\n<tbody><tr>\n<td align=\"left\">128Byte</td>\n<td align=\"center\">800</td>\n<td align=\"center\">2843.75</td>\n</tr>\n<tr>\n<td align=\"left\">256Byte</td>\n<td align=\"center\">1431.26</td>\n<td align=\"center\">6500.00</td>\n</tr>\n<tr>\n<td align=\"left\">512Byte</td>\n<td align=\"center\">2581.26</td>\n<td align=\"center\">10578.13</td>\n</tr>\n<tr>\n<td align=\"left\">1024Byte</td>\n<td align=\"center\">3731.26</td>\n<td align=\"center\">15500.00</td>\n</tr>\n<tr>\n<td align=\"left\">1400Byte</td>\n<td align=\"center\">4306.26</td>\n<td align=\"center\">18171.88</td>\n</tr>\n</tbody></table>\n<p><img src=\"/csr1kv-kvm-CentOS7/line-chart-009.png\" alt=\"性能现状图表\"></p>\n<p>注：上述测试结果非官方结果，不同服务器和网卡可能测试结果有区别，上述性能数据仅供参考。</p>\n<h2 id=\"（2）SRIOV-的限制\"><a href=\"#（2）SRIOV-的限制\" class=\"headerlink\" title=\"（2）SRIOV 的限制\"></a>（2）SRIOV 的限制</h2><p>SRIOV 的主要限制是每一个 VF 设备支持的 VLAN 数，ixgbevf 所支持的最大 VLAN 数为 64；因此，在 CSR1KV 中对应的虚拟接口配置的活跃子接口数最大为 64。</p>\n<p>配置指南中有关于 SRIOV 子接口限制的说明：</p>\n<p><code> </code><a href=\"https://www.cisco.com/c/en/us/td/docs/routers/csr1000/software/configuration/b_CSR1000v_Configuration_Guide/b_CSR1000v_Configuration_Guide_chapter_0101.html\">Cisco CSR 1000v and Cisco ISRv Software Configuration Guide</a>:</p>\n<blockquote>\n<p>SR-IOV (ixgbevf)</p>\n<p>Maximum VLANs: The maximum number of VLANs supported on PF is 64. Together, all VFs can have a total of 64 VLANs. (Intel limitation.)</p>\n<p>SR-IOV (i40evf)</p>\n<p>Maximum VLANs: The maximum number of VLANs supported on PF is 512. Together, all VFs can have a total of 512 VLANs. (Intel limitation.) Per-VF resources are managed by the PF (host) device driver.</p>\n</blockquote>\n<h1 id=\"附录\"><a href=\"#附录\" class=\"headerlink\" title=\"附录\"></a>附录</h1><h2 id=\"（1）Virt-manager-设置虚机的-CPU-模式说明\"><a href=\"#（1）Virt-manager-设置虚机的-CPU-模式说明\" class=\"headerlink\" title=\"（1）Virt-manager 设置虚机的 CPU 模式说明\"></a>（1）Virt-manager 设置虚机的 CPU 模式说明</h2><p>Libvirt 主要支持三种 CPU mode：</p>\n<ul>\n<li>host-passthrough: libvirt 令 KVM 把宿主机的 CPU 指令集全部透传给虚拟机。因此虚拟机能够最大限度的使用宿主机 CPU 指令集，故性能是最好的。但是在热迁移时，它要求目的节点的 CPU 和源节点的一致。</li>\n<li>host-model: libvirt 根据当前宿主机 CPU 指令集从配置文件 &#x2F;usr&#x2F;share&#x2F;libvirt&#x2F;cpu_map.xml 选择一种最相配的 CPU 型号。在这种 mode 下，虚拟机的指令集往往比宿主机少，性能相对 host-passthrough 要差一点，但是热迁移时，它允许目的节点 CPU 和源节点的存在一定的差异。</li>\n<li>custom: 这种模式下虚拟机 CPU 指令集数最少，故性能相对最差，但是它在热迁移时跨不同型号 CPU 的能力最强。此外，custom 模式下支持用户添加额外的指令集。</li>\n</ul>\n<p>三种 mode 的性能排序是：host-passthrough &gt; host-model &gt; custom</p>\n<p>实际性能差异不大：100%&gt; 95.84%&gt;94.73%</p>\n<p>引自：<a href=\"http://wsfdl.com/openstack/2018/01/02/libvirt_cpu_mode.html\">http://wsfdl.com/openstack/2018/01/02/libvirt_cpu_mode.html</a></p>\n<h2 id=\"（2）有关网卡模式的说明\"><a href=\"#（2）有关网卡模式的说明\" class=\"headerlink\" title=\"（2）有关网卡模式的说明\"></a>（2）有关网卡模式的说明</h2><p>使用 virt-manager 创建虚拟机，在添加网卡时，有 3 中选择，分别是 e1000, rtl8139, virtio。</p>\n<p>“rtl8139”这个网卡模式是 qemu-kvm 默认的模拟网卡类型，RTL8139 是 Realtek 半导体公司的一个 10&#x2F;100M 网卡系列，是曾经非常流行（当然现在看来有点古老）且兼容性好的网卡，几乎所有的现代操作系统都对 RTL8139 网卡驱动的提供支持。</p>\n<p>“e1000”系列提供 Intel e1000 系列的网卡模拟，纯的 QEMU（非 qemu-kvm）默认就是提供 Intel e1000 系列的虚拟网卡。</p>\n<p>“virtio” 类型是 qemu-kvm 对半虚拟化 IO（virtio）驱动的支持。</p>\n<p>这三个网卡的最大区别(此处指最需要关注的地方)是速度：</p>\n<ul>\n<li><p>rtl8139 10&#x2F;100Mb&#x2F;s</p>\n</li>\n<li><p>e1000 1Gb&#x2F;s</p>\n</li>\n<li><p>virtio 10Gb&#x2F;s</p>\n</li>\n</ul>\n<p>注意 virtio 是唯一可以达到 10Gb&#x2F;s 的。</p>\n<p>virtio 是一种 I&#x2F;O 半虚拟化解决方案，是一套通用 I&#x2F;O 设备虚拟化的程序，是对半虚拟化 Hypervisor 中的一组通用 I&#x2F;O 设备的抽象。提供了一套上层应用与各 Hypervisor 虚拟化设备（KVM，Xen，VMware 等）之间的通信框架和编程接口，减少跨平台所带来的兼容性问题，大大提高驱动程序开发效率。</p>\n<h2 id=\"（3）有关-MACVTAP\"><a href=\"#（3）有关-MACVTAP\" class=\"headerlink\" title=\"（3）有关 MACVTAP\"></a>（3）有关 MACVTAP</h2><p>以下内容来自：<a href=\"https://www.ibm.com/developerworks/cn/linux/1312_xiawc_linuxvirtnet/index.html\">https://www.ibm.com/developerworks/cn/linux/1312_xiawc_linuxvirtnet/index.html</a></p>\n<p>MACVTAP 的实现基于传统的 MACVLAN。和 TAP 设备一样，每一个 MACVTAP 设备拥有一个对应的 Linux 字符设备，并拥有和 TAP 设备一样的 IOCTL 接口，因此能直接被 KVM&#x2F;Qemu 使用，方便地完成网络数据交换工作。引入 MACVTAP 设备的目标是：简化虚拟化环境中的交换网络，代替传统的 Linux TAP 设备加 Bridge 设备组合，同时支持新的虚拟化网络技术，如 802.1 Qbg。</p>\n<p>MACVTAP 设备和 VLAN 设备类似，是以一对多的母子关系出现的。在一个母设备上可以创建多个 MACVTAP 子设备，一个 MACVTAP 设备只有一个母设备，MACVTAP 子设备可以做为母设备，再一次嵌套的创建 MACVTAP 子设备。母子设备之间被隐含的桥接起来，母设备相当于现实世界中的交换机 TRUNK 口。实际上当 MACVTAP 设备被创建并且模式不为 Passthrough 时，内核隐含的创建了 MACVLAN 网络，完成转发功能。MACVTAP 设备有四种工作模式：Bridge、VEPA、Private，Passthrough。</p>\n<p>Bridge 模式下，它完成与 Bridge 设备类似功能，数据可以在属于同一个母设备的子设备间交换转发，虚拟机相当于简单接入了一个交换机。当前的 Linux 实现有一个缺陷，此模式下 MACVTAP 子设备无法和 Linux Host 通讯，即虚拟机无法和 Host 通讯。—-经验证，属实。</p>\n<p>Passthrough 模式下，内核的 MACVLAN 数据处理逻辑被跳过，硬件决定数据如何处理，从而释放了 Host CPU 资源。</p>\n<p><img src=\"/csr1kv-kvm-CentOS7/macvtap-ibm.png\" alt=\"MACVTAP 直通 vs PCI 直通\"></p>\n<p>MACVTAP Passthrough 概念与 PCI Passthrough 概念不同，上图详细解释了两种情况的区别。</p>\n<p>PCI Passthrough 针对的是任意 PCI 设备，不一定是网络设备，目的是让 Guest OS 直接使用 Host 上的 PCI 硬件以提高效率。以 X86 平台为例，数据将通过需要硬件支持的 VT-D 技术从 Guest OS 直接传递到 Host 硬件上。这样做固然效率很高，但因为模拟器失去了对虚拟硬件的控制，难以同步不同 Host 上的硬件状态，因此当前在使用 PCI Passthrough 的情况下难以做动态迁移。</p>\n<p>MACVTAP Passthrough 仅仅针对 MACVTAP 网络设备，目的是绕过内核里 MACVTAP 的部分软件处理过程，转而交给硬件处理。在虚拟化条件下，数据还是会先到达模拟器 I&#x2F;O 层，再转发到硬件上。这样做效率有损失，但模拟器仍然控制虚拟硬件的状态及数据的走向，可以做动态迁移。</p>\n<h2 id=\"（4）SR-IOV-介绍\"><a href=\"#（4）SR-IOV-介绍\" class=\"headerlink\" title=\"（4）SR-IOV 介绍\"></a>（4）SR-IOV 介绍</h2><p>如果网卡支持 SRIOV，请使用 SRIOV PCI Passthrough。</p>\n<p><img src=\"/csr1kv-kvm-CentOS7/nic-type-010.png\" alt=\"nic-type-010\"></p>\n<p>软件模拟是通过 Hypervisor 层模拟虚拟网卡，实现与物理设备完全一样的接口，虚拟机操作系统无须修改就能直接驱动虚拟网卡，其最大的缺点是性能相对较差；</p>\n<p>网卡直通支持虚拟机绕过 Hypervisor 层，直接访问物理 I&#x2F;O 设备，具有最高的性能，但是在同一时刻物理 I&#x2F;O 设备只能被一个虚拟机独享；</p>\n<p>SR-IOV 是 Intel 在 2007 年提出的解决虚拟化网络 I&#x2F;O 的硬件技术方案，该技术不仅能够继承网卡直通的高性能优势，而且同时支持物理 I&#x2F;O 设备的跨虚拟机共享，具有较好的应用前景。</p>\n<p>原文链接：<a href=\"https://blog.csdn.net/lsz137105/article/details/100752930\">https://blog.csdn.net/lsz137105/article/details/100752930</a></p>\n<p>SR-IOV（Single Root I&#x2F;O Virtualization）是一个将 PCIe 设备（如网卡）共享给虚拟机的标准，通过为虚拟机提供独立的内存空间、中断、DMA 流，来绕过 VMM 实现数据访问。</p>\n<p>SR-IOV 引入了两种 PCIe functions：</p>\n<ul>\n<li>PF（Physical Function）：包含完整的 PCIe 功能，包括 SR-IOV 的扩张能力，该功能用于 SR-IOV 的配置和管理。</li>\n<li>VF（Virtual Function）：包含轻量级的 PCIe 功能。每一个 VF 有它自己独享的 PCI 配置区域，并且可能与其他 VF 共享着同一个物理资源。</li>\n</ul>\n<p>SR-IOV 网卡通过将 SR-IOV 功能集成到物理网卡上，将单一的物理网卡虚拟成多个 VF 接口，每个 VF 接口都有单独的虚拟 PCIe 通道，这些虚拟的 PCIe 通道共用物理网卡的 PCIe 通道。每个虚拟机可占用一个或多个 VF 接口，这样虚拟机就可以直接访问自己的 VF 接口，而不需要 Hypervisor 的协调干预，从而大幅提升网络吞吐性能。</p>\n<h2 id=\"（5）探索虚拟机进程\"><a href=\"#（5）探索虚拟机进程\" class=\"headerlink\" title=\"（5）探索虚拟机进程\"></a>（5）探索虚拟机进程</h2><p>每一个客户机就是宿主机中的一个 QEMU 进程，而一个客户机的多个 vCPU 就是一个 QEMU 进程中的多个线程。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@centos7 ~]# ps -ef | grep qemu</span><br><span class=\"line\"></span><br><span class=\"line\">qemu      52595      1 99 10:37 ?        01:24:12 /usr/libexec/qemu-kvm -name csr1kv-1 -S -machine pc-i440fx-rhel7.0.0,accel=kvm,usb=off,dump-guest-core=off,mem-merge=off -cpu host -m 8192 -mem-prealloc -mem-path /dev/hugepages/libvirt/qemu/7-csr1kv-1 -realtime mlock=on -smp 8,sockets=8,cores=1,threads=1 -uuid 59581018-6387-49df-ab09-2bcf40fc12ba -no-user-config -nodefaults -chardev socket,<span class=\"built_in\">id</span>=charmonitor,path=/var/lib/libvirt/qemu/domain-7-csr1kv-1/monitor.sock,server,nowait -mon chardev=charmonitor,<span class=\"built_in\">id</span>=monitor,mode=control -rtc base=utc,driftfix=slew -global kvm-pit.lost_tick_policy=delay -no-hpet -no-shutdown -global PIIX4_PM.disable_s3=1 -global PIIX4_PM.disable_s4=1 -boot strict=on -device piix3-usb-uhci,<span class=\"built_in\">id</span>=usb,bus=pci.0,addr=0x1.0x2 -device virtio-serial-pci,<span class=\"built_in\">id</span>=virtio-serial0,bus=pci.0,addr=0x6 -drive file=/home/root/images/csr1000v-universalk9.17.02.01v.qcow2,format=qcow2,<span class=\"keyword\">if</span>=none,<span class=\"built_in\">id</span>=drive-virtio-disk0 -device virtio-blk-pci,scsi=off,bus=pci.0,addr=0x7,drive=drive-virtio-disk0,<span class=\"built_in\">id</span>=virtio-disk0,bootindex=1 -netdev tap,fd=26,<span class=\"built_in\">id</span>=hostnet0,vhost=on,vhostfd=28 -device virtio-net-pci,netdev=hostnet0,<span class=\"built_in\">id</span>=net0,mac=52:54:00:36:95:f0,bus=pci.0,addr=0x3 -chardev pty,<span class=\"built_in\">id</span>=charserial0 -device isa-serial,chardev=charserial0,<span class=\"built_in\">id</span>=serial0 -chardev socket,<span class=\"built_in\">id</span>=charchannel0,path=/var/lib/libvirt/qemu/channel/target/domain-7-csr1kv-1/org.qemu.guest_agent.0,server,nowait -device virtserialport,bus=virtio-serial0.0,nr=1,chardev=charchannel0,<span class=\"built_in\">id</span>=channel0,name=org.qemu.guest_agent.0 -chardev spicevmc,<span class=\"built_in\">id</span>=charchannel1,name=vdagent -device virtserialport,bus=virtio-serial0.0,nr=2,chardev=charchannel1,<span class=\"built_in\">id</span>=channel1,name=com.redhat.spice.0 -spice port=5900,addr=127.0.0.1,disable-ticketing,image-compression=off,seamless-migration=on -vga qxl -global qxl-vga.ram_size=67108864 -global qxl-vga.vram_size=67108864 -global qxl-vga.vgamem_mb=16 -global qxl-vga.max_outputs=1 -device vfio-pci,host=1d:00.0,<span class=\"built_in\">id</span>=hostdev1,bus=pci.0,addr=0x8 -device vfio-pci,host=3b:10.1,<span class=\"built_in\">id</span>=hostdev0,bus=pci.0,addr=0x4 -msg timestamp=on</span><br></pre></td></tr></table></figure>\n\n<p>使用 virsh 命令或 virt-manager 开启虚拟机，是通过调用&#x2F;usr&#x2F;libexec&#x2F;qemu-kvm 并附带虚拟配置的参数，来开启 qemu-kvm 的进程。可以看到上述的参数是非常复杂的，libvirt 提供 XML 参数进行简化。</p>\n<p>ps -efL | grep qemu 可以列出所有的线程，但是输出篇幅很长，不在此列出；使用 pstree 可列出其父进程、线程关系，如下：</p>\n<p><img src=\"/csr1kv-kvm-CentOS7/pstree-011.png\" alt=\"Pstree\"></p>\n<p>virt-top 可查看虚机运行状态和资源利用率：</p>\n<p>[root@centos7 ~]# virt-top -1</p>\n<p><img src=\"/csr1kv-kvm-CentOS7/virt-top-012.png\" alt=\"Virt-top\"></p>\n<h1 id=\"参考资料连接\"><a href=\"#参考资料连接\" class=\"headerlink\" title=\"参考资料连接\"></a>参考资料连接</h1><ul>\n<li><a href=\"https://cloud.tencent.com/developer/article/1703094\">https://cloud.tencent.com/developer/article/1703094</a></li>\n<li><a href=\"https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html-single/performance_tuning_guide/index\">https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html-single/performance_tuning_guide/index</a></li>\n<li><a href=\"https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/7/html-single/virtualization_tuning_and_optimization_guide/index\">https://access.redhat.com/documentation/zh-cn/red_hat_enterprise_linux/7/html-single/virtualization_tuning_and_optimization_guide/index</a></li>\n<li><a href=\"https://computingforgeeks.com/how-to-create-and-configure-bridge-networking-for-kvm-in-linux/\">https://computingforgeeks.com/how-to-create-and-configure-bridge-networking-for-kvm-in-linux/</a></li>\n<li><a href=\"https://software.intel.com/content/www/us/en/develop/articles/configure-sr-iov-network-virtual-functions-in-linux-kvm.html\">https://software.intel.com/content/www/us/en/develop/articles/configure-sr-iov-network-virtual-functions-in-linux-kvm.html</a></li>\n</ul>\n"},{"title":"Mastering KVM Virtualization 学习笔记(1)","date":"2021-02-22T06:23:47.000Z","description":"Mastering KVM Virtualization 学习笔记，自用，本篇主要记录第三章到第五章。","_content":"\n第一章和第二章之前快速阅读过了，没有笔记，等回头再回来整理。\n\n## Chapter 3 KVM、virsh、oVirt等\n\n### CentOS 8 的KVM安装\n\n```bash\nyum module install virt\ndnf install qemu-img qemu-kvm libvirt libvirt-client virt-manager \\\nvirt-install virt-viewer -y\n```\n\n### 安装完后，使用virt-host-validate验证\n\n```bash\n[root@centos7 ~]# virt-host-validate\n  QEMU: Checking for hardware virtualization                                 : PASS\n  QEMU: Checking if device /dev/kvm exists                                   : PASS\n  QEMU: Checking if device /dev/kvm is accessible                            : PASS\n  QEMU: Checking if device /dev/vhost-net exists                             : PASS\n  QEMU: Checking if device /dev/net/tun exists                               : PASS\n  QEMU: Checking for cgroup 'memory' controller support                      : PASS\n  QEMU: Checking for cgroup 'memory' controller mount-point                  : PASS\n  QEMU: Checking for cgroup 'cpu' controller support                         : PASS\n  QEMU: Checking for cgroup 'cpu' controller mount-point                     : PASS\n  QEMU: Checking for cgroup 'cpuacct' controller support                     : PASS\n  QEMU: Checking for cgroup 'cpuacct' controller mount-point                 : PASS\n  QEMU: Checking for cgroup 'cpuset' controller support                      : PASS\n  QEMU: Checking for cgroup 'cpuset' controller mount-point                  : PASS\n  QEMU: Checking for cgroup 'devices' controller support                     : PASS\n  QEMU: Checking for cgroup 'devices' controller mount-point                 : PASS\n  QEMU: Checking for cgroup 'blkio' controller support                       : PASS\n  QEMU: Checking for cgroup 'blkio' controller mount-point                   : PASS\n  QEMU: Checking for device assignment IOMMU support                         : PASS\n  QEMU: Checking if IOMMU is enabled by kernel                               : PASS\n   LXC: Checking for Linux >= 2.6.26                                         : PASS\n   LXC: Checking for namespace ipc                                           : PASS\n   LXC: Checking for namespace mnt                                           : PASS\n   LXC: Checking for namespace pid                                           : PASS\n   LXC: Checking for namespace uts                                           : PASS\n   LXC: Checking for namespace net                                           : PASS\n   LXC: Checking for namespace user                                          : PASS\n   LXC: Checking for cgroup 'memory' controller support                      : PASS\n   LXC: Checking for cgroup 'memory' controller mount-point                  : PASS\n   LXC: Checking for cgroup 'cpu' controller support                         : PASS\n   LXC: Checking for cgroup 'cpu' controller mount-point                     : PASS\n   LXC: Checking for cgroup 'cpuacct' controller support                     : PASS\n   LXC: Checking for cgroup 'cpuacct' controller mount-point                 : PASS\n   LXC: Checking for cgroup 'cpuset' controller support                      : PASS\n   LXC: Checking for cgroup 'cpuset' controller mount-point                  : PASS\n   LXC: Checking for cgroup 'devices' controller support                     : PASS\n   LXC: Checking for cgroup 'devices' controller mount-point                 : PASS\n   LXC: Checking for cgroup 'blkio' controller support                       : PASS\n   LXC: Checking for cgroup 'blkio' controller mount-point                   : PASS\n   LXC: Checking if device /sys/fs/fuse/connections exists                   : PASS\n```\n\n### 使用virt-install 安装虚拟机\n\n编辑anaconda-ks.cfg文件，使用以下参数可以实现虚机部署的静默安装。\n\n```bash\nvirt-install --virt-type=kvm --name=MasteringKVM02 --ram=4096\n--vcpus=4 --os-variant=rhel8.0 --location=/var/lib/libvirt/\nimages/ CentOS-8-x86_64-1905-dvd1.iso --network=default\n--graphics vnc --disk size=16 -x \"ks=http://10.10.48.1/ks.cfg\"\n```\n\n### oVirt\n\noVirt（Open Virtualization Manager）是一款免费开源虚拟化软件，是RedHat商业版本虚拟化软件RHEV的开源版本。\n\noVirt基于kvm，并整合使用了libvirt、gluster、patternfly、ansible等一系列优秀的开源软件。\n\n### 探索虚拟机Qemu-kvm进程\n\n```bash\nroot@ubuntu-kvm:/home/ubuntu# ps aux | grep qemu\nlibvirt+    8526  255  0.1 13876708 653744 ?     SLl  Feb01 61850:36 /usr/bin/qemu-system-x86_64 -name guest=csr1kv-1,debug-threads=on -S -object secret,id=masterKey0,format=raw,file=/var/lib/libvirt/qemu/domain-4-csr1kv-1/master-key.aes -machine pc-q35-4.2,accel=kvm,usb=off,vmport=off,dump-guest-core=off,mem-merge=off -cpu host -m 8192 -mem-prealloc -mem-path /dev/hugepages/libvirt/qemu/4-csr1kv-1 -overcommit mem-lock=on -smp 8,sockets=8,cores=1,threads=1 -uuid 83f90c1c-f0ea-4298-bcdf-3d676de2aeb4 -no-user-config -nodefaults -chardev socket,id=charmonitor,fd=31,server,nowait -mon chardev=charmonitor,id=monitor,mode=control -rtc base=utc,driftfix=slew -global kvm-pit.lost_tick_policy=delay -no-hpet -no-shutdown -global ICH9-LPC.disable_s3=1 -global ICH9-LPC.disable_s4=1 -boot strict=on -device pcie-root-port,port=0x10,chassis=1,id=pci.1,bus=pcie.0,multifunction=on,addr=0x2 -device pcie-root-port,port=0x11,chassis=2,id=pci.2,bus=pcie.0,addr=0x2.0x1 -device pcie-root-port,port=0x12,chassis=3,id=pci.3,bus=pcie.0,addr=0x2.0x2 -device pcie-root-port,port=0x13,chassis=4,id=pci.4,bus=pcie.0,addr=0x2.0x3 -device pcie-root-port,port=0x14,chassis=5,id=pci.5,bus=pcie.0,addr=0x2.0x4 -device pcie-root-port,port=0x15,chassis=6,id=pci.6,bus=pcie.0,addr=0x2.0x5 -device pcie-root-port,port=0x16,chassis=7,id=pci.7,bus=pcie.0,addr=0x2.0x6 -device pcie-root-port,port=0x17,chassis=8,id=pci.8,bus=pcie.0,addr=0x2.0x7 -device qemu-xhci,p2=15,p3=15,id=usb,bus=pci.3,addr=0x0 -device virtio-serial-pci,id=virtio-serial0,bus=pci.4,addr=0x0 -blockdev {\"driver\":\"file\",\"filename\":\"/var/lib/libvirt/images/csr1000v-universalk9.17.02.01v.qcow2\",\"node-name\":\"libvirt-1-storage\",\"auto-read-only\":true,\"discard\":\"unmap\"} -blockdev {\"node-name\":\"libvirt-1-format\",\"read-only\":false,\"driver\":\"qcow2\",\"file\":\"libvirt-1-storage\",\"backing\":null} -device virtio-blk-pci,scsi=off,bus=pci.5,addr=0x0,drive=libvirt-1-format,id=virtio-disk0,bootindex=1 -netdev tap,fd=33,id=hostnet0,vhost=on,vhostfd=34 -device virtio-net-pci,netdev=hostnet0,id=net0,mac=52:54:00:69:ec:73,bus=pci.1,addr=0x0 -chardev pty,id=charserial0 -device isa-serial,chardev=charserial0,id=serial0 -chardev socket,id=charchannel0,fd=35,server,nowait -device virtserialport,bus=virtio-serial0.0,nr=1,chardev=charchannel0,id=channel0,name=org.qemu.guest_agent.0 -chardev spicevmc,id=charchannel1,name=vdagent -device virtserialport,bus=virtio-serial0.0,nr=2,chardev=charchannel1,id=channel1,name=com.redhat.spice.0 -spice port=5900,addr=127.0.0.1,disable-ticketing,image-compression=off,seamless-migration=on -device qxl-vga,id=video0,ram_size=67108864,vram_size=67108864,vram64_size_mb=0,vgamem_mb=16,max_outputs=1,bus=pcie.0,addr=0x1 -device vfio-pci,host=0000:5e:02.0,id=hostdev0,bus=pci.2,addr=0x0 -device vfio-pci,host=0000:5e:0a.0,id=hostdev1,bus=pci.8,addr=0x0 -sandbox on,obsolete=deny,elevateprivileges=deny,spawn=deny,resourcecontrol=deny -msg timestamp=on\n```\n\n使用pstree检查线程信息：\n\n```bash\nroot@ubuntu-kvm:/home/ubuntu# pstree -p 8526\nqemu-system-x86(8526)─┬─{qemu-system-x86}(8530)\n                      ├─{qemu-system-x86}(8534)\n                      ├─{qemu-system-x86}(8535)\n                      ├─{qemu-system-x86}(8536)\n                      ├─{qemu-system-x86}(8537)\n                      ├─{qemu-system-x86}(8538)\n                      ├─{qemu-system-x86}(8539)\n                      ├─{qemu-system-x86}(8540)\n                      ├─{qemu-system-x86}(8541)\n                      ├─{qemu-system-x86}(8542)\n                      ├─{qemu-system-x86}(8552)\n```\n\n使用gbd 调试进程，这里参考<https://www.cnblogs.com/hukey/p/11138768.html>\n\n```bash\nroot@ubuntu-kvm:/home/ubuntu# gdb attach 8526\nGNU gdb (Ubuntu 9.2-0ubuntu1~20.04) 9.2\nCopyright (C) 2020 Free Software Foundation, Inc.\nLicense GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>\nThis is free software: you are free to change and redistribute it.\nThere is NO WARRANTY, to the extent permitted by law.\nType \"show copying\" and \"show warranty\" for details.\nThis GDB was configured as \"x86_64-linux-gnu\".\nType \"show configuration\" for configuration details.\nFor bug reporting instructions, please see:\n<http://www.gnu.org/software/gdb/bugs/>.\nFind the GDB manual and other documentation resources online at:\n    <http://www.gnu.org/software/gdb/documentation/>.\n\nFor help, type \"help\".\nType \"apropos word\" to search for commands related to \"word\".\nAttaching to process 8526\n[New LWP 8530]\n[New LWP 8534]\n[New LWP 8535]\n[New LWP 8536]\n[New LWP 8537]\n[New LWP 8538]\n[New LWP 8539]\n[New LWP 8540]\n[New LWP 8541]\n[New LWP 8542]\n[New LWP 8552]\n[New LWP 250213]\n\nwarning: \"target:/usr/bin/qemu-system-x86_64 (deleted)\": could not open as an executable file: No such file or directory.\n\nwarning: `target:/usr/bin/qemu-system-x86_64 (deleted)': can't open to read symbols: No such file or directory.\n\nwarning: Could not load vsyscall page because no executable was specified\n0x00007fdcda986bf6 in ?? ()\n(gdb) info threads\n  Id   Target Id                  Frame\n* 1    LWP 8526 \"qemu-system-x86\" 0x00007fdcda986bf6 in ?? ()\n  2    LWP 8530 \"call_rcu\"        0x00007fdcda98c89d in ?? ()\n  3    LWP 8534 \"IO mon_iothread\" 0x00007fdcda986aff in ?? ()\n  4    LWP 8535 \"CPU 0/KVM\"       0x00007fdcda98850b in ?? ()\n  5    LWP 8536 \"CPU 1/KVM\"       0x00007fdcda98850b in ?? ()\n  6    LWP 8537 \"CPU 2/KVM\"       0x00007fdcda98850b in ?? ()\n  7    LWP 8538 \"CPU 3/KVM\"       0x00007fdcda98850b in ?? ()\n  8    LWP 8539 \"CPU 4/KVM\"       0x00007fdcda98850b in ?? ()\n  9    LWP 8540 \"CPU 5/KVM\"       0x00007fdcda98850b in ?? ()\n  10   LWP 8541 \"CPU 6/KVM\"       0x00007fdcda98850b in ?? ()\n  11   LWP 8542 \"CPU 7/KVM\"       0x00007fdcda98850b in ?? ()\n  12   LWP 8552 \"SPICE Worker\"    0x00007fdcda986aff in ?? ()\n  13   LWP 250213 \"worker\"        0x00007fdcdaa76618 in ?? ()\n```\n\n## Chapter 4 KVM 网络\n\n本章节介绍了以下内容\n\n- Virtual Network -- 阐述为什么需要虚拟网络。从虚拟交换机开始，设想一下如果没有虚拟交换机，有20个虚拟机需要20个物理接口连接至20个物理交换机的端口。引入虚拟交换机，减少服务器的物理接口和物理交换机的接口需求。\n- Libvirt 的三类网络：NAT、Routed(Bridged)、Isolated；使用virsh net-dumpxml default输出xml文件。\n- TUN/TAP设备：属于用户空间的设备，an application can open /dev/net/tun and use an ioctl() function to register a network device in the kernel, which, in turn, presents itself as a tunXX or tapXX device.  TUN设备是一个3层设备，TAP设备是一个2层设备。\n- 简单介绍了Linux Bridge，此处可以使用ip link 命令替代brctl命令，并使用NetworkManager来持久化配置。\n- Open vSwitch简单介绍\n- SR-IOV的介绍：此处可以参考我自己的文档。\n- MACVTAP介绍：It's a newer driver that should simplify our virtualized networking by completely removing tun/tap and bridge drivers with a single module.  有四种模式，VEPA，Bridge，Private和Pass-through。\n\n## Chapter 5 KVM 存储\n\n本章属于囫囵吞枣的看完了，一知半解的记录一下，大致了解了一些存储方面的概念和存储的最新发展。\n\n### 存储资源池\n\nCentOS支持的存储池种类如下：\n\n- Logical Volume Manager (LVM)-based storage pools\n- Directory-based storage pools\n- Partition-based storage pools\n- GlusterFS-based storage pools\n- iSCSI-based storage pools\n- Disk-based storage pools\n- HBA-based storage pools, which use SCSI devices\n\n对于libvirt来说，存储资源池可能是一个目录，一个存储设备，或者是一个文件。\n\n介绍了两种文件系统：\n\n- **Brtfs** is a type of filesystem that supports snapshots, RAID and LVM-like functionality, compression, defragmentation, online resizing, and many other advanced features. It was deprecated after it was discovered that its RAID5/6 can easily lead to a loss of data. --这里说的是Red Hat\n- **ZFS** is a type of filesystem that supports everything that Brtfs does, plus read and write caching. **ZFS is not a part of the Linux kernel.**\n\n### 本地存储池\n\nStratis是随RHEL 8引入的本地管理存储解决方案，它使系统管理员可以配置高级存储功能：\n\n1. Pool-based management\n2. Thin provisioning\n3. File system snapshots\n4. Monitoring\n\nStratis使用示例：\n\n```bash\nmdadm --create /dev/md0 --verbose --level=10 --raid-devices=4 /dev/sdb /dev/sdc /dev/sdd /dev/sde --spare-devices=1 /dev/sdf2\nstratis pool create PacktStratisPool01 /dev/md0\nstratis pool add-cache PacktStratisPool01 /dev/sdg\nstratis fs create PackStratisPool01 PacktStratisXFS01\nmkdir /mnt/packtStratisXFS01\nmount /stratis/PacktStratisPool01/PacktStratisXFS01 /mnt/packtStratisXFS01\n```\n\n### Libvirt Storage Pool\n\nLibvirt 支持多种Storage Pool，详见<https://libvirt.org/storage.html>\n\n- Directory pool\n- Filesystem pool\n- Network filesystem pool\n- Logical volume pool\n- Disk pool\n- iSCSI pool\n- iSCSI direct pool\n- SCSI pool\n- Multipath pool\n- RBD pool\n- Sheepdog pool\n- Gluster pool\n- ZFS pool\n- Vstorage pool\n\n### NFS Storage Pool\n\nNFS自上世纪80年代就出现了，至今依然活跃，尤其是4.2版本以后增强了不少功能；VMware Virtual Volume 6.0 可以提供基于Block和NFS的两种存储访问。\n\nLibvirt 使用NFS Storage Pool示例，也可以使用virt-manager 图形界面创建：\n\n```xml\n<pool type='netfs'>\n    <name>NFSpooll</name>\n    <source>\n        <host name='192.168.159.144' />\n        <dir path='/mnt/packtStratisXF501' />\n        <format type='auto'/>\n    </source>\n    <target>\n        <path>/var/lib/libvirt/images/NFSpooll</path>\n        <permissions>\n            <mode>0755</mode>\n            <owner>0</owner>\n            <group>0</group>\n            <label>system_u:object r:nfs t:s0</label>\n        </permissions>\n    </target>\n</pool>\n```\n\n### iSCIS 和 SAN 存储\n\niSCIS协议有两个主要原因影响其高效性：\n\n- **IP协议封装** iSCSI encapsulates SCSI commands into regular IP packages, which means segmentation and overhead as IP packages have a pretty large header, which means less efficiency.\n- **基于TCP传输** Even worse, it's TCP-based, which means that there are sequence numbers and retransmissions, which can lead to queueing and latency, and the bigger the environment is, the more you usually feel these effects affect your virtual machine performance.\n\nThe iSCSI and FC architectures are very similar—they both need a target (an iSCSI target and an FC target) and an initiator (an iSCS initiator and an FC initiator)，the initiator connects to a target to get access to block storage that's presented via that target.\n\n#### LUN的概念\n\nLUNs are just raw, block capacities that we export via an iSCSI target toward initiators. LUNs are indexed, or numbered, usually from 0 onward. Every LUN number represents a different storage capacity that an initiator can connect to.\n\nFor example, we can have an iSCSI target with three different LUNs—LUN0 with 20 GB, LUN1 with 40 GB, and LUN2 with 60 GB. These will all be hosted on the same storage system's iSCSI target. We can then configure the iSCSI target to accept an IQN to see all the LUNs, another IQN to only see LUN1, and another IQN to only see LUN1 and LUN2. \n\n使用 targetcli命令创建iSCIS target，步骤简要说明如下：\n\n1. 创建/dev/sdb1分区和XFS文件系统，并mount /dev/sdb1 /LUN0，用targetcli创建一个fileio 类型的target后端\n2. 创建/dev/sdc1分区，并直接使用targetcli创建一个block类型的target后端\n3. 基于/dev/sdd创建LVM，并使用targetcli创建一个block类型的target后端\n4. 在KVM主机上设置好iscsi的initiator参数\n5. 回到iSCSI上，创建ACL，允许KVM host，基于1~3创建的target发布LUNs\n6. 在KVM Host上定义Storage Pool的XML文件，用virsh pool-define创建Storage Pool\n\n### Storage redundancy and multipathing\n\n避免单点故障SPOF，网卡、线缆、交换机、存储控制器等等。\n\nKVM Host基于iSCSI做冗余和多路径的配置较为复杂，并且缺少支持，文章建议使用oVirt或者RHEV-H(Red Hat Enterprise Virtualization Hypervisor. )\n\n使用oVirt 创建一个iSCSI Bond来实现冗余和多路径。\n\n### Gluster\n\nGluster 是一个分布式文件系统，其突出优势是可扩展性，数据复制和快照功能；注意Gluster是一个文件存储服务。\n\n生产环境中，Gluster至少配置三台服务器。\n\n配置步骤简要说明如下：\n\n1. 创建磁盘分区以及文件系统 \n\n   ```bash\n   mkfs.xfs /dev/sdb\n   mkdir /gluster/bricks/1 -p\n   echo '/dev/sdb /gluster/bricks/1 xfs defaults 0 0' >> /etc/\n   fstab\n   mount -a\n   mkdir /gluster/bricks/1/brick\n   ```\n\n2. 创建Gluster分布式文件系统\n\n   ```bash\n   gluster volume create kvmgluster replica 3 \\ gluster1:/gluster/\n   bricks/1/brick gluster2:/gluster/bricks/1/brick \\ gluster3:/\n   gluster/bricks/1/brick\n   gluster volume start kvmgluster\n   gluster volume set kvmgluster auth.allow 192.168.159.0/24\n   gluster volume set kvmgluster allow-insecure on\n   gluster volume set kvmgluster storage.owner-uid 107\n   gluster volume set kvmgluster storage.owner-gid 107\n   ```\n\n3. 挂在Gluster文件系统为NFS服务\n\n   ```bash\n   echo 'localhost:/kvmgluster /mnt glusterfs \\ defaults,_\n   netdev,backupvolfile-server=localhost 0 0' >> /etc/fstab\n   mount.glusterfs localhost:/kvmgluster /mnt\n   ```\n\n4. 在KVM主机上挂在Gluster\n\n   ```bash\n   wget \\ https://download.gluster.org/pub/gluster/glusterfs/6/\n   LATEST/CentOS/gl\\ usterfs-rhel8.repo -P /etc/yum.repos.d\n   yum install glusterfs glusterfs-fuse attr -y\n   mount -t glusterfs -o context=\"system_u:object_r:virt_\n   image_t:s0\" \\ gluster1:/kvmgluster /var/lib/libvirt/images/\n   GlusterFS\n   ```\n\n5. 在KVM上定义存储资源池：\n\n   ```xml\n   <pool type='dir'>\n       <name>glusterfs-pool</name>\n       <target>\n           <path>/var/lib/libvirt/images/GlusterFS</path>\n           <permissions>\n               <mode>0755</mode>\n               <owner>107</owner>\n               <group>107</group>\n               <label>system_u:object_r:virt_image_t:s0</label>\n           </permissions>\n       </target>\n   </pool>\n   ```\n\n   ```bash\n   virsh pool-define --file gluster.xml\n   virsh pool-start --pool glusterfs-pool\n   virsh pool-autostart --pool glusterfs-pool\n   ```\n\n将Gluster挂在为目录，可以避免Libvirt在使用Gluster的两个问题：\n\n- We can use Gluster's failover capability, which will be managed automatically by the\n\n  Gluster utilities that we installed directly, as libvirt doesn't support them yet.\n\n- We will avoid creating virtual machine disks *manually*, which is another limitation of libvirt's implementation of Gluster support, while directory-based storage pools support it without any issues.\n\n### Ceph\n\nCeph offers block and object-based storage. Object-based storage for block-based devices means direct, binary storage, directly to a LUN. There are no filesystems involved, which theoretically means less overhead as there's no filesystem, filesystem tables, and other constructs that might slow the I/O process down.\n\nArchitecture-wise, Ceph has three main services:\n\n- ceph-mon : Used for cluster monitoring, CRUSH maps, and Object Storage Daemon (OSD) maps.\n- ceph-osd: This handles actual data storage, replication, and recovery. It requires at least two nodes; we'll use three for clustering reasons.\n- ceph-mds: Metadata server, used when Ceph needs filesystem access.\n\nCeph 集群中，所有的数据节点要求采用相同的硬件配置，相同的CPU、内存、硬盘，不适用RAID控制器，仅仅使用HBA。\n\n```bash\nceph-deploy install ceph-admin ceph-monitor ceph-osd1 ceph-osd2\nceph-osd3\nceph-deploy mon create-initial\nceph-deploy gatherkeys ceph-monitor\nceph-deploy disk list ceph-osd1 ceph-osd2 ceph-osd3\nceph-deploy disk zap ceph-osd1:/dev/sdb  ceph-osd2:/dev/sdb\nceph-osd3:/dev/sdb\nceph-deploy osd prepare ceph-osd1:/dev/sdb ceph-osd2:/dev/sdb\nceph-osd3:/dev/sdb\nceph-deploy osd activate ceph-osd1:/dev/sdb1 ceph-osd2:/dev/\nsdb1 ceph-osd3:/dev/sdb1\n```\n\n对上述命令的说明：\n\n- The first command starts the actual deployment process—for the admin, monitor, and OSD nodes, with the installation of all the necessary packages.\n- The second and third commands configure the monitor host so that it's ready to accept external connections.\n\n- The two disk commands are all about disk preparation—Ceph will clear the disks that we assigned to it (/dev/sdb per OSD host) and create two partitions on them, one for Ceph data and one for the Ceph journal.\n- The last two commands prepare these filesystems for use and activate Ceph. If at any time your ceph-deploy script stops, check your DNS and /etc/hosts and firewalld configuration, as that's where the problems usually are.\n\n使用以下命令将Ceph存储发布给KVM主机作为存储池：\n\n```bash\nceph osd pool create KVMpool 128 128\n```\n\n还需要几个步骤来实现安全的访问，为Ceph的访问增加密码验证。\n\n1. Ceph生成验证的密码 Key\n\n   ```bash\n   ceph auth get-or-create client.KVMpool mon 'allow r' osd 'allow\n   rwx pool=KVMpool'\n   \n   #It's going to throw us a status message, something like this:\n   key = AQB9p8RdqS09CBAA1DHsiZJbehb7ZBffhfmFJQ==\n   \n   ```\n\n2. 定义一个Secret\n\n   ```xml\n   <secret ephemeral='no' private='no'>\n       <usage type='ceph'>\n           <name>client.KVMpool secret</name>\n       </usage>\n   </secret>\n   \n   ```\n\n   将Secret的UUID与Ceph生成的Key进行关联。\n\n   ```bash\n   virsh secret-define --file secret.xml\n   \n   Secret 95b1ed29-16aa-4e95-9917-c2cd4f3b2791 created\n   \n   virsh secret-set-value 95b1ed29-16aa-4e95-9917-c2cd4f3b2791\n   AQB9p8RdqS09CBAA1DHsiZJbehb7ZBffhfmFJQ==\n   ```\n\n3. 定义Ceph存储池\n\n   ```xml\n   <pool type=\"rbd\">\n       <source>\n           <name>KVMpool</name>\n           <host name='192.168.159.151' port='6789'/>\n           <auth username='KVMpool' type='ceph'>\n               <secret uuid='95b1ed29-16aa-4e95-9917-c2cd4f3b2791'/>\n           </auth>\n       </source>\n   </pool>\n   ```\n\n   ```bash\n   virsh pool-define --file ceph.xml\n   virsh pool-start KVMpool\n   virsh pool-autostart KVMpool\n   virsh pool-list --details\n   ```\n\n### 虚拟磁盘镜像和KVM存储基本操作\n\n文章介绍了使用dd命令生成磁盘镜像文件，如下：\n\n生成10G的预分配磁盘文件：\n\n```bash\ndd if=/dev/zero of=/vms/dbvm_disk2.img bs=1G count=10\n```\n\n生成10G的磁盘文件，使用seek关键字，不做预分配\n\n```bash\ndd if=/dev/zero of=/vms/dbvm_disk2_seek.imgbs=1G seek=10 count=0\n```\n\n#### qemu-img 命令\n\n使用qemu-img info查看磁盘文件的信息，如下：\n\n```bash\n# qemu-img info /vms/dbvm_disk2.img\nimage: /vms/dbvm_disk2.img\nfile format: raw\nvirtual size: 10G (10737418240 bytes)\ndisk size: 10G\n# qemu-img info /vms/dbvm_disk2_seek.img\nimage: /vms/dbvm_disk2_seek.img\nfile format: raw\nvirtual size: 10G (10737418240 bytes)\ndisk size: 10M\n```\n\n#### 使用virsh命令加载硬盘\n\n```bash\nvirsh attach-disk CentOS8 /vms/dbvm_disk2.img vdb --live --config\n```\n\n说明如下：\n\n-  **CentOS8** is the virtual machine to which a disk attachment is executed. \n- Then, there is the path of the disk image,  **/vms/dbvm_disk2.img**\n- **vdb** is the target disk name that would be visible inside the guest operating system. \n- **--live** means performing the action while the virtual machine is running.\n- **--config** means attaching it persistently across reboot. Not adding a --config switch will keep the disk attached only until reboot.\n\n查看虚拟机的硬盘信息：\n\n```bash\nvirsh domblklist CentOS8 --details\n\nType Device Target Source\n------------------------------------------------\nfile disk vda /var/lib/libvirt/images/fedora21.qcow2\nfile disk vdb /vms/dbvm_disk2_seek.img\n```\n\n还有其他章节，比如创建ISO库、删除存储池、创建卷和删除卷。\n\n#### 有关NVMe和NVMe over Fabric\n\nSSD存储的存取方式发生改变，主要体现在性能和延时这两方面。传统**AHCI** (Advanced Host Controller Interface) 已不能满足SSD的性能要求。\n\n**NVMe** (Non-Volatile Memory Express) 是一个全新的协议，基于PCIe技术，目的在于满足SSD的高性能、低时延的访问要求。越来越多的存储设备已经集成了SSD和NVMe，主要用于缓存，同时也有用于数据存储的。\n\nFiber Channel，虽然10多年被人争执说要从市场消失，主要原因无外乎：FC需要专用的交换机、专门的网卡和线缆，FC设备贵，需要专门的知识，而且FC的速率没有以太网发展快。\n\n但是，目前市场上发生的情况有所不同，FC可以满足NVMe SSD带来的性能提升的需求。\n\nTwo of these concepts derived from **Intel Optane**—**Storage Class Memory (SCM) and Persistent Memory (PM)** are the latest technologies that storage companies and customers want adopted into their storage systems, and fast.\n\n将工作负载移到内存当中是符合逻辑的，设想一下内存型数据库(Microsoft SQL, SAP HANA, Oracle).\n\n如果一个存储厂商生产了使用SCM SSD的存储设备，那么只有内存可用于缓存(Cache).","source":"_posts/master-kvm-notes-1.md","raw":"---\ntitle: Mastering KVM Virtualization 学习笔记(1)\ndate: 2021-02-22 14:23:47\ntags: kvm\ndescription: Mastering KVM Virtualization 学习笔记，自用，本篇主要记录第三章到第五章。\n---\n\n第一章和第二章之前快速阅读过了，没有笔记，等回头再回来整理。\n\n## Chapter 3 KVM、virsh、oVirt等\n\n### CentOS 8 的KVM安装\n\n```bash\nyum module install virt\ndnf install qemu-img qemu-kvm libvirt libvirt-client virt-manager \\\nvirt-install virt-viewer -y\n```\n\n### 安装完后，使用virt-host-validate验证\n\n```bash\n[root@centos7 ~]# virt-host-validate\n  QEMU: Checking for hardware virtualization                                 : PASS\n  QEMU: Checking if device /dev/kvm exists                                   : PASS\n  QEMU: Checking if device /dev/kvm is accessible                            : PASS\n  QEMU: Checking if device /dev/vhost-net exists                             : PASS\n  QEMU: Checking if device /dev/net/tun exists                               : PASS\n  QEMU: Checking for cgroup 'memory' controller support                      : PASS\n  QEMU: Checking for cgroup 'memory' controller mount-point                  : PASS\n  QEMU: Checking for cgroup 'cpu' controller support                         : PASS\n  QEMU: Checking for cgroup 'cpu' controller mount-point                     : PASS\n  QEMU: Checking for cgroup 'cpuacct' controller support                     : PASS\n  QEMU: Checking for cgroup 'cpuacct' controller mount-point                 : PASS\n  QEMU: Checking for cgroup 'cpuset' controller support                      : PASS\n  QEMU: Checking for cgroup 'cpuset' controller mount-point                  : PASS\n  QEMU: Checking for cgroup 'devices' controller support                     : PASS\n  QEMU: Checking for cgroup 'devices' controller mount-point                 : PASS\n  QEMU: Checking for cgroup 'blkio' controller support                       : PASS\n  QEMU: Checking for cgroup 'blkio' controller mount-point                   : PASS\n  QEMU: Checking for device assignment IOMMU support                         : PASS\n  QEMU: Checking if IOMMU is enabled by kernel                               : PASS\n   LXC: Checking for Linux >= 2.6.26                                         : PASS\n   LXC: Checking for namespace ipc                                           : PASS\n   LXC: Checking for namespace mnt                                           : PASS\n   LXC: Checking for namespace pid                                           : PASS\n   LXC: Checking for namespace uts                                           : PASS\n   LXC: Checking for namespace net                                           : PASS\n   LXC: Checking for namespace user                                          : PASS\n   LXC: Checking for cgroup 'memory' controller support                      : PASS\n   LXC: Checking for cgroup 'memory' controller mount-point                  : PASS\n   LXC: Checking for cgroup 'cpu' controller support                         : PASS\n   LXC: Checking for cgroup 'cpu' controller mount-point                     : PASS\n   LXC: Checking for cgroup 'cpuacct' controller support                     : PASS\n   LXC: Checking for cgroup 'cpuacct' controller mount-point                 : PASS\n   LXC: Checking for cgroup 'cpuset' controller support                      : PASS\n   LXC: Checking for cgroup 'cpuset' controller mount-point                  : PASS\n   LXC: Checking for cgroup 'devices' controller support                     : PASS\n   LXC: Checking for cgroup 'devices' controller mount-point                 : PASS\n   LXC: Checking for cgroup 'blkio' controller support                       : PASS\n   LXC: Checking for cgroup 'blkio' controller mount-point                   : PASS\n   LXC: Checking if device /sys/fs/fuse/connections exists                   : PASS\n```\n\n### 使用virt-install 安装虚拟机\n\n编辑anaconda-ks.cfg文件，使用以下参数可以实现虚机部署的静默安装。\n\n```bash\nvirt-install --virt-type=kvm --name=MasteringKVM02 --ram=4096\n--vcpus=4 --os-variant=rhel8.0 --location=/var/lib/libvirt/\nimages/ CentOS-8-x86_64-1905-dvd1.iso --network=default\n--graphics vnc --disk size=16 -x \"ks=http://10.10.48.1/ks.cfg\"\n```\n\n### oVirt\n\noVirt（Open Virtualization Manager）是一款免费开源虚拟化软件，是RedHat商业版本虚拟化软件RHEV的开源版本。\n\noVirt基于kvm，并整合使用了libvirt、gluster、patternfly、ansible等一系列优秀的开源软件。\n\n### 探索虚拟机Qemu-kvm进程\n\n```bash\nroot@ubuntu-kvm:/home/ubuntu# ps aux | grep qemu\nlibvirt+    8526  255  0.1 13876708 653744 ?     SLl  Feb01 61850:36 /usr/bin/qemu-system-x86_64 -name guest=csr1kv-1,debug-threads=on -S -object secret,id=masterKey0,format=raw,file=/var/lib/libvirt/qemu/domain-4-csr1kv-1/master-key.aes -machine pc-q35-4.2,accel=kvm,usb=off,vmport=off,dump-guest-core=off,mem-merge=off -cpu host -m 8192 -mem-prealloc -mem-path /dev/hugepages/libvirt/qemu/4-csr1kv-1 -overcommit mem-lock=on -smp 8,sockets=8,cores=1,threads=1 -uuid 83f90c1c-f0ea-4298-bcdf-3d676de2aeb4 -no-user-config -nodefaults -chardev socket,id=charmonitor,fd=31,server,nowait -mon chardev=charmonitor,id=monitor,mode=control -rtc base=utc,driftfix=slew -global kvm-pit.lost_tick_policy=delay -no-hpet -no-shutdown -global ICH9-LPC.disable_s3=1 -global ICH9-LPC.disable_s4=1 -boot strict=on -device pcie-root-port,port=0x10,chassis=1,id=pci.1,bus=pcie.0,multifunction=on,addr=0x2 -device pcie-root-port,port=0x11,chassis=2,id=pci.2,bus=pcie.0,addr=0x2.0x1 -device pcie-root-port,port=0x12,chassis=3,id=pci.3,bus=pcie.0,addr=0x2.0x2 -device pcie-root-port,port=0x13,chassis=4,id=pci.4,bus=pcie.0,addr=0x2.0x3 -device pcie-root-port,port=0x14,chassis=5,id=pci.5,bus=pcie.0,addr=0x2.0x4 -device pcie-root-port,port=0x15,chassis=6,id=pci.6,bus=pcie.0,addr=0x2.0x5 -device pcie-root-port,port=0x16,chassis=7,id=pci.7,bus=pcie.0,addr=0x2.0x6 -device pcie-root-port,port=0x17,chassis=8,id=pci.8,bus=pcie.0,addr=0x2.0x7 -device qemu-xhci,p2=15,p3=15,id=usb,bus=pci.3,addr=0x0 -device virtio-serial-pci,id=virtio-serial0,bus=pci.4,addr=0x0 -blockdev {\"driver\":\"file\",\"filename\":\"/var/lib/libvirt/images/csr1000v-universalk9.17.02.01v.qcow2\",\"node-name\":\"libvirt-1-storage\",\"auto-read-only\":true,\"discard\":\"unmap\"} -blockdev {\"node-name\":\"libvirt-1-format\",\"read-only\":false,\"driver\":\"qcow2\",\"file\":\"libvirt-1-storage\",\"backing\":null} -device virtio-blk-pci,scsi=off,bus=pci.5,addr=0x0,drive=libvirt-1-format,id=virtio-disk0,bootindex=1 -netdev tap,fd=33,id=hostnet0,vhost=on,vhostfd=34 -device virtio-net-pci,netdev=hostnet0,id=net0,mac=52:54:00:69:ec:73,bus=pci.1,addr=0x0 -chardev pty,id=charserial0 -device isa-serial,chardev=charserial0,id=serial0 -chardev socket,id=charchannel0,fd=35,server,nowait -device virtserialport,bus=virtio-serial0.0,nr=1,chardev=charchannel0,id=channel0,name=org.qemu.guest_agent.0 -chardev spicevmc,id=charchannel1,name=vdagent -device virtserialport,bus=virtio-serial0.0,nr=2,chardev=charchannel1,id=channel1,name=com.redhat.spice.0 -spice port=5900,addr=127.0.0.1,disable-ticketing,image-compression=off,seamless-migration=on -device qxl-vga,id=video0,ram_size=67108864,vram_size=67108864,vram64_size_mb=0,vgamem_mb=16,max_outputs=1,bus=pcie.0,addr=0x1 -device vfio-pci,host=0000:5e:02.0,id=hostdev0,bus=pci.2,addr=0x0 -device vfio-pci,host=0000:5e:0a.0,id=hostdev1,bus=pci.8,addr=0x0 -sandbox on,obsolete=deny,elevateprivileges=deny,spawn=deny,resourcecontrol=deny -msg timestamp=on\n```\n\n使用pstree检查线程信息：\n\n```bash\nroot@ubuntu-kvm:/home/ubuntu# pstree -p 8526\nqemu-system-x86(8526)─┬─{qemu-system-x86}(8530)\n                      ├─{qemu-system-x86}(8534)\n                      ├─{qemu-system-x86}(8535)\n                      ├─{qemu-system-x86}(8536)\n                      ├─{qemu-system-x86}(8537)\n                      ├─{qemu-system-x86}(8538)\n                      ├─{qemu-system-x86}(8539)\n                      ├─{qemu-system-x86}(8540)\n                      ├─{qemu-system-x86}(8541)\n                      ├─{qemu-system-x86}(8542)\n                      ├─{qemu-system-x86}(8552)\n```\n\n使用gbd 调试进程，这里参考<https://www.cnblogs.com/hukey/p/11138768.html>\n\n```bash\nroot@ubuntu-kvm:/home/ubuntu# gdb attach 8526\nGNU gdb (Ubuntu 9.2-0ubuntu1~20.04) 9.2\nCopyright (C) 2020 Free Software Foundation, Inc.\nLicense GPLv3+: GNU GPL version 3 or later <http://gnu.org/licenses/gpl.html>\nThis is free software: you are free to change and redistribute it.\nThere is NO WARRANTY, to the extent permitted by law.\nType \"show copying\" and \"show warranty\" for details.\nThis GDB was configured as \"x86_64-linux-gnu\".\nType \"show configuration\" for configuration details.\nFor bug reporting instructions, please see:\n<http://www.gnu.org/software/gdb/bugs/>.\nFind the GDB manual and other documentation resources online at:\n    <http://www.gnu.org/software/gdb/documentation/>.\n\nFor help, type \"help\".\nType \"apropos word\" to search for commands related to \"word\".\nAttaching to process 8526\n[New LWP 8530]\n[New LWP 8534]\n[New LWP 8535]\n[New LWP 8536]\n[New LWP 8537]\n[New LWP 8538]\n[New LWP 8539]\n[New LWP 8540]\n[New LWP 8541]\n[New LWP 8542]\n[New LWP 8552]\n[New LWP 250213]\n\nwarning: \"target:/usr/bin/qemu-system-x86_64 (deleted)\": could not open as an executable file: No such file or directory.\n\nwarning: `target:/usr/bin/qemu-system-x86_64 (deleted)': can't open to read symbols: No such file or directory.\n\nwarning: Could not load vsyscall page because no executable was specified\n0x00007fdcda986bf6 in ?? ()\n(gdb) info threads\n  Id   Target Id                  Frame\n* 1    LWP 8526 \"qemu-system-x86\" 0x00007fdcda986bf6 in ?? ()\n  2    LWP 8530 \"call_rcu\"        0x00007fdcda98c89d in ?? ()\n  3    LWP 8534 \"IO mon_iothread\" 0x00007fdcda986aff in ?? ()\n  4    LWP 8535 \"CPU 0/KVM\"       0x00007fdcda98850b in ?? ()\n  5    LWP 8536 \"CPU 1/KVM\"       0x00007fdcda98850b in ?? ()\n  6    LWP 8537 \"CPU 2/KVM\"       0x00007fdcda98850b in ?? ()\n  7    LWP 8538 \"CPU 3/KVM\"       0x00007fdcda98850b in ?? ()\n  8    LWP 8539 \"CPU 4/KVM\"       0x00007fdcda98850b in ?? ()\n  9    LWP 8540 \"CPU 5/KVM\"       0x00007fdcda98850b in ?? ()\n  10   LWP 8541 \"CPU 6/KVM\"       0x00007fdcda98850b in ?? ()\n  11   LWP 8542 \"CPU 7/KVM\"       0x00007fdcda98850b in ?? ()\n  12   LWP 8552 \"SPICE Worker\"    0x00007fdcda986aff in ?? ()\n  13   LWP 250213 \"worker\"        0x00007fdcdaa76618 in ?? ()\n```\n\n## Chapter 4 KVM 网络\n\n本章节介绍了以下内容\n\n- Virtual Network -- 阐述为什么需要虚拟网络。从虚拟交换机开始，设想一下如果没有虚拟交换机，有20个虚拟机需要20个物理接口连接至20个物理交换机的端口。引入虚拟交换机，减少服务器的物理接口和物理交换机的接口需求。\n- Libvirt 的三类网络：NAT、Routed(Bridged)、Isolated；使用virsh net-dumpxml default输出xml文件。\n- TUN/TAP设备：属于用户空间的设备，an application can open /dev/net/tun and use an ioctl() function to register a network device in the kernel, which, in turn, presents itself as a tunXX or tapXX device.  TUN设备是一个3层设备，TAP设备是一个2层设备。\n- 简单介绍了Linux Bridge，此处可以使用ip link 命令替代brctl命令，并使用NetworkManager来持久化配置。\n- Open vSwitch简单介绍\n- SR-IOV的介绍：此处可以参考我自己的文档。\n- MACVTAP介绍：It's a newer driver that should simplify our virtualized networking by completely removing tun/tap and bridge drivers with a single module.  有四种模式，VEPA，Bridge，Private和Pass-through。\n\n## Chapter 5 KVM 存储\n\n本章属于囫囵吞枣的看完了，一知半解的记录一下，大致了解了一些存储方面的概念和存储的最新发展。\n\n### 存储资源池\n\nCentOS支持的存储池种类如下：\n\n- Logical Volume Manager (LVM)-based storage pools\n- Directory-based storage pools\n- Partition-based storage pools\n- GlusterFS-based storage pools\n- iSCSI-based storage pools\n- Disk-based storage pools\n- HBA-based storage pools, which use SCSI devices\n\n对于libvirt来说，存储资源池可能是一个目录，一个存储设备，或者是一个文件。\n\n介绍了两种文件系统：\n\n- **Brtfs** is a type of filesystem that supports snapshots, RAID and LVM-like functionality, compression, defragmentation, online resizing, and many other advanced features. It was deprecated after it was discovered that its RAID5/6 can easily lead to a loss of data. --这里说的是Red Hat\n- **ZFS** is a type of filesystem that supports everything that Brtfs does, plus read and write caching. **ZFS is not a part of the Linux kernel.**\n\n### 本地存储池\n\nStratis是随RHEL 8引入的本地管理存储解决方案，它使系统管理员可以配置高级存储功能：\n\n1. Pool-based management\n2. Thin provisioning\n3. File system snapshots\n4. Monitoring\n\nStratis使用示例：\n\n```bash\nmdadm --create /dev/md0 --verbose --level=10 --raid-devices=4 /dev/sdb /dev/sdc /dev/sdd /dev/sde --spare-devices=1 /dev/sdf2\nstratis pool create PacktStratisPool01 /dev/md0\nstratis pool add-cache PacktStratisPool01 /dev/sdg\nstratis fs create PackStratisPool01 PacktStratisXFS01\nmkdir /mnt/packtStratisXFS01\nmount /stratis/PacktStratisPool01/PacktStratisXFS01 /mnt/packtStratisXFS01\n```\n\n### Libvirt Storage Pool\n\nLibvirt 支持多种Storage Pool，详见<https://libvirt.org/storage.html>\n\n- Directory pool\n- Filesystem pool\n- Network filesystem pool\n- Logical volume pool\n- Disk pool\n- iSCSI pool\n- iSCSI direct pool\n- SCSI pool\n- Multipath pool\n- RBD pool\n- Sheepdog pool\n- Gluster pool\n- ZFS pool\n- Vstorage pool\n\n### NFS Storage Pool\n\nNFS自上世纪80年代就出现了，至今依然活跃，尤其是4.2版本以后增强了不少功能；VMware Virtual Volume 6.0 可以提供基于Block和NFS的两种存储访问。\n\nLibvirt 使用NFS Storage Pool示例，也可以使用virt-manager 图形界面创建：\n\n```xml\n<pool type='netfs'>\n    <name>NFSpooll</name>\n    <source>\n        <host name='192.168.159.144' />\n        <dir path='/mnt/packtStratisXF501' />\n        <format type='auto'/>\n    </source>\n    <target>\n        <path>/var/lib/libvirt/images/NFSpooll</path>\n        <permissions>\n            <mode>0755</mode>\n            <owner>0</owner>\n            <group>0</group>\n            <label>system_u:object r:nfs t:s0</label>\n        </permissions>\n    </target>\n</pool>\n```\n\n### iSCIS 和 SAN 存储\n\niSCIS协议有两个主要原因影响其高效性：\n\n- **IP协议封装** iSCSI encapsulates SCSI commands into regular IP packages, which means segmentation and overhead as IP packages have a pretty large header, which means less efficiency.\n- **基于TCP传输** Even worse, it's TCP-based, which means that there are sequence numbers and retransmissions, which can lead to queueing and latency, and the bigger the environment is, the more you usually feel these effects affect your virtual machine performance.\n\nThe iSCSI and FC architectures are very similar—they both need a target (an iSCSI target and an FC target) and an initiator (an iSCS initiator and an FC initiator)，the initiator connects to a target to get access to block storage that's presented via that target.\n\n#### LUN的概念\n\nLUNs are just raw, block capacities that we export via an iSCSI target toward initiators. LUNs are indexed, or numbered, usually from 0 onward. Every LUN number represents a different storage capacity that an initiator can connect to.\n\nFor example, we can have an iSCSI target with three different LUNs—LUN0 with 20 GB, LUN1 with 40 GB, and LUN2 with 60 GB. These will all be hosted on the same storage system's iSCSI target. We can then configure the iSCSI target to accept an IQN to see all the LUNs, another IQN to only see LUN1, and another IQN to only see LUN1 and LUN2. \n\n使用 targetcli命令创建iSCIS target，步骤简要说明如下：\n\n1. 创建/dev/sdb1分区和XFS文件系统，并mount /dev/sdb1 /LUN0，用targetcli创建一个fileio 类型的target后端\n2. 创建/dev/sdc1分区，并直接使用targetcli创建一个block类型的target后端\n3. 基于/dev/sdd创建LVM，并使用targetcli创建一个block类型的target后端\n4. 在KVM主机上设置好iscsi的initiator参数\n5. 回到iSCSI上，创建ACL，允许KVM host，基于1~3创建的target发布LUNs\n6. 在KVM Host上定义Storage Pool的XML文件，用virsh pool-define创建Storage Pool\n\n### Storage redundancy and multipathing\n\n避免单点故障SPOF，网卡、线缆、交换机、存储控制器等等。\n\nKVM Host基于iSCSI做冗余和多路径的配置较为复杂，并且缺少支持，文章建议使用oVirt或者RHEV-H(Red Hat Enterprise Virtualization Hypervisor. )\n\n使用oVirt 创建一个iSCSI Bond来实现冗余和多路径。\n\n### Gluster\n\nGluster 是一个分布式文件系统，其突出优势是可扩展性，数据复制和快照功能；注意Gluster是一个文件存储服务。\n\n生产环境中，Gluster至少配置三台服务器。\n\n配置步骤简要说明如下：\n\n1. 创建磁盘分区以及文件系统 \n\n   ```bash\n   mkfs.xfs /dev/sdb\n   mkdir /gluster/bricks/1 -p\n   echo '/dev/sdb /gluster/bricks/1 xfs defaults 0 0' >> /etc/\n   fstab\n   mount -a\n   mkdir /gluster/bricks/1/brick\n   ```\n\n2. 创建Gluster分布式文件系统\n\n   ```bash\n   gluster volume create kvmgluster replica 3 \\ gluster1:/gluster/\n   bricks/1/brick gluster2:/gluster/bricks/1/brick \\ gluster3:/\n   gluster/bricks/1/brick\n   gluster volume start kvmgluster\n   gluster volume set kvmgluster auth.allow 192.168.159.0/24\n   gluster volume set kvmgluster allow-insecure on\n   gluster volume set kvmgluster storage.owner-uid 107\n   gluster volume set kvmgluster storage.owner-gid 107\n   ```\n\n3. 挂在Gluster文件系统为NFS服务\n\n   ```bash\n   echo 'localhost:/kvmgluster /mnt glusterfs \\ defaults,_\n   netdev,backupvolfile-server=localhost 0 0' >> /etc/fstab\n   mount.glusterfs localhost:/kvmgluster /mnt\n   ```\n\n4. 在KVM主机上挂在Gluster\n\n   ```bash\n   wget \\ https://download.gluster.org/pub/gluster/glusterfs/6/\n   LATEST/CentOS/gl\\ usterfs-rhel8.repo -P /etc/yum.repos.d\n   yum install glusterfs glusterfs-fuse attr -y\n   mount -t glusterfs -o context=\"system_u:object_r:virt_\n   image_t:s0\" \\ gluster1:/kvmgluster /var/lib/libvirt/images/\n   GlusterFS\n   ```\n\n5. 在KVM上定义存储资源池：\n\n   ```xml\n   <pool type='dir'>\n       <name>glusterfs-pool</name>\n       <target>\n           <path>/var/lib/libvirt/images/GlusterFS</path>\n           <permissions>\n               <mode>0755</mode>\n               <owner>107</owner>\n               <group>107</group>\n               <label>system_u:object_r:virt_image_t:s0</label>\n           </permissions>\n       </target>\n   </pool>\n   ```\n\n   ```bash\n   virsh pool-define --file gluster.xml\n   virsh pool-start --pool glusterfs-pool\n   virsh pool-autostart --pool glusterfs-pool\n   ```\n\n将Gluster挂在为目录，可以避免Libvirt在使用Gluster的两个问题：\n\n- We can use Gluster's failover capability, which will be managed automatically by the\n\n  Gluster utilities that we installed directly, as libvirt doesn't support them yet.\n\n- We will avoid creating virtual machine disks *manually*, which is another limitation of libvirt's implementation of Gluster support, while directory-based storage pools support it without any issues.\n\n### Ceph\n\nCeph offers block and object-based storage. Object-based storage for block-based devices means direct, binary storage, directly to a LUN. There are no filesystems involved, which theoretically means less overhead as there's no filesystem, filesystem tables, and other constructs that might slow the I/O process down.\n\nArchitecture-wise, Ceph has three main services:\n\n- ceph-mon : Used for cluster monitoring, CRUSH maps, and Object Storage Daemon (OSD) maps.\n- ceph-osd: This handles actual data storage, replication, and recovery. It requires at least two nodes; we'll use three for clustering reasons.\n- ceph-mds: Metadata server, used when Ceph needs filesystem access.\n\nCeph 集群中，所有的数据节点要求采用相同的硬件配置，相同的CPU、内存、硬盘，不适用RAID控制器，仅仅使用HBA。\n\n```bash\nceph-deploy install ceph-admin ceph-monitor ceph-osd1 ceph-osd2\nceph-osd3\nceph-deploy mon create-initial\nceph-deploy gatherkeys ceph-monitor\nceph-deploy disk list ceph-osd1 ceph-osd2 ceph-osd3\nceph-deploy disk zap ceph-osd1:/dev/sdb  ceph-osd2:/dev/sdb\nceph-osd3:/dev/sdb\nceph-deploy osd prepare ceph-osd1:/dev/sdb ceph-osd2:/dev/sdb\nceph-osd3:/dev/sdb\nceph-deploy osd activate ceph-osd1:/dev/sdb1 ceph-osd2:/dev/\nsdb1 ceph-osd3:/dev/sdb1\n```\n\n对上述命令的说明：\n\n- The first command starts the actual deployment process—for the admin, monitor, and OSD nodes, with the installation of all the necessary packages.\n- The second and third commands configure the monitor host so that it's ready to accept external connections.\n\n- The two disk commands are all about disk preparation—Ceph will clear the disks that we assigned to it (/dev/sdb per OSD host) and create two partitions on them, one for Ceph data and one for the Ceph journal.\n- The last two commands prepare these filesystems for use and activate Ceph. If at any time your ceph-deploy script stops, check your DNS and /etc/hosts and firewalld configuration, as that's where the problems usually are.\n\n使用以下命令将Ceph存储发布给KVM主机作为存储池：\n\n```bash\nceph osd pool create KVMpool 128 128\n```\n\n还需要几个步骤来实现安全的访问，为Ceph的访问增加密码验证。\n\n1. Ceph生成验证的密码 Key\n\n   ```bash\n   ceph auth get-or-create client.KVMpool mon 'allow r' osd 'allow\n   rwx pool=KVMpool'\n   \n   #It's going to throw us a status message, something like this:\n   key = AQB9p8RdqS09CBAA1DHsiZJbehb7ZBffhfmFJQ==\n   \n   ```\n\n2. 定义一个Secret\n\n   ```xml\n   <secret ephemeral='no' private='no'>\n       <usage type='ceph'>\n           <name>client.KVMpool secret</name>\n       </usage>\n   </secret>\n   \n   ```\n\n   将Secret的UUID与Ceph生成的Key进行关联。\n\n   ```bash\n   virsh secret-define --file secret.xml\n   \n   Secret 95b1ed29-16aa-4e95-9917-c2cd4f3b2791 created\n   \n   virsh secret-set-value 95b1ed29-16aa-4e95-9917-c2cd4f3b2791\n   AQB9p8RdqS09CBAA1DHsiZJbehb7ZBffhfmFJQ==\n   ```\n\n3. 定义Ceph存储池\n\n   ```xml\n   <pool type=\"rbd\">\n       <source>\n           <name>KVMpool</name>\n           <host name='192.168.159.151' port='6789'/>\n           <auth username='KVMpool' type='ceph'>\n               <secret uuid='95b1ed29-16aa-4e95-9917-c2cd4f3b2791'/>\n           </auth>\n       </source>\n   </pool>\n   ```\n\n   ```bash\n   virsh pool-define --file ceph.xml\n   virsh pool-start KVMpool\n   virsh pool-autostart KVMpool\n   virsh pool-list --details\n   ```\n\n### 虚拟磁盘镜像和KVM存储基本操作\n\n文章介绍了使用dd命令生成磁盘镜像文件，如下：\n\n生成10G的预分配磁盘文件：\n\n```bash\ndd if=/dev/zero of=/vms/dbvm_disk2.img bs=1G count=10\n```\n\n生成10G的磁盘文件，使用seek关键字，不做预分配\n\n```bash\ndd if=/dev/zero of=/vms/dbvm_disk2_seek.imgbs=1G seek=10 count=0\n```\n\n#### qemu-img 命令\n\n使用qemu-img info查看磁盘文件的信息，如下：\n\n```bash\n# qemu-img info /vms/dbvm_disk2.img\nimage: /vms/dbvm_disk2.img\nfile format: raw\nvirtual size: 10G (10737418240 bytes)\ndisk size: 10G\n# qemu-img info /vms/dbvm_disk2_seek.img\nimage: /vms/dbvm_disk2_seek.img\nfile format: raw\nvirtual size: 10G (10737418240 bytes)\ndisk size: 10M\n```\n\n#### 使用virsh命令加载硬盘\n\n```bash\nvirsh attach-disk CentOS8 /vms/dbvm_disk2.img vdb --live --config\n```\n\n说明如下：\n\n-  **CentOS8** is the virtual machine to which a disk attachment is executed. \n- Then, there is the path of the disk image,  **/vms/dbvm_disk2.img**\n- **vdb** is the target disk name that would be visible inside the guest operating system. \n- **--live** means performing the action while the virtual machine is running.\n- **--config** means attaching it persistently across reboot. Not adding a --config switch will keep the disk attached only until reboot.\n\n查看虚拟机的硬盘信息：\n\n```bash\nvirsh domblklist CentOS8 --details\n\nType Device Target Source\n------------------------------------------------\nfile disk vda /var/lib/libvirt/images/fedora21.qcow2\nfile disk vdb /vms/dbvm_disk2_seek.img\n```\n\n还有其他章节，比如创建ISO库、删除存储池、创建卷和删除卷。\n\n#### 有关NVMe和NVMe over Fabric\n\nSSD存储的存取方式发生改变，主要体现在性能和延时这两方面。传统**AHCI** (Advanced Host Controller Interface) 已不能满足SSD的性能要求。\n\n**NVMe** (Non-Volatile Memory Express) 是一个全新的协议，基于PCIe技术，目的在于满足SSD的高性能、低时延的访问要求。越来越多的存储设备已经集成了SSD和NVMe，主要用于缓存，同时也有用于数据存储的。\n\nFiber Channel，虽然10多年被人争执说要从市场消失，主要原因无外乎：FC需要专用的交换机、专门的网卡和线缆，FC设备贵，需要专门的知识，而且FC的速率没有以太网发展快。\n\n但是，目前市场上发生的情况有所不同，FC可以满足NVMe SSD带来的性能提升的需求。\n\nTwo of these concepts derived from **Intel Optane**—**Storage Class Memory (SCM) and Persistent Memory (PM)** are the latest technologies that storage companies and customers want adopted into their storage systems, and fast.\n\n将工作负载移到内存当中是符合逻辑的，设想一下内存型数据库(Microsoft SQL, SAP HANA, Oracle).\n\n如果一个存储厂商生产了使用SCM SSD的存储设备，那么只有内存可用于缓存(Cache).","slug":"master-kvm-notes-1","published":1,"updated":"2025-12-14T09:50:07.477Z","comments":1,"layout":"post","photos":[],"_id":"cuidWuSRIkDcjEzgyLOvVi3c6","content":"<p>第一章和第二章之前快速阅读过了，没有笔记，等回头再回来整理。</p>\n<h2 id=\"Chapter-3-KVM、virsh、oVirt等\"><a href=\"#Chapter-3-KVM、virsh、oVirt等\" class=\"headerlink\" title=\"Chapter 3 KVM、virsh、oVirt等\"></a>Chapter 3 KVM、virsh、oVirt等</h2><h3 id=\"CentOS-8-的KVM安装\"><a href=\"#CentOS-8-的KVM安装\" class=\"headerlink\" title=\"CentOS 8 的KVM安装\"></a>CentOS 8 的KVM安装</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum module install virt</span><br><span class=\"line\">dnf install qemu-img qemu-kvm libvirt libvirt-client virt-manager \\</span><br><span class=\"line\">virt-install virt-viewer -y</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"安装完后，使用virt-host-validate验证\"><a href=\"#安装完后，使用virt-host-validate验证\" class=\"headerlink\" title=\"安装完后，使用virt-host-validate验证\"></a>安装完后，使用virt-host-validate验证</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@centos7 ~]# virt-host-validate</span><br><span class=\"line\">  QEMU: Checking <span class=\"keyword\">for</span> hardware virtualization                                 : PASS</span><br><span class=\"line\">  QEMU: Checking <span class=\"keyword\">if</span> device /dev/kvm exists                                   : PASS</span><br><span class=\"line\">  QEMU: Checking <span class=\"keyword\">if</span> device /dev/kvm is accessible                            : PASS</span><br><span class=\"line\">  QEMU: Checking <span class=\"keyword\">if</span> device /dev/vhost-net exists                             : PASS</span><br><span class=\"line\">  QEMU: Checking <span class=\"keyword\">if</span> device /dev/net/tun exists                               : PASS</span><br><span class=\"line\">  QEMU: Checking <span class=\"keyword\">for</span> cgroup <span class=\"string\">&#x27;memory&#x27;</span> controller support                      : PASS</span><br><span class=\"line\">  QEMU: Checking <span class=\"keyword\">for</span> cgroup <span class=\"string\">&#x27;memory&#x27;</span> controller mount-point                  : PASS</span><br><span class=\"line\">  QEMU: Checking <span class=\"keyword\">for</span> cgroup <span class=\"string\">&#x27;cpu&#x27;</span> controller support                         : PASS</span><br><span class=\"line\">  QEMU: Checking <span class=\"keyword\">for</span> cgroup <span class=\"string\">&#x27;cpu&#x27;</span> controller mount-point                     : PASS</span><br><span class=\"line\">  QEMU: Checking <span class=\"keyword\">for</span> cgroup <span class=\"string\">&#x27;cpuacct&#x27;</span> controller support                     : PASS</span><br><span class=\"line\">  QEMU: Checking <span class=\"keyword\">for</span> cgroup <span class=\"string\">&#x27;cpuacct&#x27;</span> controller mount-point                 : PASS</span><br><span class=\"line\">  QEMU: Checking <span class=\"keyword\">for</span> cgroup <span class=\"string\">&#x27;cpuset&#x27;</span> controller support                      : PASS</span><br><span class=\"line\">  QEMU: Checking <span class=\"keyword\">for</span> cgroup <span class=\"string\">&#x27;cpuset&#x27;</span> controller mount-point                  : PASS</span><br><span class=\"line\">  QEMU: Checking <span class=\"keyword\">for</span> cgroup <span class=\"string\">&#x27;devices&#x27;</span> controller support                     : PASS</span><br><span class=\"line\">  QEMU: Checking <span class=\"keyword\">for</span> cgroup <span class=\"string\">&#x27;devices&#x27;</span> controller mount-point                 : PASS</span><br><span class=\"line\">  QEMU: Checking <span class=\"keyword\">for</span> cgroup <span class=\"string\">&#x27;blkio&#x27;</span> controller support                       : PASS</span><br><span class=\"line\">  QEMU: Checking <span class=\"keyword\">for</span> cgroup <span class=\"string\">&#x27;blkio&#x27;</span> controller mount-point                   : PASS</span><br><span class=\"line\">  QEMU: Checking <span class=\"keyword\">for</span> device assignment IOMMU support                         : PASS</span><br><span class=\"line\">  QEMU: Checking <span class=\"keyword\">if</span> IOMMU is enabled by kernel                               : PASS</span><br><span class=\"line\">   LXC: Checking <span class=\"keyword\">for</span> Linux &gt;= 2.6.26                                         : PASS</span><br><span class=\"line\">   LXC: Checking <span class=\"keyword\">for</span> namespace ipc                                           : PASS</span><br><span class=\"line\">   LXC: Checking <span class=\"keyword\">for</span> namespace mnt                                           : PASS</span><br><span class=\"line\">   LXC: Checking <span class=\"keyword\">for</span> namespace pid                                           : PASS</span><br><span class=\"line\">   LXC: Checking <span class=\"keyword\">for</span> namespace uts                                           : PASS</span><br><span class=\"line\">   LXC: Checking <span class=\"keyword\">for</span> namespace net                                           : PASS</span><br><span class=\"line\">   LXC: Checking <span class=\"keyword\">for</span> namespace user                                          : PASS</span><br><span class=\"line\">   LXC: Checking <span class=\"keyword\">for</span> cgroup <span class=\"string\">&#x27;memory&#x27;</span> controller support                      : PASS</span><br><span class=\"line\">   LXC: Checking <span class=\"keyword\">for</span> cgroup <span class=\"string\">&#x27;memory&#x27;</span> controller mount-point                  : PASS</span><br><span class=\"line\">   LXC: Checking <span class=\"keyword\">for</span> cgroup <span class=\"string\">&#x27;cpu&#x27;</span> controller support                         : PASS</span><br><span class=\"line\">   LXC: Checking <span class=\"keyword\">for</span> cgroup <span class=\"string\">&#x27;cpu&#x27;</span> controller mount-point                     : PASS</span><br><span class=\"line\">   LXC: Checking <span class=\"keyword\">for</span> cgroup <span class=\"string\">&#x27;cpuacct&#x27;</span> controller support                     : PASS</span><br><span class=\"line\">   LXC: Checking <span class=\"keyword\">for</span> cgroup <span class=\"string\">&#x27;cpuacct&#x27;</span> controller mount-point                 : PASS</span><br><span class=\"line\">   LXC: Checking <span class=\"keyword\">for</span> cgroup <span class=\"string\">&#x27;cpuset&#x27;</span> controller support                      : PASS</span><br><span class=\"line\">   LXC: Checking <span class=\"keyword\">for</span> cgroup <span class=\"string\">&#x27;cpuset&#x27;</span> controller mount-point                  : PASS</span><br><span class=\"line\">   LXC: Checking <span class=\"keyword\">for</span> cgroup <span class=\"string\">&#x27;devices&#x27;</span> controller support                     : PASS</span><br><span class=\"line\">   LXC: Checking <span class=\"keyword\">for</span> cgroup <span class=\"string\">&#x27;devices&#x27;</span> controller mount-point                 : PASS</span><br><span class=\"line\">   LXC: Checking <span class=\"keyword\">for</span> cgroup <span class=\"string\">&#x27;blkio&#x27;</span> controller support                       : PASS</span><br><span class=\"line\">   LXC: Checking <span class=\"keyword\">for</span> cgroup <span class=\"string\">&#x27;blkio&#x27;</span> controller mount-point                   : PASS</span><br><span class=\"line\">   LXC: Checking <span class=\"keyword\">if</span> device /sys/fs/fuse/connections exists                   : PASS</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"使用virt-install-安装虚拟机\"><a href=\"#使用virt-install-安装虚拟机\" class=\"headerlink\" title=\"使用virt-install 安装虚拟机\"></a>使用virt-install 安装虚拟机</h3><p>编辑anaconda-ks.cfg文件，使用以下参数可以实现虚机部署的静默安装。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">virt-install --virt-type=kvm --name=MasteringKVM02 --ram=4096</span><br><span class=\"line\">--vcpus=4 --os-variant=rhel8.0 --location=/var/lib/libvirt/</span><br><span class=\"line\">images/ CentOS-8-x86_64-1905-dvd1.iso --network=default</span><br><span class=\"line\">--graphics vnc --disk size=16 -x <span class=\"string\">&quot;ks=http://10.10.48.1/ks.cfg&quot;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"oVirt\"><a href=\"#oVirt\" class=\"headerlink\" title=\"oVirt\"></a>oVirt</h3><p>oVirt（Open Virtualization Manager）是一款免费开源虚拟化软件，是RedHat商业版本虚拟化软件RHEV的开源版本。</p>\n<p>oVirt基于kvm，并整合使用了libvirt、gluster、patternfly、ansible等一系列优秀的开源软件。</p>\n<h3 id=\"探索虚拟机Qemu-kvm进程\"><a href=\"#探索虚拟机Qemu-kvm进程\" class=\"headerlink\" title=\"探索虚拟机Qemu-kvm进程\"></a>探索虚拟机Qemu-kvm进程</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@ubuntu-kvm:/home/ubuntu# ps aux | grep qemu</span><br><span class=\"line\">libvirt+    8526  255  0.1 13876708 653744 ?     SLl  Feb01 61850:36 /usr/bin/qemu-system-x86_64 -name guest=csr1kv-1,debug-threads=on -S -object secret,<span class=\"built_in\">id</span>=masterKey0,format=raw,file=/var/lib/libvirt/qemu/domain-4-csr1kv-1/master-key.aes -machine pc-q35-4.2,accel=kvm,usb=off,vmport=off,dump-guest-core=off,mem-merge=off -cpu host -m 8192 -mem-prealloc -mem-path /dev/hugepages/libvirt/qemu/4-csr1kv-1 -overcommit mem-lock=on -smp 8,sockets=8,cores=1,threads=1 -uuid 83f90c1c-f0ea-4298-bcdf-3d676de2aeb4 -no-user-config -nodefaults -chardev socket,<span class=\"built_in\">id</span>=charmonitor,fd=31,server,nowait -mon chardev=charmonitor,<span class=\"built_in\">id</span>=monitor,mode=control -rtc base=utc,driftfix=slew -global kvm-pit.lost_tick_policy=delay -no-hpet -no-shutdown -global ICH9-LPC.disable_s3=1 -global ICH9-LPC.disable_s4=1 -boot strict=on -device pcie-root-port,port=0x10,chassis=1,<span class=\"built_in\">id</span>=pci.1,bus=pcie.0,multifunction=on,addr=0x2 -device pcie-root-port,port=0x11,chassis=2,<span class=\"built_in\">id</span>=pci.2,bus=pcie.0,addr=0x2.0x1 -device pcie-root-port,port=0x12,chassis=3,<span class=\"built_in\">id</span>=pci.3,bus=pcie.0,addr=0x2.0x2 -device pcie-root-port,port=0x13,chassis=4,<span class=\"built_in\">id</span>=pci.4,bus=pcie.0,addr=0x2.0x3 -device pcie-root-port,port=0x14,chassis=5,<span class=\"built_in\">id</span>=pci.5,bus=pcie.0,addr=0x2.0x4 -device pcie-root-port,port=0x15,chassis=6,<span class=\"built_in\">id</span>=pci.6,bus=pcie.0,addr=0x2.0x5 -device pcie-root-port,port=0x16,chassis=7,<span class=\"built_in\">id</span>=pci.7,bus=pcie.0,addr=0x2.0x6 -device pcie-root-port,port=0x17,chassis=8,<span class=\"built_in\">id</span>=pci.8,bus=pcie.0,addr=0x2.0x7 -device qemu-xhci,p2=15,p3=15,<span class=\"built_in\">id</span>=usb,bus=pci.3,addr=0x0 -device virtio-serial-pci,<span class=\"built_in\">id</span>=virtio-serial0,bus=pci.4,addr=0x0 -blockdev &#123;<span class=\"string\">&quot;driver&quot;</span>:<span class=\"string\">&quot;file&quot;</span>,<span class=\"string\">&quot;filename&quot;</span>:<span class=\"string\">&quot;/var/lib/libvirt/images/csr1000v-universalk9.17.02.01v.qcow2&quot;</span>,<span class=\"string\">&quot;node-name&quot;</span>:<span class=\"string\">&quot;libvirt-1-storage&quot;</span>,<span class=\"string\">&quot;auto-read-only&quot;</span>:<span class=\"literal\">true</span>,<span class=\"string\">&quot;discard&quot;</span>:<span class=\"string\">&quot;unmap&quot;</span>&#125; -blockdev &#123;<span class=\"string\">&quot;node-name&quot;</span>:<span class=\"string\">&quot;libvirt-1-format&quot;</span>,<span class=\"string\">&quot;read-only&quot;</span>:<span class=\"literal\">false</span>,<span class=\"string\">&quot;driver&quot;</span>:<span class=\"string\">&quot;qcow2&quot;</span>,<span class=\"string\">&quot;file&quot;</span>:<span class=\"string\">&quot;libvirt-1-storage&quot;</span>,<span class=\"string\">&quot;backing&quot;</span>:null&#125; -device virtio-blk-pci,scsi=off,bus=pci.5,addr=0x0,drive=libvirt-1-format,<span class=\"built_in\">id</span>=virtio-disk0,bootindex=1 -netdev tap,fd=33,<span class=\"built_in\">id</span>=hostnet0,vhost=on,vhostfd=34 -device virtio-net-pci,netdev=hostnet0,<span class=\"built_in\">id</span>=net0,mac=52:54:00:69:ec:73,bus=pci.1,addr=0x0 -chardev pty,<span class=\"built_in\">id</span>=charserial0 -device isa-serial,chardev=charserial0,<span class=\"built_in\">id</span>=serial0 -chardev socket,<span class=\"built_in\">id</span>=charchannel0,fd=35,server,nowait -device virtserialport,bus=virtio-serial0.0,nr=1,chardev=charchannel0,<span class=\"built_in\">id</span>=channel0,name=org.qemu.guest_agent.0 -chardev spicevmc,<span class=\"built_in\">id</span>=charchannel1,name=vdagent -device virtserialport,bus=virtio-serial0.0,nr=2,chardev=charchannel1,<span class=\"built_in\">id</span>=channel1,name=com.redhat.spice.0 -spice port=5900,addr=127.0.0.1,disable-ticketing,image-compression=off,seamless-migration=on -device qxl-vga,<span class=\"built_in\">id</span>=video0,ram_size=67108864,vram_size=67108864,vram64_size_mb=0,vgamem_mb=16,max_outputs=1,bus=pcie.0,addr=0x1 -device vfio-pci,host=0000:5e:02.0,<span class=\"built_in\">id</span>=hostdev0,bus=pci.2,addr=0x0 -device vfio-pci,host=0000:5e:0a.0,<span class=\"built_in\">id</span>=hostdev1,bus=pci.8,addr=0x0 -sandbox on,obsolete=deny,elevateprivileges=deny,spawn=deny,resourcecontrol=deny -msg timestamp=on</span><br></pre></td></tr></table></figure>\n\n<p>使用pstree检查线程信息：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@ubuntu-kvm:/home/ubuntu# pstree -p 8526</span><br><span class=\"line\">qemu-system-x86(8526)─┬─&#123;qemu-system-x86&#125;(8530)</span><br><span class=\"line\">                      ├─&#123;qemu-system-x86&#125;(8534)</span><br><span class=\"line\">                      ├─&#123;qemu-system-x86&#125;(8535)</span><br><span class=\"line\">                      ├─&#123;qemu-system-x86&#125;(8536)</span><br><span class=\"line\">                      ├─&#123;qemu-system-x86&#125;(8537)</span><br><span class=\"line\">                      ├─&#123;qemu-system-x86&#125;(8538)</span><br><span class=\"line\">                      ├─&#123;qemu-system-x86&#125;(8539)</span><br><span class=\"line\">                      ├─&#123;qemu-system-x86&#125;(8540)</span><br><span class=\"line\">                      ├─&#123;qemu-system-x86&#125;(8541)</span><br><span class=\"line\">                      ├─&#123;qemu-system-x86&#125;(8542)</span><br><span class=\"line\">                      ├─&#123;qemu-system-x86&#125;(8552)</span><br></pre></td></tr></table></figure>\n\n<p>使用gbd 调试进程，这里参考<a href=\"https://www.cnblogs.com/hukey/p/11138768.html\">https://www.cnblogs.com/hukey/p/11138768.html</a></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@ubuntu-kvm:/home/ubuntu# gdb attach 8526</span><br><span class=\"line\">GNU gdb (Ubuntu 9.2-0ubuntu1~20.04) 9.2</span><br><span class=\"line\">Copyright (C) 2020 Free Software Foundation, Inc.</span><br><span class=\"line\">License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;</span><br><span class=\"line\">This is free software: you are free to change and redistribute it.</span><br><span class=\"line\">There is NO WARRANTY, to the extent permitted by law.</span><br><span class=\"line\">Type <span class=\"string\">&quot;show copying&quot;</span> and <span class=\"string\">&quot;show warranty&quot;</span> <span class=\"keyword\">for</span> details.</span><br><span class=\"line\">This GDB was configured as <span class=\"string\">&quot;x86_64-linux-gnu&quot;</span>.</span><br><span class=\"line\">Type <span class=\"string\">&quot;show configuration&quot;</span> <span class=\"keyword\">for</span> configuration details.</span><br><span class=\"line\">For bug reporting instructions, please see:</span><br><span class=\"line\">&lt;http://www.gnu.org/software/gdb/bugs/&gt;.</span><br><span class=\"line\">Find the GDB manual and other documentation resources online at:</span><br><span class=\"line\">    &lt;http://www.gnu.org/software/gdb/documentation/&gt;.</span><br><span class=\"line\"></span><br><span class=\"line\">For <span class=\"built_in\">help</span>, <span class=\"built_in\">type</span> <span class=\"string\">&quot;help&quot;</span>.</span><br><span class=\"line\">Type <span class=\"string\">&quot;apropos word&quot;</span> to search <span class=\"keyword\">for</span> commands related to <span class=\"string\">&quot;word&quot;</span>.</span><br><span class=\"line\">Attaching to process 8526</span><br><span class=\"line\">[New LWP 8530]</span><br><span class=\"line\">[New LWP 8534]</span><br><span class=\"line\">[New LWP 8535]</span><br><span class=\"line\">[New LWP 8536]</span><br><span class=\"line\">[New LWP 8537]</span><br><span class=\"line\">[New LWP 8538]</span><br><span class=\"line\">[New LWP 8539]</span><br><span class=\"line\">[New LWP 8540]</span><br><span class=\"line\">[New LWP 8541]</span><br><span class=\"line\">[New LWP 8542]</span><br><span class=\"line\">[New LWP 8552]</span><br><span class=\"line\">[New LWP 250213]</span><br><span class=\"line\"></span><br><span class=\"line\">warning: <span class=\"string\">&quot;target:/usr/bin/qemu-system-x86_64 (deleted)&quot;</span>: could not open as an executable file: No such file or directory.</span><br><span class=\"line\"></span><br><span class=\"line\">warning: `target:/usr/bin/qemu-system-x86_64 (deleted)<span class=\"string\">&#x27;: can&#x27;</span>t open to <span class=\"built_in\">read</span> symbols: No such file or directory.</span><br><span class=\"line\"></span><br><span class=\"line\">warning: Could not load vsyscall page because no executable was specified</span><br><span class=\"line\">0x00007fdcda986bf6 <span class=\"keyword\">in</span> ?? ()</span><br><span class=\"line\">(gdb) info threads</span><br><span class=\"line\">  Id   Target Id                  Frame</span><br><span class=\"line\">* 1    LWP 8526 <span class=\"string\">&quot;qemu-system-x86&quot;</span> 0x00007fdcda986bf6 <span class=\"keyword\">in</span> ?? ()</span><br><span class=\"line\">  2    LWP 8530 <span class=\"string\">&quot;call_rcu&quot;</span>        0x00007fdcda98c89d <span class=\"keyword\">in</span> ?? ()</span><br><span class=\"line\">  3    LWP 8534 <span class=\"string\">&quot;IO mon_iothread&quot;</span> 0x00007fdcda986aff <span class=\"keyword\">in</span> ?? ()</span><br><span class=\"line\">  4    LWP 8535 <span class=\"string\">&quot;CPU 0/KVM&quot;</span>       0x00007fdcda98850b <span class=\"keyword\">in</span> ?? ()</span><br><span class=\"line\">  5    LWP 8536 <span class=\"string\">&quot;CPU 1/KVM&quot;</span>       0x00007fdcda98850b <span class=\"keyword\">in</span> ?? ()</span><br><span class=\"line\">  6    LWP 8537 <span class=\"string\">&quot;CPU 2/KVM&quot;</span>       0x00007fdcda98850b <span class=\"keyword\">in</span> ?? ()</span><br><span class=\"line\">  7    LWP 8538 <span class=\"string\">&quot;CPU 3/KVM&quot;</span>       0x00007fdcda98850b <span class=\"keyword\">in</span> ?? ()</span><br><span class=\"line\">  8    LWP 8539 <span class=\"string\">&quot;CPU 4/KVM&quot;</span>       0x00007fdcda98850b <span class=\"keyword\">in</span> ?? ()</span><br><span class=\"line\">  9    LWP 8540 <span class=\"string\">&quot;CPU 5/KVM&quot;</span>       0x00007fdcda98850b <span class=\"keyword\">in</span> ?? ()</span><br><span class=\"line\">  10   LWP 8541 <span class=\"string\">&quot;CPU 6/KVM&quot;</span>       0x00007fdcda98850b <span class=\"keyword\">in</span> ?? ()</span><br><span class=\"line\">  11   LWP 8542 <span class=\"string\">&quot;CPU 7/KVM&quot;</span>       0x00007fdcda98850b <span class=\"keyword\">in</span> ?? ()</span><br><span class=\"line\">  12   LWP 8552 <span class=\"string\">&quot;SPICE Worker&quot;</span>    0x00007fdcda986aff <span class=\"keyword\">in</span> ?? ()</span><br><span class=\"line\">  13   LWP 250213 <span class=\"string\">&quot;worker&quot;</span>        0x00007fdcdaa76618 <span class=\"keyword\">in</span> ?? ()</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"Chapter-4-KVM-网络\"><a href=\"#Chapter-4-KVM-网络\" class=\"headerlink\" title=\"Chapter 4 KVM 网络\"></a>Chapter 4 KVM 网络</h2><p>本章节介绍了以下内容</p>\n<ul>\n<li>Virtual Network – 阐述为什么需要虚拟网络。从虚拟交换机开始，设想一下如果没有虚拟交换机，有20个虚拟机需要20个物理接口连接至20个物理交换机的端口。引入虚拟交换机，减少服务器的物理接口和物理交换机的接口需求。</li>\n<li>Libvirt 的三类网络：NAT、Routed(Bridged)、Isolated；使用virsh net-dumpxml default输出xml文件。</li>\n<li>TUN&#x2F;TAP设备：属于用户空间的设备，an application can open &#x2F;dev&#x2F;net&#x2F;tun and use an ioctl() function to register a network device in the kernel, which, in turn, presents itself as a tunXX or tapXX device.  TUN设备是一个3层设备，TAP设备是一个2层设备。</li>\n<li>简单介绍了Linux Bridge，此处可以使用ip link 命令替代brctl命令，并使用NetworkManager来持久化配置。</li>\n<li>Open vSwitch简单介绍</li>\n<li>SR-IOV的介绍：此处可以参考我自己的文档。</li>\n<li>MACVTAP介绍：It’s a newer driver that should simplify our virtualized networking by completely removing tun&#x2F;tap and bridge drivers with a single module.  有四种模式，VEPA，Bridge，Private和Pass-through。</li>\n</ul>\n<h2 id=\"Chapter-5-KVM-存储\"><a href=\"#Chapter-5-KVM-存储\" class=\"headerlink\" title=\"Chapter 5 KVM 存储\"></a>Chapter 5 KVM 存储</h2><p>本章属于囫囵吞枣的看完了，一知半解的记录一下，大致了解了一些存储方面的概念和存储的最新发展。</p>\n<h3 id=\"存储资源池\"><a href=\"#存储资源池\" class=\"headerlink\" title=\"存储资源池\"></a>存储资源池</h3><p>CentOS支持的存储池种类如下：</p>\n<ul>\n<li>Logical Volume Manager (LVM)-based storage pools</li>\n<li>Directory-based storage pools</li>\n<li>Partition-based storage pools</li>\n<li>GlusterFS-based storage pools</li>\n<li>iSCSI-based storage pools</li>\n<li>Disk-based storage pools</li>\n<li>HBA-based storage pools, which use SCSI devices</li>\n</ul>\n<p>对于libvirt来说，存储资源池可能是一个目录，一个存储设备，或者是一个文件。</p>\n<p>介绍了两种文件系统：</p>\n<ul>\n<li><strong>Brtfs</strong> is a type of filesystem that supports snapshots, RAID and LVM-like functionality, compression, defragmentation, online resizing, and many other advanced features. It was deprecated after it was discovered that its RAID5&#x2F;6 can easily lead to a loss of data. –这里说的是Red Hat</li>\n<li><strong>ZFS</strong> is a type of filesystem that supports everything that Brtfs does, plus read and write caching. <strong>ZFS is not a part of the Linux kernel.</strong></li>\n</ul>\n<h3 id=\"本地存储池\"><a href=\"#本地存储池\" class=\"headerlink\" title=\"本地存储池\"></a>本地存储池</h3><p>Stratis是随RHEL 8引入的本地管理存储解决方案，它使系统管理员可以配置高级存储功能：</p>\n<ol>\n<li>Pool-based management</li>\n<li>Thin provisioning</li>\n<li>File system snapshots</li>\n<li>Monitoring</li>\n</ol>\n<p>Stratis使用示例：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mdadm --create /dev/md0 --verbose --level=10 --raid-devices=4 /dev/sdb /dev/sdc /dev/sdd /dev/sde --spare-devices=1 /dev/sdf2</span><br><span class=\"line\">stratis pool create PacktStratisPool01 /dev/md0</span><br><span class=\"line\">stratis pool add-cache PacktStratisPool01 /dev/sdg</span><br><span class=\"line\">stratis fs create PackStratisPool01 PacktStratisXFS01</span><br><span class=\"line\"><span class=\"built_in\">mkdir</span> /mnt/packtStratisXFS01</span><br><span class=\"line\">mount /stratis/PacktStratisPool01/PacktStratisXFS01 /mnt/packtStratisXFS01</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"Libvirt-Storage-Pool\"><a href=\"#Libvirt-Storage-Pool\" class=\"headerlink\" title=\"Libvirt Storage Pool\"></a>Libvirt Storage Pool</h3><p>Libvirt 支持多种Storage Pool，详见<a href=\"https://libvirt.org/storage.html\">https://libvirt.org/storage.html</a></p>\n<ul>\n<li>Directory pool</li>\n<li>Filesystem pool</li>\n<li>Network filesystem pool</li>\n<li>Logical volume pool</li>\n<li>Disk pool</li>\n<li>iSCSI pool</li>\n<li>iSCSI direct pool</li>\n<li>SCSI pool</li>\n<li>Multipath pool</li>\n<li>RBD pool</li>\n<li>Sheepdog pool</li>\n<li>Gluster pool</li>\n<li>ZFS pool</li>\n<li>Vstorage pool</li>\n</ul>\n<h3 id=\"NFS-Storage-Pool\"><a href=\"#NFS-Storage-Pool\" class=\"headerlink\" title=\"NFS Storage Pool\"></a>NFS Storage Pool</h3><p>NFS自上世纪80年代就出现了，至今依然活跃，尤其是4.2版本以后增强了不少功能；VMware Virtual Volume 6.0 可以提供基于Block和NFS的两种存储访问。</p>\n<p>Libvirt 使用NFS Storage Pool示例，也可以使用virt-manager 图形界面创建：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">pool</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;netfs&#x27;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">name</span>&gt;</span>NFSpooll<span class=\"tag\">&lt;/<span class=\"name\">name</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">source</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">host</span> <span class=\"attr\">name</span>=<span class=\"string\">&#x27;192.168.159.144&#x27;</span> /&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">dir</span> <span class=\"attr\">path</span>=<span class=\"string\">&#x27;/mnt/packtStratisXF501&#x27;</span> /&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">format</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;auto&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">source</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">target</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">path</span>&gt;</span>/var/lib/libvirt/images/NFSpooll<span class=\"tag\">&lt;/<span class=\"name\">path</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">permissions</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">mode</span>&gt;</span>0755<span class=\"tag\">&lt;/<span class=\"name\">mode</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">owner</span>&gt;</span>0<span class=\"tag\">&lt;/<span class=\"name\">owner</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">group</span>&gt;</span>0<span class=\"tag\">&lt;/<span class=\"name\">group</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">label</span>&gt;</span>system_u:object r:nfs t:s0<span class=\"tag\">&lt;/<span class=\"name\">label</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">permissions</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">target</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">pool</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"iSCIS-和-SAN-存储\"><a href=\"#iSCIS-和-SAN-存储\" class=\"headerlink\" title=\"iSCIS 和 SAN 存储\"></a>iSCIS 和 SAN 存储</h3><p>iSCIS协议有两个主要原因影响其高效性：</p>\n<ul>\n<li><strong>IP协议封装</strong> iSCSI encapsulates SCSI commands into regular IP packages, which means segmentation and overhead as IP packages have a pretty large header, which means less efficiency.</li>\n<li><strong>基于TCP传输</strong> Even worse, it’s TCP-based, which means that there are sequence numbers and retransmissions, which can lead to queueing and latency, and the bigger the environment is, the more you usually feel these effects affect your virtual machine performance.</li>\n</ul>\n<p>The iSCSI and FC architectures are very similar—they both need a target (an iSCSI target and an FC target) and an initiator (an iSCS initiator and an FC initiator)，the initiator connects to a target to get access to block storage that’s presented via that target.</p>\n<h4 id=\"LUN的概念\"><a href=\"#LUN的概念\" class=\"headerlink\" title=\"LUN的概念\"></a>LUN的概念</h4><p>LUNs are just raw, block capacities that we export via an iSCSI target toward initiators. LUNs are indexed, or numbered, usually from 0 onward. Every LUN number represents a different storage capacity that an initiator can connect to.</p>\n<p>For example, we can have an iSCSI target with three different LUNs—LUN0 with 20 GB, LUN1 with 40 GB, and LUN2 with 60 GB. These will all be hosted on the same storage system’s iSCSI target. We can then configure the iSCSI target to accept an IQN to see all the LUNs, another IQN to only see LUN1, and another IQN to only see LUN1 and LUN2. </p>\n<p>使用 targetcli命令创建iSCIS target，步骤简要说明如下：</p>\n<ol>\n<li>创建&#x2F;dev&#x2F;sdb1分区和XFS文件系统，并mount &#x2F;dev&#x2F;sdb1 &#x2F;LUN0，用targetcli创建一个fileio 类型的target后端</li>\n<li>创建&#x2F;dev&#x2F;sdc1分区，并直接使用targetcli创建一个block类型的target后端</li>\n<li>基于&#x2F;dev&#x2F;sdd创建LVM，并使用targetcli创建一个block类型的target后端</li>\n<li>在KVM主机上设置好iscsi的initiator参数</li>\n<li>回到iSCSI上，创建ACL，允许KVM host，基于1~3创建的target发布LUNs</li>\n<li>在KVM Host上定义Storage Pool的XML文件，用virsh pool-define创建Storage Pool</li>\n</ol>\n<h3 id=\"Storage-redundancy-and-multipathing\"><a href=\"#Storage-redundancy-and-multipathing\" class=\"headerlink\" title=\"Storage redundancy and multipathing\"></a>Storage redundancy and multipathing</h3><p>避免单点故障SPOF，网卡、线缆、交换机、存储控制器等等。</p>\n<p>KVM Host基于iSCSI做冗余和多路径的配置较为复杂，并且缺少支持，文章建议使用oVirt或者RHEV-H(Red Hat Enterprise Virtualization Hypervisor. )</p>\n<p>使用oVirt 创建一个iSCSI Bond来实现冗余和多路径。</p>\n<h3 id=\"Gluster\"><a href=\"#Gluster\" class=\"headerlink\" title=\"Gluster\"></a>Gluster</h3><p>Gluster 是一个分布式文件系统，其突出优势是可扩展性，数据复制和快照功能；注意Gluster是一个文件存储服务。</p>\n<p>生产环境中，Gluster至少配置三台服务器。</p>\n<p>配置步骤简要说明如下：</p>\n<ol>\n<li><p>创建磁盘分区以及文件系统 </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mkfs.xfs /dev/sdb</span><br><span class=\"line\"><span class=\"built_in\">mkdir</span> /gluster/bricks/1 -p</span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&#x27;/dev/sdb /gluster/bricks/1 xfs defaults 0 0&#x27;</span> &gt;&gt; /etc/</span><br><span class=\"line\">fstab</span><br><span class=\"line\">mount -a</span><br><span class=\"line\"><span class=\"built_in\">mkdir</span> /gluster/bricks/1/brick</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>创建Gluster分布式文件系统</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gluster volume create kvmgluster replica 3 \\ gluster1:/gluster/</span><br><span class=\"line\">bricks/1/brick gluster2:/gluster/bricks/1/brick \\ gluster3:/</span><br><span class=\"line\">gluster/bricks/1/brick</span><br><span class=\"line\">gluster volume start kvmgluster</span><br><span class=\"line\">gluster volume <span class=\"built_in\">set</span> kvmgluster auth.allow 192.168.159.0/24</span><br><span class=\"line\">gluster volume <span class=\"built_in\">set</span> kvmgluster allow-insecure on</span><br><span class=\"line\">gluster volume <span class=\"built_in\">set</span> kvmgluster storage.owner-uid 107</span><br><span class=\"line\">gluster volume <span class=\"built_in\">set</span> kvmgluster storage.owner-gid 107</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>挂在Gluster文件系统为NFS服务</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&#x27;localhost:/kvmgluster /mnt glusterfs \\ defaults,_</span></span><br><span class=\"line\"><span class=\"string\">netdev,backupvolfile-server=localhost 0 0&#x27;</span> &gt;&gt; /etc/fstab</span><br><span class=\"line\">mount.glusterfs localhost:/kvmgluster /mnt</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>在KVM主机上挂在Gluster</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget \\ https://download.gluster.org/pub/gluster/glusterfs/6/</span><br><span class=\"line\">LATEST/CentOS/gl\\ usterfs-rhel8.repo -P /etc/yum.repos.d</span><br><span class=\"line\">yum install glusterfs glusterfs-fuse attr -y</span><br><span class=\"line\">mount -t glusterfs -o context=<span class=\"string\">&quot;system_u:object_r:virt_</span></span><br><span class=\"line\"><span class=\"string\">image_t:s0&quot;</span> \\ gluster1:/kvmgluster /var/lib/libvirt/images/</span><br><span class=\"line\">GlusterFS</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>在KVM上定义存储资源池：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">pool</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;dir&#x27;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">name</span>&gt;</span>glusterfs-pool<span class=\"tag\">&lt;/<span class=\"name\">name</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">target</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">path</span>&gt;</span>/var/lib/libvirt/images/GlusterFS<span class=\"tag\">&lt;/<span class=\"name\">path</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">permissions</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">mode</span>&gt;</span>0755<span class=\"tag\">&lt;/<span class=\"name\">mode</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">owner</span>&gt;</span>107<span class=\"tag\">&lt;/<span class=\"name\">owner</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">group</span>&gt;</span>107<span class=\"tag\">&lt;/<span class=\"name\">group</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">label</span>&gt;</span>system_u:object_r:virt_image_t:s0<span class=\"tag\">&lt;/<span class=\"name\">label</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">permissions</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">target</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">pool</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">virsh pool-define --file gluster.xml</span><br><span class=\"line\">virsh pool-start --pool glusterfs-pool</span><br><span class=\"line\">virsh pool-autostart --pool glusterfs-pool</span><br></pre></td></tr></table></figure></li>\n</ol>\n<p>将Gluster挂在为目录，可以避免Libvirt在使用Gluster的两个问题：</p>\n<ul>\n<li><p>We can use Gluster’s failover capability, which will be managed automatically by the</p>\n<p>Gluster utilities that we installed directly, as libvirt doesn’t support them yet.</p>\n</li>\n<li><p>We will avoid creating virtual machine disks <em>manually</em>, which is another limitation of libvirt’s implementation of Gluster support, while directory-based storage pools support it without any issues.</p>\n</li>\n</ul>\n<h3 id=\"Ceph\"><a href=\"#Ceph\" class=\"headerlink\" title=\"Ceph\"></a>Ceph</h3><p>Ceph offers block and object-based storage. Object-based storage for block-based devices means direct, binary storage, directly to a LUN. There are no filesystems involved, which theoretically means less overhead as there’s no filesystem, filesystem tables, and other constructs that might slow the I&#x2F;O process down.</p>\n<p>Architecture-wise, Ceph has three main services:</p>\n<ul>\n<li>ceph-mon : Used for cluster monitoring, CRUSH maps, and Object Storage Daemon (OSD) maps.</li>\n<li>ceph-osd: This handles actual data storage, replication, and recovery. It requires at least two nodes; we’ll use three for clustering reasons.</li>\n<li>ceph-mds: Metadata server, used when Ceph needs filesystem access.</li>\n</ul>\n<p>Ceph 集群中，所有的数据节点要求采用相同的硬件配置，相同的CPU、内存、硬盘，不适用RAID控制器，仅仅使用HBA。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ceph-deploy install ceph-admin ceph-monitor ceph-osd1 ceph-osd2</span><br><span class=\"line\">ceph-osd3</span><br><span class=\"line\">ceph-deploy mon create-initial</span><br><span class=\"line\">ceph-deploy gatherkeys ceph-monitor</span><br><span class=\"line\">ceph-deploy disk list ceph-osd1 ceph-osd2 ceph-osd3</span><br><span class=\"line\">ceph-deploy disk zap ceph-osd1:/dev/sdb  ceph-osd2:/dev/sdb</span><br><span class=\"line\">ceph-osd3:/dev/sdb</span><br><span class=\"line\">ceph-deploy osd prepare ceph-osd1:/dev/sdb ceph-osd2:/dev/sdb</span><br><span class=\"line\">ceph-osd3:/dev/sdb</span><br><span class=\"line\">ceph-deploy osd activate ceph-osd1:/dev/sdb1 ceph-osd2:/dev/</span><br><span class=\"line\">sdb1 ceph-osd3:/dev/sdb1</span><br></pre></td></tr></table></figure>\n\n<p>对上述命令的说明：</p>\n<ul>\n<li><p>The first command starts the actual deployment process—for the admin, monitor, and OSD nodes, with the installation of all the necessary packages.</p>\n</li>\n<li><p>The second and third commands configure the monitor host so that it’s ready to accept external connections.</p>\n</li>\n<li><p>The two disk commands are all about disk preparation—Ceph will clear the disks that we assigned to it (&#x2F;dev&#x2F;sdb per OSD host) and create two partitions on them, one for Ceph data and one for the Ceph journal.</p>\n</li>\n<li><p>The last two commands prepare these filesystems for use and activate Ceph. If at any time your ceph-deploy script stops, check your DNS and &#x2F;etc&#x2F;hosts and firewalld configuration, as that’s where the problems usually are.</p>\n</li>\n</ul>\n<p>使用以下命令将Ceph存储发布给KVM主机作为存储池：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ceph osd pool create KVMpool 128 128</span><br></pre></td></tr></table></figure>\n\n<p>还需要几个步骤来实现安全的访问，为Ceph的访问增加密码验证。</p>\n<ol>\n<li><p>Ceph生成验证的密码 Key</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ceph auth get-or-create client.KVMpool mon <span class=\"string\">&#x27;allow r&#x27;</span> osd <span class=\"string\">&#x27;allow</span></span><br><span class=\"line\"><span class=\"string\">rwx pool=KVMpool&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#It&#x27;s going to throw us a status message, something like this:</span></span><br><span class=\"line\">key = AQB9p8RdqS09CBAA1DHsiZJbehb7ZBffhfmFJQ==</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>定义一个Secret</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">secret</span> <span class=\"attr\">ephemeral</span>=<span class=\"string\">&#x27;no&#x27;</span> <span class=\"attr\">private</span>=<span class=\"string\">&#x27;no&#x27;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">usage</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;ceph&#x27;</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">name</span>&gt;</span>client.KVMpool secret<span class=\"tag\">&lt;/<span class=\"name\">name</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">usage</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">secret</span>&gt;</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>将Secret的UUID与Ceph生成的Key进行关联。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">virsh secret-define --file secret.xml</span><br><span class=\"line\"></span><br><span class=\"line\">Secret 95b1ed29-16aa-4e95-9917-c2cd4f3b2791 created</span><br><span class=\"line\"></span><br><span class=\"line\">virsh secret-set-value 95b1ed29-16aa-4e95-9917-c2cd4f3b2791</span><br><span class=\"line\">AQB9p8RdqS09CBAA1DHsiZJbehb7ZBffhfmFJQ==</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>定义Ceph存储池</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">pool</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;rbd&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">source</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">name</span>&gt;</span>KVMpool<span class=\"tag\">&lt;/<span class=\"name\">name</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">host</span> <span class=\"attr\">name</span>=<span class=\"string\">&#x27;192.168.159.151&#x27;</span> <span class=\"attr\">port</span>=<span class=\"string\">&#x27;6789&#x27;</span>/&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">auth</span> <span class=\"attr\">username</span>=<span class=\"string\">&#x27;KVMpool&#x27;</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;ceph&#x27;</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">secret</span> <span class=\"attr\">uuid</span>=<span class=\"string\">&#x27;95b1ed29-16aa-4e95-9917-c2cd4f3b2791&#x27;</span>/&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">auth</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">source</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">pool</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">virsh pool-define --file ceph.xml</span><br><span class=\"line\">virsh pool-start KVMpool</span><br><span class=\"line\">virsh pool-autostart KVMpool</span><br><span class=\"line\">virsh pool-list --details</span><br></pre></td></tr></table></figure></li>\n</ol>\n<h3 id=\"虚拟磁盘镜像和KVM存储基本操作\"><a href=\"#虚拟磁盘镜像和KVM存储基本操作\" class=\"headerlink\" title=\"虚拟磁盘镜像和KVM存储基本操作\"></a>虚拟磁盘镜像和KVM存储基本操作</h3><p>文章介绍了使用dd命令生成磁盘镜像文件，如下：</p>\n<p>生成10G的预分配磁盘文件：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">dd</span> <span class=\"keyword\">if</span>=/dev/zero of=/vms/dbvm_disk2.img bs=1G count=10</span><br></pre></td></tr></table></figure>\n\n<p>生成10G的磁盘文件，使用seek关键字，不做预分配</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">dd</span> <span class=\"keyword\">if</span>=/dev/zero of=/vms/dbvm_disk2_seek.imgbs=1G seek=10 count=0</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"qemu-img-命令\"><a href=\"#qemu-img-命令\" class=\"headerlink\" title=\"qemu-img 命令\"></a>qemu-img 命令</h4><p>使用qemu-img info查看磁盘文件的信息，如下：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># qemu-img info /vms/dbvm_disk2.img</span></span><br><span class=\"line\">image: /vms/dbvm_disk2.img</span><br><span class=\"line\">file format: raw</span><br><span class=\"line\">virtual size: 10G (10737418240 bytes)</span><br><span class=\"line\">disk size: 10G</span><br><span class=\"line\"><span class=\"comment\"># qemu-img info /vms/dbvm_disk2_seek.img</span></span><br><span class=\"line\">image: /vms/dbvm_disk2_seek.img</span><br><span class=\"line\">file format: raw</span><br><span class=\"line\">virtual size: 10G (10737418240 bytes)</span><br><span class=\"line\">disk size: 10M</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"使用virsh命令加载硬盘\"><a href=\"#使用virsh命令加载硬盘\" class=\"headerlink\" title=\"使用virsh命令加载硬盘\"></a>使用virsh命令加载硬盘</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">virsh attach-disk CentOS8 /vms/dbvm_disk2.img vdb --live --config</span><br></pre></td></tr></table></figure>\n\n<p>说明如下：</p>\n<ul>\n<li><strong>CentOS8</strong> is the virtual machine to which a disk attachment is executed. </li>\n<li>Then, there is the path of the disk image,  <strong>&#x2F;vms&#x2F;dbvm_disk2.img</strong></li>\n<li><strong>vdb</strong> is the target disk name that would be visible inside the guest operating system. </li>\n<li><strong>–live</strong> means performing the action while the virtual machine is running.</li>\n<li><strong>–config</strong> means attaching it persistently across reboot. Not adding a –config switch will keep the disk attached only until reboot.</li>\n</ul>\n<p>查看虚拟机的硬盘信息：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">virsh domblklist CentOS8 --details</span><br><span class=\"line\"></span><br><span class=\"line\">Type Device Target Source</span><br><span class=\"line\">------------------------------------------------</span><br><span class=\"line\">file disk vda /var/lib/libvirt/images/fedora21.qcow2</span><br><span class=\"line\">file disk vdb /vms/dbvm_disk2_seek.img</span><br></pre></td></tr></table></figure>\n\n<p>还有其他章节，比如创建ISO库、删除存储池、创建卷和删除卷。</p>\n<h4 id=\"有关NVMe和NVMe-over-Fabric\"><a href=\"#有关NVMe和NVMe-over-Fabric\" class=\"headerlink\" title=\"有关NVMe和NVMe over Fabric\"></a>有关NVMe和NVMe over Fabric</h4><p>SSD存储的存取方式发生改变，主要体现在性能和延时这两方面。传统<strong>AHCI</strong> (Advanced Host Controller Interface) 已不能满足SSD的性能要求。</p>\n<p><strong>NVMe</strong> (Non-Volatile Memory Express) 是一个全新的协议，基于PCIe技术，目的在于满足SSD的高性能、低时延的访问要求。越来越多的存储设备已经集成了SSD和NVMe，主要用于缓存，同时也有用于数据存储的。</p>\n<p>Fiber Channel，虽然10多年被人争执说要从市场消失，主要原因无外乎：FC需要专用的交换机、专门的网卡和线缆，FC设备贵，需要专门的知识，而且FC的速率没有以太网发展快。</p>\n<p>但是，目前市场上发生的情况有所不同，FC可以满足NVMe SSD带来的性能提升的需求。</p>\n<p>Two of these concepts derived from <strong>Intel Optane</strong>—<strong>Storage Class Memory (SCM) and Persistent Memory (PM)</strong> are the latest technologies that storage companies and customers want adopted into their storage systems, and fast.</p>\n<p>将工作负载移到内存当中是符合逻辑的，设想一下内存型数据库(Microsoft SQL, SAP HANA, Oracle).</p>\n<p>如果一个存储厂商生产了使用SCM SSD的存储设备，那么只有内存可用于缓存(Cache).</p>\n","length":4267,"excerpt":"","more":"<p>第一章和第二章之前快速阅读过了，没有笔记，等回头再回来整理。</p>\n<h2 id=\"Chapter-3-KVM、virsh、oVirt等\"><a href=\"#Chapter-3-KVM、virsh、oVirt等\" class=\"headerlink\" title=\"Chapter 3 KVM、virsh、oVirt等\"></a>Chapter 3 KVM、virsh、oVirt等</h2><h3 id=\"CentOS-8-的KVM安装\"><a href=\"#CentOS-8-的KVM安装\" class=\"headerlink\" title=\"CentOS 8 的KVM安装\"></a>CentOS 8 的KVM安装</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum module install virt</span><br><span class=\"line\">dnf install qemu-img qemu-kvm libvirt libvirt-client virt-manager \\</span><br><span class=\"line\">virt-install virt-viewer -y</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"安装完后，使用virt-host-validate验证\"><a href=\"#安装完后，使用virt-host-validate验证\" class=\"headerlink\" title=\"安装完后，使用virt-host-validate验证\"></a>安装完后，使用virt-host-validate验证</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@centos7 ~]# virt-host-validate</span><br><span class=\"line\">  QEMU: Checking <span class=\"keyword\">for</span> hardware virtualization                                 : PASS</span><br><span class=\"line\">  QEMU: Checking <span class=\"keyword\">if</span> device /dev/kvm exists                                   : PASS</span><br><span class=\"line\">  QEMU: Checking <span class=\"keyword\">if</span> device /dev/kvm is accessible                            : PASS</span><br><span class=\"line\">  QEMU: Checking <span class=\"keyword\">if</span> device /dev/vhost-net exists                             : PASS</span><br><span class=\"line\">  QEMU: Checking <span class=\"keyword\">if</span> device /dev/net/tun exists                               : PASS</span><br><span class=\"line\">  QEMU: Checking <span class=\"keyword\">for</span> cgroup <span class=\"string\">&#x27;memory&#x27;</span> controller support                      : PASS</span><br><span class=\"line\">  QEMU: Checking <span class=\"keyword\">for</span> cgroup <span class=\"string\">&#x27;memory&#x27;</span> controller mount-point                  : PASS</span><br><span class=\"line\">  QEMU: Checking <span class=\"keyword\">for</span> cgroup <span class=\"string\">&#x27;cpu&#x27;</span> controller support                         : PASS</span><br><span class=\"line\">  QEMU: Checking <span class=\"keyword\">for</span> cgroup <span class=\"string\">&#x27;cpu&#x27;</span> controller mount-point                     : PASS</span><br><span class=\"line\">  QEMU: Checking <span class=\"keyword\">for</span> cgroup <span class=\"string\">&#x27;cpuacct&#x27;</span> controller support                     : PASS</span><br><span class=\"line\">  QEMU: Checking <span class=\"keyword\">for</span> cgroup <span class=\"string\">&#x27;cpuacct&#x27;</span> controller mount-point                 : PASS</span><br><span class=\"line\">  QEMU: Checking <span class=\"keyword\">for</span> cgroup <span class=\"string\">&#x27;cpuset&#x27;</span> controller support                      : PASS</span><br><span class=\"line\">  QEMU: Checking <span class=\"keyword\">for</span> cgroup <span class=\"string\">&#x27;cpuset&#x27;</span> controller mount-point                  : PASS</span><br><span class=\"line\">  QEMU: Checking <span class=\"keyword\">for</span> cgroup <span class=\"string\">&#x27;devices&#x27;</span> controller support                     : PASS</span><br><span class=\"line\">  QEMU: Checking <span class=\"keyword\">for</span> cgroup <span class=\"string\">&#x27;devices&#x27;</span> controller mount-point                 : PASS</span><br><span class=\"line\">  QEMU: Checking <span class=\"keyword\">for</span> cgroup <span class=\"string\">&#x27;blkio&#x27;</span> controller support                       : PASS</span><br><span class=\"line\">  QEMU: Checking <span class=\"keyword\">for</span> cgroup <span class=\"string\">&#x27;blkio&#x27;</span> controller mount-point                   : PASS</span><br><span class=\"line\">  QEMU: Checking <span class=\"keyword\">for</span> device assignment IOMMU support                         : PASS</span><br><span class=\"line\">  QEMU: Checking <span class=\"keyword\">if</span> IOMMU is enabled by kernel                               : PASS</span><br><span class=\"line\">   LXC: Checking <span class=\"keyword\">for</span> Linux &gt;= 2.6.26                                         : PASS</span><br><span class=\"line\">   LXC: Checking <span class=\"keyword\">for</span> namespace ipc                                           : PASS</span><br><span class=\"line\">   LXC: Checking <span class=\"keyword\">for</span> namespace mnt                                           : PASS</span><br><span class=\"line\">   LXC: Checking <span class=\"keyword\">for</span> namespace pid                                           : PASS</span><br><span class=\"line\">   LXC: Checking <span class=\"keyword\">for</span> namespace uts                                           : PASS</span><br><span class=\"line\">   LXC: Checking <span class=\"keyword\">for</span> namespace net                                           : PASS</span><br><span class=\"line\">   LXC: Checking <span class=\"keyword\">for</span> namespace user                                          : PASS</span><br><span class=\"line\">   LXC: Checking <span class=\"keyword\">for</span> cgroup <span class=\"string\">&#x27;memory&#x27;</span> controller support                      : PASS</span><br><span class=\"line\">   LXC: Checking <span class=\"keyword\">for</span> cgroup <span class=\"string\">&#x27;memory&#x27;</span> controller mount-point                  : PASS</span><br><span class=\"line\">   LXC: Checking <span class=\"keyword\">for</span> cgroup <span class=\"string\">&#x27;cpu&#x27;</span> controller support                         : PASS</span><br><span class=\"line\">   LXC: Checking <span class=\"keyword\">for</span> cgroup <span class=\"string\">&#x27;cpu&#x27;</span> controller mount-point                     : PASS</span><br><span class=\"line\">   LXC: Checking <span class=\"keyword\">for</span> cgroup <span class=\"string\">&#x27;cpuacct&#x27;</span> controller support                     : PASS</span><br><span class=\"line\">   LXC: Checking <span class=\"keyword\">for</span> cgroup <span class=\"string\">&#x27;cpuacct&#x27;</span> controller mount-point                 : PASS</span><br><span class=\"line\">   LXC: Checking <span class=\"keyword\">for</span> cgroup <span class=\"string\">&#x27;cpuset&#x27;</span> controller support                      : PASS</span><br><span class=\"line\">   LXC: Checking <span class=\"keyword\">for</span> cgroup <span class=\"string\">&#x27;cpuset&#x27;</span> controller mount-point                  : PASS</span><br><span class=\"line\">   LXC: Checking <span class=\"keyword\">for</span> cgroup <span class=\"string\">&#x27;devices&#x27;</span> controller support                     : PASS</span><br><span class=\"line\">   LXC: Checking <span class=\"keyword\">for</span> cgroup <span class=\"string\">&#x27;devices&#x27;</span> controller mount-point                 : PASS</span><br><span class=\"line\">   LXC: Checking <span class=\"keyword\">for</span> cgroup <span class=\"string\">&#x27;blkio&#x27;</span> controller support                       : PASS</span><br><span class=\"line\">   LXC: Checking <span class=\"keyword\">for</span> cgroup <span class=\"string\">&#x27;blkio&#x27;</span> controller mount-point                   : PASS</span><br><span class=\"line\">   LXC: Checking <span class=\"keyword\">if</span> device /sys/fs/fuse/connections exists                   : PASS</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"使用virt-install-安装虚拟机\"><a href=\"#使用virt-install-安装虚拟机\" class=\"headerlink\" title=\"使用virt-install 安装虚拟机\"></a>使用virt-install 安装虚拟机</h3><p>编辑anaconda-ks.cfg文件，使用以下参数可以实现虚机部署的静默安装。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">virt-install --virt-type=kvm --name=MasteringKVM02 --ram=4096</span><br><span class=\"line\">--vcpus=4 --os-variant=rhel8.0 --location=/var/lib/libvirt/</span><br><span class=\"line\">images/ CentOS-8-x86_64-1905-dvd1.iso --network=default</span><br><span class=\"line\">--graphics vnc --disk size=16 -x <span class=\"string\">&quot;ks=http://10.10.48.1/ks.cfg&quot;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"oVirt\"><a href=\"#oVirt\" class=\"headerlink\" title=\"oVirt\"></a>oVirt</h3><p>oVirt（Open Virtualization Manager）是一款免费开源虚拟化软件，是RedHat商业版本虚拟化软件RHEV的开源版本。</p>\n<p>oVirt基于kvm，并整合使用了libvirt、gluster、patternfly、ansible等一系列优秀的开源软件。</p>\n<h3 id=\"探索虚拟机Qemu-kvm进程\"><a href=\"#探索虚拟机Qemu-kvm进程\" class=\"headerlink\" title=\"探索虚拟机Qemu-kvm进程\"></a>探索虚拟机Qemu-kvm进程</h3><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@ubuntu-kvm:/home/ubuntu# ps aux | grep qemu</span><br><span class=\"line\">libvirt+    8526  255  0.1 13876708 653744 ?     SLl  Feb01 61850:36 /usr/bin/qemu-system-x86_64 -name guest=csr1kv-1,debug-threads=on -S -object secret,<span class=\"built_in\">id</span>=masterKey0,format=raw,file=/var/lib/libvirt/qemu/domain-4-csr1kv-1/master-key.aes -machine pc-q35-4.2,accel=kvm,usb=off,vmport=off,dump-guest-core=off,mem-merge=off -cpu host -m 8192 -mem-prealloc -mem-path /dev/hugepages/libvirt/qemu/4-csr1kv-1 -overcommit mem-lock=on -smp 8,sockets=8,cores=1,threads=1 -uuid 83f90c1c-f0ea-4298-bcdf-3d676de2aeb4 -no-user-config -nodefaults -chardev socket,<span class=\"built_in\">id</span>=charmonitor,fd=31,server,nowait -mon chardev=charmonitor,<span class=\"built_in\">id</span>=monitor,mode=control -rtc base=utc,driftfix=slew -global kvm-pit.lost_tick_policy=delay -no-hpet -no-shutdown -global ICH9-LPC.disable_s3=1 -global ICH9-LPC.disable_s4=1 -boot strict=on -device pcie-root-port,port=0x10,chassis=1,<span class=\"built_in\">id</span>=pci.1,bus=pcie.0,multifunction=on,addr=0x2 -device pcie-root-port,port=0x11,chassis=2,<span class=\"built_in\">id</span>=pci.2,bus=pcie.0,addr=0x2.0x1 -device pcie-root-port,port=0x12,chassis=3,<span class=\"built_in\">id</span>=pci.3,bus=pcie.0,addr=0x2.0x2 -device pcie-root-port,port=0x13,chassis=4,<span class=\"built_in\">id</span>=pci.4,bus=pcie.0,addr=0x2.0x3 -device pcie-root-port,port=0x14,chassis=5,<span class=\"built_in\">id</span>=pci.5,bus=pcie.0,addr=0x2.0x4 -device pcie-root-port,port=0x15,chassis=6,<span class=\"built_in\">id</span>=pci.6,bus=pcie.0,addr=0x2.0x5 -device pcie-root-port,port=0x16,chassis=7,<span class=\"built_in\">id</span>=pci.7,bus=pcie.0,addr=0x2.0x6 -device pcie-root-port,port=0x17,chassis=8,<span class=\"built_in\">id</span>=pci.8,bus=pcie.0,addr=0x2.0x7 -device qemu-xhci,p2=15,p3=15,<span class=\"built_in\">id</span>=usb,bus=pci.3,addr=0x0 -device virtio-serial-pci,<span class=\"built_in\">id</span>=virtio-serial0,bus=pci.4,addr=0x0 -blockdev &#123;<span class=\"string\">&quot;driver&quot;</span>:<span class=\"string\">&quot;file&quot;</span>,<span class=\"string\">&quot;filename&quot;</span>:<span class=\"string\">&quot;/var/lib/libvirt/images/csr1000v-universalk9.17.02.01v.qcow2&quot;</span>,<span class=\"string\">&quot;node-name&quot;</span>:<span class=\"string\">&quot;libvirt-1-storage&quot;</span>,<span class=\"string\">&quot;auto-read-only&quot;</span>:<span class=\"literal\">true</span>,<span class=\"string\">&quot;discard&quot;</span>:<span class=\"string\">&quot;unmap&quot;</span>&#125; -blockdev &#123;<span class=\"string\">&quot;node-name&quot;</span>:<span class=\"string\">&quot;libvirt-1-format&quot;</span>,<span class=\"string\">&quot;read-only&quot;</span>:<span class=\"literal\">false</span>,<span class=\"string\">&quot;driver&quot;</span>:<span class=\"string\">&quot;qcow2&quot;</span>,<span class=\"string\">&quot;file&quot;</span>:<span class=\"string\">&quot;libvirt-1-storage&quot;</span>,<span class=\"string\">&quot;backing&quot;</span>:null&#125; -device virtio-blk-pci,scsi=off,bus=pci.5,addr=0x0,drive=libvirt-1-format,<span class=\"built_in\">id</span>=virtio-disk0,bootindex=1 -netdev tap,fd=33,<span class=\"built_in\">id</span>=hostnet0,vhost=on,vhostfd=34 -device virtio-net-pci,netdev=hostnet0,<span class=\"built_in\">id</span>=net0,mac=52:54:00:69:ec:73,bus=pci.1,addr=0x0 -chardev pty,<span class=\"built_in\">id</span>=charserial0 -device isa-serial,chardev=charserial0,<span class=\"built_in\">id</span>=serial0 -chardev socket,<span class=\"built_in\">id</span>=charchannel0,fd=35,server,nowait -device virtserialport,bus=virtio-serial0.0,nr=1,chardev=charchannel0,<span class=\"built_in\">id</span>=channel0,name=org.qemu.guest_agent.0 -chardev spicevmc,<span class=\"built_in\">id</span>=charchannel1,name=vdagent -device virtserialport,bus=virtio-serial0.0,nr=2,chardev=charchannel1,<span class=\"built_in\">id</span>=channel1,name=com.redhat.spice.0 -spice port=5900,addr=127.0.0.1,disable-ticketing,image-compression=off,seamless-migration=on -device qxl-vga,<span class=\"built_in\">id</span>=video0,ram_size=67108864,vram_size=67108864,vram64_size_mb=0,vgamem_mb=16,max_outputs=1,bus=pcie.0,addr=0x1 -device vfio-pci,host=0000:5e:02.0,<span class=\"built_in\">id</span>=hostdev0,bus=pci.2,addr=0x0 -device vfio-pci,host=0000:5e:0a.0,<span class=\"built_in\">id</span>=hostdev1,bus=pci.8,addr=0x0 -sandbox on,obsolete=deny,elevateprivileges=deny,spawn=deny,resourcecontrol=deny -msg timestamp=on</span><br></pre></td></tr></table></figure>\n\n<p>使用pstree检查线程信息：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@ubuntu-kvm:/home/ubuntu# pstree -p 8526</span><br><span class=\"line\">qemu-system-x86(8526)─┬─&#123;qemu-system-x86&#125;(8530)</span><br><span class=\"line\">                      ├─&#123;qemu-system-x86&#125;(8534)</span><br><span class=\"line\">                      ├─&#123;qemu-system-x86&#125;(8535)</span><br><span class=\"line\">                      ├─&#123;qemu-system-x86&#125;(8536)</span><br><span class=\"line\">                      ├─&#123;qemu-system-x86&#125;(8537)</span><br><span class=\"line\">                      ├─&#123;qemu-system-x86&#125;(8538)</span><br><span class=\"line\">                      ├─&#123;qemu-system-x86&#125;(8539)</span><br><span class=\"line\">                      ├─&#123;qemu-system-x86&#125;(8540)</span><br><span class=\"line\">                      ├─&#123;qemu-system-x86&#125;(8541)</span><br><span class=\"line\">                      ├─&#123;qemu-system-x86&#125;(8542)</span><br><span class=\"line\">                      ├─&#123;qemu-system-x86&#125;(8552)</span><br></pre></td></tr></table></figure>\n\n<p>使用gbd 调试进程，这里参考<a href=\"https://www.cnblogs.com/hukey/p/11138768.html\">https://www.cnblogs.com/hukey/p/11138768.html</a></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@ubuntu-kvm:/home/ubuntu# gdb attach 8526</span><br><span class=\"line\">GNU gdb (Ubuntu 9.2-0ubuntu1~20.04) 9.2</span><br><span class=\"line\">Copyright (C) 2020 Free Software Foundation, Inc.</span><br><span class=\"line\">License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;</span><br><span class=\"line\">This is free software: you are free to change and redistribute it.</span><br><span class=\"line\">There is NO WARRANTY, to the extent permitted by law.</span><br><span class=\"line\">Type <span class=\"string\">&quot;show copying&quot;</span> and <span class=\"string\">&quot;show warranty&quot;</span> <span class=\"keyword\">for</span> details.</span><br><span class=\"line\">This GDB was configured as <span class=\"string\">&quot;x86_64-linux-gnu&quot;</span>.</span><br><span class=\"line\">Type <span class=\"string\">&quot;show configuration&quot;</span> <span class=\"keyword\">for</span> configuration details.</span><br><span class=\"line\">For bug reporting instructions, please see:</span><br><span class=\"line\">&lt;http://www.gnu.org/software/gdb/bugs/&gt;.</span><br><span class=\"line\">Find the GDB manual and other documentation resources online at:</span><br><span class=\"line\">    &lt;http://www.gnu.org/software/gdb/documentation/&gt;.</span><br><span class=\"line\"></span><br><span class=\"line\">For <span class=\"built_in\">help</span>, <span class=\"built_in\">type</span> <span class=\"string\">&quot;help&quot;</span>.</span><br><span class=\"line\">Type <span class=\"string\">&quot;apropos word&quot;</span> to search <span class=\"keyword\">for</span> commands related to <span class=\"string\">&quot;word&quot;</span>.</span><br><span class=\"line\">Attaching to process 8526</span><br><span class=\"line\">[New LWP 8530]</span><br><span class=\"line\">[New LWP 8534]</span><br><span class=\"line\">[New LWP 8535]</span><br><span class=\"line\">[New LWP 8536]</span><br><span class=\"line\">[New LWP 8537]</span><br><span class=\"line\">[New LWP 8538]</span><br><span class=\"line\">[New LWP 8539]</span><br><span class=\"line\">[New LWP 8540]</span><br><span class=\"line\">[New LWP 8541]</span><br><span class=\"line\">[New LWP 8542]</span><br><span class=\"line\">[New LWP 8552]</span><br><span class=\"line\">[New LWP 250213]</span><br><span class=\"line\"></span><br><span class=\"line\">warning: <span class=\"string\">&quot;target:/usr/bin/qemu-system-x86_64 (deleted)&quot;</span>: could not open as an executable file: No such file or directory.</span><br><span class=\"line\"></span><br><span class=\"line\">warning: `target:/usr/bin/qemu-system-x86_64 (deleted)<span class=\"string\">&#x27;: can&#x27;</span>t open to <span class=\"built_in\">read</span> symbols: No such file or directory.</span><br><span class=\"line\"></span><br><span class=\"line\">warning: Could not load vsyscall page because no executable was specified</span><br><span class=\"line\">0x00007fdcda986bf6 <span class=\"keyword\">in</span> ?? ()</span><br><span class=\"line\">(gdb) info threads</span><br><span class=\"line\">  Id   Target Id                  Frame</span><br><span class=\"line\">* 1    LWP 8526 <span class=\"string\">&quot;qemu-system-x86&quot;</span> 0x00007fdcda986bf6 <span class=\"keyword\">in</span> ?? ()</span><br><span class=\"line\">  2    LWP 8530 <span class=\"string\">&quot;call_rcu&quot;</span>        0x00007fdcda98c89d <span class=\"keyword\">in</span> ?? ()</span><br><span class=\"line\">  3    LWP 8534 <span class=\"string\">&quot;IO mon_iothread&quot;</span> 0x00007fdcda986aff <span class=\"keyword\">in</span> ?? ()</span><br><span class=\"line\">  4    LWP 8535 <span class=\"string\">&quot;CPU 0/KVM&quot;</span>       0x00007fdcda98850b <span class=\"keyword\">in</span> ?? ()</span><br><span class=\"line\">  5    LWP 8536 <span class=\"string\">&quot;CPU 1/KVM&quot;</span>       0x00007fdcda98850b <span class=\"keyword\">in</span> ?? ()</span><br><span class=\"line\">  6    LWP 8537 <span class=\"string\">&quot;CPU 2/KVM&quot;</span>       0x00007fdcda98850b <span class=\"keyword\">in</span> ?? ()</span><br><span class=\"line\">  7    LWP 8538 <span class=\"string\">&quot;CPU 3/KVM&quot;</span>       0x00007fdcda98850b <span class=\"keyword\">in</span> ?? ()</span><br><span class=\"line\">  8    LWP 8539 <span class=\"string\">&quot;CPU 4/KVM&quot;</span>       0x00007fdcda98850b <span class=\"keyword\">in</span> ?? ()</span><br><span class=\"line\">  9    LWP 8540 <span class=\"string\">&quot;CPU 5/KVM&quot;</span>       0x00007fdcda98850b <span class=\"keyword\">in</span> ?? ()</span><br><span class=\"line\">  10   LWP 8541 <span class=\"string\">&quot;CPU 6/KVM&quot;</span>       0x00007fdcda98850b <span class=\"keyword\">in</span> ?? ()</span><br><span class=\"line\">  11   LWP 8542 <span class=\"string\">&quot;CPU 7/KVM&quot;</span>       0x00007fdcda98850b <span class=\"keyword\">in</span> ?? ()</span><br><span class=\"line\">  12   LWP 8552 <span class=\"string\">&quot;SPICE Worker&quot;</span>    0x00007fdcda986aff <span class=\"keyword\">in</span> ?? ()</span><br><span class=\"line\">  13   LWP 250213 <span class=\"string\">&quot;worker&quot;</span>        0x00007fdcdaa76618 <span class=\"keyword\">in</span> ?? ()</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"Chapter-4-KVM-网络\"><a href=\"#Chapter-4-KVM-网络\" class=\"headerlink\" title=\"Chapter 4 KVM 网络\"></a>Chapter 4 KVM 网络</h2><p>本章节介绍了以下内容</p>\n<ul>\n<li>Virtual Network – 阐述为什么需要虚拟网络。从虚拟交换机开始，设想一下如果没有虚拟交换机，有20个虚拟机需要20个物理接口连接至20个物理交换机的端口。引入虚拟交换机，减少服务器的物理接口和物理交换机的接口需求。</li>\n<li>Libvirt 的三类网络：NAT、Routed(Bridged)、Isolated；使用virsh net-dumpxml default输出xml文件。</li>\n<li>TUN&#x2F;TAP设备：属于用户空间的设备，an application can open &#x2F;dev&#x2F;net&#x2F;tun and use an ioctl() function to register a network device in the kernel, which, in turn, presents itself as a tunXX or tapXX device.  TUN设备是一个3层设备，TAP设备是一个2层设备。</li>\n<li>简单介绍了Linux Bridge，此处可以使用ip link 命令替代brctl命令，并使用NetworkManager来持久化配置。</li>\n<li>Open vSwitch简单介绍</li>\n<li>SR-IOV的介绍：此处可以参考我自己的文档。</li>\n<li>MACVTAP介绍：It’s a newer driver that should simplify our virtualized networking by completely removing tun&#x2F;tap and bridge drivers with a single module.  有四种模式，VEPA，Bridge，Private和Pass-through。</li>\n</ul>\n<h2 id=\"Chapter-5-KVM-存储\"><a href=\"#Chapter-5-KVM-存储\" class=\"headerlink\" title=\"Chapter 5 KVM 存储\"></a>Chapter 5 KVM 存储</h2><p>本章属于囫囵吞枣的看完了，一知半解的记录一下，大致了解了一些存储方面的概念和存储的最新发展。</p>\n<h3 id=\"存储资源池\"><a href=\"#存储资源池\" class=\"headerlink\" title=\"存储资源池\"></a>存储资源池</h3><p>CentOS支持的存储池种类如下：</p>\n<ul>\n<li>Logical Volume Manager (LVM)-based storage pools</li>\n<li>Directory-based storage pools</li>\n<li>Partition-based storage pools</li>\n<li>GlusterFS-based storage pools</li>\n<li>iSCSI-based storage pools</li>\n<li>Disk-based storage pools</li>\n<li>HBA-based storage pools, which use SCSI devices</li>\n</ul>\n<p>对于libvirt来说，存储资源池可能是一个目录，一个存储设备，或者是一个文件。</p>\n<p>介绍了两种文件系统：</p>\n<ul>\n<li><strong>Brtfs</strong> is a type of filesystem that supports snapshots, RAID and LVM-like functionality, compression, defragmentation, online resizing, and many other advanced features. It was deprecated after it was discovered that its RAID5&#x2F;6 can easily lead to a loss of data. –这里说的是Red Hat</li>\n<li><strong>ZFS</strong> is a type of filesystem that supports everything that Brtfs does, plus read and write caching. <strong>ZFS is not a part of the Linux kernel.</strong></li>\n</ul>\n<h3 id=\"本地存储池\"><a href=\"#本地存储池\" class=\"headerlink\" title=\"本地存储池\"></a>本地存储池</h3><p>Stratis是随RHEL 8引入的本地管理存储解决方案，它使系统管理员可以配置高级存储功能：</p>\n<ol>\n<li>Pool-based management</li>\n<li>Thin provisioning</li>\n<li>File system snapshots</li>\n<li>Monitoring</li>\n</ol>\n<p>Stratis使用示例：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mdadm --create /dev/md0 --verbose --level=10 --raid-devices=4 /dev/sdb /dev/sdc /dev/sdd /dev/sde --spare-devices=1 /dev/sdf2</span><br><span class=\"line\">stratis pool create PacktStratisPool01 /dev/md0</span><br><span class=\"line\">stratis pool add-cache PacktStratisPool01 /dev/sdg</span><br><span class=\"line\">stratis fs create PackStratisPool01 PacktStratisXFS01</span><br><span class=\"line\"><span class=\"built_in\">mkdir</span> /mnt/packtStratisXFS01</span><br><span class=\"line\">mount /stratis/PacktStratisPool01/PacktStratisXFS01 /mnt/packtStratisXFS01</span><br></pre></td></tr></table></figure>\n\n<h3 id=\"Libvirt-Storage-Pool\"><a href=\"#Libvirt-Storage-Pool\" class=\"headerlink\" title=\"Libvirt Storage Pool\"></a>Libvirt Storage Pool</h3><p>Libvirt 支持多种Storage Pool，详见<a href=\"https://libvirt.org/storage.html\">https://libvirt.org/storage.html</a></p>\n<ul>\n<li>Directory pool</li>\n<li>Filesystem pool</li>\n<li>Network filesystem pool</li>\n<li>Logical volume pool</li>\n<li>Disk pool</li>\n<li>iSCSI pool</li>\n<li>iSCSI direct pool</li>\n<li>SCSI pool</li>\n<li>Multipath pool</li>\n<li>RBD pool</li>\n<li>Sheepdog pool</li>\n<li>Gluster pool</li>\n<li>ZFS pool</li>\n<li>Vstorage pool</li>\n</ul>\n<h3 id=\"NFS-Storage-Pool\"><a href=\"#NFS-Storage-Pool\" class=\"headerlink\" title=\"NFS Storage Pool\"></a>NFS Storage Pool</h3><p>NFS自上世纪80年代就出现了，至今依然活跃，尤其是4.2版本以后增强了不少功能；VMware Virtual Volume 6.0 可以提供基于Block和NFS的两种存储访问。</p>\n<p>Libvirt 使用NFS Storage Pool示例，也可以使用virt-manager 图形界面创建：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">pool</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;netfs&#x27;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">name</span>&gt;</span>NFSpooll<span class=\"tag\">&lt;/<span class=\"name\">name</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">source</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">host</span> <span class=\"attr\">name</span>=<span class=\"string\">&#x27;192.168.159.144&#x27;</span> /&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">dir</span> <span class=\"attr\">path</span>=<span class=\"string\">&#x27;/mnt/packtStratisXF501&#x27;</span> /&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">format</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;auto&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">source</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">target</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">path</span>&gt;</span>/var/lib/libvirt/images/NFSpooll<span class=\"tag\">&lt;/<span class=\"name\">path</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">permissions</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">mode</span>&gt;</span>0755<span class=\"tag\">&lt;/<span class=\"name\">mode</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">owner</span>&gt;</span>0<span class=\"tag\">&lt;/<span class=\"name\">owner</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">group</span>&gt;</span>0<span class=\"tag\">&lt;/<span class=\"name\">group</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">label</span>&gt;</span>system_u:object r:nfs t:s0<span class=\"tag\">&lt;/<span class=\"name\">label</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">permissions</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">target</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">pool</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h3 id=\"iSCIS-和-SAN-存储\"><a href=\"#iSCIS-和-SAN-存储\" class=\"headerlink\" title=\"iSCIS 和 SAN 存储\"></a>iSCIS 和 SAN 存储</h3><p>iSCIS协议有两个主要原因影响其高效性：</p>\n<ul>\n<li><strong>IP协议封装</strong> iSCSI encapsulates SCSI commands into regular IP packages, which means segmentation and overhead as IP packages have a pretty large header, which means less efficiency.</li>\n<li><strong>基于TCP传输</strong> Even worse, it’s TCP-based, which means that there are sequence numbers and retransmissions, which can lead to queueing and latency, and the bigger the environment is, the more you usually feel these effects affect your virtual machine performance.</li>\n</ul>\n<p>The iSCSI and FC architectures are very similar—they both need a target (an iSCSI target and an FC target) and an initiator (an iSCS initiator and an FC initiator)，the initiator connects to a target to get access to block storage that’s presented via that target.</p>\n<h4 id=\"LUN的概念\"><a href=\"#LUN的概念\" class=\"headerlink\" title=\"LUN的概念\"></a>LUN的概念</h4><p>LUNs are just raw, block capacities that we export via an iSCSI target toward initiators. LUNs are indexed, or numbered, usually from 0 onward. Every LUN number represents a different storage capacity that an initiator can connect to.</p>\n<p>For example, we can have an iSCSI target with three different LUNs—LUN0 with 20 GB, LUN1 with 40 GB, and LUN2 with 60 GB. These will all be hosted on the same storage system’s iSCSI target. We can then configure the iSCSI target to accept an IQN to see all the LUNs, another IQN to only see LUN1, and another IQN to only see LUN1 and LUN2. </p>\n<p>使用 targetcli命令创建iSCIS target，步骤简要说明如下：</p>\n<ol>\n<li>创建&#x2F;dev&#x2F;sdb1分区和XFS文件系统，并mount &#x2F;dev&#x2F;sdb1 &#x2F;LUN0，用targetcli创建一个fileio 类型的target后端</li>\n<li>创建&#x2F;dev&#x2F;sdc1分区，并直接使用targetcli创建一个block类型的target后端</li>\n<li>基于&#x2F;dev&#x2F;sdd创建LVM，并使用targetcli创建一个block类型的target后端</li>\n<li>在KVM主机上设置好iscsi的initiator参数</li>\n<li>回到iSCSI上，创建ACL，允许KVM host，基于1~3创建的target发布LUNs</li>\n<li>在KVM Host上定义Storage Pool的XML文件，用virsh pool-define创建Storage Pool</li>\n</ol>\n<h3 id=\"Storage-redundancy-and-multipathing\"><a href=\"#Storage-redundancy-and-multipathing\" class=\"headerlink\" title=\"Storage redundancy and multipathing\"></a>Storage redundancy and multipathing</h3><p>避免单点故障SPOF，网卡、线缆、交换机、存储控制器等等。</p>\n<p>KVM Host基于iSCSI做冗余和多路径的配置较为复杂，并且缺少支持，文章建议使用oVirt或者RHEV-H(Red Hat Enterprise Virtualization Hypervisor. )</p>\n<p>使用oVirt 创建一个iSCSI Bond来实现冗余和多路径。</p>\n<h3 id=\"Gluster\"><a href=\"#Gluster\" class=\"headerlink\" title=\"Gluster\"></a>Gluster</h3><p>Gluster 是一个分布式文件系统，其突出优势是可扩展性，数据复制和快照功能；注意Gluster是一个文件存储服务。</p>\n<p>生产环境中，Gluster至少配置三台服务器。</p>\n<p>配置步骤简要说明如下：</p>\n<ol>\n<li><p>创建磁盘分区以及文件系统 </p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mkfs.xfs /dev/sdb</span><br><span class=\"line\"><span class=\"built_in\">mkdir</span> /gluster/bricks/1 -p</span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&#x27;/dev/sdb /gluster/bricks/1 xfs defaults 0 0&#x27;</span> &gt;&gt; /etc/</span><br><span class=\"line\">fstab</span><br><span class=\"line\">mount -a</span><br><span class=\"line\"><span class=\"built_in\">mkdir</span> /gluster/bricks/1/brick</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>创建Gluster分布式文件系统</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gluster volume create kvmgluster replica 3 \\ gluster1:/gluster/</span><br><span class=\"line\">bricks/1/brick gluster2:/gluster/bricks/1/brick \\ gluster3:/</span><br><span class=\"line\">gluster/bricks/1/brick</span><br><span class=\"line\">gluster volume start kvmgluster</span><br><span class=\"line\">gluster volume <span class=\"built_in\">set</span> kvmgluster auth.allow 192.168.159.0/24</span><br><span class=\"line\">gluster volume <span class=\"built_in\">set</span> kvmgluster allow-insecure on</span><br><span class=\"line\">gluster volume <span class=\"built_in\">set</span> kvmgluster storage.owner-uid 107</span><br><span class=\"line\">gluster volume <span class=\"built_in\">set</span> kvmgluster storage.owner-gid 107</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>挂在Gluster文件系统为NFS服务</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&#x27;localhost:/kvmgluster /mnt glusterfs \\ defaults,_</span></span><br><span class=\"line\"><span class=\"string\">netdev,backupvolfile-server=localhost 0 0&#x27;</span> &gt;&gt; /etc/fstab</span><br><span class=\"line\">mount.glusterfs localhost:/kvmgluster /mnt</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>在KVM主机上挂在Gluster</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget \\ https://download.gluster.org/pub/gluster/glusterfs/6/</span><br><span class=\"line\">LATEST/CentOS/gl\\ usterfs-rhel8.repo -P /etc/yum.repos.d</span><br><span class=\"line\">yum install glusterfs glusterfs-fuse attr -y</span><br><span class=\"line\">mount -t glusterfs -o context=<span class=\"string\">&quot;system_u:object_r:virt_</span></span><br><span class=\"line\"><span class=\"string\">image_t:s0&quot;</span> \\ gluster1:/kvmgluster /var/lib/libvirt/images/</span><br><span class=\"line\">GlusterFS</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>在KVM上定义存储资源池：</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">pool</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;dir&#x27;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">name</span>&gt;</span>glusterfs-pool<span class=\"tag\">&lt;/<span class=\"name\">name</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">target</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">path</span>&gt;</span>/var/lib/libvirt/images/GlusterFS<span class=\"tag\">&lt;/<span class=\"name\">path</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">permissions</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">mode</span>&gt;</span>0755<span class=\"tag\">&lt;/<span class=\"name\">mode</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">owner</span>&gt;</span>107<span class=\"tag\">&lt;/<span class=\"name\">owner</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">group</span>&gt;</span>107<span class=\"tag\">&lt;/<span class=\"name\">group</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">label</span>&gt;</span>system_u:object_r:virt_image_t:s0<span class=\"tag\">&lt;/<span class=\"name\">label</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">permissions</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">target</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">pool</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">virsh pool-define --file gluster.xml</span><br><span class=\"line\">virsh pool-start --pool glusterfs-pool</span><br><span class=\"line\">virsh pool-autostart --pool glusterfs-pool</span><br></pre></td></tr></table></figure></li>\n</ol>\n<p>将Gluster挂在为目录，可以避免Libvirt在使用Gluster的两个问题：</p>\n<ul>\n<li><p>We can use Gluster’s failover capability, which will be managed automatically by the</p>\n<p>Gluster utilities that we installed directly, as libvirt doesn’t support them yet.</p>\n</li>\n<li><p>We will avoid creating virtual machine disks <em>manually</em>, which is another limitation of libvirt’s implementation of Gluster support, while directory-based storage pools support it without any issues.</p>\n</li>\n</ul>\n<h3 id=\"Ceph\"><a href=\"#Ceph\" class=\"headerlink\" title=\"Ceph\"></a>Ceph</h3><p>Ceph offers block and object-based storage. Object-based storage for block-based devices means direct, binary storage, directly to a LUN. There are no filesystems involved, which theoretically means less overhead as there’s no filesystem, filesystem tables, and other constructs that might slow the I&#x2F;O process down.</p>\n<p>Architecture-wise, Ceph has three main services:</p>\n<ul>\n<li>ceph-mon : Used for cluster monitoring, CRUSH maps, and Object Storage Daemon (OSD) maps.</li>\n<li>ceph-osd: This handles actual data storage, replication, and recovery. It requires at least two nodes; we’ll use three for clustering reasons.</li>\n<li>ceph-mds: Metadata server, used when Ceph needs filesystem access.</li>\n</ul>\n<p>Ceph 集群中，所有的数据节点要求采用相同的硬件配置，相同的CPU、内存、硬盘，不适用RAID控制器，仅仅使用HBA。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ceph-deploy install ceph-admin ceph-monitor ceph-osd1 ceph-osd2</span><br><span class=\"line\">ceph-osd3</span><br><span class=\"line\">ceph-deploy mon create-initial</span><br><span class=\"line\">ceph-deploy gatherkeys ceph-monitor</span><br><span class=\"line\">ceph-deploy disk list ceph-osd1 ceph-osd2 ceph-osd3</span><br><span class=\"line\">ceph-deploy disk zap ceph-osd1:/dev/sdb  ceph-osd2:/dev/sdb</span><br><span class=\"line\">ceph-osd3:/dev/sdb</span><br><span class=\"line\">ceph-deploy osd prepare ceph-osd1:/dev/sdb ceph-osd2:/dev/sdb</span><br><span class=\"line\">ceph-osd3:/dev/sdb</span><br><span class=\"line\">ceph-deploy osd activate ceph-osd1:/dev/sdb1 ceph-osd2:/dev/</span><br><span class=\"line\">sdb1 ceph-osd3:/dev/sdb1</span><br></pre></td></tr></table></figure>\n\n<p>对上述命令的说明：</p>\n<ul>\n<li><p>The first command starts the actual deployment process—for the admin, monitor, and OSD nodes, with the installation of all the necessary packages.</p>\n</li>\n<li><p>The second and third commands configure the monitor host so that it’s ready to accept external connections.</p>\n</li>\n<li><p>The two disk commands are all about disk preparation—Ceph will clear the disks that we assigned to it (&#x2F;dev&#x2F;sdb per OSD host) and create two partitions on them, one for Ceph data and one for the Ceph journal.</p>\n</li>\n<li><p>The last two commands prepare these filesystems for use and activate Ceph. If at any time your ceph-deploy script stops, check your DNS and &#x2F;etc&#x2F;hosts and firewalld configuration, as that’s where the problems usually are.</p>\n</li>\n</ul>\n<p>使用以下命令将Ceph存储发布给KVM主机作为存储池：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ceph osd pool create KVMpool 128 128</span><br></pre></td></tr></table></figure>\n\n<p>还需要几个步骤来实现安全的访问，为Ceph的访问增加密码验证。</p>\n<ol>\n<li><p>Ceph生成验证的密码 Key</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ceph auth get-or-create client.KVMpool mon <span class=\"string\">&#x27;allow r&#x27;</span> osd <span class=\"string\">&#x27;allow</span></span><br><span class=\"line\"><span class=\"string\">rwx pool=KVMpool&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#It&#x27;s going to throw us a status message, something like this:</span></span><br><span class=\"line\">key = AQB9p8RdqS09CBAA1DHsiZJbehb7ZBffhfmFJQ==</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n</li>\n<li><p>定义一个Secret</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">secret</span> <span class=\"attr\">ephemeral</span>=<span class=\"string\">&#x27;no&#x27;</span> <span class=\"attr\">private</span>=<span class=\"string\">&#x27;no&#x27;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">usage</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;ceph&#x27;</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">name</span>&gt;</span>client.KVMpool secret<span class=\"tag\">&lt;/<span class=\"name\">name</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">usage</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">secret</span>&gt;</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n<p>将Secret的UUID与Ceph生成的Key进行关联。</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">virsh secret-define --file secret.xml</span><br><span class=\"line\"></span><br><span class=\"line\">Secret 95b1ed29-16aa-4e95-9917-c2cd4f3b2791 created</span><br><span class=\"line\"></span><br><span class=\"line\">virsh secret-set-value 95b1ed29-16aa-4e95-9917-c2cd4f3b2791</span><br><span class=\"line\">AQB9p8RdqS09CBAA1DHsiZJbehb7ZBffhfmFJQ==</span><br></pre></td></tr></table></figure>\n</li>\n<li><p>定义Ceph存储池</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">pool</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;rbd&quot;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">source</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">name</span>&gt;</span>KVMpool<span class=\"tag\">&lt;/<span class=\"name\">name</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">host</span> <span class=\"attr\">name</span>=<span class=\"string\">&#x27;192.168.159.151&#x27;</span> <span class=\"attr\">port</span>=<span class=\"string\">&#x27;6789&#x27;</span>/&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">auth</span> <span class=\"attr\">username</span>=<span class=\"string\">&#x27;KVMpool&#x27;</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;ceph&#x27;</span>&gt;</span></span><br><span class=\"line\">            <span class=\"tag\">&lt;<span class=\"name\">secret</span> <span class=\"attr\">uuid</span>=<span class=\"string\">&#x27;95b1ed29-16aa-4e95-9917-c2cd4f3b2791&#x27;</span>/&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;/<span class=\"name\">auth</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">source</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">pool</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">virsh pool-define --file ceph.xml</span><br><span class=\"line\">virsh pool-start KVMpool</span><br><span class=\"line\">virsh pool-autostart KVMpool</span><br><span class=\"line\">virsh pool-list --details</span><br></pre></td></tr></table></figure></li>\n</ol>\n<h3 id=\"虚拟磁盘镜像和KVM存储基本操作\"><a href=\"#虚拟磁盘镜像和KVM存储基本操作\" class=\"headerlink\" title=\"虚拟磁盘镜像和KVM存储基本操作\"></a>虚拟磁盘镜像和KVM存储基本操作</h3><p>文章介绍了使用dd命令生成磁盘镜像文件，如下：</p>\n<p>生成10G的预分配磁盘文件：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">dd</span> <span class=\"keyword\">if</span>=/dev/zero of=/vms/dbvm_disk2.img bs=1G count=10</span><br></pre></td></tr></table></figure>\n\n<p>生成10G的磁盘文件，使用seek关键字，不做预分配</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">dd</span> <span class=\"keyword\">if</span>=/dev/zero of=/vms/dbvm_disk2_seek.imgbs=1G seek=10 count=0</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"qemu-img-命令\"><a href=\"#qemu-img-命令\" class=\"headerlink\" title=\"qemu-img 命令\"></a>qemu-img 命令</h4><p>使用qemu-img info查看磁盘文件的信息，如下：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># qemu-img info /vms/dbvm_disk2.img</span></span><br><span class=\"line\">image: /vms/dbvm_disk2.img</span><br><span class=\"line\">file format: raw</span><br><span class=\"line\">virtual size: 10G (10737418240 bytes)</span><br><span class=\"line\">disk size: 10G</span><br><span class=\"line\"><span class=\"comment\"># qemu-img info /vms/dbvm_disk2_seek.img</span></span><br><span class=\"line\">image: /vms/dbvm_disk2_seek.img</span><br><span class=\"line\">file format: raw</span><br><span class=\"line\">virtual size: 10G (10737418240 bytes)</span><br><span class=\"line\">disk size: 10M</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"使用virsh命令加载硬盘\"><a href=\"#使用virsh命令加载硬盘\" class=\"headerlink\" title=\"使用virsh命令加载硬盘\"></a>使用virsh命令加载硬盘</h4><figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">virsh attach-disk CentOS8 /vms/dbvm_disk2.img vdb --live --config</span><br></pre></td></tr></table></figure>\n\n<p>说明如下：</p>\n<ul>\n<li><strong>CentOS8</strong> is the virtual machine to which a disk attachment is executed. </li>\n<li>Then, there is the path of the disk image,  <strong>&#x2F;vms&#x2F;dbvm_disk2.img</strong></li>\n<li><strong>vdb</strong> is the target disk name that would be visible inside the guest operating system. </li>\n<li><strong>–live</strong> means performing the action while the virtual machine is running.</li>\n<li><strong>–config</strong> means attaching it persistently across reboot. Not adding a –config switch will keep the disk attached only until reboot.</li>\n</ul>\n<p>查看虚拟机的硬盘信息：</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">virsh domblklist CentOS8 --details</span><br><span class=\"line\"></span><br><span class=\"line\">Type Device Target Source</span><br><span class=\"line\">------------------------------------------------</span><br><span class=\"line\">file disk vda /var/lib/libvirt/images/fedora21.qcow2</span><br><span class=\"line\">file disk vdb /vms/dbvm_disk2_seek.img</span><br></pre></td></tr></table></figure>\n\n<p>还有其他章节，比如创建ISO库、删除存储池、创建卷和删除卷。</p>\n<h4 id=\"有关NVMe和NVMe-over-Fabric\"><a href=\"#有关NVMe和NVMe-over-Fabric\" class=\"headerlink\" title=\"有关NVMe和NVMe over Fabric\"></a>有关NVMe和NVMe over Fabric</h4><p>SSD存储的存取方式发生改变，主要体现在性能和延时这两方面。传统<strong>AHCI</strong> (Advanced Host Controller Interface) 已不能满足SSD的性能要求。</p>\n<p><strong>NVMe</strong> (Non-Volatile Memory Express) 是一个全新的协议，基于PCIe技术，目的在于满足SSD的高性能、低时延的访问要求。越来越多的存储设备已经集成了SSD和NVMe，主要用于缓存，同时也有用于数据存储的。</p>\n<p>Fiber Channel，虽然10多年被人争执说要从市场消失，主要原因无外乎：FC需要专用的交换机、专门的网卡和线缆，FC设备贵，需要专门的知识，而且FC的速率没有以太网发展快。</p>\n<p>但是，目前市场上发生的情况有所不同，FC可以满足NVMe SSD带来的性能提升的需求。</p>\n<p>Two of these concepts derived from <strong>Intel Optane</strong>—<strong>Storage Class Memory (SCM) and Persistent Memory (PM)</strong> are the latest technologies that storage companies and customers want adopted into their storage systems, and fast.</p>\n<p>将工作负载移到内存当中是符合逻辑的，设想一下内存型数据库(Microsoft SQL, SAP HANA, Oracle).</p>\n<p>如果一个存储厂商生产了使用SCM SSD的存储设备，那么只有内存可用于缓存(Cache).</p>\n"},{"title":"Cisco CSR1000v KVM SRIOV Setting Guide on Ubuntu 20.04 With NetworkManager","date":"2021-02-03T14:37:33.000Z","description":"This guide provides the steps on how to install CSR1000v/Catalyst 8000v on KVM, the setting of SRIOV and KVM tuning.","_content":"\n\n\nLast Update: February 3, 2021\n\nAuthor: Rao Weibo\n\nVersion: 1.0\n\n\nThis guide provides the steps on how to install CSR1000v/Catalyst 8000v on KVM, the setting of SRIOV and KVM tuning.\n\n# Ubuntu 20.04 Installation and Settings\n## (1) BIOS settings\n\n| Configuration                        | Recommended Setting |\n| ------------------------------------ | ------------------- |\n| Intel Hyper-Threading  Technology    | Disabled            |\n| Number of Enable Cores               | ALL                 |\n| Execute Disable                      | Enabled             |\n| **Intel VT**                         | **Enabled**         |\n| **Intel VT-D**                       | **Enabled**         |\n| Intel VT-D coherency support         | Enabled             |\n| Intel VT-D ATS support               | Enabled             |\n| CPU Performance                      | High throughput     |\n| Hardware Perfetcher                  | Disabled            |\n| Adjacent Cache Line Prefetcher       | Disabled            |\n| DCU Streamer Prefetch                | Disable             |\n| Power Technology                     | Custom              |\n| Enhanced Intel Speedstep  Technology | Disabled            |\n| Intel Turbo Boost Technology         | Enabled             |\n| Processor Power State C6             | Disabled            |\n| Processor Power State C1 Enhanced    | Disabled            |\n| Frequency Poor Override              | Enabled             |\n| P-State Coordination                 | HW_ALL              |\n| Energy Performance                   | Performance         |\n\nThe above settings are from the Installation guide from [Cisco CSR 1000v and Cisco ISRv Software Configuration Guide](https://www.cisco.com/c/en/us/td/docs/routers/csr1000/software/configuration/b_CSR1000v_Configuration_Guide/b_CSR1000v_Configuration_Guide_chapter_0101.html#con_1313827).\nNote: some platform such as **Cisco NFVIS**, does not disable the Hyper-Threading.\n\n## (2) Ubuntu 20.04 installation tips\nIf you need the Gnome GUI, you can install the Ubuntu 20.04 Desktop.\nAfter the system bootup, **‘apparmor’** is recommended to be disabled, otherwise, you may meet **permission denied** when you assign SRIOV devices to the CSR1kV. You need to reboot to take effect.\n\n```shell\nsudo systemctl disable apparmor\negrep -o '(vmx|svm)' /proc/cpuinfo | sort | uniq\n```\nYou can find the **vmx** on Intel platform, or **svm** on AMD platform.\n\n```shell\nsudo systemctl stop ufw\nsystemctl disable ufw\n```\n\n`cat /etc/sysctl.conf`\n```text\nnet.ipv4.ip_forward = 1\nnet.bridge.bridge-nf-call-ip6tables = 0\nnet.bridge.bridge-nf-call-iptables = 0\nnet.bridge.bridge-nf-call-arptables = 0\n```\n```shell\n$ sudo apt install qemu-kvm libvirt-clients libvirt-daemon-system bridge-utils virt-manager numactl virt-top\n```\nAfter installation, you can check the version\n\n```shell\nubuntu@ubuntu-kvm:~$ libvirtd -V\nlibvirtd (libvirt) 6.0.0\nubuntu@ubuntu-kvm:~$ qemu-system-x86_64 --version\nQEMU emulator version 4.2.1 (Debian 1:4.2-3ubuntu6.11)\nCopyright (c) 2003-2019 Fabrice Bellard and the QEMU Project developers\nubuntu@ubuntu-kvm:~$ virt-manager --version\n2.2.1\nubuntu@ubuntu-kvm:~$ modinfo kvm-intel\nfilename:       /lib/modules/5.4.0-62-generic/kernel/arch/x86/kvm/kvm-intel.ko\nubuntu@ubuntu-kvm:~$ modinfo i40evf\nfilename:       /lib/modules/5.4.0-62-generic/kernel/drivers/net/ethernet/intel/iavf/iavf.ko\nversion:        3.2.3-k\n```\n## (3) NIC Setting\nIn Ubuntu 20.04, we use NetworkManager to config the NIC, you can use nmtui on the terminal, or nmcli.\nFirst, check the netplan.\n\n`cat /etc/netplan/ 00-installer-config.yaml`\n\nEdit the yaml file:\n```yaml\n# Let NetworkManager manage all devices on this system\nnetwork:\n  version: 2\n  renderer: NetworkManager\n```\n```shell\nsudo netplan apply\n```\nThen you can set the network config with nmcli or nmtui.\n\n```shell\nubuntu@ubuntu-kvm:~$ sudo nmcli connection modify netplan-eno1 ipv4.method manual ipv4.addresses 10.75.59.50/24 ipv4.gateway 10.75.59.1 ipv4.dns 64.104.123.245\nubuntu@ubuntu-kvm:~$ sudo nmcli connection modify netplan-eno1 connection.id eno1\nubuntu@ubuntu-kvm:~$ sudo nmcli connection up eno1\n\n# Change the connections name to the devices name.\n\nsudo nmcli connection\nubuntu@ubuntu-kvm:~$ sudo nmcli connection\nNAME        UUID                                  TYPE      DEVICE\neno1        10838d80-caeb-349e-ba73-08ed16d4d666  ethernet  eno1\nenp216s0f0  6556c191-c253-3a5e-b440-c5b071ec29a4  ethernet  enp216s0f0\nenp216s0f1  8080672c-5784-375f-8eb9-a6ef57cbd4f7  ethernet  enp216s0f1\nens1f0      58fb5b1f-c10a-3e7a-9ab9-a8c449840ce6  ethernet  ens1f0\nens1f1      2a06a9d9-b761-3bdf-aa0b-3d44fff2158f  ethernet  ens1f1\nvirbr0      ca7d1e11-a82f-429c-9d91-fc985776232c  bridge    virbr0\n\n#Set the MTU and disable ipv4 for the NIC to enable SRIOV. \n\nsudo nmcli connection modify ens1f0 ethernet.mtu 9216\nsudo nmcli connection modify ens1f0 ipv4.method disabled\nsudo nmcli connection up ens1f0\nsudo ip link show ens1f0\n2: ens1f0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9216 qdisc mq state UP mode DEFAULT group default qlen 1000\nlink/ether 40:a6:b7:0f:a7:74 brd ff:ff:ff:ff:ff:ff\n\n# Note: This value 9216 of MTU is derived from Cisco NFVIS.\nCSP5228-1# show pnic-detail mtu\nName          MTU\n=============================\neth0-1        9216\neth0-2        9216\neth1-1        9216\neth1-2        9216\n```\n\n# SR-IOV Configuration\n\n## (1) Check the NIC to support SR-IOV\n\nCheck the NIC hardware infor.\n\n```shell\nsudo lshw -c network -businfo\n\nBus info          Device      Class          Description\n========================================================\n\npci@0000:3b:00.0  eno1        network        Ethernet Controller 10G X550T\npci@0000:3b:00.1  eno2        network        Ethernet Controller 10G X550T\npci@0000:5e:00.0  ens1f0      network        Ethernet Controller XXV710 for 25GbE SFP28\npci@0000:5e:00.1  ens1f1      network        Ethernet Controller XXV710 for 25GbE SFP28\npci@0000:d8:00.0  enp216s0f0  network        Ethernet Controller XXV710 for 25GbE SFP28\npci@0000:d8:00.1  enp216s0f1  network        Ethernet Controller XXV710 for 25GbE SFP28\n```\n\nCheck the capabilities of NIC\n\n```shell\nsudo lspci -vv -s 5e:00.0 | grep -A 5 -i SR-IOV\n    Capabilities: [160 v1] Single Root I/O Virtualization (SR-IOV)\n        IOVCap: Migration-, Interrupt Message Number: 000\n        IOVCtl: Enable+ Migration- Interrupt- MSE+ ARIHierarchy+\n        IOVSta: Migration-\n        Initial VFs: 64, Total VFs: 64, Number of VFs: 2, Function Dependency Link: 00\n        VF offset: 16, stride: 1, Device ID: 154c\n```\n\n## (2) Change the GRUB parameters\n\n```shell\nsudo vi /etc/default/grub \nGRUB_CMDLINE_LINUX_DEFAULT=\"quiet hugepagesz=1G hugepages=64 default_hugepagesz=1G intel_iommu=on iommu=pt isolcpus=1-8,45-52\"\n```\n\n**Note：The hugepages should be no more than the physical memory, otherwise, it will fail to bootup.**\n\n- **default_hugepagesz=1G hugepagesz=1G hugepages=64** will allocate 64 1GB huge pages at boot, which are **static huge pages**. CSR 1000v will use these static huge pages for best performance.\n- **isolcpus=1-8,45-52** will isolate the CPUs cores reserved for CSR 1000v, prevent other processes running on these cores, this can reduce latency for CSR 1000v. You can refer to   [Check the capability of the platform][1]  to get the CPU information.\n\n```shell\nsudo update-grub\n```\n\nAfter reboot, check the /proc/cmdline.\n\n```shell\ncat /proc/cmdline |grep intel_iommu=on\ndmesg |grep -e DMAR -e IOMMU\ndmesg | grep -e DMAR -e IOMMU -e AMD-Vi\nubuntu@ubuntu-kvm:~$ cat /proc/cmdline |grep intel_iommu=on\nBOOT_IMAGE=/vmlinuz-5.4.0-62-generic root=/dev/mapper/ubuntu--vg-ubuntu--lv ro quiet hugepagesz=1G hugepages=64 default_hugepagesz=1G intel_iommu=on iommu=pt isolcpus=1-8,45-52\n\nubuntu@ubuntu-kvm:~ $ dmesg |grep -e DMAR -e IOMMU\n[    0.020313] ACPI: DMAR 0x000000005DA8EB80 000270 (v01 Cisco0 CiscoUCS 00000001 INTL 20091013)\n[    1.954441] DMAR: IOMMU enabled\n```\n\nCheck the CPU info, all the CPU cores and isolated CPU cores.\n\n```shell\nubuntu@ubuntu-kvm:~$ cat /sys/devices/system/cpu/isolated\n1-8,45-52\nubuntu@ubuntu-kvm:~$ cat /sys/devices/system/cpu/present\n0-87\n```\n\n## (3) VFs Persistence\n\n**NetworkManager way:**\n\n```shell\n# nmcli can set the SRIOV, as follow:\nsudo nmcli connection modify ens1f0 sriov.total-vfs 2\nsudo nmcli connection modify ens1f1 sriov.total-vfs 2\n\n# We can set the MAC address and set the trust on:\nsudo nmcli connection modify ens1f0 sriov.vfs '0 mac=b6:4f:02:37:5a:d8 trust=true, 1 mac=26:04:1d:1f:3d:a9 trust=true'\nsudo nmcli connection modify ens1f1 sriov.vfs '0 mac=76:6c:4e:16:7f:e2 trust=true, 1 mac=6a:f2:bd:97:71:65 trust=true'\nsudo nmcli connection up ens1f0\nsudo nmcli connection up ens1f1\n```\n\nAfter reboot, check the dmesg.\n\n```shell\nsudo dmesg | grep -i vf\n[    6.599304] i40e 0000:5e:00.0: Allocating 2 VFs.\n[    6.680111] i40e 0000:5e:00.1: Allocating 2 VFs.\n[    6.730167] iavf: Intel(R) Ethernet Adaptive Virtual Function Network Driver - version 3.2.3-k\n<< snip >>\n[   17.931493] i40e 0000:5e:00.0: Setting MAC b6:4f:02:37:5a:d8 on VF 0\n[   18.111781] i40e 0000:5e:00.0: VF 0 is now trusted\n[   18.112559] i40e 0000:5e:00.0: Setting MAC 26:04:1d:1f:3d:a9 on VF 1\n[   18.291464] i40e 0000:5e:00.0: VF 1 is now trusted\n[   18.292231] i40e 0000:5e:00.1: Setting MAC 76:6c:4e:16:7f:e2 on VF 0\n[   18.475259] i40e 0000:5e:00.1: VF 0 is now trusted\n[   18.475929] i40e 0000:5e:00.1: Setting MAC 6a:f2:bd:97:71:65 on VF 1\n[   18.659465] i40e 0000:5e:00.1: VF 1 is now trusted\n[   18.728124] iavf 0000:5e:02.0 ens1f0v0: NIC Link is Up Speed is 25 Gbps Full Duplex\n[   18.752275] iavf 0000:5e:02.1 ens1f0v1: NIC Link is Up Speed is 25 Gbps Full Duplex\n[   18.776329] iavf 0000:5e:0a.0 ens1f1v0: NIC Link is Up Speed is 25 Gbps Full Duplex\n[   18.800569] iavf 0000:5e:0a.1 ens1f1v1: NIC Link is Up Speed is 25 Gbps Full Duplex\n```\n\n## (4) Check the VFs\n\nYou can check the VFs from lspci or ip link commands.\n\n```shell\nubuntu@ubuntu-kvm:~$ sudo lspci | grep -i Virtual\nubuntu@ubuntu-kvm:~$ sudo ip link show | grep -B2 vf\n```\n\nGood news is that the VFs names are well related to the physical NICs. For example, **ens1f0v1** is one of the VFs of the physical NIC **ens1f0** .\n\n```shell\nubuntu@ubuntu-kvm:~$ ip link show | grep -E ens1f[0,1]v[0,1] -A 1\n9: ens1f0v1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc mq state UP mode DEFAULT group default qlen 1000\n    link/ether 26:04:1d:1f:3d:a9 brd ff:ff:ff:ff:ff:ff\n10: ens1f1v1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc mq state UP mode DEFAULT group default qlen 1000\n    link/ether 6a:f2:bd:97:71:65 brd ff:ff:ff:ff:ff:ff\n15: ens1f0v0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc mq state UP mode DEFAULT group default qlen 1000\n    link/ether b6:4f:02:37:5a:d8 brd ff:ff:ff:ff:ff:ff\n16: ens1f1v0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc mq state UP mode DEFAULT group default qlen 1000\nlink/ether 76:6c:4e:16:7f:e2 brd ff:ff:ff:ff:ff:ff\n```\n\nWe can change the MTU to **9216** (or you may not need 9216, 1504 is enough).\n\n```shell\nsudo nmcli connection modify ens1f0v0 ethernet.mtu 9216 ipv4.method disabled\nsudo nmcli connection modify ens1f0v1 ethernet.mtu 9216 ipv4.method disabled\nsudo nmcli connection modify ens1f1v0 ethernet.mtu 9216 ipv4.method disabled\nsudo nmcli connection modify ens1f1v1 ethernet.mtu 9216 ipv4.method disabled\nsudo nmcli connection up ens1f0v0 \nsudo nmcli connection up ens1f0v1\nsudo nmcli connection up ens1f1v0\nsudo nmcli connection up ens1f1v1\n```\n\nThe above configs will survive after reboot.\n\n\n\n# Create SR-IOV Virtual Network Adapter Pool\n\nUsing this method, KVM creates a pool of network devices that can be inserted into VMs, and the size of that pool is determined by how many VFs were created on the physical function when they were initialized.\n\n## (1) Create an xml file\n\nubuntu@ubuntu-kvm:~/kvm$ cat ens1f0_sriov_pool.xml\n\n```xml\n<network>\n   <name>ens1f0_sriov_pool</name> <!-- This is the name of the file you created -->\n   <forward mode='hostdev' managed='yes'>\n     <pf dev='ens1f0'/>  <!-- Use the netdev name of your SR-IOV devices PF here -->\n   </forward>\n</network>\n```\n\n## (2) Define a network and set to auto start.\n\n```shell\nvirsh net-define ens1f0_sriov_pool.xml\nSleep 1\nvirsh net-start ens1f0_sriov_pool\nvirsh net-autostart ens1f0_sriov_pool\n```\n\nubuntu@ubuntu-kvm:~/kvm$ virsh net-dumpxml ens1f0_sriov_pool\n\n```xml\n<network connections='1'>\n  <name>ens1f0_sriov_pool</name>\n  <uuid>9125a600-6620-4ab6-9a47-8844a61b0918</uuid>\n  <forward mode='hostdev' managed='yes'>\n    <pf dev='ens1f0'/>\n    <address type='pci' domain='0x0000' bus='0x5e' slot='0x02' function='0x0'/>\n    <address type='pci' domain='0x0000' bus='0x5e' slot='0x02' function='0x1'/>\n  </forward>\n</network>\n```\n\n## (3) Select the virtual adapter from the pool\n\nIt is simple to add an SR-IOV NIC, as follow:\n\n![SRIOV Adapter Pool](csr1kv-kvm-Ubuntu20-04-md/pic1-sriov-pool.png)\n\nThis is equivalent to the following XML:\n\n```xml\n    <interface type='network'>\n      <mac address='52:54:00:0b:a5:2e'/>\n      <source network='ens1f0_sriov_pool'/>\n      <model type='virtio'/>\n      <address type='pci' domain='0x0000' bus='0x02' slot='0x00' function='0x0'/>\n    </interface>\n```\n\nAfter the VM powered on, the network info is as follow:\nvirsh dumpxml CSR1KV-1\n\n```xml\n    <interface type='hostdev' managed='yes'>\n      <mac address='52:54:00:0b:a5:2e'/>\n      <driver name='vfio'/>\n      <source>\n        <address type='pci' domain='0x0000' bus='0x5e' slot='0x02' function='0x0'/>\n      </source>\n      <model type='virtio'/>\n      <alias name='hostdev0'/>\n      <address type='pci' domain='0x0000' bus='0x02' slot='0x00' function='0x0'/>\n    </interface>\n```\n\n# Create the CSR1KV VM from virt-manager\n\nFrom the virt-manager, create a CSR1KV virtual machine step by step, and choose the virtual network interface from the SR-IOV pool.\n\n![Virt-manager step 1](csr1kv-kvm-Ubuntu20-04-md/virt-manager-step1.png)\n\n![Virt-manager Step 2](csr1kv-kvm-Ubuntu20-04-md/virt-manager-step2.png)\n\n![Virt-manager Step2-2](csr1kv-kvm-Ubuntu20-04-md/virt-manager-step2-2.png)\n\n![Virt-manager Step 3](csr1kv-kvm-Ubuntu20-04-md/virt-manager-step3.png)\n\n![Virt-manager Step 4](csr1kv-kvm-Ubuntu20-04-md/virt-manager-step4.png)\n\nNote: The first interface of csr1kv-1 is configured to **macvtap Bridge mode**, so you do not need to create a Linux bridge. However, csr1kv-1 can not communicate to the Linux host through this interface, but it can go out of the Linux host through the eno1. This is a known issue with macvtap.\n\n![Virt-manager Step 5](csr1kv-kvm-Ubuntu20-04-md/add-sriov-pool.png)\n\nAfter select the Virtual Network Interface, click the **Begin Installation**, and you can shut down the virtual machine.\nThe actions above will create the **csr1kv-1.xml** file under the directory: **/etc/libvirtd/qemu/**\n\n# KVM Performance Tunning\n\nKVM performance tuning are related to NUMA, Memory Hugepage and vCPU pinning. The main reference is Redhat Linux 7 PERFORMANCE TUNING GUIDE\n\nWe will use **virsh edit csr1kv-1** to do the performance tuning.\n\n## (1) Check the capability of the platform\n\n```shell\nubuntu@ubuntu-kvm:~$ virsh nodeinfo\nCPU model:           x86_64\nCPU(s):              88\nCPU frequency:       1000 MHz\nCPU socket(s):       1\nCore(s) per socket:  22\nThread(s) per core:  2\nNUMA cell(s):        2\nMemory size:         394929928 KiB\n```\n\n[1]:ubuntu@ubuntu-kvm:~$ virsh capabilities\n\n```xml\n<capabilities>\n\n  <host>\n    <uuid>a24f9760-48f1-f34e-a001-a848f08df7bb</uuid>\n    <cpu>\n      <arch>x86_64</arch>\n      <model>Cascadelake-Server-noTSX</model>\n      <vendor>Intel</vendor>\n      <microcode version='83898371'/>\n      <counter name='tsc' frequency='2095078000' scaling='no'/>\n      <topology sockets='1' cores='22' threads='2'/>\n...\n```\n\nFrom the outputs, we can get the cores of CPU, the NUMA info and the hugepages.\n\n## (2) NUMA Info\n\n```shell\nubuntu@ubuntu-kvm:~$ numactl --hardware\navailable: 2 nodes (0-1)\nnode 0 cpus: 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65\nnode 0 size: 192172 MB\nnode 0 free: 152956 MB\nnode 1 cpus: 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87\nnode 1 size: 193500 MB\nnode 1 free: 158037 MB\nnode distances:\nnode   0   1\n  0:  10  21\n  1:  21  10 \n```\n\nTwo CPUs, each has 192GB memory, the NUMA node are node 0 and node 1.\n\nYou can also check the NUMA info of the NIC, as follow:\n\n```shell\nubuntu@ubuntu-kvm:~$ sudo lspci -vv | grep Ethernet -A 6\n5e:00.0 Ethernet controller: Intel Corporation Ethernet Controller XXV710 for 25GbE SFP28 (rev 02)\n    Subsystem: Cisco Systems Inc Ethernet Network Adapter XXV710\n    Control: I/O- Mem+ BusMaster+ SpecCycle- MemWINV- VGASnoop- ParErr+ Stepping- SERR+ FastB2B- DisINTx+\n    Status: Cap+ 66MHz- UDF- FastB2B- ParErr- DEVSEL=fast >TAbort- <TAbort- <MAbort- >SERR- <PERR- INTx-\n    Latency: 0, Cache Line Size: 32 bytes\n    Interrupt: pin A routed to IRQ 137\n    NUMA node: 0\n\n#Or you can find the numa infor from udevadm.\nubuntu@ubuntu-kvm:~$ sudo udevadm info -ap /sys/class/net/ens1f0 | grep numa\n    ATTRS{numa_node}==\"0\"\n    ATTRS{numa_node}==\"0\"\n```\n\nIf the memory and NICs are all on numa_node 0, that would be more efficient. Please check the server’s PCI-E slots mapping with the CPU slots.\n\n## (3) HugePage and Transparent Hugepage\n\nTo check the memory info\n\n```shell\nubuntu@ubuntu-kvm:~$ cat /proc/meminfo | grep Huge\nAnonHugePages:    133120 kB\nShmemHugePages:        0 kB\nFileHugePages:         0 kB\nHugePages_Total:      64\nHugePages_Free:       56\nHugePages_Rsvd:        0\nHugePages_Surp:        0\nHugepagesize:    1048576 kB\nHugetlb:        67108864 kB\n```\n\nYou can change the hugepages on the run time：\n\n```shell\nubuntu@ubuntu-kvm:~$ cat /sys/devices/system/node/node0/hugepages/hugepages-1048576kB/nr_hugepages\n32\nsudo su -     // switch to root user.\nroot@ubuntu-kvm:~# echo 64 > /sys/devices/system/node/node0/hugepages/hugepages-1048576kB/nr_hugepages\nroot@ubuntu-kvm:~# echo 64 > /sys/devices/system/node/node1/hugepages/hugepages-1048576kB/nr_hugepages\n```\n\nCheck and configure the transparent_hugepage:\n\n```shell\nroot@ubuntu-kvm:~# echo always > /sys/kernel/mm/transparent_hugepage/enabled\ncat /sys/kernel/mm/transparent_hugepage/enabled\n[always] madvise never\n```\n\n## (4) vCPU Pinning\n\nvCPU pinning can improve the cache meet rate and improve the performance.\nYou can check the vcpu pinning.\n**virsh vcpuinfo csr1kv-1**\n\n## (5) Edit the XML file of the CSR1KV\n\nRun virsh edit csr1kv-1 to edit the parameters.\nPlease pay attention to the following texts, other parameters might be different.\n\n```xml\n  <memoryBacking>\n    <hugepages>\n      <page size='1048576' unit='KiB'/>\n    </hugepages>\n    <locked/>\n    <nosharepages/>\n  </memoryBacking>\n  <vcpu placement='static'>8</vcpu>\n  <cputune>\n    <vcpupin vcpu='0' cpuset='1'/>\n    <vcpupin vcpu='1' cpuset='2'/>\n    <vcpupin vcpu='2' cpuset='3'/>\n    <vcpupin vcpu='3' cpuset='4'/>\n    <vcpupin vcpu='4' cpuset='5'/>\n    <vcpupin vcpu='5' cpuset='6'/>\n    <vcpupin vcpu='6' cpuset='7'/>\n    <vcpupin vcpu='7' cpuset='8'/>\n    <emulatorpin cpuset='45-52'/> <!-- If Hyper-threading were enabled -->\n  </cputune>\n  <numatune>\n    <memory mode='strict' nodeset='0'/>\n  </numatune>\n  <cpu mode='host-passthrough' check='none'/>\n    <memballoon model='none'/>\n```\n\nPlease note that, if hyper-threading is enabled in BIOS setting, the parameter “emulatorpin” should be set, the cpuset are from the “virsh capabilities”, for example, siblings='1,45'. When the core 1 is pinned, core 45 should be set in emulatorpin.\n\nFrom the guide <https://libvirt.org/formatdomain.html> and <https://libvirt.org/kbase/kvm-realtime.html> we set the CPU and memory tuning parameters as the highlighted text.\n\n```xml\n<domain type='kvm'>\n  <name>csr1kv-1</name>\n  <uuid>83f90c1c-f0ea-4298-bcdf-3d676de2aeb4</uuid>\n  <metadata>\n    <libosinfo:libosinfo xmlns:libosinfo=\"http://libosinfo.org/xmlns/libvirt/domain/1.0\">\n      <libosinfo:os id=\"http://centos.org/centos/7.0\"/>\n    </libosinfo:libosinfo>\n  </metadata>\n  <memory unit='KiB'>8388608</memory>\n  <currentMemory unit='KiB'>8388608</currentMemory>\n  <memoryBacking>\n    <hugepages>\n      <page size='1048576' unit='KiB'/>\n    </hugepages>\n    <locked/>\n    <nosharepages/>\n  </memoryBacking>\n  <vcpu placement='static'>8</vcpu>\n  <cputune>\n    <vcpupin vcpu='0' cpuset='1'/>\n    <vcpupin vcpu='1' cpuset='2'/>\n    <vcpupin vcpu='2' cpuset='3'/>\n    <vcpupin vcpu='3' cpuset='4'/>\n    <vcpupin vcpu='4' cpuset='5'/>\n    <vcpupin vcpu='5' cpuset='6'/>\n    <vcpupin vcpu='6' cpuset='7'/>\n    <vcpupin vcpu='7' cpuset='8'/>\n    <emulatorpin cpuset='45-52'/> <!-- If Hyper-threading were enabled -->\n  </cputune>\n  <numatune>\n    <memory mode='strict' nodeset='0'/>\n  </numatune>\n  <os>\n    <type arch='x86_64' machine='pc-q35-4.2'>hvm</type>\n    <boot dev='hd'/>\n  </os>\n  <features>\n    <acpi/>\n    <apic/>\n    <vmport state='off'/>\n  </features>\n  <cpu mode='host-passthrough' check='none'/>\n  <clock offset='utc'>\n    <timer name='rtc' tickpolicy='catchup'/>\n    <timer name='pit' tickpolicy='delay'/>\n    <timer name='hpet' present='no'/>\n  </clock>\n  <on_poweroff>destroy</on_poweroff>\n  <on_reboot>restart</on_reboot>\n  <on_crash>destroy</on_crash>\n  <pm>\n    <suspend-to-mem enabled='no'/>\n    <suspend-to-disk enabled='no'/>\n  </pm>\n  <devices>\n    <emulator>/usr/bin/qemu-system-x86_64</emulator>\n    <disk type='file' device='disk'>\n      <driver name='qemu' type='qcow2'/>\n      <source file='/var/lib/libvirt/images/csr1000v-universalk9.17.02.01v.qcow2'/>\n      <target dev='vda' bus='virtio'/>\n      <address type='pci' domain='0x0000' bus='0x05' slot='0x00' function='0x0'/>\n    </disk>\n    <controller type='usb' index='0' model='qemu-xhci' ports='15'>\n      <address type='pci' domain='0x0000' bus='0x03' slot='0x00' function='0x0'/>\n    </controller>\n    <controller type='sata' index='0'>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x1f' function='0x2'/>\n    </controller>\n    <controller type='pci' index='0' model='pcie-root'/>\n    <controller type='pci' index='1' model='pcie-root-port'>\n      <model name='pcie-root-port'/>\n      <target chassis='1' port='0x10'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x02' function='0x0' multifunction='on'/>\n    </controller>\n    <controller type='pci' index='2' model='pcie-root-port'>\n      <model name='pcie-root-port'/>\n      <target chassis='2' port='0x11'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x02' function='0x1'/>\n    </controller>\n    <controller type='pci' index='3' model='pcie-root-port'>\n      <model name='pcie-root-port'/>\n      <target chassis='3' port='0x12'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x02' function='0x2'/>\n    </controller>\n    <controller type='pci' index='4' model='pcie-root-port'>\n      <model name='pcie-root-port'/>\n      <target chassis='4' port='0x13'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x02' function='0x3'/>\n    </controller>\n    <controller type='pci' index='5' model='pcie-root-port'>\n      <model name='pcie-root-port'/>\n      <target chassis='5' port='0x14'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x02' function='0x4'/>\n    </controller>\n    <controller type='pci' index='6' model='pcie-root-port'>\n      <model name='pcie-root-port'/>\n      <target chassis='6' port='0x15'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x02' function='0x5'/>\n    </controller>\n    <controller type='pci' index='7' model='pcie-root-port'>\n      <model name='pcie-root-port'/>\n      <target chassis='7' port='0x16'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x02' function='0x6'/>\n    </controller>\n    <controller type='pci' index='8' model='pcie-root-port'>\n      <model name='pcie-root-port'/>\n      <target chassis='8' port='0x17'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x02' function='0x7'/>\n    </controller>\n    <controller type='virtio-serial' index='0'>\n      <address type='pci' domain='0x0000' bus='0x04' slot='0x00' function='0x0'/>\n    </controller>\n    <interface type='direct'>\n      <mac address='52:54:00:69:ec:73'/>\n      <source dev='eno1' mode='bridge'/>\n      <model type='virtio'/>\n      <address type='pci' domain='0x0000' bus='0x01' slot='0x00' function='0x0'/>\n    </interface>\n    <interface type='network'>\n      <mac address='52:54:00:0b:a5:2e'/>\n      <source network='ens1f0_sriov_pool'/>\n      <model type='virtio'/>\n      <address type='pci' domain='0x0000' bus='0x02' slot='0x00' function='0x0'/>\n    </interface>\n    <interface type='network'>\n      <mac address='52:54:00:bd:9f:54'/>\n      <source network='ens1f1_sriov_pool'/>\n      <model type='virtio'/>\n      <address type='pci' domain='0x0000' bus='0x08' slot='0x00' function='0x0'/>\n    </interface>\n    <serial type='pty'>\n      <target type='isa-serial' port='0'>\n        <model name='isa-serial'/>\n      </target>\n    </serial>\n    <console type='pty'>\n      <target type='serial' port='0'/>\n    </console>\n    <channel type='unix'>\n      <target type='virtio' name='org.qemu.guest_agent.0'/>\n      <address type='virtio-serial' controller='0' bus='0' port='1'/>\n    </channel>\n    <channel type='spicevmc'>\n      <target type='virtio' name='com.redhat.spice.0'/>\n      <address type='virtio-serial' controller='0' bus='0' port='2'/>\n    </channel>\n    <input type='mouse' bus='ps2'/>\n    <input type='keyboard' bus='ps2'/>\n    <graphics type='spice' autoport='yes'>\n      <listen type='address'/>\n      <image compression='off'/>\n    </graphics>\n    <video>\n      <model type='qxl' ram='65536' vram='65536' vgamem='16384' heads='1' primary='yes'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x01' function='0x0'/>\n    </video>\n    <redirdev bus='usb' type='spicevmc'>\n      <address type='usb' bus='0' port='2'/>\n    </redirdev>\n    <redirdev bus='usb' type='spicevmc'>\n      <address type='usb' bus='0' port='3'/>\n    </redirdev>\n    <memballoon model='none'/>\n  </devices>\n</domain>\n```\n\nThe parameters are from [Cisco CSR 1000v and Cisco ISRv Software Configuration Guide](https://www.cisco.com/c/en/us/td/docs/routers/csr1000/software/configuration/b_CSR1000v_Configuration_Guide/b_CSR1000v_Configuration_Guide_chapter_0101.html#con_1313827)\nAfter you install the CSR1000v, and edit the XML file, you can run virsh to create the csr1kv.\n\n```shell\ncd /etc/libvirtd/qemu\nvirsh define csr1kv-1.xml\nvirsh start csr1kv-1\n```\n\n## (6) Check CSR1000v’s tunning\n\nubuntu@ubuntu-kvm:/etc/libvirt/qemu$ virsh list\n\n```shell\n Id   Name       State\n--------------------------\n\n 1    csr1kv-1   running\n\nubuntu@ubuntu-kvm:/etc/libvirt/qemu$ virsh vcpuinfo 1\nVCPU:           0\nCPU:            1\nState:          running\nCPU time:       167.0s\nCPU Affinity:   -y--------------------------------------------------------------------------------------\n\nVCPU:           1\nCPU:            2\nState:          running\nCPU time:       193.3s\nCPU Affinity:   --y-------------------------------------------------------------------------------------\n\nVCPU:           2\nCPU:            3\nState:          running\nCPU time:       152.5s\nCPU Affinity:   ---y------------------------------------------------------------------------------------\n\nVCPU:           3\nCPU:            4\nState:          running\nCPU time:       174.3s\nCPU Affinity:   ----y-----------------------------------------------------------------------------------\n\nVCPU:           4\nCPU:            5\nState:          running\nCPU time:       260.6s\nCPU Affinity:   -----y----------------------------------------------------------------------------------\n\nVCPU:           5\nCPU:            6\nState:          running\nCPU time:       386.0s\nCPU Affinity:   ------y---------------------------------------------------------------------------------\n\nVCPU:           6\nCPU:            7\nState:          running\nCPU time:       2189.9s\nCPU Affinity:   -------y--------------------------------------------------------------------------------\n\nVCPU:           7\nCPU:            8\nState:          running\nCPU time:       2192.2s\nCPU Affinity:   --------y-------------------------------------------------------------------------------\n```\n\n\nFrom the above outputs, we can find that the vCPUa are pinned to NO. 1 to 8 CPU cores.\n\n```shell\nubuntu@ubuntu-kvm:~$ sudo numastat -c qemu\nPer-node process memory usage (in MBs)\nPID              Node 0 Node 1 Total\n\n---------------  ------ ------ -----\n\n4391 (qemu-syste   8373      0  8373\n5891 (sudo)           4      1     5\n\n---------------  ------ ------ -----\n\nTotal              8377      1  8377\n\nubuntu@ubuntu-kvm:~$ sudo numastat -p 4391\nPer-node process memory usage (in MBs) for PID 4391 (qemu-system-x86)\n                           Node 0          Node 1           Total\n                  --------------- --------------- ---------------\nHuge                      8192.00            0.00         8192.00\nHeap                        10.00            0.00           10.00\nStack                        0.03            0.00            0.03\nPrivate                    170.70            0.15          170.85\n\n----------------  --------------- --------------- ---------------\n\nTotal                     8372.73            0.16         8372.88\n```\n\n\nFrom the above outputs, the csr1kv-1 are using the memories from node 0.\n\n## (7) Check the vNIC in CSR1KV\n\n```ios\ncsr1kv-1#show platform software vnic-if interface-mapping\n-------------------------------------------------------------\n\n Interface Name        Driver Name         Mac Addr\n-------------------------------------------------------------\n\n GigabitEthernet3       net_i40e_vf        5254.00bd.9f54\n GigabitEthernet2       net_i40e_vf        5254.000b.a52e\n GigabitEthernet1       net_virtio         5254.0069.ec73\n```\n\nThe Driver Name net_i40e_vf indicates that the vNIC is a VF from the SR-IOV pool.\n\n# CSR 1000v initial configuration and Smart License registration\n\n## (1) CSR 1000v initial config example\n\nPart of the configuration:\n\n```\nCSR1000v-1#show sdwan running-config\nsystem\n system-ip             1.1.10.1\n site-id               101\n sp-organization-name  CiscoBJ\n organization-name     CiscoBJ\n vbond 10.75.58.51 port 12346\n!\nhostname CSR1000v-1\nusername admin privilege 15 secret 9 $9$4/QL2V2K4/6H1k$XUmRNf.T7t3KDOj/FmoNexpEypCxr482dExXHDnohSI\nip name-server 64.104.123.245\nip route 0.0.0.0 0.0.0.0 10.75.59.1\n\ninterface GigabitEthernet1\n no shutdown\n arp timeout 1200\n ip address 10.75.59.35 255.255.255.0\n no ip redirects\n ip mtu    1500\n mtu 1500\n negotiation auto\nexit\n\ninterface Tunnel1\n no shutdown\n ip unnumbered GigabitEthernet1\n no ip redirects\n ipv6 unnumbered GigabitEthernet1\n no ipv6 redirects\n tunnel source GigabitEthernet1\n tunnel mode sdwan\nexit\n\nclock timezone CST 8 0\nntp server x.x.x.x version 4\n\nsdwan\n interface GigabitEthernet1\n  tunnel-interface\n   encapsulation ipsec\n   allow-service sshd\n  exit\n```\n\n## (2) Commands to check the status\n\n```\nshow sdwan control local-properties\nshow sdwan control connections\nshow sdwan control connection-history\nshow sdwan running-config\nshow sdwan bfd sessions\nshow sdwan omp peers\nshow sdwan omp routes\n```\n\n## (3) CSR 1000v Smart License Registration\n\nBefore Smart License registration, you need ：\n1. CSR 1000v’s control connections are up；\n2. Configure ip http client source-interface GigabitEthernet2\n3. If the version is 16.12.x and bellow, you need to allow service all\n   `sdwan interface GigabitEthernet2 tunnel-interface allow-service all `\n   In the 17.2.x and above versions, there is an allow-service https\n4. CSR 1000v can access URL：https://tools.cisco.com/its/service/oddce/services/DDCEService\n   The command license smart register idtoken xxxxxx will do the registration.\n   You can find the idtoken from your Smart Account smart license inventory.\n   show license status to check the status.\n\n\n```\nCSR1000v-1#show platform hardware throughput level\nThe current throughput level is 200000000 kb/s\n```\n\n# Performances and limitations\n\n## (1) The performance of the SR-IOV\n\nA performance test was done after the SR-IOV setup, the CSR1KV was configured as 8vCPU and 8G Memory, the packet drop rate was 0%.\n\n| Packet Site | SDWAN Performance (Mbps) | CEF Performance (Mbps) |\n| ----------- | ------------------------ | ---------------------- |\n| 128Bytes    | 800                      | 2843.75                |\n| 256Bytes    | 1431.26                  | 6500.00                |\n| 512Bytes    | 2581.26                  | 10578.13               |\n| 1024Bytes   | 3731.26                  | 15500.00               |\n| 1400Bytes   | 4306.26                  | 18171.88               |\n\n![Performance Line Chart](csr1kv-kvm-Ubuntu20-04-md/line-chart.png)\n\nNote: **These test results are not to represent the official performance data. Different servers and network cards may have different test results. The above data is for demo only.**\n\n## (2) The limitation of the SR-IOV\n\nThe main limitation of the SR-IOV is the number of VLANs on each VF, the maximum VLAN of an VF is limited to 63 in ixgbevf.\nSo, the active number of sub-interfaces on an interface of the CSR1KV that uses the SRIOV VFs is limited to 63.\nThere is some notes in the Cisco CSR 1000v and Cisco ISRv Software Configuration Guide:\n\n> SR-IOV (ixgbevf)\n> Maximum VLANs: The maximum number of VLANs supported on PF is 64. Together, all VFs can have a total of 64 VLANs. (Intel limitation.)\n>\n> SR-IOV (i40evf)\n> Maximum VLANs: The maximum number of VLANs supported on PF is 512. Together, all VFs can have a total of 512 VLANs. (Intel limitation.) Per-VF resources are managed by the PF (host) device driver.\n\n# References\n\n<https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html-single/performance_tuning_guide/index>\n\n<https://computingforgeeks.com/how-to-create-and-configure-bridge-networking-for-kvm-in-linux/>\n\n<https://software.intel.com/content/www/us/en/develop/articles/configure-sr-iov-network-virtual-functions-in-linux-kvm.html>\n\n<https://linuxconfig.org/install-and-set-up-kvm-on-ubuntu-20-04-focal-fossa-linux>\n\n<https://kifarunix.com/how-to-fix-qemu-kvm-not-connected-error-on-ubuntu-20-04/>\n\n<https://linuxconfig.org/how-to-disable-apparmor-on-ubuntu-20-04-focal-fossa-linux>\n\n**CSR1000v SD-WAN Installation on KVM** by Jean-Marc Barozet\n\n\n\n# Scripts and XML Example Files\n\n1. [Ubuntu and KVM installation and setting](https://raw.githubusercontent.com/weiborao/CSR1KV-Installation-on-KVM-with-SRIOV/main/kvm/1.2-install-ubuntu-kvm.sh)\n2. [NIC Settings with nmcli](https://github.com/weiborao/CSR1KV-Installation-on-KVM-with-SRIOV/raw/main/kvm/1.3-nic-settings.sh)\n3. [Check NIC SRIOV Capabilities](https://github.com/weiborao/CSR1KV-Installation-on-KVM-with-SRIOV/raw/main/kvm/2.1-check-nic-sriov.sh)\n4. [GRUB Settings](https://github.com/weiborao/CSR1KV-Installation-on-KVM-with-SRIOV/raw/main/kvm/2.2-change-grub.sh)\n5. [SRIOV Settings](https://github.com/weiborao/CSR1KV-Installation-on-KVM-with-SRIOV/raw/main/kvm/2.3-sriov-setting.sh)\n6. [Check VFs](https://github.com/weiborao/CSR1KV-Installation-on-KVM-with-SRIOV/raw/main/kvm/2.4-check-vfs.sh)\n7. [Create SRIOV Adapter Pool](https://github.com/weiborao/CSR1KV-Installation-on-KVM-with-SRIOV/raw/main/kvm/3.0-create-sriov-pool.sh)\n8. [KVM Tuning](https://github.com/weiborao/CSR1KV-Installation-on-KVM-with-SRIOV/raw/main/kvm/4.0-kvm-tuning.sh)\n9. [Check CSR1000v Tuning](https://github.com/weiborao/CSR1KV-Installation-on-KVM-with-SRIOV/raw/main/kvm/4.1-check-csr1kv.sh)\n10. [ens1f0_sriov_pool.xml](https://github.com/weiborao/CSR1KV-Installation-on-KVM-with-SRIOV/raw/main/kvm/ens1f0_sriov_pool.xml)\n11. [csr1kv-1.xml](https://github.com/weiborao/CSR1KV-Installation-on-KVM-with-SRIOV/raw/main/kvm/csr1kv-1.xml)","source":"_posts/csr1kv-kvm-Ubuntu20-04-md.md","raw":"---\ntitle: Cisco CSR1000v KVM SRIOV Setting Guide on Ubuntu 20.04 With NetworkManager\ndate: 2021-02-03 22:37:33\ntags: \n    - CSR1000v\n    - KVM\n    - SRIOV\n    - NetworkManager\ndescription: This guide provides the steps on how to install CSR1000v/Catalyst 8000v on KVM, the setting of SRIOV and KVM tuning.\n---\n\n\n\nLast Update: February 3, 2021\n\nAuthor: Rao Weibo\n\nVersion: 1.0\n\n\nThis guide provides the steps on how to install CSR1000v/Catalyst 8000v on KVM, the setting of SRIOV and KVM tuning.\n\n# Ubuntu 20.04 Installation and Settings\n## (1) BIOS settings\n\n| Configuration                        | Recommended Setting |\n| ------------------------------------ | ------------------- |\n| Intel Hyper-Threading  Technology    | Disabled            |\n| Number of Enable Cores               | ALL                 |\n| Execute Disable                      | Enabled             |\n| **Intel VT**                         | **Enabled**         |\n| **Intel VT-D**                       | **Enabled**         |\n| Intel VT-D coherency support         | Enabled             |\n| Intel VT-D ATS support               | Enabled             |\n| CPU Performance                      | High throughput     |\n| Hardware Perfetcher                  | Disabled            |\n| Adjacent Cache Line Prefetcher       | Disabled            |\n| DCU Streamer Prefetch                | Disable             |\n| Power Technology                     | Custom              |\n| Enhanced Intel Speedstep  Technology | Disabled            |\n| Intel Turbo Boost Technology         | Enabled             |\n| Processor Power State C6             | Disabled            |\n| Processor Power State C1 Enhanced    | Disabled            |\n| Frequency Poor Override              | Enabled             |\n| P-State Coordination                 | HW_ALL              |\n| Energy Performance                   | Performance         |\n\nThe above settings are from the Installation guide from [Cisco CSR 1000v and Cisco ISRv Software Configuration Guide](https://www.cisco.com/c/en/us/td/docs/routers/csr1000/software/configuration/b_CSR1000v_Configuration_Guide/b_CSR1000v_Configuration_Guide_chapter_0101.html#con_1313827).\nNote: some platform such as **Cisco NFVIS**, does not disable the Hyper-Threading.\n\n## (2) Ubuntu 20.04 installation tips\nIf you need the Gnome GUI, you can install the Ubuntu 20.04 Desktop.\nAfter the system bootup, **‘apparmor’** is recommended to be disabled, otherwise, you may meet **permission denied** when you assign SRIOV devices to the CSR1kV. You need to reboot to take effect.\n\n```shell\nsudo systemctl disable apparmor\negrep -o '(vmx|svm)' /proc/cpuinfo | sort | uniq\n```\nYou can find the **vmx** on Intel platform, or **svm** on AMD platform.\n\n```shell\nsudo systemctl stop ufw\nsystemctl disable ufw\n```\n\n`cat /etc/sysctl.conf`\n```text\nnet.ipv4.ip_forward = 1\nnet.bridge.bridge-nf-call-ip6tables = 0\nnet.bridge.bridge-nf-call-iptables = 0\nnet.bridge.bridge-nf-call-arptables = 0\n```\n```shell\n$ sudo apt install qemu-kvm libvirt-clients libvirt-daemon-system bridge-utils virt-manager numactl virt-top\n```\nAfter installation, you can check the version\n\n```shell\nubuntu@ubuntu-kvm:~$ libvirtd -V\nlibvirtd (libvirt) 6.0.0\nubuntu@ubuntu-kvm:~$ qemu-system-x86_64 --version\nQEMU emulator version 4.2.1 (Debian 1:4.2-3ubuntu6.11)\nCopyright (c) 2003-2019 Fabrice Bellard and the QEMU Project developers\nubuntu@ubuntu-kvm:~$ virt-manager --version\n2.2.1\nubuntu@ubuntu-kvm:~$ modinfo kvm-intel\nfilename:       /lib/modules/5.4.0-62-generic/kernel/arch/x86/kvm/kvm-intel.ko\nubuntu@ubuntu-kvm:~$ modinfo i40evf\nfilename:       /lib/modules/5.4.0-62-generic/kernel/drivers/net/ethernet/intel/iavf/iavf.ko\nversion:        3.2.3-k\n```\n## (3) NIC Setting\nIn Ubuntu 20.04, we use NetworkManager to config the NIC, you can use nmtui on the terminal, or nmcli.\nFirst, check the netplan.\n\n`cat /etc/netplan/ 00-installer-config.yaml`\n\nEdit the yaml file:\n```yaml\n# Let NetworkManager manage all devices on this system\nnetwork:\n  version: 2\n  renderer: NetworkManager\n```\n```shell\nsudo netplan apply\n```\nThen you can set the network config with nmcli or nmtui.\n\n```shell\nubuntu@ubuntu-kvm:~$ sudo nmcli connection modify netplan-eno1 ipv4.method manual ipv4.addresses 10.75.59.50/24 ipv4.gateway 10.75.59.1 ipv4.dns 64.104.123.245\nubuntu@ubuntu-kvm:~$ sudo nmcli connection modify netplan-eno1 connection.id eno1\nubuntu@ubuntu-kvm:~$ sudo nmcli connection up eno1\n\n# Change the connections name to the devices name.\n\nsudo nmcli connection\nubuntu@ubuntu-kvm:~$ sudo nmcli connection\nNAME        UUID                                  TYPE      DEVICE\neno1        10838d80-caeb-349e-ba73-08ed16d4d666  ethernet  eno1\nenp216s0f0  6556c191-c253-3a5e-b440-c5b071ec29a4  ethernet  enp216s0f0\nenp216s0f1  8080672c-5784-375f-8eb9-a6ef57cbd4f7  ethernet  enp216s0f1\nens1f0      58fb5b1f-c10a-3e7a-9ab9-a8c449840ce6  ethernet  ens1f0\nens1f1      2a06a9d9-b761-3bdf-aa0b-3d44fff2158f  ethernet  ens1f1\nvirbr0      ca7d1e11-a82f-429c-9d91-fc985776232c  bridge    virbr0\n\n#Set the MTU and disable ipv4 for the NIC to enable SRIOV. \n\nsudo nmcli connection modify ens1f0 ethernet.mtu 9216\nsudo nmcli connection modify ens1f0 ipv4.method disabled\nsudo nmcli connection up ens1f0\nsudo ip link show ens1f0\n2: ens1f0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 9216 qdisc mq state UP mode DEFAULT group default qlen 1000\nlink/ether 40:a6:b7:0f:a7:74 brd ff:ff:ff:ff:ff:ff\n\n# Note: This value 9216 of MTU is derived from Cisco NFVIS.\nCSP5228-1# show pnic-detail mtu\nName          MTU\n=============================\neth0-1        9216\neth0-2        9216\neth1-1        9216\neth1-2        9216\n```\n\n# SR-IOV Configuration\n\n## (1) Check the NIC to support SR-IOV\n\nCheck the NIC hardware infor.\n\n```shell\nsudo lshw -c network -businfo\n\nBus info          Device      Class          Description\n========================================================\n\npci@0000:3b:00.0  eno1        network        Ethernet Controller 10G X550T\npci@0000:3b:00.1  eno2        network        Ethernet Controller 10G X550T\npci@0000:5e:00.0  ens1f0      network        Ethernet Controller XXV710 for 25GbE SFP28\npci@0000:5e:00.1  ens1f1      network        Ethernet Controller XXV710 for 25GbE SFP28\npci@0000:d8:00.0  enp216s0f0  network        Ethernet Controller XXV710 for 25GbE SFP28\npci@0000:d8:00.1  enp216s0f1  network        Ethernet Controller XXV710 for 25GbE SFP28\n```\n\nCheck the capabilities of NIC\n\n```shell\nsudo lspci -vv -s 5e:00.0 | grep -A 5 -i SR-IOV\n    Capabilities: [160 v1] Single Root I/O Virtualization (SR-IOV)\n        IOVCap: Migration-, Interrupt Message Number: 000\n        IOVCtl: Enable+ Migration- Interrupt- MSE+ ARIHierarchy+\n        IOVSta: Migration-\n        Initial VFs: 64, Total VFs: 64, Number of VFs: 2, Function Dependency Link: 00\n        VF offset: 16, stride: 1, Device ID: 154c\n```\n\n## (2) Change the GRUB parameters\n\n```shell\nsudo vi /etc/default/grub \nGRUB_CMDLINE_LINUX_DEFAULT=\"quiet hugepagesz=1G hugepages=64 default_hugepagesz=1G intel_iommu=on iommu=pt isolcpus=1-8,45-52\"\n```\n\n**Note：The hugepages should be no more than the physical memory, otherwise, it will fail to bootup.**\n\n- **default_hugepagesz=1G hugepagesz=1G hugepages=64** will allocate 64 1GB huge pages at boot, which are **static huge pages**. CSR 1000v will use these static huge pages for best performance.\n- **isolcpus=1-8,45-52** will isolate the CPUs cores reserved for CSR 1000v, prevent other processes running on these cores, this can reduce latency for CSR 1000v. You can refer to   [Check the capability of the platform][1]  to get the CPU information.\n\n```shell\nsudo update-grub\n```\n\nAfter reboot, check the /proc/cmdline.\n\n```shell\ncat /proc/cmdline |grep intel_iommu=on\ndmesg |grep -e DMAR -e IOMMU\ndmesg | grep -e DMAR -e IOMMU -e AMD-Vi\nubuntu@ubuntu-kvm:~$ cat /proc/cmdline |grep intel_iommu=on\nBOOT_IMAGE=/vmlinuz-5.4.0-62-generic root=/dev/mapper/ubuntu--vg-ubuntu--lv ro quiet hugepagesz=1G hugepages=64 default_hugepagesz=1G intel_iommu=on iommu=pt isolcpus=1-8,45-52\n\nubuntu@ubuntu-kvm:~ $ dmesg |grep -e DMAR -e IOMMU\n[    0.020313] ACPI: DMAR 0x000000005DA8EB80 000270 (v01 Cisco0 CiscoUCS 00000001 INTL 20091013)\n[    1.954441] DMAR: IOMMU enabled\n```\n\nCheck the CPU info, all the CPU cores and isolated CPU cores.\n\n```shell\nubuntu@ubuntu-kvm:~$ cat /sys/devices/system/cpu/isolated\n1-8,45-52\nubuntu@ubuntu-kvm:~$ cat /sys/devices/system/cpu/present\n0-87\n```\n\n## (3) VFs Persistence\n\n**NetworkManager way:**\n\n```shell\n# nmcli can set the SRIOV, as follow:\nsudo nmcli connection modify ens1f0 sriov.total-vfs 2\nsudo nmcli connection modify ens1f1 sriov.total-vfs 2\n\n# We can set the MAC address and set the trust on:\nsudo nmcli connection modify ens1f0 sriov.vfs '0 mac=b6:4f:02:37:5a:d8 trust=true, 1 mac=26:04:1d:1f:3d:a9 trust=true'\nsudo nmcli connection modify ens1f1 sriov.vfs '0 mac=76:6c:4e:16:7f:e2 trust=true, 1 mac=6a:f2:bd:97:71:65 trust=true'\nsudo nmcli connection up ens1f0\nsudo nmcli connection up ens1f1\n```\n\nAfter reboot, check the dmesg.\n\n```shell\nsudo dmesg | grep -i vf\n[    6.599304] i40e 0000:5e:00.0: Allocating 2 VFs.\n[    6.680111] i40e 0000:5e:00.1: Allocating 2 VFs.\n[    6.730167] iavf: Intel(R) Ethernet Adaptive Virtual Function Network Driver - version 3.2.3-k\n<< snip >>\n[   17.931493] i40e 0000:5e:00.0: Setting MAC b6:4f:02:37:5a:d8 on VF 0\n[   18.111781] i40e 0000:5e:00.0: VF 0 is now trusted\n[   18.112559] i40e 0000:5e:00.0: Setting MAC 26:04:1d:1f:3d:a9 on VF 1\n[   18.291464] i40e 0000:5e:00.0: VF 1 is now trusted\n[   18.292231] i40e 0000:5e:00.1: Setting MAC 76:6c:4e:16:7f:e2 on VF 0\n[   18.475259] i40e 0000:5e:00.1: VF 0 is now trusted\n[   18.475929] i40e 0000:5e:00.1: Setting MAC 6a:f2:bd:97:71:65 on VF 1\n[   18.659465] i40e 0000:5e:00.1: VF 1 is now trusted\n[   18.728124] iavf 0000:5e:02.0 ens1f0v0: NIC Link is Up Speed is 25 Gbps Full Duplex\n[   18.752275] iavf 0000:5e:02.1 ens1f0v1: NIC Link is Up Speed is 25 Gbps Full Duplex\n[   18.776329] iavf 0000:5e:0a.0 ens1f1v0: NIC Link is Up Speed is 25 Gbps Full Duplex\n[   18.800569] iavf 0000:5e:0a.1 ens1f1v1: NIC Link is Up Speed is 25 Gbps Full Duplex\n```\n\n## (4) Check the VFs\n\nYou can check the VFs from lspci or ip link commands.\n\n```shell\nubuntu@ubuntu-kvm:~$ sudo lspci | grep -i Virtual\nubuntu@ubuntu-kvm:~$ sudo ip link show | grep -B2 vf\n```\n\nGood news is that the VFs names are well related to the physical NICs. For example, **ens1f0v1** is one of the VFs of the physical NIC **ens1f0** .\n\n```shell\nubuntu@ubuntu-kvm:~$ ip link show | grep -E ens1f[0,1]v[0,1] -A 1\n9: ens1f0v1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc mq state UP mode DEFAULT group default qlen 1000\n    link/ether 26:04:1d:1f:3d:a9 brd ff:ff:ff:ff:ff:ff\n10: ens1f1v1: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc mq state UP mode DEFAULT group default qlen 1000\n    link/ether 6a:f2:bd:97:71:65 brd ff:ff:ff:ff:ff:ff\n15: ens1f0v0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc mq state UP mode DEFAULT group default qlen 1000\n    link/ether b6:4f:02:37:5a:d8 brd ff:ff:ff:ff:ff:ff\n16: ens1f1v0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc mq state UP mode DEFAULT group default qlen 1000\nlink/ether 76:6c:4e:16:7f:e2 brd ff:ff:ff:ff:ff:ff\n```\n\nWe can change the MTU to **9216** (or you may not need 9216, 1504 is enough).\n\n```shell\nsudo nmcli connection modify ens1f0v0 ethernet.mtu 9216 ipv4.method disabled\nsudo nmcli connection modify ens1f0v1 ethernet.mtu 9216 ipv4.method disabled\nsudo nmcli connection modify ens1f1v0 ethernet.mtu 9216 ipv4.method disabled\nsudo nmcli connection modify ens1f1v1 ethernet.mtu 9216 ipv4.method disabled\nsudo nmcli connection up ens1f0v0 \nsudo nmcli connection up ens1f0v1\nsudo nmcli connection up ens1f1v0\nsudo nmcli connection up ens1f1v1\n```\n\nThe above configs will survive after reboot.\n\n\n\n# Create SR-IOV Virtual Network Adapter Pool\n\nUsing this method, KVM creates a pool of network devices that can be inserted into VMs, and the size of that pool is determined by how many VFs were created on the physical function when they were initialized.\n\n## (1) Create an xml file\n\nubuntu@ubuntu-kvm:~/kvm$ cat ens1f0_sriov_pool.xml\n\n```xml\n<network>\n   <name>ens1f0_sriov_pool</name> <!-- This is the name of the file you created -->\n   <forward mode='hostdev' managed='yes'>\n     <pf dev='ens1f0'/>  <!-- Use the netdev name of your SR-IOV devices PF here -->\n   </forward>\n</network>\n```\n\n## (2) Define a network and set to auto start.\n\n```shell\nvirsh net-define ens1f0_sriov_pool.xml\nSleep 1\nvirsh net-start ens1f0_sriov_pool\nvirsh net-autostart ens1f0_sriov_pool\n```\n\nubuntu@ubuntu-kvm:~/kvm$ virsh net-dumpxml ens1f0_sriov_pool\n\n```xml\n<network connections='1'>\n  <name>ens1f0_sriov_pool</name>\n  <uuid>9125a600-6620-4ab6-9a47-8844a61b0918</uuid>\n  <forward mode='hostdev' managed='yes'>\n    <pf dev='ens1f0'/>\n    <address type='pci' domain='0x0000' bus='0x5e' slot='0x02' function='0x0'/>\n    <address type='pci' domain='0x0000' bus='0x5e' slot='0x02' function='0x1'/>\n  </forward>\n</network>\n```\n\n## (3) Select the virtual adapter from the pool\n\nIt is simple to add an SR-IOV NIC, as follow:\n\n![SRIOV Adapter Pool](csr1kv-kvm-Ubuntu20-04-md/pic1-sriov-pool.png)\n\nThis is equivalent to the following XML:\n\n```xml\n    <interface type='network'>\n      <mac address='52:54:00:0b:a5:2e'/>\n      <source network='ens1f0_sriov_pool'/>\n      <model type='virtio'/>\n      <address type='pci' domain='0x0000' bus='0x02' slot='0x00' function='0x0'/>\n    </interface>\n```\n\nAfter the VM powered on, the network info is as follow:\nvirsh dumpxml CSR1KV-1\n\n```xml\n    <interface type='hostdev' managed='yes'>\n      <mac address='52:54:00:0b:a5:2e'/>\n      <driver name='vfio'/>\n      <source>\n        <address type='pci' domain='0x0000' bus='0x5e' slot='0x02' function='0x0'/>\n      </source>\n      <model type='virtio'/>\n      <alias name='hostdev0'/>\n      <address type='pci' domain='0x0000' bus='0x02' slot='0x00' function='0x0'/>\n    </interface>\n```\n\n# Create the CSR1KV VM from virt-manager\n\nFrom the virt-manager, create a CSR1KV virtual machine step by step, and choose the virtual network interface from the SR-IOV pool.\n\n![Virt-manager step 1](csr1kv-kvm-Ubuntu20-04-md/virt-manager-step1.png)\n\n![Virt-manager Step 2](csr1kv-kvm-Ubuntu20-04-md/virt-manager-step2.png)\n\n![Virt-manager Step2-2](csr1kv-kvm-Ubuntu20-04-md/virt-manager-step2-2.png)\n\n![Virt-manager Step 3](csr1kv-kvm-Ubuntu20-04-md/virt-manager-step3.png)\n\n![Virt-manager Step 4](csr1kv-kvm-Ubuntu20-04-md/virt-manager-step4.png)\n\nNote: The first interface of csr1kv-1 is configured to **macvtap Bridge mode**, so you do not need to create a Linux bridge. However, csr1kv-1 can not communicate to the Linux host through this interface, but it can go out of the Linux host through the eno1. This is a known issue with macvtap.\n\n![Virt-manager Step 5](csr1kv-kvm-Ubuntu20-04-md/add-sriov-pool.png)\n\nAfter select the Virtual Network Interface, click the **Begin Installation**, and you can shut down the virtual machine.\nThe actions above will create the **csr1kv-1.xml** file under the directory: **/etc/libvirtd/qemu/**\n\n# KVM Performance Tunning\n\nKVM performance tuning are related to NUMA, Memory Hugepage and vCPU pinning. The main reference is Redhat Linux 7 PERFORMANCE TUNING GUIDE\n\nWe will use **virsh edit csr1kv-1** to do the performance tuning.\n\n## (1) Check the capability of the platform\n\n```shell\nubuntu@ubuntu-kvm:~$ virsh nodeinfo\nCPU model:           x86_64\nCPU(s):              88\nCPU frequency:       1000 MHz\nCPU socket(s):       1\nCore(s) per socket:  22\nThread(s) per core:  2\nNUMA cell(s):        2\nMemory size:         394929928 KiB\n```\n\n[1]:ubuntu@ubuntu-kvm:~$ virsh capabilities\n\n```xml\n<capabilities>\n\n  <host>\n    <uuid>a24f9760-48f1-f34e-a001-a848f08df7bb</uuid>\n    <cpu>\n      <arch>x86_64</arch>\n      <model>Cascadelake-Server-noTSX</model>\n      <vendor>Intel</vendor>\n      <microcode version='83898371'/>\n      <counter name='tsc' frequency='2095078000' scaling='no'/>\n      <topology sockets='1' cores='22' threads='2'/>\n...\n```\n\nFrom the outputs, we can get the cores of CPU, the NUMA info and the hugepages.\n\n## (2) NUMA Info\n\n```shell\nubuntu@ubuntu-kvm:~$ numactl --hardware\navailable: 2 nodes (0-1)\nnode 0 cpus: 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65\nnode 0 size: 192172 MB\nnode 0 free: 152956 MB\nnode 1 cpus: 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87\nnode 1 size: 193500 MB\nnode 1 free: 158037 MB\nnode distances:\nnode   0   1\n  0:  10  21\n  1:  21  10 \n```\n\nTwo CPUs, each has 192GB memory, the NUMA node are node 0 and node 1.\n\nYou can also check the NUMA info of the NIC, as follow:\n\n```shell\nubuntu@ubuntu-kvm:~$ sudo lspci -vv | grep Ethernet -A 6\n5e:00.0 Ethernet controller: Intel Corporation Ethernet Controller XXV710 for 25GbE SFP28 (rev 02)\n    Subsystem: Cisco Systems Inc Ethernet Network Adapter XXV710\n    Control: I/O- Mem+ BusMaster+ SpecCycle- MemWINV- VGASnoop- ParErr+ Stepping- SERR+ FastB2B- DisINTx+\n    Status: Cap+ 66MHz- UDF- FastB2B- ParErr- DEVSEL=fast >TAbort- <TAbort- <MAbort- >SERR- <PERR- INTx-\n    Latency: 0, Cache Line Size: 32 bytes\n    Interrupt: pin A routed to IRQ 137\n    NUMA node: 0\n\n#Or you can find the numa infor from udevadm.\nubuntu@ubuntu-kvm:~$ sudo udevadm info -ap /sys/class/net/ens1f0 | grep numa\n    ATTRS{numa_node}==\"0\"\n    ATTRS{numa_node}==\"0\"\n```\n\nIf the memory and NICs are all on numa_node 0, that would be more efficient. Please check the server’s PCI-E slots mapping with the CPU slots.\n\n## (3) HugePage and Transparent Hugepage\n\nTo check the memory info\n\n```shell\nubuntu@ubuntu-kvm:~$ cat /proc/meminfo | grep Huge\nAnonHugePages:    133120 kB\nShmemHugePages:        0 kB\nFileHugePages:         0 kB\nHugePages_Total:      64\nHugePages_Free:       56\nHugePages_Rsvd:        0\nHugePages_Surp:        0\nHugepagesize:    1048576 kB\nHugetlb:        67108864 kB\n```\n\nYou can change the hugepages on the run time：\n\n```shell\nubuntu@ubuntu-kvm:~$ cat /sys/devices/system/node/node0/hugepages/hugepages-1048576kB/nr_hugepages\n32\nsudo su -     // switch to root user.\nroot@ubuntu-kvm:~# echo 64 > /sys/devices/system/node/node0/hugepages/hugepages-1048576kB/nr_hugepages\nroot@ubuntu-kvm:~# echo 64 > /sys/devices/system/node/node1/hugepages/hugepages-1048576kB/nr_hugepages\n```\n\nCheck and configure the transparent_hugepage:\n\n```shell\nroot@ubuntu-kvm:~# echo always > /sys/kernel/mm/transparent_hugepage/enabled\ncat /sys/kernel/mm/transparent_hugepage/enabled\n[always] madvise never\n```\n\n## (4) vCPU Pinning\n\nvCPU pinning can improve the cache meet rate and improve the performance.\nYou can check the vcpu pinning.\n**virsh vcpuinfo csr1kv-1**\n\n## (5) Edit the XML file of the CSR1KV\n\nRun virsh edit csr1kv-1 to edit the parameters.\nPlease pay attention to the following texts, other parameters might be different.\n\n```xml\n  <memoryBacking>\n    <hugepages>\n      <page size='1048576' unit='KiB'/>\n    </hugepages>\n    <locked/>\n    <nosharepages/>\n  </memoryBacking>\n  <vcpu placement='static'>8</vcpu>\n  <cputune>\n    <vcpupin vcpu='0' cpuset='1'/>\n    <vcpupin vcpu='1' cpuset='2'/>\n    <vcpupin vcpu='2' cpuset='3'/>\n    <vcpupin vcpu='3' cpuset='4'/>\n    <vcpupin vcpu='4' cpuset='5'/>\n    <vcpupin vcpu='5' cpuset='6'/>\n    <vcpupin vcpu='6' cpuset='7'/>\n    <vcpupin vcpu='7' cpuset='8'/>\n    <emulatorpin cpuset='45-52'/> <!-- If Hyper-threading were enabled -->\n  </cputune>\n  <numatune>\n    <memory mode='strict' nodeset='0'/>\n  </numatune>\n  <cpu mode='host-passthrough' check='none'/>\n    <memballoon model='none'/>\n```\n\nPlease note that, if hyper-threading is enabled in BIOS setting, the parameter “emulatorpin” should be set, the cpuset are from the “virsh capabilities”, for example, siblings='1,45'. When the core 1 is pinned, core 45 should be set in emulatorpin.\n\nFrom the guide <https://libvirt.org/formatdomain.html> and <https://libvirt.org/kbase/kvm-realtime.html> we set the CPU and memory tuning parameters as the highlighted text.\n\n```xml\n<domain type='kvm'>\n  <name>csr1kv-1</name>\n  <uuid>83f90c1c-f0ea-4298-bcdf-3d676de2aeb4</uuid>\n  <metadata>\n    <libosinfo:libosinfo xmlns:libosinfo=\"http://libosinfo.org/xmlns/libvirt/domain/1.0\">\n      <libosinfo:os id=\"http://centos.org/centos/7.0\"/>\n    </libosinfo:libosinfo>\n  </metadata>\n  <memory unit='KiB'>8388608</memory>\n  <currentMemory unit='KiB'>8388608</currentMemory>\n  <memoryBacking>\n    <hugepages>\n      <page size='1048576' unit='KiB'/>\n    </hugepages>\n    <locked/>\n    <nosharepages/>\n  </memoryBacking>\n  <vcpu placement='static'>8</vcpu>\n  <cputune>\n    <vcpupin vcpu='0' cpuset='1'/>\n    <vcpupin vcpu='1' cpuset='2'/>\n    <vcpupin vcpu='2' cpuset='3'/>\n    <vcpupin vcpu='3' cpuset='4'/>\n    <vcpupin vcpu='4' cpuset='5'/>\n    <vcpupin vcpu='5' cpuset='6'/>\n    <vcpupin vcpu='6' cpuset='7'/>\n    <vcpupin vcpu='7' cpuset='8'/>\n    <emulatorpin cpuset='45-52'/> <!-- If Hyper-threading were enabled -->\n  </cputune>\n  <numatune>\n    <memory mode='strict' nodeset='0'/>\n  </numatune>\n  <os>\n    <type arch='x86_64' machine='pc-q35-4.2'>hvm</type>\n    <boot dev='hd'/>\n  </os>\n  <features>\n    <acpi/>\n    <apic/>\n    <vmport state='off'/>\n  </features>\n  <cpu mode='host-passthrough' check='none'/>\n  <clock offset='utc'>\n    <timer name='rtc' tickpolicy='catchup'/>\n    <timer name='pit' tickpolicy='delay'/>\n    <timer name='hpet' present='no'/>\n  </clock>\n  <on_poweroff>destroy</on_poweroff>\n  <on_reboot>restart</on_reboot>\n  <on_crash>destroy</on_crash>\n  <pm>\n    <suspend-to-mem enabled='no'/>\n    <suspend-to-disk enabled='no'/>\n  </pm>\n  <devices>\n    <emulator>/usr/bin/qemu-system-x86_64</emulator>\n    <disk type='file' device='disk'>\n      <driver name='qemu' type='qcow2'/>\n      <source file='/var/lib/libvirt/images/csr1000v-universalk9.17.02.01v.qcow2'/>\n      <target dev='vda' bus='virtio'/>\n      <address type='pci' domain='0x0000' bus='0x05' slot='0x00' function='0x0'/>\n    </disk>\n    <controller type='usb' index='0' model='qemu-xhci' ports='15'>\n      <address type='pci' domain='0x0000' bus='0x03' slot='0x00' function='0x0'/>\n    </controller>\n    <controller type='sata' index='0'>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x1f' function='0x2'/>\n    </controller>\n    <controller type='pci' index='0' model='pcie-root'/>\n    <controller type='pci' index='1' model='pcie-root-port'>\n      <model name='pcie-root-port'/>\n      <target chassis='1' port='0x10'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x02' function='0x0' multifunction='on'/>\n    </controller>\n    <controller type='pci' index='2' model='pcie-root-port'>\n      <model name='pcie-root-port'/>\n      <target chassis='2' port='0x11'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x02' function='0x1'/>\n    </controller>\n    <controller type='pci' index='3' model='pcie-root-port'>\n      <model name='pcie-root-port'/>\n      <target chassis='3' port='0x12'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x02' function='0x2'/>\n    </controller>\n    <controller type='pci' index='4' model='pcie-root-port'>\n      <model name='pcie-root-port'/>\n      <target chassis='4' port='0x13'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x02' function='0x3'/>\n    </controller>\n    <controller type='pci' index='5' model='pcie-root-port'>\n      <model name='pcie-root-port'/>\n      <target chassis='5' port='0x14'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x02' function='0x4'/>\n    </controller>\n    <controller type='pci' index='6' model='pcie-root-port'>\n      <model name='pcie-root-port'/>\n      <target chassis='6' port='0x15'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x02' function='0x5'/>\n    </controller>\n    <controller type='pci' index='7' model='pcie-root-port'>\n      <model name='pcie-root-port'/>\n      <target chassis='7' port='0x16'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x02' function='0x6'/>\n    </controller>\n    <controller type='pci' index='8' model='pcie-root-port'>\n      <model name='pcie-root-port'/>\n      <target chassis='8' port='0x17'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x02' function='0x7'/>\n    </controller>\n    <controller type='virtio-serial' index='0'>\n      <address type='pci' domain='0x0000' bus='0x04' slot='0x00' function='0x0'/>\n    </controller>\n    <interface type='direct'>\n      <mac address='52:54:00:69:ec:73'/>\n      <source dev='eno1' mode='bridge'/>\n      <model type='virtio'/>\n      <address type='pci' domain='0x0000' bus='0x01' slot='0x00' function='0x0'/>\n    </interface>\n    <interface type='network'>\n      <mac address='52:54:00:0b:a5:2e'/>\n      <source network='ens1f0_sriov_pool'/>\n      <model type='virtio'/>\n      <address type='pci' domain='0x0000' bus='0x02' slot='0x00' function='0x0'/>\n    </interface>\n    <interface type='network'>\n      <mac address='52:54:00:bd:9f:54'/>\n      <source network='ens1f1_sriov_pool'/>\n      <model type='virtio'/>\n      <address type='pci' domain='0x0000' bus='0x08' slot='0x00' function='0x0'/>\n    </interface>\n    <serial type='pty'>\n      <target type='isa-serial' port='0'>\n        <model name='isa-serial'/>\n      </target>\n    </serial>\n    <console type='pty'>\n      <target type='serial' port='0'/>\n    </console>\n    <channel type='unix'>\n      <target type='virtio' name='org.qemu.guest_agent.0'/>\n      <address type='virtio-serial' controller='0' bus='0' port='1'/>\n    </channel>\n    <channel type='spicevmc'>\n      <target type='virtio' name='com.redhat.spice.0'/>\n      <address type='virtio-serial' controller='0' bus='0' port='2'/>\n    </channel>\n    <input type='mouse' bus='ps2'/>\n    <input type='keyboard' bus='ps2'/>\n    <graphics type='spice' autoport='yes'>\n      <listen type='address'/>\n      <image compression='off'/>\n    </graphics>\n    <video>\n      <model type='qxl' ram='65536' vram='65536' vgamem='16384' heads='1' primary='yes'/>\n      <address type='pci' domain='0x0000' bus='0x00' slot='0x01' function='0x0'/>\n    </video>\n    <redirdev bus='usb' type='spicevmc'>\n      <address type='usb' bus='0' port='2'/>\n    </redirdev>\n    <redirdev bus='usb' type='spicevmc'>\n      <address type='usb' bus='0' port='3'/>\n    </redirdev>\n    <memballoon model='none'/>\n  </devices>\n</domain>\n```\n\nThe parameters are from [Cisco CSR 1000v and Cisco ISRv Software Configuration Guide](https://www.cisco.com/c/en/us/td/docs/routers/csr1000/software/configuration/b_CSR1000v_Configuration_Guide/b_CSR1000v_Configuration_Guide_chapter_0101.html#con_1313827)\nAfter you install the CSR1000v, and edit the XML file, you can run virsh to create the csr1kv.\n\n```shell\ncd /etc/libvirtd/qemu\nvirsh define csr1kv-1.xml\nvirsh start csr1kv-1\n```\n\n## (6) Check CSR1000v’s tunning\n\nubuntu@ubuntu-kvm:/etc/libvirt/qemu$ virsh list\n\n```shell\n Id   Name       State\n--------------------------\n\n 1    csr1kv-1   running\n\nubuntu@ubuntu-kvm:/etc/libvirt/qemu$ virsh vcpuinfo 1\nVCPU:           0\nCPU:            1\nState:          running\nCPU time:       167.0s\nCPU Affinity:   -y--------------------------------------------------------------------------------------\n\nVCPU:           1\nCPU:            2\nState:          running\nCPU time:       193.3s\nCPU Affinity:   --y-------------------------------------------------------------------------------------\n\nVCPU:           2\nCPU:            3\nState:          running\nCPU time:       152.5s\nCPU Affinity:   ---y------------------------------------------------------------------------------------\n\nVCPU:           3\nCPU:            4\nState:          running\nCPU time:       174.3s\nCPU Affinity:   ----y-----------------------------------------------------------------------------------\n\nVCPU:           4\nCPU:            5\nState:          running\nCPU time:       260.6s\nCPU Affinity:   -----y----------------------------------------------------------------------------------\n\nVCPU:           5\nCPU:            6\nState:          running\nCPU time:       386.0s\nCPU Affinity:   ------y---------------------------------------------------------------------------------\n\nVCPU:           6\nCPU:            7\nState:          running\nCPU time:       2189.9s\nCPU Affinity:   -------y--------------------------------------------------------------------------------\n\nVCPU:           7\nCPU:            8\nState:          running\nCPU time:       2192.2s\nCPU Affinity:   --------y-------------------------------------------------------------------------------\n```\n\n\nFrom the above outputs, we can find that the vCPUa are pinned to NO. 1 to 8 CPU cores.\n\n```shell\nubuntu@ubuntu-kvm:~$ sudo numastat -c qemu\nPer-node process memory usage (in MBs)\nPID              Node 0 Node 1 Total\n\n---------------  ------ ------ -----\n\n4391 (qemu-syste   8373      0  8373\n5891 (sudo)           4      1     5\n\n---------------  ------ ------ -----\n\nTotal              8377      1  8377\n\nubuntu@ubuntu-kvm:~$ sudo numastat -p 4391\nPer-node process memory usage (in MBs) for PID 4391 (qemu-system-x86)\n                           Node 0          Node 1           Total\n                  --------------- --------------- ---------------\nHuge                      8192.00            0.00         8192.00\nHeap                        10.00            0.00           10.00\nStack                        0.03            0.00            0.03\nPrivate                    170.70            0.15          170.85\n\n----------------  --------------- --------------- ---------------\n\nTotal                     8372.73            0.16         8372.88\n```\n\n\nFrom the above outputs, the csr1kv-1 are using the memories from node 0.\n\n## (7) Check the vNIC in CSR1KV\n\n```ios\ncsr1kv-1#show platform software vnic-if interface-mapping\n-------------------------------------------------------------\n\n Interface Name        Driver Name         Mac Addr\n-------------------------------------------------------------\n\n GigabitEthernet3       net_i40e_vf        5254.00bd.9f54\n GigabitEthernet2       net_i40e_vf        5254.000b.a52e\n GigabitEthernet1       net_virtio         5254.0069.ec73\n```\n\nThe Driver Name net_i40e_vf indicates that the vNIC is a VF from the SR-IOV pool.\n\n# CSR 1000v initial configuration and Smart License registration\n\n## (1) CSR 1000v initial config example\n\nPart of the configuration:\n\n```\nCSR1000v-1#show sdwan running-config\nsystem\n system-ip             1.1.10.1\n site-id               101\n sp-organization-name  CiscoBJ\n organization-name     CiscoBJ\n vbond 10.75.58.51 port 12346\n!\nhostname CSR1000v-1\nusername admin privilege 15 secret 9 $9$4/QL2V2K4/6H1k$XUmRNf.T7t3KDOj/FmoNexpEypCxr482dExXHDnohSI\nip name-server 64.104.123.245\nip route 0.0.0.0 0.0.0.0 10.75.59.1\n\ninterface GigabitEthernet1\n no shutdown\n arp timeout 1200\n ip address 10.75.59.35 255.255.255.0\n no ip redirects\n ip mtu    1500\n mtu 1500\n negotiation auto\nexit\n\ninterface Tunnel1\n no shutdown\n ip unnumbered GigabitEthernet1\n no ip redirects\n ipv6 unnumbered GigabitEthernet1\n no ipv6 redirects\n tunnel source GigabitEthernet1\n tunnel mode sdwan\nexit\n\nclock timezone CST 8 0\nntp server x.x.x.x version 4\n\nsdwan\n interface GigabitEthernet1\n  tunnel-interface\n   encapsulation ipsec\n   allow-service sshd\n  exit\n```\n\n## (2) Commands to check the status\n\n```\nshow sdwan control local-properties\nshow sdwan control connections\nshow sdwan control connection-history\nshow sdwan running-config\nshow sdwan bfd sessions\nshow sdwan omp peers\nshow sdwan omp routes\n```\n\n## (3) CSR 1000v Smart License Registration\n\nBefore Smart License registration, you need ：\n1. CSR 1000v’s control connections are up；\n2. Configure ip http client source-interface GigabitEthernet2\n3. If the version is 16.12.x and bellow, you need to allow service all\n   `sdwan interface GigabitEthernet2 tunnel-interface allow-service all `\n   In the 17.2.x and above versions, there is an allow-service https\n4. CSR 1000v can access URL：https://tools.cisco.com/its/service/oddce/services/DDCEService\n   The command license smart register idtoken xxxxxx will do the registration.\n   You can find the idtoken from your Smart Account smart license inventory.\n   show license status to check the status.\n\n\n```\nCSR1000v-1#show platform hardware throughput level\nThe current throughput level is 200000000 kb/s\n```\n\n# Performances and limitations\n\n## (1) The performance of the SR-IOV\n\nA performance test was done after the SR-IOV setup, the CSR1KV was configured as 8vCPU and 8G Memory, the packet drop rate was 0%.\n\n| Packet Site | SDWAN Performance (Mbps) | CEF Performance (Mbps) |\n| ----------- | ------------------------ | ---------------------- |\n| 128Bytes    | 800                      | 2843.75                |\n| 256Bytes    | 1431.26                  | 6500.00                |\n| 512Bytes    | 2581.26                  | 10578.13               |\n| 1024Bytes   | 3731.26                  | 15500.00               |\n| 1400Bytes   | 4306.26                  | 18171.88               |\n\n![Performance Line Chart](csr1kv-kvm-Ubuntu20-04-md/line-chart.png)\n\nNote: **These test results are not to represent the official performance data. Different servers and network cards may have different test results. The above data is for demo only.**\n\n## (2) The limitation of the SR-IOV\n\nThe main limitation of the SR-IOV is the number of VLANs on each VF, the maximum VLAN of an VF is limited to 63 in ixgbevf.\nSo, the active number of sub-interfaces on an interface of the CSR1KV that uses the SRIOV VFs is limited to 63.\nThere is some notes in the Cisco CSR 1000v and Cisco ISRv Software Configuration Guide:\n\n> SR-IOV (ixgbevf)\n> Maximum VLANs: The maximum number of VLANs supported on PF is 64. Together, all VFs can have a total of 64 VLANs. (Intel limitation.)\n>\n> SR-IOV (i40evf)\n> Maximum VLANs: The maximum number of VLANs supported on PF is 512. Together, all VFs can have a total of 512 VLANs. (Intel limitation.) Per-VF resources are managed by the PF (host) device driver.\n\n# References\n\n<https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html-single/performance_tuning_guide/index>\n\n<https://computingforgeeks.com/how-to-create-and-configure-bridge-networking-for-kvm-in-linux/>\n\n<https://software.intel.com/content/www/us/en/develop/articles/configure-sr-iov-network-virtual-functions-in-linux-kvm.html>\n\n<https://linuxconfig.org/install-and-set-up-kvm-on-ubuntu-20-04-focal-fossa-linux>\n\n<https://kifarunix.com/how-to-fix-qemu-kvm-not-connected-error-on-ubuntu-20-04/>\n\n<https://linuxconfig.org/how-to-disable-apparmor-on-ubuntu-20-04-focal-fossa-linux>\n\n**CSR1000v SD-WAN Installation on KVM** by Jean-Marc Barozet\n\n\n\n# Scripts and XML Example Files\n\n1. [Ubuntu and KVM installation and setting](https://raw.githubusercontent.com/weiborao/CSR1KV-Installation-on-KVM-with-SRIOV/main/kvm/1.2-install-ubuntu-kvm.sh)\n2. [NIC Settings with nmcli](https://github.com/weiborao/CSR1KV-Installation-on-KVM-with-SRIOV/raw/main/kvm/1.3-nic-settings.sh)\n3. [Check NIC SRIOV Capabilities](https://github.com/weiborao/CSR1KV-Installation-on-KVM-with-SRIOV/raw/main/kvm/2.1-check-nic-sriov.sh)\n4. [GRUB Settings](https://github.com/weiborao/CSR1KV-Installation-on-KVM-with-SRIOV/raw/main/kvm/2.2-change-grub.sh)\n5. [SRIOV Settings](https://github.com/weiborao/CSR1KV-Installation-on-KVM-with-SRIOV/raw/main/kvm/2.3-sriov-setting.sh)\n6. [Check VFs](https://github.com/weiborao/CSR1KV-Installation-on-KVM-with-SRIOV/raw/main/kvm/2.4-check-vfs.sh)\n7. [Create SRIOV Adapter Pool](https://github.com/weiborao/CSR1KV-Installation-on-KVM-with-SRIOV/raw/main/kvm/3.0-create-sriov-pool.sh)\n8. [KVM Tuning](https://github.com/weiborao/CSR1KV-Installation-on-KVM-with-SRIOV/raw/main/kvm/4.0-kvm-tuning.sh)\n9. [Check CSR1000v Tuning](https://github.com/weiborao/CSR1KV-Installation-on-KVM-with-SRIOV/raw/main/kvm/4.1-check-csr1kv.sh)\n10. [ens1f0_sriov_pool.xml](https://github.com/weiborao/CSR1KV-Installation-on-KVM-with-SRIOV/raw/main/kvm/ens1f0_sriov_pool.xml)\n11. [csr1kv-1.xml](https://github.com/weiborao/CSR1KV-Installation-on-KVM-with-SRIOV/raw/main/kvm/csr1kv-1.xml)","slug":"csr1kv-kvm-Ubuntu20-04-md","published":1,"updated":"2025-12-14T09:50:07.444Z","comments":1,"layout":"post","photos":[],"_id":"cuidlMGQmhJ6srse824OJbYiq","content":"<p>Last Update: February 3, 2021</p>\n<p>Author: Rao Weibo</p>\n<p>Version: 1.0</p>\n<p>This guide provides the steps on how to install CSR1000v&#x2F;Catalyst 8000v on KVM, the setting of SRIOV and KVM tuning.</p>\n<h1 id=\"Ubuntu-20-04-Installation-and-Settings\"><a href=\"#Ubuntu-20-04-Installation-and-Settings\" class=\"headerlink\" title=\"Ubuntu 20.04 Installation and Settings\"></a>Ubuntu 20.04 Installation and Settings</h1><h2 id=\"1-BIOS-settings\"><a href=\"#1-BIOS-settings\" class=\"headerlink\" title=\"(1) BIOS settings\"></a>(1) BIOS settings</h2><table>\n<thead>\n<tr>\n<th>Configuration</th>\n<th>Recommended Setting</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Intel Hyper-Threading  Technology</td>\n<td>Disabled</td>\n</tr>\n<tr>\n<td>Number of Enable Cores</td>\n<td>ALL</td>\n</tr>\n<tr>\n<td>Execute Disable</td>\n<td>Enabled</td>\n</tr>\n<tr>\n<td><strong>Intel VT</strong></td>\n<td><strong>Enabled</strong></td>\n</tr>\n<tr>\n<td><strong>Intel VT-D</strong></td>\n<td><strong>Enabled</strong></td>\n</tr>\n<tr>\n<td>Intel VT-D coherency support</td>\n<td>Enabled</td>\n</tr>\n<tr>\n<td>Intel VT-D ATS support</td>\n<td>Enabled</td>\n</tr>\n<tr>\n<td>CPU Performance</td>\n<td>High throughput</td>\n</tr>\n<tr>\n<td>Hardware Perfetcher</td>\n<td>Disabled</td>\n</tr>\n<tr>\n<td>Adjacent Cache Line Prefetcher</td>\n<td>Disabled</td>\n</tr>\n<tr>\n<td>DCU Streamer Prefetch</td>\n<td>Disable</td>\n</tr>\n<tr>\n<td>Power Technology</td>\n<td>Custom</td>\n</tr>\n<tr>\n<td>Enhanced Intel Speedstep  Technology</td>\n<td>Disabled</td>\n</tr>\n<tr>\n<td>Intel Turbo Boost Technology</td>\n<td>Enabled</td>\n</tr>\n<tr>\n<td>Processor Power State C6</td>\n<td>Disabled</td>\n</tr>\n<tr>\n<td>Processor Power State C1 Enhanced</td>\n<td>Disabled</td>\n</tr>\n<tr>\n<td>Frequency Poor Override</td>\n<td>Enabled</td>\n</tr>\n<tr>\n<td>P-State Coordination</td>\n<td>HW_ALL</td>\n</tr>\n<tr>\n<td>Energy Performance</td>\n<td>Performance</td>\n</tr>\n</tbody></table>\n<p>The above settings are from the Installation guide from <a href=\"https://www.cisco.com/c/en/us/td/docs/routers/csr1000/software/configuration/b_CSR1000v_Configuration_Guide/b_CSR1000v_Configuration_Guide_chapter_0101.html#con_1313827\">Cisco CSR 1000v and Cisco ISRv Software Configuration Guide</a>.<br>Note: some platform such as <strong>Cisco NFVIS</strong>, does not disable the Hyper-Threading.</p>\n<h2 id=\"2-Ubuntu-20-04-installation-tips\"><a href=\"#2-Ubuntu-20-04-installation-tips\" class=\"headerlink\" title=\"(2) Ubuntu 20.04 installation tips\"></a>(2) Ubuntu 20.04 installation tips</h2><p>If you need the Gnome GUI, you can install the Ubuntu 20.04 Desktop.<br>After the system bootup, <strong>‘apparmor’</strong> is recommended to be disabled, otherwise, you may meet <strong>permission denied</strong> when you assign SRIOV devices to the CSR1kV. You need to reboot to take effect.</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo systemctl disable apparmor</span><br><span class=\"line\">egrep -o &#x27;(vmx|svm)&#x27; /proc/cpuinfo | sort | uniq</span><br></pre></td></tr></table></figure>\n<p>You can find the <strong>vmx</strong> on Intel platform, or <strong>svm</strong> on AMD platform.</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo systemctl stop ufw</span><br><span class=\"line\">systemctl disable ufw</span><br></pre></td></tr></table></figure>\n\n<p><code>cat /etc/sysctl.conf</code></p>\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">net.ipv4.ip_forward = 1</span><br><span class=\"line\">net.bridge.bridge-nf-call-ip6tables = 0</span><br><span class=\"line\">net.bridge.bridge-nf-call-iptables = 0</span><br><span class=\"line\">net.bridge.bridge-nf-call-arptables = 0</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">$ </span><span class=\"language-bash\"><span class=\"built_in\">sudo</span> apt install qemu-kvm libvirt-clients libvirt-daemon-system bridge-utils virt-manager numactl virt-top</span></span><br></pre></td></tr></table></figure>\n<p>After installation, you can check the version</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ubuntu@ubuntu-kvm:~$ libvirtd -V</span><br><span class=\"line\">libvirtd (libvirt) 6.0.0</span><br><span class=\"line\">ubuntu@ubuntu-kvm:~$ qemu-system-x86_64 --version</span><br><span class=\"line\">QEMU emulator version 4.2.1 (Debian 1:4.2-3ubuntu6.11)</span><br><span class=\"line\">Copyright (c) 2003-2019 Fabrice Bellard and the QEMU Project developers</span><br><span class=\"line\">ubuntu@ubuntu-kvm:~$ virt-manager --version</span><br><span class=\"line\">2.2.1</span><br><span class=\"line\">ubuntu@ubuntu-kvm:~$ modinfo kvm-intel</span><br><span class=\"line\">filename:       /lib/modules/5.4.0-62-generic/kernel/arch/x86/kvm/kvm-intel.ko</span><br><span class=\"line\">ubuntu@ubuntu-kvm:~$ modinfo i40evf</span><br><span class=\"line\">filename:       /lib/modules/5.4.0-62-generic/kernel/drivers/net/ethernet/intel/iavf/iavf.ko</span><br><span class=\"line\">version:        3.2.3-k</span><br></pre></td></tr></table></figure>\n<h2 id=\"3-NIC-Setting\"><a href=\"#3-NIC-Setting\" class=\"headerlink\" title=\"(3) NIC Setting\"></a>(3) NIC Setting</h2><p>In Ubuntu 20.04, we use NetworkManager to config the NIC, you can use nmtui on the terminal, or nmcli.<br>First, check the netplan.</p>\n<p><code>cat /etc/netplan/ 00-installer-config.yaml</code></p>\n<p>Edit the yaml file:</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Let NetworkManager manage all devices on this system</span></span><br><span class=\"line\"><span class=\"attr\">network:</span></span><br><span class=\"line\">  <span class=\"attr\">version:</span> <span class=\"number\">2</span></span><br><span class=\"line\">  <span class=\"attr\">renderer:</span> <span class=\"string\">NetworkManager</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo netplan apply</span><br></pre></td></tr></table></figure>\n<p>Then you can set the network config with nmcli or nmtui.</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ubuntu@ubuntu-kvm:~$ sudo nmcli connection modify netplan-eno1 ipv4.method manual ipv4.addresses 10.75.59.50/24 ipv4.gateway 10.75.59.1 ipv4.dns 64.104.123.245</span><br><span class=\"line\">ubuntu@ubuntu-kvm:~$ sudo nmcli connection modify netplan-eno1 connection.id eno1</span><br><span class=\"line\">ubuntu@ubuntu-kvm:~$ sudo nmcli connection up eno1</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">Change the connections name to the devices name.</span></span><br><span class=\"line\"></span><br><span class=\"line\">sudo nmcli connection</span><br><span class=\"line\">ubuntu@ubuntu-kvm:~$ sudo nmcli connection</span><br><span class=\"line\">NAME        UUID                                  TYPE      DEVICE</span><br><span class=\"line\">eno1        10838d80-caeb-349e-ba73-08ed16d4d666  ethernet  eno1</span><br><span class=\"line\">enp216s0f0  6556c191-c253-3a5e-b440-c5b071ec29a4  ethernet  enp216s0f0</span><br><span class=\"line\">enp216s0f1  8080672c-5784-375f-8eb9-a6ef57cbd4f7  ethernet  enp216s0f1</span><br><span class=\"line\">ens1f0      58fb5b1f-c10a-3e7a-9ab9-a8c449840ce6  ethernet  ens1f0</span><br><span class=\"line\">ens1f1      2a06a9d9-b761-3bdf-aa0b-3d44fff2158f  ethernet  ens1f1</span><br><span class=\"line\">virbr0      ca7d1e11-a82f-429c-9d91-fc985776232c  bridge    virbr0</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">Set the MTU and <span class=\"built_in\">disable</span> ipv4 <span class=\"keyword\">for</span> the NIC to <span class=\"built_in\">enable</span> SRIOV.</span> </span><br><span class=\"line\"></span><br><span class=\"line\">sudo nmcli connection modify ens1f0 ethernet.mtu 9216</span><br><span class=\"line\">sudo nmcli connection modify ens1f0 ipv4.method disabled</span><br><span class=\"line\">sudo nmcli connection up ens1f0</span><br><span class=\"line\">sudo ip link show ens1f0</span><br><span class=\"line\">2: ens1f0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 9216 qdisc mq state UP mode DEFAULT group default qlen 1000</span><br><span class=\"line\">link/ether 40:a6:b7:0f:a7:74 brd ff:ff:ff:ff:ff:ff</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">Note: This value 9216 of MTU is derived from Cisco NFVIS.</span></span><br><span class=\"line\"><span class=\"meta prompt_\">CSP5228-1# </span><span class=\"language-bash\">show pnic-detail mtu</span></span><br><span class=\"line\">Name          MTU</span><br><span class=\"line\">=============================</span><br><span class=\"line\">eth0-1        9216</span><br><span class=\"line\">eth0-2        9216</span><br><span class=\"line\">eth1-1        9216</span><br><span class=\"line\">eth1-2        9216</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"SR-IOV-Configuration\"><a href=\"#SR-IOV-Configuration\" class=\"headerlink\" title=\"SR-IOV Configuration\"></a>SR-IOV Configuration</h1><h2 id=\"1-Check-the-NIC-to-support-SR-IOV\"><a href=\"#1-Check-the-NIC-to-support-SR-IOV\" class=\"headerlink\" title=\"(1) Check the NIC to support SR-IOV\"></a>(1) Check the NIC to support SR-IOV</h2><p>Check the NIC hardware infor.</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo lshw -c network -businfo</span><br><span class=\"line\"></span><br><span class=\"line\">Bus info          Device      Class          Description</span><br><span class=\"line\">========================================================</span><br><span class=\"line\"></span><br><span class=\"line\">pci@0000:3b:00.0  eno1        network        Ethernet Controller 10G X550T</span><br><span class=\"line\">pci@0000:3b:00.1  eno2        network        Ethernet Controller 10G X550T</span><br><span class=\"line\">pci@0000:5e:00.0  ens1f0      network        Ethernet Controller XXV710 for 25GbE SFP28</span><br><span class=\"line\">pci@0000:5e:00.1  ens1f1      network        Ethernet Controller XXV710 for 25GbE SFP28</span><br><span class=\"line\">pci@0000:d8:00.0  enp216s0f0  network        Ethernet Controller XXV710 for 25GbE SFP28</span><br><span class=\"line\">pci@0000:d8:00.1  enp216s0f1  network        Ethernet Controller XXV710 for 25GbE SFP28</span><br></pre></td></tr></table></figure>\n\n<p>Check the capabilities of NIC</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo lspci -vv -s 5e:00.0 | grep -A 5 -i SR-IOV</span><br><span class=\"line\">    Capabilities: [160 v1] Single Root I/O Virtualization (SR-IOV)</span><br><span class=\"line\">        IOVCap: Migration-, Interrupt Message Number: 000</span><br><span class=\"line\">        IOVCtl: Enable+ Migration- Interrupt- MSE+ ARIHierarchy+</span><br><span class=\"line\">        IOVSta: Migration-</span><br><span class=\"line\">        Initial VFs: 64, Total VFs: 64, Number of VFs: 2, Function Dependency Link: 00</span><br><span class=\"line\">        VF offset: 16, stride: 1, Device ID: 154c</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"2-Change-the-GRUB-parameters\"><a href=\"#2-Change-the-GRUB-parameters\" class=\"headerlink\" title=\"(2) Change the GRUB parameters\"></a>(2) Change the GRUB parameters</h2><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo vi /etc/default/grub </span><br><span class=\"line\">GRUB_CMDLINE_LINUX_DEFAULT=&quot;quiet hugepagesz=1G hugepages=64 default_hugepagesz=1G intel_iommu=on iommu=pt isolcpus=1-8,45-52&quot;</span><br></pre></td></tr></table></figure>\n\n<p><strong>Note：The hugepages should be no more than the physical memory, otherwise, it will fail to bootup.</strong></p>\n<ul>\n<li><strong>default_hugepagesz&#x3D;1G hugepagesz&#x3D;1G hugepages&#x3D;64</strong> will allocate 64 1GB huge pages at boot, which are <strong>static huge pages</strong>. CSR 1000v will use these static huge pages for best performance.</li>\n<li><strong>isolcpus&#x3D;1-8,45-52</strong> will isolate the CPUs cores reserved for CSR 1000v, prevent other processes running on these cores, this can reduce latency for CSR 1000v. You can refer to   [Check the capability of the platform][1]  to get the CPU information.</li>\n</ul>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo update-grub</span><br></pre></td></tr></table></figure>\n\n<p>After reboot, check the &#x2F;proc&#x2F;cmdline.</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat /proc/cmdline |grep intel_iommu=on</span><br><span class=\"line\">dmesg |grep -e DMAR -e IOMMU</span><br><span class=\"line\">dmesg | grep -e DMAR -e IOMMU -e AMD-Vi</span><br><span class=\"line\">ubuntu@ubuntu-kvm:~$ cat /proc/cmdline |grep intel_iommu=on</span><br><span class=\"line\">BOOT_IMAGE=/vmlinuz-5.4.0-62-generic root=/dev/mapper/ubuntu--vg-ubuntu--lv ro quiet hugepagesz=1G hugepages=64 default_hugepagesz=1G intel_iommu=on iommu=pt isolcpus=1-8,45-52</span><br><span class=\"line\"></span><br><span class=\"line\">ubuntu@ubuntu-kvm:~ $ dmesg |grep -e DMAR -e IOMMU</span><br><span class=\"line\">[    0.020313] ACPI: DMAR 0x000000005DA8EB80 000270 (v01 Cisco0 CiscoUCS 00000001 INTL 20091013)</span><br><span class=\"line\">[    1.954441] DMAR: IOMMU enabled</span><br></pre></td></tr></table></figure>\n\n<p>Check the CPU info, all the CPU cores and isolated CPU cores.</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ubuntu@ubuntu-kvm:~$ cat /sys/devices/system/cpu/isolated</span><br><span class=\"line\">1-8,45-52</span><br><span class=\"line\">ubuntu@ubuntu-kvm:~$ cat /sys/devices/system/cpu/present</span><br><span class=\"line\">0-87</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"3-VFs-Persistence\"><a href=\"#3-VFs-Persistence\" class=\"headerlink\" title=\"(3) VFs Persistence\"></a>(3) VFs Persistence</h2><p><strong>NetworkManager way:</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">nmcli can <span class=\"built_in\">set</span> the SRIOV, as follow:</span></span><br><span class=\"line\">sudo nmcli connection modify ens1f0 sriov.total-vfs 2</span><br><span class=\"line\">sudo nmcli connection modify ens1f1 sriov.total-vfs 2</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">We can <span class=\"built_in\">set</span> the MAC address and <span class=\"built_in\">set</span> the trust on:</span></span><br><span class=\"line\">sudo nmcli connection modify ens1f0 sriov.vfs &#x27;0 mac=b6:4f:02:37:5a:d8 trust=true, 1 mac=26:04:1d:1f:3d:a9 trust=true&#x27;</span><br><span class=\"line\">sudo nmcli connection modify ens1f1 sriov.vfs &#x27;0 mac=76:6c:4e:16:7f:e2 trust=true, 1 mac=6a:f2:bd:97:71:65 trust=true&#x27;</span><br><span class=\"line\">sudo nmcli connection up ens1f0</span><br><span class=\"line\">sudo nmcli connection up ens1f1</span><br></pre></td></tr></table></figure>\n\n<p>After reboot, check the dmesg.</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo dmesg | grep -i vf</span><br><span class=\"line\">[    6.599304] i40e 0000:5e:00.0: Allocating 2 VFs.</span><br><span class=\"line\">[    6.680111] i40e 0000:5e:00.1: Allocating 2 VFs.</span><br><span class=\"line\">[    6.730167] iavf: Intel(R) Ethernet Adaptive Virtual Function Network Driver - version 3.2.3-k</span><br><span class=\"line\">&lt;&lt; snip &gt;&gt;</span><br><span class=\"line\">[   17.931493] i40e 0000:5e:00.0: Setting MAC b6:4f:02:37:5a:d8 on VF 0</span><br><span class=\"line\">[   18.111781] i40e 0000:5e:00.0: VF 0 is now trusted</span><br><span class=\"line\">[   18.112559] i40e 0000:5e:00.0: Setting MAC 26:04:1d:1f:3d:a9 on VF 1</span><br><span class=\"line\">[   18.291464] i40e 0000:5e:00.0: VF 1 is now trusted</span><br><span class=\"line\">[   18.292231] i40e 0000:5e:00.1: Setting MAC 76:6c:4e:16:7f:e2 on VF 0</span><br><span class=\"line\">[   18.475259] i40e 0000:5e:00.1: VF 0 is now trusted</span><br><span class=\"line\">[   18.475929] i40e 0000:5e:00.1: Setting MAC 6a:f2:bd:97:71:65 on VF 1</span><br><span class=\"line\">[   18.659465] i40e 0000:5e:00.1: VF 1 is now trusted</span><br><span class=\"line\">[   18.728124] iavf 0000:5e:02.0 ens1f0v0: NIC Link is Up Speed is 25 Gbps Full Duplex</span><br><span class=\"line\">[   18.752275] iavf 0000:5e:02.1 ens1f0v1: NIC Link is Up Speed is 25 Gbps Full Duplex</span><br><span class=\"line\">[   18.776329] iavf 0000:5e:0a.0 ens1f1v0: NIC Link is Up Speed is 25 Gbps Full Duplex</span><br><span class=\"line\">[   18.800569] iavf 0000:5e:0a.1 ens1f1v1: NIC Link is Up Speed is 25 Gbps Full Duplex</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"4-Check-the-VFs\"><a href=\"#4-Check-the-VFs\" class=\"headerlink\" title=\"(4) Check the VFs\"></a>(4) Check the VFs</h2><p>You can check the VFs from lspci or ip link commands.</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ubuntu@ubuntu-kvm:~$ sudo lspci | grep -i Virtual</span><br><span class=\"line\">ubuntu@ubuntu-kvm:~$ sudo ip link show | grep -B2 vf</span><br></pre></td></tr></table></figure>\n\n<p>Good news is that the VFs names are well related to the physical NICs. For example, <strong>ens1f0v1</strong> is one of the VFs of the physical NIC <strong>ens1f0</strong> .</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ubuntu@ubuntu-kvm:~$ ip link show | grep -E ens1f[0,1]v[0,1] -A 1</span><br><span class=\"line\">9: ens1f0v1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP mode DEFAULT group default qlen 1000</span><br><span class=\"line\">    link/ether 26:04:1d:1f:3d:a9 brd ff:ff:ff:ff:ff:ff</span><br><span class=\"line\">10: ens1f1v1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP mode DEFAULT group default qlen 1000</span><br><span class=\"line\">    link/ether 6a:f2:bd:97:71:65 brd ff:ff:ff:ff:ff:ff</span><br><span class=\"line\">15: ens1f0v0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP mode DEFAULT group default qlen 1000</span><br><span class=\"line\">    link/ether b6:4f:02:37:5a:d8 brd ff:ff:ff:ff:ff:ff</span><br><span class=\"line\">16: ens1f1v0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP mode DEFAULT group default qlen 1000</span><br><span class=\"line\">link/ether 76:6c:4e:16:7f:e2 brd ff:ff:ff:ff:ff:ff</span><br></pre></td></tr></table></figure>\n\n<p>We can change the MTU to <strong>9216</strong> (or you may not need 9216, 1504 is enough).</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo nmcli connection modify ens1f0v0 ethernet.mtu 9216 ipv4.method disabled</span><br><span class=\"line\">sudo nmcli connection modify ens1f0v1 ethernet.mtu 9216 ipv4.method disabled</span><br><span class=\"line\">sudo nmcli connection modify ens1f1v0 ethernet.mtu 9216 ipv4.method disabled</span><br><span class=\"line\">sudo nmcli connection modify ens1f1v1 ethernet.mtu 9216 ipv4.method disabled</span><br><span class=\"line\">sudo nmcli connection up ens1f0v0 </span><br><span class=\"line\">sudo nmcli connection up ens1f0v1</span><br><span class=\"line\">sudo nmcli connection up ens1f1v0</span><br><span class=\"line\">sudo nmcli connection up ens1f1v1</span><br></pre></td></tr></table></figure>\n\n<p>The above configs will survive after reboot.</p>\n<h1 id=\"Create-SR-IOV-Virtual-Network-Adapter-Pool\"><a href=\"#Create-SR-IOV-Virtual-Network-Adapter-Pool\" class=\"headerlink\" title=\"Create SR-IOV Virtual Network Adapter Pool\"></a>Create SR-IOV Virtual Network Adapter Pool</h1><p>Using this method, KVM creates a pool of network devices that can be inserted into VMs, and the size of that pool is determined by how many VFs were created on the physical function when they were initialized.</p>\n<h2 id=\"1-Create-an-xml-file\"><a href=\"#1-Create-an-xml-file\" class=\"headerlink\" title=\"(1) Create an xml file\"></a>(1) Create an xml file</h2><p>ubuntu@ubuntu-kvm:~&#x2F;kvm$ cat ens1f0_sriov_pool.xml</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">network</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">name</span>&gt;</span>ens1f0_sriov_pool<span class=\"tag\">&lt;/<span class=\"name\">name</span>&gt;</span> <span class=\"comment\">&lt;!-- This is the name of the file you created --&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">forward</span> <span class=\"attr\">mode</span>=<span class=\"string\">&#x27;hostdev&#x27;</span> <span class=\"attr\">managed</span>=<span class=\"string\">&#x27;yes&#x27;</span>&gt;</span></span><br><span class=\"line\">     <span class=\"tag\">&lt;<span class=\"name\">pf</span> <span class=\"attr\">dev</span>=<span class=\"string\">&#x27;ens1f0&#x27;</span>/&gt;</span>  <span class=\"comment\">&lt;!-- Use the netdev name of your SR-IOV devices PF here --&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;/<span class=\"name\">forward</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">network</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"2-Define-a-network-and-set-to-auto-start\"><a href=\"#2-Define-a-network-and-set-to-auto-start\" class=\"headerlink\" title=\"(2) Define a network and set to auto start.\"></a>(2) Define a network and set to auto start.</h2><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">virsh net-define ens1f0_sriov_pool.xml</span><br><span class=\"line\">Sleep 1</span><br><span class=\"line\">virsh net-start ens1f0_sriov_pool</span><br><span class=\"line\">virsh net-autostart ens1f0_sriov_pool</span><br></pre></td></tr></table></figure>\n\n<p>ubuntu@ubuntu-kvm:~&#x2F;kvm$ virsh net-dumpxml ens1f0_sriov_pool</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">network</span> <span class=\"attr\">connections</span>=<span class=\"string\">&#x27;1&#x27;</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">name</span>&gt;</span>ens1f0_sriov_pool<span class=\"tag\">&lt;/<span class=\"name\">name</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">uuid</span>&gt;</span>9125a600-6620-4ab6-9a47-8844a61b0918<span class=\"tag\">&lt;/<span class=\"name\">uuid</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">forward</span> <span class=\"attr\">mode</span>=<span class=\"string\">&#x27;hostdev&#x27;</span> <span class=\"attr\">managed</span>=<span class=\"string\">&#x27;yes&#x27;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">pf</span> <span class=\"attr\">dev</span>=<span class=\"string\">&#x27;ens1f0&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">domain</span>=<span class=\"string\">&#x27;0x0000&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0x5e&#x27;</span> <span class=\"attr\">slot</span>=<span class=\"string\">&#x27;0x02&#x27;</span> <span class=\"attr\">function</span>=<span class=\"string\">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">domain</span>=<span class=\"string\">&#x27;0x0000&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0x5e&#x27;</span> <span class=\"attr\">slot</span>=<span class=\"string\">&#x27;0x02&#x27;</span> <span class=\"attr\">function</span>=<span class=\"string\">&#x27;0x1&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">forward</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">network</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"3-Select-the-virtual-adapter-from-the-pool\"><a href=\"#3-Select-the-virtual-adapter-from-the-pool\" class=\"headerlink\" title=\"(3) Select the virtual adapter from the pool\"></a>(3) Select the virtual adapter from the pool</h2><p>It is simple to add an SR-IOV NIC, as follow:</p>\n<p><img src=\"/csr1kv-kvm-Ubuntu20-04-md/pic1-sriov-pool.png\" alt=\"SRIOV Adapter Pool\"></p>\n<p>This is equivalent to the following XML:</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">interface</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;network&#x27;</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">mac</span> <span class=\"attr\">address</span>=<span class=\"string\">&#x27;52:54:00:0b:a5:2e&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">source</span> <span class=\"attr\">network</span>=<span class=\"string\">&#x27;ens1f0_sriov_pool&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">model</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;virtio&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">domain</span>=<span class=\"string\">&#x27;0x0000&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0x02&#x27;</span> <span class=\"attr\">slot</span>=<span class=\"string\">&#x27;0x00&#x27;</span> <span class=\"attr\">function</span>=<span class=\"string\">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">interface</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>After the VM powered on, the network info is as follow:<br>virsh dumpxml CSR1KV-1</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">interface</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;hostdev&#x27;</span> <span class=\"attr\">managed</span>=<span class=\"string\">&#x27;yes&#x27;</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">mac</span> <span class=\"attr\">address</span>=<span class=\"string\">&#x27;52:54:00:0b:a5:2e&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">driver</span> <span class=\"attr\">name</span>=<span class=\"string\">&#x27;vfio&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">source</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">domain</span>=<span class=\"string\">&#x27;0x0000&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0x5e&#x27;</span> <span class=\"attr\">slot</span>=<span class=\"string\">&#x27;0x02&#x27;</span> <span class=\"attr\">function</span>=<span class=\"string\">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">source</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">model</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;virtio&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">alias</span> <span class=\"attr\">name</span>=<span class=\"string\">&#x27;hostdev0&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">domain</span>=<span class=\"string\">&#x27;0x0000&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0x02&#x27;</span> <span class=\"attr\">slot</span>=<span class=\"string\">&#x27;0x00&#x27;</span> <span class=\"attr\">function</span>=<span class=\"string\">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">interface</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"Create-the-CSR1KV-VM-from-virt-manager\"><a href=\"#Create-the-CSR1KV-VM-from-virt-manager\" class=\"headerlink\" title=\"Create the CSR1KV VM from virt-manager\"></a>Create the CSR1KV VM from virt-manager</h1><p>From the virt-manager, create a CSR1KV virtual machine step by step, and choose the virtual network interface from the SR-IOV pool.</p>\n<p><img src=\"/csr1kv-kvm-Ubuntu20-04-md/virt-manager-step1.png\" alt=\"Virt-manager step 1\"></p>\n<p><img src=\"/csr1kv-kvm-Ubuntu20-04-md/virt-manager-step2.png\" alt=\"Virt-manager Step 2\"></p>\n<p><img src=\"/csr1kv-kvm-Ubuntu20-04-md/virt-manager-step2-2.png\" alt=\"Virt-manager Step2-2\"></p>\n<p><img src=\"/csr1kv-kvm-Ubuntu20-04-md/virt-manager-step3.png\" alt=\"Virt-manager Step 3\"></p>\n<p><img src=\"/csr1kv-kvm-Ubuntu20-04-md/virt-manager-step4.png\" alt=\"Virt-manager Step 4\"></p>\n<p>Note: The first interface of csr1kv-1 is configured to <strong>macvtap Bridge mode</strong>, so you do not need to create a Linux bridge. However, csr1kv-1 can not communicate to the Linux host through this interface, but it can go out of the Linux host through the eno1. This is a known issue with macvtap.</p>\n<p><img src=\"/csr1kv-kvm-Ubuntu20-04-md/add-sriov-pool.png\" alt=\"Virt-manager Step 5\"></p>\n<p>After select the Virtual Network Interface, click the <strong>Begin Installation</strong>, and you can shut down the virtual machine.<br>The actions above will create the <strong>csr1kv-1.xml</strong> file under the directory: <strong>&#x2F;etc&#x2F;libvirtd&#x2F;qemu&#x2F;</strong></p>\n<h1 id=\"KVM-Performance-Tunning\"><a href=\"#KVM-Performance-Tunning\" class=\"headerlink\" title=\"KVM Performance Tunning\"></a>KVM Performance Tunning</h1><p>KVM performance tuning are related to NUMA, Memory Hugepage and vCPU pinning. The main reference is Redhat Linux 7 PERFORMANCE TUNING GUIDE</p>\n<p>We will use <strong>virsh edit csr1kv-1</strong> to do the performance tuning.</p>\n<h2 id=\"1-Check-the-capability-of-the-platform\"><a href=\"#1-Check-the-capability-of-the-platform\" class=\"headerlink\" title=\"(1) Check the capability of the platform\"></a>(1) Check the capability of the platform</h2><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ubuntu@ubuntu-kvm:~$ virsh nodeinfo</span><br><span class=\"line\">CPU model:           x86_64</span><br><span class=\"line\">CPU(s):              88</span><br><span class=\"line\">CPU frequency:       1000 MHz</span><br><span class=\"line\">CPU socket(s):       1</span><br><span class=\"line\">Core(s) per socket:  22</span><br><span class=\"line\">Thread(s) per core:  2</span><br><span class=\"line\">NUMA cell(s):        2</span><br><span class=\"line\">Memory size:         394929928 KiB</span><br></pre></td></tr></table></figure>\n\n<p>[1]:ubuntu@ubuntu-kvm:~$ virsh capabilities</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">capabilities</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">host</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">uuid</span>&gt;</span>a24f9760-48f1-f34e-a001-a848f08df7bb<span class=\"tag\">&lt;/<span class=\"name\">uuid</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">cpu</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">arch</span>&gt;</span>x86_64<span class=\"tag\">&lt;/<span class=\"name\">arch</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">model</span>&gt;</span>Cascadelake-Server-noTSX<span class=\"tag\">&lt;/<span class=\"name\">model</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">vendor</span>&gt;</span>Intel<span class=\"tag\">&lt;/<span class=\"name\">vendor</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">microcode</span> <span class=\"attr\">version</span>=<span class=\"string\">&#x27;83898371&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">counter</span> <span class=\"attr\">name</span>=<span class=\"string\">&#x27;tsc&#x27;</span> <span class=\"attr\">frequency</span>=<span class=\"string\">&#x27;2095078000&#x27;</span> <span class=\"attr\">scaling</span>=<span class=\"string\">&#x27;no&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">topology</span> <span class=\"attr\">sockets</span>=<span class=\"string\">&#x27;1&#x27;</span> <span class=\"attr\">cores</span>=<span class=\"string\">&#x27;22&#x27;</span> <span class=\"attr\">threads</span>=<span class=\"string\">&#x27;2&#x27;</span>/&gt;</span></span><br><span class=\"line\">...</span><br></pre></td></tr></table></figure>\n\n<p>From the outputs, we can get the cores of CPU, the NUMA info and the hugepages.</p>\n<h2 id=\"2-NUMA-Info\"><a href=\"#2-NUMA-Info\" class=\"headerlink\" title=\"(2) NUMA Info\"></a>(2) NUMA Info</h2><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ubuntu@ubuntu-kvm:~$ numactl --hardware</span><br><span class=\"line\">available: 2 nodes (0-1)</span><br><span class=\"line\">node 0 cpus: 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65</span><br><span class=\"line\">node 0 size: 192172 MB</span><br><span class=\"line\">node 0 free: 152956 MB</span><br><span class=\"line\">node 1 cpus: 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87</span><br><span class=\"line\">node 1 size: 193500 MB</span><br><span class=\"line\">node 1 free: 158037 MB</span><br><span class=\"line\">node distances:</span><br><span class=\"line\">node   0   1</span><br><span class=\"line\">  0:  10  21</span><br><span class=\"line\">  1:  21  10 </span><br></pre></td></tr></table></figure>\n\n<p>Two CPUs, each has 192GB memory, the NUMA node are node 0 and node 1.</p>\n<p>You can also check the NUMA info of the NIC, as follow:</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ubuntu@ubuntu-kvm:~$ sudo lspci -vv | grep Ethernet -A 6</span><br><span class=\"line\">5e:00.0 Ethernet controller: Intel Corporation Ethernet Controller XXV710 for 25GbE SFP28 (rev 02)</span><br><span class=\"line\">    Subsystem: Cisco Systems Inc Ethernet Network Adapter XXV710</span><br><span class=\"line\">    Control: I/O- Mem+ BusMaster+ SpecCycle- MemWINV- VGASnoop- ParErr+ Stepping- SERR+ FastB2B- DisINTx+</span><br><span class=\"line\">    Status: Cap+ 66MHz- UDF- FastB2B- ParErr- DEVSEL=fast &gt;TAbort- &lt;TAbort- &lt;MAbort- &gt;SERR- &lt;PERR- INTx-</span><br><span class=\"line\">    Latency: 0, Cache Line Size: 32 bytes</span><br><span class=\"line\">    Interrupt: pin A routed to IRQ 137</span><br><span class=\"line\">    NUMA node: 0</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">Or you can find the numa infor from udevadm.</span></span><br><span class=\"line\">ubuntu@ubuntu-kvm:~$ sudo udevadm info -ap /sys/class/net/ens1f0 | grep numa</span><br><span class=\"line\">    ATTRS&#123;numa_node&#125;==&quot;0&quot;</span><br><span class=\"line\">    ATTRS&#123;numa_node&#125;==&quot;0&quot;</span><br></pre></td></tr></table></figure>\n\n<p>If the memory and NICs are all on numa_node 0, that would be more efficient. Please check the server’s PCI-E slots mapping with the CPU slots.</p>\n<h2 id=\"3-HugePage-and-Transparent-Hugepage\"><a href=\"#3-HugePage-and-Transparent-Hugepage\" class=\"headerlink\" title=\"(3) HugePage and Transparent Hugepage\"></a>(3) HugePage and Transparent Hugepage</h2><p>To check the memory info</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ubuntu@ubuntu-kvm:~$ cat /proc/meminfo | grep Huge</span><br><span class=\"line\">AnonHugePages:    133120 kB</span><br><span class=\"line\">ShmemHugePages:        0 kB</span><br><span class=\"line\">FileHugePages:         0 kB</span><br><span class=\"line\">HugePages_Total:      64</span><br><span class=\"line\">HugePages_Free:       56</span><br><span class=\"line\">HugePages_Rsvd:        0</span><br><span class=\"line\">HugePages_Surp:        0</span><br><span class=\"line\">Hugepagesize:    1048576 kB</span><br><span class=\"line\">Hugetlb:        67108864 kB</span><br></pre></td></tr></table></figure>\n\n<p>You can change the hugepages on the run time：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ubuntu@ubuntu-kvm:~$ cat /sys/devices/system/node/node0/hugepages/hugepages-1048576kB/nr_hugepages</span><br><span class=\"line\">32</span><br><span class=\"line\">sudo su -     // switch to root user.</span><br><span class=\"line\">root@ubuntu-kvm:~# echo 64 &gt; /sys/devices/system/node/node0/hugepages/hugepages-1048576kB/nr_hugepages</span><br><span class=\"line\">root@ubuntu-kvm:~# echo 64 &gt; /sys/devices/system/node/node1/hugepages/hugepages-1048576kB/nr_hugepages</span><br></pre></td></tr></table></figure>\n\n<p>Check and configure the transparent_hugepage:</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@ubuntu-kvm:~# echo always &gt; /sys/kernel/mm/transparent_hugepage/enabled</span><br><span class=\"line\">cat /sys/kernel/mm/transparent_hugepage/enabled</span><br><span class=\"line\">[always] madvise never</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"4-vCPU-Pinning\"><a href=\"#4-vCPU-Pinning\" class=\"headerlink\" title=\"(4) vCPU Pinning\"></a>(4) vCPU Pinning</h2><p>vCPU pinning can improve the cache meet rate and improve the performance.<br>You can check the vcpu pinning.<br><strong>virsh vcpuinfo csr1kv-1</strong></p>\n<h2 id=\"5-Edit-the-XML-file-of-the-CSR1KV\"><a href=\"#5-Edit-the-XML-file-of-the-CSR1KV\" class=\"headerlink\" title=\"(5) Edit the XML file of the CSR1KV\"></a>(5) Edit the XML file of the CSR1KV</h2><p>Run virsh edit csr1kv-1 to edit the parameters.<br>Please pay attention to the following texts, other parameters might be different.</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">memoryBacking</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">hugepages</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">page</span> <span class=\"attr\">size</span>=<span class=\"string\">&#x27;1048576&#x27;</span> <span class=\"attr\">unit</span>=<span class=\"string\">&#x27;KiB&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">hugepages</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">locked</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">nosharepages</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">memoryBacking</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">vcpu</span> <span class=\"attr\">placement</span>=<span class=\"string\">&#x27;static&#x27;</span>&gt;</span>8<span class=\"tag\">&lt;/<span class=\"name\">vcpu</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">cputune</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">vcpupin</span> <span class=\"attr\">vcpu</span>=<span class=\"string\">&#x27;0&#x27;</span> <span class=\"attr\">cpuset</span>=<span class=\"string\">&#x27;1&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">vcpupin</span> <span class=\"attr\">vcpu</span>=<span class=\"string\">&#x27;1&#x27;</span> <span class=\"attr\">cpuset</span>=<span class=\"string\">&#x27;2&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">vcpupin</span> <span class=\"attr\">vcpu</span>=<span class=\"string\">&#x27;2&#x27;</span> <span class=\"attr\">cpuset</span>=<span class=\"string\">&#x27;3&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">vcpupin</span> <span class=\"attr\">vcpu</span>=<span class=\"string\">&#x27;3&#x27;</span> <span class=\"attr\">cpuset</span>=<span class=\"string\">&#x27;4&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">vcpupin</span> <span class=\"attr\">vcpu</span>=<span class=\"string\">&#x27;4&#x27;</span> <span class=\"attr\">cpuset</span>=<span class=\"string\">&#x27;5&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">vcpupin</span> <span class=\"attr\">vcpu</span>=<span class=\"string\">&#x27;5&#x27;</span> <span class=\"attr\">cpuset</span>=<span class=\"string\">&#x27;6&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">vcpupin</span> <span class=\"attr\">vcpu</span>=<span class=\"string\">&#x27;6&#x27;</span> <span class=\"attr\">cpuset</span>=<span class=\"string\">&#x27;7&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">vcpupin</span> <span class=\"attr\">vcpu</span>=<span class=\"string\">&#x27;7&#x27;</span> <span class=\"attr\">cpuset</span>=<span class=\"string\">&#x27;8&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">emulatorpin</span> <span class=\"attr\">cpuset</span>=<span class=\"string\">&#x27;45-52&#x27;</span>/&gt;</span> <span class=\"comment\">&lt;!-- If Hyper-threading were enabled --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">cputune</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">numatune</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">memory</span> <span class=\"attr\">mode</span>=<span class=\"string\">&#x27;strict&#x27;</span> <span class=\"attr\">nodeset</span>=<span class=\"string\">&#x27;0&#x27;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">numatune</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">cpu</span> <span class=\"attr\">mode</span>=<span class=\"string\">&#x27;host-passthrough&#x27;</span> <span class=\"attr\">check</span>=<span class=\"string\">&#x27;none&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">memballoon</span> <span class=\"attr\">model</span>=<span class=\"string\">&#x27;none&#x27;</span>/&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>Please note that, if hyper-threading is enabled in BIOS setting, the parameter “emulatorpin” should be set, the cpuset are from the “virsh capabilities”, for example, siblings&#x3D;’1,45’. When the core 1 is pinned, core 45 should be set in emulatorpin.</p>\n<p>From the guide <a href=\"https://libvirt.org/formatdomain.html\">https://libvirt.org/formatdomain.html</a> and <a href=\"https://libvirt.org/kbase/kvm-realtime.html\">https://libvirt.org/kbase/kvm-realtime.html</a> we set the CPU and memory tuning parameters as the highlighted text.</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">domain</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;kvm&#x27;</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">name</span>&gt;</span>csr1kv-1<span class=\"tag\">&lt;/<span class=\"name\">name</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">uuid</span>&gt;</span>83f90c1c-f0ea-4298-bcdf-3d676de2aeb4<span class=\"tag\">&lt;/<span class=\"name\">uuid</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">metadata</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">libosinfo:libosinfo</span> <span class=\"attr\">xmlns:libosinfo</span>=<span class=\"string\">&quot;http://libosinfo.org/xmlns/libvirt/domain/1.0&quot;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">libosinfo:os</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;http://centos.org/centos/7.0&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">libosinfo:libosinfo</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">metadata</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">memory</span> <span class=\"attr\">unit</span>=<span class=\"string\">&#x27;KiB&#x27;</span>&gt;</span>8388608<span class=\"tag\">&lt;/<span class=\"name\">memory</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">currentMemory</span> <span class=\"attr\">unit</span>=<span class=\"string\">&#x27;KiB&#x27;</span>&gt;</span>8388608<span class=\"tag\">&lt;/<span class=\"name\">currentMemory</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">memoryBacking</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">hugepages</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">page</span> <span class=\"attr\">size</span>=<span class=\"string\">&#x27;1048576&#x27;</span> <span class=\"attr\">unit</span>=<span class=\"string\">&#x27;KiB&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">hugepages</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">locked</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">nosharepages</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">memoryBacking</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">vcpu</span> <span class=\"attr\">placement</span>=<span class=\"string\">&#x27;static&#x27;</span>&gt;</span>8<span class=\"tag\">&lt;/<span class=\"name\">vcpu</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">cputune</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">vcpupin</span> <span class=\"attr\">vcpu</span>=<span class=\"string\">&#x27;0&#x27;</span> <span class=\"attr\">cpuset</span>=<span class=\"string\">&#x27;1&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">vcpupin</span> <span class=\"attr\">vcpu</span>=<span class=\"string\">&#x27;1&#x27;</span> <span class=\"attr\">cpuset</span>=<span class=\"string\">&#x27;2&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">vcpupin</span> <span class=\"attr\">vcpu</span>=<span class=\"string\">&#x27;2&#x27;</span> <span class=\"attr\">cpuset</span>=<span class=\"string\">&#x27;3&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">vcpupin</span> <span class=\"attr\">vcpu</span>=<span class=\"string\">&#x27;3&#x27;</span> <span class=\"attr\">cpuset</span>=<span class=\"string\">&#x27;4&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">vcpupin</span> <span class=\"attr\">vcpu</span>=<span class=\"string\">&#x27;4&#x27;</span> <span class=\"attr\">cpuset</span>=<span class=\"string\">&#x27;5&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">vcpupin</span> <span class=\"attr\">vcpu</span>=<span class=\"string\">&#x27;5&#x27;</span> <span class=\"attr\">cpuset</span>=<span class=\"string\">&#x27;6&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">vcpupin</span> <span class=\"attr\">vcpu</span>=<span class=\"string\">&#x27;6&#x27;</span> <span class=\"attr\">cpuset</span>=<span class=\"string\">&#x27;7&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">vcpupin</span> <span class=\"attr\">vcpu</span>=<span class=\"string\">&#x27;7&#x27;</span> <span class=\"attr\">cpuset</span>=<span class=\"string\">&#x27;8&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">emulatorpin</span> <span class=\"attr\">cpuset</span>=<span class=\"string\">&#x27;45-52&#x27;</span>/&gt;</span> <span class=\"comment\">&lt;!-- If Hyper-threading were enabled --&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">cputune</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">numatune</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">memory</span> <span class=\"attr\">mode</span>=<span class=\"string\">&#x27;strict&#x27;</span> <span class=\"attr\">nodeset</span>=<span class=\"string\">&#x27;0&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">numatune</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">os</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">type</span> <span class=\"attr\">arch</span>=<span class=\"string\">&#x27;x86_64&#x27;</span> <span class=\"attr\">machine</span>=<span class=\"string\">&#x27;pc-q35-4.2&#x27;</span>&gt;</span>hvm<span class=\"tag\">&lt;/<span class=\"name\">type</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">boot</span> <span class=\"attr\">dev</span>=<span class=\"string\">&#x27;hd&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">os</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">features</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">acpi</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">apic</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">vmport</span> <span class=\"attr\">state</span>=<span class=\"string\">&#x27;off&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">features</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">cpu</span> <span class=\"attr\">mode</span>=<span class=\"string\">&#x27;host-passthrough&#x27;</span> <span class=\"attr\">check</span>=<span class=\"string\">&#x27;none&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">clock</span> <span class=\"attr\">offset</span>=<span class=\"string\">&#x27;utc&#x27;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">timer</span> <span class=\"attr\">name</span>=<span class=\"string\">&#x27;rtc&#x27;</span> <span class=\"attr\">tickpolicy</span>=<span class=\"string\">&#x27;catchup&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">timer</span> <span class=\"attr\">name</span>=<span class=\"string\">&#x27;pit&#x27;</span> <span class=\"attr\">tickpolicy</span>=<span class=\"string\">&#x27;delay&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">timer</span> <span class=\"attr\">name</span>=<span class=\"string\">&#x27;hpet&#x27;</span> <span class=\"attr\">present</span>=<span class=\"string\">&#x27;no&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">clock</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">on_poweroff</span>&gt;</span>destroy<span class=\"tag\">&lt;/<span class=\"name\">on_poweroff</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">on_reboot</span>&gt;</span>restart<span class=\"tag\">&lt;/<span class=\"name\">on_reboot</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">on_crash</span>&gt;</span>destroy<span class=\"tag\">&lt;/<span class=\"name\">on_crash</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">pm</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">suspend-to-mem</span> <span class=\"attr\">enabled</span>=<span class=\"string\">&#x27;no&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">suspend-to-disk</span> <span class=\"attr\">enabled</span>=<span class=\"string\">&#x27;no&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">pm</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">devices</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">emulator</span>&gt;</span>/usr/bin/qemu-system-x86_64<span class=\"tag\">&lt;/<span class=\"name\">emulator</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">disk</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;file&#x27;</span> <span class=\"attr\">device</span>=<span class=\"string\">&#x27;disk&#x27;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">driver</span> <span class=\"attr\">name</span>=<span class=\"string\">&#x27;qemu&#x27;</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;qcow2&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">source</span> <span class=\"attr\">file</span>=<span class=\"string\">&#x27;/var/lib/libvirt/images/csr1000v-universalk9.17.02.01v.qcow2&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">target</span> <span class=\"attr\">dev</span>=<span class=\"string\">&#x27;vda&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;virtio&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">domain</span>=<span class=\"string\">&#x27;0x0000&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0x05&#x27;</span> <span class=\"attr\">slot</span>=<span class=\"string\">&#x27;0x00&#x27;</span> <span class=\"attr\">function</span>=<span class=\"string\">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">disk</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">controller</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;usb&#x27;</span> <span class=\"attr\">index</span>=<span class=\"string\">&#x27;0&#x27;</span> <span class=\"attr\">model</span>=<span class=\"string\">&#x27;qemu-xhci&#x27;</span> <span class=\"attr\">ports</span>=<span class=\"string\">&#x27;15&#x27;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">domain</span>=<span class=\"string\">&#x27;0x0000&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0x03&#x27;</span> <span class=\"attr\">slot</span>=<span class=\"string\">&#x27;0x00&#x27;</span> <span class=\"attr\">function</span>=<span class=\"string\">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">controller</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">controller</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;sata&#x27;</span> <span class=\"attr\">index</span>=<span class=\"string\">&#x27;0&#x27;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">domain</span>=<span class=\"string\">&#x27;0x0000&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0x00&#x27;</span> <span class=\"attr\">slot</span>=<span class=\"string\">&#x27;0x1f&#x27;</span> <span class=\"attr\">function</span>=<span class=\"string\">&#x27;0x2&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">controller</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">controller</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">index</span>=<span class=\"string\">&#x27;0&#x27;</span> <span class=\"attr\">model</span>=<span class=\"string\">&#x27;pcie-root&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">controller</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">index</span>=<span class=\"string\">&#x27;1&#x27;</span> <span class=\"attr\">model</span>=<span class=\"string\">&#x27;pcie-root-port&#x27;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">model</span> <span class=\"attr\">name</span>=<span class=\"string\">&#x27;pcie-root-port&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">target</span> <span class=\"attr\">chassis</span>=<span class=\"string\">&#x27;1&#x27;</span> <span class=\"attr\">port</span>=<span class=\"string\">&#x27;0x10&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">domain</span>=<span class=\"string\">&#x27;0x0000&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0x00&#x27;</span> <span class=\"attr\">slot</span>=<span class=\"string\">&#x27;0x02&#x27;</span> <span class=\"attr\">function</span>=<span class=\"string\">&#x27;0x0&#x27;</span> <span class=\"attr\">multifunction</span>=<span class=\"string\">&#x27;on&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">controller</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">controller</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">index</span>=<span class=\"string\">&#x27;2&#x27;</span> <span class=\"attr\">model</span>=<span class=\"string\">&#x27;pcie-root-port&#x27;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">model</span> <span class=\"attr\">name</span>=<span class=\"string\">&#x27;pcie-root-port&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">target</span> <span class=\"attr\">chassis</span>=<span class=\"string\">&#x27;2&#x27;</span> <span class=\"attr\">port</span>=<span class=\"string\">&#x27;0x11&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">domain</span>=<span class=\"string\">&#x27;0x0000&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0x00&#x27;</span> <span class=\"attr\">slot</span>=<span class=\"string\">&#x27;0x02&#x27;</span> <span class=\"attr\">function</span>=<span class=\"string\">&#x27;0x1&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">controller</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">controller</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">index</span>=<span class=\"string\">&#x27;3&#x27;</span> <span class=\"attr\">model</span>=<span class=\"string\">&#x27;pcie-root-port&#x27;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">model</span> <span class=\"attr\">name</span>=<span class=\"string\">&#x27;pcie-root-port&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">target</span> <span class=\"attr\">chassis</span>=<span class=\"string\">&#x27;3&#x27;</span> <span class=\"attr\">port</span>=<span class=\"string\">&#x27;0x12&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">domain</span>=<span class=\"string\">&#x27;0x0000&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0x00&#x27;</span> <span class=\"attr\">slot</span>=<span class=\"string\">&#x27;0x02&#x27;</span> <span class=\"attr\">function</span>=<span class=\"string\">&#x27;0x2&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">controller</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">controller</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">index</span>=<span class=\"string\">&#x27;4&#x27;</span> <span class=\"attr\">model</span>=<span class=\"string\">&#x27;pcie-root-port&#x27;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">model</span> <span class=\"attr\">name</span>=<span class=\"string\">&#x27;pcie-root-port&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">target</span> <span class=\"attr\">chassis</span>=<span class=\"string\">&#x27;4&#x27;</span> <span class=\"attr\">port</span>=<span class=\"string\">&#x27;0x13&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">domain</span>=<span class=\"string\">&#x27;0x0000&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0x00&#x27;</span> <span class=\"attr\">slot</span>=<span class=\"string\">&#x27;0x02&#x27;</span> <span class=\"attr\">function</span>=<span class=\"string\">&#x27;0x3&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">controller</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">controller</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">index</span>=<span class=\"string\">&#x27;5&#x27;</span> <span class=\"attr\">model</span>=<span class=\"string\">&#x27;pcie-root-port&#x27;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">model</span> <span class=\"attr\">name</span>=<span class=\"string\">&#x27;pcie-root-port&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">target</span> <span class=\"attr\">chassis</span>=<span class=\"string\">&#x27;5&#x27;</span> <span class=\"attr\">port</span>=<span class=\"string\">&#x27;0x14&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">domain</span>=<span class=\"string\">&#x27;0x0000&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0x00&#x27;</span> <span class=\"attr\">slot</span>=<span class=\"string\">&#x27;0x02&#x27;</span> <span class=\"attr\">function</span>=<span class=\"string\">&#x27;0x4&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">controller</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">controller</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">index</span>=<span class=\"string\">&#x27;6&#x27;</span> <span class=\"attr\">model</span>=<span class=\"string\">&#x27;pcie-root-port&#x27;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">model</span> <span class=\"attr\">name</span>=<span class=\"string\">&#x27;pcie-root-port&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">target</span> <span class=\"attr\">chassis</span>=<span class=\"string\">&#x27;6&#x27;</span> <span class=\"attr\">port</span>=<span class=\"string\">&#x27;0x15&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">domain</span>=<span class=\"string\">&#x27;0x0000&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0x00&#x27;</span> <span class=\"attr\">slot</span>=<span class=\"string\">&#x27;0x02&#x27;</span> <span class=\"attr\">function</span>=<span class=\"string\">&#x27;0x5&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">controller</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">controller</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">index</span>=<span class=\"string\">&#x27;7&#x27;</span> <span class=\"attr\">model</span>=<span class=\"string\">&#x27;pcie-root-port&#x27;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">model</span> <span class=\"attr\">name</span>=<span class=\"string\">&#x27;pcie-root-port&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">target</span> <span class=\"attr\">chassis</span>=<span class=\"string\">&#x27;7&#x27;</span> <span class=\"attr\">port</span>=<span class=\"string\">&#x27;0x16&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">domain</span>=<span class=\"string\">&#x27;0x0000&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0x00&#x27;</span> <span class=\"attr\">slot</span>=<span class=\"string\">&#x27;0x02&#x27;</span> <span class=\"attr\">function</span>=<span class=\"string\">&#x27;0x6&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">controller</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">controller</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">index</span>=<span class=\"string\">&#x27;8&#x27;</span> <span class=\"attr\">model</span>=<span class=\"string\">&#x27;pcie-root-port&#x27;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">model</span> <span class=\"attr\">name</span>=<span class=\"string\">&#x27;pcie-root-port&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">target</span> <span class=\"attr\">chassis</span>=<span class=\"string\">&#x27;8&#x27;</span> <span class=\"attr\">port</span>=<span class=\"string\">&#x27;0x17&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">domain</span>=<span class=\"string\">&#x27;0x0000&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0x00&#x27;</span> <span class=\"attr\">slot</span>=<span class=\"string\">&#x27;0x02&#x27;</span> <span class=\"attr\">function</span>=<span class=\"string\">&#x27;0x7&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">controller</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">controller</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;virtio-serial&#x27;</span> <span class=\"attr\">index</span>=<span class=\"string\">&#x27;0&#x27;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">domain</span>=<span class=\"string\">&#x27;0x0000&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0x04&#x27;</span> <span class=\"attr\">slot</span>=<span class=\"string\">&#x27;0x00&#x27;</span> <span class=\"attr\">function</span>=<span class=\"string\">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">controller</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">interface</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;direct&#x27;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">mac</span> <span class=\"attr\">address</span>=<span class=\"string\">&#x27;52:54:00:69:ec:73&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">source</span> <span class=\"attr\">dev</span>=<span class=\"string\">&#x27;eno1&#x27;</span> <span class=\"attr\">mode</span>=<span class=\"string\">&#x27;bridge&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">model</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;virtio&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">domain</span>=<span class=\"string\">&#x27;0x0000&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0x01&#x27;</span> <span class=\"attr\">slot</span>=<span class=\"string\">&#x27;0x00&#x27;</span> <span class=\"attr\">function</span>=<span class=\"string\">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">interface</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">interface</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;network&#x27;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">mac</span> <span class=\"attr\">address</span>=<span class=\"string\">&#x27;52:54:00:0b:a5:2e&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">source</span> <span class=\"attr\">network</span>=<span class=\"string\">&#x27;ens1f0_sriov_pool&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">model</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;virtio&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">domain</span>=<span class=\"string\">&#x27;0x0000&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0x02&#x27;</span> <span class=\"attr\">slot</span>=<span class=\"string\">&#x27;0x00&#x27;</span> <span class=\"attr\">function</span>=<span class=\"string\">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">interface</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">interface</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;network&#x27;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">mac</span> <span class=\"attr\">address</span>=<span class=\"string\">&#x27;52:54:00:bd:9f:54&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">source</span> <span class=\"attr\">network</span>=<span class=\"string\">&#x27;ens1f1_sriov_pool&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">model</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;virtio&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">domain</span>=<span class=\"string\">&#x27;0x0000&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0x08&#x27;</span> <span class=\"attr\">slot</span>=<span class=\"string\">&#x27;0x00&#x27;</span> <span class=\"attr\">function</span>=<span class=\"string\">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">interface</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">serial</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pty&#x27;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">target</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;isa-serial&#x27;</span> <span class=\"attr\">port</span>=<span class=\"string\">&#x27;0&#x27;</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">model</span> <span class=\"attr\">name</span>=<span class=\"string\">&#x27;isa-serial&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;/<span class=\"name\">target</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">serial</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">console</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pty&#x27;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">target</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;serial&#x27;</span> <span class=\"attr\">port</span>=<span class=\"string\">&#x27;0&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">console</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">channel</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;unix&#x27;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">target</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;virtio&#x27;</span> <span class=\"attr\">name</span>=<span class=\"string\">&#x27;org.qemu.guest_agent.0&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;virtio-serial&#x27;</span> <span class=\"attr\">controller</span>=<span class=\"string\">&#x27;0&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0&#x27;</span> <span class=\"attr\">port</span>=<span class=\"string\">&#x27;1&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">channel</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">channel</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;spicevmc&#x27;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">target</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;virtio&#x27;</span> <span class=\"attr\">name</span>=<span class=\"string\">&#x27;com.redhat.spice.0&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;virtio-serial&#x27;</span> <span class=\"attr\">controller</span>=<span class=\"string\">&#x27;0&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0&#x27;</span> <span class=\"attr\">port</span>=<span class=\"string\">&#x27;2&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">channel</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;mouse&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;ps2&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;keyboard&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;ps2&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">graphics</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;spice&#x27;</span> <span class=\"attr\">autoport</span>=<span class=\"string\">&#x27;yes&#x27;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">listen</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;address&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">image</span> <span class=\"attr\">compression</span>=<span class=\"string\">&#x27;off&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">graphics</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">video</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">model</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;qxl&#x27;</span> <span class=\"attr\">ram</span>=<span class=\"string\">&#x27;65536&#x27;</span> <span class=\"attr\">vram</span>=<span class=\"string\">&#x27;65536&#x27;</span> <span class=\"attr\">vgamem</span>=<span class=\"string\">&#x27;16384&#x27;</span> <span class=\"attr\">heads</span>=<span class=\"string\">&#x27;1&#x27;</span> <span class=\"attr\">primary</span>=<span class=\"string\">&#x27;yes&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">domain</span>=<span class=\"string\">&#x27;0x0000&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0x00&#x27;</span> <span class=\"attr\">slot</span>=<span class=\"string\">&#x27;0x01&#x27;</span> <span class=\"attr\">function</span>=<span class=\"string\">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">video</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">redirdev</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;usb&#x27;</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;spicevmc&#x27;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;usb&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0&#x27;</span> <span class=\"attr\">port</span>=<span class=\"string\">&#x27;2&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">redirdev</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">redirdev</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;usb&#x27;</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;spicevmc&#x27;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;usb&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0&#x27;</span> <span class=\"attr\">port</span>=<span class=\"string\">&#x27;3&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">redirdev</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">memballoon</span> <span class=\"attr\">model</span>=<span class=\"string\">&#x27;none&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">devices</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">domain</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>The parameters are from <a href=\"https://www.cisco.com/c/en/us/td/docs/routers/csr1000/software/configuration/b_CSR1000v_Configuration_Guide/b_CSR1000v_Configuration_Guide_chapter_0101.html#con_1313827\">Cisco CSR 1000v and Cisco ISRv Software Configuration Guide</a><br>After you install the CSR1000v, and edit the XML file, you can run virsh to create the csr1kv.</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cd /etc/libvirtd/qemu</span><br><span class=\"line\">virsh define csr1kv-1.xml</span><br><span class=\"line\">virsh start csr1kv-1</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"6-Check-CSR1000v’s-tunning\"><a href=\"#6-Check-CSR1000v’s-tunning\" class=\"headerlink\" title=\"(6) Check CSR1000v’s tunning\"></a>(6) Check CSR1000v’s tunning</h2><p>ubuntu@ubuntu-kvm:&#x2F;etc&#x2F;libvirt&#x2F;qemu$ virsh list</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> Id   Name       State</span><br><span class=\"line\">--------------------------</span><br><span class=\"line\"></span><br><span class=\"line\"> 1    csr1kv-1   running</span><br><span class=\"line\"></span><br><span class=\"line\">ubuntu@ubuntu-kvm:/etc/libvirt/qemu$ virsh vcpuinfo 1</span><br><span class=\"line\">VCPU:           0</span><br><span class=\"line\">CPU:            1</span><br><span class=\"line\">State:          running</span><br><span class=\"line\">CPU time:       167.0s</span><br><span class=\"line\">CPU Affinity:   -y--------------------------------------------------------------------------------------</span><br><span class=\"line\"></span><br><span class=\"line\">VCPU:           1</span><br><span class=\"line\">CPU:            2</span><br><span class=\"line\">State:          running</span><br><span class=\"line\">CPU time:       193.3s</span><br><span class=\"line\">CPU Affinity:   --y-------------------------------------------------------------------------------------</span><br><span class=\"line\"></span><br><span class=\"line\">VCPU:           2</span><br><span class=\"line\">CPU:            3</span><br><span class=\"line\">State:          running</span><br><span class=\"line\">CPU time:       152.5s</span><br><span class=\"line\">CPU Affinity:   ---y------------------------------------------------------------------------------------</span><br><span class=\"line\"></span><br><span class=\"line\">VCPU:           3</span><br><span class=\"line\">CPU:            4</span><br><span class=\"line\">State:          running</span><br><span class=\"line\">CPU time:       174.3s</span><br><span class=\"line\">CPU Affinity:   ----y-----------------------------------------------------------------------------------</span><br><span class=\"line\"></span><br><span class=\"line\">VCPU:           4</span><br><span class=\"line\">CPU:            5</span><br><span class=\"line\">State:          running</span><br><span class=\"line\">CPU time:       260.6s</span><br><span class=\"line\">CPU Affinity:   -----y----------------------------------------------------------------------------------</span><br><span class=\"line\"></span><br><span class=\"line\">VCPU:           5</span><br><span class=\"line\">CPU:            6</span><br><span class=\"line\">State:          running</span><br><span class=\"line\">CPU time:       386.0s</span><br><span class=\"line\">CPU Affinity:   ------y---------------------------------------------------------------------------------</span><br><span class=\"line\"></span><br><span class=\"line\">VCPU:           6</span><br><span class=\"line\">CPU:            7</span><br><span class=\"line\">State:          running</span><br><span class=\"line\">CPU time:       2189.9s</span><br><span class=\"line\">CPU Affinity:   -------y--------------------------------------------------------------------------------</span><br><span class=\"line\"></span><br><span class=\"line\">VCPU:           7</span><br><span class=\"line\">CPU:            8</span><br><span class=\"line\">State:          running</span><br><span class=\"line\">CPU time:       2192.2s</span><br><span class=\"line\">CPU Affinity:   --------y-------------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>\n\n\n<p>From the above outputs, we can find that the vCPUa are pinned to NO. 1 to 8 CPU cores.</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ubuntu@ubuntu-kvm:~$ sudo numastat -c qemu</span><br><span class=\"line\">Per-node process memory usage (in MBs)</span><br><span class=\"line\">PID              Node 0 Node 1 Total</span><br><span class=\"line\"></span><br><span class=\"line\">---------------  ------ ------ -----</span><br><span class=\"line\"></span><br><span class=\"line\">4391 (qemu-syste   8373      0  8373</span><br><span class=\"line\">5891 (sudo)           4      1     5</span><br><span class=\"line\"></span><br><span class=\"line\">---------------  ------ ------ -----</span><br><span class=\"line\"></span><br><span class=\"line\">Total              8377      1  8377</span><br><span class=\"line\"></span><br><span class=\"line\">ubuntu@ubuntu-kvm:~$ sudo numastat -p 4391</span><br><span class=\"line\">Per-node process memory usage (in MBs) for PID 4391 (qemu-system-x86)</span><br><span class=\"line\">                           Node 0          Node 1           Total</span><br><span class=\"line\">                  --------------- --------------- ---------------</span><br><span class=\"line\">Huge                      8192.00            0.00         8192.00</span><br><span class=\"line\">Heap                        10.00            0.00           10.00</span><br><span class=\"line\">Stack                        0.03            0.00            0.03</span><br><span class=\"line\">Private                    170.70            0.15          170.85</span><br><span class=\"line\"></span><br><span class=\"line\">----------------  --------------- --------------- ---------------</span><br><span class=\"line\"></span><br><span class=\"line\">Total                     8372.73            0.16         8372.88</span><br></pre></td></tr></table></figure>\n\n\n<p>From the above outputs, the csr1kv-1 are using the memories from node 0.</p>\n<h2 id=\"7-Check-the-vNIC-in-CSR1KV\"><a href=\"#7-Check-the-vNIC-in-CSR1KV\" class=\"headerlink\" title=\"(7) Check the vNIC in CSR1KV\"></a>(7) Check the vNIC in CSR1KV</h2><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">csr1kv-1#show platform software vnic-if interface-mapping</span><br><span class=\"line\">-------------------------------------------------------------</span><br><span class=\"line\"></span><br><span class=\"line\"> Interface Name        Driver Name         Mac Addr</span><br><span class=\"line\">-------------------------------------------------------------</span><br><span class=\"line\"></span><br><span class=\"line\"> GigabitEthernet3       net_i40e_vf        5254.00bd.9f54</span><br><span class=\"line\"> GigabitEthernet2       net_i40e_vf        5254.000b.a52e</span><br><span class=\"line\"> GigabitEthernet1       net_virtio         5254.0069.ec73</span><br></pre></td></tr></table></figure>\n\n<p>The Driver Name net_i40e_vf indicates that the vNIC is a VF from the SR-IOV pool.</p>\n<h1 id=\"CSR-1000v-initial-configuration-and-Smart-License-registration\"><a href=\"#CSR-1000v-initial-configuration-and-Smart-License-registration\" class=\"headerlink\" title=\"CSR 1000v initial configuration and Smart License registration\"></a>CSR 1000v initial configuration and Smart License registration</h1><h2 id=\"1-CSR-1000v-initial-config-example\"><a href=\"#1-CSR-1000v-initial-config-example\" class=\"headerlink\" title=\"(1) CSR 1000v initial config example\"></a>(1) CSR 1000v initial config example</h2><p>Part of the configuration:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">CSR1000v-1#show sdwan running-config</span><br><span class=\"line\">system</span><br><span class=\"line\"> system-ip             1.1.10.1</span><br><span class=\"line\"> site-id               101</span><br><span class=\"line\"> sp-organization-name  CiscoBJ</span><br><span class=\"line\"> organization-name     CiscoBJ</span><br><span class=\"line\"> vbond 10.75.58.51 port 12346</span><br><span class=\"line\">!</span><br><span class=\"line\">hostname CSR1000v-1</span><br><span class=\"line\">username admin privilege 15 secret 9 $9$4/QL2V2K4/6H1k$XUmRNf.T7t3KDOj/FmoNexpEypCxr482dExXHDnohSI</span><br><span class=\"line\">ip name-server 64.104.123.245</span><br><span class=\"line\">ip route 0.0.0.0 0.0.0.0 10.75.59.1</span><br><span class=\"line\"></span><br><span class=\"line\">interface GigabitEthernet1</span><br><span class=\"line\"> no shutdown</span><br><span class=\"line\"> arp timeout 1200</span><br><span class=\"line\"> ip address 10.75.59.35 255.255.255.0</span><br><span class=\"line\"> no ip redirects</span><br><span class=\"line\"> ip mtu    1500</span><br><span class=\"line\"> mtu 1500</span><br><span class=\"line\"> negotiation auto</span><br><span class=\"line\">exit</span><br><span class=\"line\"></span><br><span class=\"line\">interface Tunnel1</span><br><span class=\"line\"> no shutdown</span><br><span class=\"line\"> ip unnumbered GigabitEthernet1</span><br><span class=\"line\"> no ip redirects</span><br><span class=\"line\"> ipv6 unnumbered GigabitEthernet1</span><br><span class=\"line\"> no ipv6 redirects</span><br><span class=\"line\"> tunnel source GigabitEthernet1</span><br><span class=\"line\"> tunnel mode sdwan</span><br><span class=\"line\">exit</span><br><span class=\"line\"></span><br><span class=\"line\">clock timezone CST 8 0</span><br><span class=\"line\">ntp server x.x.x.x version 4</span><br><span class=\"line\"></span><br><span class=\"line\">sdwan</span><br><span class=\"line\"> interface GigabitEthernet1</span><br><span class=\"line\">  tunnel-interface</span><br><span class=\"line\">   encapsulation ipsec</span><br><span class=\"line\">   allow-service sshd</span><br><span class=\"line\">  exit</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"2-Commands-to-check-the-status\"><a href=\"#2-Commands-to-check-the-status\" class=\"headerlink\" title=\"(2) Commands to check the status\"></a>(2) Commands to check the status</h2><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">show sdwan control local-properties</span><br><span class=\"line\">show sdwan control connections</span><br><span class=\"line\">show sdwan control connection-history</span><br><span class=\"line\">show sdwan running-config</span><br><span class=\"line\">show sdwan bfd sessions</span><br><span class=\"line\">show sdwan omp peers</span><br><span class=\"line\">show sdwan omp routes</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"3-CSR-1000v-Smart-License-Registration\"><a href=\"#3-CSR-1000v-Smart-License-Registration\" class=\"headerlink\" title=\"(3) CSR 1000v Smart License Registration\"></a>(3) CSR 1000v Smart License Registration</h2><p>Before Smart License registration, you need ：</p>\n<ol>\n<li>CSR 1000v’s control connections are up；</li>\n<li>Configure ip http client source-interface GigabitEthernet2</li>\n<li>If the version is 16.12.x and bellow, you need to allow service all<br><code>sdwan interface GigabitEthernet2 tunnel-interface allow-service all </code><br>In the 17.2.x and above versions, there is an allow-service https</li>\n<li>CSR 1000v can access URL：<a href=\"https://tools.cisco.com/its/service/oddce/services/DDCEService\">https://tools.cisco.com/its/service/oddce/services/DDCEService</a><br>The command license smart register idtoken xxxxxx will do the registration.<br>You can find the idtoken from your Smart Account smart license inventory.<br>show license status to check the status.</li>\n</ol>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">CSR1000v-1#show platform hardware throughput level</span><br><span class=\"line\">The current throughput level is 200000000 kb/s</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"Performances-and-limitations\"><a href=\"#Performances-and-limitations\" class=\"headerlink\" title=\"Performances and limitations\"></a>Performances and limitations</h1><h2 id=\"1-The-performance-of-the-SR-IOV\"><a href=\"#1-The-performance-of-the-SR-IOV\" class=\"headerlink\" title=\"(1) The performance of the SR-IOV\"></a>(1) The performance of the SR-IOV</h2><p>A performance test was done after the SR-IOV setup, the CSR1KV was configured as 8vCPU and 8G Memory, the packet drop rate was 0%.</p>\n<table>\n<thead>\n<tr>\n<th>Packet Site</th>\n<th>SDWAN Performance (Mbps)</th>\n<th>CEF Performance (Mbps)</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>128Bytes</td>\n<td>800</td>\n<td>2843.75</td>\n</tr>\n<tr>\n<td>256Bytes</td>\n<td>1431.26</td>\n<td>6500.00</td>\n</tr>\n<tr>\n<td>512Bytes</td>\n<td>2581.26</td>\n<td>10578.13</td>\n</tr>\n<tr>\n<td>1024Bytes</td>\n<td>3731.26</td>\n<td>15500.00</td>\n</tr>\n<tr>\n<td>1400Bytes</td>\n<td>4306.26</td>\n<td>18171.88</td>\n</tr>\n</tbody></table>\n<p><img src=\"/csr1kv-kvm-Ubuntu20-04-md/line-chart.png\" alt=\"Performance Line Chart\"></p>\n<p>Note: <strong>These test results are not to represent the official performance data. Different servers and network cards may have different test results. The above data is for demo only.</strong></p>\n<h2 id=\"2-The-limitation-of-the-SR-IOV\"><a href=\"#2-The-limitation-of-the-SR-IOV\" class=\"headerlink\" title=\"(2) The limitation of the SR-IOV\"></a>(2) The limitation of the SR-IOV</h2><p>The main limitation of the SR-IOV is the number of VLANs on each VF, the maximum VLAN of an VF is limited to 63 in ixgbevf.<br>So, the active number of sub-interfaces on an interface of the CSR1KV that uses the SRIOV VFs is limited to 63.<br>There is some notes in the Cisco CSR 1000v and Cisco ISRv Software Configuration Guide:</p>\n<blockquote>\n<p>SR-IOV (ixgbevf)<br>Maximum VLANs: The maximum number of VLANs supported on PF is 64. Together, all VFs can have a total of 64 VLANs. (Intel limitation.)</p>\n<p>SR-IOV (i40evf)<br>Maximum VLANs: The maximum number of VLANs supported on PF is 512. Together, all VFs can have a total of 512 VLANs. (Intel limitation.) Per-VF resources are managed by the PF (host) device driver.</p>\n</blockquote>\n<h1 id=\"References\"><a href=\"#References\" class=\"headerlink\" title=\"References\"></a>References</h1><p><a href=\"https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html-single/performance_tuning_guide/index\">https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html-single/performance_tuning_guide/index</a></p>\n<p><a href=\"https://computingforgeeks.com/how-to-create-and-configure-bridge-networking-for-kvm-in-linux/\">https://computingforgeeks.com/how-to-create-and-configure-bridge-networking-for-kvm-in-linux/</a></p>\n<p><a href=\"https://software.intel.com/content/www/us/en/develop/articles/configure-sr-iov-network-virtual-functions-in-linux-kvm.html\">https://software.intel.com/content/www/us/en/develop/articles/configure-sr-iov-network-virtual-functions-in-linux-kvm.html</a></p>\n<p><a href=\"https://linuxconfig.org/install-and-set-up-kvm-on-ubuntu-20-04-focal-fossa-linux\">https://linuxconfig.org/install-and-set-up-kvm-on-ubuntu-20-04-focal-fossa-linux</a></p>\n<p><a href=\"https://kifarunix.com/how-to-fix-qemu-kvm-not-connected-error-on-ubuntu-20-04/\">https://kifarunix.com/how-to-fix-qemu-kvm-not-connected-error-on-ubuntu-20-04/</a></p>\n<p><a href=\"https://linuxconfig.org/how-to-disable-apparmor-on-ubuntu-20-04-focal-fossa-linux\">https://linuxconfig.org/how-to-disable-apparmor-on-ubuntu-20-04-focal-fossa-linux</a></p>\n<p><strong>CSR1000v SD-WAN Installation on KVM</strong> by Jean-Marc Barozet</p>\n<h1 id=\"Scripts-and-XML-Example-Files\"><a href=\"#Scripts-and-XML-Example-Files\" class=\"headerlink\" title=\"Scripts and XML Example Files\"></a>Scripts and XML Example Files</h1><ol>\n<li><a href=\"https://raw.githubusercontent.com/weiborao/CSR1KV-Installation-on-KVM-with-SRIOV/main/kvm/1.2-install-ubuntu-kvm.sh\">Ubuntu and KVM installation and setting</a></li>\n<li><a href=\"https://github.com/weiborao/CSR1KV-Installation-on-KVM-with-SRIOV/raw/main/kvm/1.3-nic-settings.sh\">NIC Settings with nmcli</a></li>\n<li><a href=\"https://github.com/weiborao/CSR1KV-Installation-on-KVM-with-SRIOV/raw/main/kvm/2.1-check-nic-sriov.sh\">Check NIC SRIOV Capabilities</a></li>\n<li><a href=\"https://github.com/weiborao/CSR1KV-Installation-on-KVM-with-SRIOV/raw/main/kvm/2.2-change-grub.sh\">GRUB Settings</a></li>\n<li><a href=\"https://github.com/weiborao/CSR1KV-Installation-on-KVM-with-SRIOV/raw/main/kvm/2.3-sriov-setting.sh\">SRIOV Settings</a></li>\n<li><a href=\"https://github.com/weiborao/CSR1KV-Installation-on-KVM-with-SRIOV/raw/main/kvm/2.4-check-vfs.sh\">Check VFs</a></li>\n<li><a href=\"https://github.com/weiborao/CSR1KV-Installation-on-KVM-with-SRIOV/raw/main/kvm/3.0-create-sriov-pool.sh\">Create SRIOV Adapter Pool</a></li>\n<li><a href=\"https://github.com/weiborao/CSR1KV-Installation-on-KVM-with-SRIOV/raw/main/kvm/4.0-kvm-tuning.sh\">KVM Tuning</a></li>\n<li><a href=\"https://github.com/weiborao/CSR1KV-Installation-on-KVM-with-SRIOV/raw/main/kvm/4.1-check-csr1kv.sh\">Check CSR1000v Tuning</a></li>\n<li><a href=\"https://github.com/weiborao/CSR1KV-Installation-on-KVM-with-SRIOV/raw/main/kvm/ens1f0_sriov_pool.xml\">ens1f0_sriov_pool.xml</a></li>\n<li><a href=\"https://github.com/weiborao/CSR1KV-Installation-on-KVM-with-SRIOV/raw/main/kvm/csr1kv-1.xml\">csr1kv-1.xml</a></li>\n</ol>\n","length":4577,"excerpt":"","more":"<p>Last Update: February 3, 2021</p>\n<p>Author: Rao Weibo</p>\n<p>Version: 1.0</p>\n<p>This guide provides the steps on how to install CSR1000v&#x2F;Catalyst 8000v on KVM, the setting of SRIOV and KVM tuning.</p>\n<h1 id=\"Ubuntu-20-04-Installation-and-Settings\"><a href=\"#Ubuntu-20-04-Installation-and-Settings\" class=\"headerlink\" title=\"Ubuntu 20.04 Installation and Settings\"></a>Ubuntu 20.04 Installation and Settings</h1><h2 id=\"1-BIOS-settings\"><a href=\"#1-BIOS-settings\" class=\"headerlink\" title=\"(1) BIOS settings\"></a>(1) BIOS settings</h2><table>\n<thead>\n<tr>\n<th>Configuration</th>\n<th>Recommended Setting</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>Intel Hyper-Threading  Technology</td>\n<td>Disabled</td>\n</tr>\n<tr>\n<td>Number of Enable Cores</td>\n<td>ALL</td>\n</tr>\n<tr>\n<td>Execute Disable</td>\n<td>Enabled</td>\n</tr>\n<tr>\n<td><strong>Intel VT</strong></td>\n<td><strong>Enabled</strong></td>\n</tr>\n<tr>\n<td><strong>Intel VT-D</strong></td>\n<td><strong>Enabled</strong></td>\n</tr>\n<tr>\n<td>Intel VT-D coherency support</td>\n<td>Enabled</td>\n</tr>\n<tr>\n<td>Intel VT-D ATS support</td>\n<td>Enabled</td>\n</tr>\n<tr>\n<td>CPU Performance</td>\n<td>High throughput</td>\n</tr>\n<tr>\n<td>Hardware Perfetcher</td>\n<td>Disabled</td>\n</tr>\n<tr>\n<td>Adjacent Cache Line Prefetcher</td>\n<td>Disabled</td>\n</tr>\n<tr>\n<td>DCU Streamer Prefetch</td>\n<td>Disable</td>\n</tr>\n<tr>\n<td>Power Technology</td>\n<td>Custom</td>\n</tr>\n<tr>\n<td>Enhanced Intel Speedstep  Technology</td>\n<td>Disabled</td>\n</tr>\n<tr>\n<td>Intel Turbo Boost Technology</td>\n<td>Enabled</td>\n</tr>\n<tr>\n<td>Processor Power State C6</td>\n<td>Disabled</td>\n</tr>\n<tr>\n<td>Processor Power State C1 Enhanced</td>\n<td>Disabled</td>\n</tr>\n<tr>\n<td>Frequency Poor Override</td>\n<td>Enabled</td>\n</tr>\n<tr>\n<td>P-State Coordination</td>\n<td>HW_ALL</td>\n</tr>\n<tr>\n<td>Energy Performance</td>\n<td>Performance</td>\n</tr>\n</tbody></table>\n<p>The above settings are from the Installation guide from <a href=\"https://www.cisco.com/c/en/us/td/docs/routers/csr1000/software/configuration/b_CSR1000v_Configuration_Guide/b_CSR1000v_Configuration_Guide_chapter_0101.html#con_1313827\">Cisco CSR 1000v and Cisco ISRv Software Configuration Guide</a>.<br>Note: some platform such as <strong>Cisco NFVIS</strong>, does not disable the Hyper-Threading.</p>\n<h2 id=\"2-Ubuntu-20-04-installation-tips\"><a href=\"#2-Ubuntu-20-04-installation-tips\" class=\"headerlink\" title=\"(2) Ubuntu 20.04 installation tips\"></a>(2) Ubuntu 20.04 installation tips</h2><p>If you need the Gnome GUI, you can install the Ubuntu 20.04 Desktop.<br>After the system bootup, <strong>‘apparmor’</strong> is recommended to be disabled, otherwise, you may meet <strong>permission denied</strong> when you assign SRIOV devices to the CSR1kV. You need to reboot to take effect.</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo systemctl disable apparmor</span><br><span class=\"line\">egrep -o &#x27;(vmx|svm)&#x27; /proc/cpuinfo | sort | uniq</span><br></pre></td></tr></table></figure>\n<p>You can find the <strong>vmx</strong> on Intel platform, or <strong>svm</strong> on AMD platform.</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo systemctl stop ufw</span><br><span class=\"line\">systemctl disable ufw</span><br></pre></td></tr></table></figure>\n\n<p><code>cat /etc/sysctl.conf</code></p>\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">net.ipv4.ip_forward = 1</span><br><span class=\"line\">net.bridge.bridge-nf-call-ip6tables = 0</span><br><span class=\"line\">net.bridge.bridge-nf-call-iptables = 0</span><br><span class=\"line\">net.bridge.bridge-nf-call-arptables = 0</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">$ </span><span class=\"language-bash\"><span class=\"built_in\">sudo</span> apt install qemu-kvm libvirt-clients libvirt-daemon-system bridge-utils virt-manager numactl virt-top</span></span><br></pre></td></tr></table></figure>\n<p>After installation, you can check the version</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ubuntu@ubuntu-kvm:~$ libvirtd -V</span><br><span class=\"line\">libvirtd (libvirt) 6.0.0</span><br><span class=\"line\">ubuntu@ubuntu-kvm:~$ qemu-system-x86_64 --version</span><br><span class=\"line\">QEMU emulator version 4.2.1 (Debian 1:4.2-3ubuntu6.11)</span><br><span class=\"line\">Copyright (c) 2003-2019 Fabrice Bellard and the QEMU Project developers</span><br><span class=\"line\">ubuntu@ubuntu-kvm:~$ virt-manager --version</span><br><span class=\"line\">2.2.1</span><br><span class=\"line\">ubuntu@ubuntu-kvm:~$ modinfo kvm-intel</span><br><span class=\"line\">filename:       /lib/modules/5.4.0-62-generic/kernel/arch/x86/kvm/kvm-intel.ko</span><br><span class=\"line\">ubuntu@ubuntu-kvm:~$ modinfo i40evf</span><br><span class=\"line\">filename:       /lib/modules/5.4.0-62-generic/kernel/drivers/net/ethernet/intel/iavf/iavf.ko</span><br><span class=\"line\">version:        3.2.3-k</span><br></pre></td></tr></table></figure>\n<h2 id=\"3-NIC-Setting\"><a href=\"#3-NIC-Setting\" class=\"headerlink\" title=\"(3) NIC Setting\"></a>(3) NIC Setting</h2><p>In Ubuntu 20.04, we use NetworkManager to config the NIC, you can use nmtui on the terminal, or nmcli.<br>First, check the netplan.</p>\n<p><code>cat /etc/netplan/ 00-installer-config.yaml</code></p>\n<p>Edit the yaml file:</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># Let NetworkManager manage all devices on this system</span></span><br><span class=\"line\"><span class=\"attr\">network:</span></span><br><span class=\"line\">  <span class=\"attr\">version:</span> <span class=\"number\">2</span></span><br><span class=\"line\">  <span class=\"attr\">renderer:</span> <span class=\"string\">NetworkManager</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo netplan apply</span><br></pre></td></tr></table></figure>\n<p>Then you can set the network config with nmcli or nmtui.</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ubuntu@ubuntu-kvm:~$ sudo nmcli connection modify netplan-eno1 ipv4.method manual ipv4.addresses 10.75.59.50/24 ipv4.gateway 10.75.59.1 ipv4.dns 64.104.123.245</span><br><span class=\"line\">ubuntu@ubuntu-kvm:~$ sudo nmcli connection modify netplan-eno1 connection.id eno1</span><br><span class=\"line\">ubuntu@ubuntu-kvm:~$ sudo nmcli connection up eno1</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">Change the connections name to the devices name.</span></span><br><span class=\"line\"></span><br><span class=\"line\">sudo nmcli connection</span><br><span class=\"line\">ubuntu@ubuntu-kvm:~$ sudo nmcli connection</span><br><span class=\"line\">NAME        UUID                                  TYPE      DEVICE</span><br><span class=\"line\">eno1        10838d80-caeb-349e-ba73-08ed16d4d666  ethernet  eno1</span><br><span class=\"line\">enp216s0f0  6556c191-c253-3a5e-b440-c5b071ec29a4  ethernet  enp216s0f0</span><br><span class=\"line\">enp216s0f1  8080672c-5784-375f-8eb9-a6ef57cbd4f7  ethernet  enp216s0f1</span><br><span class=\"line\">ens1f0      58fb5b1f-c10a-3e7a-9ab9-a8c449840ce6  ethernet  ens1f0</span><br><span class=\"line\">ens1f1      2a06a9d9-b761-3bdf-aa0b-3d44fff2158f  ethernet  ens1f1</span><br><span class=\"line\">virbr0      ca7d1e11-a82f-429c-9d91-fc985776232c  bridge    virbr0</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">Set the MTU and <span class=\"built_in\">disable</span> ipv4 <span class=\"keyword\">for</span> the NIC to <span class=\"built_in\">enable</span> SRIOV.</span> </span><br><span class=\"line\"></span><br><span class=\"line\">sudo nmcli connection modify ens1f0 ethernet.mtu 9216</span><br><span class=\"line\">sudo nmcli connection modify ens1f0 ipv4.method disabled</span><br><span class=\"line\">sudo nmcli connection up ens1f0</span><br><span class=\"line\">sudo ip link show ens1f0</span><br><span class=\"line\">2: ens1f0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 9216 qdisc mq state UP mode DEFAULT group default qlen 1000</span><br><span class=\"line\">link/ether 40:a6:b7:0f:a7:74 brd ff:ff:ff:ff:ff:ff</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">Note: This value 9216 of MTU is derived from Cisco NFVIS.</span></span><br><span class=\"line\"><span class=\"meta prompt_\">CSP5228-1# </span><span class=\"language-bash\">show pnic-detail mtu</span></span><br><span class=\"line\">Name          MTU</span><br><span class=\"line\">=============================</span><br><span class=\"line\">eth0-1        9216</span><br><span class=\"line\">eth0-2        9216</span><br><span class=\"line\">eth1-1        9216</span><br><span class=\"line\">eth1-2        9216</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"SR-IOV-Configuration\"><a href=\"#SR-IOV-Configuration\" class=\"headerlink\" title=\"SR-IOV Configuration\"></a>SR-IOV Configuration</h1><h2 id=\"1-Check-the-NIC-to-support-SR-IOV\"><a href=\"#1-Check-the-NIC-to-support-SR-IOV\" class=\"headerlink\" title=\"(1) Check the NIC to support SR-IOV\"></a>(1) Check the NIC to support SR-IOV</h2><p>Check the NIC hardware infor.</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo lshw -c network -businfo</span><br><span class=\"line\"></span><br><span class=\"line\">Bus info          Device      Class          Description</span><br><span class=\"line\">========================================================</span><br><span class=\"line\"></span><br><span class=\"line\">pci@0000:3b:00.0  eno1        network        Ethernet Controller 10G X550T</span><br><span class=\"line\">pci@0000:3b:00.1  eno2        network        Ethernet Controller 10G X550T</span><br><span class=\"line\">pci@0000:5e:00.0  ens1f0      network        Ethernet Controller XXV710 for 25GbE SFP28</span><br><span class=\"line\">pci@0000:5e:00.1  ens1f1      network        Ethernet Controller XXV710 for 25GbE SFP28</span><br><span class=\"line\">pci@0000:d8:00.0  enp216s0f0  network        Ethernet Controller XXV710 for 25GbE SFP28</span><br><span class=\"line\">pci@0000:d8:00.1  enp216s0f1  network        Ethernet Controller XXV710 for 25GbE SFP28</span><br></pre></td></tr></table></figure>\n\n<p>Check the capabilities of NIC</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo lspci -vv -s 5e:00.0 | grep -A 5 -i SR-IOV</span><br><span class=\"line\">    Capabilities: [160 v1] Single Root I/O Virtualization (SR-IOV)</span><br><span class=\"line\">        IOVCap: Migration-, Interrupt Message Number: 000</span><br><span class=\"line\">        IOVCtl: Enable+ Migration- Interrupt- MSE+ ARIHierarchy+</span><br><span class=\"line\">        IOVSta: Migration-</span><br><span class=\"line\">        Initial VFs: 64, Total VFs: 64, Number of VFs: 2, Function Dependency Link: 00</span><br><span class=\"line\">        VF offset: 16, stride: 1, Device ID: 154c</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"2-Change-the-GRUB-parameters\"><a href=\"#2-Change-the-GRUB-parameters\" class=\"headerlink\" title=\"(2) Change the GRUB parameters\"></a>(2) Change the GRUB parameters</h2><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo vi /etc/default/grub </span><br><span class=\"line\">GRUB_CMDLINE_LINUX_DEFAULT=&quot;quiet hugepagesz=1G hugepages=64 default_hugepagesz=1G intel_iommu=on iommu=pt isolcpus=1-8,45-52&quot;</span><br></pre></td></tr></table></figure>\n\n<p><strong>Note：The hugepages should be no more than the physical memory, otherwise, it will fail to bootup.</strong></p>\n<ul>\n<li><strong>default_hugepagesz&#x3D;1G hugepagesz&#x3D;1G hugepages&#x3D;64</strong> will allocate 64 1GB huge pages at boot, which are <strong>static huge pages</strong>. CSR 1000v will use these static huge pages for best performance.</li>\n<li><strong>isolcpus&#x3D;1-8,45-52</strong> will isolate the CPUs cores reserved for CSR 1000v, prevent other processes running on these cores, this can reduce latency for CSR 1000v. You can refer to   [Check the capability of the platform][1]  to get the CPU information.</li>\n</ul>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo update-grub</span><br></pre></td></tr></table></figure>\n\n<p>After reboot, check the &#x2F;proc&#x2F;cmdline.</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat /proc/cmdline |grep intel_iommu=on</span><br><span class=\"line\">dmesg |grep -e DMAR -e IOMMU</span><br><span class=\"line\">dmesg | grep -e DMAR -e IOMMU -e AMD-Vi</span><br><span class=\"line\">ubuntu@ubuntu-kvm:~$ cat /proc/cmdline |grep intel_iommu=on</span><br><span class=\"line\">BOOT_IMAGE=/vmlinuz-5.4.0-62-generic root=/dev/mapper/ubuntu--vg-ubuntu--lv ro quiet hugepagesz=1G hugepages=64 default_hugepagesz=1G intel_iommu=on iommu=pt isolcpus=1-8,45-52</span><br><span class=\"line\"></span><br><span class=\"line\">ubuntu@ubuntu-kvm:~ $ dmesg |grep -e DMAR -e IOMMU</span><br><span class=\"line\">[    0.020313] ACPI: DMAR 0x000000005DA8EB80 000270 (v01 Cisco0 CiscoUCS 00000001 INTL 20091013)</span><br><span class=\"line\">[    1.954441] DMAR: IOMMU enabled</span><br></pre></td></tr></table></figure>\n\n<p>Check the CPU info, all the CPU cores and isolated CPU cores.</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ubuntu@ubuntu-kvm:~$ cat /sys/devices/system/cpu/isolated</span><br><span class=\"line\">1-8,45-52</span><br><span class=\"line\">ubuntu@ubuntu-kvm:~$ cat /sys/devices/system/cpu/present</span><br><span class=\"line\">0-87</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"3-VFs-Persistence\"><a href=\"#3-VFs-Persistence\" class=\"headerlink\" title=\"(3) VFs Persistence\"></a>(3) VFs Persistence</h2><p><strong>NetworkManager way:</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">nmcli can <span class=\"built_in\">set</span> the SRIOV, as follow:</span></span><br><span class=\"line\">sudo nmcli connection modify ens1f0 sriov.total-vfs 2</span><br><span class=\"line\">sudo nmcli connection modify ens1f1 sriov.total-vfs 2</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\"># </span><span class=\"language-bash\">We can <span class=\"built_in\">set</span> the MAC address and <span class=\"built_in\">set</span> the trust on:</span></span><br><span class=\"line\">sudo nmcli connection modify ens1f0 sriov.vfs &#x27;0 mac=b6:4f:02:37:5a:d8 trust=true, 1 mac=26:04:1d:1f:3d:a9 trust=true&#x27;</span><br><span class=\"line\">sudo nmcli connection modify ens1f1 sriov.vfs &#x27;0 mac=76:6c:4e:16:7f:e2 trust=true, 1 mac=6a:f2:bd:97:71:65 trust=true&#x27;</span><br><span class=\"line\">sudo nmcli connection up ens1f0</span><br><span class=\"line\">sudo nmcli connection up ens1f1</span><br></pre></td></tr></table></figure>\n\n<p>After reboot, check the dmesg.</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo dmesg | grep -i vf</span><br><span class=\"line\">[    6.599304] i40e 0000:5e:00.0: Allocating 2 VFs.</span><br><span class=\"line\">[    6.680111] i40e 0000:5e:00.1: Allocating 2 VFs.</span><br><span class=\"line\">[    6.730167] iavf: Intel(R) Ethernet Adaptive Virtual Function Network Driver - version 3.2.3-k</span><br><span class=\"line\">&lt;&lt; snip &gt;&gt;</span><br><span class=\"line\">[   17.931493] i40e 0000:5e:00.0: Setting MAC b6:4f:02:37:5a:d8 on VF 0</span><br><span class=\"line\">[   18.111781] i40e 0000:5e:00.0: VF 0 is now trusted</span><br><span class=\"line\">[   18.112559] i40e 0000:5e:00.0: Setting MAC 26:04:1d:1f:3d:a9 on VF 1</span><br><span class=\"line\">[   18.291464] i40e 0000:5e:00.0: VF 1 is now trusted</span><br><span class=\"line\">[   18.292231] i40e 0000:5e:00.1: Setting MAC 76:6c:4e:16:7f:e2 on VF 0</span><br><span class=\"line\">[   18.475259] i40e 0000:5e:00.1: VF 0 is now trusted</span><br><span class=\"line\">[   18.475929] i40e 0000:5e:00.1: Setting MAC 6a:f2:bd:97:71:65 on VF 1</span><br><span class=\"line\">[   18.659465] i40e 0000:5e:00.1: VF 1 is now trusted</span><br><span class=\"line\">[   18.728124] iavf 0000:5e:02.0 ens1f0v0: NIC Link is Up Speed is 25 Gbps Full Duplex</span><br><span class=\"line\">[   18.752275] iavf 0000:5e:02.1 ens1f0v1: NIC Link is Up Speed is 25 Gbps Full Duplex</span><br><span class=\"line\">[   18.776329] iavf 0000:5e:0a.0 ens1f1v0: NIC Link is Up Speed is 25 Gbps Full Duplex</span><br><span class=\"line\">[   18.800569] iavf 0000:5e:0a.1 ens1f1v1: NIC Link is Up Speed is 25 Gbps Full Duplex</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"4-Check-the-VFs\"><a href=\"#4-Check-the-VFs\" class=\"headerlink\" title=\"(4) Check the VFs\"></a>(4) Check the VFs</h2><p>You can check the VFs from lspci or ip link commands.</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ubuntu@ubuntu-kvm:~$ sudo lspci | grep -i Virtual</span><br><span class=\"line\">ubuntu@ubuntu-kvm:~$ sudo ip link show | grep -B2 vf</span><br></pre></td></tr></table></figure>\n\n<p>Good news is that the VFs names are well related to the physical NICs. For example, <strong>ens1f0v1</strong> is one of the VFs of the physical NIC <strong>ens1f0</strong> .</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ubuntu@ubuntu-kvm:~$ ip link show | grep -E ens1f[0,1]v[0,1] -A 1</span><br><span class=\"line\">9: ens1f0v1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP mode DEFAULT group default qlen 1000</span><br><span class=\"line\">    link/ether 26:04:1d:1f:3d:a9 brd ff:ff:ff:ff:ff:ff</span><br><span class=\"line\">10: ens1f1v1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP mode DEFAULT group default qlen 1000</span><br><span class=\"line\">    link/ether 6a:f2:bd:97:71:65 brd ff:ff:ff:ff:ff:ff</span><br><span class=\"line\">15: ens1f0v0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP mode DEFAULT group default qlen 1000</span><br><span class=\"line\">    link/ether b6:4f:02:37:5a:d8 brd ff:ff:ff:ff:ff:ff</span><br><span class=\"line\">16: ens1f1v0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP mode DEFAULT group default qlen 1000</span><br><span class=\"line\">link/ether 76:6c:4e:16:7f:e2 brd ff:ff:ff:ff:ff:ff</span><br></pre></td></tr></table></figure>\n\n<p>We can change the MTU to <strong>9216</strong> (or you may not need 9216, 1504 is enough).</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo nmcli connection modify ens1f0v0 ethernet.mtu 9216 ipv4.method disabled</span><br><span class=\"line\">sudo nmcli connection modify ens1f0v1 ethernet.mtu 9216 ipv4.method disabled</span><br><span class=\"line\">sudo nmcli connection modify ens1f1v0 ethernet.mtu 9216 ipv4.method disabled</span><br><span class=\"line\">sudo nmcli connection modify ens1f1v1 ethernet.mtu 9216 ipv4.method disabled</span><br><span class=\"line\">sudo nmcli connection up ens1f0v0 </span><br><span class=\"line\">sudo nmcli connection up ens1f0v1</span><br><span class=\"line\">sudo nmcli connection up ens1f1v0</span><br><span class=\"line\">sudo nmcli connection up ens1f1v1</span><br></pre></td></tr></table></figure>\n\n<p>The above configs will survive after reboot.</p>\n<h1 id=\"Create-SR-IOV-Virtual-Network-Adapter-Pool\"><a href=\"#Create-SR-IOV-Virtual-Network-Adapter-Pool\" class=\"headerlink\" title=\"Create SR-IOV Virtual Network Adapter Pool\"></a>Create SR-IOV Virtual Network Adapter Pool</h1><p>Using this method, KVM creates a pool of network devices that can be inserted into VMs, and the size of that pool is determined by how many VFs were created on the physical function when they were initialized.</p>\n<h2 id=\"1-Create-an-xml-file\"><a href=\"#1-Create-an-xml-file\" class=\"headerlink\" title=\"(1) Create an xml file\"></a>(1) Create an xml file</h2><p>ubuntu@ubuntu-kvm:~&#x2F;kvm$ cat ens1f0_sriov_pool.xml</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">network</span>&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">name</span>&gt;</span>ens1f0_sriov_pool<span class=\"tag\">&lt;/<span class=\"name\">name</span>&gt;</span> <span class=\"comment\">&lt;!-- This is the name of the file you created --&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;<span class=\"name\">forward</span> <span class=\"attr\">mode</span>=<span class=\"string\">&#x27;hostdev&#x27;</span> <span class=\"attr\">managed</span>=<span class=\"string\">&#x27;yes&#x27;</span>&gt;</span></span><br><span class=\"line\">     <span class=\"tag\">&lt;<span class=\"name\">pf</span> <span class=\"attr\">dev</span>=<span class=\"string\">&#x27;ens1f0&#x27;</span>/&gt;</span>  <span class=\"comment\">&lt;!-- Use the netdev name of your SR-IOV devices PF here --&gt;</span></span><br><span class=\"line\">   <span class=\"tag\">&lt;/<span class=\"name\">forward</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">network</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"2-Define-a-network-and-set-to-auto-start\"><a href=\"#2-Define-a-network-and-set-to-auto-start\" class=\"headerlink\" title=\"(2) Define a network and set to auto start.\"></a>(2) Define a network and set to auto start.</h2><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">virsh net-define ens1f0_sriov_pool.xml</span><br><span class=\"line\">Sleep 1</span><br><span class=\"line\">virsh net-start ens1f0_sriov_pool</span><br><span class=\"line\">virsh net-autostart ens1f0_sriov_pool</span><br></pre></td></tr></table></figure>\n\n<p>ubuntu@ubuntu-kvm:~&#x2F;kvm$ virsh net-dumpxml ens1f0_sriov_pool</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">network</span> <span class=\"attr\">connections</span>=<span class=\"string\">&#x27;1&#x27;</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">name</span>&gt;</span>ens1f0_sriov_pool<span class=\"tag\">&lt;/<span class=\"name\">name</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">uuid</span>&gt;</span>9125a600-6620-4ab6-9a47-8844a61b0918<span class=\"tag\">&lt;/<span class=\"name\">uuid</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">forward</span> <span class=\"attr\">mode</span>=<span class=\"string\">&#x27;hostdev&#x27;</span> <span class=\"attr\">managed</span>=<span class=\"string\">&#x27;yes&#x27;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">pf</span> <span class=\"attr\">dev</span>=<span class=\"string\">&#x27;ens1f0&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">domain</span>=<span class=\"string\">&#x27;0x0000&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0x5e&#x27;</span> <span class=\"attr\">slot</span>=<span class=\"string\">&#x27;0x02&#x27;</span> <span class=\"attr\">function</span>=<span class=\"string\">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">domain</span>=<span class=\"string\">&#x27;0x0000&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0x5e&#x27;</span> <span class=\"attr\">slot</span>=<span class=\"string\">&#x27;0x02&#x27;</span> <span class=\"attr\">function</span>=<span class=\"string\">&#x27;0x1&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">forward</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">network</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h2 id=\"3-Select-the-virtual-adapter-from-the-pool\"><a href=\"#3-Select-the-virtual-adapter-from-the-pool\" class=\"headerlink\" title=\"(3) Select the virtual adapter from the pool\"></a>(3) Select the virtual adapter from the pool</h2><p>It is simple to add an SR-IOV NIC, as follow:</p>\n<p><img src=\"/csr1kv-kvm-Ubuntu20-04-md/pic1-sriov-pool.png\" alt=\"SRIOV Adapter Pool\"></p>\n<p>This is equivalent to the following XML:</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">interface</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;network&#x27;</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">mac</span> <span class=\"attr\">address</span>=<span class=\"string\">&#x27;52:54:00:0b:a5:2e&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">source</span> <span class=\"attr\">network</span>=<span class=\"string\">&#x27;ens1f0_sriov_pool&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">model</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;virtio&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">domain</span>=<span class=\"string\">&#x27;0x0000&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0x02&#x27;</span> <span class=\"attr\">slot</span>=<span class=\"string\">&#x27;0x00&#x27;</span> <span class=\"attr\">function</span>=<span class=\"string\">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">interface</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>After the VM powered on, the network info is as follow:<br>virsh dumpxml CSR1KV-1</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">interface</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;hostdev&#x27;</span> <span class=\"attr\">managed</span>=<span class=\"string\">&#x27;yes&#x27;</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">mac</span> <span class=\"attr\">address</span>=<span class=\"string\">&#x27;52:54:00:0b:a5:2e&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">driver</span> <span class=\"attr\">name</span>=<span class=\"string\">&#x27;vfio&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">source</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">domain</span>=<span class=\"string\">&#x27;0x0000&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0x5e&#x27;</span> <span class=\"attr\">slot</span>=<span class=\"string\">&#x27;0x02&#x27;</span> <span class=\"attr\">function</span>=<span class=\"string\">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">source</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">model</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;virtio&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">alias</span> <span class=\"attr\">name</span>=<span class=\"string\">&#x27;hostdev0&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">domain</span>=<span class=\"string\">&#x27;0x0000&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0x02&#x27;</span> <span class=\"attr\">slot</span>=<span class=\"string\">&#x27;0x00&#x27;</span> <span class=\"attr\">function</span>=<span class=\"string\">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">interface</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<h1 id=\"Create-the-CSR1KV-VM-from-virt-manager\"><a href=\"#Create-the-CSR1KV-VM-from-virt-manager\" class=\"headerlink\" title=\"Create the CSR1KV VM from virt-manager\"></a>Create the CSR1KV VM from virt-manager</h1><p>From the virt-manager, create a CSR1KV virtual machine step by step, and choose the virtual network interface from the SR-IOV pool.</p>\n<p><img src=\"/csr1kv-kvm-Ubuntu20-04-md/virt-manager-step1.png\" alt=\"Virt-manager step 1\"></p>\n<p><img src=\"/csr1kv-kvm-Ubuntu20-04-md/virt-manager-step2.png\" alt=\"Virt-manager Step 2\"></p>\n<p><img src=\"/csr1kv-kvm-Ubuntu20-04-md/virt-manager-step2-2.png\" alt=\"Virt-manager Step2-2\"></p>\n<p><img src=\"/csr1kv-kvm-Ubuntu20-04-md/virt-manager-step3.png\" alt=\"Virt-manager Step 3\"></p>\n<p><img src=\"/csr1kv-kvm-Ubuntu20-04-md/virt-manager-step4.png\" alt=\"Virt-manager Step 4\"></p>\n<p>Note: The first interface of csr1kv-1 is configured to <strong>macvtap Bridge mode</strong>, so you do not need to create a Linux bridge. However, csr1kv-1 can not communicate to the Linux host through this interface, but it can go out of the Linux host through the eno1. This is a known issue with macvtap.</p>\n<p><img src=\"/csr1kv-kvm-Ubuntu20-04-md/add-sriov-pool.png\" alt=\"Virt-manager Step 5\"></p>\n<p>After select the Virtual Network Interface, click the <strong>Begin Installation</strong>, and you can shut down the virtual machine.<br>The actions above will create the <strong>csr1kv-1.xml</strong> file under the directory: <strong>&#x2F;etc&#x2F;libvirtd&#x2F;qemu&#x2F;</strong></p>\n<h1 id=\"KVM-Performance-Tunning\"><a href=\"#KVM-Performance-Tunning\" class=\"headerlink\" title=\"KVM Performance Tunning\"></a>KVM Performance Tunning</h1><p>KVM performance tuning are related to NUMA, Memory Hugepage and vCPU pinning. The main reference is Redhat Linux 7 PERFORMANCE TUNING GUIDE</p>\n<p>We will use <strong>virsh edit csr1kv-1</strong> to do the performance tuning.</p>\n<h2 id=\"1-Check-the-capability-of-the-platform\"><a href=\"#1-Check-the-capability-of-the-platform\" class=\"headerlink\" title=\"(1) Check the capability of the platform\"></a>(1) Check the capability of the platform</h2><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ubuntu@ubuntu-kvm:~$ virsh nodeinfo</span><br><span class=\"line\">CPU model:           x86_64</span><br><span class=\"line\">CPU(s):              88</span><br><span class=\"line\">CPU frequency:       1000 MHz</span><br><span class=\"line\">CPU socket(s):       1</span><br><span class=\"line\">Core(s) per socket:  22</span><br><span class=\"line\">Thread(s) per core:  2</span><br><span class=\"line\">NUMA cell(s):        2</span><br><span class=\"line\">Memory size:         394929928 KiB</span><br></pre></td></tr></table></figure>\n\n<p>[1]:ubuntu@ubuntu-kvm:~$ virsh capabilities</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">capabilities</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">host</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">uuid</span>&gt;</span>a24f9760-48f1-f34e-a001-a848f08df7bb<span class=\"tag\">&lt;/<span class=\"name\">uuid</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">cpu</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">arch</span>&gt;</span>x86_64<span class=\"tag\">&lt;/<span class=\"name\">arch</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">model</span>&gt;</span>Cascadelake-Server-noTSX<span class=\"tag\">&lt;/<span class=\"name\">model</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">vendor</span>&gt;</span>Intel<span class=\"tag\">&lt;/<span class=\"name\">vendor</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">microcode</span> <span class=\"attr\">version</span>=<span class=\"string\">&#x27;83898371&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">counter</span> <span class=\"attr\">name</span>=<span class=\"string\">&#x27;tsc&#x27;</span> <span class=\"attr\">frequency</span>=<span class=\"string\">&#x27;2095078000&#x27;</span> <span class=\"attr\">scaling</span>=<span class=\"string\">&#x27;no&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">topology</span> <span class=\"attr\">sockets</span>=<span class=\"string\">&#x27;1&#x27;</span> <span class=\"attr\">cores</span>=<span class=\"string\">&#x27;22&#x27;</span> <span class=\"attr\">threads</span>=<span class=\"string\">&#x27;2&#x27;</span>/&gt;</span></span><br><span class=\"line\">...</span><br></pre></td></tr></table></figure>\n\n<p>From the outputs, we can get the cores of CPU, the NUMA info and the hugepages.</p>\n<h2 id=\"2-NUMA-Info\"><a href=\"#2-NUMA-Info\" class=\"headerlink\" title=\"(2) NUMA Info\"></a>(2) NUMA Info</h2><figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ubuntu@ubuntu-kvm:~$ numactl --hardware</span><br><span class=\"line\">available: 2 nodes (0-1)</span><br><span class=\"line\">node 0 cpus: 0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65</span><br><span class=\"line\">node 0 size: 192172 MB</span><br><span class=\"line\">node 0 free: 152956 MB</span><br><span class=\"line\">node 1 cpus: 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87</span><br><span class=\"line\">node 1 size: 193500 MB</span><br><span class=\"line\">node 1 free: 158037 MB</span><br><span class=\"line\">node distances:</span><br><span class=\"line\">node   0   1</span><br><span class=\"line\">  0:  10  21</span><br><span class=\"line\">  1:  21  10 </span><br></pre></td></tr></table></figure>\n\n<p>Two CPUs, each has 192GB memory, the NUMA node are node 0 and node 1.</p>\n<p>You can also check the NUMA info of the NIC, as follow:</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ubuntu@ubuntu-kvm:~$ sudo lspci -vv | grep Ethernet -A 6</span><br><span class=\"line\">5e:00.0 Ethernet controller: Intel Corporation Ethernet Controller XXV710 for 25GbE SFP28 (rev 02)</span><br><span class=\"line\">    Subsystem: Cisco Systems Inc Ethernet Network Adapter XXV710</span><br><span class=\"line\">    Control: I/O- Mem+ BusMaster+ SpecCycle- MemWINV- VGASnoop- ParErr+ Stepping- SERR+ FastB2B- DisINTx+</span><br><span class=\"line\">    Status: Cap+ 66MHz- UDF- FastB2B- ParErr- DEVSEL=fast &gt;TAbort- &lt;TAbort- &lt;MAbort- &gt;SERR- &lt;PERR- INTx-</span><br><span class=\"line\">    Latency: 0, Cache Line Size: 32 bytes</span><br><span class=\"line\">    Interrupt: pin A routed to IRQ 137</span><br><span class=\"line\">    NUMA node: 0</span><br><span class=\"line\"><span class=\"meta prompt_\"></span></span><br><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">Or you can find the numa infor from udevadm.</span></span><br><span class=\"line\">ubuntu@ubuntu-kvm:~$ sudo udevadm info -ap /sys/class/net/ens1f0 | grep numa</span><br><span class=\"line\">    ATTRS&#123;numa_node&#125;==&quot;0&quot;</span><br><span class=\"line\">    ATTRS&#123;numa_node&#125;==&quot;0&quot;</span><br></pre></td></tr></table></figure>\n\n<p>If the memory and NICs are all on numa_node 0, that would be more efficient. Please check the server’s PCI-E slots mapping with the CPU slots.</p>\n<h2 id=\"3-HugePage-and-Transparent-Hugepage\"><a href=\"#3-HugePage-and-Transparent-Hugepage\" class=\"headerlink\" title=\"(3) HugePage and Transparent Hugepage\"></a>(3) HugePage and Transparent Hugepage</h2><p>To check the memory info</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ubuntu@ubuntu-kvm:~$ cat /proc/meminfo | grep Huge</span><br><span class=\"line\">AnonHugePages:    133120 kB</span><br><span class=\"line\">ShmemHugePages:        0 kB</span><br><span class=\"line\">FileHugePages:         0 kB</span><br><span class=\"line\">HugePages_Total:      64</span><br><span class=\"line\">HugePages_Free:       56</span><br><span class=\"line\">HugePages_Rsvd:        0</span><br><span class=\"line\">HugePages_Surp:        0</span><br><span class=\"line\">Hugepagesize:    1048576 kB</span><br><span class=\"line\">Hugetlb:        67108864 kB</span><br></pre></td></tr></table></figure>\n\n<p>You can change the hugepages on the run time：</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ubuntu@ubuntu-kvm:~$ cat /sys/devices/system/node/node0/hugepages/hugepages-1048576kB/nr_hugepages</span><br><span class=\"line\">32</span><br><span class=\"line\">sudo su -     // switch to root user.</span><br><span class=\"line\">root@ubuntu-kvm:~# echo 64 &gt; /sys/devices/system/node/node0/hugepages/hugepages-1048576kB/nr_hugepages</span><br><span class=\"line\">root@ubuntu-kvm:~# echo 64 &gt; /sys/devices/system/node/node1/hugepages/hugepages-1048576kB/nr_hugepages</span><br></pre></td></tr></table></figure>\n\n<p>Check and configure the transparent_hugepage:</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">root@ubuntu-kvm:~# echo always &gt; /sys/kernel/mm/transparent_hugepage/enabled</span><br><span class=\"line\">cat /sys/kernel/mm/transparent_hugepage/enabled</span><br><span class=\"line\">[always] madvise never</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"4-vCPU-Pinning\"><a href=\"#4-vCPU-Pinning\" class=\"headerlink\" title=\"(4) vCPU Pinning\"></a>(4) vCPU Pinning</h2><p>vCPU pinning can improve the cache meet rate and improve the performance.<br>You can check the vcpu pinning.<br><strong>virsh vcpuinfo csr1kv-1</strong></p>\n<h2 id=\"5-Edit-the-XML-file-of-the-CSR1KV\"><a href=\"#5-Edit-the-XML-file-of-the-CSR1KV\" class=\"headerlink\" title=\"(5) Edit the XML file of the CSR1KV\"></a>(5) Edit the XML file of the CSR1KV</h2><p>Run virsh edit csr1kv-1 to edit the parameters.<br>Please pay attention to the following texts, other parameters might be different.</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">memoryBacking</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">hugepages</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">page</span> <span class=\"attr\">size</span>=<span class=\"string\">&#x27;1048576&#x27;</span> <span class=\"attr\">unit</span>=<span class=\"string\">&#x27;KiB&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">hugepages</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">locked</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">nosharepages</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">memoryBacking</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">vcpu</span> <span class=\"attr\">placement</span>=<span class=\"string\">&#x27;static&#x27;</span>&gt;</span>8<span class=\"tag\">&lt;/<span class=\"name\">vcpu</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">cputune</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">vcpupin</span> <span class=\"attr\">vcpu</span>=<span class=\"string\">&#x27;0&#x27;</span> <span class=\"attr\">cpuset</span>=<span class=\"string\">&#x27;1&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">vcpupin</span> <span class=\"attr\">vcpu</span>=<span class=\"string\">&#x27;1&#x27;</span> <span class=\"attr\">cpuset</span>=<span class=\"string\">&#x27;2&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">vcpupin</span> <span class=\"attr\">vcpu</span>=<span class=\"string\">&#x27;2&#x27;</span> <span class=\"attr\">cpuset</span>=<span class=\"string\">&#x27;3&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">vcpupin</span> <span class=\"attr\">vcpu</span>=<span class=\"string\">&#x27;3&#x27;</span> <span class=\"attr\">cpuset</span>=<span class=\"string\">&#x27;4&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">vcpupin</span> <span class=\"attr\">vcpu</span>=<span class=\"string\">&#x27;4&#x27;</span> <span class=\"attr\">cpuset</span>=<span class=\"string\">&#x27;5&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">vcpupin</span> <span class=\"attr\">vcpu</span>=<span class=\"string\">&#x27;5&#x27;</span> <span class=\"attr\">cpuset</span>=<span class=\"string\">&#x27;6&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">vcpupin</span> <span class=\"attr\">vcpu</span>=<span class=\"string\">&#x27;6&#x27;</span> <span class=\"attr\">cpuset</span>=<span class=\"string\">&#x27;7&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">vcpupin</span> <span class=\"attr\">vcpu</span>=<span class=\"string\">&#x27;7&#x27;</span> <span class=\"attr\">cpuset</span>=<span class=\"string\">&#x27;8&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">emulatorpin</span> <span class=\"attr\">cpuset</span>=<span class=\"string\">&#x27;45-52&#x27;</span>/&gt;</span> <span class=\"comment\">&lt;!-- If Hyper-threading were enabled --&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">cputune</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">numatune</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">memory</span> <span class=\"attr\">mode</span>=<span class=\"string\">&#x27;strict&#x27;</span> <span class=\"attr\">nodeset</span>=<span class=\"string\">&#x27;0&#x27;</span>/&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">numatune</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">cpu</span> <span class=\"attr\">mode</span>=<span class=\"string\">&#x27;host-passthrough&#x27;</span> <span class=\"attr\">check</span>=<span class=\"string\">&#x27;none&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">memballoon</span> <span class=\"attr\">model</span>=<span class=\"string\">&#x27;none&#x27;</span>/&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>Please note that, if hyper-threading is enabled in BIOS setting, the parameter “emulatorpin” should be set, the cpuset are from the “virsh capabilities”, for example, siblings&#x3D;’1,45’. When the core 1 is pinned, core 45 should be set in emulatorpin.</p>\n<p>From the guide <a href=\"https://libvirt.org/formatdomain.html\">https://libvirt.org/formatdomain.html</a> and <a href=\"https://libvirt.org/kbase/kvm-realtime.html\">https://libvirt.org/kbase/kvm-realtime.html</a> we set the CPU and memory tuning parameters as the highlighted text.</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">domain</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;kvm&#x27;</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">name</span>&gt;</span>csr1kv-1<span class=\"tag\">&lt;/<span class=\"name\">name</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">uuid</span>&gt;</span>83f90c1c-f0ea-4298-bcdf-3d676de2aeb4<span class=\"tag\">&lt;/<span class=\"name\">uuid</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">metadata</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">libosinfo:libosinfo</span> <span class=\"attr\">xmlns:libosinfo</span>=<span class=\"string\">&quot;http://libosinfo.org/xmlns/libvirt/domain/1.0&quot;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">libosinfo:os</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;http://centos.org/centos/7.0&quot;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">libosinfo:libosinfo</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">metadata</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">memory</span> <span class=\"attr\">unit</span>=<span class=\"string\">&#x27;KiB&#x27;</span>&gt;</span>8388608<span class=\"tag\">&lt;/<span class=\"name\">memory</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">currentMemory</span> <span class=\"attr\">unit</span>=<span class=\"string\">&#x27;KiB&#x27;</span>&gt;</span>8388608<span class=\"tag\">&lt;/<span class=\"name\">currentMemory</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">memoryBacking</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">hugepages</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">page</span> <span class=\"attr\">size</span>=<span class=\"string\">&#x27;1048576&#x27;</span> <span class=\"attr\">unit</span>=<span class=\"string\">&#x27;KiB&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">hugepages</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">locked</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">nosharepages</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">memoryBacking</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">vcpu</span> <span class=\"attr\">placement</span>=<span class=\"string\">&#x27;static&#x27;</span>&gt;</span>8<span class=\"tag\">&lt;/<span class=\"name\">vcpu</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">cputune</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">vcpupin</span> <span class=\"attr\">vcpu</span>=<span class=\"string\">&#x27;0&#x27;</span> <span class=\"attr\">cpuset</span>=<span class=\"string\">&#x27;1&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">vcpupin</span> <span class=\"attr\">vcpu</span>=<span class=\"string\">&#x27;1&#x27;</span> <span class=\"attr\">cpuset</span>=<span class=\"string\">&#x27;2&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">vcpupin</span> <span class=\"attr\">vcpu</span>=<span class=\"string\">&#x27;2&#x27;</span> <span class=\"attr\">cpuset</span>=<span class=\"string\">&#x27;3&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">vcpupin</span> <span class=\"attr\">vcpu</span>=<span class=\"string\">&#x27;3&#x27;</span> <span class=\"attr\">cpuset</span>=<span class=\"string\">&#x27;4&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">vcpupin</span> <span class=\"attr\">vcpu</span>=<span class=\"string\">&#x27;4&#x27;</span> <span class=\"attr\">cpuset</span>=<span class=\"string\">&#x27;5&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">vcpupin</span> <span class=\"attr\">vcpu</span>=<span class=\"string\">&#x27;5&#x27;</span> <span class=\"attr\">cpuset</span>=<span class=\"string\">&#x27;6&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">vcpupin</span> <span class=\"attr\">vcpu</span>=<span class=\"string\">&#x27;6&#x27;</span> <span class=\"attr\">cpuset</span>=<span class=\"string\">&#x27;7&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">vcpupin</span> <span class=\"attr\">vcpu</span>=<span class=\"string\">&#x27;7&#x27;</span> <span class=\"attr\">cpuset</span>=<span class=\"string\">&#x27;8&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">emulatorpin</span> <span class=\"attr\">cpuset</span>=<span class=\"string\">&#x27;45-52&#x27;</span>/&gt;</span> <span class=\"comment\">&lt;!-- If Hyper-threading were enabled --&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">cputune</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">numatune</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">memory</span> <span class=\"attr\">mode</span>=<span class=\"string\">&#x27;strict&#x27;</span> <span class=\"attr\">nodeset</span>=<span class=\"string\">&#x27;0&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">numatune</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">os</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">type</span> <span class=\"attr\">arch</span>=<span class=\"string\">&#x27;x86_64&#x27;</span> <span class=\"attr\">machine</span>=<span class=\"string\">&#x27;pc-q35-4.2&#x27;</span>&gt;</span>hvm<span class=\"tag\">&lt;/<span class=\"name\">type</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">boot</span> <span class=\"attr\">dev</span>=<span class=\"string\">&#x27;hd&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">os</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">features</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">acpi</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">apic</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">vmport</span> <span class=\"attr\">state</span>=<span class=\"string\">&#x27;off&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">features</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">cpu</span> <span class=\"attr\">mode</span>=<span class=\"string\">&#x27;host-passthrough&#x27;</span> <span class=\"attr\">check</span>=<span class=\"string\">&#x27;none&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">clock</span> <span class=\"attr\">offset</span>=<span class=\"string\">&#x27;utc&#x27;</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">timer</span> <span class=\"attr\">name</span>=<span class=\"string\">&#x27;rtc&#x27;</span> <span class=\"attr\">tickpolicy</span>=<span class=\"string\">&#x27;catchup&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">timer</span> <span class=\"attr\">name</span>=<span class=\"string\">&#x27;pit&#x27;</span> <span class=\"attr\">tickpolicy</span>=<span class=\"string\">&#x27;delay&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">timer</span> <span class=\"attr\">name</span>=<span class=\"string\">&#x27;hpet&#x27;</span> <span class=\"attr\">present</span>=<span class=\"string\">&#x27;no&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">clock</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">on_poweroff</span>&gt;</span>destroy<span class=\"tag\">&lt;/<span class=\"name\">on_poweroff</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">on_reboot</span>&gt;</span>restart<span class=\"tag\">&lt;/<span class=\"name\">on_reboot</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">on_crash</span>&gt;</span>destroy<span class=\"tag\">&lt;/<span class=\"name\">on_crash</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">pm</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">suspend-to-mem</span> <span class=\"attr\">enabled</span>=<span class=\"string\">&#x27;no&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">suspend-to-disk</span> <span class=\"attr\">enabled</span>=<span class=\"string\">&#x27;no&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">pm</span>&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;<span class=\"name\">devices</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">emulator</span>&gt;</span>/usr/bin/qemu-system-x86_64<span class=\"tag\">&lt;/<span class=\"name\">emulator</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">disk</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;file&#x27;</span> <span class=\"attr\">device</span>=<span class=\"string\">&#x27;disk&#x27;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">driver</span> <span class=\"attr\">name</span>=<span class=\"string\">&#x27;qemu&#x27;</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;qcow2&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">source</span> <span class=\"attr\">file</span>=<span class=\"string\">&#x27;/var/lib/libvirt/images/csr1000v-universalk9.17.02.01v.qcow2&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">target</span> <span class=\"attr\">dev</span>=<span class=\"string\">&#x27;vda&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;virtio&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">domain</span>=<span class=\"string\">&#x27;0x0000&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0x05&#x27;</span> <span class=\"attr\">slot</span>=<span class=\"string\">&#x27;0x00&#x27;</span> <span class=\"attr\">function</span>=<span class=\"string\">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">disk</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">controller</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;usb&#x27;</span> <span class=\"attr\">index</span>=<span class=\"string\">&#x27;0&#x27;</span> <span class=\"attr\">model</span>=<span class=\"string\">&#x27;qemu-xhci&#x27;</span> <span class=\"attr\">ports</span>=<span class=\"string\">&#x27;15&#x27;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">domain</span>=<span class=\"string\">&#x27;0x0000&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0x03&#x27;</span> <span class=\"attr\">slot</span>=<span class=\"string\">&#x27;0x00&#x27;</span> <span class=\"attr\">function</span>=<span class=\"string\">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">controller</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">controller</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;sata&#x27;</span> <span class=\"attr\">index</span>=<span class=\"string\">&#x27;0&#x27;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">domain</span>=<span class=\"string\">&#x27;0x0000&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0x00&#x27;</span> <span class=\"attr\">slot</span>=<span class=\"string\">&#x27;0x1f&#x27;</span> <span class=\"attr\">function</span>=<span class=\"string\">&#x27;0x2&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">controller</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">controller</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">index</span>=<span class=\"string\">&#x27;0&#x27;</span> <span class=\"attr\">model</span>=<span class=\"string\">&#x27;pcie-root&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">controller</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">index</span>=<span class=\"string\">&#x27;1&#x27;</span> <span class=\"attr\">model</span>=<span class=\"string\">&#x27;pcie-root-port&#x27;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">model</span> <span class=\"attr\">name</span>=<span class=\"string\">&#x27;pcie-root-port&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">target</span> <span class=\"attr\">chassis</span>=<span class=\"string\">&#x27;1&#x27;</span> <span class=\"attr\">port</span>=<span class=\"string\">&#x27;0x10&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">domain</span>=<span class=\"string\">&#x27;0x0000&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0x00&#x27;</span> <span class=\"attr\">slot</span>=<span class=\"string\">&#x27;0x02&#x27;</span> <span class=\"attr\">function</span>=<span class=\"string\">&#x27;0x0&#x27;</span> <span class=\"attr\">multifunction</span>=<span class=\"string\">&#x27;on&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">controller</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">controller</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">index</span>=<span class=\"string\">&#x27;2&#x27;</span> <span class=\"attr\">model</span>=<span class=\"string\">&#x27;pcie-root-port&#x27;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">model</span> <span class=\"attr\">name</span>=<span class=\"string\">&#x27;pcie-root-port&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">target</span> <span class=\"attr\">chassis</span>=<span class=\"string\">&#x27;2&#x27;</span> <span class=\"attr\">port</span>=<span class=\"string\">&#x27;0x11&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">domain</span>=<span class=\"string\">&#x27;0x0000&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0x00&#x27;</span> <span class=\"attr\">slot</span>=<span class=\"string\">&#x27;0x02&#x27;</span> <span class=\"attr\">function</span>=<span class=\"string\">&#x27;0x1&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">controller</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">controller</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">index</span>=<span class=\"string\">&#x27;3&#x27;</span> <span class=\"attr\">model</span>=<span class=\"string\">&#x27;pcie-root-port&#x27;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">model</span> <span class=\"attr\">name</span>=<span class=\"string\">&#x27;pcie-root-port&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">target</span> <span class=\"attr\">chassis</span>=<span class=\"string\">&#x27;3&#x27;</span> <span class=\"attr\">port</span>=<span class=\"string\">&#x27;0x12&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">domain</span>=<span class=\"string\">&#x27;0x0000&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0x00&#x27;</span> <span class=\"attr\">slot</span>=<span class=\"string\">&#x27;0x02&#x27;</span> <span class=\"attr\">function</span>=<span class=\"string\">&#x27;0x2&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">controller</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">controller</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">index</span>=<span class=\"string\">&#x27;4&#x27;</span> <span class=\"attr\">model</span>=<span class=\"string\">&#x27;pcie-root-port&#x27;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">model</span> <span class=\"attr\">name</span>=<span class=\"string\">&#x27;pcie-root-port&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">target</span> <span class=\"attr\">chassis</span>=<span class=\"string\">&#x27;4&#x27;</span> <span class=\"attr\">port</span>=<span class=\"string\">&#x27;0x13&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">domain</span>=<span class=\"string\">&#x27;0x0000&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0x00&#x27;</span> <span class=\"attr\">slot</span>=<span class=\"string\">&#x27;0x02&#x27;</span> <span class=\"attr\">function</span>=<span class=\"string\">&#x27;0x3&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">controller</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">controller</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">index</span>=<span class=\"string\">&#x27;5&#x27;</span> <span class=\"attr\">model</span>=<span class=\"string\">&#x27;pcie-root-port&#x27;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">model</span> <span class=\"attr\">name</span>=<span class=\"string\">&#x27;pcie-root-port&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">target</span> <span class=\"attr\">chassis</span>=<span class=\"string\">&#x27;5&#x27;</span> <span class=\"attr\">port</span>=<span class=\"string\">&#x27;0x14&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">domain</span>=<span class=\"string\">&#x27;0x0000&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0x00&#x27;</span> <span class=\"attr\">slot</span>=<span class=\"string\">&#x27;0x02&#x27;</span> <span class=\"attr\">function</span>=<span class=\"string\">&#x27;0x4&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">controller</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">controller</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">index</span>=<span class=\"string\">&#x27;6&#x27;</span> <span class=\"attr\">model</span>=<span class=\"string\">&#x27;pcie-root-port&#x27;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">model</span> <span class=\"attr\">name</span>=<span class=\"string\">&#x27;pcie-root-port&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">target</span> <span class=\"attr\">chassis</span>=<span class=\"string\">&#x27;6&#x27;</span> <span class=\"attr\">port</span>=<span class=\"string\">&#x27;0x15&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">domain</span>=<span class=\"string\">&#x27;0x0000&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0x00&#x27;</span> <span class=\"attr\">slot</span>=<span class=\"string\">&#x27;0x02&#x27;</span> <span class=\"attr\">function</span>=<span class=\"string\">&#x27;0x5&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">controller</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">controller</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">index</span>=<span class=\"string\">&#x27;7&#x27;</span> <span class=\"attr\">model</span>=<span class=\"string\">&#x27;pcie-root-port&#x27;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">model</span> <span class=\"attr\">name</span>=<span class=\"string\">&#x27;pcie-root-port&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">target</span> <span class=\"attr\">chassis</span>=<span class=\"string\">&#x27;7&#x27;</span> <span class=\"attr\">port</span>=<span class=\"string\">&#x27;0x16&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">domain</span>=<span class=\"string\">&#x27;0x0000&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0x00&#x27;</span> <span class=\"attr\">slot</span>=<span class=\"string\">&#x27;0x02&#x27;</span> <span class=\"attr\">function</span>=<span class=\"string\">&#x27;0x6&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">controller</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">controller</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">index</span>=<span class=\"string\">&#x27;8&#x27;</span> <span class=\"attr\">model</span>=<span class=\"string\">&#x27;pcie-root-port&#x27;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">model</span> <span class=\"attr\">name</span>=<span class=\"string\">&#x27;pcie-root-port&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">target</span> <span class=\"attr\">chassis</span>=<span class=\"string\">&#x27;8&#x27;</span> <span class=\"attr\">port</span>=<span class=\"string\">&#x27;0x17&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">domain</span>=<span class=\"string\">&#x27;0x0000&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0x00&#x27;</span> <span class=\"attr\">slot</span>=<span class=\"string\">&#x27;0x02&#x27;</span> <span class=\"attr\">function</span>=<span class=\"string\">&#x27;0x7&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">controller</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">controller</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;virtio-serial&#x27;</span> <span class=\"attr\">index</span>=<span class=\"string\">&#x27;0&#x27;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">domain</span>=<span class=\"string\">&#x27;0x0000&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0x04&#x27;</span> <span class=\"attr\">slot</span>=<span class=\"string\">&#x27;0x00&#x27;</span> <span class=\"attr\">function</span>=<span class=\"string\">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">controller</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">interface</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;direct&#x27;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">mac</span> <span class=\"attr\">address</span>=<span class=\"string\">&#x27;52:54:00:69:ec:73&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">source</span> <span class=\"attr\">dev</span>=<span class=\"string\">&#x27;eno1&#x27;</span> <span class=\"attr\">mode</span>=<span class=\"string\">&#x27;bridge&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">model</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;virtio&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">domain</span>=<span class=\"string\">&#x27;0x0000&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0x01&#x27;</span> <span class=\"attr\">slot</span>=<span class=\"string\">&#x27;0x00&#x27;</span> <span class=\"attr\">function</span>=<span class=\"string\">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">interface</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">interface</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;network&#x27;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">mac</span> <span class=\"attr\">address</span>=<span class=\"string\">&#x27;52:54:00:0b:a5:2e&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">source</span> <span class=\"attr\">network</span>=<span class=\"string\">&#x27;ens1f0_sriov_pool&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">model</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;virtio&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">domain</span>=<span class=\"string\">&#x27;0x0000&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0x02&#x27;</span> <span class=\"attr\">slot</span>=<span class=\"string\">&#x27;0x00&#x27;</span> <span class=\"attr\">function</span>=<span class=\"string\">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">interface</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">interface</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;network&#x27;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">mac</span> <span class=\"attr\">address</span>=<span class=\"string\">&#x27;52:54:00:bd:9f:54&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">source</span> <span class=\"attr\">network</span>=<span class=\"string\">&#x27;ens1f1_sriov_pool&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">model</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;virtio&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">domain</span>=<span class=\"string\">&#x27;0x0000&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0x08&#x27;</span> <span class=\"attr\">slot</span>=<span class=\"string\">&#x27;0x00&#x27;</span> <span class=\"attr\">function</span>=<span class=\"string\">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">interface</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">serial</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pty&#x27;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">target</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;isa-serial&#x27;</span> <span class=\"attr\">port</span>=<span class=\"string\">&#x27;0&#x27;</span>&gt;</span></span><br><span class=\"line\">        <span class=\"tag\">&lt;<span class=\"name\">model</span> <span class=\"attr\">name</span>=<span class=\"string\">&#x27;isa-serial&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;/<span class=\"name\">target</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">serial</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">console</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pty&#x27;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">target</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;serial&#x27;</span> <span class=\"attr\">port</span>=<span class=\"string\">&#x27;0&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">console</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">channel</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;unix&#x27;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">target</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;virtio&#x27;</span> <span class=\"attr\">name</span>=<span class=\"string\">&#x27;org.qemu.guest_agent.0&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;virtio-serial&#x27;</span> <span class=\"attr\">controller</span>=<span class=\"string\">&#x27;0&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0&#x27;</span> <span class=\"attr\">port</span>=<span class=\"string\">&#x27;1&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">channel</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">channel</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;spicevmc&#x27;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">target</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;virtio&#x27;</span> <span class=\"attr\">name</span>=<span class=\"string\">&#x27;com.redhat.spice.0&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;virtio-serial&#x27;</span> <span class=\"attr\">controller</span>=<span class=\"string\">&#x27;0&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0&#x27;</span> <span class=\"attr\">port</span>=<span class=\"string\">&#x27;2&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">channel</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;mouse&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;ps2&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;keyboard&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;ps2&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">graphics</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;spice&#x27;</span> <span class=\"attr\">autoport</span>=<span class=\"string\">&#x27;yes&#x27;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">listen</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;address&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">image</span> <span class=\"attr\">compression</span>=<span class=\"string\">&#x27;off&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">graphics</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">video</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">model</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;qxl&#x27;</span> <span class=\"attr\">ram</span>=<span class=\"string\">&#x27;65536&#x27;</span> <span class=\"attr\">vram</span>=<span class=\"string\">&#x27;65536&#x27;</span> <span class=\"attr\">vgamem</span>=<span class=\"string\">&#x27;16384&#x27;</span> <span class=\"attr\">heads</span>=<span class=\"string\">&#x27;1&#x27;</span> <span class=\"attr\">primary</span>=<span class=\"string\">&#x27;yes&#x27;</span>/&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;pci&#x27;</span> <span class=\"attr\">domain</span>=<span class=\"string\">&#x27;0x0000&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0x00&#x27;</span> <span class=\"attr\">slot</span>=<span class=\"string\">&#x27;0x01&#x27;</span> <span class=\"attr\">function</span>=<span class=\"string\">&#x27;0x0&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">video</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">redirdev</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;usb&#x27;</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;spicevmc&#x27;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;usb&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0&#x27;</span> <span class=\"attr\">port</span>=<span class=\"string\">&#x27;2&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">redirdev</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">redirdev</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;usb&#x27;</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;spicevmc&#x27;</span>&gt;</span></span><br><span class=\"line\">      <span class=\"tag\">&lt;<span class=\"name\">address</span> <span class=\"attr\">type</span>=<span class=\"string\">&#x27;usb&#x27;</span> <span class=\"attr\">bus</span>=<span class=\"string\">&#x27;0&#x27;</span> <span class=\"attr\">port</span>=<span class=\"string\">&#x27;3&#x27;</span>/&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;/<span class=\"name\">redirdev</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">memballoon</span> <span class=\"attr\">model</span>=<span class=\"string\">&#x27;none&#x27;</span>/&gt;</span></span><br><span class=\"line\">  <span class=\"tag\">&lt;/<span class=\"name\">devices</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">domain</span>&gt;</span></span><br></pre></td></tr></table></figure>\n\n<p>The parameters are from <a href=\"https://www.cisco.com/c/en/us/td/docs/routers/csr1000/software/configuration/b_CSR1000v_Configuration_Guide/b_CSR1000v_Configuration_Guide_chapter_0101.html#con_1313827\">Cisco CSR 1000v and Cisco ISRv Software Configuration Guide</a><br>After you install the CSR1000v, and edit the XML file, you can run virsh to create the csr1kv.</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cd /etc/libvirtd/qemu</span><br><span class=\"line\">virsh define csr1kv-1.xml</span><br><span class=\"line\">virsh start csr1kv-1</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"6-Check-CSR1000v’s-tunning\"><a href=\"#6-Check-CSR1000v’s-tunning\" class=\"headerlink\" title=\"(6) Check CSR1000v’s tunning\"></a>(6) Check CSR1000v’s tunning</h2><p>ubuntu@ubuntu-kvm:&#x2F;etc&#x2F;libvirt&#x2F;qemu$ virsh list</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> Id   Name       State</span><br><span class=\"line\">--------------------------</span><br><span class=\"line\"></span><br><span class=\"line\"> 1    csr1kv-1   running</span><br><span class=\"line\"></span><br><span class=\"line\">ubuntu@ubuntu-kvm:/etc/libvirt/qemu$ virsh vcpuinfo 1</span><br><span class=\"line\">VCPU:           0</span><br><span class=\"line\">CPU:            1</span><br><span class=\"line\">State:          running</span><br><span class=\"line\">CPU time:       167.0s</span><br><span class=\"line\">CPU Affinity:   -y--------------------------------------------------------------------------------------</span><br><span class=\"line\"></span><br><span class=\"line\">VCPU:           1</span><br><span class=\"line\">CPU:            2</span><br><span class=\"line\">State:          running</span><br><span class=\"line\">CPU time:       193.3s</span><br><span class=\"line\">CPU Affinity:   --y-------------------------------------------------------------------------------------</span><br><span class=\"line\"></span><br><span class=\"line\">VCPU:           2</span><br><span class=\"line\">CPU:            3</span><br><span class=\"line\">State:          running</span><br><span class=\"line\">CPU time:       152.5s</span><br><span class=\"line\">CPU Affinity:   ---y------------------------------------------------------------------------------------</span><br><span class=\"line\"></span><br><span class=\"line\">VCPU:           3</span><br><span class=\"line\">CPU:            4</span><br><span class=\"line\">State:          running</span><br><span class=\"line\">CPU time:       174.3s</span><br><span class=\"line\">CPU Affinity:   ----y-----------------------------------------------------------------------------------</span><br><span class=\"line\"></span><br><span class=\"line\">VCPU:           4</span><br><span class=\"line\">CPU:            5</span><br><span class=\"line\">State:          running</span><br><span class=\"line\">CPU time:       260.6s</span><br><span class=\"line\">CPU Affinity:   -----y----------------------------------------------------------------------------------</span><br><span class=\"line\"></span><br><span class=\"line\">VCPU:           5</span><br><span class=\"line\">CPU:            6</span><br><span class=\"line\">State:          running</span><br><span class=\"line\">CPU time:       386.0s</span><br><span class=\"line\">CPU Affinity:   ------y---------------------------------------------------------------------------------</span><br><span class=\"line\"></span><br><span class=\"line\">VCPU:           6</span><br><span class=\"line\">CPU:            7</span><br><span class=\"line\">State:          running</span><br><span class=\"line\">CPU time:       2189.9s</span><br><span class=\"line\">CPU Affinity:   -------y--------------------------------------------------------------------------------</span><br><span class=\"line\"></span><br><span class=\"line\">VCPU:           7</span><br><span class=\"line\">CPU:            8</span><br><span class=\"line\">State:          running</span><br><span class=\"line\">CPU time:       2192.2s</span><br><span class=\"line\">CPU Affinity:   --------y-------------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>\n\n\n<p>From the above outputs, we can find that the vCPUa are pinned to NO. 1 to 8 CPU cores.</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ubuntu@ubuntu-kvm:~$ sudo numastat -c qemu</span><br><span class=\"line\">Per-node process memory usage (in MBs)</span><br><span class=\"line\">PID              Node 0 Node 1 Total</span><br><span class=\"line\"></span><br><span class=\"line\">---------------  ------ ------ -----</span><br><span class=\"line\"></span><br><span class=\"line\">4391 (qemu-syste   8373      0  8373</span><br><span class=\"line\">5891 (sudo)           4      1     5</span><br><span class=\"line\"></span><br><span class=\"line\">---------------  ------ ------ -----</span><br><span class=\"line\"></span><br><span class=\"line\">Total              8377      1  8377</span><br><span class=\"line\"></span><br><span class=\"line\">ubuntu@ubuntu-kvm:~$ sudo numastat -p 4391</span><br><span class=\"line\">Per-node process memory usage (in MBs) for PID 4391 (qemu-system-x86)</span><br><span class=\"line\">                           Node 0          Node 1           Total</span><br><span class=\"line\">                  --------------- --------------- ---------------</span><br><span class=\"line\">Huge                      8192.00            0.00         8192.00</span><br><span class=\"line\">Heap                        10.00            0.00           10.00</span><br><span class=\"line\">Stack                        0.03            0.00            0.03</span><br><span class=\"line\">Private                    170.70            0.15          170.85</span><br><span class=\"line\"></span><br><span class=\"line\">----------------  --------------- --------------- ---------------</span><br><span class=\"line\"></span><br><span class=\"line\">Total                     8372.73            0.16         8372.88</span><br></pre></td></tr></table></figure>\n\n\n<p>From the above outputs, the csr1kv-1 are using the memories from node 0.</p>\n<h2 id=\"7-Check-the-vNIC-in-CSR1KV\"><a href=\"#7-Check-the-vNIC-in-CSR1KV\" class=\"headerlink\" title=\"(7) Check the vNIC in CSR1KV\"></a>(7) Check the vNIC in CSR1KV</h2><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">csr1kv-1#show platform software vnic-if interface-mapping</span><br><span class=\"line\">-------------------------------------------------------------</span><br><span class=\"line\"></span><br><span class=\"line\"> Interface Name        Driver Name         Mac Addr</span><br><span class=\"line\">-------------------------------------------------------------</span><br><span class=\"line\"></span><br><span class=\"line\"> GigabitEthernet3       net_i40e_vf        5254.00bd.9f54</span><br><span class=\"line\"> GigabitEthernet2       net_i40e_vf        5254.000b.a52e</span><br><span class=\"line\"> GigabitEthernet1       net_virtio         5254.0069.ec73</span><br></pre></td></tr></table></figure>\n\n<p>The Driver Name net_i40e_vf indicates that the vNIC is a VF from the SR-IOV pool.</p>\n<h1 id=\"CSR-1000v-initial-configuration-and-Smart-License-registration\"><a href=\"#CSR-1000v-initial-configuration-and-Smart-License-registration\" class=\"headerlink\" title=\"CSR 1000v initial configuration and Smart License registration\"></a>CSR 1000v initial configuration and Smart License registration</h1><h2 id=\"1-CSR-1000v-initial-config-example\"><a href=\"#1-CSR-1000v-initial-config-example\" class=\"headerlink\" title=\"(1) CSR 1000v initial config example\"></a>(1) CSR 1000v initial config example</h2><p>Part of the configuration:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">CSR1000v-1#show sdwan running-config</span><br><span class=\"line\">system</span><br><span class=\"line\"> system-ip             1.1.10.1</span><br><span class=\"line\"> site-id               101</span><br><span class=\"line\"> sp-organization-name  CiscoBJ</span><br><span class=\"line\"> organization-name     CiscoBJ</span><br><span class=\"line\"> vbond 10.75.58.51 port 12346</span><br><span class=\"line\">!</span><br><span class=\"line\">hostname CSR1000v-1</span><br><span class=\"line\">username admin privilege 15 secret 9 $9$4/QL2V2K4/6H1k$XUmRNf.T7t3KDOj/FmoNexpEypCxr482dExXHDnohSI</span><br><span class=\"line\">ip name-server 64.104.123.245</span><br><span class=\"line\">ip route 0.0.0.0 0.0.0.0 10.75.59.1</span><br><span class=\"line\"></span><br><span class=\"line\">interface GigabitEthernet1</span><br><span class=\"line\"> no shutdown</span><br><span class=\"line\"> arp timeout 1200</span><br><span class=\"line\"> ip address 10.75.59.35 255.255.255.0</span><br><span class=\"line\"> no ip redirects</span><br><span class=\"line\"> ip mtu    1500</span><br><span class=\"line\"> mtu 1500</span><br><span class=\"line\"> negotiation auto</span><br><span class=\"line\">exit</span><br><span class=\"line\"></span><br><span class=\"line\">interface Tunnel1</span><br><span class=\"line\"> no shutdown</span><br><span class=\"line\"> ip unnumbered GigabitEthernet1</span><br><span class=\"line\"> no ip redirects</span><br><span class=\"line\"> ipv6 unnumbered GigabitEthernet1</span><br><span class=\"line\"> no ipv6 redirects</span><br><span class=\"line\"> tunnel source GigabitEthernet1</span><br><span class=\"line\"> tunnel mode sdwan</span><br><span class=\"line\">exit</span><br><span class=\"line\"></span><br><span class=\"line\">clock timezone CST 8 0</span><br><span class=\"line\">ntp server x.x.x.x version 4</span><br><span class=\"line\"></span><br><span class=\"line\">sdwan</span><br><span class=\"line\"> interface GigabitEthernet1</span><br><span class=\"line\">  tunnel-interface</span><br><span class=\"line\">   encapsulation ipsec</span><br><span class=\"line\">   allow-service sshd</span><br><span class=\"line\">  exit</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"2-Commands-to-check-the-status\"><a href=\"#2-Commands-to-check-the-status\" class=\"headerlink\" title=\"(2) Commands to check the status\"></a>(2) Commands to check the status</h2><figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">show sdwan control local-properties</span><br><span class=\"line\">show sdwan control connections</span><br><span class=\"line\">show sdwan control connection-history</span><br><span class=\"line\">show sdwan running-config</span><br><span class=\"line\">show sdwan bfd sessions</span><br><span class=\"line\">show sdwan omp peers</span><br><span class=\"line\">show sdwan omp routes</span><br></pre></td></tr></table></figure>\n\n<h2 id=\"3-CSR-1000v-Smart-License-Registration\"><a href=\"#3-CSR-1000v-Smart-License-Registration\" class=\"headerlink\" title=\"(3) CSR 1000v Smart License Registration\"></a>(3) CSR 1000v Smart License Registration</h2><p>Before Smart License registration, you need ：</p>\n<ol>\n<li>CSR 1000v’s control connections are up；</li>\n<li>Configure ip http client source-interface GigabitEthernet2</li>\n<li>If the version is 16.12.x and bellow, you need to allow service all<br><code>sdwan interface GigabitEthernet2 tunnel-interface allow-service all </code><br>In the 17.2.x and above versions, there is an allow-service https</li>\n<li>CSR 1000v can access URL：<a href=\"https://tools.cisco.com/its/service/oddce/services/DDCEService\">https://tools.cisco.com/its/service/oddce/services/DDCEService</a><br>The command license smart register idtoken xxxxxx will do the registration.<br>You can find the idtoken from your Smart Account smart license inventory.<br>show license status to check the status.</li>\n</ol>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">CSR1000v-1#show platform hardware throughput level</span><br><span class=\"line\">The current throughput level is 200000000 kb/s</span><br></pre></td></tr></table></figure>\n\n<h1 id=\"Performances-and-limitations\"><a href=\"#Performances-and-limitations\" class=\"headerlink\" title=\"Performances and limitations\"></a>Performances and limitations</h1><h2 id=\"1-The-performance-of-the-SR-IOV\"><a href=\"#1-The-performance-of-the-SR-IOV\" class=\"headerlink\" title=\"(1) The performance of the SR-IOV\"></a>(1) The performance of the SR-IOV</h2><p>A performance test was done after the SR-IOV setup, the CSR1KV was configured as 8vCPU and 8G Memory, the packet drop rate was 0%.</p>\n<table>\n<thead>\n<tr>\n<th>Packet Site</th>\n<th>SDWAN Performance (Mbps)</th>\n<th>CEF Performance (Mbps)</th>\n</tr>\n</thead>\n<tbody><tr>\n<td>128Bytes</td>\n<td>800</td>\n<td>2843.75</td>\n</tr>\n<tr>\n<td>256Bytes</td>\n<td>1431.26</td>\n<td>6500.00</td>\n</tr>\n<tr>\n<td>512Bytes</td>\n<td>2581.26</td>\n<td>10578.13</td>\n</tr>\n<tr>\n<td>1024Bytes</td>\n<td>3731.26</td>\n<td>15500.00</td>\n</tr>\n<tr>\n<td>1400Bytes</td>\n<td>4306.26</td>\n<td>18171.88</td>\n</tr>\n</tbody></table>\n<p><img src=\"/csr1kv-kvm-Ubuntu20-04-md/line-chart.png\" alt=\"Performance Line Chart\"></p>\n<p>Note: <strong>These test results are not to represent the official performance data. Different servers and network cards may have different test results. The above data is for demo only.</strong></p>\n<h2 id=\"2-The-limitation-of-the-SR-IOV\"><a href=\"#2-The-limitation-of-the-SR-IOV\" class=\"headerlink\" title=\"(2) The limitation of the SR-IOV\"></a>(2) The limitation of the SR-IOV</h2><p>The main limitation of the SR-IOV is the number of VLANs on each VF, the maximum VLAN of an VF is limited to 63 in ixgbevf.<br>So, the active number of sub-interfaces on an interface of the CSR1KV that uses the SRIOV VFs is limited to 63.<br>There is some notes in the Cisco CSR 1000v and Cisco ISRv Software Configuration Guide:</p>\n<blockquote>\n<p>SR-IOV (ixgbevf)<br>Maximum VLANs: The maximum number of VLANs supported on PF is 64. Together, all VFs can have a total of 64 VLANs. (Intel limitation.)</p>\n<p>SR-IOV (i40evf)<br>Maximum VLANs: The maximum number of VLANs supported on PF is 512. Together, all VFs can have a total of 512 VLANs. (Intel limitation.) Per-VF resources are managed by the PF (host) device driver.</p>\n</blockquote>\n<h1 id=\"References\"><a href=\"#References\" class=\"headerlink\" title=\"References\"></a>References</h1><p><a href=\"https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html-single/performance_tuning_guide/index\">https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html-single/performance_tuning_guide/index</a></p>\n<p><a href=\"https://computingforgeeks.com/how-to-create-and-configure-bridge-networking-for-kvm-in-linux/\">https://computingforgeeks.com/how-to-create-and-configure-bridge-networking-for-kvm-in-linux/</a></p>\n<p><a href=\"https://software.intel.com/content/www/us/en/develop/articles/configure-sr-iov-network-virtual-functions-in-linux-kvm.html\">https://software.intel.com/content/www/us/en/develop/articles/configure-sr-iov-network-virtual-functions-in-linux-kvm.html</a></p>\n<p><a href=\"https://linuxconfig.org/install-and-set-up-kvm-on-ubuntu-20-04-focal-fossa-linux\">https://linuxconfig.org/install-and-set-up-kvm-on-ubuntu-20-04-focal-fossa-linux</a></p>\n<p><a href=\"https://kifarunix.com/how-to-fix-qemu-kvm-not-connected-error-on-ubuntu-20-04/\">https://kifarunix.com/how-to-fix-qemu-kvm-not-connected-error-on-ubuntu-20-04/</a></p>\n<p><a href=\"https://linuxconfig.org/how-to-disable-apparmor-on-ubuntu-20-04-focal-fossa-linux\">https://linuxconfig.org/how-to-disable-apparmor-on-ubuntu-20-04-focal-fossa-linux</a></p>\n<p><strong>CSR1000v SD-WAN Installation on KVM</strong> by Jean-Marc Barozet</p>\n<h1 id=\"Scripts-and-XML-Example-Files\"><a href=\"#Scripts-and-XML-Example-Files\" class=\"headerlink\" title=\"Scripts and XML Example Files\"></a>Scripts and XML Example Files</h1><ol>\n<li><a href=\"https://raw.githubusercontent.com/weiborao/CSR1KV-Installation-on-KVM-with-SRIOV/main/kvm/1.2-install-ubuntu-kvm.sh\">Ubuntu and KVM installation and setting</a></li>\n<li><a href=\"https://github.com/weiborao/CSR1KV-Installation-on-KVM-with-SRIOV/raw/main/kvm/1.3-nic-settings.sh\">NIC Settings with nmcli</a></li>\n<li><a href=\"https://github.com/weiborao/CSR1KV-Installation-on-KVM-with-SRIOV/raw/main/kvm/2.1-check-nic-sriov.sh\">Check NIC SRIOV Capabilities</a></li>\n<li><a href=\"https://github.com/weiborao/CSR1KV-Installation-on-KVM-with-SRIOV/raw/main/kvm/2.2-change-grub.sh\">GRUB Settings</a></li>\n<li><a href=\"https://github.com/weiborao/CSR1KV-Installation-on-KVM-with-SRIOV/raw/main/kvm/2.3-sriov-setting.sh\">SRIOV Settings</a></li>\n<li><a href=\"https://github.com/weiborao/CSR1KV-Installation-on-KVM-with-SRIOV/raw/main/kvm/2.4-check-vfs.sh\">Check VFs</a></li>\n<li><a href=\"https://github.com/weiborao/CSR1KV-Installation-on-KVM-with-SRIOV/raw/main/kvm/3.0-create-sriov-pool.sh\">Create SRIOV Adapter Pool</a></li>\n<li><a href=\"https://github.com/weiborao/CSR1KV-Installation-on-KVM-with-SRIOV/raw/main/kvm/4.0-kvm-tuning.sh\">KVM Tuning</a></li>\n<li><a href=\"https://github.com/weiborao/CSR1KV-Installation-on-KVM-with-SRIOV/raw/main/kvm/4.1-check-csr1kv.sh\">Check CSR1000v Tuning</a></li>\n<li><a href=\"https://github.com/weiborao/CSR1KV-Installation-on-KVM-with-SRIOV/raw/main/kvm/ens1f0_sriov_pool.xml\">ens1f0_sriov_pool.xml</a></li>\n<li><a href=\"https://github.com/weiborao/CSR1KV-Installation-on-KVM-with-SRIOV/raw/main/kvm/csr1kv-1.xml\">csr1kv-1.xml</a></li>\n</ol>\n"},{"title":"Traceroute 漏洞？","date":"2021-12-16T13:25:41.000Z","_content":"\n本文将分析一种名为**允许Traceroute探测**的漏洞，对其判定方法进行追查，并提出建议。\n\n## 背景\n\n最近，笔者在做一个网络设备方面的安全合规性的测试，其中有一项是需要使用漏洞扫描设备对被测试的设备进行全面的安全漏洞扫描。在笔者对被测设备进行了针对性的安全加固后，漏洞扫描报告仍然有一个低危漏洞：允许Traceroute探测。该低危漏洞的详细信息如下：\n\n![traceroute-vulnerability](traceroute-vulnerability/traceroute-vulnerability.png)\n\n需要说明的一点是，扫描器如需成功扫描到该设备，这个设备的IP地址要求能被扫描器探测到，否则扫描器会认为设备不在线。通常的做法就是允许Ping，具体而言，被测设备至少要允许ICMP Echo Request请求，并应答ICMP Echo Reply。\n\n笔者在被测试设备的接口上配置了ACL，入向仅允许ICMP Echo Request报文，出向仅允许ICMP Echo Reply，但是扫描结果依然判断被测设备允许Traceroute探测。\n\n对此，笔者疑惑不已，下文将展开思考和分析。\n\n<!-- more -->\n\n## 对漏洞的解读\n\n- **详细描述**：使用Traceroute探测来获取扫描器与远程主机之间的路由信息。攻击者也可以利用这些信息来了解目标网络的网络拓扑。\n\n- **解读**：如果扫描器与被测试设备处于同一网段，那么扫描器（充当攻击者角色）与被测设备之间的网络拓扑实际是已知的，即通过二层交换网络互联；根本不需要使用Traceroute来获取路由信息、网络拓扑。按照笔者之前的文章[《通过Wireshark重新认识Traceroute》](https://weiborao.github.io/get-known-traceroute-by-wireshark.html)的分析，如果针对同一个网段的主机进行Traceroute，那么第一个TTL=1的UDP报文发送到该地址后，立刻会收到Port-Unreachable的ICMP报文。如果是Windows系统，tracert会发送TTL=1 的ICMP Echo Request，但是同一网段的地址只是会简单的回复一个ICMP Echo Reply的报文，就宣告结束。不管发送UDP报文还是ICMP报文，整个过程中，不会出现TTL超时的情况，也就不会收到TTL Exceeded的ICMP报文。\n- **解决办法**：在防火墙中禁用Time Exceeded类型的ICMP包。\n- **推理**：根据解决办法的定义推理：如果防火墙禁用了Time Exceeded类型的ICMP报文，该漏洞就得到解决，那么扫描结果中就不会出现**允许Traceroute探测**的漏洞。也可以说，如果扫描器没有接收到Time Exceeded类型的ICMP包，也就没有发现Traceroute的证据，那么，扫描结果中不能出现**允许Traceroute探测**的漏洞。\n- 综合上述的分析，笔者认为，依据漏洞的解决办法进行推理，如果扫描器与被测设备在同一网段，扫描过程中不会收到TTL Exceeded的ICMP包，不能得出被测设备**允许Traceroute探测**这个结论的。\n- 简言之，扫描器对于该漏洞的判定原则与其提供的解决办法并不匹配。\n\n## 漏洞判定方法的追查\n\n为了追查扫描器到底如何判定该漏洞，笔者请负责漏洞扫描的工程师设法进行抓包，将扫描过程中扫描器发送/接收的报文进行全量抓取。将抓取到的报文进行分析，有如下发现：\n\n1. 扫描器对被测设备发起随机的TCP端口扫描，因笔者进行了安全加固，被测设备没有回复任何一个TCP报文；\n2. 扫描器对被测设备发起其他常见协议的扫描，例如SNMP、SIP、NTP、TFTP等，均未得到响应；\n3. 扫描器对被测设备发起基于UDP报文的Traceroute探测，逐一发送TTL=1、2、3的UDP报文，UDP端口号为32768，未得到响应；\n4. 扫描器对被测设备发起基于ICMP的Traceroute探测，得到ICMP Echo Reply的回包，如下图：\n\n![icmp-echo-reply](traceroute-vulnerability/icmp-echo-reply.png)\n\n注：扫描器地址为192.168.100.11，被测设备地址为192.168.99.101，其中隔着一个设备192.168.100.101，均为同一系列的两个不同型号的产品，两个设备的软件版本相同。\n\n笔者设法将TTL=1和TTL=2的报文进行了过滤，但是还有TTL=3的报文继续发送过来。\n\n按照上述的抓包分析来分析，判定原则似乎是逐一发送TTL=1、2、……N，（N>=3）的ICMP Echo Request报文，期望回复TTL Exceeded的报文，实际回复ICMP Echo Reply报文，竟然也判定为**允许Traceroute探测**。\n\n笔者去掉安全加固的策略，重新进行扫描，抓取扫描器的收发报文，如下：\n\n![icmp-ttl-exceeded](traceroute-vulnerability/icmp-ttl-exceeded.png)\n\n在该图中，我们可以清晰的看到中间的设备192.168.100.101发送的TTL Exceeded报文，从而让扫描器探测到其与远程主机之间的路由信息，网络拓扑信息（发现了中间设备）。\n\n## 建议\n\n通过上述的分析，我们得出结论：\n\n1. 该漏洞扫描程序的判定原则与其提供的解决办法不匹配，即按照解决办法整改后，依然会扫描出**允许Traceroute探测**的漏洞。\n2. 通过抓包分析，我们发现其判定原则存在不合理之处，即扫描过程中通过发送TTL=1、2、3……的报文，期望回复ICMP TTL Exceeded，然而在回复了ICMP Echo Reply，仍然会判定为有该漏洞。\n3. 执行该漏洞扫描时，不能将扫描器与被测设备进行同网段直连，这样被测设备不会返回ICMP TTL Exceeded报文。\n\n建议：\n\n1. 修改判定原则，使其与解决办法相匹配；\n2. 执行该漏洞扫描时，需要在扫描器和被测设备之间至少增加一个路由设备（可为同款测试设备），以便真实的反映出Traceroute的功能。\n","source":"_posts/traceroute-vulnerability.md","raw":"---\ntitle: Traceroute 漏洞？\ndate: 2021-12-16 21:25:41\ntags:\n    - traceroute\n    - icmp\n---\n\n本文将分析一种名为**允许Traceroute探测**的漏洞，对其判定方法进行追查，并提出建议。\n\n## 背景\n\n最近，笔者在做一个网络设备方面的安全合规性的测试，其中有一项是需要使用漏洞扫描设备对被测试的设备进行全面的安全漏洞扫描。在笔者对被测设备进行了针对性的安全加固后，漏洞扫描报告仍然有一个低危漏洞：允许Traceroute探测。该低危漏洞的详细信息如下：\n\n![traceroute-vulnerability](traceroute-vulnerability/traceroute-vulnerability.png)\n\n需要说明的一点是，扫描器如需成功扫描到该设备，这个设备的IP地址要求能被扫描器探测到，否则扫描器会认为设备不在线。通常的做法就是允许Ping，具体而言，被测设备至少要允许ICMP Echo Request请求，并应答ICMP Echo Reply。\n\n笔者在被测试设备的接口上配置了ACL，入向仅允许ICMP Echo Request报文，出向仅允许ICMP Echo Reply，但是扫描结果依然判断被测设备允许Traceroute探测。\n\n对此，笔者疑惑不已，下文将展开思考和分析。\n\n<!-- more -->\n\n## 对漏洞的解读\n\n- **详细描述**：使用Traceroute探测来获取扫描器与远程主机之间的路由信息。攻击者也可以利用这些信息来了解目标网络的网络拓扑。\n\n- **解读**：如果扫描器与被测试设备处于同一网段，那么扫描器（充当攻击者角色）与被测设备之间的网络拓扑实际是已知的，即通过二层交换网络互联；根本不需要使用Traceroute来获取路由信息、网络拓扑。按照笔者之前的文章[《通过Wireshark重新认识Traceroute》](https://weiborao.github.io/get-known-traceroute-by-wireshark.html)的分析，如果针对同一个网段的主机进行Traceroute，那么第一个TTL=1的UDP报文发送到该地址后，立刻会收到Port-Unreachable的ICMP报文。如果是Windows系统，tracert会发送TTL=1 的ICMP Echo Request，但是同一网段的地址只是会简单的回复一个ICMP Echo Reply的报文，就宣告结束。不管发送UDP报文还是ICMP报文，整个过程中，不会出现TTL超时的情况，也就不会收到TTL Exceeded的ICMP报文。\n- **解决办法**：在防火墙中禁用Time Exceeded类型的ICMP包。\n- **推理**：根据解决办法的定义推理：如果防火墙禁用了Time Exceeded类型的ICMP报文，该漏洞就得到解决，那么扫描结果中就不会出现**允许Traceroute探测**的漏洞。也可以说，如果扫描器没有接收到Time Exceeded类型的ICMP包，也就没有发现Traceroute的证据，那么，扫描结果中不能出现**允许Traceroute探测**的漏洞。\n- 综合上述的分析，笔者认为，依据漏洞的解决办法进行推理，如果扫描器与被测设备在同一网段，扫描过程中不会收到TTL Exceeded的ICMP包，不能得出被测设备**允许Traceroute探测**这个结论的。\n- 简言之，扫描器对于该漏洞的判定原则与其提供的解决办法并不匹配。\n\n## 漏洞判定方法的追查\n\n为了追查扫描器到底如何判定该漏洞，笔者请负责漏洞扫描的工程师设法进行抓包，将扫描过程中扫描器发送/接收的报文进行全量抓取。将抓取到的报文进行分析，有如下发现：\n\n1. 扫描器对被测设备发起随机的TCP端口扫描，因笔者进行了安全加固，被测设备没有回复任何一个TCP报文；\n2. 扫描器对被测设备发起其他常见协议的扫描，例如SNMP、SIP、NTP、TFTP等，均未得到响应；\n3. 扫描器对被测设备发起基于UDP报文的Traceroute探测，逐一发送TTL=1、2、3的UDP报文，UDP端口号为32768，未得到响应；\n4. 扫描器对被测设备发起基于ICMP的Traceroute探测，得到ICMP Echo Reply的回包，如下图：\n\n![icmp-echo-reply](traceroute-vulnerability/icmp-echo-reply.png)\n\n注：扫描器地址为192.168.100.11，被测设备地址为192.168.99.101，其中隔着一个设备192.168.100.101，均为同一系列的两个不同型号的产品，两个设备的软件版本相同。\n\n笔者设法将TTL=1和TTL=2的报文进行了过滤，但是还有TTL=3的报文继续发送过来。\n\n按照上述的抓包分析来分析，判定原则似乎是逐一发送TTL=1、2、……N，（N>=3）的ICMP Echo Request报文，期望回复TTL Exceeded的报文，实际回复ICMP Echo Reply报文，竟然也判定为**允许Traceroute探测**。\n\n笔者去掉安全加固的策略，重新进行扫描，抓取扫描器的收发报文，如下：\n\n![icmp-ttl-exceeded](traceroute-vulnerability/icmp-ttl-exceeded.png)\n\n在该图中，我们可以清晰的看到中间的设备192.168.100.101发送的TTL Exceeded报文，从而让扫描器探测到其与远程主机之间的路由信息，网络拓扑信息（发现了中间设备）。\n\n## 建议\n\n通过上述的分析，我们得出结论：\n\n1. 该漏洞扫描程序的判定原则与其提供的解决办法不匹配，即按照解决办法整改后，依然会扫描出**允许Traceroute探测**的漏洞。\n2. 通过抓包分析，我们发现其判定原则存在不合理之处，即扫描过程中通过发送TTL=1、2、3……的报文，期望回复ICMP TTL Exceeded，然而在回复了ICMP Echo Reply，仍然会判定为有该漏洞。\n3. 执行该漏洞扫描时，不能将扫描器与被测设备进行同网段直连，这样被测设备不会返回ICMP TTL Exceeded报文。\n\n建议：\n\n1. 修改判定原则，使其与解决办法相匹配；\n2. 执行该漏洞扫描时，需要在扫描器和被测设备之间至少增加一个路由设备（可为同款测试设备），以便真实的反映出Traceroute的功能。\n","slug":"traceroute-vulnerability","published":1,"updated":"2025-12-14T09:50:07.477Z","comments":1,"layout":"post","photos":[],"_id":"cuidNllT4EdXnG074AoaH5I2g","content":"<p>本文将分析一种名为<strong>允许Traceroute探测</strong>的漏洞，对其判定方法进行追查，并提出建议。</p>\n<h2 id=\"背景\"><a href=\"#背景\" class=\"headerlink\" title=\"背景\"></a>背景</h2><p>最近，笔者在做一个网络设备方面的安全合规性的测试，其中有一项是需要使用漏洞扫描设备对被测试的设备进行全面的安全漏洞扫描。在笔者对被测设备进行了针对性的安全加固后，漏洞扫描报告仍然有一个低危漏洞：允许Traceroute探测。该低危漏洞的详细信息如下：</p>\n<p><img src=\"/traceroute-vulnerability/traceroute-vulnerability.png\" alt=\"traceroute-vulnerability\"></p>\n<p>需要说明的一点是，扫描器如需成功扫描到该设备，这个设备的IP地址要求能被扫描器探测到，否则扫描器会认为设备不在线。通常的做法就是允许Ping，具体而言，被测设备至少要允许ICMP Echo Request请求，并应答ICMP Echo Reply。</p>\n<p>笔者在被测试设备的接口上配置了ACL，入向仅允许ICMP Echo Request报文，出向仅允许ICMP Echo Reply，但是扫描结果依然判断被测设备允许Traceroute探测。</p>\n<p>对此，笔者疑惑不已，下文将展开思考和分析。</p>\n<span id=\"more\"></span>\n\n<h2 id=\"对漏洞的解读\"><a href=\"#对漏洞的解读\" class=\"headerlink\" title=\"对漏洞的解读\"></a>对漏洞的解读</h2><ul>\n<li><p><strong>详细描述</strong>：使用Traceroute探测来获取扫描器与远程主机之间的路由信息。攻击者也可以利用这些信息来了解目标网络的网络拓扑。</p>\n</li>\n<li><p><strong>解读</strong>：如果扫描器与被测试设备处于同一网段，那么扫描器（充当攻击者角色）与被测设备之间的网络拓扑实际是已知的，即通过二层交换网络互联；根本不需要使用Traceroute来获取路由信息、网络拓扑。按照笔者之前的文章<a href=\"https://weiborao.github.io/get-known-traceroute-by-wireshark.html\">《通过Wireshark重新认识Traceroute》</a>的分析，如果针对同一个网段的主机进行Traceroute，那么第一个TTL&#x3D;1的UDP报文发送到该地址后，立刻会收到Port-Unreachable的ICMP报文。如果是Windows系统，tracert会发送TTL&#x3D;1 的ICMP Echo Request，但是同一网段的地址只是会简单的回复一个ICMP Echo Reply的报文，就宣告结束。不管发送UDP报文还是ICMP报文，整个过程中，不会出现TTL超时的情况，也就不会收到TTL Exceeded的ICMP报文。</p>\n</li>\n<li><p><strong>解决办法</strong>：在防火墙中禁用Time Exceeded类型的ICMP包。</p>\n</li>\n<li><p><strong>推理</strong>：根据解决办法的定义推理：如果防火墙禁用了Time Exceeded类型的ICMP报文，该漏洞就得到解决，那么扫描结果中就不会出现<strong>允许Traceroute探测</strong>的漏洞。也可以说，如果扫描器没有接收到Time Exceeded类型的ICMP包，也就没有发现Traceroute的证据，那么，扫描结果中不能出现<strong>允许Traceroute探测</strong>的漏洞。</p>\n</li>\n<li><p>综合上述的分析，笔者认为，依据漏洞的解决办法进行推理，如果扫描器与被测设备在同一网段，扫描过程中不会收到TTL Exceeded的ICMP包，不能得出被测设备<strong>允许Traceroute探测</strong>这个结论的。</p>\n</li>\n<li><p>简言之，扫描器对于该漏洞的判定原则与其提供的解决办法并不匹配。</p>\n</li>\n</ul>\n<h2 id=\"漏洞判定方法的追查\"><a href=\"#漏洞判定方法的追查\" class=\"headerlink\" title=\"漏洞判定方法的追查\"></a>漏洞判定方法的追查</h2><p>为了追查扫描器到底如何判定该漏洞，笔者请负责漏洞扫描的工程师设法进行抓包，将扫描过程中扫描器发送&#x2F;接收的报文进行全量抓取。将抓取到的报文进行分析，有如下发现：</p>\n<ol>\n<li>扫描器对被测设备发起随机的TCP端口扫描，因笔者进行了安全加固，被测设备没有回复任何一个TCP报文；</li>\n<li>扫描器对被测设备发起其他常见协议的扫描，例如SNMP、SIP、NTP、TFTP等，均未得到响应；</li>\n<li>扫描器对被测设备发起基于UDP报文的Traceroute探测，逐一发送TTL&#x3D;1、2、3的UDP报文，UDP端口号为32768，未得到响应；</li>\n<li>扫描器对被测设备发起基于ICMP的Traceroute探测，得到ICMP Echo Reply的回包，如下图：</li>\n</ol>\n<p><img src=\"/traceroute-vulnerability/icmp-echo-reply.png\" alt=\"icmp-echo-reply\"></p>\n<p>注：扫描器地址为192.168.100.11，被测设备地址为192.168.99.101，其中隔着一个设备192.168.100.101，均为同一系列的两个不同型号的产品，两个设备的软件版本相同。</p>\n<p>笔者设法将TTL&#x3D;1和TTL&#x3D;2的报文进行了过滤，但是还有TTL&#x3D;3的报文继续发送过来。</p>\n<p>按照上述的抓包分析来分析，判定原则似乎是逐一发送TTL&#x3D;1、2、……N，（N&gt;&#x3D;3）的ICMP Echo Request报文，期望回复TTL Exceeded的报文，实际回复ICMP Echo Reply报文，竟然也判定为<strong>允许Traceroute探测</strong>。</p>\n<p>笔者去掉安全加固的策略，重新进行扫描，抓取扫描器的收发报文，如下：</p>\n<p><img src=\"/traceroute-vulnerability/icmp-ttl-exceeded.png\" alt=\"icmp-ttl-exceeded\"></p>\n<p>在该图中，我们可以清晰的看到中间的设备192.168.100.101发送的TTL Exceeded报文，从而让扫描器探测到其与远程主机之间的路由信息，网络拓扑信息（发现了中间设备）。</p>\n<h2 id=\"建议\"><a href=\"#建议\" class=\"headerlink\" title=\"建议\"></a>建议</h2><p>通过上述的分析，我们得出结论：</p>\n<ol>\n<li>该漏洞扫描程序的判定原则与其提供的解决办法不匹配，即按照解决办法整改后，依然会扫描出<strong>允许Traceroute探测</strong>的漏洞。</li>\n<li>通过抓包分析，我们发现其判定原则存在不合理之处，即扫描过程中通过发送TTL&#x3D;1、2、3……的报文，期望回复ICMP TTL Exceeded，然而在回复了ICMP Echo Reply，仍然会判定为有该漏洞。</li>\n<li>执行该漏洞扫描时，不能将扫描器与被测设备进行同网段直连，这样被测设备不会返回ICMP TTL Exceeded报文。</li>\n</ol>\n<p>建议：</p>\n<ol>\n<li>修改判定原则，使其与解决办法相匹配；</li>\n<li>执行该漏洞扫描时，需要在扫描器和被测设备之间至少增加一个路由设备（可为同款测试设备），以便真实的反映出Traceroute的功能。</li>\n</ol>\n","length":1532,"excerpt":"<p>本文将分析一种名为<strong>允许Traceroute探测</strong>的漏洞，对其判定方法进行追查，并提出建议。</p>\n<h2 id=\"背景\"><a href=\"#背景\" class=\"headerlink\" title=\"背景\"></a>背景</h2><p>最近，笔者在做一个网络设备方面的安全合规性的测试，其中有一项是需要使用漏洞扫描设备对被测试的设备进行全面的安全漏洞扫描。在笔者对被测设备进行了针对性的安全加固后，漏洞扫描报告仍然有一个低危漏洞：允许Traceroute探测。该低危漏洞的详细信息如下：</p>\n<p><img src=\"/traceroute-vulnerability/traceroute-vulnerability.png\" alt=\"traceroute-vulnerability\"></p>\n<p>需要说明的一点是，扫描器如需成功扫描到该设备，这个设备的IP地址要求能被扫描器探测到，否则扫描器会认为设备不在线。通常的做法就是允许Ping，具体而言，被测设备至少要允许ICMP Echo Request请求，并应答ICMP Echo Reply。</p>\n<p>笔者在被测试设备的接口上配置了ACL，入向仅允许ICMP Echo Request报文，出向仅允许ICMP Echo Reply，但是扫描结果依然判断被测设备允许Traceroute探测。</p>\n<p>对此，笔者疑惑不已，下文将展开思考和分析。</p>","more":"<h2 id=\"对漏洞的解读\"><a href=\"#对漏洞的解读\" class=\"headerlink\" title=\"对漏洞的解读\"></a>对漏洞的解读</h2><ul>\n<li><p><strong>详细描述</strong>：使用Traceroute探测来获取扫描器与远程主机之间的路由信息。攻击者也可以利用这些信息来了解目标网络的网络拓扑。</p>\n</li>\n<li><p><strong>解读</strong>：如果扫描器与被测试设备处于同一网段，那么扫描器（充当攻击者角色）与被测设备之间的网络拓扑实际是已知的，即通过二层交换网络互联；根本不需要使用Traceroute来获取路由信息、网络拓扑。按照笔者之前的文章<a href=\"https://weiborao.github.io/get-known-traceroute-by-wireshark.html\">《通过Wireshark重新认识Traceroute》</a>的分析，如果针对同一个网段的主机进行Traceroute，那么第一个TTL&#x3D;1的UDP报文发送到该地址后，立刻会收到Port-Unreachable的ICMP报文。如果是Windows系统，tracert会发送TTL&#x3D;1 的ICMP Echo Request，但是同一网段的地址只是会简单的回复一个ICMP Echo Reply的报文，就宣告结束。不管发送UDP报文还是ICMP报文，整个过程中，不会出现TTL超时的情况，也就不会收到TTL Exceeded的ICMP报文。</p>\n</li>\n<li><p><strong>解决办法</strong>：在防火墙中禁用Time Exceeded类型的ICMP包。</p>\n</li>\n<li><p><strong>推理</strong>：根据解决办法的定义推理：如果防火墙禁用了Time Exceeded类型的ICMP报文，该漏洞就得到解决，那么扫描结果中就不会出现<strong>允许Traceroute探测</strong>的漏洞。也可以说，如果扫描器没有接收到Time Exceeded类型的ICMP包，也就没有发现Traceroute的证据，那么，扫描结果中不能出现<strong>允许Traceroute探测</strong>的漏洞。</p>\n</li>\n<li><p>综合上述的分析，笔者认为，依据漏洞的解决办法进行推理，如果扫描器与被测设备在同一网段，扫描过程中不会收到TTL Exceeded的ICMP包，不能得出被测设备<strong>允许Traceroute探测</strong>这个结论的。</p>\n</li>\n<li><p>简言之，扫描器对于该漏洞的判定原则与其提供的解决办法并不匹配。</p>\n</li>\n</ul>\n<h2 id=\"漏洞判定方法的追查\"><a href=\"#漏洞判定方法的追查\" class=\"headerlink\" title=\"漏洞判定方法的追查\"></a>漏洞判定方法的追查</h2><p>为了追查扫描器到底如何判定该漏洞，笔者请负责漏洞扫描的工程师设法进行抓包，将扫描过程中扫描器发送&#x2F;接收的报文进行全量抓取。将抓取到的报文进行分析，有如下发现：</p>\n<ol>\n<li>扫描器对被测设备发起随机的TCP端口扫描，因笔者进行了安全加固，被测设备没有回复任何一个TCP报文；</li>\n<li>扫描器对被测设备发起其他常见协议的扫描，例如SNMP、SIP、NTP、TFTP等，均未得到响应；</li>\n<li>扫描器对被测设备发起基于UDP报文的Traceroute探测，逐一发送TTL&#x3D;1、2、3的UDP报文，UDP端口号为32768，未得到响应；</li>\n<li>扫描器对被测设备发起基于ICMP的Traceroute探测，得到ICMP Echo Reply的回包，如下图：</li>\n</ol>\n<p><img src=\"/traceroute-vulnerability/icmp-echo-reply.png\" alt=\"icmp-echo-reply\"></p>\n<p>注：扫描器地址为192.168.100.11，被测设备地址为192.168.99.101，其中隔着一个设备192.168.100.101，均为同一系列的两个不同型号的产品，两个设备的软件版本相同。</p>\n<p>笔者设法将TTL&#x3D;1和TTL&#x3D;2的报文进行了过滤，但是还有TTL&#x3D;3的报文继续发送过来。</p>\n<p>按照上述的抓包分析来分析，判定原则似乎是逐一发送TTL&#x3D;1、2、……N，（N&gt;&#x3D;3）的ICMP Echo Request报文，期望回复TTL Exceeded的报文，实际回复ICMP Echo Reply报文，竟然也判定为<strong>允许Traceroute探测</strong>。</p>\n<p>笔者去掉安全加固的策略，重新进行扫描，抓取扫描器的收发报文，如下：</p>\n<p><img src=\"/traceroute-vulnerability/icmp-ttl-exceeded.png\" alt=\"icmp-ttl-exceeded\"></p>\n<p>在该图中，我们可以清晰的看到中间的设备192.168.100.101发送的TTL Exceeded报文，从而让扫描器探测到其与远程主机之间的路由信息，网络拓扑信息（发现了中间设备）。</p>\n<h2 id=\"建议\"><a href=\"#建议\" class=\"headerlink\" title=\"建议\"></a>建议</h2><p>通过上述的分析，我们得出结论：</p>\n<ol>\n<li>该漏洞扫描程序的判定原则与其提供的解决办法不匹配，即按照解决办法整改后，依然会扫描出<strong>允许Traceroute探测</strong>的漏洞。</li>\n<li>通过抓包分析，我们发现其判定原则存在不合理之处，即扫描过程中通过发送TTL&#x3D;1、2、3……的报文，期望回复ICMP TTL Exceeded，然而在回复了ICMP Echo Reply，仍然会判定为有该漏洞。</li>\n<li>执行该漏洞扫描时，不能将扫描器与被测设备进行同网段直连，这样被测设备不会返回ICMP TTL Exceeded报文。</li>\n</ol>\n<p>建议：</p>\n<ol>\n<li>修改判定原则，使其与解决办法相匹配；</li>\n<li>执行该漏洞扫描时，需要在扫描器和被测设备之间至少增加一个路由设备（可为同款测试设备），以便真实的反映出Traceroute的功能。</li>\n</ol>"},{"title":"作品集 (Works)","date":"2025-12-25T07:50:00.000Z","type":"works","layout":"page","description":null,"_content":"\n# 🚀 技术作品集 | Technical Portfolio\n\n这里是我在基础设施可编程、网络安全及自动化领域的实战记录与深度洞察，本文为AI生成。\n\n---\n\n## 🛡️ eBPF 与可观测性 (Canvas 交互系列)\n*将复杂的 Linux 内核逻辑转化为交互式视觉专题。*\n\n* **[eBPF: Linux 内核的超能力](https://weiborao.link/ebpf.html)**\n    深度解析 eBPF 如何重塑现代化基础设施平台，涵盖 JIT 编译、Verifier 验证器及 2025 年最新的 Netkit 演进。\n* **[Cilium: eBPF 重塑云原生基础设施](https://weiborao.link/cilium.html)**\n    探讨 Cilium 如何利用服务身份（Identity）而非 IP 寻址，提供 L7 层级的深度隔离与高性能网络。\n* **[Tetragon: 云原生安全的最后一道防线](https://weiborao.link/tetragon.html)**\n    实战模拟 \"Dark-Chain\" 攻击，演示如何在内核态实现亚毫秒级的实时威胁阻断。\n* **[Project Deep Sight: 重塑云原生基座](https://weiborao.link/ebpfsre.html)**\n    面向 SRE 的技术报告，剖析如何构建具备“上帝视角”的可观测性体系。\n\n---\n\n## 🔒 零信任与安全云 (Security Cloud)\n*基于身份中心化与持续校验的现代安全架构实践。*\n\n* **[Cisco ISE: 零信任架构基石](https://weiborao.link/isev2.html)**\n    视觉化呈现 ISE 在 AAA 鉴权、端点合规及安全策略分发中的核心价值。\n* **[当信任变成最致命的漏洞](https://weiborao.link/isestory.html)**\n    关于边界安全失效后的深度反思，探讨为什么“持续校验”是现代安全的唯一出路。\n* **[Cisco SNA: 从网络数据中提取安全价值](https://weiborao.link/sna.html)**\n    利用 Stealthwatch 流量分析技术，识别内网中的潜伏威胁与异常行为。\n* **[eBPF Tetragon + Splunk + Foundation-sec 智能安全闭环](https://weiborao.link/sec8b.html)**\n    构建从内核审计到大规模日志分析的智能防御生态。\n\n---\n\n## ☁️ 云原生与基础设施自动化\n*通过代码定义一切 (Everything as Code)，实现分钟级的环境交付。*\n\n* **[Kubernetes with CNI Cilium 深度实践](https://weiborao.link/K8S-Cilium-Replace-kube-proxy.html)**\n    详述如何使用自动化脚本创建 K8S 集群，并彻底替换传统的 kube-proxy。\n* **[Ansible-K8S-Cilium 自动化实验项目](https://weiborao.link/Ansible-K8S-Cilium.html)**\n    完整的 Ansible Playbook 实践，涵盖从虚拟机初始化到 BGP 网络配置的全流程。\n* **[AppDynamics AMI & Cloud-init 自动化镜像制作](https://weiborao.link/Update-the-cloud-init-code-for-AppD-AMI.html)**\n    利用 Cloud-init 脚本在 AWS 上快速构建预装监控探针的企业级系统镜像。\n\n---\n\n## 🌐 网络架构与深度诊断\n*深挖协议栈与硬件卸载技术，优化底层传输效能。*\n\n* **[Cisco CSR1000v KVM SRIOV 性能优化指南](https://weiborao.link/csr1kv-kvm-Ubuntu20-04-md.html)**\n    涵盖 SR-IOV 配置、HugePages 开启及 vCPU 亲和性绑定的深度调优指南。\n* **[有关 AnyCast 技术简述](https://weiborao.link/anycast-brief.html)**\n    通俗易懂地解释 AnyCast 的路由机制及其在 DDoS 防御中的天然优势。\n* **[[在Docker容器中tcpdump抓包探秘Traceroute](https://weiborao.link/docker-traceroute-tcpdump.html)]**\n    在一个纯净的容器环境下进行抓包分析Traceroute的过程；通过番外篇介绍ThousandEyes的探针在容器中安装部署，并展示路径可视化分析的效果。\n\n---\n\n## 🤖 AI 辅助开发与赋能系列\n*探索生成式 AI 如何重构技术生产力。*\n\n* **[与 ChatGPT 对话：AI 助手加速云计算开发](https://weiborao.link/Conversation-with-ChatGPT-to-accelerate-Cloud-Develpment.html)**\n    实战展示如何利用大模型生成高质量的 IaC（基础设施即代码）片段。\n* **[eBPF 重构 IT 基础设施交付的基石](https://weiborao.link/ebpv2.html)**\n    AI 赋能下的基础设施思考，探讨可编程内核对 DevOps 文化的深远影响。\n* **[面向未来的 IT 基础设施架构：eBPF 赋能之旅](https://weiborao.link/ebpfv3.html)**\n    勾勒未来五年的技术路线图。\n\n---\n\n### 🔙 [返回博客首页](/)","source":"_posts/My-GenAI-works-md.md","raw":"---\ntitle: 作品集 (Works)\ndate: 2025-12-25 15:50:00\ntype: \"works\"\nlayout: \"page\"\ndescription: \n---\n\n# 🚀 技术作品集 | Technical Portfolio\n\n这里是我在基础设施可编程、网络安全及自动化领域的实战记录与深度洞察，本文为AI生成。\n\n---\n\n## 🛡️ eBPF 与可观测性 (Canvas 交互系列)\n*将复杂的 Linux 内核逻辑转化为交互式视觉专题。*\n\n* **[eBPF: Linux 内核的超能力](https://weiborao.link/ebpf.html)**\n    深度解析 eBPF 如何重塑现代化基础设施平台，涵盖 JIT 编译、Verifier 验证器及 2025 年最新的 Netkit 演进。\n* **[Cilium: eBPF 重塑云原生基础设施](https://weiborao.link/cilium.html)**\n    探讨 Cilium 如何利用服务身份（Identity）而非 IP 寻址，提供 L7 层级的深度隔离与高性能网络。\n* **[Tetragon: 云原生安全的最后一道防线](https://weiborao.link/tetragon.html)**\n    实战模拟 \"Dark-Chain\" 攻击，演示如何在内核态实现亚毫秒级的实时威胁阻断。\n* **[Project Deep Sight: 重塑云原生基座](https://weiborao.link/ebpfsre.html)**\n    面向 SRE 的技术报告，剖析如何构建具备“上帝视角”的可观测性体系。\n\n---\n\n## 🔒 零信任与安全云 (Security Cloud)\n*基于身份中心化与持续校验的现代安全架构实践。*\n\n* **[Cisco ISE: 零信任架构基石](https://weiborao.link/isev2.html)**\n    视觉化呈现 ISE 在 AAA 鉴权、端点合规及安全策略分发中的核心价值。\n* **[当信任变成最致命的漏洞](https://weiborao.link/isestory.html)**\n    关于边界安全失效后的深度反思，探讨为什么“持续校验”是现代安全的唯一出路。\n* **[Cisco SNA: 从网络数据中提取安全价值](https://weiborao.link/sna.html)**\n    利用 Stealthwatch 流量分析技术，识别内网中的潜伏威胁与异常行为。\n* **[eBPF Tetragon + Splunk + Foundation-sec 智能安全闭环](https://weiborao.link/sec8b.html)**\n    构建从内核审计到大规模日志分析的智能防御生态。\n\n---\n\n## ☁️ 云原生与基础设施自动化\n*通过代码定义一切 (Everything as Code)，实现分钟级的环境交付。*\n\n* **[Kubernetes with CNI Cilium 深度实践](https://weiborao.link/K8S-Cilium-Replace-kube-proxy.html)**\n    详述如何使用自动化脚本创建 K8S 集群，并彻底替换传统的 kube-proxy。\n* **[Ansible-K8S-Cilium 自动化实验项目](https://weiborao.link/Ansible-K8S-Cilium.html)**\n    完整的 Ansible Playbook 实践，涵盖从虚拟机初始化到 BGP 网络配置的全流程。\n* **[AppDynamics AMI & Cloud-init 自动化镜像制作](https://weiborao.link/Update-the-cloud-init-code-for-AppD-AMI.html)**\n    利用 Cloud-init 脚本在 AWS 上快速构建预装监控探针的企业级系统镜像。\n\n---\n\n## 🌐 网络架构与深度诊断\n*深挖协议栈与硬件卸载技术，优化底层传输效能。*\n\n* **[Cisco CSR1000v KVM SRIOV 性能优化指南](https://weiborao.link/csr1kv-kvm-Ubuntu20-04-md.html)**\n    涵盖 SR-IOV 配置、HugePages 开启及 vCPU 亲和性绑定的深度调优指南。\n* **[有关 AnyCast 技术简述](https://weiborao.link/anycast-brief.html)**\n    通俗易懂地解释 AnyCast 的路由机制及其在 DDoS 防御中的天然优势。\n* **[[在Docker容器中tcpdump抓包探秘Traceroute](https://weiborao.link/docker-traceroute-tcpdump.html)]**\n    在一个纯净的容器环境下进行抓包分析Traceroute的过程；通过番外篇介绍ThousandEyes的探针在容器中安装部署，并展示路径可视化分析的效果。\n\n---\n\n## 🤖 AI 辅助开发与赋能系列\n*探索生成式 AI 如何重构技术生产力。*\n\n* **[与 ChatGPT 对话：AI 助手加速云计算开发](https://weiborao.link/Conversation-with-ChatGPT-to-accelerate-Cloud-Develpment.html)**\n    实战展示如何利用大模型生成高质量的 IaC（基础设施即代码）片段。\n* **[eBPF 重构 IT 基础设施交付的基石](https://weiborao.link/ebpv2.html)**\n    AI 赋能下的基础设施思考，探讨可编程内核对 DevOps 文化的深远影响。\n* **[面向未来的 IT 基础设施架构：eBPF 赋能之旅](https://weiborao.link/ebpfv3.html)**\n    勾勒未来五年的技术路线图。\n\n---\n\n### 🔙 [返回博客首页](/)","slug":"My-GenAI-works-md","published":1,"updated":"2025-12-25T08:09:03.327Z","_id":"cuidRzIjncvDVP-GxEw7roZF7","comments":1,"photos":[],"content":"<h1 id=\"🚀-技术作品集-Technical-Portfolio\"><a href=\"#🚀-技术作品集-Technical-Portfolio\" class=\"headerlink\" title=\"🚀 技术作品集 | Technical Portfolio\"></a>🚀 技术作品集 | Technical Portfolio</h1><p>这里是我在基础设施可编程、网络安全及自动化领域的实战记录与深度洞察，本文为AI生成。</p>\n<hr>\n<h2 id=\"🛡️-eBPF-与可观测性-Canvas-交互系列\"><a href=\"#🛡️-eBPF-与可观测性-Canvas-交互系列\" class=\"headerlink\" title=\"🛡️ eBPF 与可观测性 (Canvas 交互系列)\"></a>🛡️ eBPF 与可观测性 (Canvas 交互系列)</h2><p><em>将复杂的 Linux 内核逻辑转化为交互式视觉专题。</em></p>\n<ul>\n<li><strong><a href=\"https://weiborao.link/ebpf.html\">eBPF: Linux 内核的超能力</a></strong><br>  深度解析 eBPF 如何重塑现代化基础设施平台，涵盖 JIT 编译、Verifier 验证器及 2025 年最新的 Netkit 演进。</li>\n<li><strong><a href=\"https://weiborao.link/cilium.html\">Cilium: eBPF 重塑云原生基础设施</a></strong><br>  探讨 Cilium 如何利用服务身份（Identity）而非 IP 寻址，提供 L7 层级的深度隔离与高性能网络。</li>\n<li><strong><a href=\"https://weiborao.link/tetragon.html\">Tetragon: 云原生安全的最后一道防线</a></strong><br>  实战模拟 “Dark-Chain” 攻击，演示如何在内核态实现亚毫秒级的实时威胁阻断。</li>\n<li><strong><a href=\"https://weiborao.link/ebpfsre.html\">Project Deep Sight: 重塑云原生基座</a></strong><br>  面向 SRE 的技术报告，剖析如何构建具备“上帝视角”的可观测性体系。</li>\n</ul>\n<hr>\n<h2 id=\"🔒-零信任与安全云-Security-Cloud\"><a href=\"#🔒-零信任与安全云-Security-Cloud\" class=\"headerlink\" title=\"🔒 零信任与安全云 (Security Cloud)\"></a>🔒 零信任与安全云 (Security Cloud)</h2><p><em>基于身份中心化与持续校验的现代安全架构实践。</em></p>\n<ul>\n<li><strong><a href=\"https://weiborao.link/isev2.html\">Cisco ISE: 零信任架构基石</a></strong><br>  视觉化呈现 ISE 在 AAA 鉴权、端点合规及安全策略分发中的核心价值。</li>\n<li><strong><a href=\"https://weiborao.link/isestory.html\">当信任变成最致命的漏洞</a></strong><br>  关于边界安全失效后的深度反思，探讨为什么“持续校验”是现代安全的唯一出路。</li>\n<li><strong><a href=\"https://weiborao.link/sna.html\">Cisco SNA: 从网络数据中提取安全价值</a></strong><br>  利用 Stealthwatch 流量分析技术，识别内网中的潜伏威胁与异常行为。</li>\n<li><strong><a href=\"https://weiborao.link/sec8b.html\">eBPF Tetragon + Splunk + Foundation-sec 智能安全闭环</a></strong><br>  构建从内核审计到大规模日志分析的智能防御生态。</li>\n</ul>\n<hr>\n<h2 id=\"☁️-云原生与基础设施自动化\"><a href=\"#☁️-云原生与基础设施自动化\" class=\"headerlink\" title=\"☁️ 云原生与基础设施自动化\"></a>☁️ 云原生与基础设施自动化</h2><p><em>通过代码定义一切 (Everything as Code)，实现分钟级的环境交付。</em></p>\n<ul>\n<li><strong><a href=\"https://weiborao.link/K8S-Cilium-Replace-kube-proxy.html\">Kubernetes with CNI Cilium 深度实践</a></strong><br>  详述如何使用自动化脚本创建 K8S 集群，并彻底替换传统的 kube-proxy。</li>\n<li><strong><a href=\"https://weiborao.link/Ansible-K8S-Cilium.html\">Ansible-K8S-Cilium 自动化实验项目</a></strong><br>  完整的 Ansible Playbook 实践，涵盖从虚拟机初始化到 BGP 网络配置的全流程。</li>\n<li><strong><a href=\"https://weiborao.link/Update-the-cloud-init-code-for-AppD-AMI.html\">AppDynamics AMI &amp; Cloud-init 自动化镜像制作</a></strong><br>  利用 Cloud-init 脚本在 AWS 上快速构建预装监控探针的企业级系统镜像。</li>\n</ul>\n<hr>\n<h2 id=\"🌐-网络架构与深度诊断\"><a href=\"#🌐-网络架构与深度诊断\" class=\"headerlink\" title=\"🌐 网络架构与深度诊断\"></a>🌐 网络架构与深度诊断</h2><p><em>深挖协议栈与硬件卸载技术，优化底层传输效能。</em></p>\n<ul>\n<li><strong><a href=\"https://weiborao.link/csr1kv-kvm-Ubuntu20-04-md.html\">Cisco CSR1000v KVM SRIOV 性能优化指南</a></strong><br>  涵盖 SR-IOV 配置、HugePages 开启及 vCPU 亲和性绑定的深度调优指南。</li>\n<li><strong><a href=\"https://weiborao.link/anycast-brief.html\">有关 AnyCast 技术简述</a></strong><br>  通俗易懂地解释 AnyCast 的路由机制及其在 DDoS 防御中的天然优势。</li>\n<li><strong>[<a href=\"https://weiborao.link/docker-traceroute-tcpdump.html\">在Docker容器中tcpdump抓包探秘Traceroute</a>]</strong><br>  在一个纯净的容器环境下进行抓包分析Traceroute的过程；通过番外篇介绍ThousandEyes的探针在容器中安装部署，并展示路径可视化分析的效果。</li>\n</ul>\n<hr>\n<h2 id=\"🤖-AI-辅助开发与赋能系列\"><a href=\"#🤖-AI-辅助开发与赋能系列\" class=\"headerlink\" title=\"🤖 AI 辅助开发与赋能系列\"></a>🤖 AI 辅助开发与赋能系列</h2><p><em>探索生成式 AI 如何重构技术生产力。</em></p>\n<ul>\n<li><strong><a href=\"https://weiborao.link/Conversation-with-ChatGPT-to-accelerate-Cloud-Develpment.html\">与 ChatGPT 对话：AI 助手加速云计算开发</a></strong><br>  实战展示如何利用大模型生成高质量的 IaC（基础设施即代码）片段。</li>\n<li><strong><a href=\"https://weiborao.link/ebpv2.html\">eBPF 重构 IT 基础设施交付的基石</a></strong><br>  AI 赋能下的基础设施思考，探讨可编程内核对 DevOps 文化的深远影响。</li>\n<li><strong><a href=\"https://weiborao.link/ebpfv3.html\">面向未来的 IT 基础设施架构：eBPF 赋能之旅</a></strong><br>  勾勒未来五年的技术路线图。</li>\n</ul>\n<hr>\n<h3 id=\"🔙-返回博客首页\"><a href=\"#🔙-返回博客首页\" class=\"headerlink\" title=\"🔙 返回博客首页\"></a>🔙 <a href=\"/\">返回博客首页</a></h3>","length":862,"excerpt":"","more":"<h1 id=\"🚀-技术作品集-Technical-Portfolio\"><a href=\"#🚀-技术作品集-Technical-Portfolio\" class=\"headerlink\" title=\"🚀 技术作品集 | Technical Portfolio\"></a>🚀 技术作品集 | Technical Portfolio</h1><p>这里是我在基础设施可编程、网络安全及自动化领域的实战记录与深度洞察，本文为AI生成。</p>\n<hr>\n<h2 id=\"🛡️-eBPF-与可观测性-Canvas-交互系列\"><a href=\"#🛡️-eBPF-与可观测性-Canvas-交互系列\" class=\"headerlink\" title=\"🛡️ eBPF 与可观测性 (Canvas 交互系列)\"></a>🛡️ eBPF 与可观测性 (Canvas 交互系列)</h2><p><em>将复杂的 Linux 内核逻辑转化为交互式视觉专题。</em></p>\n<ul>\n<li><strong><a href=\"https://weiborao.link/ebpf.html\">eBPF: Linux 内核的超能力</a></strong><br>  深度解析 eBPF 如何重塑现代化基础设施平台，涵盖 JIT 编译、Verifier 验证器及 2025 年最新的 Netkit 演进。</li>\n<li><strong><a href=\"https://weiborao.link/cilium.html\">Cilium: eBPF 重塑云原生基础设施</a></strong><br>  探讨 Cilium 如何利用服务身份（Identity）而非 IP 寻址，提供 L7 层级的深度隔离与高性能网络。</li>\n<li><strong><a href=\"https://weiborao.link/tetragon.html\">Tetragon: 云原生安全的最后一道防线</a></strong><br>  实战模拟 “Dark-Chain” 攻击，演示如何在内核态实现亚毫秒级的实时威胁阻断。</li>\n<li><strong><a href=\"https://weiborao.link/ebpfsre.html\">Project Deep Sight: 重塑云原生基座</a></strong><br>  面向 SRE 的技术报告，剖析如何构建具备“上帝视角”的可观测性体系。</li>\n</ul>\n<hr>\n<h2 id=\"🔒-零信任与安全云-Security-Cloud\"><a href=\"#🔒-零信任与安全云-Security-Cloud\" class=\"headerlink\" title=\"🔒 零信任与安全云 (Security Cloud)\"></a>🔒 零信任与安全云 (Security Cloud)</h2><p><em>基于身份中心化与持续校验的现代安全架构实践。</em></p>\n<ul>\n<li><strong><a href=\"https://weiborao.link/isev2.html\">Cisco ISE: 零信任架构基石</a></strong><br>  视觉化呈现 ISE 在 AAA 鉴权、端点合规及安全策略分发中的核心价值。</li>\n<li><strong><a href=\"https://weiborao.link/isestory.html\">当信任变成最致命的漏洞</a></strong><br>  关于边界安全失效后的深度反思，探讨为什么“持续校验”是现代安全的唯一出路。</li>\n<li><strong><a href=\"https://weiborao.link/sna.html\">Cisco SNA: 从网络数据中提取安全价值</a></strong><br>  利用 Stealthwatch 流量分析技术，识别内网中的潜伏威胁与异常行为。</li>\n<li><strong><a href=\"https://weiborao.link/sec8b.html\">eBPF Tetragon + Splunk + Foundation-sec 智能安全闭环</a></strong><br>  构建从内核审计到大规模日志分析的智能防御生态。</li>\n</ul>\n<hr>\n<h2 id=\"☁️-云原生与基础设施自动化\"><a href=\"#☁️-云原生与基础设施自动化\" class=\"headerlink\" title=\"☁️ 云原生与基础设施自动化\"></a>☁️ 云原生与基础设施自动化</h2><p><em>通过代码定义一切 (Everything as Code)，实现分钟级的环境交付。</em></p>\n<ul>\n<li><strong><a href=\"https://weiborao.link/K8S-Cilium-Replace-kube-proxy.html\">Kubernetes with CNI Cilium 深度实践</a></strong><br>  详述如何使用自动化脚本创建 K8S 集群，并彻底替换传统的 kube-proxy。</li>\n<li><strong><a href=\"https://weiborao.link/Ansible-K8S-Cilium.html\">Ansible-K8S-Cilium 自动化实验项目</a></strong><br>  完整的 Ansible Playbook 实践，涵盖从虚拟机初始化到 BGP 网络配置的全流程。</li>\n<li><strong><a href=\"https://weiborao.link/Update-the-cloud-init-code-for-AppD-AMI.html\">AppDynamics AMI &amp; Cloud-init 自动化镜像制作</a></strong><br>  利用 Cloud-init 脚本在 AWS 上快速构建预装监控探针的企业级系统镜像。</li>\n</ul>\n<hr>\n<h2 id=\"🌐-网络架构与深度诊断\"><a href=\"#🌐-网络架构与深度诊断\" class=\"headerlink\" title=\"🌐 网络架构与深度诊断\"></a>🌐 网络架构与深度诊断</h2><p><em>深挖协议栈与硬件卸载技术，优化底层传输效能。</em></p>\n<ul>\n<li><strong><a href=\"https://weiborao.link/csr1kv-kvm-Ubuntu20-04-md.html\">Cisco CSR1000v KVM SRIOV 性能优化指南</a></strong><br>  涵盖 SR-IOV 配置、HugePages 开启及 vCPU 亲和性绑定的深度调优指南。</li>\n<li><strong><a href=\"https://weiborao.link/anycast-brief.html\">有关 AnyCast 技术简述</a></strong><br>  通俗易懂地解释 AnyCast 的路由机制及其在 DDoS 防御中的天然优势。</li>\n<li><strong>[<a href=\"https://weiborao.link/docker-traceroute-tcpdump.html\">在Docker容器中tcpdump抓包探秘Traceroute</a>]</strong><br>  在一个纯净的容器环境下进行抓包分析Traceroute的过程；通过番外篇介绍ThousandEyes的探针在容器中安装部署，并展示路径可视化分析的效果。</li>\n</ul>\n<hr>\n<h2 id=\"🤖-AI-辅助开发与赋能系列\"><a href=\"#🤖-AI-辅助开发与赋能系列\" class=\"headerlink\" title=\"🤖 AI 辅助开发与赋能系列\"></a>🤖 AI 辅助开发与赋能系列</h2><p><em>探索生成式 AI 如何重构技术生产力。</em></p>\n<ul>\n<li><strong><a href=\"https://weiborao.link/Conversation-with-ChatGPT-to-accelerate-Cloud-Develpment.html\">与 ChatGPT 对话：AI 助手加速云计算开发</a></strong><br>  实战展示如何利用大模型生成高质量的 IaC（基础设施即代码）片段。</li>\n<li><strong><a href=\"https://weiborao.link/ebpv2.html\">eBPF 重构 IT 基础设施交付的基石</a></strong><br>  AI 赋能下的基础设施思考，探讨可编程内核对 DevOps 文化的深远影响。</li>\n<li><strong><a href=\"https://weiborao.link/ebpfv3.html\">面向未来的 IT 基础设施架构：eBPF 赋能之旅</a></strong><br>  勾勒未来五年的技术路线图。</li>\n</ul>\n<hr>\n<h3 id=\"🔙-返回博客首页\"><a href=\"#🔙-返回博客首页\" class=\"headerlink\" title=\"🔙 返回博客首页\"></a>🔙 <a href=\"/\">返回博客首页</a></h3>"},{"layout":"post","title":"Tetragon 技术展示","date":"2026-01-04T15:30:00.000Z","_content":"\n从“看见”到“拦截”：eBPF 如何重塑云原生安全？ 🛡️\n\n在复杂的 Kubernetes 生态中，如何能在不拖慢系统性能的前提下，实时感知并阻止恶意攻击？\n\n最近我深度解析了基于 eBPF 的安全利器——Tetragon。\n\n我不仅关注它如何安装，更关注它如何利用 Linux 内核钩子实现“零感知”审计。\n\n在这篇文章中，我将带你从底层原理到实战演练，手把手构建一套现代化的运行时安全体系。\n\n技术不应只是冰冷的文档，而是守护业务的盾牌。\n\n你可以在下方直接浏览，或点击链接全屏查看。\n\n<!--more-->\n\n<div style=\"position: relative; width: 100%; height: 0; padding-bottom: 75%; overflow: hidden; border: 1px solid #eee; border-radius: 8px;\">\n    <iframe src=\"/tetragon.html\" style=\"position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0;\"></iframe>\n</div>\n\n<div style=\"margin-top: 20px; text-align: center;\">\n    <a href=\"/tetragon.html\" target=\"_blank\" style=\"display: inline-block; padding: 10px 20px; background: #333; color: #fff; text-decoration: none; border-radius: 4px;\">🚀 全屏浏览此页面</a>\n</div>","source":"_posts/tetragon-md.md","raw":"---\nlayout: post\ntitle: Tetragon 技术展示\ndate: 2026-01-04 23:30:00\ntags: [eBPF, Linux, Tetragon, Runtime Security]\n---\n\n从“看见”到“拦截”：eBPF 如何重塑云原生安全？ 🛡️\n\n在复杂的 Kubernetes 生态中，如何能在不拖慢系统性能的前提下，实时感知并阻止恶意攻击？\n\n最近我深度解析了基于 eBPF 的安全利器——Tetragon。\n\n我不仅关注它如何安装，更关注它如何利用 Linux 内核钩子实现“零感知”审计。\n\n在这篇文章中，我将带你从底层原理到实战演练，手把手构建一套现代化的运行时安全体系。\n\n技术不应只是冰冷的文档，而是守护业务的盾牌。\n\n你可以在下方直接浏览，或点击链接全屏查看。\n\n<!--more-->\n\n<div style=\"position: relative; width: 100%; height: 0; padding-bottom: 75%; overflow: hidden; border: 1px solid #eee; border-radius: 8px;\">\n    <iframe src=\"/tetragon.html\" style=\"position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0;\"></iframe>\n</div>\n\n<div style=\"margin-top: 20px; text-align: center;\">\n    <a href=\"/tetragon.html\" target=\"_blank\" style=\"display: inline-block; padding: 10px 20px; background: #333; color: #fff; text-decoration: none; border-radius: 4px;\">🚀 全屏浏览此页面</a>\n</div>","slug":"tetragon-md","published":1,"updated":"2026-01-04T16:02:50.401Z","comments":1,"photos":[],"_id":"cuidhj7VdTUNPOIVs7OURh0Qt","content":"<p>从“看见”到“拦截”：eBPF 如何重塑云原生安全？ 🛡️</p>\n<p>在复杂的 Kubernetes 生态中，如何能在不拖慢系统性能的前提下，实时感知并阻止恶意攻击？</p>\n<p>最近我深度解析了基于 eBPF 的安全利器——Tetragon。</p>\n<p>我不仅关注它如何安装，更关注它如何利用 Linux 内核钩子实现“零感知”审计。</p>\n<p>在这篇文章中，我将带你从底层原理到实战演练，手把手构建一套现代化的运行时安全体系。</p>\n<p>技术不应只是冰冷的文档，而是守护业务的盾牌。</p>\n<p>你可以在下方直接浏览，或点击链接全屏查看。</p>\n<span id=\"more\"></span>\n\n<div style=\"position: relative; width: 100%; height: 0; padding-bottom: 75%; overflow: hidden; border: 1px solid #eee; border-radius: 8px;\">\n    <iframe src=\"/tetragon.html\" style=\"position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0;\"></iframe>\n</div>\n\n<div style=\"margin-top: 20px; text-align: center;\">\n    <a href=\"/tetragon.html\" target=\"_blank\" style=\"display: inline-block; padding: 10px 20px; background: #333; color: #fff; text-decoration: none; border-radius: 4px;\">🚀 全屏浏览此页面</a>\n</div>","length":252,"excerpt":"<p>从“看见”到“拦截”：eBPF 如何重塑云原生安全？ 🛡️</p>\n<p>在复杂的 Kubernetes 生态中，如何能在不拖慢系统性能的前提下，实时感知并阻止恶意攻击？</p>\n<p>最近我深度解析了基于 eBPF 的安全利器——Tetragon。</p>\n<p>我不仅关注它如何安装，更关注它如何利用 Linux 内核钩子实现“零感知”审计。</p>\n<p>在这篇文章中，我将带你从底层原理到实战演练，手把手构建一套现代化的运行时安全体系。</p>\n<p>技术不应只是冰冷的文档，而是守护业务的盾牌。</p>\n<p>你可以在下方直接浏览，或点击链接全屏查看。</p>","more":"<div style=\"position: relative; width: 100%; height: 0; padding-bottom: 75%; overflow: hidden; border: 1px solid #eee; border-radius: 8px;\">\n    <iframe src=\"/tetragon.html\" style=\"position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: 0;\"></iframe>\n</div>\n\n<div style=\"margin-top: 20px; text-align: center;\">\n    <a href=\"/tetragon.html\" target=\"_blank\" style=\"display: inline-block; padding: 10px 20px; background: #333; color: #fff; text-decoration: none; border-radius: 4px;\">🚀 全屏浏览此页面</a>\n</div>"}],"PostAsset":[{"_id":"source/_posts/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-vv3.png","slug":"SCR-20230301-vv3.png","post":"cuidNXthGD9-T8SpACZm2xcgB","modified":0,"renderable":0},{"_id":"source/_posts/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-vxg.png","slug":"SCR-20230301-vxg.png","post":"cuidNXthGD9-T8SpACZm2xcgB","modified":0,"renderable":0},{"_id":"source/_posts/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-vz3.png","slug":"SCR-20230301-vz3.png","post":"cuidNXthGD9-T8SpACZm2xcgB","modified":0,"renderable":0},{"_id":"source/_posts/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-w1c.png","slug":"SCR-20230301-w1c.png","post":"cuidNXthGD9-T8SpACZm2xcgB","modified":0,"renderable":0},{"_id":"source/_posts/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-w1t.png","slug":"SCR-20230301-w1t.png","post":"cuidNXthGD9-T8SpACZm2xcgB","modified":0,"renderable":0},{"_id":"source/_posts/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-w6k.png","slug":"SCR-20230301-w6k.png","post":"cuidNXthGD9-T8SpACZm2xcgB","modified":0,"renderable":0},{"_id":"source/_posts/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-w8d.png","slug":"SCR-20230301-w8d.png","post":"cuidNXthGD9-T8SpACZm2xcgB","modified":0,"renderable":0},{"_id":"source/_posts/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-wa6.png","slug":"SCR-20230301-wa6.png","post":"cuidNXthGD9-T8SpACZm2xcgB","modified":0,"renderable":0},{"_id":"source/_posts/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-wdb.png","slug":"SCR-20230301-wdb.png","post":"cuidNXthGD9-T8SpACZm2xcgB","modified":0,"renderable":0},{"_id":"source/_posts/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-wgi.png","slug":"SCR-20230301-wgi.png","post":"cuidNXthGD9-T8SpACZm2xcgB","modified":0,"renderable":0},{"_id":"source/_posts/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-wi7.png","slug":"SCR-20230301-wi7.png","post":"cuidNXthGD9-T8SpACZm2xcgB","modified":0,"renderable":0},{"_id":"source/_posts/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-wle.png","slug":"SCR-20230301-wle.png","post":"cuidNXthGD9-T8SpACZm2xcgB","modified":0,"renderable":0},{"_id":"source/_posts/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-wn8.png","slug":"SCR-20230301-wn8.png","post":"cuidNXthGD9-T8SpACZm2xcgB","modified":0,"renderable":0},{"_id":"source/_posts/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-wob.png","slug":"SCR-20230301-wob.png","post":"cuidNXthGD9-T8SpACZm2xcgB","modified":0,"renderable":0},{"_id":"source/_posts/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-wzx.png","slug":"SCR-20230301-wzx.png","post":"cuidNXthGD9-T8SpACZm2xcgB","modified":0,"renderable":0},{"_id":"source/_posts/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-x5q.png","slug":"SCR-20230301-x5q.png","post":"cuidNXthGD9-T8SpACZm2xcgB","modified":0,"renderable":0},{"_id":"source/_posts/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230301-x8g.png","slug":"SCR-20230301-x8g.png","post":"cuidNXthGD9-T8SpACZm2xcgB","modified":0,"renderable":0},{"_id":"source/_posts/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230302-8x.png","slug":"SCR-20230302-8x.png","post":"cuidNXthGD9-T8SpACZm2xcgB","modified":0,"renderable":0},{"_id":"source/_posts/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230302-a8.png","slug":"SCR-20230302-a8.png","post":"cuidNXthGD9-T8SpACZm2xcgB","modified":0,"renderable":0},{"_id":"source/_posts/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230302-b8.png","slug":"SCR-20230302-b8.png","post":"cuidNXthGD9-T8SpACZm2xcgB","modified":0,"renderable":0},{"_id":"source/_posts/ChatGPT-generate-code-to-build-AMI-for-AppDynamics/SCR-20230302-du.png","slug":"SCR-20230302-du.png","post":"cuidNXthGD9-T8SpACZm2xcgB","modified":0,"renderable":0},{"_id":"source/_posts/Conversation-with-ChatGPT-to-accelerate-Cloud-Develpment/SCR-20230301-wa6.png","slug":"SCR-20230301-wa6.png","post":"cuidslWEZ6BMgBPJO6a90wVT9","modified":0,"renderable":0},{"_id":"source/_posts/Conversation-with-ChatGPT-to-accelerate-Cloud-Develpment/SCR-20230301-wdb.png","slug":"SCR-20230301-wdb.png","post":"cuidslWEZ6BMgBPJO6a90wVT9","modified":0,"renderable":0},{"_id":"source/_posts/Conversation-with-ChatGPT-to-accelerate-Cloud-Develpment/SCR-20230301-wob.png","slug":"SCR-20230301-wob.png","post":"cuidslWEZ6BMgBPJO6a90wVT9","modified":0,"renderable":0},{"_id":"source/_posts/Conversation-with-ChatGPT-to-accelerate-Cloud-Develpment/SCR-20230301-x5q.png","slug":"SCR-20230301-x5q.png","post":"cuidslWEZ6BMgBPJO6a90wVT9","modified":0,"renderable":0},{"_id":"source/_posts/Conversation-with-ChatGPT-to-accelerate-Cloud-Develpment/SCR-20230301-x8g.png","slug":"SCR-20230301-x8g.png","post":"cuidslWEZ6BMgBPJO6a90wVT9","modified":0,"renderable":0},{"_id":"source/_posts/Conversation-with-ChatGPT-to-accelerate-Cloud-Develpment/SCR-20230302-8x.png","slug":"SCR-20230302-8x.png","post":"cuidslWEZ6BMgBPJO6a90wVT9","modified":0,"renderable":0},{"_id":"source/_posts/Conversation-with-ChatGPT-to-accelerate-Cloud-Develpment/SCR-20230302-a8.png","slug":"SCR-20230302-a8.png","post":"cuidslWEZ6BMgBPJO6a90wVT9","modified":0,"renderable":0},{"_id":"source/_posts/Conversation-with-ChatGPT-to-accelerate-Cloud-Develpment/SCR-20230302-b8.png","slug":"SCR-20230302-b8.png","post":"cuidslWEZ6BMgBPJO6a90wVT9","modified":0,"renderable":0},{"_id":"source/_posts/Conversation-with-ChatGPT-to-accelerate-Cloud-Develpment/SCR-20230302-w8m.png","slug":"SCR-20230302-w8m.png","post":"cuidslWEZ6BMgBPJO6a90wVT9","modified":0,"renderable":0},{"_id":"source/_posts/Conversation-with-ChatGPT-to-accelerate-Cloud-Develpment/SCR-20230303-mp.png","slug":"SCR-20230303-mp.png","post":"cuidslWEZ6BMgBPJO6a90wVT9","modified":0,"renderable":0},{"_id":"source/_posts/docker-traceroute-tcpdump/container-module-in-docker-network.png","slug":"container-module-in-docker-network.png","post":"cuid4D4jqFLyj5HtJ5uWNkV-p","modified":0,"renderable":0},{"_id":"source/_posts/docker-traceroute-tcpdump/docker-packet1-36.png","slug":"docker-packet1-36.png","post":"cuid4D4jqFLyj5HtJ5uWNkV-p","modified":0,"renderable":0},{"_id":"source/_posts/docker-traceroute-tcpdump/probe-anycast-dns.png","slug":"probe-anycast-dns.png","post":"cuid4D4jqFLyj5HtJ5uWNkV-p","modified":0,"renderable":0},{"_id":"source/_posts/docker-traceroute-tcpdump/te-agent-docker.png","slug":"te-agent-docker.png","post":"cuid4D4jqFLyj5HtJ5uWNkV-p","modified":0,"renderable":0},{"_id":"source/_posts/docker-traceroute-tcpdump/thousandeyes-path-node1.png","slug":"thousandeyes-path-node1.png","post":"cuid4D4jqFLyj5HtJ5uWNkV-p","modified":0,"renderable":0},{"_id":"source/_posts/docker-traceroute-tcpdump/thousandeyes-path-node2.png","slug":"thousandeyes-path-node2.png","post":"cuid4D4jqFLyj5HtJ5uWNkV-p","modified":0,"renderable":0},{"_id":"source/_posts/docker-traceroute-tcpdump/thousandeyes-path-node3.png","slug":"thousandeyes-path-node3.png","post":"cuid4D4jqFLyj5HtJ5uWNkV-p","modified":0,"renderable":0},{"_id":"source/_posts/docker-traceroute-tcpdump/thousandeyes-path.png","slug":"thousandeyes-path.png","post":"cuid4D4jqFLyj5HtJ5uWNkV-p","modified":0,"renderable":0},{"_id":"source/_posts/docker-traceroute-tcpdump/traceroute-ubuntu.pcapng","slug":"traceroute-ubuntu.pcapng","post":"cuid4D4jqFLyj5HtJ5uWNkV-p","modified":0,"renderable":0},{"_id":"source/_posts/docker-traceroute-tcpdump/wireshark-int-list.png","slug":"wireshark-int-list.png","post":"cuid4D4jqFLyj5HtJ5uWNkV-p","modified":0,"renderable":0},{"_id":"source/_posts/get-known-traceroute-by-wireshark/AS-query-1.png","slug":"AS-query-1.png","post":"cuidP4cJUhUqjSVn67nvwwNua","modified":0,"renderable":0},{"_id":"source/_posts/get-known-traceroute-by-wireshark/AS-reply-1.png","slug":"AS-reply-1.png","post":"cuidP4cJUhUqjSVn67nvwwNua","modified":0,"renderable":0},{"_id":"source/_posts/get-known-traceroute-by-wireshark/ICMP-Reply-1.png","slug":"ICMP-Reply-1.png","post":"cuidP4cJUhUqjSVn67nvwwNua","modified":0,"renderable":0},{"_id":"source/_posts/get-known-traceroute-by-wireshark/ICMP-last-reply.png","slug":"ICMP-last-reply.png","post":"cuidP4cJUhUqjSVn67nvwwNua","modified":0,"renderable":0},{"_id":"source/_posts/get-known-traceroute-by-wireshark/Traceroute 过程.drawio","slug":"Traceroute 过程.drawio","post":"cuidP4cJUhUqjSVn67nvwwNua","modified":0,"renderable":0},{"_id":"source/_posts/get-known-traceroute-by-wireshark/Traceroute-work.png","slug":"Traceroute-work.png","post":"cuidP4cJUhUqjSVn67nvwwNua","modified":0,"renderable":0},{"_id":"source/_posts/get-known-traceroute-by-wireshark/UDP-Probe-1.png","slug":"UDP-Probe-1.png","post":"cuidP4cJUhUqjSVn67nvwwNua","modified":0,"renderable":0},{"_id":"source/_posts/get-known-traceroute-by-wireshark/UDP-Probe-2.png","slug":"UDP-Probe-2.png","post":"cuidP4cJUhUqjSVn67nvwwNua","modified":0,"renderable":0},{"_id":"source/_posts/get-known-traceroute-by-wireshark/dns-query-1.png","slug":"dns-query-1.png","post":"cuidP4cJUhUqjSVn67nvwwNua","modified":0,"renderable":0},{"_id":"source/_posts/get-known-traceroute-by-wireshark/packet1-36.png","slug":"packet1-36.png","post":"cuidP4cJUhUqjSVn67nvwwNua","modified":0,"renderable":0},{"_id":"source/_posts/get-known-traceroute-by-wireshark/traceroute-google-dns.pcapng","slug":"traceroute-google-dns.pcapng","post":"cuidP4cJUhUqjSVn67nvwwNua","modified":0,"renderable":0},{"_id":"source/_posts/get-known-traceroute-by-wireshark/whois-answer-2.png","slug":"whois-answer-2.png","post":"cuidP4cJUhUqjSVn67nvwwNua","modified":0,"renderable":0},{"_id":"source/_posts/get-known-traceroute-by-wireshark/whois-answer.png","slug":"whois-answer.png","post":"cuidP4cJUhUqjSVn67nvwwNua","modified":0,"renderable":0},{"_id":"source/_posts/get-known-traceroute-by-wireshark/whois-query.png","slug":"whois-query.png","post":"cuidP4cJUhUqjSVn67nvwwNua","modified":0,"renderable":0},{"_id":"source/_posts/csr1kv-kvm-CentOS7/line-chart-009.png","slug":"line-chart-009.png","post":"cuidRCOgRoGMsTkR3PcorDgKD","modified":0,"renderable":0},{"_id":"source/_posts/csr1kv-kvm-CentOS7/macvtap-ibm.png","slug":"macvtap-ibm.png","post":"cuidRCOgRoGMsTkR3PcorDgKD","modified":0,"renderable":0},{"_id":"source/_posts/csr1kv-kvm-CentOS7/nic-type-010.png","slug":"nic-type-010.png","post":"cuidRCOgRoGMsTkR3PcorDgKD","modified":0,"renderable":0},{"_id":"source/_posts/csr1kv-kvm-CentOS7/pstree-011.png","slug":"pstree-011.png","post":"cuidRCOgRoGMsTkR3PcorDgKD","modified":0,"renderable":0},{"_id":"source/_posts/csr1kv-kvm-CentOS7/sriov-pool-001.png","slug":"sriov-pool-001.png","post":"cuidRCOgRoGMsTkR3PcorDgKD","modified":0,"renderable":0},{"_id":"source/_posts/csr1kv-kvm-CentOS7/virt-manager-1.png","slug":"virt-manager-1.png","post":"cuidRCOgRoGMsTkR3PcorDgKD","modified":0,"renderable":0},{"_id":"source/_posts/csr1kv-kvm-CentOS7/virt-manager-2.png","slug":"virt-manager-2.png","post":"cuidRCOgRoGMsTkR3PcorDgKD","modified":0,"renderable":0},{"_id":"source/_posts/csr1kv-kvm-CentOS7/virt-manager-3.png","slug":"virt-manager-3.png","post":"cuidRCOgRoGMsTkR3PcorDgKD","modified":0,"renderable":0},{"_id":"source/_posts/csr1kv-kvm-CentOS7/virt-manager-4.png","slug":"virt-manager-4.png","post":"cuidRCOgRoGMsTkR3PcorDgKD","modified":0,"renderable":0},{"_id":"source/_posts/csr1kv-kvm-CentOS7/virt-manager-5.png","slug":"virt-manager-5.png","post":"cuidRCOgRoGMsTkR3PcorDgKD","modified":0,"renderable":0},{"_id":"source/_posts/csr1kv-kvm-CentOS7/virt-manager-6.png","slug":"virt-manager-6.png","post":"cuidRCOgRoGMsTkR3PcorDgKD","modified":0,"renderable":0},{"_id":"source/_posts/csr1kv-kvm-CentOS7/virt-manager-7.png","slug":"virt-manager-7.png","post":"cuidRCOgRoGMsTkR3PcorDgKD","modified":0,"renderable":0},{"_id":"source/_posts/csr1kv-kvm-CentOS7/virt-top-012.png","slug":"virt-top-012.png","post":"cuidRCOgRoGMsTkR3PcorDgKD","modified":0,"renderable":0},{"_id":"source/_posts/traceroute-vulnerability/icmp-echo-reply.png","slug":"icmp-echo-reply.png","post":"cuidNllT4EdXnG074AoaH5I2g","modified":0,"renderable":0},{"_id":"source/_posts/traceroute-vulnerability/icmp-ttl-exceeded.png","slug":"icmp-ttl-exceeded.png","post":"cuidNllT4EdXnG074AoaH5I2g","modified":0,"renderable":0},{"_id":"source/_posts/traceroute-vulnerability/traceroute-vulnerability.png","slug":"traceroute-vulnerability.png","post":"cuidNllT4EdXnG074AoaH5I2g","modified":0,"renderable":0},{"_id":"source/_posts/csr1kv-kvm-Ubuntu20-04-md/add-sriov-pool.png","slug":"add-sriov-pool.png","post":"cuidlMGQmhJ6srse824OJbYiq","modified":0,"renderable":0},{"_id":"source/_posts/csr1kv-kvm-Ubuntu20-04-md/kvm.zip","slug":"kvm.zip","post":"cuidlMGQmhJ6srse824OJbYiq","modified":0,"renderable":0},{"_id":"source/_posts/csr1kv-kvm-Ubuntu20-04-md/line-chart.png","slug":"line-chart.png","post":"cuidlMGQmhJ6srse824OJbYiq","modified":0,"renderable":0},{"_id":"source/_posts/csr1kv-kvm-Ubuntu20-04-md/pic1-sriov-pool.png","slug":"pic1-sriov-pool.png","post":"cuidlMGQmhJ6srse824OJbYiq","modified":0,"renderable":0},{"_id":"source/_posts/csr1kv-kvm-Ubuntu20-04-md/virt-manager-step1.png","slug":"virt-manager-step1.png","post":"cuidlMGQmhJ6srse824OJbYiq","modified":0,"renderable":0},{"_id":"source/_posts/csr1kv-kvm-Ubuntu20-04-md/virt-manager-step2-2.png","slug":"virt-manager-step2-2.png","post":"cuidlMGQmhJ6srse824OJbYiq","modified":0,"renderable":0},{"_id":"source/_posts/csr1kv-kvm-Ubuntu20-04-md/virt-manager-step2.png","slug":"virt-manager-step2.png","post":"cuidlMGQmhJ6srse824OJbYiq","modified":0,"renderable":0},{"_id":"source/_posts/csr1kv-kvm-Ubuntu20-04-md/virt-manager-step3.png","slug":"virt-manager-step3.png","post":"cuidlMGQmhJ6srse824OJbYiq","modified":0,"renderable":0},{"_id":"source/_posts/csr1kv-kvm-Ubuntu20-04-md/virt-manager-step4.png","slug":"virt-manager-step4.png","post":"cuidlMGQmhJ6srse824OJbYiq","modified":0,"renderable":0}],"PostCategory":[{"post_id":"cuid6vlNGu1X047RteIEyQJtd","category_id":"cuidobEyq_vlTOF1kRET6mtA-","_id":"cuidX7ygnuVXcvjyMS3Zvpz0N"},{"post_id":"cuidtg_FuUlUQQ5BRfGY8QsMI","category_id":"cuidobEyq_vlTOF1kRET6mtA-","_id":"cuid8ovlRqan8MA5_bsXnAamG"}],"PostTag":[{"post_id":"cuid6vlNGu1X047RteIEyQJtd","tag_id":"cuidnGxNQfexraVXTZe1e-NbO","_id":"cuidgaMVeNDtbqrytYvANgt1C"},{"post_id":"cuid6vlNGu1X047RteIEyQJtd","tag_id":"cuidZmhPvOHKAc_qCK650Gu0O","_id":"cuidC73-dLiv_YTqdAopmmu0m"},{"post_id":"cuid6vlNGu1X047RteIEyQJtd","tag_id":"cuidtQqcCn7QHGYxMEOt3Ptod","_id":"cuidK39JFSqE3WuLliJyJ2jYM"},{"post_id":"cuidNXthGD9-T8SpACZm2xcgB","tag_id":"cuidpWu1wC7QeUIbTF0zyTW3V","_id":"cuidtV3B7v_-4uOewlKLx5VQO"},{"post_id":"cuidNXthGD9-T8SpACZm2xcgB","tag_id":"cuidBaKr3iA3BObxFwXzcJHwD","_id":"cuidAzOsApjnIKKYgWpOjXHmG"},{"post_id":"cuidNXthGD9-T8SpACZm2xcgB","tag_id":"cuidcOrlH7jjuwlzirDQVwzT5","_id":"cuidKOhqAQplEFRTlBJazhrvf"},{"post_id":"cuidNXthGD9-T8SpACZm2xcgB","tag_id":"cuidvGjIg_wqeF3BlFUOCWakR","_id":"cuidvvRMP4w1wedTrFVu4424s"},{"post_id":"cuiduwhVLGliVaOsJLVasBbIs","tag_id":"cuidMabful0DymbvqG1awmBIB","_id":"cuid2EKoNGPZBhqunfVII-LoS"},{"post_id":"cuidslWEZ6BMgBPJO6a90wVT9","tag_id":"cuidpWu1wC7QeUIbTF0zyTW3V","_id":"cuidVmOZmUZYCtINg80LkGkxQ"},{"post_id":"cuidslWEZ6BMgBPJO6a90wVT9","tag_id":"cuidKKChclVJlQMDTi1-p_c6J","_id":"cuidx6YLGYUUyWvVc8iXC4cOu"},{"post_id":"cuidslWEZ6BMgBPJO6a90wVT9","tag_id":"cuide-3osxwOLov_UmKbB3UVD","_id":"cuidnoVsCG8zgWhDJhg-rYvjI"},{"post_id":"cuidslWEZ6BMgBPJO6a90wVT9","tag_id":"cuidBaKr3iA3BObxFwXzcJHwD","_id":"cuiduROpkfZNYdpmJ0CYkRZjJ"},{"post_id":"cuidslWEZ6BMgBPJO6a90wVT9","tag_id":"cuidcOrlH7jjuwlzirDQVwzT5","_id":"cuidpB52Rkf8VG95YLycQnezf"},{"post_id":"cuidslWEZ6BMgBPJO6a90wVT9","tag_id":"cuidvGjIg_wqeF3BlFUOCWakR","_id":"cuidvi8WhiyZXMxBg5ZeGjfxE"},{"post_id":"cuidvZ2R6C5lWECwhyVL4oFAS","tag_id":"cuidT1kXnFPcY3ZQU14xWlHa1","_id":"cuidk-O4daxFZ7VCUxcsWrel_"},{"post_id":"cuidvZ2R6C5lWECwhyVL4oFAS","tag_id":"cuidzAWLIkJBq4opFqG68WQTY","_id":"cuidyHlpnGCtii7oQR5UI7zYt"},{"post_id":"cuidvZ2R6C5lWECwhyVL4oFAS","tag_id":"cuidjfU2VPZ5BFoTuwGZlhBj0","_id":"cuidelWJRG9zUls7hyBDtpCYc"},{"post_id":"cuidalk9exSsOGPnRMK_pTACa","tag_id":"cuidpfHSrMIwjmG_ufVcwhmng","_id":"cuidcZKj0tOX0tb9nqg85Rjfq"},{"post_id":"cuidalk9exSsOGPnRMK_pTACa","tag_id":"cuidOp0WIspqKLy86O4USw62R","_id":"cuid9tMPO4QsdV9EmMCQkf6mE"},{"post_id":"cuid6x1Z-P-eIi0SWdr69o_ot","tag_id":"cuidAEVFsWdcCGXXQ28YIYQOr","_id":"cuidKrMbeWaTlHK3-_c0d_xsk"},{"post_id":"cuid6x1Z-P-eIi0SWdr69o_ot","tag_id":"cuidvGjIg_wqeF3BlFUOCWakR","_id":"cuidQum4z2ahwmP9KLIjrkLpw"},{"post_id":"cuidOrYEGbG1wwCNgePOc-cRG","tag_id":"cuidosd6d6s_5Ikb21vG-NLk3","_id":"cuid1tOoQqTJh0dDz1u6p6yAC"},{"post_id":"cuidOrYEGbG1wwCNgePOc-cRG","tag_id":"cuidjfU2VPZ5BFoTuwGZlhBj0","_id":"cuidvSRuhABd15cTEiI4iOdVe"},{"post_id":"cuid4D4jqFLyj5HtJ5uWNkV-p","tag_id":"cuidcQaJvq7-Cs27V1PYSAAi0","_id":"cuidvZBi9A4wWkChPEfUbZJvD"},{"post_id":"cuid4D4jqFLyj5HtJ5uWNkV-p","tag_id":"cuidWS-GVvxHRxfbmCi0Cjoyl","_id":"cuidCWbjmbMEYiZv-OIYwCpYG"},{"post_id":"cuid4D4jqFLyj5HtJ5uWNkV-p","tag_id":"cuid1-tCUh2V05cvmDsKJvEHz","_id":"cuidUSkiEVC_jkOwaZKfYgQX1"},{"post_id":"cuidyitPcZc94wsVJ0_DWj0LO","tag_id":"cuidC-m_DYizyxSuAzUAXoxG7","_id":"cuid1uCvnnIEYgWsvBWFDt_M7"},{"post_id":"cuidP4cJUhUqjSVn67nvwwNua","tag_id":"cuid1-tCUh2V05cvmDsKJvEHz","_id":"cuid-d46yfSIKt7NzT3GS7t8k"},{"post_id":"cuidP4cJUhUqjSVn67nvwwNua","tag_id":"cuidlNmvXbgpYQOdCs9rceETJ","_id":"cuidd-5aZ9J-BRvR6gNbg3yja"},{"post_id":"cuidtg_FuUlUQQ5BRfGY8QsMI","tag_id":"cuidbVhk9gjGBGHdp8TU3jjXY","_id":"cuid-QJ5rsS_fXCDOZwU06ylI"},{"post_id":"cuidtg_FuUlUQQ5BRfGY8QsMI","tag_id":"cuidtQqcCn7QHGYxMEOt3Ptod","_id":"cuidbYMn3sLUG7h6WNapFJBkP"},{"post_id":"cuidRCOgRoGMsTkR3PcorDgKD","tag_id":"cuidcYIB6tmj8e52dHG7ZayVm","_id":"cuidyqGYAE3O00eWaKCypWZFJ"},{"post_id":"cuidRCOgRoGMsTkR3PcorDgKD","tag_id":"cuidwqwKCPG9F_c_8wrgseccb","_id":"cuidPb3Y3kUS1zryK81tXG0nf"},{"post_id":"cuidRCOgRoGMsTkR3PcorDgKD","tag_id":"cuidRKgA0ptNpLFDh0tPdOAQu","_id":"cuidhpgyjqK5Z7LKaHi-vOp52"},{"post_id":"cuidRCOgRoGMsTkR3PcorDgKD","tag_id":"cuidmib4dZxxR_a2jsft2uP54","_id":"cuid4ll4sEHPXWg48DoKQOPCt"},{"post_id":"cuidRCOgRoGMsTkR3PcorDgKD","tag_id":"cuid2KYadU3oKzMbEfXvmmtxi","_id":"cuidXTg_odqvQ-LxnhFKwHnkU"},{"post_id":"cuidWuSRIkDcjEzgyLOvVi3c6","tag_id":"cuidD3orxbXbHfrOrK6qfEhKx","_id":"cuid_Frw5FRFOkKr1VW87v5zx"},{"post_id":"cuidlMGQmhJ6srse824OJbYiq","tag_id":"cuidcYIB6tmj8e52dHG7ZayVm","_id":"cuidiVo9koFHw4gT8yQwmzdqs"},{"post_id":"cuidlMGQmhJ6srse824OJbYiq","tag_id":"cuidwqwKCPG9F_c_8wrgseccb","_id":"cuid_C39sQeE9rk64JmwRrnMY"},{"post_id":"cuidlMGQmhJ6srse824OJbYiq","tag_id":"cuidRKgA0ptNpLFDh0tPdOAQu","_id":"cuidlXJaydT9tuFcGgETjylpo"},{"post_id":"cuidlMGQmhJ6srse824OJbYiq","tag_id":"cuidmib4dZxxR_a2jsft2uP54","_id":"cuidGa1sgaptk8MxHUJHbMfLj"},{"post_id":"cuidNllT4EdXnG074AoaH5I2g","tag_id":"cuid1-tCUh2V05cvmDsKJvEHz","_id":"cuidwxdix_FElmfd-bEAeHMwe"},{"post_id":"cuidNllT4EdXnG074AoaH5I2g","tag_id":"cuidvpeIgeT4Im8TCuj6Txbtg","_id":"cuidUp93LBaZm2U0xT19ELbLO"},{"post_id":"cuidhj7VdTUNPOIVs7OURh0Qt","tag_id":"cuidnGxNQfexraVXTZe1e-NbO","_id":"cuidgH04uax3MITju_VhOhmUY"},{"post_id":"cuidhj7VdTUNPOIVs7OURh0Qt","tag_id":"cuidZmhPvOHKAc_qCK650Gu0O","_id":"cuidYr9T59o3yEVuSL_eDXwyz"},{"post_id":"cuidhj7VdTUNPOIVs7OURh0Qt","tag_id":"cuidVbaTHzyvOF7rOHq0DJX9M","_id":"cuidS0HhUbT-P8MZO5Ncce0qJ"},{"post_id":"cuidhj7VdTUNPOIVs7OURh0Qt","tag_id":"cuidOCtIHdvkWkoKP5O7mWqAY","_id":"cuidOtpiDI1JojQ-2PQUjg1Yz"}],"Tag":[{"name":"eBPF","_id":"cuidnGxNQfexraVXTZe1e-NbO"},{"name":"Linux","_id":"cuidZmhPvOHKAc_qCK650Gu0O"},{"name":"AI Works","_id":"cuidtQqcCn7QHGYxMEOt3Ptod"},{"name":"chatGPT","_id":"cuidpWu1wC7QeUIbTF0zyTW3V"},{"name":"AMI","_id":"cuidBaKr3iA3BObxFwXzcJHwD"},{"name":"AppDynamics","_id":"cuidcOrlH7jjuwlzirDQVwzT5"},{"name":"cloud-init","_id":"cuidvGjIg_wqeF3BlFUOCWakR"},{"name":"anycast","_id":"cuidMabful0DymbvqG1awmBIB"},{"name":"Automation","_id":"cuidKKChclVJlQMDTi1-p_c6J"},{"name":"coding","_id":"cuide-3osxwOLov_UmKbB3UVD"},{"name":"sriov","_id":"cuidT1kXnFPcY3ZQU14xWlHa1"},{"name":"csr1000v","_id":"cuidzAWLIkJBq4opFqG68WQTY"},{"name":"ztp","_id":"cuidjfU2VPZ5BFoTuwGZlhBj0"},{"name":"ThousandEyes","_id":"cuidpfHSrMIwjmG_ufVcwhmng"},{"name":"AWS","_id":"cuidOp0WIspqKLy86O4USw62R"},{"name":"AppD","_id":"cuidAEVFsWdcCGXXQ28YIYQOr"},{"name":"nfvis","_id":"cuidosd6d6s_5Ikb21vG-NLk3"},{"name":"docker","_id":"cuidcQaJvq7-Cs27V1PYSAAi0"},{"name":"tcpdump","_id":"cuidWS-GVvxHRxfbmCi0Cjoyl"},{"name":"traceroute","_id":"cuid1-tCUh2V05cvmDsKJvEHz"},{"name":"hexo","_id":"cuidC-m_DYizyxSuAzUAXoxG7"},{"name":"wireshark","_id":"cuidlNmvXbgpYQOdCs9rceETJ"},{"name":"ISE","_id":"cuidbVhk9gjGBGHdp8TU3jjXY"},{"name":"CSR1000v","_id":"cuidcYIB6tmj8e52dHG7ZayVm"},{"name":"KVM","_id":"cuidwqwKCPG9F_c_8wrgseccb"},{"name":"SRIOV","_id":"cuidRKgA0ptNpLFDh0tPdOAQu"},{"name":"NetworkManager","_id":"cuidmib4dZxxR_a2jsft2uP54"},{"name":"Cisco","_id":"cuid2KYadU3oKzMbEfXvmmtxi"},{"name":"kvm","_id":"cuidD3orxbXbHfrOrK6qfEhKx"},{"name":"icmp","_id":"cuidvpeIgeT4Im8TCuj6Txbtg"},{"name":"Tetragon","_id":"cuidVbaTHzyvOF7rOHq0DJX9M"},{"name":"Runtime Security","_id":"cuidOCtIHdvkWkoKP5O7mWqAY"}]}}