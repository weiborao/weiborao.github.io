---
title: é€šè¿‡Wiresharké‡æ–°è®¤è¯†Traceroute
date: 2021-06-27 14:50:00
tags:
    - traceroute
    - wireshark
description: æœ¬æ–‡å¯¹Tracerouteçš„å·¥ä½œåŸç†è¿›è¡Œåˆ†æï¼Œä»‹ç»Tracerouteåœ¨è¾“å‡ºç»“æœä¸­æ˜¾ç¤ºASå·çš„åŠŸèƒ½å‚æ•°ï¼Œå¹¶é€šè¿‡WiresharkæŠ“åŒ…åˆ†æMACç”µè„‘ä¸ŠTracerouteçš„å·¥ä½œæ”¶å‘åŒ…è¿‡ç¨‹ï¼Œä»è€Œé‡æ–°è®¤è¯†Tracerouteï¼›åœ¨æ­¤åŸºç¡€ä¸Šï¼Œä»‹ç»Tracerouteçš„è¿›é˜¶å·¥å…·MTRã€‚
---

# åˆè¯†Traceroute

Tracerouteæ˜¯ä¸€ç§å¸¸è§çš„ç½‘ç»œåˆ†æå·¥å…·ï¼Œç”¨äºæ¢æµ‹æ•°æ®åŒ…ä»æºåœ°å€åˆ°ç›®çš„åœ°å€ç»è¿‡çš„è·¯ç”±å™¨çš„IPåœ°å€ã€‚

ä»¥ä¸‹çš„ç¤ºä¾‹æ˜¾ç¤ºä»ä¸€ä¸ªMACç”µè„‘åˆ°8.8.8.8çš„è·¯å¾„æ¢æµ‹ç»“æœï¼š

```shell
âœ  ~ traceroute 8.8.8.8
traceroute to 8.8.8.8 (8.8.8.8), 64 hops max, 52 byte packets
 1  localhost (10.39.101.1)  8.662 ms  1.307 ms  1.155 ms
 2  localhost (192.168.1.1)  2.287 ms  2.157 ms  1.897 ms
 3  222.129.32.1 (222.129.32.1)  5.844 ms  13.092 ms  10.332 ms
 4  114.244.95.105 (114.244.95.105)  7.541 ms
    61.51.101.101 (61.51.101.101)  7.420 ms
    61.148.163.81 (61.148.163.81)  7.075 ms
 5  61.148.4.213 (61.148.4.213)  7.759 ms
    219.232.11.65 (219.232.11.65)  5.976 ms
    bt-230-081.bta.net.cn (202.106.230.81)  6.021 ms
 6  202.96.12.13 (202.96.12.13)  7.828 ms * *
 7  219.158.112.26 (219.158.112.26)  39.486 ms *
    219.158.7.22 (219.158.7.22)  45.959 ms
 8  219.158.103.218 (219.158.103.218)  48.469 ms
    219.158.97.2 (219.158.97.2)  47.146 ms
    219.158.103.218 (219.158.103.218)  50.320 ms
 9  219.158.103.30 (219.158.103.30)  50.739 ms  50.382 ms  48.348 ms
10  219.158.10.30 (219.158.10.30)  49.927 ms  44.264 ms  56.353 ms
11  219.158.33.174 (219.158.33.174)  54.123 ms  61.131 ms  47.302 ms
12  108.170.241.97 (108.170.241.97)  56.082 ms
    108.170.241.33 (108.170.241.33)  52.942 ms  54.393 ms
13  142.250.58.189 (142.250.58.189)  48.958 ms
    209.85.143.37 (209.85.143.37)  51.217 ms
    108.170.226.115 (108.170.226.115)  141.544 ms
14  dns.google (8.8.8.8)  48.935 ms  46.364 ms  51.043 ms

âœ  ~ ping 8.8.8.8
PING 8.8.8.8 (8.8.8.8): 56 data bytes
64 bytes from 8.8.8.8: icmp_seq=0 ttl=113 time=52.060 ms
64 bytes from 8.8.8.8: icmp_seq=1 ttl=113 time=44.845 ms
64 bytes from 8.8.8.8: icmp_seq=2 ttl=113 time=52.393 ms
64 bytes from 8.8.8.8: icmp_seq=3 ttl=113 time=51.059 ms
64 bytes from 8.8.8.8: icmp_seq=4 ttl=113 time=44.437 ms
64 bytes from 8.8.8.8: icmp_seq=5 ttl=113 time=44.534 ms
^C
--- 8.8.8.8 ping statistics ---
6 packets transmitted, 6 packets received, 0.0% packet loss
round-trip min/avg/max/stddev = 44.437/48.221/52.393/3.640 ms
```

è¾“å‡ºç»“æœè¡¨æ˜ï¼š
1. ä»MACç”µè„‘åˆ°8.8.8.8çš„è·¯å¾„åŒ…å«14ä¸ªç½‘ç»œèŠ‚ç‚¹ã€‚
2. æ¯ä¸ªèŠ‚ç‚¹åé¢éƒ½æ˜¾ç¤ºæ—¶å»¶ä¿¡æ¯ï¼Œè¡¨æ˜ä»MACç”µè„‘åˆ°è¯¥èŠ‚ç‚¹çš„å¾€è¿”æ—¶å»¶ã€‚æ‚¨å¯èƒ½ä¼šå‘ç°ï¼Œä¸­é—´çš„æŸäº›èŠ‚ç‚¹å¾€è¿”æ—¶å»¶å¯èƒ½è¦é«˜äºæ›´è¿œçš„èŠ‚ç‚¹çš„å¾€è¿”æ—¶å»¶ã€‚è¿™æ˜¯ç”±äºè¯¥æ—¶å»¶åŒ…å«äº†è·¯ç”±å™¨å°†TTL=0çš„æŠ¥æ–‡äº¤ç»™æ§åˆ¶é¢å¤„ç†çš„æ—¶å»¶ï¼Œå› è€Œå¾€å¾€æ¯”è·¯å¾„ä¸Šçš„ä¼ æ’­æ—¶å»¶è¦é«˜ï¼Œå°¤å…¶æ˜¯å½“æ§åˆ¶é¢CPUç¹å¿™æ—¶ã€‚Tracerouteå¯¹æ¯ä¸€ä¸ªèŠ‚ç‚¹å‘å‡º3ä¸ªæ¢æµ‹æŠ¥æ–‡ï¼Œæ¯ä¸ªæŠ¥æ–‡çš„è·¯å¾„ä¸å°½ç›¸åŒï¼Œä¾‹å¦‚åœ¨ç¬¬4ã€5ã€7ã€8ã€12ã€13è·³ç»è¿‡ä¸åŒçš„è·¯ç”±å™¨è½¬å‘ã€‚
3. æœ‰çš„æ¢æµ‹æ²¡æœ‰å¾—åˆ°å›åº”ï¼Œå› æ­¤åœ¨æœ‰çš„èŠ‚ç‚¹æœ¬åº”æ˜¾ç¤ºæ—¶å»¶ä¿¡æ¯çš„ï¼Œæ˜¾ç¤ºäº†\*ã€‚è¿™å¹¶ä¸èƒ½æ–­å®šä¸­é—´çš„ç½‘ç»œä¸å¯è¾¾ï¼Œå¾ˆå¯èƒ½çš„åŸå› æ˜¯è¯¥èŠ‚ç‚¹çš„è·¯ç”±å™¨åœ¨æ¥å£ä¸Šé…ç½®äº† ***no ip unreachable*** å‘½ä»¤ï¼Œè¯¥æ¥å£ä¸å›åº”ICMP Unreachableæ¶ˆæ¯ï¼Œè€Œè¯¥æ¶ˆæ¯æ­£æ˜¯Tracerouteæ¢æµ‹è·¯å¾„æ‰€ä¾èµ–çš„ä¿¡æ¯æ¥æºã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬ç®€è¦æè¿°ä¸€ä¸‹ï¼Œåœ¨MACç”µè„‘ä¸‹ï¼ŒTracerouteçš„å·¥ä½œåŸç†ï¼Œå¹¶ä½¿ç”¨Wiresharkè¿›ä¸€æ­¥çš„æ¢ç©¶Tracerouteçš„å·¥ä½œè¿‡ç¨‹ã€‚

# Tracerouteçš„å·¥ä½œåŸç†

æ¯å½“IPæ•°æ®åŒ…ç»è¿‡ä¸€ä¸ªè·¯ç”±å™¨ï¼Œå…¶å­˜æ´»æ—¶é—´TTLå°±ä¼šå‡1ã€‚å½“å…¶å­˜æ´»æ—¶é—´æ˜¯0æ—¶ï¼Œä¸»æœºä¾¿å–æ¶ˆæ•°æ®åŒ…ï¼Œå¹¶å‘é€ä¸€ä¸ªICMP TTLè¶…æ—¶æ•°æ®åŒ…ç»™åŸæ•°æ®åŒ…çš„å‘å‡ºè€…ã€‚Tracerouteç¨‹åºé€šè¿‡å‘ç›®çš„åœ°å€å‘é€ä¸€ç³»åˆ—çš„æ¢æµ‹åŒ…ï¼Œè®¾ç½®æ¢æµ‹åŒ…çš„TTLåˆå§‹å€¼åˆ†åˆ«ä¸º1,2,3â€¦ï¼Œæ ¹æ®è¿”å›çš„è¶…æ—¶é€šçŸ¥ï¼ˆICMP Time Exceeded Messageï¼‰å¾—åˆ°æºåœ°å€ä¸ç›®çš„åœ°å€ä¹‹é—´çš„æ¯ä¸€è·³è·¯ç”±ä¿¡æ¯ã€‚

![Traceroute çš„å·¥ä½œåŸç†](get-known-traceroute-by-wireshark/Traceroute-work.png)

1. ä»æºåœ°å€å‘å‡ºä¸€ä¸ªUDPæ¢æµ‹åŒ…åˆ°ç›®çš„åœ°å€ï¼Œå¹¶å°†TTLè®¾ç½®ä¸º1ï¼›

2. åˆ°è¾¾è·¯ç”±å™¨æ—¶ï¼Œå°†TTLå‡1ï¼›

3. å½“TTLå˜ä¸º0æ—¶ï¼ŒåŒ…è¢«ä¸¢å¼ƒï¼Œè·¯ç”±å™¨å‘æºåœ°å€å‘å›ä¸€ä¸ªICMPè¶…æ—¶é€šçŸ¥ï¼ˆICMP Time Exceeded Messageï¼‰ï¼Œå†…å«å‘é€IPåŒ…çš„æºåœ°å€ï¼ŒIPåŒ…çš„æ‰€æœ‰å†…å®¹åŠè·¯ç”±å™¨çš„IPåœ°å€ï¼›

4. å½“æºåœ°å€æ”¶åˆ°è¯¥ICMPåŒ…æ—¶ï¼Œæ˜¾ç¤ºè¿™ä¸€è·³è·¯ç”±ä¿¡æ¯ï¼›

5. é‡å¤1ï½5ï¼Œå¹¶æ¯æ¬¡è®¾ç½®TTLåŠ 1ï¼›

6. ç›´è‡³ç›®æ ‡åœ°å€æ”¶åˆ°æ¢æµ‹æ•°æ®åŒ…ï¼Œå¹¶è¿”å›ç«¯å£ä¸å¯è¾¾é€šçŸ¥ï¼ˆICMP Port Unreachableï¼‰ï¼›

7. å½“æºåœ°å€æ”¶åˆ°ICMP Port UnreachableåŒ…æ—¶åœæ­¢tracerouteã€‚

ä»¥ä¸Šå†…å®¹å¼•è‡ª[Traceroute/tracertåŸç†å’Œå®è·µ](https://blog.csdn.net/shb_derek1/article/details/100097050)

# é€šè¿‡Wiresharkæ¢ç©¶Traceroute

## åœ¨Tracerouteè¾“å‡ºç»“æœä¸­æ˜¾ç¤ºASå·

åœ¨Macç”µè„‘çš„Tracerouteå‘½ä»¤ä¸­ï¼Œé€šè¿‡'-a'çš„å‚æ•°å¯ä»¥å¼€å¯è·¯å¾„ä¸­é‡åˆ°çš„IPåœ°å€æ‰€åœ¨çš„BGP ASå·ï¼Œä»¥ä¾¿äºè·çŸ¥è·¯å¾„ä¸­æ¯ä¸€è·³æ‰€å½’å±çš„è¿è¥å•†ï¼Œé€šè¿‡'-q 1'å¯å°†ç¼ºçœå‘é€3ä¸ªæ¢æµ‹æŠ¥æ–‡æ”¹ä¸ºå‘é€1ä¸ªæ¢æµ‹æŠ¥æ–‡ï¼Œè¾“å‡ºç¤ºä¾‹å¦‚ä¸‹ï¼š
```shell
âœ  ~ traceroute -aq 1 8.8.8.8
traceroute to 8.8.8.8 (8.8.8.8), 64 hops max, 52 byte packets
 1  [AS0] bogon (10.39.101.1)  2.424 ms
 2  [AS0] localhost (192.168.1.1)  3.031 ms
 3  [AS4808] 222.129.32.1 (222.129.32.1)  6.496 ms
 4  [AS4808] 61.51.101.101 (61.51.101.101)  8.114 ms
 5  [AS17431] 219.232.11.29 (219.232.11.29)  5.865 ms
 6  [AS4808] 202.96.12.13 (202.96.12.13)  6.558 ms
 7  [AS4837] 219.158.112.46 (219.158.112.46)  44.826 ms
 8  [AS4837] 219.158.103.218 (219.158.103.218)  52.181 ms
 9  [AS4837] 219.158.103.30 (219.158.103.30)  47.851 ms
10  [AS4837] 219.158.10.30 (219.158.10.30)  56.963 ms
11  [AS4837] 219.158.33.174 (219.158.33.174)  46.523 ms
12  [AS15169] 108.170.241.1 (108.170.241.1)  48.503 ms
13  [AS15169] 172.253.64.111 (172.253.64.111)  142.926 ms
14  [AS15169] dns.google (8.8.8.8)  52.208 ms
```
ä¸Šè¿°çš„ASç¼–å·ä¿¡æ¯æ˜¯å¦‚ä½•è·å¾—çš„ï¼Ÿä¸‹é¢æˆ‘ä»¬é€šè¿‡WiresharkæŠ“å–æŠ¥æ–‡è¿›è¡Œåˆ†æã€‚

## ä¸Šè¿°Tracerouteçš„æ”¶å‘åŒ…è¿‡ç¨‹ç®€è¿°
å¼€å¯Wiresharkï¼Œå¹¶è¿…é€Ÿæ‰§è¡Œ**traceroute -aq 1 8.8.8.8**ï¼ŒTracerouteå®Œæ•´è¾“å‡ºåï¼Œåœæ­¢Wiresharkçš„æŠ¥æ–‡æŠ“å–ã€‚
é’ˆå¯¹æŠ“å–çš„æŠ¥æ–‡è¿›è¡Œè¿‡æ»¤ï¼Œåœ¨è¿‡æ»¤æ¡†ä¸­è¾“å…¥ **udp or icmp or ip.addr == 198.108.0.18**
ç»è¿‡Wiresharkçš„æŠ¥æ–‡åˆ†æï¼Œä»¥ä¸‹ä¸ºTracerouteçš„ç®€è¦çš„æ”¶å‘åŒ…è¿‡ç¨‹ï¼š

1. å‘èµ·DNSæŸ¥è¯¢ï¼ŒæŸ¥è¯¢**whois.radb.net**åŸŸåï¼Œå¾—åˆ°åº”ç­”ä¸º198.108.0.18----ä¸Šè¿°è¿‡æ»¤å™¨ä¸­IPåœ°å€æ¥æºäºæ­¤ã€‚
2. å‘èµ·TCPè¿æ¥è¯·æ±‚ï¼Œä¸198.108.0.18å»ºç«‹TCPè¿æ¥ã€‚
3. å‘8.8.8.8å‘èµ·UDPæŠ¥æ–‡ï¼Œç›®çš„ç«¯å£ä¸º33435ï¼ŒTTLè®¾ç½®ä¸º1
4. æ”¶åˆ°è·¯ç”±å™¨çš„ICMP TTLè¶…æ—¶æ¶ˆæ¯ï¼Œè·å–è·¯ç”±å™¨å¯¹åº”çš„IPåœ°å€
5. å‘**whois.radb.net**å‘èµ·æŸ¥è¯¢ï¼Œè¯¢é—®è·¯ç”±å™¨IPåœ°å€å¯¹åº”çš„ASå·ï¼Œå¹¶å¾—åˆ°å›åº”ï¼Œå¦‚æœæ˜¯ç§æœ‰åœ°å€ï¼Œå…¶ASå·ä¸º0ã€‚
6. å°è¯•å‘DNSæœåŠ¡å™¨æŸ¥è¯¢è·¯ç”±å™¨IPåœ°å€çš„åå‘åŸŸåè§£æï¼Œå¦‚æœå¾—åˆ°åŸŸåï¼Œå°±å°†å…¶æ˜¾ç¤ºåœ¨Tracerouteçš„è¾“å‡ºç»“æœä¸­ã€‚
7. é‡å¤ä¸Šè¿°ç¬¬3~6æ­¥ï¼Œæ¯æ¬¡å°†TTLåŠ 1ï¼Œç›´è‡³ç›®æ ‡åœ°å€æ¥æ”¶åˆ°æ¢æµ‹æŠ¥æ–‡ï¼Œå¹¶è¿”å›ICMP Port Unreachableæ¶ˆæ¯ã€‚

## WiresharkæŠ“åŒ…è¯¦ç»†åˆ†æ
ä¸‹å›¾ä¸ºWiresharkæŠ“å–çš„æŠ¥æ–‡çš„å‰36ä¸ªï¼š![packet1-36](get-known-traceroute-by-wireshark/packet1-36.png)

1. ç¬¬1å’Œç¬¬2ä¸ªæŠ¥æ–‡ä¸ºDNSæŸ¥è¯¢ï¼ŒæŸ¥è¯¢whois.radb.netçš„åœ°å€ä¸º198.108.0.18ã€‚

2. ç¬¬3~5çš„æŠ¥æ–‡ä¸ºTCPä¸‰æ¬¡æ¡æ‰‹ï¼Œå¹¶æˆåŠŸå»ºç«‹TCP è¿æ¥10.39.101.141:51705<--->198.108.0.18:43ï¼ŒTCP 43ç«¯å£é€šå¸¸æ˜¯whois serverçš„ç«¯å£ã€‚

3. ç¬¬6ä¸ªæŠ¥æ–‡ç”±10.39.101.141å‘å‘198.108.0.18ï¼Œå¹¶å°†PSHç½®ä½ï¼Œè¯·æ±‚æ¥æ”¶ç«¯ä¸€æ”¶åˆ°å°±è¿›è¡Œå‘ä¸Šäº¤ä»˜ï¼Œä»¥ç¼©çŸ­Tracerouteçš„ç­‰å¾…æ—¶é—´ã€‚

4. ç¬¬7ä¸ªæŠ¥æ–‡å‘å‡ºç¬¬ä¸€ä¸ªUDPçš„æ¢æµ‹æŠ¥æ–‡ï¼Œç›®æ ‡ç«¯å£å·ä¸º33435ï¼ŒTTL=1ï¼Œå…·ä½“å¦‚ä¸‹ï¼š

   ![UDP-Probe-1](get-known-traceroute-by-wireshark/UDP-Probe-1.png)

5. ç¬¬8ä¸ªæŠ¥æ–‡ä¸ºç½‘å…³å›å¤çš„ICMP Time-to-live exceeded (Time to live exceeded in transit)æŠ¥æ–‡ï¼ŒTracerouteä»IPæŠ¥æ–‡ä¸­çš„æºåœ°å€è·å–è·¯ç”±å™¨çš„IPåœ°å€10.39.101.1ã€‚è¯¥æŠ¥æ–‡åŒ…å«åŸå§‹çš„UDPæŠ¥æ–‡ä¿¡æ¯ï¼Œå…·ä½“å¦‚ä¸‹ï¼š

   ![ICMP-Reply-1](get-known-traceroute-by-wireshark/ICMP-Reply-1.png)

6. ç¬¬9ä¸ªæŠ¥æ–‡ä¸ºç¬¬6ä¸ªæŠ¥æ–‡çš„TCPç¡®è®¤æŠ¥æ–‡ï¼Œç¬¬10ä¸ªæŠ¥æ–‡ä¸ºå‘whois.radb.netæŸ¥è¯¢ç½‘å…³10.39.101.1/32æ‰€åœ¨çš„ASå·ã€‚ç¬¬11ä¸ªæŠ¥æ–‡ä¸ºç¬¬10ä¸ªæŠ¥æ–‡çš„TCPç¡®è®¤ï¼Œç¬¬12ä¸ªæŠ¥æ–‡ç­”å¤æŸ¥è¯¢ç»“æœï¼Œç”±äºè¯¥åœ°å€ä¸ºç§æœ‰IPåœ°å€æ®µï¼Œæ²¡æœ‰æŸ¥è¯¢åˆ°ç»“æœï¼Œå› æ­¤Traceroute å°†ASå·æ˜¾ç¤ºä¸º[AS0]ã€‚ä»¥ä¸‹ä½¿ç”¨ç¬¬29å’Œ30æŠ¥æ–‡ï¼Œç”¨äºå±•ç¤ºASå·æŸ¥è¯¢çš„æŠ¥æ–‡ï¼Œå¦‚ä¸‹ï¼š
  
  ![AS-query-1](get-known-traceroute-by-wireshark/AS-query-1.png)
  
  ![AS-reply-1](get-known-traceroute-by-wireshark/AS-reply-1.png)
  
  æŸ¥è¯¢ç»“æœçš„æ–‡æœ¬å†…å®¹å¦‚ä¸‹ï¼š
  
  ```text
  route:      222.129.0.0/18
  descr:      CMI  (Customer Route)
  origin:     AS4808
  mnt-by:     MAINT-AS58453
  changed:    qas_support@cmi.chinamobile.com 20160525
  source:     RADB
  
  route:          222.128.0.0/14
  descr:          China Unicom Beijing Province Network
  country:        CN
  origin:         AS4808
  mnt-by:         MAINT-CNCGROUP-RR
  changed:        abuse@cnc-noc.net 20160516
  source:         APNIC
  
  route:      222.129.0.0/18
  descr:      CMI IP Transit
  origin:     AS4808
  admin-c:    MAINT-CMI-INT-HK
  tech-c:     MAINT-CMI-INT-HK
  mnt-by:     MAINT-CMI-INT-HK
  changed:    qas_support@cmi.chinamobile.com 20160525
  source:     NTTCOM
  ```
  
7. ç¬¬14~17æŠ¥æ–‡æ˜¯DNSè§£ææŠ¥æ–‡ï¼Œåˆ†åˆ«å¯¹ä¸»æœºåWERAO-M-40KAè¿›è¡ŒåŸŸåè§£æï¼Œä»¥åŠå¯¹ç½‘å…³IP 10.39.101.1è¿›è¡Œåå‘åŸŸåè§£æï¼Œç”±äºæ˜¯ç§æœ‰ä¸»æœºåå’Œç§æœ‰åœ°å€ï¼Œè‡ªç„¶å…¬ç½‘DNSæ˜¯è§£æä¸å‡ºæ¥ã€‚ä»¥ä¸‹å°†é’ˆå¯¹8.8.8.8è¿›è¡Œåå‘åŸŸåè§£æä¸ºdns.googleçš„æˆªå›¾ä½œä¸ºç¤ºä¾‹ï¼š

   ![dns-query-1](get-known-traceroute-by-wireshark/dns-query-1.png)

8. æŠ¥æ–‡18\~26é‡å¤æŠ¥æ–‡7\~17çš„è¿‡ç¨‹ï¼Œå…¶ä¸­æŠ¥æ–‡18çš„TTLä¸º2ï¼Œå¦‚ä¸‹ï¼š

   ![UDP-Probe-2](get-known-traceroute-by-wireshark/UDP-Probe-2.png)

   è¿‡ç¨‹æŒç»­è‡³8.8.8.8è¿”å›Code: 3 (Port unreachable)çš„æ¶ˆæ¯ï¼Œå¹¶å¯¹8.8.8.8è¿›è¡Œåå‘åŸŸåè§£æã€‚

   ![ICMP-last-reply](get-known-traceroute-by-wireshark/ICMP-last-reply.png)

ä»¥ä¸Šè¯¦ç»†çš„åˆ†æäº†**traceroute -aq 1 8.8.8.8**çš„æŠ¥æ–‡æ”¶å‘è¿‡ç¨‹ã€‚

## åè®°

åœ¨ä¸Šè¿°çš„Tracerouteå®Œæˆè¾“å‡ºåï¼ŒWiresharkæˆåŠŸçš„å°†Whoisçš„äº¤äº’æŠ¥æ–‡è¿›è¡Œé‡æ–°ç»„è£…ï¼Œå¹¶å®Œæˆå†…å®¹çš„è§£æã€‚

åœ¨Wiresharkåˆ†æå®Œç¬¬133ä¸ªæŠ¥æ–‡åï¼ŒWiresharkæˆåŠŸçš„ç»„è£…å‡ºwhoisçš„æŸ¥è¯¢æŠ¥æ–‡ï¼Œå¦‚ä¸‹ï¼š

![whois-query](get-known-traceroute-by-wireshark/whois-query.png)

åœ¨Wiresharkåˆ†æå®Œç¬¬135ä¸ªæŠ¥æ–‡åï¼ŒWiresharkæˆåŠŸçš„ç»„è£…å‡ºWhoisçš„åº”ç­”æŠ¥æ–‡ï¼Œå¦‚ä¸‹ï¼š

![whois-answer](get-known-traceroute-by-wireshark/whois-answer.png)



åœ¨Terminalæ‰§è¡Œwhois 8.8.8.8/32ï¼Œå¹¶è¿›è¡ŒæŠ¥æ–‡æŠ“å–ï¼Œè§£æå‡ºWhoisçš„æŠ¥æ–‡åº”ç­”å¦‚ä¸‹ï¼š

![whois-answer-2](get-known-traceroute-by-wireshark/whois-answer-2.png)

è¯¥æŠ¥æ–‡ä¹Ÿæ˜¯Wireshark æ‹¼è£…äº†å¤šä¸ªTCP Segmentï¼Œ#101ã€#103ã€#104ã€#106ã€#109åè§£æå‡ºæ¥çš„ã€‚å¯¹æ¯”è¯¥è§£æç»“æœå’Œä¸Šæ–‡ä¸­ï¼ŒTracerouteè¿‡ç¨‹ä¸­çš„æŸ¥è¯¢ç»“æœï¼Œå¯ä»¥å‘ç°ï¼ŒæŠ¥æ–‡ç»“æ„æ˜¯ä¸€è‡´çš„ï¼Œéƒ½è¢«Wiresharkè§£ææˆWhoisçš„æŠ¥æ–‡ã€‚

æ®æ­¤ï¼Œæˆ‘æ¨æµ‹ï¼ŒMACç”µè„‘ä¸Šçš„Traceroute åœ¨å¢åŠ äº†-açš„å‚æ•°åï¼Œä¼šä¸»åŠ¨å‘èµ·WhoisæŸ¥è¯¢ï¼Œç¼ºçœçš„WhoisæœåŠ¡å™¨æ˜¯whois.radb.netã€‚

æ­¤éƒ¨åˆ†å†…å®¹æ˜¯åœ¨Tracerouteæ”¶å‘åŒ…è¿‡ç¨‹åˆ†æå®Œæˆåï¼Œå†åçŸ¥åè§‰å‘ç°çš„ï¼Œå› æ­¤å°†æ­¤éƒ¨åˆ†å†…å®¹ä½œä¸ºâ€œåè®°â€è¿›è¡Œè®°å½•ã€‚

# Traceroute è¿›é˜¶ç‰ˆå·¥å…·MTR

MTR ï¼ˆMy Tracerouteï¼‰å·¥å…·å°†pingå’Œtracerouteå‘½ä»¤çš„åŠŸèƒ½å¹¶å…¥äº†åŒä¸€ä¸ªå·¥å…·ä¸­ï¼Œå®ç°æ›´å¼ºå¤§çš„åŠŸèƒ½ã€‚ç›¸å¯¹äºtracerouteå‘½ä»¤åªä¼šåšä¸€æ¬¡é“¾è·¯è·Ÿè¸ªæµ‹è¯•ï¼Œmtrå‘½ä»¤ä¼šå¯¹é“¾è·¯ä¸Šçš„ç›¸å…³èŠ‚ç‚¹åšæŒç»­æ¢æµ‹å¹¶ç»™å‡ºç›¸åº”çš„ç»Ÿè®¡ä¿¡æ¯ã€‚

å¦‚ä¸‹ä¸ºMTRçš„è¾“å‡ºï¼š

```shell
âœ  ~ sudo mtr -ry 4 8.8.8.8
Start: 2021-06-27T23:37:21+0800
HOST: WERAO-M-40KA                Loss%   Snt   Last   Avg  Best  Wrst StDev
  1. ???        localhost          0.0%    10    1.8   2.2   1.2  10.1   2.8
  2. ???        bogon              0.0%    10    2.2   2.3   1.9   3.3   0.5
  3. 2003-11-19 222.129.32.1       0.0%    10    6.3   9.5   5.0  29.2   7.7
  4. 2000-03-14 61.148.163.181     0.0%    10    5.3   7.4   5.3   8.7   1.2
  5. 2002-04-17 219.232.11.65     70.0%    10    5.4   6.1   5.4   6.8   0.7
  6. 2006-01-09 124.65.194.153    30.0%    10   28.9   9.6   5.7  28.9   8.5
  7. 2002-03-21 219.158.112.26    40.0%    10   38.9  44.2  38.5  63.7   9.7
  8. 2002-03-21 219.158.19.66      0.0%    10   74.4  64.1  46.4  74.4   8.8
  9. 2002-03-21 219.158.97.25      0.0%    10   90.8  90.8  82.2  96.7   4.3
 10. 2002-03-21 219.158.20.94      0.0%    10   97.5  89.8  74.1 104.6  11.8
 11. 2002-03-21 219.158.33.174     0.0%    10   73.0  62.1  49.7  74.0   8.5
 12. 2012-02-07 108.170.241.65     0.0%    10   59.0  67.3  53.1  75.4   7.2
 13. 2013-04-04 172.253.69.229    10.0%    10   62.9  68.3  54.5  76.6   6.5
 14. 1992-12-01 dns.google         0.0%    10   71.0  65.6  56.4  71.0   5.7
```

MTRå‘½ä»¤ï¼Œé€šè¿‡-r è¾“å‡ºæŠ¥å‘Šï¼Œ-z å¯è¾“å‡ºåœ°å€æ‰€åœ¨çš„ASå·ï¼Œ-y 4 å¯è¾“å‡ºè¯¥åœ°å€çš„åˆ†é…æ—¶é—´ã€‚

è¾“å‡ºä¿¡æ¯è§£é‡Šå¦‚ä¸‹ï¼š

- ç¬¬ä¸€åˆ—ï¼ˆHostï¼‰ï¼šèŠ‚ç‚¹IPåœ°å€å’ŒåŸŸåã€‚
- ç¬¬äºŒåˆ—ï¼ˆLoss%ï¼‰ï¼šèŠ‚ç‚¹ä¸¢åŒ…ç‡ã€‚
- ç¬¬ä¸‰åˆ—ï¼ˆSntï¼‰ï¼šå‘é€çš„PingåŒ…æ•°ã€‚é»˜è®¤å€¼æ˜¯10ï¼Œå¯ä»¥é€šè¿‡å‚æ•°â€œ-câ€æŒ‡å®šã€‚
- ç¬¬å››åˆ—ï¼ˆLastï¼‰ï¼šæœ€è¿‘ä¸€æ¬¡çš„æ¢æµ‹å»¶è¿Ÿå€¼ã€‚
- ç¬¬äº”ã€å…­ã€ä¸ƒåˆ—ï¼ˆAvgã€Bestã€Wrstï¼‰ï¼šåˆ†åˆ«æ˜¯æ¢æµ‹å»¶è¿Ÿçš„å¹³å‡å€¼ã€æœ€å°å€¼å’Œæœ€å¤§å€¼ã€‚
- ç¬¬å…«åˆ—ï¼ˆStDevï¼‰ï¼šæ ‡å‡†åå·®ã€‚è¶Šå¤§è¯´æ˜ç›¸åº”èŠ‚ç‚¹è¶Šä¸ç¨³å®šã€‚

ä¸Šè¿°è§£é‡Šå¼•ç”¨è‡ªï¼š[MTRå·¥å…·ä½¿ç”¨è¯´æ˜ä¸ç»“æœåˆ†æ](https://help.aliyun.com/knowledge_detail/98706.html)ï¼Œç•¥æœ‰æ”¹åŠ¨ã€‚

# Q&A

1. David Tian:  èµï¼Œè¯·æ•™ä¸‹ï¼Œä¸ºä»€ä¹ˆipv4çš„traceroute ä¼šè§¦å‘ç”¨ipv6å»æŸ¥dnså‘¢ï¼Ÿ

   ç­”ï¼šå¥½çœ¼åŠ›ï¼Œå¥½é—®é¢˜~~å®é™…ä¸Šï¼Œæˆ‘æŠ“å–çš„æŠ¥æ–‡ä¸­ï¼Œæ¯æ¬¡å¾—åˆ°ICMPæŠ¥æ–‡åï¼ŒTracerouteä¹Ÿä¼šå‘208.67.222.222å‘é€DNSè¯·æ±‚ã€‚ä½†æ˜¯æŠ¥æ–‡æ˜¯åŠ å¯†çš„ï¼Œçœ‹ä¸å‡ºæ˜¯ä»€ä¹ˆå†…å®¹ï¼Œä¸èƒ½çŒœæµ‹ï¼Œæ‰€ä»¥æˆ‘å°†è¿™äº›ä¸ç¡®å®šçš„æŠ¥æ–‡åˆ é™¤äº†ã€‚208.67.222.222æ˜¯OpenDNSçš„DNSæœåŠ¡å™¨ï¼Œè¿™æ˜¯Cisco ITè®¾ç½®çš„DNSæœåŠ¡å™¨ã€‚ğŸ˜„

# é™„å½•

ä»¥ä¸‹æ˜¯WiresharkæŠ“åŒ…æ–‡ä»¶çš„å‰60ä¸ªæŠ¥æ–‡çš„æ¦‚è§ˆã€‚

| No.  | Source                    | Destination               | Protocol | Info                                                         |
| ---- | ------------------------- | ------------------------- | -------- | ------------------------------------------------------------ |
| 1    | fe80::1c7a:24fd:c837:3017 | fe80::1                   | DNS      | Standard query 0xc7d5 A whois.radb.net                       |
| 2    | fe80::1                   | fe80::1c7a:24fd:c837:3017 | DNS      | Standard query response 0xc7d5 A whois.radb.net A 198.108.0.18 |
| 3    | 10.39.101.141             | 198.108.0.18              | TCP      | 51705 â†’ 43 [SYN] Seq=0 Win=65535 Len=0 MSS=1460 WS=64 TSval=2785245374  TSecr=0 SACK_PERM=1 |
| 4    | 198.108.0.18              | 10.39.101.141             | TCP      | 43 â†’ 51705 [SYN, ACK] Seq=0 Ack=1 Win=28960 Len=0 MSS=1412  TSval=3642352050 TSecr=2785245374 WS=256 |
| 5    | 10.39.101.141             | 198.108.0.18              | TCP      | 51705 â†’ 43 [ACK] Seq=1 Ack=1 Win=131584 Len=0 TSval=2785245692  TSecr=3642352050 |
| 6    | 10.39.101.141             | 198.108.0.18              | TCP      | 51705 â†’ 43 [PSH, ACK] Seq=1 Ack=1 Win=131584 Len=3 TSval=2785245692  TSecr=3642352050 [TCP segment of a reassembled PDU] |
| 7    | 10.39.101.141             | 8.8.8.8                   | UDP      | 36904 â†’ 33435 Len=24                                         |
| 8    | 10.39.101.1               | 10.39.101.141             | ICMP     | Time-to-live exceeded (Time to live exceeded in transit)     |
| 9    | 198.108.0.18              | 10.39.101.141             | TCP      | 43 â†’ 51705 [ACK] Seq=1 Ack=4 Win=29184 Len=0 TSval=3642352370  TSecr=2785245692 |
| 10   | 10.39.101.141             | 198.108.0.18              | TCP      | 51705 â†’ 43 [PSH, ACK] Seq=4 Ack=1 Win=131584 Len=19 TSval=2785246039  TSecr=3642352370 [TCP segment of a reassembled PDU] |
| 11   | 198.108.0.18              | 10.39.101.141             | TCP      | 43 â†’ 51705 [ACK] Seq=1 Ack=23 Win=29184 Len=0 TSval=3642352717  TSecr=2785246039 |
| 12   | 198.108.0.18              | 10.39.101.141             | TCP      | 43 â†’ 51705 [PSH, ACK] Seq=1 Ack=23 Win=29184 Len=2 TSval=3642352717  TSecr=2785246039 [TCP segment of a reassembled PDU] |
| 13   | 10.39.101.141             | 198.108.0.18              | TCP      | 51705 â†’ 43 [ACK] Seq=23 Ack=3 Win=131584 Len=0 TSval=2785246448  TSecr=3642352717 |
| 14   | fe80::1c7a:24fd:c837:3017 | fe80::1                   | DNS      | Standard query 0x93fc A WERAO-M-40KA                         |
| 15   | fe80::1                   | fe80::1c7a:24fd:c837:3017 | DNS      | Standard query response 0x93fc No such name A WERAO-M-40KA   |
| 16   | fe80::1c7a:24fd:c837:3017 | fe80::1                   | DNS      | Standard query 0xbcf9 PTR 1.101.39.10.in-addr.arpa           |
| 17   | fe80::1                   | fe80::1c7a:24fd:c837:3017 | DNS      | Standard query response 0xbcf9 PTR 1.101.39.10.in-addr.arpa PTR bogon |
| 18   | 10.39.101.141             | 8.8.8.8                   | UDP      | 36904 â†’ 33436 Len=24                                         |
| 19   | 192.168.1.1               | 10.39.101.141             | ICMP     | Time-to-live exceeded (Time to live exceeded in transit)     |
| 20   | 10.39.101.141             | 198.108.0.18              | TCP      | 51705 â†’ 43 [PSH, ACK] Seq=23 Ack=3 Win=131584 Len=19 TSval=2785248590  TSecr=3642352717 [TCP segment of a reassembled PDU] |
| 21   | 10.39.101.141             | 10.39.101.1               | DNS      | Standard query 0xc81a A WERAO-M-40KA                         |
| 22   | 10.39.101.1               | 10.39.101.141             | DNS      | Standard query response 0xc81a A WERAO-M-40KA A 10.39.101.141 |
| 23   | 198.108.0.18              | 10.39.101.141             | TCP      | 43 â†’ 51705 [PSH, ACK] Seq=3 Ack=42 Win=29184 Len=2 TSval=3642355278  TSecr=2785248590 [TCP segment of a reassembled PDU] |
| 24   | 10.39.101.141             | 198.108.0.18              | TCP      | 51705 â†’ 43 [ACK] Seq=42 Ack=5 Win=131584 Len=0 TSval=2785248902  TSecr=3642355278 |
| 25   | fe80::1c7a:24fd:c837:3017 | fe80::1                   | DNS      | Standard query 0x7504 PTR 1.1.168.192.in-addr.arpa           |
| 26   | fe80::1                   | fe80::1c7a:24fd:c837:3017 | DNS      | Standard query response 0x7504 PTR 1.1.168.192.in-addr.arpa PTR localhost |
| 27   | 10.39.101.141             | 8.8.8.8                   | UDP      | 36904 â†’ 33437 Len=24                                         |
| 28   | 222.129.32.1              | 10.39.101.141             | ICMP     | Time-to-live exceeded (Time to live exceeded in transit)     |
| 29   | 10.39.101.141             | 198.108.0.18              | TCP      | 51705 â†’ 43 [PSH, ACK] Seq=42 Ack=5 Win=131584 Len=20 TSval=2785249974  TSecr=3642355278 [TCP segment of a reassembled PDU] |
| 30   | 198.108.0.18              | 10.39.101.141             | TCP      | 43 â†’ 51705 [PSH, ACK] Seq=5 Ack=62 Win=29184 Len=643 TSval=3642356666  TSecr=2785249974 [TCP segment of a reassembled PDU] |
| 31   | 10.39.101.141             | 198.108.0.18              | TCP      | 51705 â†’ 43 [ACK] Seq=62 Ack=648 Win=130944 Len=0 TSval=2785250324  TSecr=3642356666 |
| 32   | fe80::1c7a:24fd:c837:3017 | fe80::1                   | DNS      | Standard query 0x4f56 PTR 1.32.129.222.in-addr.arpa          |
| 33   | fe80::1                   | fe80::1c7a:24fd:c837:3017 | DNS      | Standard query response 0x4f56 No such name PTR 1.32.129.222.in-addr.arpa |
| 34   | 10.39.101.141             | 8.8.8.8                   | UDP      | 36904 â†’ 33438 Len=24                                         |
| 35   | 61.51.101.101             | 10.39.101.141             | ICMP     | Time-to-live exceeded (Time to live exceeded in transit)     |
| 36   | 10.39.101.141             | 198.108.0.18              | TCP      | 51705 â†’ 43 [PSH, ACK] Seq=62 Ack=648 Win=131072 Len=21 TSval=2785251389  TSecr=3642356666 [TCP segment of a reassembled PDU] |
| 37   | 198.108.0.18              | 10.39.101.141             | TCP      | 43 â†’ 51705 [PSH, ACK] Seq=648 Ack=83 Win=29184 Len=639 TSval=3642358087  TSecr=2785251389 [TCP segment of a reassembled PDU] |
| 38   | 10.39.101.141             | 198.108.0.18              | TCP      | 51705 â†’ 43 [ACK] Seq=83 Ack=1287 Win=130432 Len=0 TSval=2785251697  TSecr=3642358087 |
| 39   | 10.39.101.141             | 10.39.101.1               | DNS      | Standard query 0x521b PTR 1.32.129.222.in-addr.arpa          |
| 40   | 10.39.101.1               | 10.39.101.141             | DNS      | Standard query response 0x521b No such name PTR 1.32.129.222.in-addr.arpa |
| 41   | fe80::1c7a:24fd:c837:3017 | fe80::1                   | DNS      | Standard query 0x5931 PTR 101.101.51.61.in-addr.arpa         |
| 42   | fe80::1                   | fe80::1c7a:24fd:c837:3017 | DNS      | Standard query response 0x5931 No such name PTR  101.101.51.61.in-addr.arpa |
| 43   | 10.39.101.141             | 8.8.8.8                   | UDP      | 36904 â†’ 33439 Len=24                                         |
| 44   | 219.232.11.29             | 10.39.101.141             | ICMP     | Time-to-live exceeded (Time to live exceeded in transit)     |
| 45   | 10.39.101.141             | 198.108.0.18              | TCP      | 51705 â†’ 43 [PSH, ACK] Seq=83 Ack=1287 Win=131072 Len=21 TSval=2785252732  TSecr=3642358087 [TCP segment of a reassembled PDU] |
| 46   | 198.108.0.18              | 10.39.101.141             | TCP      | 43 â†’ 51705 [PSH, ACK] Seq=1287 Ack=104 Win=29184 Len=418 TSval=3642359437  TSecr=2785252732 [TCP segment of a reassembled PDU] |
| 47   | 10.39.101.141             | 198.108.0.18              | TCP      | 51705 â†’ 43 [ACK] Seq=104 Ack=1705 Win=130624 Len=0 TSval=2785253042  TSecr=3642359437 |
| 48   | fe80::1c7a:24fd:c837:3017 | fe80::1                   | DNS      | Standard query 0x7d09 PTR 29.11.232.219.in-addr.arpa         |
| 49   | fe80::1                   | fe80::1c7a:24fd:c837:3017 | DNS      | Standard query response 0x7d09 No such name PTR  29.11.232.219.in-addr.arpa |
| 50   | 10.39.101.141             | 8.8.8.8                   | UDP      | 36904 â†’ 33440 Len=24                                         |
| 51   | 202.96.12.13              | 10.39.101.141             | ICMP     | Time-to-live exceeded (Time to live exceeded in transit)     |
| 52   | 10.39.101.141             | 198.108.0.18              | TCP      | 51705 â†’ 43 [PSH, ACK] Seq=104 Ack=1705 Win=131072 Len=20 TSval=2785254068  TSecr=3642359437 [TCP segment of a reassembled PDU] |
| 53   | 10.39.101.141             | 10.39.101.1               | DNS      | Standard query 0x961b PTR 101.101.51.61.in-addr.arpa         |
| 54   | 10.39.101.1               | 10.39.101.141             | DNS      | Standard query response 0x961b No such name PTR  101.101.51.61.in-addr.arpa |
| 55   | 198.108.0.18              | 10.39.101.141             | TCP      | 43 â†’ 51705 [PSH, ACK] Seq=1705 Ack=124 Win=29184 Len=642 TSval=3642360779  TSecr=2785254068 [TCP segment of a reassembled PDU] |
| 56   | 10.39.101.141             | 198.108.0.18              | TCP      | 51705 â†’ 43 [ACK] Seq=124 Ack=2347 Win=130368 Len=0 TSval=2785254400  TSecr=3642360779 |
| 57   | fe80::1c7a:24fd:c837:3017 | fe80::1                   | DNS      | Standard query 0xb016 PTR 13.12.96.202.in-addr.arpa          |
| 58   | fe80::1                   | fe80::1c7a:24fd:c837:3017 | DNS      | Standard query response 0xb016 No such name PTR 13.12.96.202.in-addr.arpa  SOA beijing.cn.net |
| 59   | 10.39.101.141             | 8.8.8.8                   | UDP      | 36904 â†’ 33441 Len=24                                         |
| 60   | 219.158.112.46            | 10.39.101.141             | ICMP     | Time-to-live exceeded (Time to live exceeded in transit)     |

[æŠ“åŒ…æ–‡ä»¶ä¸‹è½½](get-known-traceroute-by-wireshark/traceroute-google-dns.pcapng)

