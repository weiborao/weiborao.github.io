<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">
<link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
<link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin>
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">

<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" integrity="sha256-HtsXJanqjKTc8vVQjO4YMhiqFoXkfBsjBWcX91T1jr8=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"weiborao.link","root":"/","images":"/images","scheme":"Pisces","darkmode":false,"version":"8.18.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"mac"},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="记录一些工作、学习相关的笔记">
<meta property="og:type" content="website">
<meta property="og:title" content="Rao Weibo的博客">
<meta property="og:url" content="https://weiborao.link/index.html">
<meta property="og:site_name" content="Rao Weibo的博客">
<meta property="og:description" content="记录一些工作、学习相关的笔记">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Rao Weibo">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://weiborao.link/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Rao Weibo的博客</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Rao Weibo的博客</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">26</span></a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">15</span></a></li>
  </ul>
</nav>




</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Rao Weibo</p>
  <div class="site-description" itemprop="description">记录一些工作、学习相关的笔记</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">15</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">26</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author animated">
      <span class="links-of-author-item">
        <a href="https://github.com/weiborao" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;weiborao" rel="noopener me" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:raoweibo@gmail.com" title="E-Mail → mailto:raoweibo@gmail.com" rel="noopener me" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>

        </div>
      </div>
        <div class="back-to-top animated" role="button" aria-label="返回顶部">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://weiborao.link/K8S-Cilium-Replace-kube-proxy.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rao Weibo">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Rao Weibo的博客">
      <meta itemprop="description" content="记录一些工作、学习相关的笔记">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Rao Weibo的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/K8S-Cilium-Replace-kube-proxy.html" class="post-title-link" itemprop="url">Kubernetes with CNI Cilium 安装学习</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2025-08-01 16:06:36 / 修改时间：17:35:11" itemprop="dateCreated datePublished" datetime="2025-08-01T16:06:36+08:00">2025-08-01</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>20k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1:12</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="Kubernetes-with-CNI-Cilium-安装学习"><a href="#Kubernetes-with-CNI-Cilium-安装学习" class="headerlink" title="Kubernetes with CNI Cilium 安装学习"></a>Kubernetes with CNI Cilium 安装学习</h1><h1 id="1-使用自动化脚本安装Ubuntu-24-04虚拟机"><a href="#1-使用自动化脚本安装Ubuntu-24-04虚拟机" class="headerlink" title="1. 使用自动化脚本安装Ubuntu 24.04虚拟机"></a>1. 使用自动化脚本安装Ubuntu 24.04虚拟机</h1><h2 id="1-1-准备工作"><a href="#1-1-准备工作" class="headerlink" title="1.1 准备工作"></a>1.1 准备工作</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">密码加密字符串</span><br><span class="line">ois@ois:~$ mkpasswd --method=SHA-512 --rounds=4096</span><br><span class="line">Password: </span><br><span class="line">$6<span class="variable">$rounds</span>=4096<span class="variable">$LDu9pXXXXXXXXXXXXXXOh</span>/Iunw372/TVfst1</span><br><span class="line"></span><br><span class="line">生成ssh-key，以便实现无密码登录。</span><br><span class="line">ssh-keygen -t rsa -b 4096</span><br><span class="line">Generating public/private rsa key pair.</span><br><span class="line">Enter file <span class="keyword">in</span> <span class="built_in">which</span> to save the key (/root/.ssh/id_rsa): </span><br><span class="line">Enter passphrase (empty <span class="keyword">for</span> no passphrase): </span><br><span class="line">Enter same passphrase again: </span><br><span class="line">Your identification has been saved <span class="keyword">in</span> /root/.ssh/id_rsa</span><br><span class="line">Your public key has been saved <span class="keyword">in</span> /root/.ssh/id_rsa.pub</span><br><span class="line">The key fingerprint is:</span><br><span class="line">SHA256:1+BaD0K3fe6saxPFf41r0SyZEpqhq29AVeRwz+WEXiU </span><br><span class="line">The key<span class="string">&#x27;s randomart image is:</span></span><br><span class="line"><span class="string">+---[RSA 4096]----+</span></span><br><span class="line"><span class="string">|        .o+  .E..|</span></span><br><span class="line"><span class="string">|        .+ o.+.. |</span></span><br><span class="line"><span class="string">|       .. +.oo.  |</span></span><br><span class="line"><span class="string">|      .. o.=o o  |</span></span><br><span class="line"><span class="string">|     .  S.*+oo.B.|</span></span><br><span class="line"><span class="string">|      . .=oooo* *|</span></span><br><span class="line"><span class="string">|       ...  .o.+.|</span></span><br><span class="line"><span class="string">|        o   ooo  |</span></span><br><span class="line"><span class="string">|      .+.  .o=o  |</span></span><br><span class="line"><span class="string">+----[SHA256]-----+</span></span><br></pre></td></tr></table></figure>

<h2 id="1-2-自动化脚本创建虚拟机节点—-由Gemini生成"><a href="#1-2-自动化脚本创建虚拟机节点—-由Gemini生成" class="headerlink" title="1.2 自动化脚本创建虚拟机节点— 由Gemini生成"></a>1.2 自动化脚本创建虚拟机节点— 由Gemini生成</h2><h3 id="create-vms-sh"><a href="#create-vms-sh" class="headerlink" title="create-vms.sh"></a>create-vms.sh</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- Configuration ---</span></span><br><span class="line">BASE_IMAGE_PATH=<span class="string">&quot;/home/ois/data/vmimages/noble-server-cloudimg-amd64.img&quot;</span></span><br><span class="line">VM_IMAGE_DIR=<span class="string">&quot;/home/ois/data/k8s/nodevms&quot;</span></span><br><span class="line">VM_CONFIG_DIR=<span class="string">&quot;/home/ois/data/k8s/nodevm_cfg&quot;</span></span><br><span class="line">RAM_MB=8192</span><br><span class="line">VCPUS=4</span><br><span class="line">DISK_SIZE_GB=20 <span class="comment"># &lt;--- ADDED: Increased disk size to 20 GB</span></span><br><span class="line">BRIDGE_INTERFACE=<span class="string">&quot;br0&quot;</span></span><br><span class="line">BASE_IP=<span class="string">&quot;10.75.59&quot;</span></span><br><span class="line">NETWORK_PREFIX=<span class="string">&quot;/24&quot;</span></span><br><span class="line">GATEWAY=<span class="string">&quot;10.75.59.1&quot;</span></span><br><span class="line">NAMESERVER1=<span class="string">&quot;64.104.76.247&quot;</span></span><br><span class="line">NAMESERVER2=<span class="string">&quot;64.104.14.184&quot;</span></span><br><span class="line">SEARCH_DOMAIN=<span class="string">&quot;cisco.com&quot;</span></span><br><span class="line">VNC_PORT_START=5905 <span class="comment"># VNC ports will be 5905, 5906, 5907</span></span><br><span class="line">PASSWORD_HASH=<span class="string">&#x27;$6$rounds=4096$LDu9pXXXXXXXXXXXXXXOh/Iunw372/TVfst1&#x27;</span></span><br><span class="line">SSH_PUB_KEY=$(<span class="built_in">cat</span> ~/.ssh/id_rsa.pub)</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- Loop to create 3 VMs ---</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;1..3&#125;; <span class="keyword">do</span></span><br><span class="line">    VM_NAME=<span class="string">&quot;kube-node-<span class="variable">$i</span>&quot;</span></span><br><span class="line">    VM_IP=<span class="string">&quot;<span class="variable">$&#123;BASE_IP&#125;</span>.<span class="subst">$((70 + i)</span>)&quot;</span> <span class="comment"># IPs will be 10.75.59.71, 10.75.59.72, 10.75.59.73</span></span><br><span class="line">    VM_IMAGE_PATH=<span class="string">&quot;<span class="variable">$&#123;VM_IMAGE_DIR&#125;</span>/<span class="variable">$&#123;VM_NAME&#125;</span>.qcow2&quot;</span></span><br><span class="line">    VM_VNC_PORT=$((VNC_PORT_START + i - <span class="number">1</span>)) <span class="comment"># VNC ports will be 5905, 5906, 5907</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;--- Preparing for <span class="variable">$VM_NAME</span> (IP: <span class="variable">$VM_IP</span>) ---&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Create directories if they don&#x27;t exist</span></span><br><span class="line">    <span class="built_in">mkdir</span> -p <span class="string">&quot;<span class="variable">$VM_IMAGE_DIR</span>&quot;</span></span><br><span class="line">    <span class="built_in">mkdir</span> -p <span class="string">&quot;<span class="variable">$VM_CONFIG_DIR</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Create a fresh image for each VM</span></span><br><span class="line">    <span class="keyword">if</span> [ -f <span class="string">&quot;<span class="variable">$VM_IMAGE_PATH</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Removing existing image for <span class="variable">$VM_NAME</span>...&quot;</span></span><br><span class="line">        <span class="built_in">rm</span> <span class="string">&quot;<span class="variable">$VM_IMAGE_PATH</span>&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Copying base image to <span class="variable">$VM_IMAGE_PATH</span>...&quot;</span></span><br><span class="line">    <span class="built_in">cp</span> <span class="string">&quot;<span class="variable">$BASE_IMAGE_PATH</span>&quot;</span> <span class="string">&quot;<span class="variable">$VM_IMAGE_PATH</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># --- NEW: Resize the copied image before virt-install ---</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Resizing VM image to <span class="variable">$&#123;DISK_SIZE_GB&#125;</span>GB...&quot;</span></span><br><span class="line">    qemu-img resize <span class="string">&quot;<span class="variable">$VM_IMAGE_PATH</span>&quot;</span> <span class="string">&quot;<span class="variable">$&#123;DISK_SIZE_GB&#125;</span>G&quot;</span></span><br><span class="line">    <span class="comment"># --- END NEW ---</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Generate user-data for the current VM</span></span><br><span class="line">    USER_DATA_FILE=<span class="string">&quot;<span class="variable">$&#123;VM_CONFIG_DIR&#125;</span>/<span class="variable">$&#123;VM_NAME&#125;</span>_user-data&quot;</span></span><br><span class="line">    <span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt; &quot;$USER_DATA_FILE&quot;</span></span><br><span class="line"><span class="string">#cloud-config</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">locale: en_US</span></span><br><span class="line"><span class="string">keyboard:</span></span><br><span class="line"><span class="string">  layout: us</span></span><br><span class="line"><span class="string">timezone: Asia/Shanghai</span></span><br><span class="line"><span class="string">hostname: $&#123;VM_NAME&#125;</span></span><br><span class="line"><span class="string">create_hostname_file: true</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">ssh_pwauth: yes</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">groups:</span></span><br><span class="line"><span class="string">  - ubuntu</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">users:</span></span><br><span class="line"><span class="string">  - name: ubuntu</span></span><br><span class="line"><span class="string">    gecos: ubuntu</span></span><br><span class="line"><span class="string">    primary_group: ubuntu</span></span><br><span class="line"><span class="string">    groups: sudo, cdrom</span></span><br><span class="line"><span class="string">    sudo: ALL=(ALL:ALL) ALL</span></span><br><span class="line"><span class="string">    shell: /bin/bash</span></span><br><span class="line"><span class="string">    lock_passwd: false</span></span><br><span class="line"><span class="string">    passwd: $&#123;PASSWORD_HASH&#125;</span></span><br><span class="line"><span class="string">    ssh_authorized_keys:</span></span><br><span class="line"><span class="string">      - &quot;$&#123;SSH_PUB_KEY&#125;&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">apt:</span></span><br><span class="line"><span class="string">  primary:</span></span><br><span class="line"><span class="string">    - arches: [default]</span></span><br><span class="line"><span class="string">      uri: http://us.archive.ubuntu.com/ubuntu/</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">packages:</span></span><br><span class="line"><span class="string">  - openssh-server</span></span><br><span class="line"><span class="string">  - net-tools</span></span><br><span class="line"><span class="string">  - iftop</span></span><br><span class="line"><span class="string">  - htop</span></span><br><span class="line"><span class="string">  - iperf3</span></span><br><span class="line"><span class="string">  - vim</span></span><br><span class="line"><span class="string">  - curl</span></span><br><span class="line"><span class="string">  - wget</span></span><br><span class="line"><span class="string">  - cloud-guest-utils # Ensure growpart is available</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">ntp:</span></span><br><span class="line"><span class="string">  servers: [&#x27;ntp.esl.cisco.com&#x27;]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">runcmd:</span></span><br><span class="line"><span class="string">  - echo &quot;Attempting to resize root partition and filesystem...&quot;</span></span><br><span class="line"><span class="string">  - growpart /dev/vda 1 # Expand the first partition on /dev/vda</span></span><br><span class="line"><span class="string">  - resize2fs /dev/vda1 # Expand the ext4 filesystem on /dev/vda1</span></span><br><span class="line"><span class="string">  - echo &quot;Disk resize commands executed. Verify with &#x27;df -h&#x27; after boot.&quot;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Generate network-config for the current VM</span></span><br><span class="line">    NETWORK_CONFIG_FILE=<span class="string">&quot;<span class="variable">$&#123;VM_CONFIG_DIR&#125;</span>/<span class="variable">$&#123;VM_NAME&#125;</span>_network-config&quot;</span></span><br><span class="line">    <span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt; &quot;$NETWORK_CONFIG_FILE&quot;</span></span><br><span class="line"><span class="string">network:</span></span><br><span class="line"><span class="string">  version: 2</span></span><br><span class="line"><span class="string">  ethernets:</span></span><br><span class="line"><span class="string">    enp1s0:</span></span><br><span class="line"><span class="string">      addresses:</span></span><br><span class="line"><span class="string">      - &quot;$&#123;VM_IP&#125;$&#123;NETWORK_PREFIX&#125;&quot;</span></span><br><span class="line"><span class="string">      nameservers:</span></span><br><span class="line"><span class="string">        addresses:</span></span><br><span class="line"><span class="string">        - $&#123;NAMESERVER1&#125;</span></span><br><span class="line"><span class="string">        - $&#123;NAMESERVER2&#125;</span></span><br><span class="line"><span class="string">        search:</span></span><br><span class="line"><span class="string">        - $&#123;SEARCH_DOMAIN&#125;</span></span><br><span class="line"><span class="string">      routes:</span></span><br><span class="line"><span class="string">      - to: &quot;default&quot;</span></span><br><span class="line"><span class="string">        via: &quot;$&#123;GATEWAY&#125;&quot;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Generate meta-data (can be static for now)</span></span><br><span class="line">    META_DATA_FILE=<span class="string">&quot;<span class="variable">$&#123;VM_CONFIG_DIR&#125;</span>/<span class="variable">$&#123;VM_NAME&#125;</span>_meta-data&quot;</span></span><br><span class="line">    <span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt; &quot;$META_DATA_FILE&quot;</span></span><br><span class="line"><span class="string">instance-id: $&#123;VM_NAME&#125;</span></span><br><span class="line"><span class="string">local-hostname: $&#123;VM_NAME&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;--- Installing <span class="variable">$VM_NAME</span> ---&quot;</span></span><br><span class="line">    virt-install --name <span class="string">&quot;<span class="variable">$&#123;VM_NAME&#125;</span>&quot;</span> --ram <span class="string">&quot;<span class="variable">$&#123;RAM_MB&#125;</span>&quot;</span> --vcpus <span class="string">&quot;<span class="variable">$&#123;VCPUS&#125;</span>&quot;</span> --noreboot \</span><br><span class="line">        --os-variant ubuntu24.04 \</span><br><span class="line">        --network bridge=<span class="string">&quot;<span class="variable">$&#123;BRIDGE_INTERFACE&#125;</span>&quot;</span> \</span><br><span class="line">        --graphics vnc,listen=0.0.0.0,port=<span class="string">&quot;<span class="variable">$&#123;VM_VNC_PORT&#125;</span>&quot;</span> \</span><br><span class="line">        --disk path=<span class="string">&quot;<span class="variable">$&#123;VM_IMAGE_PATH&#125;</span>&quot;</span>,format=qcow2 \</span><br><span class="line">        --console pty,target_type=serial \</span><br><span class="line">        --cloud-init user-data=<span class="string">&quot;<span class="variable">$&#123;USER_DATA_FILE&#125;</span>&quot;</span>,meta-data=<span class="string">&quot;<span class="variable">$&#123;META_DATA_FILE&#125;</span>&quot;</span>,network-config=<span class="string">&quot;<span class="variable">$&#123;NETWORK_CONFIG_FILE&#125;</span>&quot;</span> \</span><br><span class="line">        --import \</span><br><span class="line">        --<span class="built_in">wait</span> 0</span><br><span class="line"></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Successfully initiated creation of <span class="variable">$VM_NAME</span>.&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;You can connect to VNC on port <span class="variable">$&#123;VM_VNC_PORT&#125;</span> to monitor installation (optional).&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Wait a few minutes for the VM to boot and cloud-init to run.&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;--------------------------------------------------------&quot;</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;All 3 VMs have been initiated. Please wait for them to fully provision.&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;You can SSH into them using &#x27;ssh ubuntu@&lt;IP_ADDRESS&gt;&#x27; where IP addresses are 10.75.59.71, 10.75.59.72, 10.75.59.73.&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>上述脚本可自动生成三个虚拟机，并可以使用 ssh <a href="mailto:&#x75;&#x62;&#117;&#110;&#116;&#117;&#x40;&#x31;&#48;&#x2e;&#x37;&#53;&#x2e;&#x35;&#57;&#46;&#55;&#49;">&#x75;&#x62;&#117;&#110;&#116;&#117;&#x40;&#x31;&#48;&#x2e;&#x37;&#53;&#x2e;&#x35;&#57;&#46;&#55;&#49;</a> 登录</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> +x create-vms.sh</span><br><span class="line"></span><br><span class="line">ois@ois:~/data/k8s$ ./create-vms.sh </span><br><span class="line">--- Preparing <span class="keyword">for</span> kube-node-1 (IP: 10.75.59.71) ---</span><br><span class="line">Removing existing image <span class="keyword">for</span> kube-node-1...</span><br><span class="line">Copying base image to /home/ois/data/k8s/nodevms/kube-node-1.qcow2...</span><br><span class="line">Resizing VM image to 20GB...</span><br><span class="line">Image resized.</span><br><span class="line">--- Installing kube-node-1 ---</span><br><span class="line">WARNING  Treating --<span class="built_in">wait</span> 0 as --noautoconsole</span><br><span class="line"></span><br><span class="line">Starting install...</span><br><span class="line">Allocating <span class="string">&#x27;virtinst-3jev55ba-cloudinit.iso&#x27;</span>                                                                                                                                                                                             |    0 B  00:00:00 ... </span><br><span class="line">Transferring <span class="string">&#x27;virtinst-3jev55ba-cloudinit.iso&#x27;</span>                                                                                                                                                                                           |    0 B  00:00:00 ... </span><br><span class="line">Creating domain...                                                                                                                                                                                                                       |    0 B  00:00:00     </span><br><span class="line">Domain creation completed.</span><br><span class="line">Successfully initiated creation of kube-node-1.</span><br><span class="line">You can connect to VNC on port 5905 to monitor installation (optional).</span><br><span class="line">Wait a few minutes <span class="keyword">for</span> the VM to boot and cloud-init to run.</span><br><span class="line">--------------------------------------------------------</span><br><span class="line">--- Preparing <span class="keyword">for</span> kube-node-2 (IP: 10.75.59.72) ---</span><br><span class="line">Removing existing image <span class="keyword">for</span> kube-node-2...</span><br><span class="line">Copying base image to /home/ois/data/k8s/nodevms/kube-node-2.qcow2...</span><br><span class="line">Resizing VM image to 20GB...</span><br><span class="line">Image resized.</span><br><span class="line">--- Installing kube-node-2 ---</span><br><span class="line">WARNING  Treating --<span class="built_in">wait</span> 0 as --noautoconsole</span><br><span class="line"></span><br><span class="line">Starting install...</span><br><span class="line">Allocating <span class="string">&#x27;virtinst-c4ruhql3-cloudinit.iso&#x27;</span>                                                                                                                                                                                             |    0 B  00:00:00 ... </span><br><span class="line">Transferring <span class="string">&#x27;virtinst-c4ruhql3-cloudinit.iso&#x27;</span>                                                                                                                                                                                           |    0 B  00:00:00 ... </span><br><span class="line">Creating domain...                                                                                                                                                                                                                       |    0 B  00:00:00     </span><br><span class="line">Domain creation completed.</span><br><span class="line">Successfully initiated creation of kube-node-2.</span><br><span class="line">You can connect to VNC on port 5906 to monitor installation (optional).</span><br><span class="line">Wait a few minutes <span class="keyword">for</span> the VM to boot and cloud-init to run.</span><br><span class="line">--------------------------------------------------------</span><br><span class="line">--- Preparing <span class="keyword">for</span> kube-node-3 (IP: 10.75.59.73) ---</span><br><span class="line">Removing existing image <span class="keyword">for</span> kube-node-3...</span><br><span class="line">Copying base image to /home/ois/data/k8s/nodevms/kube-node-3.qcow2...</span><br><span class="line">Resizing VM image to 20GB...</span><br><span class="line">Image resized.</span><br><span class="line">--- Installing kube-node-3 ---</span><br><span class="line">WARNING  Treating --<span class="built_in">wait</span> 0 as --noautoconsole</span><br><span class="line"></span><br><span class="line">Starting install...</span><br><span class="line">Allocating <span class="string">&#x27;virtinst-u5e8k9a9-cloudinit.iso&#x27;</span>                                                                                                                                                                                             |    0 B  00:00:00 ... </span><br><span class="line">Transferring <span class="string">&#x27;virtinst-u5e8k9a9-cloudinit.iso&#x27;</span>                                                                                                                                                                                           |    0 B  00:00:00 ... </span><br><span class="line">Creating domain...                                                                                                                                                                                                                       |    0 B  00:00:00     </span><br><span class="line">Domain creation completed.</span><br><span class="line">Successfully initiated creation of kube-node-3.</span><br><span class="line">You can connect to VNC on port 5907 to monitor installation (optional).</span><br><span class="line">Wait a few minutes <span class="keyword">for</span> the VM to boot and cloud-init to run.</span><br><span class="line">--------------------------------------------------------</span><br><span class="line">All 3 VMs have been initiated. Please <span class="built_in">wait</span> <span class="keyword">for</span> them to fully provision.</span><br><span class="line">You can SSH into them using <span class="string">&#x27;ssh ubuntu@&lt;IP_ADDRESS&gt;&#x27;</span> <span class="built_in">where</span> IP addresses are 10.75.59.71, 10.75.59.72, 10.75.59.73.</span><br><span class="line"></span><br><span class="line">ois@ois:~/data/k8s$ virsh list</span><br><span class="line"> Id   Name                  State</span><br><span class="line">-------------------------------------</span><br><span class="line"> 83   kube-node-1           running</span><br><span class="line"> 84   kube-node-2           running</span><br><span class="line"> 85   kube-node-3           running</span><br></pre></td></tr></table></figure>

<h3 id="user-data-示例"><a href="#user-data-示例" class="headerlink" title="user-data 示例"></a>user-data 示例</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#cloud-config</span></span><br><span class="line"></span><br><span class="line">locale: en_US</span><br><span class="line">keyboard:</span><br><span class="line">  layout: us</span><br><span class="line">timezone: Asia/Shanghai</span><br><span class="line">hostname: kube-node-1</span><br><span class="line">create_hostname_file: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">ssh_pwauth: <span class="built_in">yes</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">groups</span>:</span><br><span class="line">  - ubuntu</span><br><span class="line"></span><br><span class="line"><span class="built_in">users</span>:</span><br><span class="line">  - name: ubuntu</span><br><span class="line">    gecos: ubuntu</span><br><span class="line">    primary_group: ubuntu</span><br><span class="line">    <span class="built_in">groups</span>: sudo, cdrom</span><br><span class="line">    sudo: ALL=(ALL:ALL) ALL</span><br><span class="line">    shell: /bin/bash</span><br><span class="line">    lock_passwd: <span class="literal">false</span></span><br><span class="line">    passwd: $6<span class="variable">$rounds</span>=4096<span class="variable">$LDu9pXXXXXXXXXXXXXXOh</span>/Iunw372/TVfst1</span><br><span class="line">    ssh_authorized_keys:</span><br><span class="line">      - <span class="string">&quot;ssh-rsa AAAAB3NzaC1yXXXXXXXXXX==&quot;</span></span><br><span class="line"></span><br><span class="line">apt:</span><br><span class="line">  primary:</span><br><span class="line">    - arches: [default]</span><br><span class="line">      uri: http://us.archive.ubuntu.com/ubuntu/</span><br><span class="line"></span><br><span class="line">packages:</span><br><span class="line">  - openssh-server</span><br><span class="line">  - net-tools</span><br><span class="line">  - iftop</span><br><span class="line">  - htop</span><br><span class="line">  - iperf3</span><br><span class="line">  - vim</span><br><span class="line">  - curl</span><br><span class="line">  - wget</span><br><span class="line">  - cloud-guest-utils <span class="comment"># Ensure growpart is available</span></span><br><span class="line"></span><br><span class="line">ntp:</span><br><span class="line">  servers: [<span class="string">&#x27;ntp.esl.cisco.com&#x27;</span>]</span><br><span class="line"></span><br><span class="line">runcmd:</span><br><span class="line">  - <span class="built_in">echo</span> <span class="string">&quot;Attempting to resize root partition and filesystem...&quot;</span></span><br><span class="line">  - growpart /dev/vda 1 <span class="comment"># Expand the first partition on /dev/vda</span></span><br><span class="line">  - resize2fs /dev/vda1 <span class="comment"># Expand the ext4 filesystem on /dev/vda1</span></span><br><span class="line">  - <span class="built_in">echo</span> <span class="string">&quot;Disk resize commands executed. Verify with &#x27;df -h&#x27; after boot.&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="network-config"><a href="#network-config" class="headerlink" title="network-config"></a>network-config</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">network:</span><br><span class="line">  version: 2</span><br><span class="line">  ethernets:</span><br><span class="line">    enp1s0:</span><br><span class="line">      addresses:</span><br><span class="line">      - <span class="string">&quot;10.75.59.71/24&quot;</span></span><br><span class="line">      nameservers:</span><br><span class="line">        addresses:</span><br><span class="line">        - 64.104.76.247</span><br><span class="line">        - 64.104.14.184</span><br><span class="line">        search:</span><br><span class="line">        - cisco.com</span><br><span class="line">      routes:</span><br><span class="line">      - to: <span class="string">&quot;default&quot;</span></span><br><span class="line">        via: <span class="string">&quot;10.75.59.1&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="meta-data"><a href="#meta-data" class="headerlink" title="meta-data"></a>meta-data</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">instance-id: kube-node-1</span><br><span class="line">local-hostname: kube-node-1</span><br></pre></td></tr></table></figure>

<h1 id="2-使用Ansible安装Kubernetes"><a href="#2-使用Ansible安装Kubernetes" class="headerlink" title="2. 使用Ansible安装Kubernetes"></a>2. 使用Ansible安装Kubernetes</h1><h2 id="2-1-脚本内容"><a href="#2-1-脚本内容" class="headerlink" title="2.1 脚本内容"></a>2.1 脚本内容</h2><p>以下脚本可用于自动化安装Ansible，并生成Playbook，可直接执行安装任务。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># This script automates the setup of an Ansible environment for Kubernetes cluster deployment.</span></span><br><span class="line"><span class="comment"># It installs Ansible, creates the project directory, inventory, configuration,</span></span><br><span class="line"><span class="comment"># and defines common Kubernetes setup tasks.</span></span><br><span class="line"><span class="comment"># This version stops after installing Kubernetes components, allowing manual kubeadm init/join.</span></span><br><span class="line"><span class="comment"># Includes a robust fix for Containerd&#x27;s SystemdCgroup configuration and CRI plugin enabling,</span></span><br><span class="line"><span class="comment"># defines the necessary handler for restarting Containerd, dynamically adds host entries to /etc/hosts,</span></span><br><span class="line"><span class="comment"># and updates the pause image version in the manual instructions.</span></span><br><span class="line"><span class="comment"># This update also addresses the runc runtime root configuration in containerd and fixes</span></span><br><span class="line"><span class="comment"># YAML escape character issues in the hosts file regex, and updates the sandbox image in containerd config.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- Configuration ---</span></span><br><span class="line">PROJECT_DIR=<span class="string">&quot;k8s_cluster_setup&quot;</span></span><br><span class="line">MASTER_NODE_IP=<span class="string">&quot;10.75.59.71&quot;</span> <span class="comment"># Based on your previous script&#x27;s IP assignment for kube-node-1</span></span><br><span class="line">WORKER_NODE_IP_1=<span class="string">&quot;10.75.59.72&quot;</span> <span class="comment"># Based on your previous script&#x27;s IP assignment for kube-node-2</span></span><br><span class="line">WORKER_NODE_IP_2=<span class="string">&quot;10.75.59.73&quot;</span> <span class="comment"># Based on your previous script&#x27;s IP address for kube-node-3</span></span><br><span class="line">ANSIBLE_USER=<span class="string">&quot;ubuntu&quot;</span> <span class="comment"># The user created by cloud-init on your VMs</span></span><br><span class="line">SSH_PRIVATE_KEY_PATH=<span class="string">&quot;~/.ssh/id_rsa&quot;</span> <span class="comment"># Path to your SSH private key on the Ansible control machine</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- Functions ---</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Function to install Ansible</span></span><br><span class="line"><span class="function"><span class="title">install_ansible</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;--- Installing Ansible ---&quot;</span></span><br><span class="line">    <span class="keyword">if</span> ! <span class="built_in">command</span> -v ansible &amp;&gt; /dev/null; <span class="keyword">then</span></span><br><span class="line">        sudo apt update -y</span><br><span class="line">        sudo apt install -y ansible</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Ansible installed successfully.&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Ansible is already installed.&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Function to create project directory and navigate into it</span></span><br><span class="line"><span class="function"><span class="title">create_project_dir</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;--- Creating project directory: <span class="variable">$&#123;PROJECT_DIR&#125;</span> ---&quot;</span></span><br><span class="line">    <span class="built_in">mkdir</span> -p <span class="string">&quot;<span class="variable">$&#123;PROJECT_DIR&#125;</span>&quot;</span></span><br><span class="line">    <span class="built_in">cd</span> <span class="string">&quot;<span class="variable">$&#123;PROJECT_DIR&#125;</span>&quot;</span> || &#123; <span class="built_in">echo</span> <span class="string">&quot;Failed to change directory to <span class="variable">$&#123;PROJECT_DIR&#125;</span>. Exiting.&quot;</span>; <span class="built_in">exit</span> 1; &#125;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Changed to directory: <span class="subst">$(pwd)</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Function to create ansible.cfg</span></span><br><span class="line"><span class="function"><span class="title">create_ansible_cfg</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;--- Creating ansible.cfg ---&quot;</span></span><br><span class="line">    <span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt; ansible.cfg</span></span><br><span class="line"><span class="string">[defaults]</span></span><br><span class="line"><span class="string">inventory = inventory.ini</span></span><br><span class="line"><span class="string">roles_path = ./roles</span></span><br><span class="line"><span class="string">host_key_checking = False # WARNING: Disable host key checking for convenience during initial setup. Re-enable for production!</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;ansible.cfg created.&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Function to create inventory.ini (UPDATED with IP variables)</span></span><br><span class="line"><span class="function"><span class="title">create_inventory</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;--- Creating inventory.ini ---&quot;</span></span><br><span class="line">    <span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt; inventory.ini</span></span><br><span class="line"><span class="string">[master]</span></span><br><span class="line"><span class="string">kube-node-1 ansible_host=$&#123;MASTER_NODE_IP&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[workers]</span></span><br><span class="line"><span class="string">kube-node-2 ansible_host=$&#123;WORKER_NODE_IP_1&#125;</span></span><br><span class="line"><span class="string">kube-node-3 ansible_host=$&#123;WORKER_NODE_IP_2&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[all:vars]</span></span><br><span class="line"><span class="string">ansible_user=$&#123;ANSIBLE_USER&#125;</span></span><br><span class="line"><span class="string">ansible_ssh_private_key_file=$&#123;SSH_PRIVATE_KEY_PATH&#125;</span></span><br><span class="line"><span class="string">ansible_python_interpreter=/usr/bin/python3</span></span><br><span class="line"><span class="string"># These variables are now primarily for documentation/script clarity,</span></span><br><span class="line"><span class="string"># as the hosts file task will dynamically read from inventory groups.</span></span><br><span class="line"><span class="string">master_node_ip=$&#123;MASTER_NODE_IP&#125;</span></span><br><span class="line"><span class="string">worker_node_ip_1=$&#123;WORKER_NODE_IP_1&#125;</span></span><br><span class="line"><span class="string">worker_node_ip_2=$&#123;WORKER_NODE_IP_2&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;inventory.ini created.&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Function to create main playbook.yml (Modified to only include common setup)</span></span><br><span class="line"><span class="function"><span class="title">create_playbook</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;--- Creating playbook.yml ---&quot;</span></span><br><span class="line">    <span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt; playbook.yml</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">- name: Common Kubernetes Setup for all nodes</span></span><br><span class="line"><span class="string">  hosts: all</span></span><br><span class="line"><span class="string">  become: yes</span></span><br><span class="line"><span class="string">  roles:</span></span><br><span class="line"><span class="string">    - common_k8s_setup</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;playbook.yml created (only common setup included).&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Function to create roles and their tasks</span></span><br><span class="line"><span class="function"><span class="title">create_roles</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;--- Creating Ansible roles and tasks ---&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># common_k8s_setup role</span></span><br><span class="line">    <span class="built_in">mkdir</span> -p roles/common_k8s_setup/tasks</span><br><span class="line">    <span class="comment"># UPDATED: main.yml to include the new hosts entry task first</span></span><br><span class="line">    <span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt; roles/common_k8s_setup/tasks/main.yml</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">- name: Include add hosts entries task</span></span><br><span class="line"><span class="string">  ansible.builtin.include_tasks: 00_add_hosts_entries.yml</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">- name: Include disable swap task</span></span><br><span class="line"><span class="string">  ansible.builtin.include_tasks: 01_disable_swap.yml</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">- name: Include containerd setup task</span></span><br><span class="line"><span class="string">  ansible.builtin.include_tasks: 02_containerd_setup.yml</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">- name: Include kernel modules and sysctl task</span></span><br><span class="line"><span class="string">  ansible.builtin.include_tasks: 03_kernel_modules_sysctl.yml</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">- name: Include kube repo, install, and hold task</span></span><br><span class="line"><span class="string">  ansible.builtin.include_tasks: 04_kube_repo_install_hold.yml</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">- name: Include initial apt upgrade task</span></span><br><span class="line"><span class="string">  ansible.builtin.include_tasks: 05_initial_upgrade.yml</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">- name: Include configure weekly updates task</span></span><br><span class="line"><span class="string">  ansible.builtin.include_tasks: 06_configure_weekly_updates.yml</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># NEW FILE: 00_add_hosts_entries.yml (Dynamically adds hosts from inventory, FIXED: Escaped backslashes in regex)</span></span><br><span class="line">    <span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt; roles/common_k8s_setup/tasks/00_add_hosts_entries.yml</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">- name: Add all inventory hosts to /etc/hosts on each node</span></span><br><span class="line"><span class="string">  ansible.builtin.lineinfile:</span></span><br><span class="line"><span class="string">    path: /etc/hosts</span></span><br><span class="line"><span class="string">    regexp: &quot;^&#123;&#123; hostvars[item][&#x27;ansible_host&#x27;] &#125;&#125;\\\\s+&#123;&#123; item &#125;&#125;&quot; # Fixed: \\\\s for escaped backslash in regex</span></span><br><span class="line"><span class="string">    line: &quot;&#123;&#123; hostvars[item][&#x27;ansible_host&#x27;] &#125;&#125; &#123;&#123; item &#125;&#125;&quot;</span></span><br><span class="line"><span class="string">    state: present</span></span><br><span class="line"><span class="string">    create: yes</span></span><br><span class="line"><span class="string">    mode: &#x27;0644&#x27;</span></span><br><span class="line"><span class="string">    owner: root</span></span><br><span class="line"><span class="string">    group: root</span></span><br><span class="line"><span class="string">  loop: &quot;&#123;&#123; groups[&#x27;all&#x27;] &#125;&#125;&quot; # Loop over all hosts defined in the inventory</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Create handlers directory and file</span></span><br><span class="line">    <span class="built_in">mkdir</span> -p roles/common_k8s_setup/handlers</span><br><span class="line">    <span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt; roles/common_k8s_setup/handlers/main.yml</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">- name: Restart containerd service</span></span><br><span class="line"><span class="string">  ansible.builtin.systemd:</span></span><br><span class="line"><span class="string">    name: containerd</span></span><br><span class="line"><span class="string">    state: restarted</span></span><br><span class="line"><span class="string">    daemon_reload: yes</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 01_disable_swap.yml</span></span><br><span class="line">    <span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt; roles/common_k8s_setup/tasks/01_disable_swap.yml</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">- name: Check if swap is active</span></span><br><span class="line"><span class="string">  ansible.builtin.command: swapon --show</span></span><br><span class="line"><span class="string">  register: swap_check_result</span></span><br><span class="line"><span class="string">  changed_when: false # This command itself doesn&#x27;t change state</span></span><br><span class="line"><span class="string">  failed_when: false  # Don&#x27;t fail if swapon --show returns non-zero (e.g., no swap enabled)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">- name: Disable swap</span></span><br><span class="line"><span class="string">  ansible.builtin.command: swapoff -a</span></span><br><span class="line"><span class="string">  when: swap_check_result.rc == 0 # Only run if swapon --show indicated swap is active</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">- name: Persistently disable swap (comment out swapfile in fstab)</span></span><br><span class="line"><span class="string">  ansible.builtin.replace:</span></span><br><span class="line"><span class="string">    path: /etc/fstab</span></span><br><span class="line"><span class="string">    regexp: &#x27;^(/swapfile.*)$&#x27;</span></span><br><span class="line"><span class="string">    replace: &#x27;#\1&#x27;</span></span><br><span class="line"><span class="string">  when: swap_check_result.rc == 0 # Only run if swap was found to be active</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 02_containerd_setup.yml (UPDATED for sandbox_image)</span></span><br><span class="line">    <span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt; roles/common_k8s_setup/tasks/02_containerd_setup.yml</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">- name: Install required packages for Containerd</span></span><br><span class="line"><span class="string">  ansible.builtin.apt:</span></span><br><span class="line"><span class="string">    name:</span></span><br><span class="line"><span class="string">      - ca-certificates</span></span><br><span class="line"><span class="string">      - curl</span></span><br><span class="line"><span class="string">      - gnupg</span></span><br><span class="line"><span class="string">      - lsb-release</span></span><br><span class="line"><span class="string">      - apt-transport-https</span></span><br><span class="line"><span class="string">      - software-properties-common</span></span><br><span class="line"><span class="string">    state: present</span></span><br><span class="line"><span class="string">    update_cache: yes</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">- name: Add Docker GPG key</span></span><br><span class="line"><span class="string">  ansible.builtin.apt_key:</span></span><br><span class="line"><span class="string">    url: https://download.docker.com/linux/ubuntu/gpg</span></span><br><span class="line"><span class="string">    state: present</span></span><br><span class="line"><span class="string">    keyring: /etc/apt/keyrings/docker.gpg # Use keyring for modern apt</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">- name: Add Docker APT repository</span></span><br><span class="line"><span class="string">  ansible.builtin.apt_repository:</span></span><br><span class="line"><span class="string">    repo: &quot;deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu &#123;&#123; ansible_distribution_release &#125;&#125; stable&quot;</span></span><br><span class="line"><span class="string">    state: present</span></span><br><span class="line"><span class="string">    filename: docker</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">- name: Install Containerd</span></span><br><span class="line"><span class="string">  ansible.builtin.apt:</span></span><br><span class="line"><span class="string">    name: containerd.io</span></span><br><span class="line"><span class="string">    state: present</span></span><br><span class="line"><span class="string">    update_cache: yes</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">- name: Create containerd configuration directory</span></span><br><span class="line"><span class="string">  ansible.builtin.file:</span></span><br><span class="line"><span class="string">    path: /etc/containerd</span></span><br><span class="line"><span class="string">    state: directory</span></span><br><span class="line"><span class="string">    mode: &#x27;0755&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">- name: Generate default containerd configuration directly to final path</span></span><br><span class="line"><span class="string">  ansible.builtin.shell: containerd config default &gt; /etc/containerd/config.toml</span></span><br><span class="line"><span class="string">  changed_when: true # Always report change as we&#x27;re ensuring a default state</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">- name: Ensure CRI plugin is enabled (remove any disabled_plugins line containing &quot;cri&quot;)</span></span><br><span class="line"><span class="string">  ansible.builtin.lineinfile:</span></span><br><span class="line"><span class="string">    path: /etc/containerd/config.toml</span></span><br><span class="line"><span class="string">    regexp: &#x27;^\s*disabled_plugins = \[.*&quot;cri&quot;.*\]&#x27; # More general regexp</span></span><br><span class="line"><span class="string">    state: absent</span></span><br><span class="line"><span class="string">    backup: yes</span></span><br><span class="line"><span class="string">  notify: Restart containerd service</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">- name: Remove top-level systemd_cgroup from CRI plugin section</span></span><br><span class="line"><span class="string">  ansible.builtin.lineinfile:</span></span><br><span class="line"><span class="string">    path: /etc/containerd/config.toml</span></span><br><span class="line"><span class="string">    regexp: &#x27;^\s*systemd_cgroup = (true|false)&#x27; # Matches the &#x27;systemd_cgroup&#x27; directly under [plugins.&quot;io.containerd.grpc.v1.cri&quot;]</span></span><br><span class="line"><span class="string">    state: absent # Remove this line</span></span><br><span class="line"><span class="string">    backup: yes</span></span><br><span class="line"><span class="string">  notify: Restart containerd service</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">- name: Remove old runtime_root from runc runtime section</span></span><br><span class="line"><span class="string">  ansible.builtin.lineinfile:</span></span><br><span class="line"><span class="string">    path: /etc/containerd/config.toml</span></span><br><span class="line"><span class="string">    regexp: &#x27;^\s*runtime_root = &quot;.*&quot;&#x27; # Matches runtime_root line</span></span><br><span class="line"><span class="string">    state: absent</span></span><br><span class="line"><span class="string">    backup: yes</span></span><br><span class="line"><span class="string">  notify: Restart containerd service</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">- name: Configure runc runtime to use SystemdCgroup = true</span></span><br><span class="line"><span class="string">  ansible.builtin.lineinfile:</span></span><br><span class="line"><span class="string">    path: /etc/containerd/config.toml</span></span><br><span class="line"><span class="string">    regexp: &#x27;^\s*#?\s*SystemdCgroup = (true|false)&#x27; # Matches the &#x27;SystemdCgroup&#x27; under runc.options</span></span><br><span class="line"><span class="string">    line: &#x27;            SystemdCgroup = true&#x27; # Ensure correct indentation</span></span><br><span class="line"><span class="string">    insertafter: &#x27;^\s*\[plugins\.&quot;io\.containerd\.grpc\.v1\.cri&quot;\.containerd\.runtimes\.runc\.options\]&#x27;</span></span><br><span class="line"><span class="string">    backup: yes</span></span><br><span class="line"><span class="string">  notify: Restart containerd service</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">- name: Add Root path to runc options</span></span><br><span class="line"><span class="string">  ansible.builtin.lineinfile:</span></span><br><span class="line"><span class="string">    path: /etc/containerd/config.toml</span></span><br><span class="line"><span class="string">    regexp: &#x27;^\s*Root = &quot;.*&quot;&#x27; # Matches existing Root line if any</span></span><br><span class="line"><span class="string">    line: &#x27;            Root = &quot;/run/containerd/runc&quot;&#x27; # New Root path</span></span><br><span class="line"><span class="string">    insertafter: &#x27;^\s*\[plugins\.&quot;io\.containerd\.grpc\.v1\.cri&quot;\.containerd\.runtimes\.runc\.options\]&#x27;</span></span><br><span class="line"><span class="string">    backup: yes</span></span><br><span class="line"><span class="string">  notify: Restart containerd service</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">- name: Update sandbox_image to pause:3.10</span></span><br><span class="line"><span class="string">  ansible.builtin.lineinfile:</span></span><br><span class="line"><span class="string">    path: /etc/containerd/config.toml</span></span><br><span class="line"><span class="string">    regexp: &#x27;^\s*sandbox_image = &quot;registry.k8s.io/pause:.*&quot;&#x27;</span></span><br><span class="line"><span class="string">    line: &#x27;    sandbox_image = &quot;registry.k8s.io/pause:3.10&quot;&#x27;</span></span><br><span class="line"><span class="string">    insertafter: &#x27;^\s*\[plugins\.&quot;io\.containerd\.grpc\.v1\.cri&quot;\]&#x27; # Insert after the CRI plugin section start</span></span><br><span class="line"><span class="string">    backup: yes</span></span><br><span class="line"><span class="string">  notify: Restart containerd service</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 03_kernel_modules_sysctl.yml</span></span><br><span class="line">    <span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt; roles/common_k8s_setup/tasks/03_kernel_modules_sysctl.yml</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">- name: Load overlay module</span></span><br><span class="line"><span class="string">  ansible.builtin.command: modprobe overlay</span></span><br><span class="line"><span class="string">  args:</span></span><br><span class="line"><span class="string">    creates: /sys/module/overlay # Check if module is loaded</span></span><br><span class="line"><span class="string">  changed_when: false</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">- name: Load br_netfilter module</span></span><br><span class="line"><span class="string">  ansible.builtin.command: modprobe br_netfilter</span></span><br><span class="line"><span class="string">  args:</span></span><br><span class="line"><span class="string">    creates: /sys/module/br_netfilter # Check if module is loaded</span></span><br><span class="line"><span class="string">  changed_when: false</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">- name: Add modules to /etc/modules-load.d/k8s.conf</span></span><br><span class="line"><span class="string">  ansible.builtin.copy:</span></span><br><span class="line"><span class="string">    dest: /etc/modules-load.d/k8s.conf</span></span><br><span class="line"><span class="string">    content: |</span></span><br><span class="line"><span class="string">      overlay</span></span><br><span class="line"><span class="string">      br_netfilter</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">- name: Configure sysctl parameters for Kubernetes networking</span></span><br><span class="line"><span class="string">  ansible.builtin.copy:</span></span><br><span class="line"><span class="string">    dest: /etc/sysctl.d/k8s.conf</span></span><br><span class="line"><span class="string">    content: |</span></span><br><span class="line"><span class="string">      net.bridge.bridge-nf-call-iptables = 1</span></span><br><span class="line"><span class="string">      net.bridge.bridge-nf-call-ip6tables = 1</span></span><br><span class="line"><span class="string">      net.ipv4.ip_forward = 1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">- name: Apply sysctl parameters</span></span><br><span class="line"><span class="string">  ansible.builtin.command: sysctl --system</span></span><br><span class="line"><span class="string">  changed_when: false</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 04_kube_repo_install_hold.yml</span></span><br><span class="line">    <span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt; roles/common_k8s_setup/tasks/04_kube_repo_install_hold.yml</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">- name: Create Kubernetes apt keyring directory</span></span><br><span class="line"><span class="string">  ansible.builtin.file:</span></span><br><span class="line"><span class="string">    path: /etc/apt/keyrings</span></span><br><span class="line"><span class="string">    state: directory</span></span><br><span class="line"><span class="string">    mode: &#x27;0755&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">- name: Download Kubernetes GPG key and dearmor</span></span><br><span class="line"><span class="string">  ansible.builtin.shell: |</span></span><br><span class="line"><span class="string">    curl -fsSL https://pkgs.k8s.io/core:/stable:/v1.33/deb/Release.key | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg</span></span><br><span class="line"><span class="string">  args:</span></span><br><span class="line"><span class="string">    creates: /etc/apt/keyrings/kubernetes-apt-keyring.gpg</span></span><br><span class="line"><span class="string">  changed_when: false # This command is idempotent enough for our purposes</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">- name: Add Kubernetes APT repository source list</span></span><br><span class="line"><span class="string">  ansible.builtin.copy:</span></span><br><span class="line"><span class="string">    dest: /etc/apt/sources.list.d/kubernetes.list</span></span><br><span class="line"><span class="string">    content: &quot;deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.33/deb/ /\n&quot;</span></span><br><span class="line"><span class="string">    mode: &#x27;0644&#x27;</span></span><br><span class="line"><span class="string">    backup: yes</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">- name: Update apt cache after adding Kubernetes repo</span></span><br><span class="line"><span class="string">  ansible.builtin.apt:</span></span><br><span class="line"><span class="string">    update_cache: yes</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">- name: Install kubelet, kubeadm, kubectl</span></span><br><span class="line"><span class="string">  ansible.builtin.apt:</span></span><br><span class="line"><span class="string">    name:</span></span><br><span class="line"><span class="string">      - kubelet</span></span><br><span class="line"><span class="string">      - kubeadm</span></span><br><span class="line"><span class="string">      - kubectl</span></span><br><span class="line"><span class="string">    state: present</span></span><br><span class="line"><span class="string">    update_cache: yes # Ensure apt cache is updated after adding repo.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">- name: Hold kubelet, kubeadm, kubectl packages</span></span><br><span class="line"><span class="string">  ansible.builtin.dpkg_selections:</span></span><br><span class="line"><span class="string">    name: &quot;&#123;&#123; item &#125;&#125;&quot;</span></span><br><span class="line"><span class="string">    selection: hold</span></span><br><span class="line"><span class="string">  loop:</span></span><br><span class="line"><span class="string">    - kubelet</span></span><br><span class="line"><span class="string">    - kubeadm</span></span><br><span class="line"><span class="string">    - kubectl</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">- name: Enable and start kubelet service</span></span><br><span class="line"><span class="string">  ansible.builtin.systemd:</span></span><br><span class="line"><span class="string">    name: kubelet</span></span><br><span class="line"><span class="string">    state: started</span></span><br><span class="line"><span class="string">    enabled: yes</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># NEW FILE: 05_initial_upgrade.yml</span></span><br><span class="line">    <span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt; roles/common_k8s_setup/tasks/05_initial_upgrade.yml</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">- name: Perform initial apt update and upgrade</span></span><br><span class="line"><span class="string">  ansible.builtin.apt:</span></span><br><span class="line"><span class="string">    update_cache: yes</span></span><br><span class="line"><span class="string">    upgrade: yes</span></span><br><span class="line"><span class="string">    autoremove: yes</span></span><br><span class="line"><span class="string">    purge: yes</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># NEW FILE: 06_configure_weekly_updates.yml</span></span><br><span class="line">    <span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt; roles/common_k8s_setup/tasks/06_configure_weekly_updates.yml</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">- name: Configure weekly apt update and upgrade cron job</span></span><br><span class="line"><span class="string">  ansible.builtin.cron:</span></span><br><span class="line"><span class="string">    name: &quot;weekly apt update and upgrade&quot;</span></span><br><span class="line"><span class="string">    weekday: &quot;0&quot; # Sunday</span></span><br><span class="line"><span class="string">    hour: &quot;3&quot;    # 3 AM</span></span><br><span class="line"><span class="string">    minute: &quot;0&quot;</span></span><br><span class="line"><span class="string">    job: &quot;/usr/bin/apt update &amp;&amp; /usr/bin/apt upgrade -y &amp;&amp; /usr/bin/apt autoremove -y &amp;&amp; /usr/bin/apt clean&quot;</span></span><br><span class="line"><span class="string">    user: root</span></span><br><span class="line"><span class="string">    state: present</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># Master and Worker roles are still created for structure, but not called by playbook.yml</span></span><br><span class="line">    <span class="built_in">mkdir</span> -p roles/k8s-master/tasks</span><br><span class="line">    <span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt; roles/k8s-master/tasks/main.yml</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">- name: This role is intentionally skipped by the main playbook for manual setup.</span></span><br><span class="line"><span class="string">  ansible.builtin.debug:</span></span><br><span class="line"><span class="string">    msg: &quot;This master role is not executed by default. Run &#x27;kubeadm init&#x27; manually on the master node.&quot;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">mkdir</span> -p roles/k8s-worker/tasks</span><br><span class="line">    <span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt; roles/k8s-worker/tasks/main.yml</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">- name: This role is intentionally skipped by the main playbook for manual setup.</span></span><br><span class="line"><span class="string">  ansible.builtin.debug:</span></span><br><span class="line"><span class="string">    msg: &quot;This worker role is not executed by default. Run &#x27;kubeadm join&#x27; manually on worker nodes.&quot;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Ansible roles and tasks created.&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- Main execution ---</span></span><br><span class="line">install_ansible</span><br><span class="line">create_project_dir</span><br><span class="line">create_ansible_cfg</span><br><span class="line">create_inventory</span><br><span class="line">create_playbook</span><br><span class="line">create_roles</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;--- Ansible setup for Kubernetes installation is complete! ---&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Navigate to the project directory:&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;cd <span class="variable">$&#123;PROJECT_DIR&#125;</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Then, run the Ansible playbook to install Kubernetes components on all nodes:&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;ansible-playbook playbook.yml -K&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;After the playbook finishes, you will need to manually initialize the Kubernetes cluster:&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;1. SSH into the master node (kube-node-1):&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;   ssh ubuntu@<span class="variable">$&#123;MASTER_NODE_IP&#125;</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;2. Initialize the Kubernetes control plane on the master node:&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;   sudo kubeadm init --control-plane-endpoint=kube-node-1 --pod-network-cidr=172.16.0.0/20 --service-cidr=172.16.32.0/20 --skip-phases=addon/kube-proxy --pod-infra-container-image=registry.k8s.io/pause:3.10&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;3. After &#x27;kubeadm init&#x27; completes, it will print instructions to set up kubectl and the &#x27;kubeadm join&#x27; command.&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;   Follow the instructions to set up kubectl for the &#x27;ubuntu&#x27; user:&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;   mkdir -p \$HOME/.kube&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;   sudo cp -i /etc/kubernetes/admin.conf \$HOME/.kube/config&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;   sudo chown \$(id -u):\$(id -g) \$HOME/.kube/config&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;4. Copy the &#x27;kubeadm join&#x27; command (including the token and discovery-token-ca-cert-hash) printed by &#x27;kubeadm init&#x27;.&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;   It will look something like: &#x27;kubeadm join &lt;master-ip&gt;:6443 --token &lt;token&gt; --discovery-token-ca-cert-hash sha256:&lt;hash&gt;&#x27;&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;5. SSH into each worker node (kube-node-2, kube-node-3) and run the join command:&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;   ssh ubuntu@<span class="variable">$&#123;WORKER_NODE_IP_1&#125;</span> (for kube-node-2)&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;   sudo &lt;PASTE_YOUR_KUBEADM_JOIN_COMMAND_HERE&gt;&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;   ssh ubuntu@<span class="variable">$&#123;WORKER_NODE_IP_2&#125;</span> (for kube-node-3)&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;   sudo &lt;PASTE_YOUR_KUBEADM_JOIN_COMMAND_HERE&gt;&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;6. Verify your cluster status from the master node:&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;   ssh ubuntu@<span class="variable">$&#123;MASTER_NODE_IP&#125;</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;   kubectl get nodes&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;   kubectl get pods --all-namespaces&quot;</span></span><br></pre></td></tr></table></figure>

<p>上述脚本执行完后，创建以下文档</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">root@ois:/home/ois/data/k8s/k8s_cluster_setup<span class="comment"># ls -R1</span></span><br><span class="line">.:</span><br><span class="line">ansible.cfg</span><br><span class="line">inventory.ini</span><br><span class="line">playbook.yml</span><br><span class="line">roles</span><br><span class="line"></span><br><span class="line">./roles:</span><br><span class="line">common_k8s_setup</span><br><span class="line">k8s-master</span><br><span class="line">k8s-worker</span><br><span class="line"></span><br><span class="line">./roles/common_k8s_setup:</span><br><span class="line">handlers</span><br><span class="line">tasks</span><br><span class="line"></span><br><span class="line">./roles/common_k8s_setup/handlers:</span><br><span class="line">main.yml</span><br><span class="line"></span><br><span class="line">./roles/common_k8s_setup/tasks:</span><br><span class="line">00_add_hosts_entries.yml</span><br><span class="line">01_disable_swap.yml</span><br><span class="line">02_containerd_setup.yml</span><br><span class="line">03_kernel_modules_sysctl.yml</span><br><span class="line">04_kube_repo_install_hold.yml</span><br><span class="line">05_initial_upgrade.yml</span><br><span class="line">06_configure_weekly_updates.yml</span><br><span class="line">main.yml</span><br><span class="line"></span><br><span class="line">./roles/k8s-master:</span><br><span class="line">tasks</span><br><span class="line"></span><br><span class="line">./roles/k8s-master/tasks:</span><br><span class="line">main.yml</span><br><span class="line"></span><br><span class="line">./roles/k8s-worker:</span><br><span class="line">tasks</span><br><span class="line"></span><br><span class="line">./roles/k8s-worker/tasks:</span><br><span class="line">main.yml</span><br></pre></td></tr></table></figure>

<h2 id="2-2-执行过程"><a href="#2-2-执行过程" class="headerlink" title="2.2 执行过程"></a>2.2 执行过程</h2><p>在执行前，需要让.ssh&#x2F;known_hosts 文件保存这些主机的SSH Key。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># This script prepares the Ansible control node by adding the SSH host keys</span></span><br><span class="line"><span class="comment"># of the target nodes to the ~/.ssh/known_hosts file.</span></span><br><span class="line"><span class="comment"># It first removes any outdated keys for the specified hosts before scanning</span></span><br><span class="line"><span class="comment"># for the new ones, preventing &quot;REMOTE HOST IDENTIFICATION HAS CHANGED&quot; errors.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- Configuration ---</span></span><br><span class="line"><span class="comment"># List of hosts (IPs or FQDNs) to scan.</span></span><br><span class="line"><span class="comment"># These should be the same hosts you have in your Ansible inventory.</span></span><br><span class="line">HOSTS=(</span><br><span class="line">    <span class="string">&quot;10.75.59.71&quot;</span></span><br><span class="line">    <span class="string">&quot;10.75.59.72&quot;</span></span><br><span class="line">    <span class="string">&quot;10.75.59.73&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># The location of your known_hosts file.</span></span><br><span class="line">KNOWN_HOSTS_FILE=~/.ssh/known_hosts</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- Main Logic ---</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Starting SSH host key scan to update <span class="variable">$&#123;KNOWN_HOSTS_FILE&#125;</span>...&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Ensure the .ssh directory exists with the correct permissions.</span></span><br><span class="line"><span class="built_in">mkdir</span> -p ~/.ssh</span><br><span class="line"><span class="built_in">chmod</span> 700 ~/.ssh</span><br><span class="line"></span><br><span class="line"><span class="comment"># Loop through each host defined in the HOSTS array.</span></span><br><span class="line"><span class="keyword">for</span> host <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$&#123;HOSTS[@]&#125;</span>&quot;</span>; <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;--- Processing host: <span class="variable">$&#123;host&#125;</span> ---&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 1. Remove the old host key (if it exists).</span></span><br><span class="line">    <span class="comment"># This is the key step to ensure we replace outdated entries.</span></span><br><span class="line">    <span class="comment"># The command is silent if no key is found.</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Step 1: Removing any old key for <span class="variable">$&#123;host&#125;</span>...&quot;</span></span><br><span class="line">    ssh-keygen -R <span class="string">&quot;<span class="variable">$&#123;host&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 2. Scan for the new host key and append it.</span></span><br><span class="line">    <span class="comment"># The -H flag hashes the hostname, which is a security best practice.</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Step 2: Scanning for new key and adding it to known_hosts...&quot;</span></span><br><span class="line">    ssh-keyscan -H <span class="string">&quot;<span class="variable">$&#123;host&#125;</span>&quot;</span> &gt;&gt; <span class="string">&quot;<span class="variable">$&#123;KNOWN_HOSTS_FILE&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Successfully updated key for <span class="variable">$&#123;host&#125;</span>.&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Set the correct permissions for the known_hosts file, as SSH is strict about this.</span></span><br><span class="line"><span class="built_in">chmod</span> 600 <span class="string">&quot;<span class="variable">$&#123;KNOWN_HOSTS_FILE&#125;</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;✅ All hosts have been scanned and keys have been updated.&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;You can now run your Ansible playbook without host key verification prompts.&quot;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> +x ansible-k8s-v2.sh </span><br><span class="line">ois@ois:~/data/k8s$ ./ansible-k8s-v2.sh </span><br><span class="line">--- Installing Ansible ---</span><br><span class="line">Ansible is already installed.</span><br><span class="line">--- Creating project directory: k8s_cluster_setup ---</span><br><span class="line">Changed to directory: /home/ois/data/k8s/k8s_cluster_setup</span><br><span class="line">--- Creating ansible.cfg ---</span><br><span class="line">ansible.cfg created.</span><br><span class="line">--- Creating inventory.ini ---</span><br><span class="line">inventory.ini created.</span><br><span class="line">--- Creating playbook.yml ---</span><br><span class="line">playbook.yml created (only common setup included).</span><br><span class="line">--- Creating Ansible roles and tasks ---</span><br><span class="line">Ansible roles and tasks created.</span><br><span class="line"></span><br><span class="line">--- Ansible setup <span class="keyword">for</span> Kubernetes installation is complete! ---</span><br><span class="line">Navigate to the project directory:</span><br><span class="line"><span class="built_in">cd</span> k8s_cluster_setup</span><br><span class="line"></span><br><span class="line">Then, run the Ansible playbook to install Kubernetes components on all nodes:</span><br><span class="line">ansible-playbook playbook.yml -K</span><br><span class="line"></span><br><span class="line">After the playbook finishes, you will need to manually initialize the Kubernetes cluster:</span><br><span class="line">1. SSH into the master node (kube-node-1):</span><br><span class="line">   ssh ubuntu@10.75.59.71</span><br><span class="line"></span><br><span class="line">2. Initialize the Kubernetes control plane on the master node:</span><br><span class="line">   sudo kubeadm init --control-plane-endpoint=kube-node-1 --pod-network-cidr=172.16.0.0/20 --service-cidr=172.16.32.0/20 --skip-phases=addon/kube-proxy --pod-infra-container-image=registry.k8s.io/pause:3.10</span><br><span class="line"></span><br><span class="line">3. After <span class="string">&#x27;kubeadm init&#x27;</span> completes, it will <span class="built_in">print</span> instructions to <span class="built_in">set</span> up kubectl and the <span class="string">&#x27;kubeadm join&#x27;</span> <span class="built_in">command</span>.</span><br><span class="line">   Follow the instructions to <span class="built_in">set</span> up kubectl <span class="keyword">for</span> the <span class="string">&#x27;ubuntu&#x27;</span> user:</span><br><span class="line">   <span class="built_in">mkdir</span> -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">   sudo <span class="built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">   sudo <span class="built_in">chown</span> $(<span class="built_in">id</span> -u):$(<span class="built_in">id</span> -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line"></span><br><span class="line">4. Copy the <span class="string">&#x27;kubeadm join&#x27;</span> <span class="built_in">command</span> (including the token and discovery-token-ca-cert-hash) printed by <span class="string">&#x27;kubeadm init&#x27;</span>.</span><br><span class="line">   It will look something like: <span class="string">&#x27;kubeadm join &lt;master-ip&gt;:6443 --token &lt;token&gt; --discovery-token-ca-cert-hash sha256:&lt;hash&gt;&#x27;</span></span><br><span class="line"></span><br><span class="line">5. SSH into each worker node (kube-node-2, kube-node-3) and run the <span class="built_in">join</span> <span class="built_in">command</span>:</span><br><span class="line">   ssh ubuntu@10.75.59.72 (<span class="keyword">for</span> kube-node-2)</span><br><span class="line">   sudo &lt;PASTE_YOUR_KUBEADM_JOIN_COMMAND_HERE&gt;</span><br><span class="line"></span><br><span class="line">   ssh ubuntu@10.75.59.73 (<span class="keyword">for</span> kube-node-3)</span><br><span class="line">   sudo &lt;PASTE_YOUR_KUBEADM_JOIN_COMMAND_HERE&gt;</span><br><span class="line"></span><br><span class="line">6. Verify your cluster status from the master node:</span><br><span class="line">   ssh ubuntu@10.75.59.71</span><br><span class="line">   kubectl get nodes</span><br><span class="line">   kubectl get pods --all-namespaces</span><br><span class="line">ois@ois:~/data/k8s$ <span class="built_in">cd</span> k8s_cluster_setup/</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br></pre></td><td class="code"><pre><span class="line">ois@ois:~/data/k8s/k8s_cluster_setup$ ansible-playbook playbook.yml -K</span><br><span class="line">BECOME password: </span><br><span class="line"></span><br><span class="line">PLAY [Common Kubernetes Setup <span class="keyword">for</span> all nodes] *******************************************************************************************************************************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] *****************************************************************************************************************************************************************************************************************************************</span><br><span class="line">ok: [kube-node-1]</span><br><span class="line">ok: [kube-node-2]</span><br><span class="line">ok: [kube-node-3]</span><br><span class="line"></span><br><span class="line">TASK [common_k8s_setup : Include add hosts entries task] *******************************************************************************************************************************************************************************************************</span><br><span class="line">included: /home/ois/data/k8s/k8s_cluster_setup/roles/common_k8s_setup/tasks/00_add_hosts_entries.yml <span class="keyword">for</span> kube-node-1, kube-node-2, kube-node-3</span><br><span class="line"></span><br><span class="line">TASK [common_k8s_setup : Add all inventory hosts to /etc/hosts on each node] ***********************************************************************************************************************************************************************************</span><br><span class="line">changed: [kube-node-2] =&gt; (item=kube-node-1)</span><br><span class="line">changed: [kube-node-1] =&gt; (item=kube-node-1)</span><br><span class="line">changed: [kube-node-3] =&gt; (item=kube-node-1)</span><br><span class="line">changed: [kube-node-1] =&gt; (item=kube-node-2)</span><br><span class="line">changed: [kube-node-2] =&gt; (item=kube-node-2)</span><br><span class="line">changed: [kube-node-3] =&gt; (item=kube-node-2)</span><br><span class="line">changed: [kube-node-2] =&gt; (item=kube-node-3)</span><br><span class="line">changed: [kube-node-1] =&gt; (item=kube-node-3)</span><br><span class="line">changed: [kube-node-3] =&gt; (item=kube-node-3)</span><br><span class="line"></span><br><span class="line">TASK [common_k8s_setup : Include <span class="built_in">disable</span> swap task] ************************************************************************************************************************************************************************************************************</span><br><span class="line">included: /home/ois/data/k8s/k8s_cluster_setup/roles/common_k8s_setup/tasks/01_disable_swap.yml <span class="keyword">for</span> kube-node-1, kube-node-2, kube-node-3</span><br><span class="line"></span><br><span class="line">TASK [common_k8s_setup : Check <span class="keyword">if</span> swap is active] **************************************************************************************************************************************************************************************************************</span><br><span class="line">ok: [kube-node-2]</span><br><span class="line">ok: [kube-node-1]</span><br><span class="line">ok: [kube-node-3]</span><br><span class="line"></span><br><span class="line">TASK [common_k8s_setup : Disable swap] *************************************************************************************************************************************************************************************************************************</span><br><span class="line">changed: [kube-node-1]</span><br><span class="line">changed: [kube-node-2]</span><br><span class="line">changed: [kube-node-3]</span><br><span class="line"></span><br><span class="line">TASK [common_k8s_setup : Persistently <span class="built_in">disable</span> swap (comment out swapfile <span class="keyword">in</span> fstab)] ****************************************************************************************************************************************************************************</span><br><span class="line">ok: [kube-node-2]</span><br><span class="line">ok: [kube-node-3]</span><br><span class="line">ok: [kube-node-1]</span><br><span class="line"></span><br><span class="line">TASK [common_k8s_setup : Include containerd setup task] ********************************************************************************************************************************************************************************************************</span><br><span class="line">included: /home/ois/data/k8s/k8s_cluster_setup/roles/common_k8s_setup/tasks/02_containerd_setup.yml <span class="keyword">for</span> kube-node-1, kube-node-2, kube-node-3</span><br><span class="line"></span><br><span class="line">TASK [common_k8s_setup : Install required packages <span class="keyword">for</span> Containerd] *********************************************************************************************************************************************************************************************</span><br><span class="line">changed: [kube-node-2]</span><br><span class="line">changed: [kube-node-1]</span><br><span class="line">changed: [kube-node-3]</span><br><span class="line"></span><br><span class="line">TASK [common_k8s_setup : Add Docker GPG key] *******************************************************************************************************************************************************************************************************************</span><br><span class="line">changed: [kube-node-1]</span><br><span class="line">changed: [kube-node-2]</span><br><span class="line">changed: [kube-node-3]</span><br><span class="line"></span><br><span class="line">TASK [common_k8s_setup : Add Docker APT repository] ************************************************************************************************************************************************************************************************************</span><br><span class="line">changed: [kube-node-2]</span><br><span class="line">changed: [kube-node-1]</span><br><span class="line">changed: [kube-node-3]</span><br><span class="line"></span><br><span class="line">TASK [common_k8s_setup : Install Containerd] *******************************************************************************************************************************************************************************************************************</span><br><span class="line">changed: [kube-node-3]</span><br><span class="line">changed: [kube-node-1]</span><br><span class="line">changed: [kube-node-2]</span><br><span class="line"></span><br><span class="line">TASK [common_k8s_setup : Create containerd configuration directory] ********************************************************************************************************************************************************************************************</span><br><span class="line">ok: [kube-node-2]</span><br><span class="line">ok: [kube-node-3]</span><br><span class="line">ok: [kube-node-1]</span><br><span class="line"></span><br><span class="line">TASK [common_k8s_setup : Generate default containerd configuration directly to final path] *********************************************************************************************************************************************************************</span><br><span class="line">changed: [kube-node-1]</span><br><span class="line">changed: [kube-node-3]</span><br><span class="line">changed: [kube-node-2]</span><br><span class="line"></span><br><span class="line">TASK [common_k8s_setup : Ensure CRI plugin is enabled (remove any disabled_plugins line containing <span class="string">&quot;cri&quot;</span>)] *****************************************************************************************************************************************************</span><br><span class="line">ok: [kube-node-1]</span><br><span class="line">ok: [kube-node-2]</span><br><span class="line">ok: [kube-node-3]</span><br><span class="line"></span><br><span class="line">TASK [common_k8s_setup : Remove top-level systemd_cgroup from CRI plugin section] ******************************************************************************************************************************************************************************</span><br><span class="line">changed: [kube-node-1]</span><br><span class="line">changed: [kube-node-2]</span><br><span class="line">changed: [kube-node-3]</span><br><span class="line"></span><br><span class="line">TASK [common_k8s_setup : Remove old runtime_root from runc runtime section] ************************************************************************************************************************************************************************************</span><br><span class="line">changed: [kube-node-1]</span><br><span class="line">changed: [kube-node-3]</span><br><span class="line">changed: [kube-node-2]</span><br><span class="line"></span><br><span class="line">TASK [common_k8s_setup : Configure runc runtime to use SystemdCgroup = <span class="literal">true</span>] ***********************************************************************************************************************************************************************************</span><br><span class="line">changed: [kube-node-1]</span><br><span class="line">changed: [kube-node-2]</span><br><span class="line">changed: [kube-node-3]</span><br><span class="line"></span><br><span class="line">TASK [common_k8s_setup : Add Root path to runc options] ********************************************************************************************************************************************************************************************************</span><br><span class="line">changed: [kube-node-1]</span><br><span class="line">changed: [kube-node-3]</span><br><span class="line">changed: [kube-node-2]</span><br><span class="line"></span><br><span class="line">TASK [common_k8s_setup : Update sandbox_image to pause:3.10] ***************************************************************************************************************************************************************************************************</span><br><span class="line">changed: [kube-node-1]</span><br><span class="line">changed: [kube-node-2]</span><br><span class="line">changed: [kube-node-3]</span><br><span class="line"></span><br><span class="line">TASK [common_k8s_setup : Include kernel modules and sysctl task] ***********************************************************************************************************************************************************************************************</span><br><span class="line">included: /home/ois/data/k8s/k8s_cluster_setup/roles/common_k8s_setup/tasks/03_kernel_modules_sysctl.yml <span class="keyword">for</span> kube-node-1, kube-node-2, kube-node-3</span><br><span class="line"></span><br><span class="line">TASK [common_k8s_setup : Load overlay module] ******************************************************************************************************************************************************************************************************************</span><br><span class="line">ok: [kube-node-1]</span><br><span class="line">ok: [kube-node-2]</span><br><span class="line">ok: [kube-node-3]</span><br><span class="line"></span><br><span class="line">TASK [common_k8s_setup : Load br_netfilter module] *************************************************************************************************************************************************************************************************************</span><br><span class="line">ok: [kube-node-1]</span><br><span class="line">ok: [kube-node-2]</span><br><span class="line">ok: [kube-node-3]</span><br><span class="line"></span><br><span class="line">TASK [common_k8s_setup : Add modules to /etc/modules-load.d/k8s.conf] ******************************************************************************************************************************************************************************************</span><br><span class="line">changed: [kube-node-1]</span><br><span class="line">changed: [kube-node-2]</span><br><span class="line">changed: [kube-node-3]</span><br><span class="line"></span><br><span class="line">TASK [common_k8s_setup : Configure sysctl parameters <span class="keyword">for</span> Kubernetes networking] ********************************************************************************************************************************************************************************</span><br><span class="line">changed: [kube-node-1]</span><br><span class="line">changed: [kube-node-2]</span><br><span class="line">changed: [kube-node-3]</span><br><span class="line"></span><br><span class="line">TASK [common_k8s_setup : Apply sysctl parameters] **************************************************************************************************************************************************************************************************************</span><br><span class="line">ok: [kube-node-1]</span><br><span class="line">ok: [kube-node-2]</span><br><span class="line">ok: [kube-node-3]</span><br><span class="line"></span><br><span class="line">TASK [common_k8s_setup : Include kube repo, install, and hold task] ********************************************************************************************************************************************************************************************</span><br><span class="line">included: /home/ois/data/k8s/k8s_cluster_setup/roles/common_k8s_setup/tasks/04_kube_repo_install_hold.yml <span class="keyword">for</span> kube-node-1, kube-node-2, kube-node-3</span><br><span class="line"></span><br><span class="line">TASK [common_k8s_setup : Create Kubernetes apt keyring directory] **********************************************************************************************************************************************************************************************</span><br><span class="line">ok: [kube-node-1]</span><br><span class="line">ok: [kube-node-2]</span><br><span class="line">ok: [kube-node-3]</span><br><span class="line"></span><br><span class="line">TASK [common_k8s_setup : Download Kubernetes GPG key and dearmor] **********************************************************************************************************************************************************************************************</span><br><span class="line">ok: [kube-node-2]</span><br><span class="line">ok: [kube-node-1]</span><br><span class="line">ok: [kube-node-3]</span><br><span class="line"></span><br><span class="line">TASK [common_k8s_setup : Add Kubernetes APT repository <span class="built_in">source</span> list] ********************************************************************************************************************************************************************************************</span><br><span class="line">changed: [kube-node-2]</span><br><span class="line">changed: [kube-node-3]</span><br><span class="line">changed: [kube-node-1]</span><br><span class="line"></span><br><span class="line">TASK [common_k8s_setup : Update apt cache after adding Kubernetes repo] ****************************************************************************************************************************************************************************************</span><br><span class="line">changed: [kube-node-2]</span><br><span class="line">changed: [kube-node-1]</span><br><span class="line">changed: [kube-node-3]</span><br><span class="line"></span><br><span class="line">TASK [common_k8s_setup : Install kubelet, kubeadm, kubectl] ****************************************************************************************************************************************************************************************************</span><br><span class="line">changed: [kube-node-3]</span><br><span class="line">changed: [kube-node-2]</span><br><span class="line">changed: [kube-node-1]</span><br><span class="line"></span><br><span class="line">TASK [common_k8s_setup : Hold kubelet, kubeadm, kubectl packages] **********************************************************************************************************************************************************************************************</span><br><span class="line">changed: [kube-node-1] =&gt; (item=kubelet)</span><br><span class="line">changed: [kube-node-3] =&gt; (item=kubelet)</span><br><span class="line">changed: [kube-node-2] =&gt; (item=kubelet)</span><br><span class="line">changed: [kube-node-3] =&gt; (item=kubeadm)</span><br><span class="line">changed: [kube-node-1] =&gt; (item=kubeadm)</span><br><span class="line">changed: [kube-node-2] =&gt; (item=kubeadm)</span><br><span class="line">changed: [kube-node-3] =&gt; (item=kubectl)</span><br><span class="line">changed: [kube-node-1] =&gt; (item=kubectl)</span><br><span class="line">changed: [kube-node-2] =&gt; (item=kubectl)</span><br><span class="line"></span><br><span class="line">TASK [common_k8s_setup : Enable and start kubelet service] *****************************************************************************************************************************************************************************************************</span><br><span class="line">changed: [kube-node-3]</span><br><span class="line">changed: [kube-node-2]</span><br><span class="line">changed: [kube-node-1]</span><br><span class="line"></span><br><span class="line">TASK [common_k8s_setup : Include initial apt upgrade task] *****************************************************************************************************************************************************************************************************</span><br><span class="line">included: /home/ois/data/k8s/k8s_cluster_setup/roles/common_k8s_setup/tasks/05_initial_upgrade.yml <span class="keyword">for</span> kube-node-1, kube-node-2, kube-node-3</span><br><span class="line"></span><br><span class="line">TASK [common_k8s_setup : Perform initial apt update and upgrade] ***********************************************************************************************************************************************************************************************</span><br><span class="line">changed: [kube-node-3]</span><br><span class="line">changed: [kube-node-2]</span><br><span class="line">changed: [kube-node-1]</span><br><span class="line"></span><br><span class="line">TASK [common_k8s_setup : Include configure weekly updates task] ************************************************************************************************************************************************************************************************</span><br><span class="line">included: /home/ois/data/k8s/k8s_cluster_setup/roles/common_k8s_setup/tasks/06_configure_weekly_updates.yml <span class="keyword">for</span> kube-node-1, kube-node-2, kube-node-3</span><br><span class="line"></span><br><span class="line">TASK [common_k8s_setup : Configure weekly apt update and upgrade cron job] *************************************************************************************************************************************************************************************</span><br><span class="line">changed: [kube-node-1]</span><br><span class="line">changed: [kube-node-2]</span><br><span class="line">changed: [kube-node-3]</span><br><span class="line"></span><br><span class="line">RUNNING HANDLER [common_k8s_setup : Restart containerd service] ************************************************************************************************************************************************************************************************</span><br><span class="line">changed: [kube-node-2]</span><br><span class="line">changed: [kube-node-1]</span><br><span class="line">changed: [kube-node-3]</span><br><span class="line"></span><br><span class="line">PLAY RECAP *****************************************************************************************************************************************************************************************************************************************************</span><br><span class="line">kube-node-1                : ok=39   changed=22   unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line">kube-node-2                : ok=39   changed=22   unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line">kube-node-3                : ok=39   changed=22   unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br></pre></td></tr></table></figure>

<h1 id="3-设置本地DNS和BGP"><a href="#3-设置本地DNS和BGP" class="headerlink" title="3. 设置本地DNS和BGP"></a>3. 设置本地DNS和BGP</h1><p>设置一个本地DNS和BGP服务器用于测试。</p>
<h2 id="3-1-create-dns-sh"><a href="#3-1-create-dns-sh" class="headerlink" title="3.1 create-dns.sh"></a>3.1 create-dns.sh</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- Configuration ---</span></span><br><span class="line">BASE_IMAGE_PATH=<span class="string">&quot;/home/ois/data/vmimages/noble-server-cloudimg-amd64.img&quot;</span></span><br><span class="line">VM_IMAGE_DIR=<span class="string">&quot;/home/ois/data/k8s/nodevms&quot;</span></span><br><span class="line">VM_CONFIG_DIR=<span class="string">&quot;/home/ois/data/k8s/nodevm_cfg&quot;</span></span><br><span class="line">RAM_MB=8192</span><br><span class="line">VCPUS=4</span><br><span class="line">DISK_SIZE_GB=20</span><br><span class="line">BRIDGE_INTERFACE=<span class="string">&quot;br0&quot;</span></span><br><span class="line"><span class="comment"># Specific IP for the single VM</span></span><br><span class="line">VM_IP=<span class="string">&quot;10.75.59.76&quot;</span></span><br><span class="line">NETWORK_PREFIX=<span class="string">&quot;/24&quot;</span></span><br><span class="line">GATEWAY=<span class="string">&quot;10.75.59.1&quot;</span></span><br><span class="line"><span class="comment"># DNS servers for the VM&#x27;s initial resolution (for internet access)</span></span><br><span class="line">VM_NAMESERVER1=<span class="string">&quot;64.104.76.247&quot;</span></span><br><span class="line">VM_NAMESERVER2=<span class="string">&quot;64.104.14.184&quot;</span></span><br><span class="line">SEARCH_DOMAIN=<span class="string">&quot;cisco.com&quot;</span></span><br><span class="line">VNC_PORT=5909 <span class="comment"># Fixed VNC port for the single VM</span></span><br><span class="line">PASSWORD_HASH=<span class="string">&#x27;$6$rounds=4096$LDu9pXXXXXXXXXXXXXXOh/Iunw372/TVfst1&#x27;</span></span><br><span class="line">SSH_PUB_KEY=$(<span class="built_in">cat</span> ~/.ssh/id_rsa.pub)</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- VM Details ---</span></span><br><span class="line">VM_NAME=<span class="string">&quot;dns-server-vm&quot;</span></span><br><span class="line">VM_IMAGE_PATH=<span class="string">&quot;<span class="variable">$&#123;VM_IMAGE_DIR&#125;</span>/<span class="variable">$&#123;VM_NAME&#125;</span>.qcow2&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;--- Preparing for <span class="variable">$VM_NAME</span> (IP: <span class="variable">$VM_IP</span>) ---&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Create directories if they don&#x27;t exist</span></span><br><span class="line"><span class="built_in">mkdir</span> -p <span class="string">&quot;<span class="variable">$VM_IMAGE_DIR</span>&quot;</span></span><br><span class="line"><span class="built_in">mkdir</span> -p <span class="string">&quot;<span class="variable">$VM_CONFIG_DIR</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Create a fresh image for the VM</span></span><br><span class="line"><span class="keyword">if</span> [ -f <span class="string">&quot;<span class="variable">$VM_IMAGE_PATH</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Removing existing image for <span class="variable">$VM_NAME</span>...&quot;</span></span><br><span class="line">    <span class="built_in">rm</span> <span class="string">&quot;<span class="variable">$VM_IMAGE_PATH</span>&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Copying base image to <span class="variable">$VM_IMAGE_PATH</span>...&quot;</span></span><br><span class="line"><span class="built_in">cp</span> <span class="string">&quot;<span class="variable">$BASE_IMAGE_PATH</span>&quot;</span> <span class="string">&quot;<span class="variable">$VM_IMAGE_PATH</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Resize the copied image before virt-install</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Resizing VM image to <span class="variable">$&#123;DISK_SIZE_GB&#125;</span>GB...&quot;</span></span><br><span class="line">qemu-img resize <span class="string">&quot;<span class="variable">$VM_IMAGE_PATH</span>&quot;</span> <span class="string">&quot;<span class="variable">$&#123;DISK_SIZE_GB&#125;</span>G&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Generate user-data for the VM (installing dnsmasq, no UFW, no dnsmasq config here)</span></span><br><span class="line">USER_DATA_FILE=<span class="string">&quot;<span class="variable">$&#123;VM_CONFIG_DIR&#125;</span>/<span class="variable">$&#123;VM_NAME&#125;</span>_user-data&quot;</span></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt; &quot;$USER_DATA_FILE&quot;</span></span><br><span class="line"><span class="string">#cloud-config</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">locale: en_US</span></span><br><span class="line"><span class="string">keyboard:</span></span><br><span class="line"><span class="string">  layout: us</span></span><br><span class="line"><span class="string">timezone: Asia/Tokyo</span></span><br><span class="line"><span class="string">hostname: $&#123;VM_NAME&#125;</span></span><br><span class="line"><span class="string">create_hostname_file: true</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">ssh_pwauth: yes</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">groups:</span></span><br><span class="line"><span class="string">  - ubuntu</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">users:</span></span><br><span class="line"><span class="string">  - name: ubuntu</span></span><br><span class="line"><span class="string">    gecos: ubuntu</span></span><br><span class="line"><span class="string">    primary_group: ubuntu</span></span><br><span class="line"><span class="string">    groups: sudo, cdrom</span></span><br><span class="line"><span class="string">    sudo: ALL=(ALL:ALL) ALL</span></span><br><span class="line"><span class="string">    shell: /bin/bash</span></span><br><span class="line"><span class="string">    lock_passwd: false</span></span><br><span class="line"><span class="string">    passwd: $&#123;PASSWORD_HASH&#125;</span></span><br><span class="line"><span class="string">    ssh_authorized_keys:</span></span><br><span class="line"><span class="string">      - &quot;$&#123;SSH_PUB_KEY&#125;&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">apt:</span></span><br><span class="line"><span class="string">  primary:</span></span><br><span class="line"><span class="string">    - arches: [default]</span></span><br><span class="line"><span class="string">      uri: http://us.archive.ubuntu.com/ubuntu/</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">packages:</span></span><br><span class="line"><span class="string">  - openssh-server</span></span><br><span class="line"><span class="string">  - net-tools</span></span><br><span class="line"><span class="string">  - iftop</span></span><br><span class="line"><span class="string">  - htop</span></span><br><span class="line"><span class="string">  - iperf3</span></span><br><span class="line"><span class="string">  - vim</span></span><br><span class="line"><span class="string">  - curl</span></span><br><span class="line"><span class="string">  - wget</span></span><br><span class="line"><span class="string">  - cloud-guest-utils # Ensure growpart is available</span></span><br><span class="line"><span class="string">  - dnsmasq # Install dnsmasq for DNS server functionality</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">ntp:</span></span><br><span class="line"><span class="string">  servers: [&#x27;ntp.esl.cisco.com&#x27;]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">runcmd:</span></span><br><span class="line"><span class="string">  - echo &quot;Attempting to resize root partition and filesystem...&quot;</span></span><br><span class="line"><span class="string">  - growpart /dev/vda 1 # Expand the first partition on /dev/vda</span></span><br><span class="line"><span class="string">  - resize2fs /dev/vda1 # Expand the ext4 filesystem on /dev/vda1</span></span><br><span class="line"><span class="string">  - echo &quot;Disk resize commands executed. Verify with &#x27;df -h&#x27; after boot.&quot;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Generate network-config for the VM (pointing to external DNS for initial connectivity)</span></span><br><span class="line">NETWORK_CONFIG_FILE=<span class="string">&quot;<span class="variable">$&#123;VM_CONFIG_DIR&#125;</span>/<span class="variable">$&#123;VM_NAME&#125;</span>_network-config&quot;</span></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt; &quot;$NETWORK_CONFIG_FILE&quot;</span></span><br><span class="line"><span class="string">network:</span></span><br><span class="line"><span class="string">  version: 2</span></span><br><span class="line"><span class="string">  ethernets:</span></span><br><span class="line"><span class="string">    enp1s0:</span></span><br><span class="line"><span class="string">      addresses:</span></span><br><span class="line"><span class="string">      - &quot;$&#123;VM_IP&#125;$&#123;NETWORK_PREFIX&#125;&quot;</span></span><br><span class="line"><span class="string">      nameservers:</span></span><br><span class="line"><span class="string">        addresses:</span></span><br><span class="line"><span class="string">        - $&#123;VM_NAMESERVER1&#125; # Point VM to external DNS for initial internet access</span></span><br><span class="line"><span class="string">        - $&#123;VM_NAMESERVER2&#125;</span></span><br><span class="line"><span class="string">        search:</span></span><br><span class="line"><span class="string">        - $&#123;SEARCH_DOMAIN&#125;</span></span><br><span class="line"><span class="string">      routes:</span></span><br><span class="line"><span class="string">      - to: &quot;default&quot;</span></span><br><span class="line"><span class="string">        via: &quot;$&#123;GATEWAY&#125;&quot;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Generate meta-data</span></span><br><span class="line">META_DATA_FILE=<span class="string">&quot;<span class="variable">$&#123;VM_CONFIG_DIR&#125;</span>/<span class="variable">$&#123;VM_NAME&#125;</span>_meta-data&quot;</span></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt; &quot;$META_DATA_FILE&quot;</span></span><br><span class="line"><span class="string">instance-id: $&#123;VM_NAME&#125;</span></span><br><span class="line"><span class="string">local-hostname: $&#123;VM_NAME&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;--- Installing <span class="variable">$VM_NAME</span> ---&quot;</span></span><br><span class="line">virt-install --name <span class="string">&quot;<span class="variable">$&#123;VM_NAME&#125;</span>&quot;</span> --ram <span class="string">&quot;<span class="variable">$&#123;RAM_MB&#125;</span>&quot;</span> --vcpus <span class="string">&quot;<span class="variable">$&#123;VCPUS&#125;</span>&quot;</span> --noreboot \</span><br><span class="line">    --os-variant ubuntu24.04 \</span><br><span class="line">    --network bridge=<span class="string">&quot;<span class="variable">$&#123;BRIDGE_INTERFACE&#125;</span>&quot;</span> \</span><br><span class="line">    --graphics vnc,listen=0.0.0.0,port=<span class="string">&quot;<span class="variable">$&#123;VNC_PORT&#125;</span>&quot;</span> \</span><br><span class="line">    --disk path=<span class="string">&quot;<span class="variable">$&#123;VM_IMAGE_PATH&#125;</span>&quot;</span>,format=qcow2 \</span><br><span class="line">    --console pty,target_type=serial \</span><br><span class="line">    --cloud-init user-data=<span class="string">&quot;<span class="variable">$&#123;USER_DATA_FILE&#125;</span>&quot;</span>,meta-data=<span class="string">&quot;<span class="variable">$&#123;META_DATA_FILE&#125;</span>&quot;</span>,network-config=<span class="string">&quot;<span class="variable">$&#123;NETWORK_CONFIG_FILE&#125;</span>&quot;</span> \</span><br><span class="line">    --import \</span><br><span class="line">    --<span class="built_in">wait</span> 0</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Successfully initiated creation of <span class="variable">$VM_NAME</span>.&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;You can connect to VNC on port <span class="variable">$&#123;VNC_PORT&#125;</span> to monitor installation (optional).&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Wait a few minutes for the VM to boot and cloud-init to run.&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;--------------------------------------------------------&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;The DNS server VM has been initiated. Please wait for it to fully provision.&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;You can SSH into it using &#x27;ssh ubuntu@<span class="variable">$&#123;VM_IP&#125;</span>&#x27;.&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Once provisioned, proceed to use the &#x27;setup-dnsmasq-ansible.sh&#x27; script to configure DNS using Ansible.&quot;</span></span><br><span class="line"></span><br><span class="line">ois@ois:~/data/k8s$ ./create-dns.sh </span><br><span class="line">--- Preparing <span class="keyword">for</span> dns-server-vm (IP: 10.75.59.76) ---</span><br><span class="line">Copying base image to /home/ois/data/k8s/nodevms/dns-server-vm.qcow2...</span><br><span class="line">Resizing VM image to 20GB...</span><br><span class="line">Image resized.</span><br><span class="line">--- Installing dns-server-vm ---</span><br><span class="line">WARNING  Treating --<span class="built_in">wait</span> 0 as --noautoconsole</span><br><span class="line"></span><br><span class="line">Starting install...</span><br><span class="line">Allocating <span class="string">&#x27;virtinst-y1pxxrj5-cloudinit.iso&#x27;</span>                                                                                                                                                                                             |    0 B  00:00:00 ... </span><br><span class="line">Transferring <span class="string">&#x27;virtinst-y1pxxrj5-cloudinit.iso&#x27;</span>                                                                                                                                                                                           |    0 B  00:00:00 ... </span><br><span class="line">Creating domain...                                                                                                                                                                                                                       |    0 B  00:00:00     </span><br><span class="line">Domain creation completed.</span><br><span class="line">Successfully initiated creation of dns-server-vm.</span><br><span class="line">You can connect to VNC on port 5909 to monitor installation (optional).</span><br><span class="line">Wait a few minutes <span class="keyword">for</span> the VM to boot and cloud-init to run.</span><br><span class="line">--------------------------------------------------------</span><br><span class="line">The DNS server VM has been initiated. Please <span class="built_in">wait</span> <span class="keyword">for</span> it to fully provision.</span><br><span class="line">You can SSH into it using <span class="string">&#x27;ssh ubuntu@10.75.59.76&#x27;</span>.</span><br><span class="line">Once provisioned, you can <span class="built_in">test</span> the DNS forwarding by configuring another machine to use 10.75.59.76 as its DNS server and performing a DNS query.</span><br></pre></td></tr></table></figure>

<h2 id="3-2-使用Ansible设置dnsmasq"><a href="#3-2-使用Ansible设置dnsmasq" class="headerlink" title="3.2 使用Ansible设置dnsmasq"></a>3.2 使用Ansible设置dnsmasq</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- Configuration for Ansible and DNSmasq ---</span></span><br><span class="line">VM_IP=<span class="string">&quot;10.75.59.76&quot;</span></span><br><span class="line">SSH_USER=<span class="string">&quot;ubuntu&quot;</span></span><br><span class="line">SSH_PRIVATE_KEY_PATH=<span class="string">&quot;~/.ssh/id_rsa&quot;</span> <span class="comment"># Ensure this path is correct for your setup</span></span><br><span class="line">FORWARD_NAMESERVER1=<span class="string">&quot;64.104.76.247&quot;</span></span><br><span class="line">FORWARD_NAMESERVER2=<span class="string">&quot;64.104.14.184&quot;</span></span><br><span class="line">SEARCH_DOMAIN=<span class="string">&quot;cisco.com&quot;</span></span><br><span class="line">ANSIBLE_DIR=<span class="string">&quot;ansible_dnsmasq_setup&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;--- Setting up Ansible environment and configuring DNSmasq on <span class="variable">$&#123;VM_IP&#125;</span> ---&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Create a directory for Ansible files</span></span><br><span class="line"><span class="built_in">mkdir</span> -p <span class="string">&quot;<span class="variable">$ANSIBLE_DIR</span>&quot;</span></span><br><span class="line"><span class="built_in">cd</span> <span class="string">&quot;<span class="variable">$ANSIBLE_DIR</span>&quot;</span> || <span class="built_in">exit</span> 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- Install Ansible if not already installed ---</span></span><br><span class="line"><span class="keyword">if</span> ! <span class="built_in">command</span> -v ansible &amp;&gt; /dev/null</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Ansible not found. Installing Ansible...&quot;</span></span><br><span class="line">    <span class="comment"># Check OS and install accordingly</span></span><br><span class="line">    <span class="keyword">if</span> [ -f /etc/os-release ]; <span class="keyword">then</span></span><br><span class="line">        . /etc/os-release</span><br><span class="line">        <span class="keyword">if</span> [[ <span class="string">&quot;<span class="variable">$ID</span>&quot;</span> == <span class="string">&quot;ubuntu&quot;</span> || <span class="string">&quot;<span class="variable">$ID</span>&quot;</span> == <span class="string">&quot;debian&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">            sudo apt update</span><br><span class="line">            sudo apt install -y software-properties-common</span><br><span class="line">            sudo apt-add-repository --<span class="built_in">yes</span> --update ppa:ansible/ansible</span><br><span class="line">            sudo apt install -y ansible</span><br><span class="line">        <span class="keyword">elif</span> [[ <span class="string">&quot;<span class="variable">$ID</span>&quot;</span> == <span class="string">&quot;centos&quot;</span> || <span class="string">&quot;<span class="variable">$ID</span>&quot;</span> == <span class="string">&quot;rhel&quot;</span> || <span class="string">&quot;<span class="variable">$ID</span>&quot;</span> == <span class="string">&quot;fedora&quot;</span> ]]; <span class="keyword">then</span></span><br><span class="line">            sudo yum install -y epel-release</span><br><span class="line">            sudo yum install -y ansible</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;Unsupported OS for automatic Ansible installation. Please install Ansible manually.&quot;</span></span><br><span class="line">            <span class="built_in">exit</span> 1</span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Could not determine OS for automatic Ansible installation. Please install Ansible manually.&quot;</span></span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Ansible is already installed.&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- Create Ansible Inventory File ---</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Creating Ansible inventory file: inventory.ini&quot;</span></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt; inventory.ini</span></span><br><span class="line"><span class="string">[dns_server]</span></span><br><span class="line"><span class="string">$&#123;VM_IP&#125; ansible_user=$&#123;SSH_USER&#125; ansible_ssh_private_key_file=$&#123;SSH_PRIVATE_KEY_PATH&#125; ansible_python_interpreter=/usr/bin/python3</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- Create Ansible Playbook (setup-dnsmasq.yml) ---</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Creating Ansible playbook: setup-dnsmasq.yml&quot;</span></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt; setup-dnsmasq.yml</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">- name: Configure DNSmasq Server on Ubuntu VM</span></span><br><span class="line"><span class="string">  hosts: dns_server</span></span><br><span class="line"><span class="string">  become: yes # Run tasks with sudo privileges</span></span><br><span class="line"><span class="string">  vars:</span></span><br><span class="line"><span class="string">    dns_forwarder_1: &quot;$&#123;FORWARD_NAMESERVER1&#125;&quot;</span></span><br><span class="line"><span class="string">    dns_forwarder_2: &quot;$&#123;FORWARD_NAMESERVER2&#125;&quot;</span></span><br><span class="line"><span class="string">    vm_ip: &quot;$&#123;VM_IP&#125;&quot;</span></span><br><span class="line"><span class="string">    search_domain: &quot;$&#123;SEARCH_DOMAIN&#125;&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  tasks:</span></span><br><span class="line"><span class="string">    - name: Ensure apt cache is updated</span></span><br><span class="line"><span class="string">      ansible.builtin.apt:</span></span><br><span class="line"><span class="string">        update_cache: yes</span></span><br><span class="line"><span class="string">        cache_valid_time: 3600 # Cache for 1 hour</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    - name: Install dnsmasq package</span></span><br><span class="line"><span class="string">      ansible.builtin.apt:</span></span><br><span class="line"><span class="string">        name: dnsmasq</span></span><br><span class="line"><span class="string">        state: present</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    - name: Stop dnsmasq service before configuration</span></span><br><span class="line"><span class="string">      ansible.builtin.systemd:</span></span><br><span class="line"><span class="string">        name: dnsmasq</span></span><br><span class="line"><span class="string">        state: stopped</span></span><br><span class="line"><span class="string">      ignore_errors: yes # Ignore if it&#x27;s not running initially</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    - name: Backup original dnsmasq.conf</span></span><br><span class="line"><span class="string">      ansible.builtin.command: mv /etc/dnsmasq.conf /etc/dnsmasq.conf.bak</span></span><br><span class="line"><span class="string">      args:</span></span><br><span class="line"><span class="string">        removes: /etc/dnsmasq.conf # Only run if dnsmasq.conf exists</span></span><br><span class="line"><span class="string">      ignore_errors: yes</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    - name: Configure dnsmasq for forwarding</span></span><br><span class="line"><span class="string">      ansible.builtin.template:</span></span><br><span class="line"><span class="string">        src: dnsmasq.conf.j2</span></span><br><span class="line"><span class="string">        dest: /etc/dnsmasq.conf</span></span><br><span class="line"><span class="string">        owner: root</span></span><br><span class="line"><span class="string">        group: root</span></span><br><span class="line"><span class="string">        mode: &#x27;0644&#x27;</span></span><br><span class="line"><span class="string">      notify: Restart dnsmasq</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    - name: Set VM&#x27;s /etc/resolv.conf to point to itself (local DNS)</span></span><br><span class="line"><span class="string">      ansible.builtin.template:</span></span><br><span class="line"><span class="string">        src: resolv.conf.j2</span></span><br><span class="line"><span class="string">        dest: /etc/resolv.conf</span></span><br><span class="line"><span class="string">        owner: root</span></span><br><span class="line"><span class="string">        group: root</span></span><br><span class="line"><span class="string">        mode: &#x27;0644&#x27;</span></span><br><span class="line"><span class="string">      vars:</span></span><br><span class="line"><span class="string">        local_dns_ip: &quot;127.0.0.1&quot; # dnsmasq listens on 127.0.0.1</span></span><br><span class="line"><span class="string">        # Removed: search_domain: &quot;&#123;&#123; search_domain &#125;&#125;&quot; - it&#x27;s already available from play vars</span></span><br><span class="line"><span class="string">      notify: Restart systemd-resolved # Or NetworkManager, depending on Ubuntu version</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  handlers:</span></span><br><span class="line"><span class="string">    - name: Restart dnsmasq</span></span><br><span class="line"><span class="string">      ansible.builtin.systemd:</span></span><br><span class="line"><span class="string">        name: dnsmasq</span></span><br><span class="line"><span class="string">        state: restarted</span></span><br><span class="line"><span class="string">        enabled: yes # Ensure it&#x27;s enabled to start on boot</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    - name: Restart systemd-resolved</span></span><br><span class="line"><span class="string">      ansible.builtin.systemd:</span></span><br><span class="line"><span class="string">        name: systemd-resolved</span></span><br><span class="line"><span class="string">        state: restarted</span></span><br><span class="line"><span class="string">      ignore_errors: yes # systemd-resolved might not be used on server installs</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- Create dnsmasq.conf.j2 template ---</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Creating dnsmasq.conf.j2 template&quot;</span></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt; dnsmasq.conf.j2</span></span><br><span class="line"><span class="string"># This file is managed by Ansible. Do not edit manually.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># Do not read /etc/resolv.conf, use the servers below</span></span><br><span class="line"><span class="string">no-resolv</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># Specify upstream DNS servers for forwarding</span></span><br><span class="line"><span class="string">server=&#123;&#123; dns_forwarder_1 &#125;&#125;</span></span><br><span class="line"><span class="string">server=&#123;&#123; dns_forwarder_2 &#125;&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># Listen on localhost and the VM&#x27;s primary IP</span></span><br><span class="line"><span class="string">listen-address=127.0.0.1,&#123;&#123; vm_ip &#125;&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># Allow queries from any interface</span></span><br><span class="line"><span class="string">interface=&#123;&#123; ansible_default_ipv4.interface &#125;&#125; # Listen on the primary network interface</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># Bind to the interfaces to prevent dnsmasq from listening on all interfaces</span></span><br><span class="line"><span class="string">bind-interfaces</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"># Cache DNS results</span></span><br><span class="line"><span class="string">cache-size=150</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- Create resolv.conf.j2 template ---</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Creating resolv.conf.j2 template&quot;</span></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt; resolv.conf.j2</span></span><br><span class="line"><span class="string"># This file is managed by Ansible. Do not edit manually.</span></span><br><span class="line"><span class="string">nameserver &#123;&#123; local_dns_ip &#125;&#125;</span></span><br><span class="line"><span class="string">search &#123;&#123; search_domain &#125;&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- Run the Ansible Playbook ---</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Running Ansible playbook to configure DNSmasq...&quot;</span></span><br><span class="line">ansible-playbook -i inventory.ini setup-dnsmasq.yml -K</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- Final Instructions ---</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;--------------------------------------------------------&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;DNSmasq configuration complete on <span class="variable">$&#123;VM_IP&#125;</span>.&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;You can now test the DNS server from the VM or from another machine.&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;From the VM, run: dig @127.0.0.1 www.cisco.com&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;From another machine on the same network, configure its DNS to <span class="variable">$&#123;VM_IP&#125;</span> and run: dig www.cisco.com&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Remember to exit the &#x27;<span class="variable">$&#123;ANSIBLE_DIR&#125;</span>&#x27; directory when done (cd ..).&quot;</span></span><br></pre></td></tr></table></figure>

<p>执行效果</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">ois@ois:~/data/k8s$ ./ansible-dnsmasq.sh </span><br><span class="line">--- Setting up Ansible environment and configuring DNSmasq on 10.75.59.76 ---</span><br><span class="line">Ansible is already installed.</span><br><span class="line">Creating Ansible inventory file: inventory.ini</span><br><span class="line">Creating Ansible playbook: setup-dnsmasq.yml</span><br><span class="line">Creating dnsmasq.conf.j2 template</span><br><span class="line">Creating resolv.conf.j2 template</span><br><span class="line">Running Ansible playbook to configure DNSmasq...</span><br><span class="line">BECOME password: </span><br><span class="line"></span><br><span class="line">PLAY [Configure DNSmasq Server on Ubuntu VM] *******************************************************************************************************************************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] *****************************************************************************************************************************************************************************************************************************************</span><br><span class="line">ok: [10.75.59.76]</span><br><span class="line"></span><br><span class="line">TASK [Ensure apt cache is updated] *****************************************************************************************************************************************************************************************************************************</span><br><span class="line">ok: [10.75.59.76]</span><br><span class="line"></span><br><span class="line">TASK [Install dnsmasq package] *********************************************************************************************************************************************************************************************************************************</span><br><span class="line">ok: [10.75.59.76]</span><br><span class="line"></span><br><span class="line">TASK [Stop dnsmasq service before configuration] ***************************************************************************************************************************************************************************************************************</span><br><span class="line">ok: [10.75.59.76]</span><br><span class="line"></span><br><span class="line">TASK [Backup original dnsmasq.conf] ****************************************************************************************************************************************************************************************************************************</span><br><span class="line">changed: [10.75.59.76]</span><br><span class="line"></span><br><span class="line">TASK [Configure dnsmasq <span class="keyword">for</span> forwarding] ************************************************************************************************************************************************************************************************************************</span><br><span class="line">changed: [10.75.59.76]</span><br><span class="line"></span><br><span class="line">TASK [Set VM<span class="string">&#x27;s /etc/resolv.conf to point to itself (local DNS)] ************************************************************************************************************************************************************************************************</span></span><br><span class="line"><span class="string">changed: [10.75.59.76]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">RUNNING HANDLER [Restart dnsmasq] ******************************************************************************************************************************************************************************************************************************</span></span><br><span class="line"><span class="string">changed: [10.75.59.76]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">RUNNING HANDLER [Restart systemd-resolved] *********************************************************************************************************************************************************************************************************************</span></span><br><span class="line"><span class="string">changed: [10.75.59.76]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">PLAY RECAP *****************************************************************************************************************************************************************************************************************************************************</span></span><br><span class="line"><span class="string">10.75.59.76                : ok=9    changed=5    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">--------------------------------------------------------</span></span><br><span class="line"><span class="string">DNSmasq configuration complete on 10.75.59.76.</span></span><br><span class="line"><span class="string">You can now test the DNS server from the VM or from another machine.</span></span><br><span class="line"><span class="string">From the VM, run: dig @127.0.0.1 www.cisco.com</span></span><br><span class="line"><span class="string">From another machine on the same network, configure its DNS to 10.75.59.76 and run: dig www.cisco.com</span></span><br><span class="line"><span class="string">Remember to exit the &#x27;</span>ansible_dnsmasq_setup<span class="string">&#x27; directory when done (cd ..).</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">root@dns-server-vm:~<span class="comment"># dig @127.0.0.1 www.cisco.com</span></span><br><span class="line"></span><br><span class="line">; &lt;&lt;&gt;&gt; DiG 9.18.30-0ubuntu0.24.04.2-Ubuntu &lt;&lt;&gt;&gt; @127.0.0.1 www.cisco.com</span><br><span class="line">; (1 server found)</span><br><span class="line">;; global options: +cmd</span><br><span class="line">;; Got answer:</span><br><span class="line">;; -&gt;&gt;HEADER&lt;&lt;- <span class="string">opcode: QUERY, status: NOERROR, id: 10545</span></span><br><span class="line"><span class="string">;; flags: qr aa rd ra; QUERY: 1, ANSWER: 3, AUTHORITY: 0, ADDITIONAL: 1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">;; OPT PSEUDOSECTION:</span></span><br><span class="line"><span class="string">; EDNS: version: 0, flags:; udp: 1232</span></span><br><span class="line"><span class="string">; COOKIE: ba16202024b9dc8301000000688b40f90daaa0a500a50d2d (good)</span></span><br><span class="line"><span class="string">;; QUESTION SECTION:</span></span><br><span class="line"><span class="string">;www.cisco.com.                 IN      A</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">;; ANSWER SECTION:</span></span><br><span class="line"><span class="string">www.cisco.com.          3600    IN      CNAME   origin-www.cisco.com.</span></span><br><span class="line"><span class="string">origin-www.cisco.com.   1800    IN      CNAME   origin-www.xgslb-v3.cisco.com.</span></span><br><span class="line"><span class="string">origin-www.xgslb-v3.CISCO.com. 10 IN    A       72.163.4.161</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">;; Query time: 71 msec</span></span><br><span class="line"><span class="string">;; SERVER: 127.0.0.1#53(127.0.0.1) (UDP)</span></span><br><span class="line"><span class="string">;; WHEN: Thu Jul 31 19:10:01 JST 2025</span></span><br><span class="line"><span class="string">;; MSG SIZE  rcvd: 183</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure>

<h2 id="3-3-使用Ansible更新Node-的DNS配置"><a href="#3-3-使用Ansible更新Node-的DNS配置" class="headerlink" title="3.3 使用Ansible更新Node 的DNS配置"></a>3.3 使用Ansible更新Node 的DNS配置</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- Configuration ---</span></span><br><span class="line">ANSIBLE_DIR=<span class="string">&quot;ansible_dns_update&quot;</span></span><br><span class="line">INVENTORY_FILE=<span class="string">&quot;<span class="variable">$&#123;ANSIBLE_DIR&#125;</span>/hosts.ini&quot;</span></span><br><span class="line">PLAYBOOK_FILE=<span class="string">&quot;<span class="variable">$&#123;ANSIBLE_DIR&#125;</span>/update_dns.yml&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Kubernetes Node IPs (ensure these match your actual VM IPs)</span></span><br><span class="line">KUBE_NODE_1_IP=<span class="string">&quot;10.75.59.71&quot;</span></span><br><span class="line">KUBE_NODE_2_IP=<span class="string">&quot;10.75.59.72&quot;</span></span><br><span class="line">KUBE_NODE_3_IP=<span class="string">&quot;10.75.59.73&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Common Ansible user and Python interpreter</span></span><br><span class="line">ANSIBLE_USER=<span class="string">&quot;ubuntu&quot;</span></span><br><span class="line">ANSIBLE_PYTHON_INTERPRETER=<span class="string">&quot;/usr/bin/python3&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- Functions ---</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Function to check and install Ansible</span></span><br><span class="line"><span class="function"><span class="title">install_ansible</span></span>() &#123;</span><br><span class="line">    <span class="keyword">if</span> ! <span class="built_in">command</span> -v ansible &amp;&gt; /dev/null</span><br><span class="line">    <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Ansible not found. Attempting to install Ansible...&quot;</span></span><br><span class="line">        <span class="keyword">if</span> [ -f /etc/debian_version ]; <span class="keyword">then</span></span><br><span class="line">            <span class="comment"># Debian/Ubuntu</span></span><br><span class="line">            sudo apt update</span><br><span class="line">            sudo apt install -y software-properties-common</span><br><span class="line">            sudo add-apt-repository --<span class="built_in">yes</span> --update ppa:ansible/ansible</span><br><span class="line">            sudo apt install -y ansible</span><br><span class="line">        <span class="keyword">elif</span> [ -f /etc/redhat-release ]; <span class="keyword">then</span></span><br><span class="line">            <span class="comment"># CentOS/RHEL/Fedora</span></span><br><span class="line">            sudo yum install -y epel-release</span><br><span class="line">            sudo yum install -y ansible</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;Unsupported OS for automatic Ansible installation. Please install Ansible manually.&quot;</span></span><br><span class="line">            <span class="built_in">exit</span> 1</span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">        <span class="keyword">if</span> ! <span class="built_in">command</span> -v ansible &amp;&gt; /dev/null; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;Ansible installation failed. Please install it manually and re-run this script.&quot;</span></span><br><span class="line">            <span class="built_in">exit</span> 1</span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Ansible installed successfully.&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Ansible is already installed.&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Function to create Ansible inventory file</span></span><br><span class="line"><span class="function"><span class="title">create_inventory</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Creating Ansible inventory file: <span class="variable">$&#123;INVENTORY_FILE&#125;</span>&quot;</span></span><br><span class="line">    <span class="built_in">mkdir</span> -p <span class="string">&quot;<span class="variable">$ANSIBLE_DIR</span>&quot;</span></span><br><span class="line">    <span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt; &quot;$INVENTORY_FILE&quot;</span></span><br><span class="line"><span class="string">[kubernetes_nodes]</span></span><br><span class="line"><span class="string">kube-node-1 ansible_host=$&#123;KUBE_NODE_1_IP&#125;</span></span><br><span class="line"><span class="string">kube-node-2 ansible_host=$&#123;KUBE_NODE_2_IP&#125;</span></span><br><span class="line"><span class="string">kube-node-3 ansible_host=$&#123;KUBE_NODE_3_IP&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[all:vars]</span></span><br><span class="line"><span class="string">ansible_user=$&#123;ANSIBLE_USER&#125;</span></span><br><span class="line"><span class="string">ansible_python_interpreter=$&#123;ANSIBLE_PYTHON_INTERPRETER&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Inventory file created.&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Function to create Ansible playbook file</span></span><br><span class="line"><span class="function"><span class="title">create_playbook</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Creating Ansible playbook file: <span class="variable">$&#123;PLAYBOOK_FILE&#125;</span>&quot;</span></span><br><span class="line">    <span class="built_in">mkdir</span> -p <span class="string">&quot;<span class="variable">$ANSIBLE_DIR</span>&quot;</span></span><br><span class="line">    <span class="built_in">cat</span> &lt;&lt;<span class="string">&#x27;EOF&#x27;</span> &gt; <span class="string">&quot;<span class="variable">$PLAYBOOK_FILE</span>&quot;</span></span><br><span class="line">---</span><br><span class="line">- name: Update DNS server on Kubernetes nodes to use <span class="built_in">local</span> DNS only</span><br><span class="line">  hosts: kubernetes_nodes</span><br><span class="line">  become: <span class="built_in">yes</span> <span class="comment"># This allows Ansible to run commands with sudo privileges</span></span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">    - name: Ensure netplan configuration directory exists</span><br><span class="line">      ansible.builtin.file:</span><br><span class="line">        path: /etc/netplan</span><br><span class="line">        state: directory</span><br><span class="line">        mode: <span class="string">&#x27;0755&#x27;</span></span><br><span class="line"></span><br><span class="line">    - name: Get current network configuration file (e.g., 00-installer-config.yaml)</span><br><span class="line">      ansible.builtin.find:</span><br><span class="line">        paths: /etc/netplan</span><br><span class="line">        patterns: <span class="string">&#x27;*.yaml&#x27;</span></span><br><span class="line">        <span class="comment"># We assume there&#x27;s only one primary netplan config file for simplicity.</span></span><br><span class="line">        <span class="comment"># If there are multiple, you might need to specify which one.</span></span><br><span class="line">      register: netplan_files</span><br><span class="line"></span><br><span class="line">    - name: Set network config file variable</span><br><span class="line">      ansible.builtin.set_fact:</span><br><span class="line">        netplan_config_file: <span class="string">&quot;&#123;&#123; netplan_files.files[0].path &#125;&#125;&quot;</span></span><br><span class="line">      when: netplan_files.files | length &gt; 0</span><br><span class="line"></span><br><span class="line">    - name: Fail <span class="keyword">if</span> no netplan config file found</span><br><span class="line">      ansible.builtin.fail:</span><br><span class="line">        msg: <span class="string">&quot;No Netplan configuration file found in /etc/netplan. Cannot proceed.&quot;</span></span><br><span class="line">      when: netplan_files.files | length == 0</span><br><span class="line"></span><br><span class="line">    - name: Read current netplan configuration</span><br><span class="line">      ansible.builtin.slurp:</span><br><span class="line">        src: <span class="string">&quot;&#123;&#123; netplan_config_file &#125;&#125;&quot;</span></span><br><span class="line">      register: current_netplan_config</span><br><span class="line"></span><br><span class="line">    - name: Parse current netplan configuration</span><br><span class="line">      ansible.builtin.set_fact:</span><br><span class="line">        parsed_netplan: <span class="string">&quot;&#123;&#123; current_netplan_config[&#x27;content&#x27;] | b64decode | from_yaml &#125;&#125;&quot;</span></span><br><span class="line"></span><br><span class="line">    - name: Update nameservers <span class="keyword">in</span> netplan configuration to <span class="built_in">local</span> DNS only</span><br><span class="line">      ansible.builtin.set_fact:</span><br><span class="line">        updated_netplan: <span class="string">&quot;&#123;&#123; parsed_netplan | combine(</span></span><br><span class="line"><span class="string">            &#123;</span></span><br><span class="line"><span class="string">              &#x27;network&#x27;: &#123;</span></span><br><span class="line"><span class="string">                &#x27;ethernets&#x27;: &#123;</span></span><br><span class="line"><span class="string">                  &#x27;enp1s0&#x27;: &#123;</span></span><br><span class="line"><span class="string">                    &#x27;nameservers&#x27;: &#123;</span></span><br><span class="line"><span class="string">                      &#x27;addresses&#x27;: [&#x27;10.75.59.76&#x27;],</span></span><br><span class="line"><span class="string">                      &#x27;search&#x27;: [&#x27;cisco.com&#x27;]</span></span><br><span class="line"><span class="string">                    &#125;</span></span><br><span class="line"><span class="string">                  &#125;</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">              &#125;</span></span><br><span class="line"><span class="string">            &#125;, recursive=True) &#125;&#125;&quot;</span></span><br><span class="line"></span><br><span class="line">    - name: Write updated netplan configuration</span><br><span class="line">      ansible.builtin.copy:</span><br><span class="line">        content: <span class="string">&quot;&#123;&#123; updated_netplan | to_yaml &#125;&#125;&quot;</span></span><br><span class="line">        dest: <span class="string">&quot;&#123;&#123; netplan_config_file &#125;&#125;&quot;</span></span><br><span class="line">        mode: <span class="string">&#x27;0600&#x27;</span></span><br><span class="line">      notify: Apply Netplan Configuration</span><br><span class="line"></span><br><span class="line">  handlers:</span><br><span class="line">    - name: Apply Netplan Configuration</span><br><span class="line">      ansible.builtin.command: netplan apply</span><br><span class="line">      listen: <span class="string">&quot;Apply Netplan Configuration&quot;</span></span><br><span class="line">EOF</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Playbook file created.&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- Main Script Execution ---</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Starting Ansible DNS update process...&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. Install Ansible if not present</span></span><br><span class="line">install_ansible</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. Create Ansible inventory file</span></span><br><span class="line">create_inventory</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. Create Ansible playbook file</span></span><br><span class="line">create_playbook</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. Run the Ansible playbook</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Running Ansible playbook to update DNS on Kubernetes nodes...&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;You will be prompted for the &#x27;sudo&#x27; password for the &#x27;ubuntu&#x27; user on your VMs.&quot;</span></span><br><span class="line">ansible-playbook -i <span class="string">&quot;<span class="variable">$INVENTORY_FILE</span>&quot;</span> <span class="string">&quot;<span class="variable">$PLAYBOOK_FILE</span>&quot;</span> --ask-become-pass</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ $? -eq 0 ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Ansible playbook executed successfully.&quot;</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Your Kubernetes nodes should now be configured to use 10.75.59.76 as their only DNS server.&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Ansible playbook failed. Please check the output for errors.&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Process complete.&quot;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line">ois@ois:~/data/k8s$ ./updatedns.sh </span><br><span class="line">Starting Ansible DNS update process...</span><br><span class="line">Ansible is already installed.</span><br><span class="line">Creating Ansible inventory file: ansible_dns_update/hosts.ini</span><br><span class="line">Inventory file created.</span><br><span class="line">Creating Ansible playbook file: ansible_dns_update/update_dns.yml</span><br><span class="line">Playbook file created.</span><br><span class="line">Running Ansible playbook to update DNS on Kubernetes nodes...</span><br><span class="line">You will be prompted <span class="keyword">for</span> the <span class="string">&#x27;sudo&#x27;</span> password <span class="keyword">for</span> the <span class="string">&#x27;ubuntu&#x27;</span> user on your VMs.</span><br><span class="line">BECOME password: </span><br><span class="line"></span><br><span class="line">PLAY [Update DNS server on Kubernetes nodes to use <span class="built_in">local</span> DNS only] *********************************************************************************************************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] *****************************************************************************************************************************************************************************************************************************************</span><br><span class="line">ok: [kube-node-1]</span><br><span class="line">ok: [kube-node-2]</span><br><span class="line">ok: [kube-node-3]</span><br><span class="line"></span><br><span class="line">TASK [Ensure netplan configuration directory exists] ***********************************************************************************************************************************************************************************************************</span><br><span class="line">ok: [kube-node-3]</span><br><span class="line">ok: [kube-node-2]</span><br><span class="line">ok: [kube-node-1]</span><br><span class="line"></span><br><span class="line">TASK [Get current network configuration file (e.g., 00-installer-config.yaml)] *********************************************************************************************************************************************************************************</span><br><span class="line">ok: [kube-node-3]</span><br><span class="line">ok: [kube-node-1]</span><br><span class="line">ok: [kube-node-2]</span><br><span class="line"></span><br><span class="line">TASK [Set network config file variable] ************************************************************************************************************************************************************************************************************************</span><br><span class="line">ok: [kube-node-1]</span><br><span class="line">ok: [kube-node-2]</span><br><span class="line">ok: [kube-node-3]</span><br><span class="line"></span><br><span class="line">TASK [Fail <span class="keyword">if</span> no netplan config file found] ********************************************************************************************************************************************************************************************************************</span><br><span class="line">skipping: [kube-node-1]</span><br><span class="line">skipping: [kube-node-2]</span><br><span class="line">skipping: [kube-node-3]</span><br><span class="line"></span><br><span class="line">TASK [Read current netplan configuration] **********************************************************************************************************************************************************************************************************************</span><br><span class="line">ok: [kube-node-3]</span><br><span class="line">ok: [kube-node-1]</span><br><span class="line">ok: [kube-node-2]</span><br><span class="line"></span><br><span class="line">TASK [Parse current netplan configuration] *********************************************************************************************************************************************************************************************************************</span><br><span class="line">ok: [kube-node-1]</span><br><span class="line">ok: [kube-node-2]</span><br><span class="line">ok: [kube-node-3]</span><br><span class="line"></span><br><span class="line">TASK [Update nameservers <span class="keyword">in</span> netplan configuration to <span class="built_in">local</span> DNS only] *******************************************************************************************************************************************************************************************</span><br><span class="line">ok: [kube-node-1]</span><br><span class="line">ok: [kube-node-2]</span><br><span class="line">ok: [kube-node-3]</span><br><span class="line"></span><br><span class="line">TASK [Write updated netplan configuration] *********************************************************************************************************************************************************************************************************************</span><br><span class="line">ok: [kube-node-3]</span><br><span class="line">ok: [kube-node-1]</span><br><span class="line">ok: [kube-node-2]</span><br><span class="line"></span><br><span class="line">PLAY RECAP *****************************************************************************************************************************************************************************************************************************************************</span><br><span class="line">kube-node-1                : ok=8    changed=0    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   </span><br><span class="line">kube-node-2                : ok=8    changed=0    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   </span><br><span class="line">kube-node-3                : ok=8    changed=0    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   </span><br><span class="line"></span><br><span class="line">Ansible playbook executed successfully.</span><br><span class="line">Your Kubernetes nodes should now be configured to use 10.75.59.76 as their only DNS server.</span><br><span class="line">Process complete.</span><br><span class="line"></span><br><span class="line">root@kube-node-1:~<span class="comment"># cat /etc/resolv.conf </span></span><br><span class="line"><span class="comment"># This is /run/systemd/resolve/stub-resolv.conf managed by man:systemd-resolved(8).</span></span><br><span class="line"><span class="comment"># Do not edit.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># This file might be symlinked as /etc/resolv.conf. If you&#x27;re looking at</span></span><br><span class="line"><span class="comment"># /etc/resolv.conf and seeing this text, you have followed the symlink.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># This is a dynamic resolv.conf file for connecting local clients to the</span></span><br><span class="line"><span class="comment"># internal DNS stub resolver of systemd-resolved. This file lists all</span></span><br><span class="line"><span class="comment"># configured search domains.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Run &quot;resolvectl status&quot; to see details about the uplink DNS servers</span></span><br><span class="line"><span class="comment"># currently in use.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Third party programs should typically not access this file directly, but only</span></span><br><span class="line"><span class="comment"># through the symlink at /etc/resolv.conf. To manage man:resolv.conf(5) in a</span></span><br><span class="line"><span class="comment"># different way, replace this symlink by a static file or a different symlink.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># See man:systemd-resolved.service(8) for details about the supported modes of</span></span><br><span class="line"><span class="comment"># operation for /etc/resolv.conf.</span></span><br><span class="line"></span><br><span class="line">nameserver 127.0.0.53</span><br><span class="line">options edns0 trust-ad</span><br><span class="line">search cisco.com</span><br><span class="line">root@kube-node-1:~<span class="comment"># cat /etc/netplan/50-cloud-init.yaml </span></span><br><span class="line">network:</span><br><span class="line">  ethernets:</span><br><span class="line">    enp1s0:</span><br><span class="line">      addresses: [10.75.59.71/24]</span><br><span class="line">      nameservers:</span><br><span class="line">        addresses: [10.75.59.76]</span><br><span class="line">        search: [cisco.com]</span><br><span class="line">      routes:</span><br><span class="line">      - &#123;to: default, via: 10.75.59.1&#125;</span><br><span class="line">  version: 2</span><br></pre></td></tr></table></figure>

<h2 id="3-4-使用Ansible配置FRR-BGP"><a href="#3-4-使用Ansible配置FRR-BGP" class="headerlink" title="3.4 使用Ansible配置FRR BGP"></a>3.4 使用Ansible配置FRR BGP</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># This script automates the setup of an Ansible environment for installing and configuring FRRouting (FRR).</span></span><br><span class="line"><span class="comment"># It creates the project directory, inventory, configuration, and the playbook</span></span><br><span class="line"><span class="comment"># with an idempotent role to install and configure FRR.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- Configuration ---</span></span><br><span class="line">PROJECT_DIR=<span class="string">&quot;ansible-frr-setup&quot;</span> <span class="comment"># Changed project directory name</span></span><br><span class="line">FRR_NODE_IP=<span class="string">&quot;10.75.59.76&quot;</span> <span class="comment"># IP address of your FRR VM (frr-server-vm)</span></span><br><span class="line">ANSIBLE_USER=<span class="string">&quot;ubuntu&quot;</span> <span class="comment"># The user created by cloud-init on your VMs</span></span><br><span class="line">SSH_PRIVATE_KEY_PATH=<span class="string">&quot;~/.ssh/id_rsa&quot;</span> <span class="comment"># Path to your SSH private key on the Ansible control machine</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># FRR specific configuration</span></span><br><span class="line">FRR_AS=65000 <span class="comment"># The Autonomous System number for this FRR node (example AS, choose your own)</span></span><br><span class="line">K8S_MASTER_IP=<span class="string">&quot;10.75.59.71&quot;</span> <span class="comment"># From your create-vms.sh script</span></span><br><span class="line">K8S_WORKER_1_IP=<span class="string">&quot;10.75.59.72&quot;</span> <span class="comment"># From your create-vms.sh script</span></span><br><span class="line">K8S_WORKER_2_IP=<span class="string">&quot;10.75.59.73&quot;</span> <span class="comment"># From your create-vms.sh script</span></span><br><span class="line">CILIUM_BGP_AS=65000 <span class="comment"># AS for Cilium as per your CiliumBGPClusterConfig</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- Functions ---</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Function to install Ansible (if not already installed)</span></span><br><span class="line"><span class="function"><span class="title">install_ansible</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;--- Installing Ansible ---&quot;</span></span><br><span class="line">    <span class="keyword">if</span> ! <span class="built_in">command</span> -v ansible &amp;&gt; /dev/null; <span class="keyword">then</span></span><br><span class="line">        sudo apt update -y</span><br><span class="line">        sudo apt install -y ansible</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Ansible installed successfully.&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Ansible is already installed.&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Function to create project directory and navigate into it</span></span><br><span class="line"><span class="function"><span class="title">create_project_dir</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;--- Creating project directory: <span class="variable">$&#123;PROJECT_DIR&#125;</span> ---&quot;</span></span><br><span class="line">    <span class="comment"># Check if directory exists, if so, just navigate, otherwise create and navigate</span></span><br><span class="line">    <span class="keyword">if</span> [ ! -d <span class="string">&quot;<span class="variable">$&#123;PROJECT_DIR&#125;</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">mkdir</span> -p <span class="string">&quot;<span class="variable">$&#123;PROJECT_DIR&#125;</span>&quot;</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Created new directory: <span class="variable">$&#123;PROJECT_DIR&#125;</span>&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Directory <span class="variable">$&#123;PROJECT_DIR&#125;</span> already exists.&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="built_in">cd</span> <span class="string">&quot;<span class="variable">$&#123;PROJECT_DIR&#125;</span>&quot;</span> || &#123; <span class="built_in">echo</span> <span class="string">&quot;Failed to change directory to <span class="variable">$&#123;PROJECT_DIR&#125;</span>. Exiting.&quot;</span>; <span class="built_in">exit</span> 1; &#125;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Changed to directory: <span class="subst">$(pwd)</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Function to create ansible.cfg</span></span><br><span class="line"><span class="function"><span class="title">create_ansible_cfg</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;--- Creating ansible.cfg ---&quot;</span></span><br><span class="line">    <span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt; ansible.cfg</span></span><br><span class="line"><span class="string">[defaults]</span></span><br><span class="line"><span class="string">inventory = inventory.ini</span></span><br><span class="line"><span class="string">roles_path = ./roles</span></span><br><span class="line"><span class="string">host_key_checking = False # WARNING: Disable host key checking for convenience. Re-enable for production!</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;ansible.cfg created.&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Function to create inventory.ini</span></span><br><span class="line"><span class="function"><span class="title">create_inventory</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;--- Creating inventory.ini ---&quot;</span></span><br><span class="line">    <span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt; inventory.ini</span></span><br><span class="line"><span class="string">[frr_nodes]</span></span><br><span class="line"><span class="string">frr-node-1 ansible_host=$&#123;FRR_NODE_IP&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[all:vars]</span></span><br><span class="line"><span class="string">ansible_user=$&#123;ANSIBLE_USER&#125;</span></span><br><span class="line"><span class="string">ansible_ssh_private_key_file=$&#123;SSH_PRIVATE_KEY_PATH&#125;</span></span><br><span class="line"><span class="string">ansible_python_interpreter=/usr/bin/python3</span></span><br><span class="line"><span class="string">FRR_AS=$&#123;FRR_AS&#125;</span></span><br><span class="line"><span class="string">K8S_MASTER_IP=$&#123;K8S_MASTER_IP&#125;</span></span><br><span class="line"><span class="string">K8S_WORKER_1_IP=$&#123;K8S_WORKER_1_IP&#125;</span></span><br><span class="line"><span class="string">K8S_WORKER_2_IP=$&#123;K8S_WORKER_2_IP&#125;</span></span><br><span class="line"><span class="string">CILIUM_BGP_AS=$&#123;CILIUM_BGP_AS&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;inventory.ini created.&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Function to create the main playbook.yml</span></span><br><span class="line"><span class="function"><span class="title">create_playbook</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;--- Creating playbook.yml ---&quot;</span></span><br><span class="line">    <span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt; playbook.yml</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">- name: Install and Configure FRRouting (FRR)</span></span><br><span class="line"><span class="string">  hosts: frr_nodes</span></span><br><span class="line"><span class="string">  become: yes</span></span><br><span class="line"><span class="string">  roles:</span></span><br><span class="line"><span class="string">    - frr_setup # Changed role name to frr_setup</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;playbook.yml created.&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Function to create the FRR installation and configuration role</span></span><br><span class="line"><span class="function"><span class="title">create_frr_role</span></span>() &#123; <span class="comment"># Changed function name from create_gobgp_role</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;--- Creating Ansible role for FRR setup ---&quot;</span></span><br><span class="line">    <span class="built_in">mkdir</span> -p roles/frr_setup/tasks</span><br><span class="line">    <span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt; roles/frr_setup/tasks/main.yml</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">- name: Install FRRouting (FRR)</span></span><br><span class="line"><span class="string">  ansible.builtin.apt:</span></span><br><span class="line"><span class="string">    name: frr</span></span><br><span class="line"><span class="string">    state: present</span></span><br><span class="line"><span class="string">    update_cache: yes</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">- name: Configure FRR daemons (enable zebra and bgpd)</span></span><br><span class="line"><span class="string">  ansible.builtin.lineinfile:</span></span><br><span class="line"><span class="string">    path: /etc/frr/daemons</span></span><br><span class="line"><span class="string">    regexp: &#x27;^(zebra|bgpd)=&#x27;</span></span><br><span class="line"><span class="string">    line: &#x27;\1=yes&#x27;</span></span><br><span class="line"><span class="string">    state: present</span></span><br><span class="line"><span class="string">    backrefs: yes # Required to make regexp work for replacement</span></span><br><span class="line"><span class="string">  notify: Restart FRR service</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">- name: Configure frr.conf</span></span><br><span class="line"><span class="string">  ansible.builtin.copy:</span></span><br><span class="line"><span class="string">    dest: /etc/frr/frr.conf</span></span><br><span class="line"><span class="string">    content: |</span></span><br><span class="line"><span class="string">      !</span></span><br><span class="line"><span class="string">      hostname &#123;&#123; ansible_hostname &#125;&#125;</span></span><br><span class="line"><span class="string">      password zebra</span></span><br><span class="line"><span class="string">      enable password zebra</span></span><br><span class="line"><span class="string">      !</span></span><br><span class="line"><span class="string">      log syslog informational</span></span><br><span class="line"><span class="string">      !</span></span><br><span class="line"><span class="string">      router bgp &#123;&#123; FRR_AS &#125;&#125;</span></span><br><span class="line"><span class="string">       bgp router-id &#123;&#123; ansible_host &#125;&#125;</span></span><br><span class="line"><span class="string">       !</span></span><br><span class="line"><span class="string">       neighbor &#123;&#123; K8S_MASTER_IP &#125;&#125; remote-as &#123;&#123; CILIUM_BGP_AS &#125;&#125;</span></span><br><span class="line"><span class="string">       neighbor &#123;&#123; K8S_WORKER_1_IP &#125;&#125; remote-as &#123;&#123; CILIUM_BGP_AS &#125;&#125;</span></span><br><span class="line"><span class="string">       neighbor &#123;&#123; K8S_WORKER_2_IP &#125;&#125; remote-as &#123;&#123; CILIUM_BGP_AS &#125;&#125;</span></span><br><span class="line"><span class="string">       !</span></span><br><span class="line"><span class="string">       address-family ipv4 unicast</span></span><br><span class="line"><span class="string">        # Crucial: Redistribute BGP learned routes into the kernel</span></span><br><span class="line"><span class="string">        redistribute connected</span></span><br><span class="line"><span class="string">        redistribute static</span></span><br><span class="line"><span class="string">        redistribute kernel</span></span><br><span class="line"><span class="string">       exit-address-family</span></span><br><span class="line"><span class="string">      !</span></span><br><span class="line"><span class="string">      line vty</span></span><br><span class="line"><span class="string">      !</span></span><br><span class="line"><span class="string">    mode: &#x27;0644&#x27;</span></span><br><span class="line"><span class="string">  notify: Restart FRR service # Handler only runs if file content changes</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">- name: Set permissions for frr.conf</span></span><br><span class="line"><span class="string">  ansible.builtin.file:</span></span><br><span class="line"><span class="string">    path: /etc/frr/frr.conf</span></span><br><span class="line"><span class="string">    owner: frr</span></span><br><span class="line"><span class="string">    group: frr</span></span><br><span class="line"><span class="string">    mode: &#x27;0640&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">- name: Enable and start FRR service</span></span><br><span class="line"><span class="string">  ansible.builtin.systemd:</span></span><br><span class="line"><span class="string">    name: frr</span></span><br><span class="line"><span class="string">    state: started</span></span><br><span class="line"><span class="string">    enabled: yes</span></span><br><span class="line"><span class="string">    daemon_reload: yes # Ensure systemd reloads unit files if service file changed</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">mkdir</span> -p roles/frr_setup/handlers</span><br><span class="line">    <span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt; roles/frr_setup/handlers/main.yml</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">- name: Restart FRR service</span></span><br><span class="line"><span class="string">  ansible.builtin.systemd:</span></span><br><span class="line"><span class="string">    name: frr</span></span><br><span class="line"><span class="string">    state: restarted</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;FRR Ansible role created.&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- Main execution ---</span></span><br><span class="line">install_ansible</span><br><span class="line">create_project_dir</span><br><span class="line">create_ansible_cfg</span><br><span class="line">create_inventory</span><br><span class="line">create_playbook</span><br><span class="line">create_frr_role <span class="comment"># Changed function call</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;--- Ansible setup for FRR installation is complete! ---&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Navigate to the new project directory:&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;cd <span class="variable">$&#123;PROJECT_DIR&#125;</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Then, run the Ansible playbook to install and configure FRR on your VM:&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;ansible-playbook playbook.yml -K&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;After the playbook finishes, FRR should be running and configured on <span class="variable">$&#123;FRR_NODE_IP&#125;</span>.&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;You can SSH into the VM and verify with &#x27;sudo vtysh -c \&quot;show ip bgp summary\&quot;&#x27; and &#x27;sudo ip route show&#x27;.&quot;</span></span><br><span class="line"></span><br><span class="line">ois@ois:~/data/k8s$ ./ansible-frr.sh </span><br><span class="line">--- Installing Ansible ---</span><br><span class="line">Ansible is already installed.</span><br><span class="line">--- Creating project directory: ansible-frr-setup ---</span><br><span class="line">Created new directory: ansible-frr-setup</span><br><span class="line">Changed to directory: /home/ois/data/k8s/ansible-frr-setup</span><br><span class="line">--- Creating ansible.cfg ---</span><br><span class="line">ansible.cfg created.</span><br><span class="line">--- Creating inventory.ini ---</span><br><span class="line">inventory.ini created.</span><br><span class="line">--- Creating playbook.yml ---</span><br><span class="line">playbook.yml created.</span><br><span class="line">--- Creating Ansible role <span class="keyword">for</span> FRR setup ---</span><br><span class="line">FRR Ansible role created.</span><br><span class="line"></span><br><span class="line">--- Ansible setup <span class="keyword">for</span> FRR installation is complete! ---</span><br><span class="line">Navigate to the new project directory:</span><br><span class="line"><span class="built_in">cd</span> ansible-frr-setup</span><br><span class="line"></span><br><span class="line">Then, run the Ansible playbook to install and configure FRR on your VM:</span><br><span class="line">ansible-playbook playbook.yml -K</span><br><span class="line"></span><br><span class="line">After the playbook finishes, FRR should be running and configured on 10.75.59.76.</span><br><span class="line">You can SSH into the VM and verify with <span class="string">&#x27;sudo vtysh -c &quot;show ip bgp summary&quot;&#x27;</span> and <span class="string">&#x27;sudo ip route show&#x27;</span>.</span><br><span class="line">ois@ois:~/data/k8s$ <span class="built_in">cd</span> ansible-frr-setup/</span><br><span class="line">ois@ois:~/data/k8s/ansible-frr-setup$ ansible-playbook playbook.yml -K</span><br><span class="line">BECOME password: </span><br><span class="line"></span><br><span class="line">PLAY [Install and Configure FRRouting (FRR)] *******************************************************************************************************************************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] *****************************************************************************************************************************************************************************************************************************************</span><br><span class="line">ok: [frr-node-1]</span><br><span class="line"></span><br><span class="line">TASK [frr_setup : Install FRRouting (FRR)] *********************************************************************************************************************************************************************************************************************</span><br><span class="line">changed: [frr-node-1]</span><br><span class="line"></span><br><span class="line">TASK [frr_setup : Configure FRR daemons (<span class="built_in">enable</span> zebra and bgpd)] ***********************************************************************************************************************************************************************************************</span><br><span class="line">changed: [frr-node-1]</span><br><span class="line"></span><br><span class="line">TASK [frr_setup : Configure frr.conf] **************************************************************************************************************************************************************************************************************************</span><br><span class="line">changed: [frr-node-1]</span><br><span class="line"></span><br><span class="line">TASK [frr_setup : Set permissions <span class="keyword">for</span> frr.conf] ****************************************************************************************************************************************************************************************************************</span><br><span class="line">changed: [frr-node-1]</span><br><span class="line"></span><br><span class="line">TASK [frr_setup : Enable and start FRR service] ****************************************************************************************************************************************************************************************************************</span><br><span class="line">ok: [frr-node-1]</span><br><span class="line"></span><br><span class="line">RUNNING HANDLER [frr_setup : Restart FRR service] **************************************************************************************************************************************************************************************************************</span><br><span class="line">changed: [frr-node-1]</span><br><span class="line"></span><br><span class="line">PLAY RECAP *****************************************************************************************************************************************************************************************************************************************************</span><br><span class="line">frr-node-1                 : ok=7    changed=5    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line">root@dns-server-vm:~<span class="comment"># cat /etc/frr/frr.conf </span></span><br><span class="line">!</span><br><span class="line">hostname dns-server-vm</span><br><span class="line">password zebra</span><br><span class="line"><span class="built_in">enable</span> password zebra</span><br><span class="line">!</span><br><span class="line"><span class="built_in">log</span> syslog informational</span><br><span class="line">!</span><br><span class="line">router bgp 65000</span><br><span class="line"> bgp router-id 10.75.59.76</span><br><span class="line"> !</span><br><span class="line"> neighbor 10.75.59.71 remote-as 65000</span><br><span class="line"> neighbor 10.75.59.72 remote-as 65000</span><br><span class="line"> neighbor 10.75.59.73 remote-as 65000</span><br><span class="line"> !</span><br><span class="line"> address-family ipv4 unicast</span><br><span class="line">  <span class="comment"># Crucial: Redistribute BGP learned routes into the kernel</span></span><br><span class="line">  redistribute connected</span><br><span class="line">  redistribute static</span><br><span class="line">  redistribute kernel</span><br><span class="line"> exit-address-family</span><br><span class="line">!</span><br><span class="line">line vty</span><br><span class="line">!</span><br><span class="line">root@dns-server-vm:~<span class="comment"># systemctl status frr</span></span><br><span class="line">* frr.service - FRRouting</span><br><span class="line">     Loaded: loaded (/usr/lib/systemd/system/frr.service; enabled; preset: enabled)</span><br><span class="line">     Active: active (running) since Wed 2025-07-23 12:16:58 JST; 1 week 1 day ago</span><br><span class="line">       Docs: https://frrouting.readthedocs.io/en/latest/setup.html</span><br><span class="line">    Process: 15611 ExecStart=/usr/lib/frr/frrinit.sh start (code=exited, status=0/SUCCESS)</span><br><span class="line">   Main PID: 15623 (watchfrr)</span><br><span class="line">     Status: <span class="string">&quot;FRR Operational&quot;</span></span><br><span class="line">      Tasks: 13 (<span class="built_in">limit</span>: 9486)</span><br><span class="line">     Memory: 21.1M (peak: 28.3M)</span><br><span class="line">        CPU: 5min 23.845s</span><br><span class="line">     CGroup: /system.slice/frr.service</span><br><span class="line">             |-15623 /usr/lib/frr/watchfrr -d -F traditional zebra bgpd staticd</span><br><span class="line">             |-15636 /usr/lib/frr/zebra -d -F traditional -A 127.0.0.1 -s 90000000</span><br><span class="line">             |-15641 /usr/lib/frr/bgpd -d -F traditional -A 127.0.0.1</span><br><span class="line">             `-15648 /usr/lib/frr/staticd -d -F traditional -A 127.0.0.1</span><br><span class="line"></span><br><span class="line">Jul 31 16:26:25 dns-server-vm bgpd[15641]: [M59KS-A3ZXZ] bgp_update_receive: rcvd End-of-RIB <span class="keyword">for</span> IPv4 Unicast from 10.75.59.71 <span class="keyword">in</span> vrf default</span><br><span class="line">Jul 31 16:27:24 dns-server-vm bgpd[15641]: [M59KS-A3ZXZ] bgp_update_receive: rcvd End-of-RIB <span class="keyword">for</span> IPv4 Unicast from 10.75.59.73 <span class="keyword">in</span> vrf default</span><br><span class="line">Jul 31 16:27:24 dns-server-vm bgpd[15641]: [M59KS-A3ZXZ] bgp_update_receive: rcvd End-of-RIB <span class="keyword">for</span> IPv4 Unicast from 10.75.59.72 <span class="keyword">in</span> vrf default</span><br><span class="line">Jul 31 16:27:24 dns-server-vm bgpd[15641]: [M59KS-A3ZXZ] bgp_update_receive: rcvd End-of-RIB <span class="keyword">for</span> IPv4 Unicast from 10.75.59.71 <span class="keyword">in</span> vrf default</span><br><span class="line">Jul 31 16:46:48 dns-server-vm bgpd[15641]: [M59KS-A3ZXZ] bgp_update_receive: rcvd End-of-RIB <span class="keyword">for</span> IPv4 Unicast from 10.75.59.72 <span class="keyword">in</span> vrf default</span><br><span class="line">Jul 31 16:46:48 dns-server-vm bgpd[15641]: [M59KS-A3ZXZ] bgp_update_receive: rcvd End-of-RIB <span class="keyword">for</span> IPv4 Unicast from 10.75.59.73 <span class="keyword">in</span> vrf default</span><br><span class="line">Jul 31 16:46:48 dns-server-vm bgpd[15641]: [M59KS-A3ZXZ] bgp_update_receive: rcvd End-of-RIB <span class="keyword">for</span> IPv4 Unicast from 10.75.59.71 <span class="keyword">in</span> vrf default</span><br><span class="line">Jul 31 16:47:54 dns-server-vm bgpd[15641]: [M59KS-A3ZXZ] bgp_update_receive: rcvd End-of-RIB <span class="keyword">for</span> IPv4 Unicast from 10.75.59.73 <span class="keyword">in</span> vrf default</span><br><span class="line">Jul 31 16:47:54 dns-server-vm bgpd[15641]: [M59KS-A3ZXZ] bgp_update_receive: rcvd End-of-RIB <span class="keyword">for</span> IPv4 Unicast from 10.75.59.72 <span class="keyword">in</span> vrf default</span><br><span class="line">Jul 31 16:47:54 dns-server-vm bgpd[15641]: [M59KS-A3ZXZ] bgp_update_receive: rcvd End-of-RIB <span class="keyword">for</span> IPv4 Unicast from 10.75.59.71 <span class="keyword">in</span> vrf default</span><br><span class="line">root@dns-server-vm:~<span class="comment"># ip route show</span></span><br><span class="line">default via 10.75.59.1 dev enp1s0 proto static </span><br><span class="line">10.75.59.0/24 dev enp1s0 proto kernel scope <span class="built_in">link</span> src 10.75.59.76 </span><br><span class="line">172.16.0.0/24 nhid 95 via 10.75.59.71 dev enp1s0 proto bgp metric 20 </span><br><span class="line">172.16.1.0/24 nhid 90 via 10.75.59.72 dev enp1s0 proto bgp metric 20 </span><br><span class="line">172.16.2.0/24 nhid 100 via 10.75.59.73 dev enp1s0 proto bgp metric 20 </span><br><span class="line">172.16.16.1 nhid 202 proto bgp metric 20 </span><br><span class="line">        nexthop via 10.75.59.72 dev enp1s0 weight 1 </span><br><span class="line">        nexthop via 10.75.59.71 dev enp1s0 weight 1 </span><br><span class="line">        nexthop via 10.75.59.73 dev enp1s0 weight 1 </span><br><span class="line">172.16.16.10 nhid 202 proto bgp metric 20 </span><br><span class="line">        nexthop via 10.75.59.72 dev enp1s0 weight 1 </span><br><span class="line">        nexthop via 10.75.59.71 dev enp1s0 weight 1 </span><br><span class="line">        nexthop via 10.75.59.73 dev enp1s0 weight 1 </span><br><span class="line">172.16.20.119 nhid 202 proto bgp metric 20 </span><br><span class="line">        nexthop via 10.75.59.72 dev enp1s0 weight 1 </span><br><span class="line">        nexthop via 10.75.59.71 dev enp1s0 weight 1 </span><br><span class="line">        nexthop via 10.75.59.73 dev enp1s0 weight 1 </span><br><span class="line">172.16.22.26 nhid 202 proto bgp metric 20 </span><br><span class="line">        nexthop via 10.75.59.72 dev enp1s0 weight 1 </span><br><span class="line">        nexthop via 10.75.59.71 dev enp1s0 weight 1 </span><br><span class="line">        nexthop via 10.75.59.73 dev enp1s0 weight 1 </span><br><span class="line">172.16.23.18 nhid 202 proto bgp metric 20 </span><br><span class="line">        nexthop via 10.75.59.72 dev enp1s0 weight 1 </span><br><span class="line">        nexthop via 10.75.59.71 dev enp1s0 weight 1 </span><br><span class="line">        nexthop via 10.75.59.73 dev enp1s0 weight 1 </span><br><span class="line">172.16.30.170 nhid 202 proto bgp metric 20 </span><br><span class="line">        nexthop via 10.75.59.72 dev enp1s0 weight 1 </span><br><span class="line">        nexthop via 10.75.59.71 dev enp1s0 weight 1 </span><br><span class="line">        nexthop via 10.75.59.73 dev enp1s0 weight 1 </span><br><span class="line">root@dns-server-vm:~<span class="comment"># vtysh -c &#x27;show ip bgp summary&#x27;</span></span><br><span class="line"></span><br><span class="line">IPv4 Unicast Summary (VRF default):</span><br><span class="line">BGP router identifier 10.75.59.76, <span class="built_in">local</span> AS number 65000 vrf-id 0</span><br><span class="line">BGP table version 222</span><br><span class="line">RIB entries 19, using 3648 bytes of memory</span><br><span class="line">Peers 3, using 2172 KiB of memory</span><br><span class="line"></span><br><span class="line">Neighbor        V         AS   MsgRcvd   MsgSent   TblVer  InQ OutQ  Up/Down State/PfxRcd   PfxSnt Desc</span><br><span class="line">10.75.59.71     4      65000     71265     71182        0    0    0 03:21:08            7        2 N/A</span><br><span class="line">10.75.59.72     4      65000     71344     71264        0    0    0 03:21:09            7        2 N/A</span><br><span class="line">10.75.59.73     4      65000     71240     71162        0    0    0 03:21:09            7        2 N/A</span><br><span class="line"></span><br><span class="line">Total number of neighbors 3</span><br></pre></td></tr></table></figure>

<h1 id="4-设置Kubernetes集群并安装CNI-Cilium"><a href="#4-设置Kubernetes集群并安装CNI-Cilium" class="headerlink" title="4. 设置Kubernetes集群并安装CNI Cilium"></a>4. 设置Kubernetes集群并安装CNI Cilium</h1><h2 id="4-1-使用kubeadm设置Kubernetes"><a href="#4-1-使用kubeadm设置Kubernetes" class="headerlink" title="4.1 使用kubeadm设置Kubernetes"></a>4.1 使用kubeadm设置Kubernetes</h2><p>使用以下命令进行集群初始化</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">kubeadm config images pull</span><br><span class="line"></span><br><span class="line">kubeadm init --control-plane-endpoint=kube-node-1 --pod-network-cidr=172.16.0.0/20 --service-cidr=172.16.32.0/20 --skip-phases=addon/kube-proxy</span><br><span class="line"></span><br><span class="line">--skip-phases=addon/kube-proxy 表示不安装kube-proxy，会用Cilium进行替代</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line">ubuntu@kube-node-1:~$ sudo kubeadm init --control-plane-endpoint=kube-node-1 --pod-network-cidr=172.16.0.0/20 --service-cidr=172.16.32.0/20 --skip-phases=addon/kube-proxy[sudo] password <span class="keyword">for</span> ubuntu: </span><br><span class="line">[init] Using Kubernetes version: v1.33.3</span><br><span class="line">[preflight] Running pre-flight checks</span><br><span class="line">[preflight] Pulling images required <span class="keyword">for</span> setting up a Kubernetes cluster</span><br><span class="line">[preflight] This might take a minute or two, depending on the speed of your internet connection</span><br><span class="line">[preflight] You can also perform this action beforehand using <span class="string">&#x27;kubeadm config images pull&#x27;</span></span><br><span class="line">[certs] Using certificateDir folder <span class="string">&quot;/etc/kubernetes/pki&quot;</span></span><br><span class="line">[certs] Generating <span class="string">&quot;ca&quot;</span> certificate and key</span><br><span class="line">[certs] Generating <span class="string">&quot;apiserver&quot;</span> certificate and key</span><br><span class="line">[certs] apiserver serving cert is signed <span class="keyword">for</span> DNS names [kube-node-1 kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local] and IPs [10.248.0.1 10.75.59.71]</span><br><span class="line">[certs] Generating <span class="string">&quot;apiserver-kubelet-client&quot;</span> certificate and key</span><br><span class="line">[certs] Generating <span class="string">&quot;front-proxy-ca&quot;</span> certificate and key</span><br><span class="line">[certs] Generating <span class="string">&quot;front-proxy-client&quot;</span> certificate and key</span><br><span class="line">[certs] Generating <span class="string">&quot;etcd/ca&quot;</span> certificate and key</span><br><span class="line">[certs] Generating <span class="string">&quot;etcd/server&quot;</span> certificate and key</span><br><span class="line">[certs] etcd/server serving cert is signed <span class="keyword">for</span> DNS names [kube-node-1 localhost] and IPs [10.75.59.71 127.0.0.1 ::1]</span><br><span class="line">[certs] Generating <span class="string">&quot;etcd/peer&quot;</span> certificate and key</span><br><span class="line">[certs] etcd/peer serving cert is signed <span class="keyword">for</span> DNS names [kube-node-1 localhost] and IPs [10.75.59.71 127.0.0.1 ::1]</span><br><span class="line">[certs] Generating <span class="string">&quot;etcd/healthcheck-client&quot;</span> certificate and key</span><br><span class="line">[certs] Generating <span class="string">&quot;apiserver-etcd-client&quot;</span> certificate and key</span><br><span class="line">[certs] Generating <span class="string">&quot;sa&quot;</span> key and public key</span><br><span class="line">[kubeconfig] Using kubeconfig folder <span class="string">&quot;/etc/kubernetes&quot;</span></span><br><span class="line">[kubeconfig] Writing <span class="string">&quot;admin.conf&quot;</span> kubeconfig file</span><br><span class="line">[kubeconfig] Writing <span class="string">&quot;super-admin.conf&quot;</span> kubeconfig file</span><br><span class="line">[kubeconfig] Writing <span class="string">&quot;kubelet.conf&quot;</span> kubeconfig file</span><br><span class="line">[kubeconfig] Writing <span class="string">&quot;controller-manager.conf&quot;</span> kubeconfig file</span><br><span class="line">[kubeconfig] Writing <span class="string">&quot;scheduler.conf&quot;</span> kubeconfig file</span><br><span class="line">[etcd] Creating static Pod manifest <span class="keyword">for</span> <span class="built_in">local</span> etcd <span class="keyword">in</span> <span class="string">&quot;/etc/kubernetes/manifests&quot;</span></span><br><span class="line">[control-plane] Using manifest folder <span class="string">&quot;/etc/kubernetes/manifests&quot;</span></span><br><span class="line">[control-plane] Creating static Pod manifest <span class="keyword">for</span> <span class="string">&quot;kube-apiserver&quot;</span></span><br><span class="line">[control-plane] Creating static Pod manifest <span class="keyword">for</span> <span class="string">&quot;kube-controller-manager&quot;</span></span><br><span class="line">[control-plane] Creating static Pod manifest <span class="keyword">for</span> <span class="string">&quot;kube-scheduler&quot;</span></span><br><span class="line">[kubelet-start] Writing kubelet environment file with flags to file <span class="string">&quot;/var/lib/kubelet/kubeadm-flags.env&quot;</span></span><br><span class="line">[kubelet-start] Writing kubelet configuration to file <span class="string">&quot;/var/lib/kubelet/config.yaml&quot;</span></span><br><span class="line">[kubelet-start] Starting the kubelet</span><br><span class="line">[wait-control-plane] Waiting <span class="keyword">for</span> the kubelet to boot up the control plane as static Pods from directory <span class="string">&quot;/etc/kubernetes/manifests&quot;</span></span><br><span class="line">[kubelet-check] Waiting <span class="keyword">for</span> a healthy kubelet at http://127.0.0.1:10248/healthz. This can take up to 4m0s</span><br><span class="line">[kubelet-check] The kubelet is healthy after 1.002649961s</span><br><span class="line">[control-plane-check] Waiting <span class="keyword">for</span> healthy control plane components. This can take up to 4m0s</span><br><span class="line">[control-plane-check] Checking kube-apiserver at https://10.75.59.71:6443/livez</span><br><span class="line">[control-plane-check] Checking kube-controller-manager at https://127.0.0.1:10257/healthz</span><br><span class="line">[control-plane-check] Checking kube-scheduler at https://127.0.0.1:10259/livez</span><br><span class="line">[control-plane-check] kube-controller-manager is healthy after 1.813351787s</span><br><span class="line">[control-plane-check] kube-scheduler is healthy after 3.309147352s</span><br><span class="line">[control-plane-check] kube-apiserver is healthy after 5.505049123s</span><br><span class="line">[upload-config] Storing the configuration used <span class="keyword">in</span> ConfigMap <span class="string">&quot;kubeadm-config&quot;</span> <span class="keyword">in</span> the <span class="string">&quot;kube-system&quot;</span> Namespace</span><br><span class="line">[kubelet] Creating a ConfigMap <span class="string">&quot;kubelet-config&quot;</span> <span class="keyword">in</span> namespace kube-system with the configuration <span class="keyword">for</span> the kubelets <span class="keyword">in</span> the cluster</span><br><span class="line">[upload-certs] Skipping phase. Please see --upload-certs</span><br><span class="line">[mark-control-plane] Marking the node kube-node-1 as control-plane by adding the labels: [node-role.kubernetes.io/control-plane node.kubernetes.io/exclude-from-external-load-balancers]</span><br><span class="line">[mark-control-plane] Marking the node kube-node-1 as control-plane by adding the taints [node-role.kubernetes.io/control-plane:NoSchedule]</span><br><span class="line">[bootstrap-token] Using token: 1r5ugd.o2pjzipcq69z71l8</span><br><span class="line">[bootstrap-token] Configuring bootstrap tokens, cluster-info ConfigMap, RBAC Roles</span><br><span class="line">[bootstrap-token] Configured RBAC rules to allow Node Bootstrap tokens to get nodes</span><br><span class="line">[bootstrap-token] Configured RBAC rules to allow Node Bootstrap tokens to post CSRs <span class="keyword">in</span> order <span class="keyword">for</span> nodes to get long term certificate credentials</span><br><span class="line">[bootstrap-token] Configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token</span><br><span class="line">[bootstrap-token] Configured RBAC rules to allow certificate rotation <span class="keyword">for</span> all node client certificates <span class="keyword">in</span> the cluster</span><br><span class="line">[bootstrap-token] Creating the <span class="string">&quot;cluster-info&quot;</span> ConfigMap <span class="keyword">in</span> the <span class="string">&quot;kube-public&quot;</span> namespace</span><br><span class="line">[kubelet-finalize] Updating <span class="string">&quot;/etc/kubernetes/kubelet.conf&quot;</span> to point to a rotatable kubelet client certificate and key</span><br><span class="line">[addons] Applied essential addon: CoreDNS</span><br><span class="line"></span><br><span class="line">Your Kubernetes control-plane has initialized successfully!</span><br><span class="line"></span><br><span class="line">To start using your cluster, you need to run the following as a regular user:</span><br><span class="line"></span><br><span class="line">  <span class="built_in">mkdir</span> -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">  sudo <span class="built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">  sudo <span class="built_in">chown</span> $(<span class="built_in">id</span> -u):$(<span class="built_in">id</span> -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line"></span><br><span class="line">Alternatively, <span class="keyword">if</span> you are the root user, you can run:</span><br><span class="line"></span><br><span class="line">  <span class="built_in">export</span> KUBECONFIG=/etc/kubernetes/admin.conf</span><br><span class="line"></span><br><span class="line">You should now deploy a pod network to the cluster.</span><br><span class="line">Run <span class="string">&quot;kubectl apply -f [podnetwork].yaml&quot;</span> with one of the options listed at:</span><br><span class="line">  https://kubernetes.io/docs/concepts/cluster-administration/addons/</span><br><span class="line"></span><br><span class="line">You can now <span class="built_in">join</span> any number of control-plane nodes by copying certificate authorities</span><br><span class="line">and service account keys on each node and <span class="keyword">then</span> running the following as root:</span><br><span class="line"></span><br><span class="line">  kubeadm <span class="built_in">join</span> kube-node-1:6443 --token 1r5ugd.o2pjzipcq69z71l8 \</span><br><span class="line">        --discovery-token-ca-cert-hash sha256:e29fb62581a4d21268585c3b345f9e060827c52a8325b1d28b8437c792ba7923 \</span><br><span class="line">        --control-plane </span><br><span class="line"></span><br><span class="line">Then you can <span class="built_in">join</span> any number of worker nodes by running the following on each as root:</span><br><span class="line"></span><br><span class="line">kubeadm <span class="built_in">join</span> kube-node-1:6443 --token 1r5ugd.o2pjzipcq69z71l8 \</span><br><span class="line">        --discovery-token-ca-cert-hash sha256:e29fb62581a4d21268585c3b345f9e060827c52a8325b1d28b8437c792ba7923 </span><br><span class="line">ubuntu@kube-node-1:~$ </span><br><span class="line">ubuntu@kube-node-1:~$   <span class="built_in">mkdir</span> -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">  sudo <span class="built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">  sudo <span class="built_in">chown</span> $(<span class="built_in">id</span> -u):$(<span class="built_in">id</span> -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">ubuntu@kube-node-1:~$ sudo su</span><br><span class="line">root@kube-node-1:/home/ubuntu<span class="comment"># cd</span></span><br><span class="line"></span><br><span class="line">在.bashrc 中增加以下内容</span><br><span class="line">root@kube-node-1:~<span class="comment"># cat .bashrc | grep export</span></span><br><span class="line"><span class="built_in">export</span> KUBECONFIG=/etc/kubernetes/admin.conf</span><br><span class="line"></span><br><span class="line">这样root才能执行 kubectl 命令与 api-server通信.</span><br><span class="line"></span><br><span class="line">root@kube-node-1:~<span class="comment"># kubectl cluster-info</span></span><br><span class="line">Kubernetes control plane is running at https://kube-node-1:6443</span><br><span class="line">CoreDNS is running at https://kube-node-1:6443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy</span><br><span class="line"></span><br><span class="line">To further debug and diagnose cluster problems, use <span class="string">&#x27;kubectl cluster-info dump&#x27;</span>.</span><br><span class="line">root@kube-node-1:~<span class="comment"># kubectl get node -o wide</span></span><br><span class="line">NAME          STATUS     ROLES           AGE   VERSION   INTERNAL-IP   EXTERNAL-IP   OS-IMAGE             KERNEL-VERSION     CONTAINER-RUNTIME</span><br><span class="line">kube-node-1   NotReady   control-plane   68s   v1.33.3   10.75.59.71   &lt;none&gt;        Ubuntu 24.04.2 LTS   6.8.0-63-generic   containerd://1.7.27</span><br><span class="line"></span><br><span class="line">还没有安装CNI，Node NotReady</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="4-2-使用Ansible安装Helm"><a href="#4-2-使用Ansible安装Helm" class="headerlink" title="4.2 使用Ansible安装Helm"></a>4.2 使用Ansible安装Helm</h2><p>设置Helm的目的是为了安装Cilium，并非一定要使用Ansible来进行设置，供参考。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># This script automates the setup of an Ansible environment for installing Helm.</span></span><br><span class="line"><span class="comment"># It creates the project directory, inventory, configuration, and the playbook</span></span><br><span class="line"><span class="comment"># with an idempotent role to install Helm.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- Configuration ---</span></span><br><span class="line">PROJECT_DIR=<span class="string">&quot;ansible-helm&quot;</span></span><br><span class="line">MASTER_NODE_IP=<span class="string">&quot;10.75.59.71&quot;</span> <span class="comment"># IP address of your Kubernetes master node (kube-node-1)</span></span><br><span class="line">ANSIBLE_USER=<span class="string">&quot;ubuntu&quot;</span> <span class="comment"># The user created by cloud-init on your VMs</span></span><br><span class="line">SSH_PRIVATE_KEY_PATH=<span class="string">&quot;~/.ssh/id_rsa&quot;</span> <span class="comment"># Path to your SSH private key on the Ansible control machine</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Helm version to install</span></span><br><span class="line">HELM_VERSION=<span class="string">&quot;v3.18.4&quot;</span> <span class="comment"># You can change this to a desired stable version</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- Functions ---</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Function to create project directory and navigate into it</span></span><br><span class="line"><span class="function"><span class="title">create_project_dir</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;--- Creating project directory: <span class="variable">$&#123;PROJECT_DIR&#125;</span> ---&quot;</span></span><br><span class="line">    <span class="comment"># Check if directory exists, if so, just navigate, otherwise create and navigate</span></span><br><span class="line">    <span class="keyword">if</span> [ ! -d <span class="string">&quot;<span class="variable">$&#123;PROJECT_DIR&#125;</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">mkdir</span> -p <span class="string">&quot;<span class="variable">$&#123;PROJECT_DIR&#125;</span>&quot;</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Created new directory: <span class="variable">$&#123;PROJECT_DIR&#125;</span>&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Directory <span class="variable">$&#123;PROJECT_DIR&#125;</span> already exists.&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="built_in">cd</span> <span class="string">&quot;<span class="variable">$&#123;PROJECT_DIR&#125;</span>&quot;</span> || &#123; <span class="built_in">echo</span> <span class="string">&quot;Failed to change directory to <span class="variable">$&#123;PROJECT_DIR&#125;</span>. Exiting.&quot;</span>; <span class="built_in">exit</span> 1; &#125;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Changed to directory: <span class="subst">$(pwd)</span>&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Function to create ansible.cfg</span></span><br><span class="line"><span class="function"><span class="title">create_ansible_cfg</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;--- Creating ansible.cfg ---&quot;</span></span><br><span class="line">    <span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt; ansible.cfg</span></span><br><span class="line"><span class="string">[defaults]</span></span><br><span class="line"><span class="string">inventory = inventory.ini</span></span><br><span class="line"><span class="string">roles_path = ./roles</span></span><br><span class="line"><span class="string">host_key_checking = False # WARNING: Disable host key checking for convenience. Re-enable for production!</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;ansible.cfg created.&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Function to create inventory.ini</span></span><br><span class="line"><span class="function"><span class="title">create_inventory</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;--- Creating inventory.ini ---&quot;</span></span><br><span class="line">    <span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt; inventory.ini</span></span><br><span class="line"><span class="string">[kubernetes_master]</span></span><br><span class="line"><span class="string">kube-node-1 ansible_host=$&#123;MASTER_NODE_IP&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[all:vars]</span></span><br><span class="line"><span class="string">ansible_user=$&#123;ANSIBLE_USER&#125;</span></span><br><span class="line"><span class="string">ansible_ssh_private_key_file=$&#123;SSH_PRIVATE_KEY_PATH&#125;</span></span><br><span class="line"><span class="string">ansible_python_interpreter=/usr/bin/python3</span></span><br><span class="line"><span class="string">HELM_VERSION=$&#123;HELM_VERSION&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;inventory.ini created.&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Function to create the main playbook.yml</span></span><br><span class="line"><span class="function"><span class="title">create_playbook</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;--- Creating playbook.yml ---&quot;</span></span><br><span class="line">    <span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt; playbook.yml</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">- name: Install Helm on Kubernetes Master Node</span></span><br><span class="line"><span class="string">  hosts: kubernetes_master</span></span><br><span class="line"><span class="string">  become: yes</span></span><br><span class="line"><span class="string">  environment: # Ensure KUBECONFIG is set for helm commands run with become</span></span><br><span class="line"><span class="string">    KUBECONFIG: /etc/kubernetes/admin.conf # Use the admin kubeconfig on the master</span></span><br><span class="line"><span class="string">  roles:</span></span><br><span class="line"><span class="string">    - helm_install</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;playbook.yml created.&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Function to create the Helm installation role (with idempotent check)</span></span><br><span class="line"><span class="function"><span class="title">create_helm_role</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;--- Creating Ansible role for Helm installation ---&quot;</span></span><br><span class="line">    <span class="built_in">mkdir</span> -p roles/helm_install/tasks</span><br><span class="line">    <span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt; roles/helm_install/tasks/main.yml</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">- name: Check if Helm is installed and get version</span></span><br><span class="line"><span class="string">  ansible.builtin.command: helm version --short</span></span><br><span class="line"><span class="string">  register: helm_version_raw</span></span><br><span class="line"><span class="string">  ignore_errors: yes</span></span><br><span class="line"><span class="string">  changed_when: false</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">- name: Set installed Helm version fact</span></span><br><span class="line"><span class="string">  ansible.builtin.set_fact:</span></span><br><span class="line"><span class="string">    installed_helm_version: &quot;&#123;&#123; (helm_version_raw.stdout | default(&#x27;&#x27;) | regex_findall(&#x27;^(v[0-9]+\\\\.[0-9]+\\\\.[0-9]+)&#x27;) | first | default(&#x27;&#x27;) | trim) &#125;&#125;&quot;</span></span><br><span class="line"><span class="string">  changed_when: false</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">- name: Debug installed Helm version</span></span><br><span class="line"><span class="string">  ansible.builtin.debug:</span></span><br><span class="line"><span class="string">    msg: &quot;Current installed Helm version: &#123;&#123; installed_helm_version | default(&#x27;Not installed&#x27;) &#125;&#125;&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">- name: Debug raw Helm version output</span></span><br><span class="line"><span class="string">  ansible.builtin.debug:</span></span><br><span class="line"><span class="string">    msg: &quot;Raw Helm version output: &#123;&#123; helm_version_raw.stdout | default(&#x27;No output&#x27;) &#125;&#125;&quot;</span></span><br><span class="line"><span class="string">  when: helm_version_raw.stdout is defined and helm_version_raw.stdout | length &gt; 0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">- name: Check if Helm binary exists</span></span><br><span class="line"><span class="string">  ansible.builtin.stat:</span></span><br><span class="line"><span class="string">    path: /usr/local/bin/helm</span></span><br><span class="line"><span class="string">  register: helm_binary_stat</span></span><br><span class="line"><span class="string">  when: installed_helm_version == HELM_VERSION</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">- name: Download Helm tarball</span></span><br><span class="line"><span class="string">  ansible.builtin.get_url:</span></span><br><span class="line"><span class="string">    url: &quot;https://get.helm.sh/helm-&#123;&#123; HELM_VERSION &#125;&#125;-linux-amd64.tar.gz&quot;</span></span><br><span class="line"><span class="string">    dest: &quot;/tmp/helm-&#123;&#123; HELM_VERSION &#125;&#125;-linux-amd64.tar.gz&quot;</span></span><br><span class="line"><span class="string">    mode: &#x27;0644&#x27;</span></span><br><span class="line"><span class="string">    checksum: &quot;sha256:&#123;&#123; lookup(&#x27;url&#x27;, &#x27;https://get.helm.sh/helm-&#123;&#123; HELM_VERSION &#125;&#125;-linux-amd64.tar.gz.sha256sum&#x27;, wantlist=True)[0].split(&#x27; &#x27;)[0] &#125;&#125;&quot;</span></span><br><span class="line"><span class="string">  register: download_helm_result</span></span><br><span class="line"><span class="string">  until: download_helm_result is success</span></span><br><span class="line"><span class="string">  retries: 5</span></span><br><span class="line"><span class="string">  delay: 5</span></span><br><span class="line"><span class="string">  when: installed_helm_version != HELM_VERSION or not helm_binary_stat.stat.exists</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">- name: Create Helm installation directory</span></span><br><span class="line"><span class="string">  ansible.builtin.file:</span></span><br><span class="line"><span class="string">    path: /usr/local/bin</span></span><br><span class="line"><span class="string">    state: directory</span></span><br><span class="line"><span class="string">    mode: &#x27;0755&#x27;</span></span><br><span class="line"><span class="string">  when: installed_helm_version != HELM_VERSION or not helm_binary_stat.stat.exists</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">- name: Extract Helm binary</span></span><br><span class="line"><span class="string">  ansible.builtin.unarchive:</span></span><br><span class="line"><span class="string">    src: &quot;/tmp/helm-&#123;&#123; HELM_VERSION &#125;&#125;-linux-amd64.tar.gz&quot;</span></span><br><span class="line"><span class="string">    dest: &quot;/tmp&quot;</span></span><br><span class="line"><span class="string">    remote_src: yes</span></span><br><span class="line"><span class="string">    creates: &quot;/tmp/linux-amd64/helm&quot;</span></span><br><span class="line"><span class="string">  when: installed_helm_version != HELM_VERSION or not helm_binary_stat.stat.exists</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">- name: Move Helm binary to /usr/local/bin</span></span><br><span class="line"><span class="string">  ansible.builtin.copy:</span></span><br><span class="line"><span class="string">    src: &quot;/tmp/linux-amd64/helm&quot;</span></span><br><span class="line"><span class="string">    dest: &quot;/usr/local/bin/helm&quot;</span></span><br><span class="line"><span class="string">    mode: &#x27;0755&#x27;</span></span><br><span class="line"><span class="string">    remote_src: yes</span></span><br><span class="line"><span class="string">    owner: root</span></span><br><span class="line"><span class="string">    group: root</span></span><br><span class="line"><span class="string">  when: installed_helm_version != HELM_VERSION or not helm_binary_stat.stat.exists</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">- name: Clean up Helm tarball and extracted directory</span></span><br><span class="line"><span class="string">  ansible.builtin.file:</span></span><br><span class="line"><span class="string">    path: &quot;&#123;&#123; item &#125;&#125;&quot;</span></span><br><span class="line"><span class="string">    state: absent</span></span><br><span class="line"><span class="string">  loop:</span></span><br><span class="line"><span class="string">    - &quot;/tmp/helm-&#123;&#123; HELM_VERSION &#125;&#125;-linux-amd64.tar.gz&quot;</span></span><br><span class="line"><span class="string">    - &quot;/tmp/linux-amd64&quot;</span></span><br><span class="line"><span class="string">  when: installed_helm_version != HELM_VERSION or not helm_binary_stat.stat.exists</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">- name: Verify Helm installation</span></span><br><span class="line"><span class="string">  ansible.builtin.command: helm version --client</span></span><br><span class="line"><span class="string">  register: helm_version_output</span></span><br><span class="line"><span class="string">  changed_when: false</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">- name: Display Helm version</span></span><br><span class="line"><span class="string">  ansible.builtin.debug:</span></span><br><span class="line"><span class="string">    msg: &quot;&#123;&#123; helm_version_output.stdout &#125;&#125;&quot;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Helm installation role created.&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- Main execution ---</span></span><br><span class="line">create_project_dir</span><br><span class="line">create_ansible_cfg</span><br><span class="line">create_inventory</span><br><span class="line">create_playbook</span><br><span class="line">create_helm_role</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;--- Ansible setup for Helm installation is complete! ---&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Navigate to the new project directory:&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;cd <span class="variable">$&#123;PROJECT_DIR&#125;</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Then, run the Ansible playbook to install only Helm on your master node:&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;ansible-playbook playbook.yml -K&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;After Helm is installed, you can SSH into your master node (kube-node-1) and manage Cilium Enterprise installation directly using Helm.&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Remember to use the correct Cilium chart version and your custom values file.&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Example steps for manual Cilium installation via Helm:&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;ssh ubuntu@<span class="variable">$&#123;MASTER_NODE_IP&#125;</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;sudo helm repo add cilium https://helm.cilium.io/&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;sudo helm repo add isovalent https://helm.isovalent.com&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;sudo helm repo update&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;sudo helm install cilium isovalent/cilium --version 1.17.6 --namespace kube-system -f &lt;path_to_your_cilium_values_file.yaml&gt; --wait&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Example content for /tmp/cilium-enterprise-values.yaml:&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;hubble:&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;  enabled: true&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;  relay:&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;    enabled: true&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;  ui:&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;    enabled: false&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;kubeProxyReplacement: strict&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;ipam:&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;  mode: kubernetes&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;ipv4NativeRoutingCIDR: 10.244.0.0/16&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;k8s:&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;  requireIPv4PodCIDR: true&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;routingMode: native&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;autoDirectNodeRoutes: false&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;bgpControlPlane:&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;  enabled: true&quot;</span></span><br></pre></td></tr></table></figure>

<p>执行效果如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line">ois@ois:~/data/k8s$ ./ansible-helm.sh </span><br><span class="line">--- Creating project directory: ansible-helm ---</span><br><span class="line">Created new directory: ansible-helm</span><br><span class="line">Changed to directory: /home/ois/data/k8s/ansible-helm</span><br><span class="line">--- Creating ansible.cfg ---</span><br><span class="line">ansible.cfg created.</span><br><span class="line">--- Creating inventory.ini ---</span><br><span class="line">inventory.ini created.</span><br><span class="line">--- Creating playbook.yml ---</span><br><span class="line">playbook.yml created.</span><br><span class="line">--- Creating Ansible role <span class="keyword">for</span> Helm installation ---</span><br><span class="line">Helm installation role created.</span><br><span class="line"></span><br><span class="line">--- Ansible setup <span class="keyword">for</span> Helm installation is complete! ---</span><br><span class="line">Navigate to the new project directory:</span><br><span class="line"><span class="built_in">cd</span> ansible-helm</span><br><span class="line"></span><br><span class="line">Then, run the Ansible playbook to install only Helm on your master node:</span><br><span class="line">ansible-playbook playbook.yml -K</span><br><span class="line"></span><br><span class="line">After Helm is installed, you can SSH into your master node (kube-node-1) and manage Cilium Enterprise installation directly using Helm.</span><br><span class="line">Remember to use the correct Cilium chart version and your custom values file.</span><br><span class="line">Example steps <span class="keyword">for</span> manual Cilium installation via Helm:</span><br><span class="line">ssh ubuntu@10.75.59.71</span><br><span class="line">sudo helm repo add cilium https://helm.cilium.io/</span><br><span class="line">sudo helm repo add isovalent https://helm.isovalent.com</span><br><span class="line">sudo helm repo update</span><br><span class="line">sudo helm install cilium isovalent/cilium --version 1.17.6 --namespace kube-system -f &lt;path_to_your_cilium_values_file.yaml&gt; --<span class="built_in">wait</span></span><br><span class="line">Example content <span class="keyword">for</span> /tmp/cilium-enterprise-values.yaml:</span><br><span class="line">hubble:</span><br><span class="line">  enabled: <span class="literal">true</span></span><br><span class="line">  relay:</span><br><span class="line">    enabled: <span class="literal">true</span></span><br><span class="line">  ui:</span><br><span class="line">    enabled: <span class="literal">false</span></span><br><span class="line">kubeProxyReplacement: strict</span><br><span class="line">ipam:</span><br><span class="line">  mode: kubernetes</span><br><span class="line">ipv4NativeRoutingCIDR: 172.16.0.0/20</span><br><span class="line">k8s:</span><br><span class="line">  requireIPv4PodCIDR: <span class="literal">true</span></span><br><span class="line">routingMode: native</span><br><span class="line">autoDirectNodeRoutes: <span class="literal">false</span></span><br><span class="line">bgpControlPlane:</span><br><span class="line">  enabled: <span class="literal">true</span></span><br><span class="line">ois@ois:~/data/k8s$ <span class="built_in">cd</span> ansible-helm</span><br><span class="line">ois@ois:~/data/k8s/ansible-helm$ ansible-playbook playbook.yml -K</span><br><span class="line">BECOME password: </span><br><span class="line"></span><br><span class="line">PLAY [Install Helm on Kubernetes Master Node] ******************************************************************************************************************************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] *****************************************************************************************************************************************************************************************************************************************</span><br><span class="line">ok: [kube-node-1]</span><br><span class="line"></span><br><span class="line">TASK [helm_install : Check <span class="keyword">if</span> Helm is installed and get version] ***********************************************************************************************************************************************************************************************</span><br><span class="line">fatal: [kube-node-1]: FAILED! =&gt; &#123;<span class="string">&quot;changed&quot;</span>: <span class="literal">false</span>, <span class="string">&quot;cmd&quot;</span>: <span class="string">&quot;helm version --short&quot;</span>, <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;[Errno 2] No such file or directory: b&#x27;helm&#x27;&quot;</span>, <span class="string">&quot;rc&quot;</span>: 2, <span class="string">&quot;stderr&quot;</span>: <span class="string">&quot;&quot;</span>, <span class="string">&quot;stderr_lines&quot;</span>: [], <span class="string">&quot;stdout&quot;</span>: <span class="string">&quot;&quot;</span>, <span class="string">&quot;stdout_lines&quot;</span>: []&#125;</span><br><span class="line">...ignoring</span><br><span class="line"></span><br><span class="line">TASK [helm_install : Set installed Helm version fact] **********************************************************************************************************************************************************************************************************</span><br><span class="line">ok: [kube-node-1]</span><br><span class="line"></span><br><span class="line">TASK [helm_install : Debug installed Helm version] *************************************************************************************************************************************************************************************************************</span><br><span class="line">ok: [kube-node-1] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;Current installed Helm version: &quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">TASK [helm_install : Debug raw Helm version output] ************************************************************************************************************************************************************************************************************</span><br><span class="line">skipping: [kube-node-1]</span><br><span class="line"></span><br><span class="line">TASK [helm_install : Check <span class="keyword">if</span> Helm binary exists] **************************************************************************************************************************************************************************************************************</span><br><span class="line">skipping: [kube-node-1]</span><br><span class="line"></span><br><span class="line">TASK [helm_install : Download Helm tarball] ********************************************************************************************************************************************************************************************************************</span><br><span class="line">changed: [kube-node-1]</span><br><span class="line"></span><br><span class="line">TASK [helm_install : Create Helm installation directory] *******************************************************************************************************************************************************************************************************</span><br><span class="line">ok: [kube-node-1]</span><br><span class="line"></span><br><span class="line">TASK [helm_install : Extract Helm binary] **********************************************************************************************************************************************************************************************************************</span><br><span class="line">changed: [kube-node-1]</span><br><span class="line"></span><br><span class="line">TASK [helm_install : Move Helm binary to /usr/local/bin] *******************************************************************************************************************************************************************************************************</span><br><span class="line">changed: [kube-node-1]</span><br><span class="line"></span><br><span class="line">TASK [helm_install : Clean up Helm tarball and extracted directory] ********************************************************************************************************************************************************************************************</span><br><span class="line">changed: [kube-node-1] =&gt; (item=/tmp/helm-v3.18.4-linux-amd64.tar.gz)</span><br><span class="line">changed: [kube-node-1] =&gt; (item=/tmp/linux-amd64)</span><br><span class="line"></span><br><span class="line">TASK [helm_install : Verify Helm installation] *****************************************************************************************************************************************************************************************************************</span><br><span class="line">ok: [kube-node-1]</span><br><span class="line"></span><br><span class="line">TASK [helm_install : Display Helm version] *********************************************************************************************************************************************************************************************************************</span><br><span class="line">ok: [kube-node-1] =&gt; &#123;</span><br><span class="line">    <span class="string">&quot;msg&quot;</span>: <span class="string">&quot;version.BuildInfo&#123;Version:\&quot;v3.18.4\&quot;, GitCommit:\&quot;d80839cf37d860c8aa9a0503fe463278f26cd5e2\&quot;, GitTreeState:\&quot;clean\&quot;, GoVersion:\&quot;go1.24.4\&quot;&#125;&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">PLAY RECAP *****************************************************************************************************************************************************************************************************************************************************</span><br><span class="line">kube-node-1                : ok=11   changed=4    unreachable=0    failed=0    skipped=2    rescued=0    ignored=1   </span><br></pre></td></tr></table></figure>

<h2 id="4-3-使用Helm安装Cilium"><a href="#4-3-使用Helm安装Cilium" class="headerlink" title="4.3 使用Helm安装Cilium"></a>4.3 使用Helm安装Cilium</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">root@kube-node-1:~<span class="comment"># helm repo add cilium https://helm.cilium.io/</span></span><br><span class="line"><span class="string">&quot;cilium&quot;</span> has been added to your repositories</span><br><span class="line">root@kube-node-1:~<span class="comment"># helm repo add isovalent https://helm.isovalent.com</span></span><br><span class="line"><span class="string">&quot;isovalent&quot;</span> has been added to your repositories</span><br><span class="line">root@kube-node-1:~<span class="comment"># </span></span><br><span class="line"></span><br><span class="line">准备配置文件如下：</span><br><span class="line"></span><br><span class="line">root@kube-node-1:~<span class="comment"># cat &gt; cilium-enterprise-values.yaml &lt;&lt;EOF</span></span><br><span class="line">hubble:</span><br><span class="line">  enabled: <span class="literal">true</span></span><br><span class="line">  relay:</span><br><span class="line">    enabled: <span class="literal">true</span></span><br><span class="line">  ui:</span><br><span class="line">    enabled: <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Enable Gateway API</span></span><br><span class="line"><span class="comment">#gatewayAPI:</span></span><br><span class="line"><span class="comment">#  enabled: true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Explicitly disable Egress Gateway</span></span><br><span class="line"><span class="comment">#egressGateway:</span></span><br><span class="line"><span class="comment">#  enabled: false</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># BGP native-routing configuration</span></span><br><span class="line">ipam:</span><br><span class="line">  mode: kubernetes</span><br><span class="line">ipv4NativeRoutingCIDR: 172.16.0.0/20 <span class="comment"># Advertises all pod CIDRs; ensure BGP router supports this</span></span><br><span class="line">k8s:</span><br><span class="line">  requireIPv4PodCIDR: <span class="literal">true</span></span><br><span class="line">routingMode: native</span><br><span class="line">autoDirectNodeRoutes: <span class="literal">true</span></span><br><span class="line">bgpControlPlane:</span><br><span class="line">  enabled: <span class="literal">true</span></span><br><span class="line">  <span class="comment"># Configure BGP peers (replace with your BGP router details)</span></span><br><span class="line">  announce:</span><br><span class="line">    podCIDR: <span class="literal">true</span> <span class="comment"># Advertise pod CIDRs to BGP peers</span></span><br><span class="line">enableIPv4Masquerade: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Enable kube-proxy replacement</span></span><br><span class="line">kubeProxyReplacement: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">bpf:</span><br><span class="line">  masquerade: <span class="literal">true</span></span><br><span class="line">  lb:</span><br><span class="line">    externalClusterIP: <span class="literal">true</span></span><br><span class="line">    sock: <span class="literal">true</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">root@kube-node-1:~<span class="comment"># helm install cilium isovalent/cilium --version 1.17.6 \</span></span><br><span class="line">    --namespace kube-system \</span><br><span class="line">    --<span class="built_in">set</span> kubeProxyReplacement=<span class="literal">true</span> \</span><br><span class="line">    --<span class="built_in">set</span> k8sServiceHost=10.75.59.71 \</span><br><span class="line">    --<span class="built_in">set</span> k8sServicePort=6443 \</span><br><span class="line">    -f cilium-enterprise-values.yaml</span><br><span class="line">NAME: cilium</span><br><span class="line">LAST DEPLOYED: Fri Aug  1 09:54:27 2025</span><br><span class="line">NAMESPACE: kube-system</span><br><span class="line">STATUS: deployed</span><br><span class="line">REVISION: 1</span><br><span class="line">TEST SUITE: None</span><br><span class="line">NOTES:</span><br><span class="line">You have successfully installed Cilium with Hubble Relay.</span><br><span class="line"></span><br><span class="line">Your release version is 1.17.6.</span><br><span class="line"></span><br><span class="line">For any further <span class="built_in">help</span>, visit https://docs.isovalent.com/v1.17</span><br><span class="line"></span><br><span class="line">上述命令中的参数k8sServiceHost=10.75.59.71 和 k8sServicePort=6443 是不能少的。</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">在其他Node上执行kubeadm <span class="built_in">join</span></span><br><span class="line"></span><br><span class="line">ubuntu@kube-node-2:~$ sudo su</span><br><span class="line">[sudo] password <span class="keyword">for</span> ubuntu: </span><br><span class="line">root@kube-node-2:/home/ubuntu<span class="comment"># cd</span></span><br><span class="line">root@kube-node-2:~<span class="comment"># kubeadm join kube-node-1:6443 --token wnc2sl.st6g6c4o0cd42bi4 \</span></span><br><span class="line">        --discovery-token-ca-cert-hash sha256:381868d3e0faab6dbd3e240d8f40e0e81ab46cb54b2f15ffbfe0f587fac5d982 </span><br><span class="line">[preflight] Running pre-flight checks</span><br><span class="line">[preflight] Reading configuration from the <span class="string">&quot;kubeadm-config&quot;</span> ConfigMap <span class="keyword">in</span> namespace <span class="string">&quot;kube-system&quot;</span>...</span><br><span class="line">[preflight] Use <span class="string">&#x27;kubeadm init phase upload-config --config your-config-file&#x27;</span> to re-upload it.</span><br><span class="line">W0801 09:56:27.830756   47851 configset.go:78] Warning: No kubeproxy.config.k8s.io/v1alpha1 config is loaded. Continuing without it: configmaps <span class="string">&quot;kube-proxy&quot;</span> is forbidden: User <span class="string">&quot;system:bootstrap:wnc2sl&quot;</span> cannot get resource <span class="string">&quot;configmaps&quot;</span> <span class="keyword">in</span> API group <span class="string">&quot;&quot;</span> <span class="keyword">in</span> the namespace <span class="string">&quot;kube-system&quot;</span></span><br><span class="line">[kubelet-start] Writing kubelet configuration to file <span class="string">&quot;/var/lib/kubelet/config.yaml&quot;</span></span><br><span class="line">[kubelet-start] Writing kubelet environment file with flags to file <span class="string">&quot;/var/lib/kubelet/kubeadm-flags.env&quot;</span></span><br><span class="line">[kubelet-start] Starting the kubelet</span><br><span class="line">[kubelet-check] Waiting <span class="keyword">for</span> a healthy kubelet at http://127.0.0.1:10248/healthz. This can take up to 4m0s</span><br><span class="line">[kubelet-check] The kubelet is healthy after 1.503396779s</span><br><span class="line">[kubelet-start] Waiting <span class="keyword">for</span> the kubelet to perform the TLS Bootstrap</span><br><span class="line"></span><br><span class="line">This node has joined the cluster:</span><br><span class="line">* Certificate signing request was sent to apiserver and a response was received.</span><br><span class="line">* The Kubelet was informed of the new secure connection details.</span><br><span class="line"></span><br><span class="line">Run <span class="string">&#x27;kubectl get nodes&#x27;</span> on the control-plane to see this node <span class="built_in">join</span> the cluster.</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>等待一段时间，Cilium、Hubble Relay即可Ready</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">root@kube-node-1:~<span class="comment"># kubectl get pods -n kube-system -o wide</span></span><br><span class="line">NAME                                  READY   STATUS    RESTARTS   AGE     IP            NODE          NOMINATED NODE   READINESS GATES</span><br><span class="line">cilium-2vrgj                          1/1     Running   0          3m58s   10.75.59.73   kube-node-3   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">cilium-65kvc                          1/1     Running   0          4m14s   10.75.59.72   kube-node-2   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">cilium-envoy-24sd7                    1/1     Running   0          4m14s   10.75.59.72   kube-node-2   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">cilium-envoy-7pr4g                    1/1     Running   0          6m12s   10.75.59.71   kube-node-1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">cilium-envoy-k86tp                    1/1     Running   0          3m58s   10.75.59.73   kube-node-3   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">cilium-operator-867fb7f659-2vnld      1/1     Running   0          6m12s   10.75.59.72   kube-node-2   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">cilium-operator-867fb7f659-5998x      1/1     Running   0          6m12s   10.75.59.71   kube-node-1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">cilium-x4pr7                          1/1     Running   0          6m12s   10.75.59.71   kube-node-1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">coredns-674b8bbfcf-6t8np              1/1     Running   0          13m     172.16.1.40   kube-node-2   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">coredns-674b8bbfcf-bx8xd              1/1     Running   0          13m     172.16.1.64   kube-node-2   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">etcd-kube-node-1                      1/1     Running   1          13m     10.75.59.71   kube-node-1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">hubble-relay-cfb755899-gch8w          1/1     Running   0          6m12s   172.16.1.81   kube-node-2   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-apiserver-kube-node-1            1/1     Running   1          13m     10.75.59.71   kube-node-1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-controller-manager-kube-node-1   1/1     Running   1          13m     10.75.59.71   kube-node-1   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">kube-scheduler-kube-node-1            1/1     Running   1          13m     10.75.59.71   kube-node-1   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<h2 id="4-4-安装企业版Cilium-cli"><a href="#4-4-安装企业版Cilium-cli" class="headerlink" title="4.4 安装企业版Cilium-cli"></a>4.4 安装企业版Cilium-cli</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">curl -L --remote-name-all https://github.com/isovalent/cilium-cli-releases/releases/latest/download/cilium-linux-amd64.tar.gz&#123;,.<span class="built_in">sha256sum</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">sha256sum</span> --check cilium-linux-amd64.tar.gz.sha256sum</span><br><span class="line"></span><br><span class="line">tar xzvfC cilium-linux-amd64.tar.gz /usr/local/bin</span><br><span class="line"></span><br><span class="line">root@kube-node-1:~<span class="comment"># cilium status</span></span><br><span class="line">    /¯¯\</span><br><span class="line"> /¯¯\__/¯¯\    Cilium:             OK</span><br><span class="line"> \__/¯¯\__/    Operator:           OK</span><br><span class="line"> /¯¯\__/¯¯\    Envoy DaemonSet:    OK</span><br><span class="line"> \__/¯¯\__/    Hubble Relay:       OK</span><br><span class="line">    \__/       ClusterMesh:        disabled</span><br><span class="line"></span><br><span class="line">DaemonSet              cilium                   Desired: 3, Ready: 3/3, Available: 3/3</span><br><span class="line">DaemonSet              cilium-envoy             Desired: 3, Ready: 3/3, Available: 3/3</span><br><span class="line">Deployment             cilium-operator          Desired: 2, Ready: 2/2, Available: 2/2</span><br><span class="line">Deployment             hubble-relay             Desired: 1, Ready: 1/1, Available: 1/1</span><br><span class="line">Containers:            cilium                   Running: 3</span><br><span class="line">                       cilium-envoy             Running: 3</span><br><span class="line">                       cilium-operator          Running: 2</span><br><span class="line">                       clustermesh-apiserver    </span><br><span class="line">                       hubble-relay             Running: 1</span><br><span class="line">Cluster Pods:          3/3 managed by Cilium</span><br><span class="line">Helm chart version:    1.17.6</span><br><span class="line">Image versions         cilium             quay.io/isovalent/cilium:v1.17.6-cee.1@sha256:2d01daf4f25f7d644889b49ca856e1a4269981fc963e50bd3962665b41b6adb3: 3</span><br><span class="line">                       cilium-envoy       quay.io/isovalent/cilium-envoy:v1.17.6-cee.1@sha256:318eff387835ca2717baab42a84f35a83a5f9e7d519253df87269f80b9ff0171: 3</span><br><span class="line">                       cilium-operator    quay.io/isovalent/operator-generic:v1.17.6-cee.1@sha256:2e602710a7c4f101831df679e5d8251bae8bf0f9fe26c20bbef87f1966ea8265: 2</span><br><span class="line">                       hubble-relay       quay.io/isovalent/hubble-relay:v1.17.6-cee.1@sha256:d378e3607f7492374e65e2bd854cc0ec87480c63ba49a96dadcd75a6946b586e: 1</span><br><span class="line">root@kube-node-1:~<span class="comment"># </span></span><br></pre></td></tr></table></figure>

<h2 id="4-5-设置Cilium-BGP"><a href="#4-5-设置Cilium-BGP" class="headerlink" title="4.5 设置Cilium BGP"></a>4.5 设置Cilium BGP</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">root@kube-node-1:~<span class="comment">#cat &gt; cilium-bgp.yaml &lt;&lt; EOF</span></span><br><span class="line">--- <span class="comment">#bgp的对外宣告策略，宣告POD和serviceip</span></span><br><span class="line">apiVersion: cilium.io/v2alpha1</span><br><span class="line">kind: CiliumBGPAdvertisement</span><br><span class="line">metadata:</span><br><span class="line">  name: bgp-advertisements</span><br><span class="line">  labels:</span><br><span class="line">    advertise: bgp</span><br><span class="line">spec:</span><br><span class="line">  advertisements:</span><br><span class="line">    - advertisementType: <span class="string">&quot;PodCIDR&quot;</span>              <span class="comment"># Only for Kubernetes or ClusterPool IPAM cluster-pool</span></span><br><span class="line">    - advertisementType: <span class="string">&quot;Service&quot;</span></span><br><span class="line">      service:</span><br><span class="line">        addresses:</span><br><span class="line">          - ClusterIP</span><br><span class="line">          - ExternalIP</span><br><span class="line">          <span class="comment">#- LoadBalancerIP</span></span><br><span class="line">      selector:</span><br><span class="line">        matchExpressions:</span><br><span class="line">        - &#123;key: somekey, operator: NotIn, values: [<span class="string">&#x27;never-used-value&#x27;</span>]&#125;                  <span class="comment"># 等同于宣告所有</span></span><br><span class="line"></span><br><span class="line">--- <span class="comment">#bgp邻居组的配置，类似template peer ,里面调用相关的advertisement策略</span></span><br><span class="line">apiVersion: cilium.io/v2alpha1</span><br><span class="line">kind: CiliumBGPPeerConfig</span><br><span class="line">metadata:</span><br><span class="line">  name: cilium-peer</span><br><span class="line">spec:</span><br><span class="line">  timers:</span><br><span class="line">    holdTimeSeconds: 30             <span class="comment">#default 90s</span></span><br><span class="line">    keepAliveTimeSeconds: 10  <span class="comment">#default 30s</span></span><br><span class="line">    connectRetryTimeSeconds: 40  <span class="comment">#default 120s</span></span><br><span class="line">  gracefulRestart:</span><br><span class="line">    enabled: <span class="literal">true</span></span><br><span class="line">    restartTimeSeconds: 120        <span class="comment">#default 120s</span></span><br><span class="line">  <span class="comment">#transport:</span></span><br><span class="line">  <span class="comment">#  peerPort: 179</span></span><br><span class="line">  families:</span><br><span class="line">    - afi: ipv4</span><br><span class="line">      safi: unicast</span><br><span class="line">      advertisements:</span><br><span class="line">        matchLabels:</span><br><span class="line">          advertise: <span class="string">&quot;bgp&quot;</span></span><br><span class="line"></span><br><span class="line">--- <span class="comment">#bgp的邻居配置</span></span><br><span class="line">apiVersion: cilium.io/v2alpha1</span><br><span class="line">kind: CiliumBGPClusterConfig</span><br><span class="line">metadata:</span><br><span class="line">  name: cilium-bgp-default</span><br><span class="line">spec:</span><br><span class="line">  bgpInstances:</span><br><span class="line">  - name: <span class="string">&quot;instance-65000&quot;</span></span><br><span class="line">    localASN: 65000</span><br><span class="line">    peers:</span><br><span class="line">    - name: <span class="string">&quot;GoBGP&quot;</span></span><br><span class="line">      peerASN: 65000</span><br><span class="line">      peerAddress: 10.75.59.76</span><br><span class="line">      peerConfigRef:</span><br><span class="line">        name: <span class="string">&quot;cilium-peer&quot;</span></span><br><span class="line">EOF</span><br><span class="line">root@kube-node-1:~<span class="comment"># </span></span><br><span class="line">root@kube-node-1:~<span class="comment"># </span></span><br><span class="line">root@kube-node-1:~<span class="comment"># kubectl apply -f cilium-bgp.yaml </span></span><br><span class="line">ciliumbgpadvertisement.cilium.io/bgp-advertisements created</span><br><span class="line">ciliumbgppeerconfig.cilium.io/cilium-peer created</span><br><span class="line">ciliumbgpclusterconfig.cilium.io/cilium-bgp-default created</span><br><span class="line">root@kube-node-1:~<span class="comment"># cilium bgp peers</span></span><br><span class="line">Node          Local AS   Peer AS   Peer Address   Session State   Uptime   Family         Received   Advertised</span><br><span class="line">kube-node-1   65000      65000     10.75.59.76    established     7s       ipv4/unicast   2          6    </span><br><span class="line">kube-node-2   65000      65000     10.75.59.76    established     6s       ipv4/unicast   2          6    </span><br><span class="line">kube-node-3   65000      65000     10.75.59.76    established     6s       ipv4/unicast   2          6    </span><br><span class="line">root@kube-node-1:~<span class="comment"># cilium bgp routes</span></span><br><span class="line">(Defaulting to `available ipv4 unicast` routes, please see <span class="built_in">help</span> <span class="keyword">for</span> more options)</span><br><span class="line"></span><br><span class="line">Node          VRouter   Prefix             NextHop   Age   Attrs</span><br><span class="line">kube-node-1   65000     172.16.0.0/24      0.0.0.0   12s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class="line">              65000     172.16.32.1/32     0.0.0.0   12s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class="line">              65000     172.16.32.10/32    0.0.0.0   12s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class="line">              65000     172.16.37.239/32   0.0.0.0   12s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class="line">              65000     172.16.43.10/32    0.0.0.0   12s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class="line">kube-node-2   65000     172.16.1.0/24      0.0.0.0   12s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class="line">              65000     172.16.32.1/32     0.0.0.0   12s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class="line">              65000     172.16.32.10/32    0.0.0.0   12s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class="line">              65000     172.16.37.239/32   0.0.0.0   12s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class="line">              65000     172.16.43.10/32    0.0.0.0   12s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class="line">kube-node-3   65000     172.16.3.0/24      0.0.0.0   12s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class="line">              65000     172.16.32.1/32     0.0.0.0   12s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class="line">              65000     172.16.32.10/32    0.0.0.0   12s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class="line">              65000     172.16.37.239/32   0.0.0.0   12s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class="line">              65000     172.16.43.10/32    0.0.0.0   12s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span><br><span class="line">root@kube-node-1:~<span class="comment"># </span></span><br></pre></td></tr></table></figure>

<h2 id="4-6-安装Hubble-UI"><a href="#4-6-安装Hubble-UI" class="headerlink" title="4.6 安装Hubble UI"></a>4.6 安装Hubble UI</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">root@kube-node-1:~<span class="comment"># helm search repo isovalent/hubble-ui -l</span></span><br><span class="line">NAME                    CHART VERSION   APP VERSION     DESCRIPTION         </span><br><span class="line">isovalent/hubble-ui     1.3.6           1.3.6           Hubble UI Enterprise</span><br><span class="line">isovalent/hubble-ui     1.3.5           1.3.5           Hubble UI Enterprise</span><br><span class="line"></span><br><span class="line">root@kube-node-1:~<span class="comment"># cat &gt; hubble-ui-values.yaml &lt;&lt; EOF</span></span><br><span class="line">relay:</span><br><span class="line">  address: <span class="string">&quot;hubble-relay.kube-system.svc.cluster.local&quot;</span></span><br><span class="line">EOF</span><br><span class="line">root@kube-node-1:~<span class="comment">#  </span></span><br><span class="line">root@kube-node-1:~<span class="comment"># helm install hubble-ui isovalent/hubble-ui --version 1.3.6 --namespace kube-system --values hubble-ui-values.yaml --wait</span></span><br><span class="line">NAME: hubble-ui</span><br><span class="line">LAST DEPLOYED: Fri Aug  1 10:47:58 2025</span><br><span class="line">NAMESPACE: kube-system</span><br><span class="line">STATUS: deployed</span><br><span class="line">REVISION: 1</span><br><span class="line">TEST SUITE: None</span><br><span class="line">NOTES:</span><br><span class="line">You have successfully installed Hubble-Ui.</span><br><span class="line">Your release version is 1.3.6.</span><br><span class="line"></span><br><span class="line">For any further <span class="built_in">help</span>, visit https://docs.isovalent.com</span><br><span class="line">root@kube-node-1:~<span class="comment"># kubectl patch service hubble-ui -n kube-system -p &#x27;&#123;&quot;spec&quot;: &#123;&quot;type&quot;: &quot;NodePort&quot;&#125;&#125;&#x27;</span></span><br><span class="line">service/hubble-ui patched</span><br><span class="line">root@kube-node-1:~<span class="comment"># kubectl get svc -n kube-system -o wide                                                                  </span></span><br><span class="line">NAME           TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                  AGE   SELECTOR</span><br><span class="line">cilium-envoy   ClusterIP   None            &lt;none&gt;        9964/TCP                 54m   k8s-app=cilium-envoy</span><br><span class="line">hubble-peer    ClusterIP   172.16.43.10    &lt;none&gt;        443/TCP                  54m   k8s-app=cilium</span><br><span class="line">hubble-relay   NodePort    172.16.37.239   &lt;none&gt;        80:31234/TCP             54m   k8s-app=hubble-relay</span><br><span class="line">hubble-ui      NodePort    172.16.35.177   &lt;none&gt;        80:31225/TCP             64s   k8s-app=hubble-ui</span><br><span class="line">kube-dns       ClusterIP   172.16.32.10    &lt;none&gt;        53/UDP,53/TCP,9153/TCP   61m   k8s-app=kube-dns</span><br><span class="line">root@kube-node-1:~<span class="comment"># kubectl -n kube-system exec ds/cilium -- cilium service list</span></span><br><span class="line">Defaulted container <span class="string">&quot;cilium-agent&quot;</span> out of: cilium-agent, config (init), mount-cgroup (init), apply-sysctl-overwrites (init), mount-bpf-fs (init), clean-cilium-state (init), install-cni-binaries (init)</span><br><span class="line">ID   Frontend                Service Type   Backend                               </span><br><span class="line">1    172.16.32.1:443/TCP     ClusterIP      1 =&gt; 10.75.59.71:6443/TCP (active)    </span><br><span class="line">2    172.16.43.10:443/TCP    ClusterIP      1 =&gt; 10.75.59.71:4244/TCP (active)    </span><br><span class="line">3    172.16.37.239:80/TCP    ClusterIP      1 =&gt; 172.16.1.81:4245/TCP (active)    </span><br><span class="line">4    10.75.59.71:31234/TCP   NodePort       1 =&gt; 172.16.1.81:4245/TCP (active)    </span><br><span class="line">5    0.0.0.0:31234/TCP       NodePort       1 =&gt; 172.16.1.81:4245/TCP (active)    </span><br><span class="line">6    172.16.32.10:53/TCP     ClusterIP      1 =&gt; 172.16.1.64:53/TCP (active)      </span><br><span class="line">                                            2 =&gt; 172.16.1.40:53/TCP (active)      </span><br><span class="line">7    172.16.32.10:9153/TCP   ClusterIP      1 =&gt; 172.16.1.64:9153/TCP (active)    </span><br><span class="line">                                            2 =&gt; 172.16.1.40:9153/TCP (active)    </span><br><span class="line">8    172.16.32.10:53/UDP     ClusterIP      1 =&gt; 172.16.1.64:53/UDP (active)      </span><br><span class="line">                                            2 =&gt; 172.16.1.40:53/UDP (active)      </span><br><span class="line">9    172.16.35.177:80/TCP    ClusterIP      1 =&gt; 172.16.3.127:8081/TCP (active)   </span><br><span class="line">10   10.75.59.71:31225/TCP   NodePort       1 =&gt; 172.16.3.127:8081/TCP (active)   </span><br><span class="line">11   0.0.0.0:31225/TCP       NodePort       1 =&gt; 172.16.3.127:8081/TCP (active)  </span><br><span class="line"></span><br><span class="line">浏览器可以通过http://10.75.59.71:31225/ 访问Hubble-ui</span><br><span class="line"></span><br><span class="line">root@dns-server-vm:~<span class="comment"># curl http://10.75.59.71:31225/</span></span><br><span class="line">&lt;!doctype html&gt;&lt;html&gt;&lt;<span class="built_in">head</span>&gt;&lt;meta charset=<span class="string">&quot;utf-8&quot;</span>/&gt;&lt;title&gt;Hubble UI Enterprise&lt;/title&gt;&lt;meta http-equiv=<span class="string">&quot;X-UA-Compatible&quot;</span> content=<span class="string">&quot;IE=edge&quot;</span>/&gt;&lt;meta name=<span class="string">&quot;viewport&quot;</span> content=<span class="string">&quot;width=device-width,user-scalable=0,initial-scale=1,minimum-scale=1,maximum-scale=1&quot;</span>/&gt;&lt;<span class="built_in">link</span> rel=<span class="string">&quot;icon&quot;</span> <span class="built_in">type</span>=<span class="string">&quot;image/png&quot;</span> sizes=<span class="string">&quot;32x32&quot;</span> href=<span class="string">&quot;/favicon-32x32.png&quot;</span>/&gt;&lt;<span class="built_in">link</span> rel=<span class="string">&quot;icon&quot;</span> <span class="built_in">type</span>=<span class="string">&quot;image/png&quot;</span> sizes=<span class="string">&quot;16x16&quot;</span> href=<span class="string">&quot;/favicon-16x16.png&quot;</span>/&gt;&lt;<span class="built_in">link</span> rel=<span class="string">&quot;shortcut icon&quot;</span> href=<span class="string">&quot;/favicon.ico&quot;</span>/&gt;&lt;<span class="built_in">link</span> rel=<span class="string">&quot;stylesheet&quot;</span> href=<span class="string">&quot;/fonts/inter/stylesheet.css&quot;</span>/&gt;&lt;<span class="built_in">link</span> rel=<span class="string">&quot;stylesheet&quot;</span> href=<span class="string">&quot;/fonts/roboto-mono/stylesheet.css&quot;</span>/&gt;&lt;script defer=<span class="string">&quot;defer&quot;</span> src=<span class="string">&quot;/bundle.app.77bec96f333a96efe6ea.js&quot;</span>&gt;&lt;/script&gt;&lt;<span class="built_in">link</span> href=<span class="string">&quot;/bundle.app.f1e6c0c33f1535bc8508.css&quot;</span> rel=<span class="string">&quot;stylesheet&quot;</span>&gt;&lt;script <span class="built_in">type</span>=<span class="string">&quot;text/template&quot;</span> <span class="built_in">id</span>=<span class="string">&quot;hubble-ui/feature-flags&quot;</span>&gt;[10, 0, 18, 0, 26, 0, 34, 0, 42, 0, 50, 0]&lt;/script&gt;&lt;script <span class="built_in">type</span>=<span class="string">&quot;text/template&quot;</span> <span class="built_in">id</span>=<span class="string">&quot;hubble-ui/authorization&quot;</span>&gt;[8, 1, 26, 4, 24, 1, 32, 1]&lt;/script&gt;&lt;/head&gt;&lt;body&gt;&lt;div <span class="built_in">id</span>=<span class="string">&quot;test-process-tree-char&quot;</span> style=<span class="string">&quot;font-family: &#x27;Roboto Mono&#x27;, monospace;</span></span><br><span class="line"><span class="string">        font-size: 16px;</span></span><br><span class="line"><span class="string">        position: absolute;</span></span><br><span class="line"><span class="string">        visibility: hidden;</span></span><br><span class="line"><span class="string">        height: auto;</span></span><br><span class="line"><span class="string">        width: auto;</span></span><br><span class="line"><span class="string">        white-space: nowrap;&quot;</span>&gt;a&lt;/div&gt;&lt;div <span class="built_in">id</span>=<span class="string">&quot;app&quot;</span>&gt;&lt;/div&gt;&lt;/body&gt;&lt;/html&gt;root@dns-server-vm:~<span class="comment"># </span></span><br><span class="line">root@dns-server-vm:~<span class="comment"># </span></span><br></pre></td></tr></table></figure>

<h1 id="5-部署Star-Wars-App"><a href="#5-部署Star-Wars-App" class="headerlink" title="5. 部署Star Wars App"></a>5. 部署Star Wars App</h1><h2 id="5-1-部署APP"><a href="#5-1-部署APP" class="headerlink" title="5.1 部署APP"></a>5.1 部署APP</h2><p>Isovalent 提供了一个Demo APP，以下是部署脚本。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">root@kube-node-1:~<span class="comment"># kubectl create namespace star-wars</span></span><br><span class="line">namespace/star-wars created</span><br><span class="line">root@kube-node-1:~<span class="comment"># kubectl apply -n star-wars -f https://raw.githubusercontent.com/cilium/cilium/HEAD/examples/minikube/http-sw-app.yaml</span></span><br><span class="line">service/deathstar created</span><br><span class="line">deployment.apps/deathstar created</span><br><span class="line">pod/tiefighter created</span><br><span class="line">pod/xwing created</span><br><span class="line">root@kube-node-1:~<span class="comment"># kubectl -n star-wars get pod -o wide --show-labels</span></span><br><span class="line">NAME                         READY   STATUS    RESTARTS   AGE   IP             NODE          NOMINATED NODE   READINESS GATES   LABELS</span><br><span class="line">deathstar-86f85ffb4d-4ldsj   1/1     Running   0          39s   172.16.1.231   kube-node-2   &lt;none&gt;           &lt;none&gt;            app.kubernetes.io/name=deathstar,class=deathstar,org=empire,pod-template-hash=86f85ffb4d</span><br><span class="line">deathstar-86f85ffb4d-dbzft   1/1     Running   0          39s   172.16.3.161   kube-node-3   &lt;none&gt;           &lt;none&gt;            app.kubernetes.io/name=deathstar,class=deathstar,org=empire,pod-template-hash=86f85ffb4d</span><br><span class="line">tiefighter                   1/1     Running   0          39s   172.16.3.247   kube-node-3   &lt;none&gt;           &lt;none&gt;            app.kubernetes.io/name=tiefighter,class=tiefighter,org=empire</span><br><span class="line">xwing                        1/1     Running   0          39s   172.16.3.155   kube-node-3   &lt;none&gt;           &lt;none&gt;            app.kubernetes.io/name=xwing,class=xwing,org=alliance</span><br><span class="line">root@kube-node-1:~<span class="comment"># kubectl -n star-wars get service -o wide</span></span><br><span class="line">NAME        TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE   SELECTOR</span><br><span class="line">deathstar   ClusterIP   172.16.39.138   &lt;none&gt;        80/TCP    82s   class=deathstar,org=empire</span><br><span class="line">root@kube-node-1:~<span class="comment"># kubectl -n star-wars patch service deathstar -p &#x27;&#123;&quot;spec&quot;:&#123;&quot;type&quot;:&quot;NodePort&quot;&#125;&#125;&#x27;</span></span><br><span class="line">service/deathstar patched</span><br><span class="line">root@kube-node-1:~<span class="comment"># kubectl -n star-wars get service -o wide</span></span><br><span class="line">NAME        TYPE       CLUSTER-IP      EXTERNAL-IP   PORT(S)        AGE    SELECTOR</span><br><span class="line">deathstar   NodePort   172.16.39.138   &lt;none&gt;        80:32271/TCP   112s   class=deathstar,org=empire</span><br><span class="line">root@kube-node-1:~<span class="comment"># kubectl -n kube-system exec ds/cilium -- cilium service list</span></span><br><span class="line">Defaulted container <span class="string">&quot;cilium-agent&quot;</span> out of: cilium-agent, config (init), mount-cgroup (init), apply-sysctl-overwrites (init), mount-bpf-fs (init), clean-cilium-state (init), install-cni-binaries (init)</span><br><span class="line">ID   Frontend                Service Type   Backend                               </span><br><span class="line">1    172.16.32.1:443/TCP     ClusterIP      1 =&gt; 10.75.59.71:6443/TCP (active)    </span><br><span class="line">2    172.16.43.10:443/TCP    ClusterIP      1 =&gt; 10.75.59.71:4244/TCP (active)    </span><br><span class="line">3    172.16.37.239:80/TCP    ClusterIP      1 =&gt; 172.16.1.81:4245/TCP (active)    </span><br><span class="line">4    10.75.59.71:31234/TCP   NodePort       1 =&gt; 172.16.1.81:4245/TCP (active)    </span><br><span class="line">5    0.0.0.0:31234/TCP       NodePort       1 =&gt; 172.16.1.81:4245/TCP (active)    </span><br><span class="line">6    172.16.32.10:53/TCP     ClusterIP      1 =&gt; 172.16.1.64:53/TCP (active)      </span><br><span class="line">                                            2 =&gt; 172.16.1.40:53/TCP (active)      </span><br><span class="line">7    172.16.32.10:9153/TCP   ClusterIP      1 =&gt; 172.16.1.64:9153/TCP (active)    </span><br><span class="line">                                            2 =&gt; 172.16.1.40:9153/TCP (active)    </span><br><span class="line">8    172.16.32.10:53/UDP     ClusterIP      1 =&gt; 172.16.1.64:53/UDP (active)      </span><br><span class="line">                                            2 =&gt; 172.16.1.40:53/UDP (active)      </span><br><span class="line">9    172.16.35.177:80/TCP    ClusterIP      1 =&gt; 172.16.3.127:8081/TCP (active)   </span><br><span class="line">10   10.75.59.71:31225/TCP   NodePort       1 =&gt; 172.16.3.127:8081/TCP (active)   </span><br><span class="line">11   0.0.0.0:31225/TCP       NodePort       1 =&gt; 172.16.3.127:8081/TCP (active)   </span><br><span class="line">12   172.16.39.138:80/TCP    ClusterIP      1 =&gt; 172.16.3.161:80/TCP (active)     </span><br><span class="line">                                            2 =&gt; 172.16.1.231:80/TCP (active)     </span><br><span class="line">13   10.75.59.71:32271/TCP   NodePort       1 =&gt; 172.16.3.161:80/TCP (active)     </span><br><span class="line">                                            2 =&gt; 172.16.1.231:80/TCP (active)     </span><br><span class="line">14   0.0.0.0:32271/TCP       NodePort       1 =&gt; 172.16.3.161:80/TCP (active)     </span><br><span class="line">                                            2 =&gt; 172.16.1.231:80/TCP (active)     </span><br><span class="line">到这里就算部署成功了。</span><br><span class="line"></span><br><span class="line">root@kube-node-1:~<span class="comment"># kubectl -n star-wars exec tiefighter --   curl -s -XPOST http://deathstar.star-wars.svc.cluster.local/v1/request-landing</span></span><br><span class="line">Ship landed</span><br><span class="line">root@kube-node-1:~<span class="comment"># kubectl -n star-wars exec xwing --   curl -s -XPOST http://deathstar.star-wars.svc.cluster.local/v1/request-landing</span></span><br><span class="line">Ship landed</span><br><span class="line">root@kube-node-1:~<span class="comment"># </span></span><br><span class="line"></span><br><span class="line">在外部的设备也可以通过节点IP访问。</span><br><span class="line"></span><br><span class="line">root@dns-server-vm:~<span class="comment"># curl -s -XPOST http://10.75.59.72:32271/v1/request-landing</span></span><br><span class="line">Ship landed</span><br><span class="line">root@dns-server-vm:~<span class="comment"># curl -s -XPOST http://10.75.59.71:32271/v1/request-landing</span></span><br><span class="line">Ship landed</span><br><span class="line">root@dns-server-vm:~<span class="comment"># curl -s -XPOST http://10.75.59.73:32271/v1/request-landing</span></span><br><span class="line">Ship landed</span><br></pre></td></tr></table></figure>

<h2 id="5-2-在Node外部抓包-Pod-to-Pod"><a href="#5-2-在Node外部抓包-Pod-to-Pod" class="headerlink" title="5.2 在Node外部抓包 ( Pod to Pod )"></a>5.2 在Node外部抓包 ( Pod to Pod )</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">查找虚拟机连接在网桥上的网卡</span><br><span class="line"></span><br><span class="line">root@ois:/home/ois/data/k8s<span class="comment"># virsh list</span></span><br><span class="line"> Id    Name                  State</span><br><span class="line">--------------------------------------</span><br><span class="line"> 4     win1                  running</span><br><span class="line"> 17    r1                    running</span><br><span class="line"> 69    ubuntu-2404-desktop   running</span><br><span class="line"> 96    dns-server-vm         running</span><br><span class="line"> 97    u1                    running</span><br><span class="line"> 98    ubuntu24042           running</span><br><span class="line"> 99    kube-node-1           running</span><br><span class="line"> 100   kube-node-2           running</span><br><span class="line"> 101   kube-node-3           running</span><br><span class="line"></span><br><span class="line">root@ois:/home/ois/data/k8s<span class="comment"># virsh domiflist 99</span></span><br><span class="line"> Interface   Type     Source   Model    MAC</span><br><span class="line">-----------------------------------------------------------</span><br><span class="line"> vnet90      bridge   br0      virtio   52:54:00:90:8c:cf</span><br><span class="line"></span><br><span class="line">root@ois:/home/ois/data/k8s<span class="comment"># virsh domiflist 100</span></span><br><span class="line"> Interface   Type     Source   Model    MAC</span><br><span class="line">-----------------------------------------------------------</span><br><span class="line"> vnet91      bridge   br0      virtio   52:54:00:ba:d4:1f</span><br><span class="line"></span><br><span class="line">root@ois:/home/ois/data/k8s<span class="comment"># virsh domiflist 101</span></span><br><span class="line"> Interface   Type     Source   Model    MAC</span><br><span class="line">-----------------------------------------------------------</span><br><span class="line"> vnet92      bridge   br0      virtio   52:54:00:37:e0:96</span><br><span class="line"> </span><br><span class="line"> </span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">在Pod中发起访问</span><br><span class="line"></span><br><span class="line">root@kube-node-1:~<span class="comment"># kubectl -n star-wars get pods -o wide</span></span><br><span class="line">NAME                         READY   STATUS    RESTARTS   AGE    IP             NODE          NOMINATED NODE   READINESS GATES</span><br><span class="line">deathstar-86f85ffb4d-4ldsj   1/1     Running   0          4m1s   172.16.1.231   kube-node-2   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">deathstar-86f85ffb4d-dbzft   1/1     Running   0          4m1s   172.16.3.161   kube-node-3   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">tiefighter                   1/1     Running   0          4m1s   172.16.3.247   kube-node-3   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">xwing                        1/1     Running   0          4m1s   172.16.3.155   kube-node-3   &lt;none&gt;           &lt;none&gt;</span><br><span class="line">root@kube-node-1:~<span class="comment"># kubectl -n star-wars exec xwing -- ip a                                                                            </span></span><br><span class="line">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class="line">    inet 127.0.0.1/8 scope host lo</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 ::1/128 scope host </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">11: eth0@if12: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default qlen 1000</span><br><span class="line">    <span class="built_in">link</span>/ether f2:2a:b8:da:e7:d2 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span><br><span class="line">    inet 172.16.3.155/32 scope global eth0</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::f02a:b8ff:feda:e7d2/64 scope <span class="built_in">link</span> </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">root@kube-node-1:~<span class="comment"># kubectl -n star-wars exec xwing -- ping 172.16.1.231</span></span><br><span class="line">error: Internal error occurred: Internal error occurred: error executing <span class="built_in">command</span> <span class="keyword">in</span> container: failed to <span class="built_in">exec</span> <span class="keyword">in</span> container: failed to start <span class="built_in">exec</span> <span class="string">&quot;1b1120795a5b60f35bac5a4056a1714a5c0df32762e2a79f272cf2c82089e970&quot;</span>: OCI runtime <span class="built_in">exec</span> failed: <span class="built_in">exec</span> failed: unable to start container process: <span class="built_in">exec</span>: <span class="string">&quot;ping&quot;</span>: executable file not found <span class="keyword">in</span> <span class="variable">$PATH</span>: unknown</span><br><span class="line">root@kube-node-1:~<span class="comment"># kubectl -n star-wars exec xwing -- curl -s http://172.16.1.231/v1</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Death Star&quot;</span>,</span><br><span class="line">        <span class="string">&quot;hostname&quot;</span>: <span class="string">&quot;deathstar-86f85ffb4d-4ldsj&quot;</span>,</span><br><span class="line">        <span class="string">&quot;model&quot;</span>: <span class="string">&quot;DS-1 Orbital Battle Station&quot;</span>,</span><br><span class="line">        <span class="string">&quot;manufacturer&quot;</span>: <span class="string">&quot;Imperial Department of Military Research, Sienar Fleet Systems&quot;</span>,</span><br><span class="line">        <span class="string">&quot;cost_in_credits&quot;</span>: <span class="string">&quot;1000000000000&quot;</span>,</span><br><span class="line">        <span class="string">&quot;length&quot;</span>: <span class="string">&quot;120000&quot;</span>,</span><br><span class="line">        <span class="string">&quot;crew&quot;</span>: <span class="string">&quot;342953&quot;</span>,</span><br><span class="line">        <span class="string">&quot;passengers&quot;</span>: <span class="string">&quot;843342&quot;</span>,</span><br><span class="line">        <span class="string">&quot;cargo_capacity&quot;</span>: <span class="string">&quot;1000000000000&quot;</span>,</span><br><span class="line">        <span class="string">&quot;hyperdrive_rating&quot;</span>: <span class="string">&quot;4.0&quot;</span>,</span><br><span class="line">        <span class="string">&quot;starship_class&quot;</span>: <span class="string">&quot;Deep Space Mobile Battlestation&quot;</span>,</span><br><span class="line">        <span class="string">&quot;api&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;GET   /v1&quot;</span>,</span><br><span class="line">                <span class="string">&quot;GET   /v1/healthz&quot;</span>,</span><br><span class="line">                <span class="string">&quot;POST  /v1/request-landing&quot;</span>,</span><br><span class="line">                <span class="string">&quot;PUT   /v1/cargobay&quot;</span>,</span><br><span class="line">                <span class="string">&quot;GET   /v1/hyper-matter-reactor/status&quot;</span>,</span><br><span class="line">                <span class="string">&quot;PUT   /v1/exhaust-port&quot;</span></span><br><span class="line">        ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">在宿主机上进行抓包，可以看到两者之间是直接路由的。</span><br><span class="line"></span><br><span class="line">root@ois:/home/ois/data/k8s<span class="comment"># tcpdump -i vnet92 -vn &#x27;tcp port 80&#x27;</span></span><br><span class="line">tcpdump: listening on vnet92, link-type EN10MB (Ethernet), snapshot length 262144 bytes</span><br><span class="line">11:11:11.478887 IP (tos 0x0, ttl 63, <span class="built_in">id</span> 25688, offset 0, flags [DF], proto TCP (6), length 60)</span><br><span class="line">    172.16.3.155.37162 &gt; 172.16.1.231.80: Flags [S], <span class="built_in">cksum</span> 0x5dd1 (incorrect -&gt; 0xdb07), <span class="built_in">seq</span> 542023762, win 64240, options [mss 1460,sackOK,TS val 1624400247 ecr 0,nop,wscale 7], length 0</span><br><span class="line">11:11:11.479178 IP (tos 0x0, ttl 63, <span class="built_in">id</span> 0, offset 0, flags [DF], proto TCP (6), length 60)</span><br><span class="line">    172.16.1.231.80 &gt; 172.16.3.155.37162: Flags [S.], <span class="built_in">cksum</span> 0x5dd1 (incorrect -&gt; 0x7b14), <span class="built_in">seq</span> 3892089835, ack 542023763, win 65160, options [mss 1460,sackOK,TS val 727758081 ecr 1624400247,nop,wscale 7], length 0</span><br><span class="line">11:11:11.479479 IP (tos 0x0, ttl 63, <span class="built_in">id</span> 25689, offset 0, flags [DF], proto TCP (6), length 52)</span><br><span class="line">    172.16.3.155.37162 &gt; 172.16.1.231.80: Flags [.], <span class="built_in">cksum</span> 0x5dc9 (incorrect -&gt; 0xa673), ack 1, win 502, options [nop,nop,TS val 1624400247 ecr 727758081], length 0</span><br><span class="line">11:11:11.479552 IP (tos 0x0, ttl 63, <span class="built_in">id</span> 25690, offset 0, flags [DF], proto TCP (6), length 130)</span><br><span class="line">    172.16.3.155.37162 &gt; 172.16.1.231.80: Flags [P.], <span class="built_in">cksum</span> 0x5e17 (incorrect -&gt; 0x366d), <span class="built_in">seq</span> 1:79, ack 1, win 502, options [nop,nop,TS val 1624400247 ecr 727758081], length 78: HTTP, length: 78</span><br><span class="line">        GET /v1 HTTP/1.1</span><br><span class="line">        Host: 172.16.1.231</span><br><span class="line">        User-Agent: curl/7.88.1</span><br><span class="line">        Accept: */*</span><br><span class="line"></span><br><span class="line">11:11:11.479684 IP (tos 0x0, ttl 63, <span class="built_in">id</span> 13836, offset 0, flags [DF], proto TCP (6), length 52)</span><br><span class="line">    172.16.1.231.80 &gt; 172.16.3.155.37162: Flags [.], <span class="built_in">cksum</span> 0x5dc9 (incorrect -&gt; 0xa61e), ack 79, win 509, options [nop,nop,TS val 727758081 ecr 1624400247], length 0</span><br><span class="line">11:11:11.480420 IP (tos 0x0, ttl 63, <span class="built_in">id</span> 13837, offset 0, flags [DF], proto TCP (6), length 746)</span><br><span class="line">    172.16.1.231.80 &gt; 172.16.3.155.37162: Flags [P.], <span class="built_in">cksum</span> 0x607f (incorrect -&gt; 0xc657), <span class="built_in">seq</span> 1:695, ack 79, win 509, options [nop,nop,TS val 727758082 ecr 1624400247], length 694: HTTP, length: 694</span><br><span class="line">        HTTP/1.1 200 OK</span><br><span class="line">        Content-Type: text/plain</span><br><span class="line">        Date: Fri, 01 Aug 2025 03:11:11 GMT</span><br><span class="line">        Content-Length: 591</span><br><span class="line"></span><br><span class="line">        &#123;</span><br><span class="line">                <span class="string">&quot;name&quot;</span>: <span class="string">&quot;Death Star&quot;</span>,</span><br><span class="line">                <span class="string">&quot;hostname&quot;</span>: <span class="string">&quot;deathstar-86f85ffb4d-4ldsj&quot;</span>,</span><br><span class="line">                <span class="string">&quot;model&quot;</span>: <span class="string">&quot;DS-1 Orbital Battle Station&quot;</span>,</span><br><span class="line">                <span class="string">&quot;manufacturer&quot;</span>: <span class="string">&quot;Imperial Department of Military Research, Sienar Fleet Systems&quot;</span>,</span><br><span class="line">                <span class="string">&quot;cost_in_credits&quot;</span>: <span class="string">&quot;1000000000000&quot;</span>,</span><br><span class="line">                <span class="string">&quot;length&quot;</span>: <span class="string">&quot;120000&quot;</span>,</span><br><span class="line">                <span class="string">&quot;crew&quot;</span>: <span class="string">&quot;342953&quot;</span>,</span><br><span class="line">                <span class="string">&quot;passengers&quot;</span>: <span class="string">&quot;843342&quot;</span>,</span><br><span class="line">                <span class="string">&quot;cargo_capacity&quot;</span>: <span class="string">&quot;1000000000000&quot;</span>,</span><br><span class="line">                <span class="string">&quot;hyperdrive_rating&quot;</span>: <span class="string">&quot;4.0&quot;</span>,</span><br><span class="line">                <span class="string">&quot;starship_class&quot;</span>: <span class="string">&quot;Deep Space Mobile Battlestation&quot;</span>,</span><br><span class="line">                <span class="string">&quot;api&quot;</span>: [</span><br><span class="line">                        <span class="string">&quot;GET   /v1&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;GET   /v1/healthz&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;POST  /v1/request-landing&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;PUT   /v1/cargobay&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;GET   /v1/hyper-matter-reactor/status&quot;</span>,</span><br><span class="line">                        <span class="string">&quot;PUT   /v1/exhaust-port&quot;</span></span><br><span class="line">                ]</span><br><span class="line">        &#125;       </span><br></pre></td></tr></table></figure>

<p>Cilium将各个Node对应的Pod路由自动安装了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">root@kube-node-3:~<span class="comment"># ip route show</span></span><br><span class="line">default via 10.75.59.1 dev enp1s0 proto static </span><br><span class="line">10.75.59.0/24 dev enp1s0 proto kernel scope <span class="built_in">link</span> src 10.75.59.73 </span><br><span class="line">172.16.0.0/24 via 10.75.59.71 dev enp1s0 proto kernel </span><br><span class="line">172.16.1.0/24 via 10.75.59.72 dev enp1s0 proto kernel </span><br><span class="line">172.16.3.0/24 via 172.16.3.22 dev cilium_host proto kernel src 172.16.3.22 </span><br><span class="line">172.16.3.22 dev cilium_host proto kernel scope <span class="built_in">link</span> </span><br><span class="line">root@kube-node-3:~<span class="comment"># route -n</span></span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class="line">0.0.0.0         10.75.59.1      0.0.0.0         UG    0      0        0 enp1s0</span><br><span class="line">10.75.59.0      0.0.0.0         255.255.255.0   U     0      0        0 enp1s0</span><br><span class="line">172.16.0.0      10.75.59.71     255.255.255.0   UG    0      0        0 enp1s0</span><br><span class="line">172.16.1.0      10.75.59.72     255.255.255.0   UG    0      0        0 enp1s0</span><br><span class="line">172.16.3.0      172.16.3.22     255.255.255.0   UG    0      0        0 cilium_host</span><br><span class="line">172.16.3.22     0.0.0.0         255.255.255.255 UH    0      0        0 cilium_host</span><br><span class="line"></span><br><span class="line">root@kube-node-2:~<span class="comment"># ip route show</span></span><br><span class="line">default via 10.75.59.1 dev enp1s0 proto static </span><br><span class="line">10.75.59.0/24 dev enp1s0 proto kernel scope <span class="built_in">link</span> src 10.75.59.72 </span><br><span class="line">172.16.0.0/24 via 10.75.59.71 dev enp1s0 proto kernel </span><br><span class="line">172.16.1.0/24 via 172.16.1.128 dev cilium_host proto kernel src 172.16.1.128 </span><br><span class="line">172.16.1.128 dev cilium_host proto kernel scope <span class="built_in">link</span> </span><br><span class="line">172.16.3.0/24 via 10.75.59.73 dev enp1s0 proto kernel </span><br><span class="line">root@kube-node-2:~<span class="comment"># route -n</span></span><br><span class="line">Kernel IP routing table</span><br><span class="line">Destination     Gateway         Genmask         Flags Metric Ref    Use Iface</span><br><span class="line">0.0.0.0         10.75.59.1      0.0.0.0         UG    0      0        0 enp1s0</span><br><span class="line">10.75.59.0      0.0.0.0         255.255.255.0   U     0      0        0 enp1s0</span><br><span class="line">172.16.0.0      10.75.59.71     255.255.255.0   UG    0      0        0 enp1s0</span><br><span class="line">172.16.1.0      172.16.1.128    255.255.255.0   UG    0      0        0 cilium_host</span><br><span class="line">172.16.1.128    0.0.0.0         255.255.255.255 UH    0      0        0 cilium_host</span><br><span class="line">172.16.3.0      10.75.59.73     255.255.255.0   UG    0      0        0 enp1s0</span><br></pre></td></tr></table></figure>

<p>在Hubble UI中，可以看到详细的Flow</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;uuid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2af76725-f6f9-49b4-b9f1-8d01b3f14930&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;verdict&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;drop_reason&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;auth_type&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;Type&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;node_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;kube-node-2&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;node_labels&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="string">&quot;beta.kubernetes.io/arch=amd64&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;beta.kubernetes.io/os=linux&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;kubernetes.io/arch=amd64&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;kubernetes.io/hostname=kube-node-2&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="string">&quot;kubernetes.io/os=linux&quot;</span></span><br><span class="line">  <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;source_names&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;destination_names&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;reply&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;traffic_direction&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;policy_match_type&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;trace_observation_point&quot;</span><span class="punctuation">:</span> <span class="number">101</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;trace_reason&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;drop_reason_desc&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;debug_capture_point&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;proxy_port&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;sock_xlate_point&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;socket_cookie&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;cgroup_id&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;Summary&quot;</span><span class="punctuation">:</span> <span class="string">&quot;TCP Flags: SYN&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;egress_allowed_by&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;ingress_allowed_by&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;egress_denied_by&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;ingress_denied_by&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;time&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;seconds&quot;</span><span class="punctuation">:</span> <span class="number">1754022736</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;nanos&quot;</span><span class="punctuation">:</span> <span class="number">962926009</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;ethernet&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;source&quot;</span><span class="punctuation">:</span> <span class="string">&quot;f2:64:9f:b5:8e:81&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;destination&quot;</span><span class="punctuation">:</span> <span class="string">&quot;82:31:36:d1:5a:00&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;IP&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;source&quot;</span><span class="punctuation">:</span> <span class="string">&quot;172.16.3.155&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;source_xlated&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;destination&quot;</span><span class="punctuation">:</span> <span class="string">&quot;172.16.1.231&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ipVersion&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;encrypted&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;l4&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;protocol&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;oneofKind&quot;</span><span class="punctuation">:</span> <span class="string">&quot;TCP&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;TCP&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;source_port&quot;</span><span class="punctuation">:</span> <span class="number">38680</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;destination_port&quot;</span><span class="punctuation">:</span> <span class="number">80</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;flags&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          <span class="attr">&quot;FIN&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;SYN&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;RST&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;PSH&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;ACK&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;URG&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;ECE&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;CWR&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">          <span class="attr">&quot;NS&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;source&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;ID&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;identity&quot;</span><span class="punctuation">:</span> <span class="number">36770</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;cluster_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;default&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;namespace&quot;</span><span class="punctuation">:</span> <span class="string">&quot;star-wars&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;labels&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="string">&quot;k8s:app.kubernetes.io/name=xwing&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;k8s:class=xwing&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=star-wars&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;k8s:io.cilium.k8s.policy.cluster=default&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;k8s:io.cilium.k8s.policy.serviceaccount=default&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;k8s:io.kubernetes.pod.namespace=star-wars&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;k8s:org=alliance&quot;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;pod_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;xwing&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;workloads&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span><span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;destination&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;ID&quot;</span><span class="punctuation">:</span> <span class="number">284</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;identity&quot;</span><span class="punctuation">:</span> <span class="number">15153</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;cluster_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;default&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;namespace&quot;</span><span class="punctuation">:</span> <span class="string">&quot;star-wars&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;labels&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="string">&quot;k8s:app.kubernetes.io/name=deathstar&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;k8s:class=deathstar&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;k8s:io.cilium.k8s.namespace.labels.kubernetes.io/metadata.name=star-wars&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;k8s:io.cilium.k8s.policy.cluster=default&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;k8s:io.cilium.k8s.policy.serviceaccount=default&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;k8s:io.kubernetes.pod.namespace=star-wars&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="string">&quot;k8s:org=empire&quot;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;pod_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;deathstar-86f85ffb4d-4ldsj&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;workloads&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;deathstar&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Deployment&quot;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;event_type&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;type&quot;</span><span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;sub_type&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;is_reply&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;interface&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;index&quot;</span><span class="punctuation">:</span> <span class="number">14</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;lxcf734e435e18a&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<h2 id="5-3-在Node外部抓包-Pod-to-External"><a href="#5-3-在Node外部抓包-Pod-to-External" class="headerlink" title="5.3 在Node外部抓包 ( Pod to External )"></a>5.3 在Node外部抓包 ( Pod to External )</h2><p>接下来，在Pod内部访问Internet进行测试。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">root@kube-node-1:~<span class="comment"># kubectl get configmap cilium-config -n kube-system -o yaml | grep -E &#x27;enable-ipv4-masquerade|enable-bpf-masquerade&#x27;</span></span><br><span class="line">  enable-bpf-masquerade: <span class="string">&quot;true&quot;</span></span><br><span class="line">  enable-ipv4-masquerade: <span class="string">&quot;true&quot;</span></span><br><span class="line">  </span><br><span class="line">Pod xwing 位于Kube-node3，在Node3查看</span><br><span class="line"></span><br><span class="line">root@kube-node-1:~<span class="comment"># kubectl get pods -n kube-system -l k8s-app=cilium -o wide | grep kube-node-3</span></span><br><span class="line">cilium-2vrgj   1/1     Running   0          106m   10.75.59.73   kube-node-3   &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br><span class="line">root@kube-node-1:~<span class="comment"># kubectl -n star-wars exec xwing -- curl -s https://echo.free.beeceptor.com</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;method&quot;</span>: <span class="string">&quot;GET&quot;</span>,</span><br><span class="line">  <span class="string">&quot;protocol&quot;</span>: <span class="string">&quot;https&quot;</span>,</span><br><span class="line">  <span class="string">&quot;host&quot;</span>: <span class="string">&quot;echo.free.beeceptor.com&quot;</span>,</span><br><span class="line">  <span class="string">&quot;path&quot;</span>: <span class="string">&quot;/&quot;</span>,</span><br><span class="line">  <span class="string">&quot;ip&quot;</span>: <span class="string">&quot;64.104.44.105:35834&quot;</span>,</span><br><span class="line">  <span class="string">&quot;headers&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;Host&quot;</span>: <span class="string">&quot;echo.free.beeceptor.com&quot;</span>,</span><br><span class="line">    <span class="string">&quot;User-Agent&quot;</span>: <span class="string">&quot;curl/7.88.1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Accept&quot;</span>: <span class="string">&quot;*/*&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Via&quot;</span>: <span class="string">&quot;2.0 Caddy&quot;</span>,</span><br><span class="line">    <span class="string">&quot;Accept-Encoding&quot;</span>: <span class="string">&quot;gzip&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;parsedQueryParams&quot;</span>: &#123;&#125;</span><br><span class="line">&#125;root@kube-node-1:~<span class="comment"># </span></span><br><span class="line">root@kube-node-1:~<span class="comment"># </span></span><br><span class="line"></span><br><span class="line">使用 cilium bpf nat list 查看NAT表</span><br><span class="line"></span><br><span class="line">root@kube-node-1:~<span class="comment"># kubectl exec -n kube-system cilium-2vrgj -- cilium bpf nat list | grep 172.16.3.155</span></span><br><span class="line">Defaulted container <span class="string">&quot;cilium-agent&quot;</span> out of: cilium-agent, config (init), mount-cgroup (init), apply-sysctl-overwrites (init), mount-bpf-fs (init), clean-cilium-state (init), install-cni-binaries (init)</span><br><span class="line">TCP OUT 172.16.3.155:35834 -&gt; 147.182.252.2:443 XLATE_SRC 10.75.59.73:35834 Created=4sec ago NeedsCT=0</span><br><span class="line">TCP IN 147.182.252.2:443 -&gt; 10.75.59.73:35834 XLATE_DST 172.16.3.155:35834 Created=4sec ago NeedsCT=0</span><br><span class="line">root@kube-node-1:~<span class="comment"># </span></span><br><span class="line">root@kube-node-1:~<span class="comment"># </span></span><br><span class="line"></span><br><span class="line">在外部的抓包：</span><br><span class="line">root@ois:/home/ois/data/k8s<span class="comment"># tcpdump -i vnet92 -vn &#x27;tcp port 443&#x27;</span></span><br><span class="line">tcpdump: listening on vnet92, link-type EN10MB (Ethernet), snapshot length 262144 bytes</span><br><span class="line">12:28:22.307306 IP (tos 0x0, ttl 63, <span class="built_in">id</span> 45759, offset 0, flags [DF], proto TCP (6), length 60)</span><br><span class="line">    10.75.59.73.49208 &gt; 147.182.252.2.443: Flags [S], <span class="built_in">cksum</span> 0xd57b (incorrect -&gt; 0x363a), <span class="built_in">seq</span> 3275650602, win 64240, options [mss 1460,sackOK,TS val 493037768 ecr 0,nop,wscale 7], length 0</span><br><span class="line">12:28:22.477754 IP (tos 0x0, ttl 42, <span class="built_in">id</span> 0, offset 0, flags [DF], proto TCP (6), length 60)</span><br><span class="line">    147.182.252.2.443 &gt; 10.75.59.73.49208: Flags [S.], <span class="built_in">cksum</span> 0xed16 (correct), <span class="built_in">seq</span> 450982431, ack 3275650603, win 65160, options [mss 1254,sackOK,TS val 1573215106 ecr 493037768,nop,wscale 7], length 0</span><br><span class="line">12:28:22.478053 IP (tos 0x0, ttl 63, <span class="built_in">id</span> 45760, offset 0, flags [DF], proto TCP (6), length 52)</span><br><span class="line">    10.75.59.73.49208 &gt; 147.182.252.2.443: Flags [.], <span class="built_in">cksum</span> 0xd573 (incorrect -&gt; 0x16fd), ack 1, win 502, options [nop,nop,TS val 493037939 ecr 1573215106], length 0</span><br><span class="line">12:28:22.490922 IP (tos 0x0, ttl 63, <span class="built_in">id</span> 45761, offset 0, flags [DF], proto TCP (6), length 569)</span><br><span class="line">    10.75.59.73.49208 &gt; 147.182.252.2.443: Flags [P.], <span class="built_in">cksum</span> 0xd778 (incorrect -&gt; 0x1d27), <span class="built_in">seq</span> 1:518, ack 1, win 502, options [nop,nop,TS val 493037952 ecr 1573215106], length 517</span><br></pre></td></tr></table></figure>

<h1 id="6-安装K8S和Cilium脚本自动化"><a href="#6-安装K8S和Cilium脚本自动化" class="headerlink" title="6. 安装K8S和Cilium脚本自动化"></a>6. 安装K8S和Cilium脚本自动化</h1><p>接下来打算把K8S和Cilium的安装脚本自动化。</p>
<p>首先需要解决在kube-node-1 能 无密码登录到kube-node-2 和 kube-node-3。</p>
<h2 id="6-1-无密码登录设置"><a href="#6-1-无密码登录设置" class="headerlink" title="6.1 无密码登录设置"></a>6.1 无密码登录设置</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- Configuration ---</span></span><br><span class="line">ANSIBLE_DIR=<span class="string">&quot;ansible_ssh_setup&quot;</span></span><br><span class="line">INVENTORY_FILE=<span class="string">&quot;<span class="variable">$&#123;ANSIBLE_DIR&#125;</span>/hosts.ini&quot;</span></span><br><span class="line">PLAYBOOK_FILE=<span class="string">&quot;<span class="variable">$&#123;ANSIBLE_DIR&#125;</span>/setup_ssh.yml&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Kubernetes Node IPs</span></span><br><span class="line">KUBE_NODE_1_IP=<span class="string">&quot;10.75.59.71&quot;</span></span><br><span class="line">KUBE_NODE_2_IP=<span class="string">&quot;10.75.59.72&quot;</span></span><br><span class="line">KUBE_NODE_3_IP=<span class="string">&quot;10.75.59.73&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Common Ansible user and Python interpreter</span></span><br><span class="line">ANSIBLE_USER=<span class="string">&quot;ubuntu&quot;</span></span><br><span class="line">ANSIBLE_PYTHON_INTERPRETER=<span class="string">&quot;/usr/bin/python3&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- Functions ---</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Function to check and install Ansible</span></span><br><span class="line"><span class="function"><span class="title">install_ansible</span></span>() &#123;</span><br><span class="line">    <span class="keyword">if</span> ! <span class="built_in">command</span> -v ansible &amp;&gt; /dev/null</span><br><span class="line">    <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Ansible not found. Attempting to install Ansible...&quot;</span></span><br><span class="line">        <span class="keyword">if</span> [ -f /etc/debian_version ]; <span class="keyword">then</span></span><br><span class="line">            <span class="comment"># Debian/Ubuntu</span></span><br><span class="line">            sudo apt update</span><br><span class="line">            sudo apt install -y software-properties-common</span><br><span class="line">            sudo add-apt-repository --<span class="built_in">yes</span> --update ppa:ansible/ansible</span><br><span class="line">            sudo apt install -y ansible</span><br><span class="line">        <span class="keyword">elif</span> [ -f /etc/redhat-release ]; <span class="keyword">then</span></span><br><span class="line">            <span class="comment"># CentOS/RHEL/Fedora</span></span><br><span class="line">            sudo yum install -y epel-release</span><br><span class="line">            sudo yum install -y ansible</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;Unsupported OS for automatic Ansible installation. Please install Ansible manually.&quot;</span></span><br><span class="line">            <span class="built_in">exit</span> 1</span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">        <span class="keyword">if</span> ! <span class="built_in">command</span> -v ansible &amp;&gt; /dev/null; <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;Ansible installation failed. Please install it manually and re-run this script.&quot;</span></span><br><span class="line">            <span class="built_in">exit</span> 1</span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Ansible installed successfully.&quot;</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;Ansible is already installed.&quot;</span></span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Function to create Ansible inventory file</span></span><br><span class="line"><span class="function"><span class="title">create_inventory</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Creating Ansible inventory file: <span class="variable">$&#123;INVENTORY_FILE&#125;</span>&quot;</span></span><br><span class="line">    <span class="built_in">mkdir</span> -p <span class="string">&quot;<span class="variable">$ANSIBLE_DIR</span>&quot;</span></span><br><span class="line">    <span class="built_in">cat</span> &lt;&lt;<span class="string">EOF &gt; &quot;$INVENTORY_FILE&quot;</span></span><br><span class="line"><span class="string">[kubernetes_nodes]</span></span><br><span class="line"><span class="string">kube-node-1 ansible_host=$&#123;KUBE_NODE_1_IP&#125;</span></span><br><span class="line"><span class="string">kube-node-2 ansible_host=$&#123;KUBE_NODE_2_IP&#125;</span></span><br><span class="line"><span class="string">kube-node-3 ansible_host=$&#123;KUBE_NODE_3_IP&#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[all:vars]</span></span><br><span class="line"><span class="string">ansible_user=$&#123;ANSIBLE_USER&#125;</span></span><br><span class="line"><span class="string">ansible_python_interpreter=$&#123;ANSIBLE_PYTHON_INTERPRETER&#125;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Inventory file created.&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># Function to create Ansible playbook file</span></span><br><span class="line"><span class="function"><span class="title">create_playbook</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Creating Ansible playbook file: <span class="variable">$&#123;PLAYBOOK_FILE&#125;</span>&quot;</span></span><br><span class="line">    <span class="built_in">mkdir</span> -p <span class="string">&quot;<span class="variable">$ANSIBLE_DIR</span>&quot;</span></span><br><span class="line">    <span class="built_in">cat</span> &lt;&lt;<span class="string">&#x27;EOF&#x27;</span> &gt; <span class="string">&quot;<span class="variable">$PLAYBOOK_FILE</span>&quot;</span></span><br><span class="line">---</span><br><span class="line">- name: Generate SSH key on kube-node-1 and distribute to other nodes</span><br><span class="line">  hosts: kubernetes_nodes</span><br><span class="line">  become: <span class="built_in">yes</span></span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">    - name: Generate SSH key on kube-node-1</span><br><span class="line">      ansible.builtin.command:</span><br><span class="line">        cmd: ssh-keygen -t rsa -b 4096 -N <span class="string">&quot;&quot;</span> -f /root/.ssh/id_rsa</span><br><span class="line">        creates: /root/.ssh/id_rsa</span><br><span class="line">      when: inventory_hostname == <span class="string">&#x27;kube-node-1&#x27;</span></span><br><span class="line"></span><br><span class="line">    - name: Ensure .ssh directory exists on all nodes</span><br><span class="line">      ansible.builtin.file:</span><br><span class="line">        path: /root/.ssh</span><br><span class="line">        state: directory</span><br><span class="line">        mode: <span class="string">&#x27;0700&#x27;</span></span><br><span class="line"></span><br><span class="line">    - name: Ensure authorized_keys file exists</span><br><span class="line">      ansible.builtin.file:</span><br><span class="line">        path: /root/.ssh/authorized_keys</span><br><span class="line">        state: <span class="built_in">touch</span></span><br><span class="line">        mode: <span class="string">&#x27;0600&#x27;</span></span><br><span class="line"></span><br><span class="line">    - name: Fetch public key from kube-node-1</span><br><span class="line">      ansible.builtin.slurp:</span><br><span class="line">        src: /root/.ssh/id_rsa.pub</span><br><span class="line">      register: ssh_public_key</span><br><span class="line">      when: inventory_hostname == <span class="string">&#x27;kube-node-1&#x27;</span></span><br><span class="line"></span><br><span class="line">    - name: Distribute public key to kube-node-2 and kube-node-3</span><br><span class="line">      ansible.builtin.lineinfile:</span><br><span class="line">        path: /root/.ssh/authorized_keys</span><br><span class="line">        line: <span class="string">&quot;&#123;&#123; hostvars[&#x27;kube-node-1&#x27;][&#x27;ssh_public_key&#x27;][&#x27;content&#x27;] | b64decode &#125;&#125;&quot;</span></span><br><span class="line">        state: present</span><br><span class="line">      when: inventory_hostname <span class="keyword">in</span> [<span class="string">&#x27;kube-node-2&#x27;</span>, <span class="string">&#x27;kube-node-3&#x27;</span>]</span><br><span class="line">EOF</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;Playbook file created.&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># --- Main Script Execution ---</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Starting Ansible SSH key setup process...&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 1. Install Ansible if not present</span></span><br><span class="line">install_ansible</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. Create Ansible inventory file</span></span><br><span class="line">create_inventory</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. Create Ansible playbook file</span></span><br><span class="line">create_playbook</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Setup complete. You can now run the Ansible playbook manually using:&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;ansible-playbook -i \&quot;<span class="variable">$INVENTORY_FILE</span>\&quot; \&quot;<span class="variable">$PLAYBOOK_FILE</span>\&quot; --ask-become-pass&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;You will be prompted for the &#x27;sudo&#x27; password for the &#x27;ubuntu&#x27; user on your VMs.&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Process complete.&quot;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">chmod</span> +x ansible_ssh.sh</span><br><span class="line">./ansible_ssh.sh</span><br><span class="line"></span><br><span class="line">ois@ois:~/data/k8s$ ./ansible_ssh.sh</span><br><span class="line">Starting Ansible SSH key setup process...</span><br><span class="line">Ansible is already installed.</span><br><span class="line">Creating Ansible inventory file: ansible_ssh_setup/hosts.ini</span><br><span class="line">Inventory file created.</span><br><span class="line">Creating Ansible playbook file: ansible_ssh_setup/setup_ssh.yml</span><br><span class="line">Playbook file created.</span><br><span class="line">Setup complete. You can now run the Ansible playbook manually using:</span><br><span class="line">ansible-playbook -i <span class="string">&quot;ansible_ssh_setup/hosts.ini&quot;</span> <span class="string">&quot;ansible_ssh_setup/setup_ssh.yml&quot;</span> --ask-become-pass</span><br><span class="line">You will be prompted <span class="keyword">for</span> the <span class="string">&#x27;sudo&#x27;</span> password <span class="keyword">for</span> the <span class="string">&#x27;ubuntu&#x27;</span> user on your VMs.</span><br><span class="line">Process complete.</span><br><span class="line">ois@ois:~/data/k8s$ <span class="built_in">cd</span> ansible_ssh_setup/</span><br><span class="line">ois@ois:~/data/k8s/ansible_ssh_setup$ ansible-playbook setup_ssh.yml -i hosts.ini -K</span><br><span class="line">BECOME password: </span><br><span class="line"></span><br><span class="line">PLAY [Generate SSH key on kube-node-1 and distribute to other nodes] ********************************************************************************************************</span><br><span class="line"></span><br><span class="line">TASK [Gathering Facts] ******************************************************************************************************************************************************</span><br><span class="line">ok: [kube-node-1]</span><br><span class="line">ok: [kube-node-3]</span><br><span class="line">ok: [kube-node-2]</span><br><span class="line"></span><br><span class="line">TASK [Generate SSH key on kube-node-1] **************************************************************************************************************************************</span><br><span class="line">skipping: [kube-node-2]</span><br><span class="line">skipping: [kube-node-3]</span><br><span class="line">changed: [kube-node-1]</span><br><span class="line"></span><br><span class="line">TASK [Ensure .ssh directory exists on all nodes] ****************************************************************************************************************************</span><br><span class="line">ok: [kube-node-2]</span><br><span class="line">ok: [kube-node-1]</span><br><span class="line">ok: [kube-node-3]</span><br><span class="line"></span><br><span class="line">TASK [Ensure authorized_keys file exists] ***********************************************************************************************************************************</span><br><span class="line">changed: [kube-node-1]</span><br><span class="line">changed: [kube-node-2]</span><br><span class="line">changed: [kube-node-3]</span><br><span class="line"></span><br><span class="line">TASK [Fetch public key from kube-node-1] ************************************************************************************************************************************</span><br><span class="line">skipping: [kube-node-2]</span><br><span class="line">skipping: [kube-node-3]</span><br><span class="line">ok: [kube-node-1]</span><br><span class="line"></span><br><span class="line">TASK [Distribute public key to kube-node-2 and kube-node-3] *****************************************************************************************************************</span><br><span class="line">skipping: [kube-node-1]</span><br><span class="line">changed: [kube-node-3]</span><br><span class="line">changed: [kube-node-2]</span><br><span class="line"></span><br><span class="line">PLAY RECAP ******************************************************************************************************************************************************************</span><br><span class="line">kube-node-1                : ok=5    changed=2    unreachable=0    failed=0    skipped=1    rescued=0    ignored=0   </span><br><span class="line">kube-node-2                : ok=4    changed=2    unreachable=0    failed=0    skipped=2    rescued=0    ignored=0   </span><br><span class="line">kube-node-3                : ok=4    changed=2    unreachable=0    failed=0    skipped=2    rescued=0    ignored=0   </span><br></pre></td></tr></table></figure>

<p>效果：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">root@kube-node-1:~<span class="comment"># ssh root@10.75.59.72</span></span><br><span class="line">Welcome to Ubuntu 24.04.2 LTS (GNU/Linux 6.8.0-63-generic x86_64)</span><br><span class="line"></span><br><span class="line"> * Documentation:  https://help.ubuntu.com</span><br><span class="line"> * Management:     https://landscape.canonical.com</span><br><span class="line"> * Support:        https://ubuntu.com/pro</span><br><span class="line"></span><br><span class="line"> System information as of Fri Aug  1 02:28:23 PM CST 2025</span><br><span class="line"></span><br><span class="line">  System load:  0.13               Processes:               188</span><br><span class="line">  Usage of /:   30.2% of 18.33GB   Users logged <span class="keyword">in</span>:         1</span><br><span class="line">  Memory usage: 10%                IPv4 address <span class="keyword">for</span> enp1s0: 10.75.59.72</span><br><span class="line">  Swap usage:   0%</span><br><span class="line"></span><br><span class="line"> * Strictly confined Kubernetes makes edge and IoT secure. Learn how MicroK8s</span><br><span class="line">   just raised the bar <span class="keyword">for</span> easy, resilient and secure K8s cluster deployment.</span><br><span class="line"></span><br><span class="line">   https://ubuntu.com/engage/secure-kubernetes-at-the-edge</span><br><span class="line"></span><br><span class="line">Expanded Security Maintenance <span class="keyword">for</span> Applications is not enabled.</span><br><span class="line"></span><br><span class="line">0 updates can be applied immediately.</span><br><span class="line"></span><br><span class="line">Enable ESM Apps to receive additional future security updates.</span><br><span class="line">See https://ubuntu.com/esm or run: sudo pro status</span><br><span class="line"></span><br><span class="line">*** System restart required ***</span><br></pre></td></tr></table></figure>

<h2 id="6-2-自动化安装设置脚本"><a href="#6-2-自动化安装设置脚本" class="headerlink" title="6.2 自动化安装设置脚本"></a>6.2 自动化安装设置脚本</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ==============================================================================</span></span><br><span class="line"><span class="comment"># Idempotent Kubernetes and Cilium Setup Script</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># This script can be run multiple times. It checks the current state</span></span><br><span class="line"><span class="comment"># at each step and only performs actions if necessary.</span></span><br><span class="line"><span class="comment"># It must be run as root on the primary control-plane node.</span></span><br><span class="line"><span class="comment"># ==============================================================================</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># --- Configuration ---</span></span><br><span class="line">CONTROL_PLANE_ENDPOINT=<span class="string">&quot;kube-node-1&quot;</span></span><br><span class="line">CONTROL_PLANE_IP=<span class="string">&quot;10.75.59.71&quot;</span></span><br><span class="line">WORKER_NODES=(<span class="string">&quot;10.75.59.72&quot;</span> <span class="string">&quot;10.75.59.73&quot;</span>)</span><br><span class="line">POD_CIDR=<span class="string">&quot;172.16.0.0/20&quot;</span></span><br><span class="line">SERVICE_CIDR=<span class="string">&quot;172.16.32.0/20&quot;</span></span><br><span class="line">BGP_PEER_IP=<span class="string">&quot;10.75.59.76&quot;</span></span><br><span class="line">LOCAL_ASN=65000</span><br><span class="line">PEER_ASN=65000</span><br><span class="line">CILIUM_VERSION=<span class="string">&quot;1.17.6&quot;</span></span><br><span class="line">HUBBLE_UI_VERSION=<span class="string">&quot;1.3.6&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ==============================================================================</span></span><br><span class="line"><span class="comment"># Helper Function</span></span><br><span class="line"><span class="comment"># ==============================================================================</span></span><br><span class="line"><span class="function"><span class="title">print_header</span></span>() &#123; <span class="built_in">echo</span> -e <span class="string">&quot;\n### <span class="variable">$1</span> ###&quot;</span>; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># ==============================================================================</span></span><br><span class="line"><span class="comment"># STEP 1: Initialize Kubernetes Control-Plane</span></span><br><span class="line"><span class="comment"># ==============================================================================</span></span><br><span class="line">print_header <span class="string">&quot;STEP 1: Initializing Kubernetes Control-Plane&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> kubectl get nodes &amp;&gt; /dev/null; <span class="keyword">then</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;✅ Kubernetes cluster is already running. Skipping kubeadm init.&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;--&gt; Kubernetes cluster not found. Initializing...&quot;</span></span><br><span class="line">  kubeadm config images pull</span><br><span class="line">  kubeadm init \</span><br><span class="line">    --control-plane-endpoint=<span class="variable">$&#123;CONTROL_PLANE_ENDPOINT&#125;</span> \</span><br><span class="line">    --pod-network-cidr=<span class="variable">$&#123;POD_CIDR&#125;</span> \</span><br><span class="line">    --service-cidr=<span class="variable">$&#123;SERVICE_CIDR&#125;</span> \</span><br><span class="line">    --skip-phases=addon/kube-proxy</span><br><span class="line">  <span class="built_in">mkdir</span> -p /root/.kube</span><br><span class="line">  <span class="built_in">cp</span> -i /etc/kubernetes/admin.conf /root/.kube/config</span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;✅ Control-Plane initialization complete.&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ==============================================================================</span></span><br><span class="line"><span class="comment"># STEP 2: Install or Upgrade Cilium CNI</span></span><br><span class="line"><span class="comment"># ==============================================================================</span></span><br><span class="line">print_header <span class="string">&quot;STEP 2: Installing or Upgrading Cilium CNI&quot;</span></span><br><span class="line"></span><br><span class="line">helm repo add cilium https://helm.cilium.io/ &amp;&gt; /dev/null</span><br><span class="line">helm repo add isovalent https://helm.isovalent.com/ &amp;&gt; /dev/null</span><br><span class="line">helm repo update &gt; /dev/null</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &gt; cilium-values.yaml &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">hubble:</span></span><br><span class="line"><span class="string">  enabled: true</span></span><br><span class="line"><span class="string">  relay:</span></span><br><span class="line"><span class="string">    enabled: true</span></span><br><span class="line"><span class="string">  ui:</span></span><br><span class="line"><span class="string">    enabled: false</span></span><br><span class="line"><span class="string">ipam:</span></span><br><span class="line"><span class="string">  mode: kubernetes</span></span><br><span class="line"><span class="string">ipv4NativeRoutingCIDR: $&#123;POD_CIDR&#125;</span></span><br><span class="line"><span class="string">k8s:</span></span><br><span class="line"><span class="string">  requireIPv4PodCIDR: true</span></span><br><span class="line"><span class="string">routingMode: native</span></span><br><span class="line"><span class="string">autoDirectNodeRoutes: true</span></span><br><span class="line"><span class="string">enableIPv4Masquerade: true</span></span><br><span class="line"><span class="string">bgpControlPlane:</span></span><br><span class="line"><span class="string">  enabled: true</span></span><br><span class="line"><span class="string">  announce:</span></span><br><span class="line"><span class="string">    podCIDR: true</span></span><br><span class="line"><span class="string">kubeProxyReplacement: true</span></span><br><span class="line"><span class="string">bpf:</span></span><br><span class="line"><span class="string">  masquerade: true</span></span><br><span class="line"><span class="string">  lb:</span></span><br><span class="line"><span class="string">    externalClusterIP: true</span></span><br><span class="line"><span class="string">    sock: true</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> helm status cilium -n kube-system &amp;&gt; /dev/null; <span class="keyword">then</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;--&gt; Cilium is already installed. Upgrading to apply latest configuration...&quot;</span></span><br><span class="line">  helm upgrade cilium isovalent/cilium --version <span class="variable">$&#123;CILIUM_VERSION&#125;</span> --namespace kube-system --<span class="built_in">set</span> k8sServiceHost=<span class="variable">$&#123;CONTROL_PLANE_IP&#125;</span>,k8sServicePort=6443 -f cilium-values.yaml</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;--&gt; Cilium not found. Installing...&quot;</span></span><br><span class="line">  helm install cilium isovalent/cilium --version <span class="variable">$&#123;CILIUM_VERSION&#125;</span> --namespace kube-system --<span class="built_in">set</span> k8sServiceHost=<span class="variable">$&#123;CONTROL_PLANE_IP&#125;</span>,k8sServicePort=6443 -f cilium-values.yaml</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;--&gt; Waiting for Cilium pods to become ready...&quot;</span></span><br><span class="line">kubectl -n kube-system <span class="built_in">wait</span> --<span class="keyword">for</span>=condition=Ready pod -l k8s-app=cilium --<span class="built_in">timeout</span>=5m</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;✅ Cilium is configured.&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ==============================================================================</span></span><br><span class="line"><span class="comment"># STEP 3: Join Worker Nodes to the Cluster</span></span><br><span class="line"><span class="comment"># ==============================================================================</span></span><br><span class="line">print_header <span class="string">&quot;STEP 3: Joining Worker Nodes&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> NODE_IP <span class="keyword">in</span> <span class="string">&quot;<span class="variable">$&#123;WORKER_NODES[@]&#125;</span>&quot;</span>; <span class="keyword">do</span></span><br><span class="line">  <span class="keyword">if</span> kubectl get nodes -o wide | grep -q <span class="string">&quot;<span class="variable">$NODE_IP</span>&quot;</span>; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;✅ Node <span class="variable">$&#123;NODE_IP&#125;</span> is already in the cluster. Skipping join.&quot;</span></span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;--&gt; Node <span class="variable">$&#123;NODE_IP&#125;</span> not found in cluster. Attempting to join...&quot;</span></span><br><span class="line">    JOIN_COMMAND=$(kubeadm token create --print-join-command)</span><br><span class="line">    ssh -o StrictHostKeyChecking=no root@<span class="variable">$&#123;NODE_IP&#125;</span> <span class="string">&quot;<span class="variable">$&#123;JOIN_COMMAND&#125;</span>&quot;</span></span><br><span class="line">    <span class="keyword">if</span> [ $? -ne 0 ]; <span class="keyword">then</span></span><br><span class="line">      <span class="built_in">echo</span> <span class="string">&quot;❌ Failed to join node <span class="variable">$&#123;NODE_IP&#125;</span>. Please check SSH connectivity and logs.&quot;</span> &gt;&amp;2</span><br><span class="line">      <span class="built_in">exit</span> 1</span><br><span class="line">    <span class="keyword">fi</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&quot;✅ Node <span class="variable">$&#123;NODE_IP&#125;</span> joined successfully.&quot;</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ==============================================================================</span></span><br><span class="line"><span class="comment"># STEP 4: Install Cilium CLI</span></span><br><span class="line"><span class="comment"># ==============================================================================</span></span><br><span class="line">print_header <span class="string">&quot;STEP 4: Installing Cilium CLI&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> <span class="built_in">command</span> -v cilium &amp;&gt; /dev/null; <span class="keyword">then</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;✅ Cilium CLI is already installed. Skipping.&quot;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;--&gt; Installing Cilium CLI...&quot;</span></span><br><span class="line">  curl -L --silent --remote-name-all https://github.com/isovalent/cilium-cli-releases/releases/latest/download/cilium-linux-amd64.tar.gz&#123;,.<span class="built_in">sha256sum</span>&#125;</span><br><span class="line">  <span class="built_in">sha256sum</span> --check cilium-linux-amd64.tar.gz.sha256sum &gt; /dev/null</span><br><span class="line">  tar xzvfC cilium-linux-amd64.tar.gz /usr/local/bin &gt; /dev/null</span><br><span class="line">  <span class="built_in">rm</span> cilium-linux-amd64.tar.gz cilium-linux-amd64.tar.gz.sha256sum</span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;✅ Cilium CLI installed.&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ==============================================================================</span></span><br><span class="line"><span class="comment"># STEP 5: Configure Cilium BGP Peering</span></span><br><span class="line"><span class="comment"># ==============================================================================</span></span><br><span class="line">print_header <span class="string">&quot;STEP 5: Configuring Cilium BGP Peering&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;--&gt; Applying BGP configuration. &#x27;unchanged&#x27; means it&#x27;s already correct.&quot;</span></span><br><span class="line"><span class="comment"># CORRECTION: Using the correct schema with matchLabels.</span></span><br><span class="line"><span class="built_in">cat</span> &gt; cilium-bgp.yaml &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">apiVersion: cilium.io/v2alpha1</span></span><br><span class="line"><span class="string">kind: CiliumBGPAdvertisement</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: bgp-advertisements</span></span><br><span class="line"><span class="string">  labels:</span></span><br><span class="line"><span class="string">    advertise: bgp</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  advertisements:</span></span><br><span class="line"><span class="string">    - advertisementType: &quot;PodCIDR&quot;              # Only for Kubernetes or ClusterPool IPAM cluster-pool</span></span><br><span class="line"><span class="string">    - advertisementType: &quot;Service&quot;</span></span><br><span class="line"><span class="string">      service:</span></span><br><span class="line"><span class="string">        addresses:</span></span><br><span class="line"><span class="string">          - ClusterIP</span></span><br><span class="line"><span class="string">          - ExternalIP</span></span><br><span class="line"><span class="string">          #- LoadBalancerIP</span></span><br><span class="line"><span class="string">      selector:</span></span><br><span class="line"><span class="string">        matchExpressions:</span></span><br><span class="line"><span class="string">        - &#123;key: somekey, operator: NotIn, values: [&#x27;never-used-value&#x27;]&#125; </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">apiVersion: cilium.io/v2alpha1</span></span><br><span class="line"><span class="string">kind: CiliumBGPPeerConfig</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: cilium-peer</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  timers:</span></span><br><span class="line"><span class="string">    holdTimeSeconds: 30             #default 90s</span></span><br><span class="line"><span class="string">    keepAliveTimeSeconds: 10  #default 30s</span></span><br><span class="line"><span class="string">    connectRetryTimeSeconds: 40  #default 120s</span></span><br><span class="line"><span class="string">  gracefulRestart:</span></span><br><span class="line"><span class="string">    enabled: true</span></span><br><span class="line"><span class="string">    restartTimeSeconds: 120        #default 120s</span></span><br><span class="line"><span class="string">  #transport:</span></span><br><span class="line"><span class="string">  #  peerPort: 179</span></span><br><span class="line"><span class="string">  families:</span></span><br><span class="line"><span class="string">    - afi: ipv4</span></span><br><span class="line"><span class="string">      safi: unicast</span></span><br><span class="line"><span class="string">      advertisements:</span></span><br><span class="line"><span class="string">        matchLabels:</span></span><br><span class="line"><span class="string">          advertise: &quot;bgp&quot;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">---</span></span><br><span class="line"><span class="string">apiVersion: cilium.io/v2alpha1</span></span><br><span class="line"><span class="string">kind: CiliumBGPClusterConfig</span></span><br><span class="line"><span class="string">metadata:</span></span><br><span class="line"><span class="string">  name: cilium-bgp-default</span></span><br><span class="line"><span class="string">spec:</span></span><br><span class="line"><span class="string">  bgpInstances:</span></span><br><span class="line"><span class="string">  - name: &quot;instance-65000&quot;</span></span><br><span class="line"><span class="string">    localASN: $&#123;LOCAL_ASN&#125;</span></span><br><span class="line"><span class="string">    peers:</span></span><br><span class="line"><span class="string">    - name: &quot;FRR_BGP&quot;</span></span><br><span class="line"><span class="string">      peerASN: $&#123;PEER_ASN&#125;</span></span><br><span class="line"><span class="string">      peerAddress: $&#123;BGP_PEER_IP&#125;</span></span><br><span class="line"><span class="string">      peerConfigRef:</span></span><br><span class="line"><span class="string">        name: &quot;cilium-peer&quot;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Apply the configuration and check for errors</span></span><br><span class="line">kubectl apply -f cilium-bgp.yaml</span><br><span class="line"><span class="keyword">if</span> [ $? -ne 0 ]; <span class="keyword">then</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;❌ Failed to apply BGP configuration. Please check the errors above.&quot;</span> &gt;&amp;2</span><br><span class="line">  <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;✅ BGP configuration applied.&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ==============================================================================</span></span><br><span class="line"><span class="comment"># STEP 6: Install or Upgrade Hubble UI</span></span><br><span class="line"><span class="comment"># ==============================================================================</span></span><br><span class="line">print_header <span class="string">&quot;STEP 6: Installing or Upgrading Hubble UI&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> &gt; hubble-ui-values.yaml &lt;&lt; <span class="string">EOF</span></span><br><span class="line"><span class="string">relay:</span></span><br><span class="line"><span class="string">  address: &quot;hubble-relay.kube-system.svc.cluster.local&quot;</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> helm status hubble-ui -n kube-system &amp;&gt; /dev/null; <span class="keyword">then</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;--&gt; Hubble UI is already installed. Upgrading...&quot;</span></span><br><span class="line">  helm upgrade hubble-ui isovalent/hubble-ui --version <span class="variable">$&#123;HUBBLE_UI_VERSION&#125;</span> --namespace kube-system --values hubble-ui-values.yaml --<span class="built_in">wait</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;--&gt; Hubble UI not found. Installing...&quot;</span></span><br><span class="line">  helm install hubble-ui isovalent/hubble-ui --version <span class="variable">$&#123;HUBBLE_UI_VERSION&#125;</span> --namespace kube-system --values hubble-ui-values.yaml --<span class="built_in">wait</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">SERVICE_TYPE=$(kubectl get service hubble-ui -n kube-system -o jsonpath=<span class="string">&#x27;&#123;.spec.type&#125;&#x27;</span>)</span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$SERVICE_TYPE</span>&quot;</span> != <span class="string">&quot;NodePort&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;--&gt; Patching Hubble UI service to NodePort...&quot;</span></span><br><span class="line">  kubectl patch service hubble-ui -n kube-system -p <span class="string">&#x27;&#123;&quot;spec&quot;: &#123;&quot;type&quot;: &quot;NodePort&quot;&#125;&#125;&#x27;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&quot;--&gt; Hubble UI service is already of type NodePort.&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;✅ Hubble UI is configured.&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ==============================================================================</span></span><br><span class="line"><span class="comment"># STEP 7: Final Verification</span></span><br><span class="line"><span class="comment"># ==============================================================================</span></span><br><span class="line">print_header <span class="string">&quot;STEP 7: Final Verification&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;--&gt; Waiting for all nodes to be ready...&quot;</span></span><br><span class="line">kubectl <span class="built_in">wait</span> --<span class="keyword">for</span>=condition=Ready node --all --<span class="built_in">timeout</span>=5m</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;--&gt; Checking Cilium status...&quot;</span></span><br><span class="line">cilium status --<span class="built_in">wait</span></span><br><span class="line"></span><br><span class="line">HUBBLE_UI_PORT=$(kubectl get service hubble-ui -n kube-system -o jsonpath=<span class="string">&#x27;&#123;.spec.ports[0].nodePort&#125;&#x27;</span>)</span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;\n----------------------------------------------------------------&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;🚀 Cluster setup is complete and verified!&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;Access Hubble UI at: http://<span class="variable">$&#123;CONTROL_PLANE_IP&#125;</span>:<span class="variable">$&#123;HUBBLE_UI_PORT&#125;</span>&quot;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;----------------------------------------------------------------&quot;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br></pre></td><td class="code"><pre><span class="line">root@kube-node-1:~<span class="comment"># ./k8s-cilium-setup.sh </span></span><br><span class="line"><span class="comment">### STEP 1: Initializing Kubernetes Control-Plane on kube-node-1... ###</span></span><br><span class="line">--&gt; Pulling Kubernetes container images...</span><br><span class="line">[config/images] Pulled registry.k8s.io/kube-apiserver:v1.33.3</span><br><span class="line">[config/images] Pulled registry.k8s.io/kube-controller-manager:v1.33.3</span><br><span class="line">[config/images] Pulled registry.k8s.io/kube-scheduler:v1.33.3</span><br><span class="line">[config/images] Pulled registry.k8s.io/kube-proxy:v1.33.3</span><br><span class="line">[config/images] Pulled registry.k8s.io/coredns/coredns:v1.12.0</span><br><span class="line">[config/images] Pulled registry.k8s.io/pause:3.10</span><br><span class="line">[config/images] Pulled registry.k8s.io/etcd:3.5.21-0</span><br><span class="line">--&gt; Running kubeadm init...</span><br><span class="line">[init] Using Kubernetes version: v1.33.3</span><br><span class="line">[preflight] Running pre-flight checks</span><br><span class="line">[preflight] Pulling images required <span class="keyword">for</span> setting up a Kubernetes cluster</span><br><span class="line">[preflight] This might take a minute or two, depending on the speed of your internet connection</span><br><span class="line">[preflight] You can also perform this action beforehand using <span class="string">&#x27;kubeadm config images pull&#x27;</span></span><br><span class="line">[certs] Using certificateDir folder <span class="string">&quot;/etc/kubernetes/pki&quot;</span></span><br><span class="line">[certs] Generating <span class="string">&quot;ca&quot;</span> certificate and key</span><br><span class="line">[certs] Generating <span class="string">&quot;apiserver&quot;</span> certificate and key</span><br><span class="line">[certs] apiserver serving cert is signed <span class="keyword">for</span> DNS names [kube-node-1 kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local] and IPs [172.16.32.1 10.75.59.71]</span><br><span class="line">[certs] Generating <span class="string">&quot;apiserver-kubelet-client&quot;</span> certificate and key</span><br><span class="line">[certs] Generating <span class="string">&quot;front-proxy-ca&quot;</span> certificate and key</span><br><span class="line">[certs] Generating <span class="string">&quot;front-proxy-client&quot;</span> certificate and key</span><br><span class="line">[certs] Generating <span class="string">&quot;etcd/ca&quot;</span> certificate and key</span><br><span class="line">[certs] Generating <span class="string">&quot;etcd/server&quot;</span> certificate and key</span><br><span class="line">[certs] etcd/server serving cert is signed <span class="keyword">for</span> DNS names [kube-node-1 localhost] and IPs [10.75.59.71 127.0.0.1 ::1]</span><br><span class="line">[certs] Generating <span class="string">&quot;etcd/peer&quot;</span> certificate and key</span><br><span class="line">[certs] etcd/peer serving cert is signed <span class="keyword">for</span> DNS names [kube-node-1 localhost] and IPs [10.75.59.71 127.0.0.1 ::1]</span><br><span class="line">[certs] Generating <span class="string">&quot;etcd/healthcheck-client&quot;</span> certificate and key</span><br><span class="line">[certs] Generating <span class="string">&quot;apiserver-etcd-client&quot;</span> certificate and key</span><br><span class="line">[certs] Generating <span class="string">&quot;sa&quot;</span> key and public key</span><br><span class="line">[kubeconfig] Using kubeconfig folder <span class="string">&quot;/etc/kubernetes&quot;</span></span><br><span class="line">[kubeconfig] Writing <span class="string">&quot;admin.conf&quot;</span> kubeconfig file</span><br><span class="line">[kubeconfig] Writing <span class="string">&quot;super-admin.conf&quot;</span> kubeconfig file</span><br><span class="line">[kubeconfig] Writing <span class="string">&quot;kubelet.conf&quot;</span> kubeconfig file</span><br><span class="line">[kubeconfig] Writing <span class="string">&quot;controller-manager.conf&quot;</span> kubeconfig file</span><br><span class="line">[kubeconfig] Writing <span class="string">&quot;scheduler.conf&quot;</span> kubeconfig file</span><br><span class="line">[etcd] Creating static Pod manifest <span class="keyword">for</span> <span class="built_in">local</span> etcd <span class="keyword">in</span> <span class="string">&quot;/etc/kubernetes/manifests&quot;</span></span><br><span class="line">[control-plane] Using manifest folder <span class="string">&quot;/etc/kubernetes/manifests&quot;</span></span><br><span class="line">[control-plane] Creating static Pod manifest <span class="keyword">for</span> <span class="string">&quot;kube-apiserver&quot;</span></span><br><span class="line">[control-plane] Creating static Pod manifest <span class="keyword">for</span> <span class="string">&quot;kube-controller-manager&quot;</span></span><br><span class="line">[control-plane] Creating static Pod manifest <span class="keyword">for</span> <span class="string">&quot;kube-scheduler&quot;</span></span><br><span class="line">[kubelet-start] Writing kubelet environment file with flags to file <span class="string">&quot;/var/lib/kubelet/kubeadm-flags.env&quot;</span></span><br><span class="line">[kubelet-start] Writing kubelet configuration to file <span class="string">&quot;/var/lib/kubelet/config.yaml&quot;</span></span><br><span class="line">[kubelet-start] Starting the kubelet</span><br><span class="line">[wait-control-plane] Waiting <span class="keyword">for</span> the kubelet to boot up the control plane as static Pods from directory <span class="string">&quot;/etc/kubernetes/manifests&quot;</span></span><br><span class="line">[kubelet-check] Waiting <span class="keyword">for</span> a healthy kubelet at http://127.0.0.1:10248/healthz. This can take up to 4m0s</span><br><span class="line">[kubelet-check] The kubelet is healthy after 1.001873284s</span><br><span class="line">[control-plane-check] Waiting <span class="keyword">for</span> healthy control plane components. This can take up to 4m0s</span><br><span class="line">[control-plane-check] Checking kube-apiserver at https://10.75.59.71:6443/livez</span><br><span class="line">[control-plane-check] Checking kube-controller-manager at https://127.0.0.1:10257/healthz</span><br><span class="line">[control-plane-check] Checking kube-scheduler at https://127.0.0.1:10259/livez</span><br><span class="line">[control-plane-check] kube-controller-manager is healthy after 2.272937689s</span><br><span class="line">[control-plane-check] kube-scheduler is healthy after 3.04977489s</span><br><span class="line">[control-plane-check] kube-apiserver is healthy after 5.003048769s</span><br><span class="line">[upload-config] Storing the configuration used <span class="keyword">in</span> ConfigMap <span class="string">&quot;kubeadm-config&quot;</span> <span class="keyword">in</span> the <span class="string">&quot;kube-system&quot;</span> Namespace</span><br><span class="line">[kubelet] Creating a ConfigMap <span class="string">&quot;kubelet-config&quot;</span> <span class="keyword">in</span> namespace kube-system with the configuration <span class="keyword">for</span> the kubelets <span class="keyword">in</span> the cluster</span><br><span class="line">[upload-certs] Skipping phase. Please see --upload-certs</span><br><span class="line">[mark-control-plane] Marking the node kube-node-1 as control-plane by adding the labels: [node-role.kubernetes.io/control-plane node.kubernetes.io/exclude-from-external-load-balancers]</span><br><span class="line">[mark-control-plane] Marking the node kube-node-1 as control-plane by adding the taints [node-role.kubernetes.io/control-plane:NoSchedule]</span><br><span class="line">[bootstrap-token] Using token: 0q5m6l.5pc7hz15orcc0b6b</span><br><span class="line">[bootstrap-token] Configuring bootstrap tokens, cluster-info ConfigMap, RBAC Roles</span><br><span class="line">[bootstrap-token] Configured RBAC rules to allow Node Bootstrap tokens to get nodes</span><br><span class="line">[bootstrap-token] Configured RBAC rules to allow Node Bootstrap tokens to post CSRs <span class="keyword">in</span> order <span class="keyword">for</span> nodes to get long term certificate credentials</span><br><span class="line">[bootstrap-token] Configured RBAC rules to allow the csrapprover controller automatically approve CSRs from a Node Bootstrap Token</span><br><span class="line">[bootstrap-token] Configured RBAC rules to allow certificate rotation <span class="keyword">for</span> all node client certificates <span class="keyword">in</span> the cluster</span><br><span class="line">[bootstrap-token] Creating the <span class="string">&quot;cluster-info&quot;</span> ConfigMap <span class="keyword">in</span> the <span class="string">&quot;kube-public&quot;</span> namespace</span><br><span class="line">[kubelet-finalize] Updating <span class="string">&quot;/etc/kubernetes/kubelet.conf&quot;</span> to point to a rotatable kubelet client certificate and key</span><br><span class="line">[addons] Applied essential addon: CoreDNS</span><br><span class="line"></span><br><span class="line">Your Kubernetes control-plane has initialized successfully!</span><br><span class="line"></span><br><span class="line">To start using your cluster, you need to run the following as a regular user:</span><br><span class="line"></span><br><span class="line">  <span class="built_in">mkdir</span> -p <span class="variable">$HOME</span>/.kube</span><br><span class="line">  sudo <span class="built_in">cp</span> -i /etc/kubernetes/admin.conf <span class="variable">$HOME</span>/.kube/config</span><br><span class="line">  sudo <span class="built_in">chown</span> $(<span class="built_in">id</span> -u):$(<span class="built_in">id</span> -g) <span class="variable">$HOME</span>/.kube/config</span><br><span class="line"></span><br><span class="line">Alternatively, <span class="keyword">if</span> you are the root user, you can run:</span><br><span class="line"></span><br><span class="line">  <span class="built_in">export</span> KUBECONFIG=/etc/kubernetes/admin.conf</span><br><span class="line"></span><br><span class="line">You should now deploy a pod network to the cluster.</span><br><span class="line">Run <span class="string">&quot;kubectl apply -f [podnetwork].yaml&quot;</span> with one of the options listed at:</span><br><span class="line">  https://kubernetes.io/docs/concepts/cluster-administration/addons/</span><br><span class="line"></span><br><span class="line">You can now <span class="built_in">join</span> any number of control-plane nodes by copying certificate authorities</span><br><span class="line">and service account keys on each node and <span class="keyword">then</span> running the following as root:</span><br><span class="line"></span><br><span class="line">  kubeadm <span class="built_in">join</span> kube-node-1:6443 --token 0q5m6l.5pc7hz15orcc0b6b \</span><br><span class="line">        --discovery-token-ca-cert-hash sha256:4795595e8237c54f1bf20c7fb56feea9a1960af5802c08c410733d54b5e317a6 \</span><br><span class="line">        --control-plane </span><br><span class="line"></span><br><span class="line">Then you can <span class="built_in">join</span> any number of worker nodes by running the following on each as root:</span><br><span class="line"></span><br><span class="line">kubeadm <span class="built_in">join</span> kube-node-1:6443 --token 0q5m6l.5pc7hz15orcc0b6b \</span><br><span class="line">        --discovery-token-ca-cert-hash sha256:4795595e8237c54f1bf20c7fb56feea9a1960af5802c08c410733d54b5e317a6 </span><br><span class="line">--&gt; Configuring kubectl...</span><br><span class="line">✅ Control-Plane initialization complete.</span><br><span class="line"><span class="comment">### STEP 2: Installing Cilium... ###</span></span><br><span class="line">--&gt; Adding Helm repositories...</span><br><span class="line"><span class="string">&quot;cilium&quot;</span> has been added to your repositories</span><br><span class="line"><span class="string">&quot;isovalent&quot;</span> has been added to your repositories</span><br><span class="line">Hang tight <span class="keyword">while</span> we grab the latest from your chart repositories...</span><br><span class="line">...Successfully got an update from the <span class="string">&quot;cilium&quot;</span> chart repository</span><br><span class="line">...Successfully got an update from the <span class="string">&quot;isovalent&quot;</span> chart repository</span><br><span class="line">Update Complete. ⎈Happy Helming!⎈</span><br><span class="line">--&gt; Creating cilium-enterprise-values.yaml...</span><br><span class="line">--&gt; Installing Cilium with Helm...</span><br><span class="line">NAME: cilium</span><br><span class="line">LAST DEPLOYED: Fri Aug  1 14:16:16 2025</span><br><span class="line">NAMESPACE: kube-system</span><br><span class="line">STATUS: deployed</span><br><span class="line">REVISION: 1</span><br><span class="line">TEST SUITE: None</span><br><span class="line">NOTES:</span><br><span class="line">You have successfully installed Cilium with Hubble Relay.</span><br><span class="line"></span><br><span class="line">Your release version is 1.17.6.</span><br><span class="line"></span><br><span class="line">For any further <span class="built_in">help</span>, visit https://docs.isovalent.com/v1.17</span><br><span class="line">--&gt; Waiting <span class="keyword">for</span> Cilium pods to become ready...</span><br><span class="line">pod/cilium-5ngcm condition met</span><br><span class="line">✅ Cilium installation complete.</span><br><span class="line"><span class="comment">### STEP 3: Joining Worker Nodes... ###</span></span><br><span class="line">--&gt; Generated <span class="built_in">join</span> <span class="built_in">command</span>: kubeadm <span class="built_in">join</span> kube-node-1:6443 --token whltm8.4zs5af6hiht167da --discovery-token-ca-cert-hash sha256:4795595e8237c54f1bf20c7fb56feea9a1960af5802c08c410733d54b5e317a6 </span><br><span class="line">--&gt; Joining node 10.75.59.72 to the cluster...</span><br><span class="line">[preflight] Running pre-flight checks</span><br><span class="line">[preflight] Reading configuration from the <span class="string">&quot;kubeadm-config&quot;</span> ConfigMap <span class="keyword">in</span> namespace <span class="string">&quot;kube-system&quot;</span>...</span><br><span class="line">[preflight] Use <span class="string">&#x27;kubeadm init phase upload-config --config your-config-file&#x27;</span> to re-upload it.</span><br><span class="line">W0801 14:18:01.674767   20870 configset.go:78] Warning: No kubeproxy.config.k8s.io/v1alpha1 config is loaded. Continuing without it: configmaps <span class="string">&quot;kube-proxy&quot;</span> is forbidden: User <span class="string">&quot;system:bootstrap:whltm8&quot;</span> cannot get resource <span class="string">&quot;configmaps&quot;</span> <span class="keyword">in</span> API group <span class="string">&quot;&quot;</span> <span class="keyword">in</span> the namespace <span class="string">&quot;kube-system&quot;</span></span><br><span class="line">[kubelet-start] Writing kubelet configuration to file <span class="string">&quot;/var/lib/kubelet/config.yaml&quot;</span></span><br><span class="line">[kubelet-start] Writing kubelet environment file with flags to file <span class="string">&quot;/var/lib/kubelet/kubeadm-flags.env&quot;</span></span><br><span class="line">[kubelet-start] Starting the kubelet</span><br><span class="line">[kubelet-check] Waiting <span class="keyword">for</span> a healthy kubelet at http://127.0.0.1:10248/healthz. This can take up to 4m0s</span><br><span class="line">[kubelet-check] The kubelet is healthy after 1.501212696s</span><br><span class="line">[kubelet-start] Waiting <span class="keyword">for</span> the kubelet to perform the TLS Bootstrap</span><br><span class="line"></span><br><span class="line">This node has joined the cluster:</span><br><span class="line">* Certificate signing request was sent to apiserver and a response was received.</span><br><span class="line">* The Kubelet was informed of the new secure connection details.</span><br><span class="line"></span><br><span class="line">Run <span class="string">&#x27;kubectl get nodes&#x27;</span> on the control-plane to see this node <span class="built_in">join</span> the cluster.</span><br><span class="line"></span><br><span class="line">✅ Node 10.75.59.72 joined successfully.</span><br><span class="line">--&gt; Joining node 10.75.59.73 to the cluster...</span><br><span class="line">[preflight] Running pre-flight checks</span><br><span class="line">[preflight] Reading configuration from the <span class="string">&quot;kubeadm-config&quot;</span> ConfigMap <span class="keyword">in</span> namespace <span class="string">&quot;kube-system&quot;</span>...</span><br><span class="line">[preflight] Use <span class="string">&#x27;kubeadm init phase upload-config --config your-config-file&#x27;</span> to re-upload it.</span><br><span class="line">W0801 14:18:07.347008   20684 configset.go:78] Warning: No kubeproxy.config.k8s.io/v1alpha1 config is loaded. Continuing without it: configmaps <span class="string">&quot;kube-proxy&quot;</span> is forbidden: User <span class="string">&quot;system:bootstrap:whltm8&quot;</span> cannot get resource <span class="string">&quot;configmaps&quot;</span> <span class="keyword">in</span> API group <span class="string">&quot;&quot;</span> <span class="keyword">in</span> the namespace <span class="string">&quot;kube-system&quot;</span></span><br><span class="line">[kubelet-start] Writing kubelet configuration to file <span class="string">&quot;/var/lib/kubelet/config.yaml&quot;</span></span><br><span class="line">[kubelet-start] Writing kubelet environment file with flags to file <span class="string">&quot;/var/lib/kubelet/kubeadm-flags.env&quot;</span></span><br><span class="line">[kubelet-start] Starting the kubelet</span><br><span class="line">[kubelet-check] Waiting <span class="keyword">for</span> a healthy kubelet at http://127.0.0.1:10248/healthz. This can take up to 4m0s</span><br><span class="line">[kubelet-check] The kubelet is healthy after 1.002187345s</span><br><span class="line">[kubelet-start] Waiting <span class="keyword">for</span> the kubelet to perform the TLS Bootstrap</span><br><span class="line"></span><br><span class="line">This node has joined the cluster:</span><br><span class="line">* Certificate signing request was sent to apiserver and a response was received.</span><br><span class="line">* The Kubelet was informed of the new secure connection details.</span><br><span class="line"></span><br><span class="line">Run <span class="string">&#x27;kubectl get nodes&#x27;</span> on the control-plane to see this node <span class="built_in">join</span> the cluster.</span><br><span class="line"></span><br><span class="line">✅ Node 10.75.59.73 joined successfully.</span><br><span class="line"><span class="comment">### STEP 4: Installing the Cilium CLI... ###</span></span><br><span class="line">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span><br><span class="line">                                 Dload  Upload   Total   Spent    Left  Speed</span><br><span class="line">  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0</span><br><span class="line">  0     0    0     0    0     0      0      0 --:--:--  0:00:01 --:--:--     0</span><br><span class="line">100 59.2M  100 59.2M    0     0  13.1M      0  0:00:04  0:00:04 --:--:-- 23.8M</span><br><span class="line">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</span><br><span class="line">                                 Dload  Upload   Total   Spent    Left  Speed</span><br><span class="line">  0     0    0     0    0     0      0      0 --:--:-- --:--:-- --:--:--     0</span><br><span class="line">  0     0    0     0    0     0      0      0 --:--:--  0:00:01 --:--:--     0</span><br><span class="line">100    92  100    92    0     0     70      0  0:00:01  0:00:01 --:--:--    70</span><br><span class="line">cilium-linux-amd64.tar.gz: OK</span><br><span class="line">cilium</span><br><span class="line">✅ Cilium CLI installed.</span><br><span class="line"><span class="comment">### STEP 5: Configuring Cilium BGP Peering ###</span></span><br><span class="line">--&gt; Applying BGP configuration. <span class="string">&#x27;unchanged&#x27;</span> means it<span class="string">&#x27;s already correct.</span></span><br><span class="line"><span class="string">ciliumbgpadvertisement.cilium.io/bgp-advertisements unchanged</span></span><br><span class="line"><span class="string">ciliumbgppeerconfig.cilium.io/cilium-peer unchanged</span></span><br><span class="line"><span class="string">ciliumbgpclusterconfig.cilium.io/cilium-bgp-default configured</span></span><br><span class="line"><span class="string">✅ BGP configuration applied.</span></span><br><span class="line"><span class="string">### STEP 6: Installing Hubble UI... ###</span></span><br><span class="line"><span class="string">--&gt; Creating hubble-ui-values.yaml...</span></span><br><span class="line"><span class="string">--&gt; Installing Hubble UI with Helm...</span></span><br><span class="line"><span class="string">NAME: hubble-ui</span></span><br><span class="line"><span class="string">LAST DEPLOYED: Fri Aug  1 14:18:18 2025</span></span><br><span class="line"><span class="string">NAMESPACE: kube-system</span></span><br><span class="line"><span class="string">STATUS: deployed</span></span><br><span class="line"><span class="string">REVISION: 1</span></span><br><span class="line"><span class="string">TEST SUITE: None</span></span><br><span class="line"><span class="string">NOTES:</span></span><br><span class="line"><span class="string">You have successfully installed Hubble-Ui.</span></span><br><span class="line"><span class="string">Your release version is 1.3.6.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">For any further help, visit https://docs.isovalent.com</span></span><br><span class="line"><span class="string">--&gt; Exposing Hubble UI service via NodePort...</span></span><br><span class="line"><span class="string">service/hubble-ui patched</span></span><br><span class="line"><span class="string">✅ Hubble UI installed.</span></span><br><span class="line"><span class="string">### STEP 7: Verifying the Setup... ###</span></span><br><span class="line"><span class="string">--&gt; Waiting for all nodes to be ready...</span></span><br><span class="line"><span class="string">node/kube-node-1 condition met</span></span><br><span class="line"><span class="string">node/kube-node-2 condition met</span></span><br><span class="line"><span class="string">node/kube-node-3 condition met</span></span><br><span class="line"><span class="string">--&gt; Checking Cilium status...</span></span><br><span class="line"><span class="string">    /¯¯\</span></span><br><span class="line"><span class="string"> /¯¯\__/¯¯\    Cilium:             OK</span></span><br><span class="line"><span class="string"> \__/¯¯\__/    Operator:           OK</span></span><br><span class="line"><span class="string"> /¯¯\__/¯¯\    Envoy DaemonSet:    OK</span></span><br><span class="line"><span class="string"> \__/¯¯\__/    Hubble Relay:       OK</span></span><br><span class="line"><span class="string">    \__/       ClusterMesh:        disabled</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">DaemonSet              cilium                   Desired: 3, Ready: 3/3, Available: 3/3</span></span><br><span class="line"><span class="string">DaemonSet              cilium-envoy             Desired: 3, Ready: 3/3, Available: 3/3</span></span><br><span class="line"><span class="string">Deployment             cilium-operator          Desired: 2, Ready: 2/2, Available: 2/2</span></span><br><span class="line"><span class="string">Deployment             hubble-relay             Desired: 1, Ready: 1/1, Available: 1/1</span></span><br><span class="line"><span class="string">Deployment             hubble-ui                Desired: 1, Ready: 1/1, Available: 1/1</span></span><br><span class="line"><span class="string">Containers:            cilium                   Running: 3</span></span><br><span class="line"><span class="string">                       cilium-envoy             Running: 3</span></span><br><span class="line"><span class="string">                       cilium-operator          Running: 2</span></span><br><span class="line"><span class="string">                       clustermesh-apiserver    </span></span><br><span class="line"><span class="string">                       hubble-relay             Running: 1</span></span><br><span class="line"><span class="string">                       hubble-ui                Running: 1</span></span><br><span class="line"><span class="string">Cluster Pods:          8/8 managed by Cilium</span></span><br><span class="line"><span class="string">Helm chart version:    1.17.6</span></span><br><span class="line"><span class="string">Image versions         cilium             quay.io/isovalent/cilium:v1.17.6-cee.1@sha256:2d01daf4f25f7d644889b49ca856e1a4269981fc963e50bd3962665b41b6adb3: 3</span></span><br><span class="line"><span class="string">                       cilium-envoy       quay.io/isovalent/cilium-envoy:v1.17.6-cee.1@sha256:318eff387835ca2717baab42a84f35a83a5f9e7d519253df87269f80b9ff0171: 3</span></span><br><span class="line"><span class="string">                       cilium-operator    quay.io/isovalent/operator-generic:v1.17.6-cee.1@sha256:2e602710a7c4f101831df679e5d8251bae8bf0f9fe26c20bbef87f1966ea8265: 2</span></span><br><span class="line"><span class="string">                       hubble-relay       quay.io/isovalent/hubble-relay:v1.17.6-cee.1@sha256:d378e3607f7492374e65e2bd854cc0ec87480c63ba49a96dadcd75a6946b586e: 1</span></span><br><span class="line"><span class="string">                       hubble-ui          quay.io/isovalent/hubble-ui-enterprise-backend:v1.3.6: 1</span></span><br><span class="line"><span class="string">                       hubble-ui          quay.io/isovalent/hubble-ui-enterprise:v1.3.6: 1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">----------------------------------------------------------------</span></span><br><span class="line"><span class="string">🚀 Cluster setup is complete and verified!</span></span><br><span class="line"><span class="string">Access Hubble UI at: http://10.75.59.71:30583</span></span><br><span class="line"><span class="string">----------------------------------------------------------------</span></span><br><span class="line"><span class="string">root@kube-node-1:~# cilium bgp peers</span></span><br><span class="line"><span class="string">Node          Local AS   Peer AS   Peer Address   Session State   Uptime   Family         Received   Advertised</span></span><br><span class="line"><span class="string">kube-node-1   65000      65000     10.75.59.76    established     19m1s    ipv4/unicast   2          8    </span></span><br><span class="line"><span class="string">kube-node-2   65000      65000     10.75.59.76    established     19m2s    ipv4/unicast   2          8    </span></span><br><span class="line"><span class="string">kube-node-3   65000      65000     10.75.59.76    established     19m2s    ipv4/unicast   2          8    </span></span><br><span class="line"><span class="string">root@kube-node-1:~# cilium bgp routes</span></span><br><span class="line"><span class="string">(Defaulting to `available ipv4 unicast` routes, please see help for more options)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Node          VRouter   Prefix             NextHop   Age     Attrs</span></span><br><span class="line"><span class="string">kube-node-1   65000     172.16.0.0/24      0.0.0.0   19m8s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span></span><br><span class="line"><span class="string">              65000     172.16.32.1/32     0.0.0.0   19m8s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span></span><br><span class="line"><span class="string">              65000     172.16.32.10/32    0.0.0.0   19m8s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span></span><br><span class="line"><span class="string">              65000     172.16.36.130/32   0.0.0.0   19m8s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span></span><br><span class="line"><span class="string">              65000     172.16.40.165/32   0.0.0.0   19m8s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span></span><br><span class="line"><span class="string">              65000     172.16.43.51/32    0.0.0.0   19m8s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span></span><br><span class="line"><span class="string">              65000     172.16.47.30/32    0.0.0.0   19m8s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span></span><br><span class="line"><span class="string">kube-node-2   65000     172.16.1.0/24      0.0.0.0   19m8s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span></span><br><span class="line"><span class="string">              65000     172.16.32.1/32     0.0.0.0   19m8s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span></span><br><span class="line"><span class="string">              65000     172.16.32.10/32    0.0.0.0   19m8s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span></span><br><span class="line"><span class="string">              65000     172.16.36.130/32   0.0.0.0   19m8s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span></span><br><span class="line"><span class="string">              65000     172.16.40.165/32   0.0.0.0   19m8s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span></span><br><span class="line"><span class="string">              65000     172.16.43.51/32    0.0.0.0   19m8s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span></span><br><span class="line"><span class="string">              65000     172.16.47.30/32    0.0.0.0   19m8s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span></span><br><span class="line"><span class="string">kube-node-3   65000     172.16.2.0/24      0.0.0.0   19m8s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span></span><br><span class="line"><span class="string">              65000     172.16.32.1/32     0.0.0.0   19m8s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span></span><br><span class="line"><span class="string">              65000     172.16.32.10/32    0.0.0.0   19m8s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span></span><br><span class="line"><span class="string">              65000     172.16.36.130/32   0.0.0.0   19m8s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span></span><br><span class="line"><span class="string">              65000     172.16.40.165/32   0.0.0.0   19m8s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span></span><br><span class="line"><span class="string">              65000     172.16.43.51/32    0.0.0.0   19m8s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span></span><br><span class="line"><span class="string">              65000     172.16.47.30/32    0.0.0.0   19m8s   [&#123;Origin: i&#125; &#123;Nexthop: 0.0.0.0&#125;]   </span></span><br><span class="line"><span class="string">root@kube-node-1:~# </span></span><br></pre></td></tr></table></figure>
<h1 id="7-Kubectl-常用命令"><a href="#7-Kubectl-常用命令" class="headerlink" title="7. Kubectl 常用命令"></a>7. Kubectl 常用命令</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">kubectl describe pod hubble-ui-5fdd8b4495-dv7nr -n kube-system</span><br><span class="line"></span><br><span class="line">kubectl get nodes -o wide</span><br><span class="line">kubectl get pods -n kube-system -o wide</span><br><span class="line">kubectl get pods --all-namespaces</span><br><span class="line">kubectl get service -n kube-system -o wide</span><br><span class="line">kubectl get daemonset -n kube-system cilium</span><br><span class="line">kubectl get deployment -o wide</span><br><span class="line"></span><br><span class="line">kubectl get endpoints -n kube-system kube-dns</span><br><span class="line">kubectl get cm cilium-config -n kube-system -o yaml</span><br><span class="line">kubectl get endpoints -n kube-system</span><br><span class="line">kubectl get pods -n kube-system -l k8s-app=cilium -o wide</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl describe pod hubble-relay-cfb755899-r42l8</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kubectl -n kube-system get pods -l k8s-app=cilium</span><br><span class="line">kubectl -n kube-system exec ds/cilium -- cilium-dbg bpf ipmasq list</span><br><span class="line">kubectl -n kube-system exec ds/cilium -- cilium-dbg status --verbose</span><br><span class="line">kubectl -n kube-system exec ds/cilium -- cilium status</span><br><span class="line">kubectl -n kube-system exec ds/cilium -- cilium service list</span><br><span class="line">kubectl -n kube-system exec ds/cilium -- cilium bpf nat list</span><br><span class="line">kubectl exec -n kube-system cilium-2vrgj -- cilium bpf nat list</span><br><span class="line"></span><br><span class="line">kubectl -n kube-system get configmap cilium-config -o yaml</span><br><span class="line"></span><br><span class="line">kubectl create namespace star-wars</span><br><span class="line">kubectl apply -n star-wars -f https://raw.githubusercontent.com/cilium/cilium/HEAD/examples/minikube/http-sw-app.yaml</span><br><span class="line">kubectl -n star-wars get pod -o wide --show-labels</span><br><span class="line">kubectl -n star-wars patch service deathstar -p &#x27;&#123;&quot;spec&quot;:&#123;&quot;type&quot;:&quot;NodePort&quot;&#125;&#125;&#x27;</span><br><span class="line">kubectl -n star-wars exec tiefighter --   curl -s -XPOST http://deathstar.star-wars.svc.cluster.local/v1/request-landing</span><br><span class="line">kubectl -n star-wars exec xwing --   curl -s -XPOST http://deathstar.star-wars.svc.cluster.local/v1/request-landing</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubectl delete -n star-wars -f https://raw.githubusercontent.com/cilium/cilium/1.18.0/examples/minikube/http-sw-app.yaml</span></span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">Commands <span class="keyword">for</span> reference only.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kubectl delete pod,svc,daemonset -n kube-system -l k8s-app=cilium</span><br><span class="line">kubectl delete daemonset -n kube-system kube-proxy</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kubectl create deployment nginx --image=nginx</span><br><span class="line">kubectl expose deployment nginx --port=80 --type=ClusterIP</span><br><span class="line"></span><br><span class="line">kubectl run -it --rm busybox --image=busybox --restart=Never -- sh</span><br><span class="line"></span><br><span class="line">kubectl run -it --rm curl --image=curlimages/curl --restart=Never -- sh</span><br><span class="line"></span><br><span class="line">for i in &#123;1..10&#125;; do   kubectl exec -n star-wars tiefighter --     curl -s http://deathstar.default.svc.cluster.local/v1 |     jq -r &#x27;.hostname&#x27;; done</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://weiborao.link/Update-the-cloud-init-code-for-AppD-AMI.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rao Weibo">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Rao Weibo的博客">
      <meta itemprop="description" content="记录一些工作、学习相关的笔记">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Rao Weibo的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/Update-the-cloud-init-code-for-AppD-AMI.html" class="post-title-link" itemprop="url">AppDynamics AMI cloud-init code update</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2023-03-15 12:00:00 / 修改时间：12:31:16" itemprop="dateCreated datePublished" datetime="2023-03-15T12:00:00+08:00">2023-03-15</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>309</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>1 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#cloud-config</span></span><br><span class="line"><span class="comment">#Update the packages onboot.</span></span><br><span class="line"><span class="attr">package_update:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#ncurses-compat-libs is for Amazon Linux 2.</span></span><br><span class="line"><span class="attr">packages:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">libaio</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">numactl</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">tzdata</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ncurses-compat-libs</span></span><br><span class="line"></span><br><span class="line"><span class="attr">write_files:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/etc/profile.d/lang.sh</span></span><br><span class="line">    <span class="attr">content:</span> <span class="string">|</span></span><br><span class="line"><span class="string">      export LANG=en_US.UTF-8</span></span><br><span class="line"><span class="string">      export LC_ALL=en_US.UTF-8</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/etc/security/limits.conf</span></span><br><span class="line">    <span class="attr">content:</span> <span class="string">|</span></span><br><span class="line"><span class="string">      root hard nofile 65535</span></span><br><span class="line"><span class="string">      root soft nofile 65535</span></span><br><span class="line"><span class="string">      root hard nproc 8192</span></span><br><span class="line"><span class="string">      root soft nproc 8192</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/opt/appdynamics/response.varfile.bak</span></span><br><span class="line">    <span class="attr">content:</span> <span class="string">|</span></span><br><span class="line"><span class="string">      serverHostName=HOST_NAME</span></span><br><span class="line"><span class="string">      sys.languageId=en</span></span><br><span class="line"><span class="string">      disableEULA=true</span></span><br><span class="line"><span class="string">      platformAdmin.port=9191</span></span><br><span class="line"><span class="string">      platformAdmin.databasePort=3377</span></span><br><span class="line"><span class="string">      platformAdmin.dataDir=/opt/appdynamics/platform/mysql/data</span></span><br><span class="line"><span class="string">      platformAdmin.databasePassword=ENTER_PASSWORD</span></span><br><span class="line"><span class="string">      platformAdmin.databaseRootPassword=ENTER_PASSWORD</span></span><br><span class="line"><span class="string">      platformAdmin.adminPassword=ENTER_PASSWORD</span></span><br><span class="line"><span class="string">      platformAdmin.useHttps$Boolean=false</span></span><br><span class="line"><span class="string">      sys.installationDir=/opt/appdynamics/platform</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/etc/systemd/system/appd.console.service</span></span><br><span class="line">    <span class="attr">permissions:</span> <span class="string">&#x27;0644&#x27;</span></span><br><span class="line">    <span class="attr">content:</span> <span class="string">|</span></span><br><span class="line"><span class="string">      [Unit]</span></span><br><span class="line"><span class="string">      Description=AppDynamics Enterprise Console</span></span><br><span class="line"><span class="string">      After=network.target</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">      [<span class="string">Service</span>]</span><br><span class="line">      <span class="string">Type=forking</span></span><br><span class="line">      <span class="string">ExecStart=/opt/appdynamics/platform/platform-admin/bin/platform-admin.sh</span> <span class="string">start-platform-admin</span></span><br><span class="line">      <span class="string">ExecStop=/opt/appdynamics/platform/platform-admin/bin/platform-admin.sh</span> <span class="string">stop-platform-admin</span></span><br><span class="line">      <span class="string">User=root</span></span><br><span class="line">      <span class="string">Restart=always</span></span><br><span class="line"></span><br><span class="line">      [<span class="string">Install</span>]</span><br><span class="line">      <span class="string">WantedBy=multi-user.target</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">/etc/systemd/system/appd.console.install.service</span></span><br><span class="line">    <span class="attr">permissions:</span> <span class="string">&#x27;0644&#x27;</span></span><br><span class="line">    <span class="attr">content:</span> <span class="string">|</span></span><br><span class="line"><span class="string">      [Unit]</span></span><br><span class="line"><span class="string">      Description=AppDynamics Enterprise Console Installation</span></span><br><span class="line"><span class="string">      After=network.target</span></span><br><span class="line"><span class="string"></span></span><br><span class="line">      [<span class="string">Service</span>]</span><br><span class="line">      <span class="string">Type=oneshot</span></span><br><span class="line">      <span class="string">RemainAfterExit=no</span></span><br><span class="line">      <span class="string">ExecStart=/bin/sh</span> <span class="string">-c</span> <span class="string">&#x27;sleep 5 &amp;&amp; cp /opt/appdynamics/response.varfile.bak /opt/appdynamics/response.varfile &amp;&amp; sed -i \&quot;s/ENTER_PASSWORD/`curl http://169.254.169.254/latest/meta-data/instance-id`/g\&quot; /opt/appdynamics/response.varfile &amp;&amp; sed -i \&quot;s/HOST_NAME/`curl http://169.254.169.254/latest/meta-data/hostname`/g\&quot; /opt/appdynamics/response.varfile &amp;&amp; /opt/appdynamics/platform-setup-x64-linux-23.1.1.18.sh -q -varfile /opt/appdynamics/response.varfile &amp;&amp; systemctl daemon-reload &amp;&amp; systemctl enable appd.console.service &amp;&amp; systemctl start appd.console.service&#x27;</span></span><br><span class="line"></span><br><span class="line">      [<span class="string">Install</span>]</span><br><span class="line">      <span class="string">WantedBy=multi-user.target</span></span><br><span class="line"></span><br><span class="line"><span class="attr">runcmd:</span></span><br><span class="line">  <span class="comment"># Create directory and copy Cisco AppDynamics Enterprise Console setup file</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">aws</span> <span class="string">s3</span> <span class="string">cp</span> <span class="string">s3://ciscoappdnx/platform-setup-x64-linux-23.1.1.18.sh</span> <span class="string">/opt/appdynamics/</span> <span class="string">--region</span> <span class="string">cn-northwest-1</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">chmod</span> <span class="string">+x</span> <span class="string">/opt/appdynamics/platform-setup-x64-linux-23.1.1.18.sh</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">systemctl</span> <span class="string">daemon-reload</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">systemctl</span> <span class="string">enable</span> <span class="string">appd.console.install.service</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">sed</span> <span class="string">-i</span> <span class="string">&#x27;s/#PermitRootLogin yes/PermitRootLogin no/g&#x27;</span> <span class="string">/etc/ssh/sshd_config</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">rm</span> <span class="string">-rf</span> <span class="string">/root/.ssh/authorized_keys</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">rm</span> <span class="string">-rf</span> <span class="string">/home/ec2-user/.ssh/authorized_keys</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">shred</span> <span class="string">-u</span> <span class="string">/etc/ssh/*_key</span> <span class="string">/etc/ssh/*_key.pub</span></span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://weiborao.link/Conversation-with-ChatGPT-to-accelerate-Cloud-Develpment.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rao Weibo">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Rao Weibo的博客">
      <meta itemprop="description" content="记录一些工作、学习相关的笔记">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Rao Weibo的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/Conversation-with-ChatGPT-to-accelerate-Cloud-Develpment.html" class="post-title-link" itemprop="url">与网红ChatGPT对话，AI助手加速云计算开发流程</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-03-03 07:00:00" itemprop="dateCreated datePublished" datetime="2023-03-03T07:00:00+08:00">2023-03-03</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-03-04 00:33:00" itemprop="dateModified" datetime="2023-03-04T00:33:00+08:00">2023-03-04</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>2.1k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>8 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="手工作坊与“云”格格不入"><a href="#手工作坊与“云”格格不入" class="headerlink" title="手工作坊与“云”格格不入"></a>手工作坊与“云”格格不入</h1><p>Cisco AppDynamics 是一款功能强大、易于使用的应用程序性能管理（APM）解决方案，能够端到端监控亚马逊云的应用程序，包括微服务和 Docker，通过 CloudWatch 集成为 EC2、DynamoDB、Lambda 等提供支持。AppDynamics可比较和验证云迁移前后的从客户到业务的优化，从而加速客户上云，因而深受用户喜爱。</p>
<p>为了提升用户在亚马逊云科技云端安装部署AppDynamics软件的效率，我们需要制作一个打包好的安装镜像 —— Amazon Machine Images (AMI)。用户使用AMI镜像启动虚拟机即可进入AppDynamics的设置界面，这能帮助用户节省大量软件下载、安装调试的时间，极大改善用户的安装体验。<br>我们采用什么方式来制作AMI镜像呢？</p>
<p>使用纯手工方式当然可以完成制作，但是这个AMI镜像封存了整个虚拟机的磁盘，包括操作系统和软件包。如果AppDynamics软件发布新版本，或者操作系统发现安全漏洞，就需要进行软件升级或系统漏洞修复的工作。在这种情况下，手工作坊难以招架，换句话说，在云的世界，已经没有手工作坊的一席之地，只有自动化一种选项。</p>
<p>那么，接下来的问题是：自动化需要工具和代码的支持，代码要怎么写呢？</p>
<p>笔者虽然能写点简单的Python代码、Shell脚本，可是要编写一个综合性的代码，恐怕没有两周时间，再加上掉几把头发是写不出来的。</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/Conversation-with-ChatGPT-to-accelerate-Cloud-Develpment.html#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://weiborao.link/ChatGPT-generate-code-to-build-AMI-for-AppDynamics.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rao Weibo">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Rao Weibo的博客">
      <meta itemprop="description" content="记录一些工作、学习相关的笔记">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Rao Weibo的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/ChatGPT-generate-code-to-build-AMI-for-AppDynamics.html" class="post-title-link" itemprop="url">使用ChatGPT生成cloud-init制作AppDynamics在AWS上的安装镜像</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2023-03-02 09:00:00" itemprop="dateCreated datePublished" datetime="2023-03-02T09:00:00+08:00">2023-03-02</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-03-03 07:43:05" itemprop="dateModified" datetime="2023-03-03T07:43:05+08:00">2023-03-03</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>3k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>11 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>作者: 饶维波</p>
<p>本文记录通过ChatGPT生成cloud-init制作AppDynamics在AWS上 AMI安装镜像的过程，形成操作文档作为参考指南。</p>
<h1 id="任务简介和总体思路"><a href="#任务简介和总体思路" class="headerlink" title="任务简介和总体思路"></a>任务简介和总体思路</h1><h2 id="任务简介"><a href="#任务简介" class="headerlink" title="任务简介"></a>任务简介</h2><p>Cisco AppDynamics 提供功能强大、易于使用的应用程序性能管理（APM）解决方案，端到端监控亚马逊云的应用程序，包括微服务和 Docker，通过 CloudWatch 集成为 EC2、DynamoDB、Lambda 等提供支持。AppDynamics可比较和验证云迁移前后的从客户到业务的优化，从而加速客户上云，因而深受用户喜爱。</p>
<p>为了提升用户在亚马逊云科技云端安装部署AppDynamics软件的效率，我们需要制作一个打包好的安装镜像，叫做Amazon Machine Images (AMI)。用户使用AMI镜像启动虚拟机即可进入AppDynamics的设置界面，这能帮助用户节省大量软件下载、安装调试的时间，极大改善用户的安装体验。</p>
<p>本次任务的目标是需要完成AppDynamics AMI的制作，且为了便于后续维护，维护的工作主要包括操作系统层面的安全漏洞修复、AppDynamics软件版本的升级，尽量使用自动化，节省人的时间精力的同时，避免人为错误。</p>
<p>任务关键点是需要编写一个自动化脚本，考虑为Shell脚本或者cloud-init脚本。</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/ChatGPT-generate-code-to-build-AMI-for-AppDynamics.html#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://weiborao.link/traceroute-vulnerability.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Rao Weibo">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Rao Weibo的博客">
      <meta itemprop="description" content="记录一些工作、学习相关的笔记">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Rao Weibo的博客">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/traceroute-vulnerability.html" class="post-title-link" itemprop="url">Traceroute 漏洞？</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2021-12-16 21:25:41" itemprop="dateCreated datePublished" datetime="2021-12-16T21:25:41+08:00">2021-12-16</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">更新于</span>
      <time title="修改时间：2023-03-02 18:41:28" itemprop="dateModified" datetime="2023-03-02T18:41:28+08:00">2023-03-02</time>
    </span>

  
    <span class="post-meta-break"></span>
    <span class="post-meta-item" title="本文字数">
      <span class="post-meta-item-icon">
        <i class="far fa-file-word"></i>
      </span>
      <span class="post-meta-item-text">本文字数：</span>
      <span>1.5k</span>
    </span>
    <span class="post-meta-item" title="阅读时长">
      <span class="post-meta-item-icon">
        <i class="far fa-clock"></i>
      </span>
      <span class="post-meta-item-text">阅读时长 &asymp;</span>
      <span>6 分钟</span>
    </span>
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>本文将分析一种名为<strong>允许Traceroute探测</strong>的漏洞，对其判定方法进行追查，并提出建议。</p>
<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>最近，笔者在做一个网络设备方面的安全合规性的测试，其中有一项是需要使用漏洞扫描设备对被测试的设备进行全面的安全漏洞扫描。在笔者对被测设备进行了针对性的安全加固后，漏洞扫描报告仍然有一个低危漏洞：允许Traceroute探测。该低危漏洞的详细信息如下：</p>
<p><img src="/traceroute-vulnerability/traceroute-vulnerability.png" alt="traceroute-vulnerability"></p>
<p>需要说明的一点是，扫描器如需成功扫描到该设备，这个设备的IP地址要求能被扫描器探测到，否则扫描器会认为设备不在线。通常的做法就是允许Ping，具体而言，被测设备至少要允许ICMP Echo Request请求，并应答ICMP Echo Reply。</p>
<p>笔者在被测试设备的接口上配置了ACL，入向仅允许ICMP Echo Request报文，出向仅允许ICMP Echo Reply，但是扫描结果依然判断被测设备允许Traceroute探测。</p>
<p>对此，笔者疑惑不已，下文将展开思考和分析。</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/traceroute-vulnerability.html#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" title="下一页" aria-label="下一页" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 2021 – 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Rao Weibo</span>
  </div>
<div class="wordcount">
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-line"></i>
    </span>
    <span title="站点总字数">53k</span>
  </span>
  <span class="post-meta-item">
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">3:13</span>
  </span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/pisces/" rel="noopener" target="_blank">NexT.Pisces</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/weiborao" class="github-corner" title="在 GitHub 上关注我" aria-label="在 GitHub 上关注我" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  

  <script class="next-config" data-name="mermaid" type="application/json">{"enable":true,"theme":{"light":"default","dark":"dark"},"js":{"url":"https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.3.0/mermaid.min.js","integrity":"sha256-9y71g5Lz/KLsHjB8uXwnkuWDtAMDSzD/HdIbqhJfTAI="}}</script>
  <script src="/js/third-party/tags/mermaid.js"></script>





  





</body>
</html>
